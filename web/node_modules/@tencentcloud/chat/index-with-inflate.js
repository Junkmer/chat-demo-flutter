"use strict";!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).TencentCloudChat=t()}(this,function(){function o(t,e){var n,o=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,n)),o}function y(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach(function(e){c(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function e(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _(e,t,n){return(_=p()?Reflect.construct:function(e,t,n){var o=[null],t=(o.push.apply(o,t),new(Function.bind.apply(e,o)));return n&&d(t,n.prototype),t}).apply(null,arguments)}function n(e){var n="function"==typeof Map?new Map:void 0;return function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return _(e,arguments,l(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),d(t,e)}(e)}function h(e,t){if(null==e)return{};var n,o=function(e,t){if(null==e)return{};for(var n,o={},i=Object.keys(e),a=0;a<i.length;a++)n=i[a],0<=t.indexOf(n)||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols)for(var i=Object.getOwnPropertySymbols(e),a=0;a<i.length;a++)n=i[a],0<=t.indexOf(n)||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n]);return o}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(n){var o=p();return function(){var e,t=l(n),t=(e=o?(e=l(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return g(t)}}function I(e,t){return D(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,i,a=[],s=!0,r=!1;try{for(n=n.call(e);!(s=(o=n.next()).done)&&(a.push(o.value),!t||a.length!==t);s=!0);}catch(e){r=!0,i=e}finally{try{s||null==n.return||n.return()}finally{if(r)throw i}}return a}}(e,t)||L(e,t)||O()}function T(e){return function(e){if(Array.isArray(e))return R(e)}(e)||E(e)||L(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function D(e){if(Array.isArray(e))return e}function E(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function L(e,t){if(e){if("string"==typeof e)return R(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?R(e,t):void 0}}function R(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function O(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function N(e,t){var n,o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=L(e))||t&&e&&"number"==typeof e.length)return o&&(e=o),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==o.return||o.return()}finally{if(s)throw i}}}}var G={SDK_READY:"sdkStateReady",SDK_NOT_READY:"sdkStateNotReady",SDK_DESTROY:"sdkDestroy",MESSAGE_RECEIVED:"onMessageReceived",ROOM_CUSTOM_DATA_RECEIVED:"onRoomCustomDataReceived",MESSAGE_MODIFIED:"onMessageModified",MESSAGE_REVOKED:"onMessageRevoked",MESSAGE_READ_BY_PEER:"onMessageReadByPeer",MESSAGE_READ_RECEIPT_RECEIVED:"onMessageReadReceiptReceived",MESSAGE_EXTENSIONS_UPDATED:"onMessageExtensionsUpdated",MESSAGE_EXTENSIONS_DELETED:"onMessageExtensionsDeleted",MESSAGE_REACTIONS_UPDATED:"onMessageReactionsUpdated",CONVERSATION_LIST_UPDATED:"onConversationListUpdated",TOTAL_UNREAD_MESSAGE_COUNT_UPDATED:"onTotalUnreadMessageCountUpdated",CONVERSATION_GROUP_LIST_UPDATED:"onConversationGroupListUpdated",CONVERSATION_IN_GROUP_UPDATED:"onConversationInGroupUpdated",GROUP_LIST_UPDATED:"onGroupListUpdated",GROUP_ATTRIBUTES_UPDATED:"groupAttributesUpdated",GROUP_COUNTER_UPDATED:"onGroupCounterUpdated",TOPIC_CREATED:"onTopicCreated",TOPIC_DELETED:"onTopicDeleted",TOPIC_UPDATED:"onTopicUpdated",PROFILE_UPDATED:"onProfileUpdated",USER_STATUS_UPDATED:"onUserStatusUpdated",BLACKLIST_UPDATED:"blacklistUpdated",FRIEND_LIST_UPDATED:"onFriendListUpdated",FRIEND_GROUP_LIST_UPDATED:"onFriendGroupListUpdated",FRIEND_APPLICATION_LIST_UPDATED:"onFriendApplicationListUpdated",MY_FOLLOWERS_LIST_UPDATED:"onMyFollowersListUpdated",MY_FOLLOWING_LIST_UPDATED:"onMyFollowingListUpdated",MUTUAL_FOLLOWERS_LIST_UPDATED:"onMutualFollowersListUpdated",KICKED_OUT:"kickedOut",ERROR:"error",NET_STATE_CHANGE:"netStateChange",ALL_RECEIVE_MESSAGE_OPT_UPDATED:"onAllReceiveMessageOptUpdated"},S={MSG_TEXT:"TIMTextElem",MSG_IMAGE:"TIMImageElem",MSG_SOUND:"TIMSoundElem",MSG_AUDIO:"TIMSoundElem",MSG_FILE:"TIMFileElem",MSG_FACE:"TIMFaceElem",MSG_VIDEO:"TIMVideoFileElem",MSG_GEO:"TIMLocationElem",MSG_LOCATION:"TIMLocationElem",MSG_GRP_TIP:"TIMGroupTipElem",MSG_GRP_SYS_NOTICE:"TIMGroupSystemNoticeElem",MSG_CUSTOM:"TIMCustomElem",MSG_MERGER:"TIMRelayElem",MSG_PRIORITY_HIGH:"High",MSG_PRIORITY_NORMAL:"Normal",MSG_PRIORITY_LOW:"Low",MSG_PRIORITY_LOWEST:"Lowest",CONV_C2C:"C2C",CONV_GROUP:"GROUP",CONV_TOPIC:"TOPIC",CONV_SYSTEM:"@TIM#SYSTEM",CONV_AT_ME:1,CONV_AT_ALL:2,CONV_AT_ALL_AT_ME:3,CONV_MARK_TYPE_STAR:1,CONV_MARK_TYPE_UNREAD:2,CONV_MARK_TYPE_FOLD:4,CONV_MARK_TYPE_HIDE:8,GRP_PRIVATE:"Private",GRP_WORK:"Private",GRP_PUBLIC:"Public",GRP_CHATROOM:"ChatRoom",GRP_MEETING:"ChatRoom",GRP_AVCHATROOM:"AVChatRoom",GRP_COMMUNITY:"Community",GRP_ROOM:"Room",GRP_LIVE:"Live",GRP_MBR_ROLE_OWNER:"Owner",GRP_MBR_ROLE_ADMIN:"Admin",GRP_MBR_ROLE_MEMBER:"Member",GRP_MBR_ROLE_CUSTOM:"Custom",GRP_TIP_MBR_JOIN:1,GRP_TIP_MBR_QUIT:2,GRP_TIP_MBR_KICKED_OUT:3,GRP_TIP_MBR_SET_ADMIN:4,GRP_TIP_MBR_CANCELED_ADMIN:5,GRP_TIP_GRP_PROFILE_UPDATED:6,GRP_TIP_MBR_PROFILE_UPDATED:7,GRP_TIP_BAN_AVCHATROOM_MEMBER:10,GRP_TIP_UNBAN_AVCHATROOM_MEMBER:11,MSG_REMIND_ACPT_AND_NOTE:"AcceptAndNotify",MSG_REMIND_ACPT_NOT_NOTE:"AcceptNotNotify",MSG_REMIND_DISCARD:"Discard",RECEIVE_WITH_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",GENDER_UNKNOWN:"Gender_Type_Unknown",GENDER_FEMALE:"Gender_Type_Female",GENDER_MALE:"Gender_Type_Male",KICKED_OUT_MULT_ACCOUNT:"multipleAccount",KICKED_OUT_MULT_DEVICE:"multipleDevice",KICKED_OUT_USERSIG_EXPIRED:"userSigExpired",KICKED_OUT_REST_API:"REST_API_Kick",ALLOW_TYPE_ALLOW_ANY:"AllowType_Type_AllowAny",ALLOW_TYPE_NEED_CONFIRM:"AllowType_Type_NeedConfirm",ALLOW_TYPE_DENY_ANY:"AllowType_Type_DenyAny",FORBID_TYPE_NONE:"AdminForbid_Type_None",FORBID_TYPE_SEND_OUT:"AdminForbid_Type_SendOut",JOIN_OPTIONS_FREE_ACCESS:"FreeAccess",JOIN_OPTIONS_NEED_PERMISSION:"NeedPermission",JOIN_OPTIONS_DISABLE_APPLY:"DisableApply",JOIN_STATUS_SUCCESS:"JoinedSuccess",JOIN_STATUS_ALREADY_IN_GROUP:"AlreadyInGroup",JOIN_STATUS_WAIT_APPROVAL:"WaitAdminApproval",INVITE_OPTIONS_DISABLE_INVITE:"DisableInvite",INVITE_OPTIONS_NEED_PERMISSION:"NeedPermission",INVITE_OPTIONS_FREE_ACCESS:"FreeAccess",GRP_PROFILE_OWNER_ID:"ownerID",GRP_PROFILE_CREATE_TIME:"createTime",GRP_PROFILE_LAST_INFO_TIME:"lastInfoTime",GRP_PROFILE_MEMBER_NUM:"memberNum",GRP_PROFILE_MAX_MEMBER_NUM:"maxMemberNum",GRP_PROFILE_JOIN_OPTION:"joinOption",GRP_PROFILE_INVITE_OPTION:"inviteOption",GRP_PROFILE_INTRODUCTION:"introduction",GRP_PROFILE_NOTIFICATION:"notification",GRP_PROFILE_MUTE_ALL_MBRS:"muteAllMembers",SNS_ADD_TYPE_SINGLE:"Add_Type_Single",SNS_ADD_TYPE_BOTH:"Add_Type_Both",SNS_DELETE_TYPE_SINGLE:"Delete_Type_Single",SNS_DELETE_TYPE_BOTH:"Delete_Type_Both",SNS_APPLICATION_TYPE_BOTH:"Pendency_Type_Both",SNS_APPLICATION_SENT_TO_ME:"Pendency_Type_ComeIn",SNS_APPLICATION_SENT_BY_ME:"Pendency_Type_SendOut",SNS_APPLICATION_AGREE:"Response_Action_Agree",SNS_APPLICATION_AGREE_AND_ADD:"Response_Action_AgreeAndAdd",SNS_CHECK_TYPE_BOTH:"CheckResult_Type_Both",SNS_CHECK_TYPE_SINGLE:"CheckResult_Type_Single",SNS_TYPE_NO_RELATION:"CheckResult_Type_NoRelation",SNS_TYPE_A_WITH_B:"CheckResult_Type_AWithB",SNS_TYPE_B_WITH_A:"CheckResult_Type_BWithA",SNS_TYPE_BOTH_WAY:"CheckResult_Type_BothWay",NET_STATE_CONNECTED:"connected",NET_STATE_CONNECTING:"connecting",NET_STATE_DISCONNECTED:"disconnected",MSG_AT_ALL:"__kImSDK_MesssageAtALL__",READ_ALL_C2C_MSG:"readAllC2CMessage",READ_ALL_GROUP_MSG:"readAllGroupMessage",READ_ALL_MSG:"readAllMessage",USER_STATUS_UNKNOWN:0,USER_STATUS_ONLINE:1,USER_STATUS_OFFLINE:2,USER_STATUS_UNLOGINED:3,IOS_OFFLINE_PUSH_NO_SOUND:"push.no_sound",IOS_OFFLINE_PUSH_DEFAULT_SOUND:"default"},P={NEW_INVITATION_RECEIVED:"newInvitationReceived",INVITEE_ACCEPTED:"ts_invitee_accepted",INVITEE_REJECTED:"ts_invitee_rejected",INVITATION_CANCELLED:"ts_invitation_cancelled",INVITATION_TIMEOUT:"ts_invitation_timeout",INVITATION_MODIFIED:"ts_invitation_modified",ACTION_TYPE_UNKNOWN:0,ACTION_TYPE_INVITE:1,ACTION_TYPE_CANCEL_INVITE:2,ACTION_TYPE_ACCEPT_INVITE:3,ACTION_TYPE_REJECT_INVITE:4,ACTION_TYPE_INVITE_TIMEOUT:5},U=(e(W,[{key:"use",value:function(e){if("function"!=typeof e)throw"middleware must be a function";return this.cache.push(e),this}},{key:"next",value:function(e){if(this.middlewares&&0<this.middlewares.length)return this.middlewares.shift().call(this,this.options,this.next.bind(this))}},{key:"run",value:function(e){return this.middlewares=this.cache.map(function(e){return e}),this.options=e,this.next()}}]),W),b=(e(K,[{key:"equal",value:function(e){return null!==e&&this.low===e.low&&this.high===e.high}},{key:"toString",value:function(){var e=Number(this.high).toString(16),t=Number(this.low).toString(16);if(t.length<8)for(var n=8-t.length;n;)t="0"+t,n--;return e+t}}]),K),F={TEST:{CHINA:{DEFAULT:"wss://wss-dev.tim.qq.com"},OVERSEA:{DEFAULT:"wss://wss-dev.tim.qq.com"},SINGAPORE:{DEFAULT:"wss://wsssgp-dev.im.qcloud.com"},KOREA:{DEFAULT:"wss://wsskr-dev.im.qcloud.com"},GERMANY:{DEFAULT:"wss://wssger-dev.im.qcloud.com"},IND:{DEFAULT:"wss://wssind-dev.im.qcloud.com"},JPN:{DEFAULT:"wss://wssjpn-dev.im.qcloud.com"},USA:{DEFAULT:"wss://wssusa-dev.im.qcloud.com"},INDONESIA:{DEFAULT:"wss://wssidn-dev.im.qcloud.com"}},PRODUCTION:{CHINA:{DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.tim.qq.com",STAT:"https://events.im.qcloud.com",ANYCAST:"wss://162.14.13.203"},OVERSEA:{DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.my-imcloud.com",STAT:"https://api.my-imcloud.com"},SINGAPORE:{DEFAULT:"wss://wsssgp.im.qcloud.com",BACKUP:"wss://wsssgp.my-imcloud.com",STAT:"https://apisgp.my-imcloud.com",ANYCAST:"wss://162.14.19.159"},KOREA:{DEFAULT:"wss://wsskr.im.qcloud.com",BACKUP:"wss://wsskr.my-imcloud.com",STAT:"https://apikr.my-imcloud.com",ANYCAST:"wss://162.14.13.104"},GERMANY:{DEFAULT:"wss://wssger.im.qcloud.com",BACKUP:"wss://wssger.my-imcloud.com",STAT:"https://apiger.my-imcloud.com",ANYCAST:"wss://162.14.3.17"},IND:{DEFAULT:"wss://wssind.my-imcloud.com",BACKUP:"wss://wssind.im.qcloud.com",STAT:"https://apiind.my-imcloud.com",ANYCAST:"wss://162.14.18.188"},JPN:{DEFAULT:"wss://wssjpn.im.qcloud.com",BACKUP:"wss://wssjpn.my-imcloud.com",STAT:"https://apijpn.my-imcloud.com"},USA:{DEFAULT:"wss://wssusa.im.qcloud.com",BACKUP:"wss://wssusa.my-imcloud.com",STAT:"https://apiusa.my-imcloud.com",ANYCAST:"wss://162.14.10.42"},INDONESIA:{DEFAULT:"wss://wssidn.im.qcloud.com",BACKUP:"wss://wssidn.my-imcloud.com",STAT:"https://apiidn.my-imcloud.com",ANYCAST:"wss://43.129.34.169"}}},w={ANDROID:2,IOS:3,MAC:4,WEB:7,WX_MP:8,QQ_MP:9,TT_MP:10,BAIDU_MP:11,ALI_MP:12,IPAD:13,UNI_NATIVE_APP:15},q="1.7.3",x=537048168,V="CHINA",a={HOST:{CURRENT:{DEFAULT:"wss://wss.im.qcloud.com",STAT:"https://events.im.qcloud.com"},setCurrent:function(){this.CURRENT=F.PRODUCTION[0<arguments.length&&void 0!==arguments[0]?arguments[0]:V]}},NAME:{OPEN_IM:"openim",OPEN_IM_MSG_EXT:"openim_msg_ext_http_svc",GRP:"group_open_http_svc",GRP_AV:"group_open_avchatroom_http_svc",GRP_COMMUNITY:"million_group_open_http_svc",GRP_ATTR:"group_open_attr_http_svc",FD:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GRP_NO_AUTH:"group_open_http_noauth_svc",BIG_GRP_POLLING:"group_open_long_polling_http_svc",BIG_GRP_POLLING_NO_AUTH:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat",WEB_IM:"webim",IM_COS_SIGN:"im_cos_sign_svr",CUSTOM_UPLOAD:"im_cos_msg",HEARTBEAT:"heartbeat",IM_OPEN_PUSH:"im_open_push",IM_OPEN_STATUS:"im_open_status",IM_LONG_MSG:"im_long_msg",IM_CONFIG_MANAGER:"im_sdk_config_mgr",STAT_SERVICE:"StatSvc",OVERLOAD_PUSH:"OverLoadPush",IM_MSG_AUDIT_MGR:"im_msg_audit_mgr",TUIROOM_SVR:"tui_room_svr",IM_OPEN_TRANSLATE:"im_open_translate",IM_OPEN_SPEECH:"im_open_speech",MSG_SEARCH:"message_search",FOLLOW:"follow",OFFLINE_PUSH_REPORT:"offline_push_report",IM_MSG_LOGIC:"im_msg_db_logic"}},H={SEARCH_GRP_SNS:new b(0,Math.pow(2,1)).toString(),AV_HISTORY_MSG:new b(0,Math.pow(2,2)).toString(),GRP_COMMUNITY:new b(0,Math.pow(2,3)).toString(),MSG_TO_SPECIFIED_GRP_MBR:new b(0,Math.pow(2,4)).toString(),AV_MBR_LIST:new b(0,Math.pow(2,6)).toString(),USER_STATUS:new b(0,Math.pow(2,7)).toString(),CONV_MARK:new b(0,Math.pow(2,9)).toString(),CONV_GROUP:new b(0,Math.pow(2,10)).toString(),AV_BAN_MBR:new b(0,Math.pow(2,11)).toString(),MSG_EXT:new b(0,Math.pow(2,13)).toString(),GRP_COUNTER:new b(0,Math.pow(2,15)).toString(),PLUGIN_TRANSLATE:new b(Math.pow(2,6)).toString(),PLUGIN_VOICE_TO_TEXT:new b(Math.pow(2,7)).toString(),PLUGIN_CS:new b(Math.pow(2,8)).toString(),PLUGIN_PUSH:new b(Math.pow(2,9)).toString(),PLUGIN_BOT:new b(Math.pow(2,10)).toString(),MSG_REACTION:new b(Math.pow(2,16)).toString(),FOLLOW:new b(Math.pow(2,20)).toString()},B="group_profile";function K(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;u(this,K),this.high=e,this.low=t}function W(){u(this,W),this.cache=[],this.options=null}a.HOST.setCurrent(V);var Y="undefined"!=typeof wx&&"function"==typeof wx.getSystemInfoSync&&Boolean(wx.getSystemInfoSync().fontSizeSetting),j=Y&&"function"==typeof wx.createGamePortal,J="undefined"!=typeof qq&&"function"==typeof qq.getSystemInfoSync&&Boolean(qq.getSystemInfoSync().fontSizeSetting),z="undefined"!=typeof tt&&"function"==typeof tt.getSystemInfoSync&&Boolean(tt.getSystemInfoSync().fontSizeSetting),X="undefined"!=typeof swan&&"function"==typeof swan.getSystemInfoSync&&Boolean(swan.getSystemInfoSync().fontSizeSetting),Z="undefined"!=typeof my&&"function"==typeof my.getSystemInfoSync&&Boolean(my.getSystemInfoSync().fontSizeSetting),Q="undefined"!=typeof jd&&"function"==typeof jd.getSystemInfoSync,$="undefined"!=typeof uni&&"undefined"==typeof window&&"function"==typeof uni.requireNativePlugin,ee="undefined"!=typeof uni,te=Y||J||z||X||Z||$||Q,ne=("undefined"!=typeof uni||"undefined"!=typeof window)&&!te,oe=J?qq:z?tt:X?swan:Z?my:Y?wx:$?uni:Q?jd:{},ie=ne&&window&&window.navigator&&window.navigator.userAgent||"",Q=/(micromessenger|webbrowser)/i.test(ie),ae=/AppleWebKit\/([\d.]+)/i.exec(ie);ae&&parseFloat(ae.pop());ae="WEB",Q?ae="WEB":J?ae="QQ_MP":z?ae="TT_MP":X?ae="BAIDU_MP":Z?ae="ALI_MP":Y?ae="WX_MP":$&&(ae="UNI_NATIVE_APP");var se=w[ae],Q=/iPad/i.test(ie),ae=/iPhone/i.test(ie)&&!Q,re=/iPod/i.test(ie),ce=ae||Q||re,ue=(ae=ie.match(/OS (\d+)_/i))&&ae[1]?ae[1]:null,le=/Android/i.test(ie),de=function(){var e=ie.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;var t=e[1]&&parseFloat(e[1]),n=e[2]&&parseFloat(e[2]);return t&&n?parseFloat(e[1]+"."+e[2]):t||null}(),Q=/Edge/i.test(ie),re=!Q&&/Chrome/i.test(ie),pe=((ae=ie.match(/Chrome\/(\d+)/))&&ae[1]&&parseFloat(ae[1]),/MSIE/.test(ie)||-1<ie.indexOf("Trident")&&-1<ie.indexOf("rv:11.0")),_e=ae=!(ae=(ae=/MSIE\s(\d+)\.\d/.exec(ie))&&parseFloat(ae[1]))&&/Trident\/7.0/i.test(ie)&&/rv:11.0/.test(ie)?11:ae,ge=/Safari/i.test(ie)&&!re&&!le&&!Q;(ae=ie.match(/TBS\/(\d+)/i))&&ae[1]&&ae[1];for(var he,fe=/Windows/i.test(ie),me=/MAC OS X/i.test(ie),ve=ne&&"undefined"!=typeof Worker&&!pe,Me=le||ce,Ie=ne&&void 0!==window.tencent_cloud_im_csig_flutter_for_web_25F_cy,ye=function(){if("undefined"==typeof window||void 0===window.navigator)return!1;var e=window.navigator.standalone;return!(!ce||e||ge)}(),Ce="undefined"!=typeof console?console:"undefined"!=typeof global&&global.console?global.console:"undefined"!=typeof window&&window.console?window.console:{},Te=function(){},De=["assert","clear","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],Ee=De.length;Ee--;)he=De[Ee],console[he]||(Ce[he]=Te);function Le(){var e=new Date;return e.setTime(Oe()),e}function Se(){Re=0}function Ae(){return Math.floor(Oe()/1e3)}var ke=Ce,Re=0,Oe=function(){return(new Date).getTime()+Re},Ne=0;function Ge(){return Kt()?"%c Chat %c":"Chat"}function Pe(){var e=Le();return e.toLocaleTimeString("en-US",{hour12:!1})+"."+function(e){var t;switch(e.toString().length){case 1:t="00"+e;break;case 2:t="0"+e;break;default:t=e}return t}(e.getMilliseconds())}var A={arguments2String:function(e){var t="";if(1===e.length)t=e[0];else for(var n=0,o=e.length;n<o;n++)_t(e[n])?gt(e[n])?t+=ft(e[n]):t+=JSON.stringify(e[n]):t+=e[n],t+=" ";return t},_exec:function(e,t){Kt()?ke[e](Ge(),"background:#0abf5b; padding:1px; border-radius:3px; color: #fff","background:transparent",Pe(),t):ke[e]("".concat(Ge()," ").concat(Pe()," ").concat(t))},d:function(){var e;Ne<=-1&&(e=this.arguments2String(arguments),this._exec("debug",e))},l:function(){var e;Ne<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},log:function(){var e;Ne<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},i:function(){var e;Ne<=1&&(e=this.arguments2String(arguments),this._exec("info",e))},w:function(){var e;Ne<=2&&(e=this.arguments2String(arguments),this._exec("warn",e))},e:function(){var e;Ne<=3&&(e=this.arguments2String(arguments),this._exec("error",e))},setLevel:function(e){e<4&&this._exec("log","set level from "+Ne+" to "+e),Ne=e},getLevel:function(){return Ne}},Ue={JPG:1,JPEG:1,GIF:2,PNG:3,BMP:4,UNKNOWN:255},re="Tag_Profile_IM_",be={NICK:"".concat(re,"Nick"),GENDER:"".concat(re,"Gender"),BIRTHDAY:"".concat(re,"BirthDay"),LOCATION:"".concat(re,"Location"),SELFSIGNATURE:"".concat(re,"SelfSignature"),ALLOWTYPE:"".concat(re,"AllowType"),LANGUAGE:"".concat(re,"Language"),AVATAR:"".concat(re,"Image"),MESSAGESETTINGS:"".concat(re,"MsgSettings"),ADMINFORBIDTYPE:"".concat(re,"AdminForbidType"),LEVEL:"".concat(re,"Level"),ROLE:"".concat(re,"Role")},Fe={GROUP:"".concat("Tag_SNS_IM_","Group"),REMARK:"".concat("Tag_SNS_IM_","Remark"),ADDSOURCE:"".concat("Tag_SNS_IM_","AddSource"),ADDWORDING:"".concat("Tag_SNS_IM_","Wording"),ADDTIME:"".concat("Tag_SNS_IM_","AddTime")},Q="Gender_Type_",we={UNKNOWN:"".concat(Q,"Unknown"),FEMALE:"".concat(Q,"Female"),MALE:"".concat(Q,"Male")},qe={NONE:"".concat("AdminForbid_Type_","None"),SEND_OUT:"".concat("AdminForbid_Type_","SendOut")},xe={NEED_CONFIRM:"".concat("AllowType_Type_","NeedConfirm"),ALLOW_ANY:"".concat("AllowType_Type_","AllowAny"),DENY_ANY:"".concat("AllowType_Type_","DenyAny")},Ve="JoinedSuccess",He="WaitAdminApproval",Be="@TOPIC#_",Ke=Object.prototype.hasOwnProperty;function We(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(Ze(e)){for(var t in e)if(Ke.call(e,t))return!1;return!0}return!!(Ye(e)||je(e)||Je(e))&&0===e.size}function Ye(e){return"map"===ht(e)}function je(e){return"set"===ht(e)}function Je(e){return"file"===ht(e)}function ze(e){return null!==e&&("number"==typeof e&&!isNaN(+e)||"object"===r(e)&&e.constructor===Number)}function Xe(e){return null!==e&&"object"===r(e)}function Ze(e){if("object"===r(e)&&null!==e){if(null===(e=Object.getPrototypeOf(e)))return 1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return e===t}}function Qe(e){return"function"==typeof Array.isArray?Array.isArray(e):"array"===ht(e)}function $e(e){return"function"==typeof e}function et(e){return"filelist"===ht(e)}function nt(e){return"string"==typeof e&&(e=e[0],!/[^a-zA-Z0-9]/.test(e))}function ot(e,t,n,o){if(!_t(e)||!_t(t))return 0;for(var i,a=0,s=Object.keys(t),r=0,c=s.length;r<c;r++)if(i=s[r],!(k(t[i])||n&&n.includes(i)))if(_t(e[i])&&_t(t[i]))a+=ot(e[i],t[i],n,o);else{if(o&&o.includes(t[i]))continue;e[i]!==t[i]&&(e[i]=t[i],a+=1)}return a}function it(e,t){var n,o=new Map,i=N(e.entries());try{for(i.s();!(n=i.n()).done;){var a=I(n.value,2),s=a[0],r=a[1];o.set(s,t?JSON.stringify(r):JSON.parse(JSON.stringify(r)))}}catch(e){i.e(e)}finally{i.f()}return o}function at(e){if(0===e.length)return 0;for(var t=0,n=0,o="undefined"!=typeof document&&void 0!==document.characterSet?document.characterSet:"UTF-8";void 0!==e[t];)n+=e[t++].charCodeAt[t]<=255?1:!1===o?3:2;return n}function st(e){return e=e||99999999,Math.round(Math.random()*e)}function rt(){for(var e="",t=32;0<t;--t)e+=mt[Math.floor(Math.random()*vt)];return e}function ct(e,t){for(var n in e)if(e[n]===t)return 1}function ut(e){return-1===e.indexOf("http://")||-1===e.indexOf("https://")?"https://"+e:e.replace(/https|http/,"https")}function lt(e){if(0===Object.getOwnPropertyNames(e).length)return Object.create(null);var t,n,o=Array.isArray(e)?[]:Object.create(null);for(n in e)null!==e[n]?void 0!==e[n]?(t=r(e[n]),0<=["string","number","function","boolean"].indexOf(t)?o[n]=e[n]:o[n]=lt(e[n])):o[n]=void 0:o[n]=null;return o}var dt=["url"],pt=function(e){return"string"==typeof e},k=function(e){return void 0===e},_t=function(e){return Qe(e)||Xe(e)},gt=function(e){return e instanceof Error},ht=function(e){return Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase()},ft=(Date.now||(Date.now=function(){return(new Date).getTime()}),function(e){return JSON.stringify(e,["message","code"])}),mt="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",vt=mt.length,Mt={};function It(o,e){if(!Qe(o)||!Qe(e))return!1;var i=!1;return e.forEach(function(e){var t=e.key,e=e.value,n=o.find(function(e){return e.key===t});n?n.value!==e&&(n.value=e,i=!0):(o.push({key:t,value:e}),i=!0)}),i}function yt(e){return We(e)?[]:e.filter(function(e){return!0===e.isModified})}function Ct(e){return We(e)?[]:e.filter(function(e){return!1===e.isModified})}function Tt(e){return e===S.GRP_AVCHATROOM}function Dt(e){var t=e.type,e=e.groupID;return t===S.GRP_COMMUNITY||"".concat(e).startsWith("@TGS#_")&&!"".concat(e).includes(Be)}function Et(e){return"".concat(e).startsWith("@TGS#_")&&"".concat(e).includes(Be)}function Lt(e){return pt(e)&&e.slice(0,3)===S.CONV_C2C}function St(e){return pt(e)&&e.slice(0,5)===S.CONV_GROUP}function At(e){return pt(e)&&e===S.CONV_SYSTEM}function kt(t,n){var o={};return Object.keys(t).forEach(function(e){o[e]=n(t[e],e)}),o}function Rt(o){return te?new Promise(function(t,e){oe.getImageInfo({src:o,success:function(e){t({width:e.width,height:e.height})},fail:function(){t({width:0,height:0})}})}):pe&&9===_e?Promise.resolve({width:0,height:0}):new Promise(function(e,t){var n=new Image;n.onload=function(){e({width:this.width,height:this.height}),n=null},n.onerror=function(){e({width:0,height:0}),n=null},n.src=o})}function Ot(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return"".concat(e()+e()).concat(e()).concat(e()).concat(e()).concat(e()).concat(e()).concat(e())}function Nt(){var e=le?"android":ce?"ios":fe?"windows":me?"mac":"unknown";if(te)try{var t=oe.getSystemInfoSync().platform;void 0!==t&&(e=t)}catch(e){}return e}function Gt(e,t){e=e.split("."),t=t.split(".");for(var n=Math.max(e.length,t.length);e.length<n;)e.push("0");for(;t.length<n;)t.push("0");for(var o=0;o<n;o++){var i=parseInt(e[o]),a=parseInt(t[o]);if(a<i)return 1;if(i<a)return-1}return 0}function Pt(e){var t=e.originUrl,t=void 0===t?void 0:t,n=e.originWidth,o=e.originHeight,e=e.min,e=void 0===e?198:e,n=parseInt(n),o=parseInt(o),i={url:void 0,width:0,height:0};return(n<=o?n:o)<=e?(i.url=t,i.width=n,i.height=o):(o<=n?(i.width=Math.ceil(n*e/o),i.height=e):(i.width=e,i.height=Math.ceil(o*e/n)),o=t&&-1<t.indexOf("?")?"".concat(t,"&"):"".concat(t,"?"),i.url="".concat(o,198===e?"imageView2/3/w/198/h/198":"imageView2/3/w/720/h/720")),k(t)?(i.url,h(i,dt)):i}function Ut(e){var t=e[2];e[2]=e[1],e[1]=t;for(var n=0;n<e.length;n++)e[n].setType(n)}function bt(e){e=e.servcmd;return e.slice(e.indexOf(".")+1)}function Ft(e,t){return Math.round(Number(e)*Math.pow(10,t))/Math.pow(10,t)}function wt(e,t){return e.includes(t)}function qt(e,t){return e.includes(t)}function xt(e){return e.split(Be)[0]}var Vt=function(e,t,n){if(k(t))return"";switch(e){case S.MSG_TEXT:return t.text;case S.MSG_IMAGE:return n?"[Image]":"[图片]";case S.MSG_LOCATION:return n?"[Location]":"[位置]";case S.MSG_AUDIO:return n?"[Voice]":"[语音]";case S.MSG_VIDEO:return n?"[Video]":"[视频]";case S.MSG_FILE:return n?"[File]":"[文件]";case S.MSG_CUSTOM:return n?"[Custom Messages]":"[自定义消息]";case S.MSG_GRP_TIP:return n?"[Group Notification]":"[群提示消息]";case S.MSG_GRP_SYS_NOTICE:return n?"[Group System Message]":"[群系统通知]";case S.MSG_FACE:return n?"[Animated Sticker]":"[动画表情]";case S.MSG_MERGER:return n?"[Chat Record]":"[聊天记录]";default:return""}};function Ht(e){return e===S.MSG_TEXT||e===S.MSG_CUSTOM||e===S.MSG_LOCATION||e===S.MSG_FACE}function Bt(e){var t=[];if(!pt(e))return t;var n=e.length;if(0===n)return t;for(var o=n-1;0<=o;o--)"1"===e[o]&&t.push(Math.pow(2,n-o-1));return t}function Kt(){return!pe&&!te}function Wt(e){return"the length of userIDList cannot exceed ".concat(e)}function Yt(e,t){var n;if(e)return n=e,t&&(e.startsWith("http://")?n=e.replace(/^http:\/\/[^/]+/,t):e.startsWith("https://")&&(n=e.replace(/^https:\/\/[^/]+/,t))),n}function jt(e){var t;if(Qe(e)&&0!==e.length)return t=0,e.forEach(function(e){t+=e}),t.toFixed(0)}function Jt(e){var t;if(Qe(e)&&0!==e.length)return t=0,e.forEach(function(e){t+=e}),(t/e.length).toFixed(0)}function zt(e,t,n){var t=!(1<arguments.length&&void 0!==t)||t,n=!(2<arguments.length&&void 0!==n)||n,o=Date.now();return t?n?"".concat(o-e," ms"):"".concat(Math.round((o-e)/1e3)," s"):n?o-e:Math.round((o-e)/1e3)}function Xt(e){return e&&1<e?!0:!1}function Zt(e,t,n,o){if(void 0===t)return 1;var i,a,s=!0;return t.required&&We(e)&&(A.e("[".concat(n,'] Missing required params: "').concat(o,'".')),s=!1),We(e)||(i=ht(e))!==(a=t.type.toLowerCase())&&("asyncfunction"===i&&"function"===a||(A.e("[".concat(n,'] Invalid params: type check failed for "').concat(o,'". Expected ').concat(t.type,".")),s=!1)),t.validator&&!t.validator(e,n,o)&&(A.e("[".concat(n,'] Invalid params: custom validator check failed for "').concat(o,'".')),s=!1),s}function Qt(e){return!!e&&(!!(Lt(e)||St(e)||At(e))||((e=Gn("InvalidConversationID",e))&&A.w(e),!1))}function s(e){""!==e.desc&&""!==Gn("API_REFER")&&A.w("[".concat(e.api,"] | ").concat(e.paramName," | ").concat(e.desc,", ").concat(Gn("API_REFER")).concat(e.api))}function $t(){return Gn("StringRequiredLog")}function en(e){return Gn("NonEmptyStringRequiredLog",e)}function tn(){return Gn("NumberRequiredLog")}function nn(){return Gn("UndefinedNotAllowedLog")}function on(){return Gn("FileRequiredLog")}function an(){return Gn("FunctionRequiredLog")}function sn(){return Gn("ArrayRequiredLog")}function rn(){return Gn("NonEmptyArrayLog")}function cn(){return Gn("CallbackMissingLog")}function un(){return Gn("PositiveIntegerRequiredLog")}function ln(e,t){return Gn("StringNotLongerThanLog",e,t)}function dn(e,t){return Gn("NumberGreaterOrEqualLog",e,t)}function pn(e){return Gn("KeyValueStringRequiredLog",e)}function _n(){return Gn("PlainObjectRequiredLog")}function gn(){return Gn("NonEmptyContentRequiredLog")}function hn(){return Gn("FileNotSelectedLog")}function fn(){return Gn("MessageInstanceRequiredLog")}function mn(){return Gn("NonAnonymousFunctionLog")}function vn(){return Gn("MessageExtensionNotAvailableLog")}function Mn(){return Gn("MessageReactionRequiredLog")}function In(e,t){return Gn("MaximumArrayLengthLog",e,t)}function yn(e){return{code:0,data:e||{}}}function Cn(e){return Promise.resolve(yn(e))}function m(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(e instanceof bn)return t&&null!==Fn&&Fn.emit(G.ERROR,e),Promise.reject(e);if(e instanceof Error)return n=new bn({code:C.UNCAUGHT_ERROR}),t&&null!==Fn&&Fn.emit(G.ERROR,n),Promise.reject(n);if(k(e)||k(e.code))return Promise.reject(new bn({code:C.UNCAUGHT_ERROR}));var n=new bn(e);return t&&null!==Fn&&Fn.emit(G.ERROR,n),Promise.reject(n)}var Tn,Dn="unSend",En="success",Ln="fail",Sn="notStart",An="pending",kn="resolved",Rn="rejected",ae={type:"String",required:!0},re={type:"Array",required:!0},Q={type:"Object",required:!0},On={type:"Boolean",required:!0},Nn={type:"number",required:!0},Gn=null,Pn={hookGetAPITips:function(e){Gn=e},login:{userID:ae,userSig:ae},addToBlacklist:{userIDList:re},removeFromBlacklist:{userIDList:re},on:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(s({api:t,paramName:n,desc:an()}),!1):(""===e.name&&s({api:t,paramName:n,desc:mn()}),!0)}}],once:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(s({api:t,paramName:n,desc:an()}),!1):(""===e.name&&s({api:t,paramName:n,desc:mn()}),!0)}}],off:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(s({api:t,paramName:n,desc:an()}),!1):(""===e.name&&s({api:t,paramName:n,desc:mn()}),!0)}}],sendMessage:[y({name:"message"},Q)],setMessageExtensions:[y(y({name:"message"},Q),{},{validator:function(e,t,n){return e.status===En&&!0===e.isSupportExtension||(s({api:t,paramName:n,desc:vn()}),!1)}}),y({name:"extensions"},re)],getMessageExtensions:[y(y({name:"message"},Q),{},{validator:function(e,t,n){return e.status===En&&!0===e.isSupportExtension||(s({api:t,paramName:n,desc:vn()}),!1)}})],deleteMessageExtensions:[y(y({name:"message"},Q),{},{validator:function(e,t,n){return e.status===En&&!0===e.isSupportExtension||(s({api:t,paramName:n,desc:vn()}),!1)}})],addMessageReaction:[y(y({name:"message"},Q),{},{validator:function(e,t,n){return e.status===En||(s({api:t,paramName:n,desc:Mn()}),!1)}}),y({name:"reactionID"},ae)],removeMessageReaction:[y(y({name:"message"},Q),{},{validator:function(e,t,n){return e.status===En||(s({api:t,paramName:n,desc:Mn()}),!1)}}),y({name:"reactionID"},ae)],getMessageReactions:{messageList:y({},re)},getAllUserListOfMessageReaction:{message:y(y({},Q),{},{validator:function(e,t,n){return e.status===En||(s({api:t,paramName:n,desc:Mn()}),!1)}}),reactionID:y({},ae),nextSeq:{type:"Number"},count:{type:"Number"}},getMessageList:{conversationID:y(y({},ae),{},{validator:Qt}),nextReqMessageID:{type:"String"},count:{type:"Number",validator:function(e,t,n){return!(!k(e)&&!/^[1-9][0-9]*$/.test(e)&&(s({api:t,paramName:n,desc:un()}),1))}}},getMessageListHopping:{conversationID:y(y({},ae),{},{validator:Qt}),sequence:{type:"Number"},time:{type:"Number"},direction:{type:"Number",validator:function(e,t,n){return!(!k(e)&&0!==e&&1!==e&&(s({api:t,paramName:n,desc:Gn("0Or1RequiredLog")}),1))}},count:{type:"Number",validator:function(e,t,n){return!(!k(e)&&!/^[1-9][0-9]*$/.test(e)&&(s({api:t,paramName:n,desc:un}),1))}}},setMessageRead:{conversationID:y(y({},ae),{},{validator:Qt})},setAllMessageRead:{scope:{type:"String",required:!1,validator:function(e,t,n){return!e||-1!==[S.READ_ALL_C2C_MSG,S.READ_ALL_GROUP_MSG,S.READ_ALL_MSG].indexOf(e)||(s({api:t,paramName:n,desc:Gn("ValidScopeRequired")}),!1)}}},getConversationProfile:[y(y({name:"conversationID"},ae),{},{validator:Qt})],clearHistoryMessage:[y(y({name:"conversationID"},ae),{},{validator:Qt})],pinConversation:{conversationID:y(y({},ae),{},{validator:Qt}),isPinned:y({},On)},setConversationDraft:{conversationID:y(y({},ae),{},{validator:Qt}),draftText:{type:"String",validator:function(e,t,n){return!!pt(e)||(s({api:t,paramName:n,desc:$t()}),!1)}}},setConversationCustomData:{conversationIDList:y({},re),customData:{type:"String",validator:function(e,t,n){return pt(e)?!(256<e.length&&(s({api:t,paramName:n,desc:ln(n,256)}),1)):(s({api:t,paramName:n,desc:$t()}),!1)}}},markConversation:{conversationIDList:y({},re),markType:{type:"number",validator:function(e,t,n){return ze(e)?e<=0?(s({api:t,paramName:n,desc:Gn("NumberGreaterThanLog",n,0)}),!1):!(e>=Math.pow(2,64)&&(s({api:t,paramName:n,desc:Gn("NumberLessThanLog",n,"Math.pow(2,64)")}),1)):(s({api:t,paramName:n,desc:tn()}),!1)}},enableMark:y({},On)},createConversationGroup:{conversationIDList:y({},re),groupName:y(y({},ae),{},{validator:function(e,t,n){return!(!e||32<e.length&&(s({api:t,paramName:n,desc:ln(n,32)}),1))}})},deleteConversationGroup:[y({name:"groupName"},ae)],renameConversationGroup:{oldName:y({},ae),newName:y(y({},ae),{},{validator:function(e,t,n){return!(!e||32<e.length&&(s({api:t,paramName:n,desc:ln(n,32)}),1))}})},addConversationsToGroup:{conversationIDList:y({},re),groupName:y({},ae)},deleteConversationsFromGroup:{conversationIDList:y({},re),groupName:y({},ae)},getGroupList:{groupProfileFilter:{type:"Array"}},getGroupProfile:{groupID:ae,groupCustomFieldFilter:{type:"Array"},memberCustomFieldFilter:{type:"Array"}},getGroupProfileAdvance:{groupIDList:re},createGroup:{name:ae},joinGroup:{groupID:ae,type:{type:"String"},applyMessage:{type:"String"}},quitGroup:[y({name:"groupID"},ae)],handleApplication:{message:Q,handleAction:ae,handleMessage:{type:"String"}},changeGroupOwner:{groupID:ae,newOwnerID:ae},updateGroupProfile:{groupID:ae,muteAllMembers:{type:"Boolean"}},dismissGroup:[y({name:"groupID"},ae)],searchGroupByID:[y({name:"groupID"},ae)],getGroupOnlineMemberCount:[y({name:"groupID"},ae)],initGroupAttributes:{groupID:ae,groupAttributes:y(y({},Q),{},{validator:function(t,n,o){var i=!0;return Object.keys(t).forEach(function(e){if(!pt(t[e]))return s({api:n,paramName:o,desc:pn("value")}),i=!1}),i}})},setGroupAttributes:{groupID:ae,groupAttributes:y(y({},Q),{},{validator:function(t,n,o){var i=!0;return Object.keys(t).forEach(function(e){if(!pt(t[e]))return s({api:n,paramName:o,desc:pn("value")}),i=!1}),i}})},deleteGroupAttributes:{groupID:ae,keyList:{type:"Array",validator:function(e,t,n){return k(e)||!Qe(e)?(s({api:t,paramName:n,desc:sn()}),!1):!!We(e)||(o=!0,e.forEach(function(e){if(!pt(e))return s({api:t,paramName:n,desc:Gn("StringArrayRequiredLog")}),o=!1}),o);var o}}},getGroupAttributes:{groupID:ae,keyList:{type:"Array",validator:function(e,t,n){return k(e)||!Qe(e)?(s({api:t,paramName:n,desc:sn()}),!1):!!We(e)||(o=!0,e.forEach(function(e){if(!pt(e))return s({api:t,paramName:n,desc:pn("key")}),o=!1}),o);var o}}},setGroupCounters:{groupID:ae,counters:Q},increaseGroupCounter:{groupID:ae,key:ae,value:Nn},decreaseGroupCounter:{groupID:ae,key:ae,value:Nn},getGroupCounters:{groupID:ae},getGroupMemberList:{groupID:ae,count:{type:"Number"}},getGroupMemberProfile:{groupID:ae,userIDList:re,memberCustomFieldFilter:{type:"Array"}},addGroupMember:{groupID:ae,userIDList:re},setGroupMemberRole:{groupID:ae,userID:ae,role:ae},setGroupMemberMuteTime:{groupID:ae,userID:ae,muteTime:{type:"Number",validator:function(e){return 0<=e}}},setGroupMemberNameCard:{groupID:ae,userID:{type:"String"},nameCard:{type:"String",validator:function(e,t,n){return pt(e)?(e.length,!0):(s({api:t,paramName:n,desc:$t()}),!1)}}},setGroupMemberCustomField:{groupID:ae,userID:{type:"String"},memberCustomField:re},deleteGroupMember:{groupID:ae},markGroupMemberList:{groupID:ae,markType:{type:"number",validator:function(e,t,n){return ze(e)?!(e<1e3&&(s({api:t,paramName:n,desc:dn(n,1e3)}),1)):(s({api:t,paramName:n,desc:tn()}),!1)}},userIDList:y({},re),enableMark:y({},On)},createTextMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){return Ze(e)?pt(e.text)?0!==e.text.length||(s({api:t,paramName:"payload.text",desc:gn()}),!1):(s({api:t,paramName:"payload.text",desc:$t()}),!1):(s({api:t,paramName:n,desc:_n()}),!1)}})},createTextAtMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){return Ze(e)?pt(e.text)?0===e.text.length?(s({api:t,paramName:"payload.text",desc:gn()}),!1):!(e.atUserList&&!Qe(e.atUserList)&&(s({api:t,paramName:"payload.atUserList",desc:sn()}),1)):(s({api:t,paramName:"payload.text",desc:$t()}),!1):(s({api:t,paramName:n,desc:_n()}),!1)}})},createCustomMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){return Ze(e)?e.data&&!pt(e.data)?(s({api:t,paramName:"payload.data",desc:$t()}),!1):e.description&&!pt(e.description)?(s({api:t,paramName:"payload.description",desc:$t()}),!1):!(e.extension&&!pt(e.extension)&&(s({api:t,paramName:"payload.extension",desc:$t()}),1)):(s({api:t,paramName:"payload",desc:_n()}),!1)}})},createImageMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){if(!Ze(e))return s({api:t,paramName:n,desc:_n()}),!1;if(k(e.file))return s({api:t,paramName:"payload.file",desc:nn()}),!1;if(ne){if(!(e.file instanceof HTMLInputElement||Je(e.file)))return Ze(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(s({api:t,paramName:"payload.file",desc:hn()}),!1):(s({api:t,paramName:"payload.file",desc:on()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return s({api:t,paramName:"payload.file",desc:hn()}),!1}return!0},onProgress:{type:"Function",required:!1,validator:function(e,t,n){return k(e)&&s({api:t,paramName:n,desc:cn()}),!0}}})},createAudioMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){return!!Ze(e)||(s({api:t,paramName:n,desc:_n()}),!1)}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return k(e)&&s({api:t,paramName:n,desc:cn()}),!0}}},createVideoMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){if(!Ze(e))return s({api:t,paramName:n,desc:_n()}),!1;if(k(e.file))return s({api:t,paramName:"payload.file",desc:nn()}),!1;if(ne){if(!(e.file instanceof HTMLInputElement||Je(e.file)))return Ze(e.file)&&"undefined"!=typeof uni?!!Je(e.file.tempFile)||(s({api:t,paramName:"payload.file",desc:hn()}),!1):(s({api:t,paramName:"payload.file",desc:on()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return s({api:t,paramName:"payload.file",desc:hn()}),!1}return!0}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return k(e)&&s({api:t,paramName:n,desc:cn()}),!0}}},createFaceMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){return Ze(e)?ze(e.index)?!!pt(e.data)||(s({api:t,paramName:"payload.data",desc:$t()}),!1):(s({api:t,paramName:"payload.index",desc:tn()}),!1):(s({api:t,paramName:n,desc:_n()}),!1)}})},createFileMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){if(!Ze(e))return s({api:t,paramName:n,desc:_n()}),!1;if(k(e.file))return s({api:t,paramName:"payload.file",desc:nn()}),!1;if(ne){if(!(e.file instanceof HTMLInputElement||Je(e.file)))return Ze(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(s({api:t,paramName:"payload.file",desc:hn()}),!1):(s({api:t,paramName:"payload.file",desc:on()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return s({api:t,paramName:"payload.file",desc:hn()}),!1}return!0}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return k(e)&&s({api:t,paramName:n,desc:cn()}),!0}}},createLocationMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){return Ze(e)?pt(e.description)?ze(e.longitude)?!!ze(e.latitude)||(s({api:t,paramName:"payload.latitude",desc:tn()}),!1):(s({api:t,paramName:"payload.longitude",desc:tn()}),!1):(s({api:t,paramName:"payload.description",desc:$t()}),!1):(s({api:t,paramName:n,desc:_n()}),!1)}})},createMergerMessage:{to:ae,conversationType:ae,payload:y(y({},Q),{},{validator:function(e,t,n){if(We(e.messageList))return s({api:t,paramName:"payload.messageList",desc:rn()}),!1;if(We(e.compatibleText))return s({api:t,paramName:"payload.compatibleText",desc:en("compatibleText")}),!1;var o=!1;return e.messageList.forEach(function(e){e.status===Ln&&(o=!0)}),!o||(s({api:t,paramName:"payload.messageList",desc:Gn("MergeFailedMessageLog")}),!1)}})},revokeMessage:[y(y({name:"message"},Q),{},{validator:function(e,t,n){return We(e)?(s({api:t,paramName:n,desc:fn()}),!1):e.conversationType===S.CONV_SYSTEM?(s({api:t,paramName:n,desc:Gn("MessageCanBeRevokedDesc")}),!1):!0!==e.isRevoked||(s({api:t,paramName:n,desc:Gn("MessageRevokedLog")}),!1)}})],deleteMessage:[y(y({name:"messageList"},re),{},{validator:function(e,t,n){return!We(e)||(s({api:t,paramName:n,desc:rn()}),!1)}})],translateText:{sourceTextList:re,sourceLanguage:ae,targetLanguage:ae},convertVoiceToText:{message:y(y({},Q),{},{validator:function(e,t,n){return We(e)?(s({api:t,paramName:n,desc:fn()}),!1):e.type===S.MSG_AUDIO&&e.status===En||(s({api:t,paramName:n,desc:Gn("AudioMessageRequiredLog")}),!1)}})},modifyMessage:[y(y({name:"message"},Q),{},{validator:function(e,t,n){return We(e)?(s({api:t,paramName:n,desc:fn()}),!1):e.conversationType===S.CONV_SYSTEM?(s({api:t,paramName:n,desc:Gn("MessageCanBeModifiedLog")}),!1):!0!==e._onlineOnlyFlag||(s({api:t,paramName:n,desc:Gn("OnlineMessageNotSupportLog")}),!1)}})],searchCloudMessages:{keywordList:{type:"Array",required:!1,validator:function(e,t,n){return!(e&&(Qe(e)?0===e.length?(s({api:t,paramName:n,desc:rn()}),1):5<e.length&&(s({api:t,paramName:n,desc:In(n,5)}),1):(s({api:t,paramName:n,desc:sn()}),1)))}},keywordListMatchType:{type:"String",required:!1,validator:function(e,t,n){return!e||"or"===e||"and"===e||s({api:t,paramName:n,desc:"".concat(e," is invalid match type")})}},senderUserIDList:{type:"Array",required:!1,validator:function(e,t,n){return!(e&&(Qe(e)?(0===e.length&&s({api:t,paramName:n,desc:rn()}),5<e.length&&(s({api:t,paramName:n,desc:In(n,5)}),1)):(s({api:t,paramName:n,desc:sn()}),1)))}},messageTypeList:{type:"Array",required:!1,validator:function(e,t,n){if(!e)return!0;if(!Qe(e))return s({api:t,paramName:n,desc:sn()}),!1;0===e.length&&s({api:t,paramName:n,desc:rn()});var o=[S.MSG_TEXT,S.MSG_IMAGE,S.MSG_AUDIO,S.MSG_FILE,S.MSG_VIDEO,S.MSG_LOCATION,S.MSG_CUSTOM,S.MSG_MERGER];return!(0<e.filter(function(e){return-1===o.indexOf(e)}).length&&(s({api:t,paramName:n,desc:Gn("ContainsUnsupportedMessageTypeLog",n)}),1))}},conversationID:{type:"String",required:!1,validator:function(e){return!e||Qt(e)}},timePosition:{type:"number",required:!1,validator:function(e,t,n){return!(e&&e<0&&(s({api:t,paramName:n,desc:dn(n,0)}),1))}},timePeriod:{type:"number",required:!1,validator:function(e,t,n){return!(e&&e<0&&(s({api:t,paramName:n,desc:dn(n,0)}),1))}},cursor:{type:"String",required:!1}},getUserProfile:{userIDList:{type:"Array",validator:function(e,t,n){return Qe(e)?(0===e.length&&s({api:t,paramName:n,desc:rn()}),!0):(s({api:t,paramName:n,desc:sn()}),!1)}}},updateMyProfile:{profileCustomField:{type:"Array",validator:function(e,t,n){return!!k(e)||!!Qe(e)||(s({api:t,paramName:n,desc:sn()}),!1)}}},setSelfStatus:{customStatus:{type:"String",validator:function(e,t,n){return!!pt(e)||(s({api:t,paramName:n,desc:$t()}),!1)}}},getUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return Qe(e)?0!==e.length||(s({api:t,paramName:n,desc:rn()}),!1):(s({api:t,paramName:n,desc:sn()}),!1)}}},subscribeUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return Qe(e)?0!==e.length||(s({api:t,paramName:n,desc:rn()}),!1):(s({api:t,paramName:n,desc:sn()}),!1)}}},unsubscribeUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return!e||!!Qe(e)||(s({api:t,paramName:n,desc:sn()}),!1)}}},addFriend:{to:ae,source:{type:"String",required:!0,validator:function(e,t,n){return!(!e||(e.startsWith("AddSource_Type_")?8<e.replace("AddSource_Type_","").length&&(s({api:t,paramName:n,desc:ln("keyword",8)}),1):(s({api:t,paramName:n,desc:Gn("SourcePrefixLog")}),1)))}},remark:{type:"String",required:!1,validator:function(e,t,n){return!(pt(e)&&96<e.length&&(s({api:t,paramName:n,desc:ln(n,96)}),1))}}},deleteFriend:{userIDList:re},checkFriend:{userIDList:re},getFriendProfile:{userIDList:re},updateFriend:{userID:ae,remark:{type:"String",required:!1,validator:function(e,t,n){return!(pt(e)&&96<e.length&&(s({api:t,paramName:n,desc:ln(n,96)}),1))}},friendCustomField:{type:"Array",required:!1,validator:function(e,t,n){if(e){if(!Qe(e))return s({api:t,paramName:n,desc:sn()}),!1;var o=!0;return e.forEach(function(e){return pt(e.key)&&-1!==e.key.indexOf("Tag_SNS_Custom")?pt(e.value)?8<e.key.replace("Tag_SNS_Custom_","").length?(s({api:t,paramName:n,desc:ln("keyword",8)}),o=!1):void 0:(s({api:t,paramName:n,desc:pn("value")}),o=!1):(s({api:t,paramName:n,desc:Gn("FriendCustomFieldPrefixLog")}),o=!1)}),o}return!0}}},acceptFriendApplication:{userID:ae},refuseFriendApplication:{userID:ae},deleteFriendApplication:{userID:ae},createFriendGroup:{name:ae},deleteFriendGroup:{name:ae},addToFriendGroup:{name:ae,userIDList:re},removeFromFriendGroup:{name:ae,userIDList:re},renameFriendGroup:{oldName:ae,newName:ae},sendMessageReadReceipt:[{name:"messageList",type:"Array",validator:function(e,t,n){return Qe(e)?0!==e.length||(s({api:t,paramName:n,desc:rn()}),!1):(s({api:t,paramName:n,desc:sn()}),!1)}}],getMessageReadReceiptList:[{name:"messageList",type:"Array",validator:function(e,t,n){return Qe(e)?0!==e.length||(s({api:t,paramName:n,desc:rn()}),!1):(s({api:t,paramName:n,desc:sn()}),!1)}}],createTopicInCommunity:{groupID:ae,topicName:ae},deleteTopicFromCommunity:{groupID:ae,topicIDList:{type:"Array",validator:function(e,t,n){return!e||!!Qe(e)||(s({api:t,paramName:n,desc:sn()}),!1)}}},updateTopicProfile:{groupID:ae,topicID:ae},getTopicList:{groupID:ae,topicIDList:{type:"Array",validator:function(e,t,n){return!e||!!Qe(e)||(s({api:t,paramName:n,desc:sn()}),!1)}}},followUser:[y({name:"userIDList"},re)],unfollowUser:[y({name:"userIDList"},re)],getMyFollowingList:[y(y({name:"startIndex"},ae),{},{required:!1})],getMyFollowersList:[y(y({name:"startIndex"},ae),{},{required:!1})],getMutualFollowersList:[y(y({name:"startIndex"},ae),{},{required:!1})],getUserFollowInfo:[y(y({name:"userIDList"},re),{},{required:!1})],checkFollowType:[y({name:"userIDList"},re)],addSignalingListener:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(s({api:t,paramName:n,desc:an()}),!1):(""===e.name&&s({api:t,paramName:n,desc:mn()}),!0)}}],removeSignalingListener:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(s({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(s({api:t,paramName:n,desc:an()}),!1):(""===e.name&&s({api:t,paramName:n,desc:mn()}),!0)}}],invite:{userID:ae},inviteSync:[y(y({},Q),{},{validator:function(e,t,n){return Ze(e)?!!pt(e.userID)||(s({api:t,paramName:"options.userID",desc:$t()}),!1):(s({api:t,paramName:"options",desc:_n()}),!1)}}),{name:"successCb",type:"Function",required:!1,validator:function(e,t,n){return k(e)&&s({api:t,paramName:n,desc:an()}),!0}},{name:"errorCb",type:"Function",required:!1,validator:function(e,t,n){return k(e)&&s({api:t,paramName:n,desc:an()}),!0}}],inviteInGroup:{groupID:ae,inviteeList:re},inviteInGroupSync:[y(y({},Q),{},{validator:function(e,t,n){return Ze(e)?pt(e.groupID)?!!Qe(e.inviteeList)||(s({api:t,paramName:"options.inviteeList",desc:sn()}),!1):(s({api:t,paramName:"options.groupID",desc:$t()}),!1):(s({api:t,paramName:"options",desc:_n()}),!1)}}),{name:"successCb",type:"Function",required:!1,validator:function(e,t,n){return k(e)&&s({api:t,paramName:n,desc:an()}),!0}},{name:"errorCb",type:"Function",required:!1,validator:function(e,t,n){return k(e)&&s({api:t,paramName:n,desc:an()}),!0}}],accept:{inviteID:ae},reject:{inviteID:ae},getSignalingInfo:[y(y({name:"message"},Q),{},{validator:function(e,t,n){return!We(e)||(s({api:t,paramName:n,desc:fn()}),!1)}})],modifyInvitation:{inviteID:ae,data:ae}},Un={login:1,logout:1,getLoginUser:1,on:1,once:1,off:1,setLogLevel:1,registerPlugin:1,destroy:1,isReady:1,createTextMessage:1,createTextAtMessage:1,createImageMessage:1,createAudioMessage:1,createVideoMessage:1,createCustomMessage:1,createFaceMessage:1,createFileMessage:1,createLocationMessage:1,createMergerMessage:1,downloadMergerMessage:1,createForwardMessage:1,sendMessage:1,resendMessage:1,revokeMessage:1,deleteMessage:1,translateText:1,convertVoiceToText:1,modifyMessage:1,searchCloudMessages:1,sendMessageReadReceipt:1,getGroupMessageReadMemberList:1,getMessageReadReceiptList:1,setMessageExtensions:1,getMessageExtensions:1,deleteMessageExtensions:1,addMessageReaction:1,removeMessageReaction:1,getMessageReactions:1,getAllUserListOfMessageReaction:1,getMessageList:1,findMessage:1,getMessageListHopping:1,setMessageRead:1,setAllMessageRead:1,getConversationList:1,getConversationProfile:1,deleteConversation:1,setConversationDraft:1,pinConversation:1,getTotalUnreadMessageCount:1,setConversationCustomData:1,markConversation:1,createConversationGroup:1,getConversationGroupList:1,deleteConversationGroup:1,renameConversationGroup:1,addConversationsToGroup:1,deleteConversationsFromGroup:1,clearHistoryMessage:1,setMessageRemindType:1,setAllReceiveMessageOpt:1,getAllReceiveMessageOpt:1,getGroupList:1,getGroupProfile:1,createGroup:1,joinGroup:1,updateGroupProfile:1,quitGroup:1,dismissGroup:1,changeGroupOwner:1,searchGroupByID:1,getGroupApplicationList:1,handleGroupApplication:1,initGroupAttributes:1,setGroupAttributes:1,deleteGroupAttributes:1,getGroupAttributes:1,setGroupCounters:1,increaseGroupCounter:1,decreaseGroupCounter:1,getGroupCounters:1,getJoinedCommunityList:1,createTopicInCommunity:1,deleteTopicFromCommunity:1,updateTopicProfile:1,getTopicList:1,getGroupMemberProfile:1,getGroupMemberList:1,addGroupMember:1,deleteGroupMember:1,setGroupMemberNameCard:1,setGroupMemberMuteTime:1,setGroupMemberRole:1,setGroupMemberCustomField:1,getGroupOnlineMemberCount:1,markGroupMemberList:1,getMyProfile:1,getUserProfile:1,updateMyProfile:1,setSelfStatus:1,getUserStatus:1,subscribeUserStatus:1,unsubscribeUserStatus:1,getBlacklist:1,addToBlacklist:1,removeFromBlacklist:1,getFriendList:1,addFriend:1,deleteFriend:1,checkFriend:1,updateFriend:1,getFriendProfile:1,getFriendApplicationList:1,refuseFriendApplication:1,deleteFriendApplication:1,acceptFriendApplication:1,setFriendApplicationRead:1,getFriendGroupList:1,createFriendGroup:1,renameFriendGroup:1,deleteFriendGroup:1,addToFriendGroup:1,removeFromFriendGroup:1,followUser:1,unfollowUser:1,getMyFollowingList:1,getMyFollowersList:1,getMutualFollowersList:1,getUserFollowInfo:1,checkFollowType:1,callExperimentalAPI:1,addSignalingListener:1,removeSignalingListener:1,invite:1,inviteSync:1,inviteInGroup:1,inviteInGroupSync:1,cancel:1,accept:1,reject:1,getSignalingInfo:1,modifyInvitation:1},bn=(t(Ro,n(Error)),Tn=f(Ro),e(Ro)),C={NO_SDKAPPID:2e3,NO_ACCOUNT_TYPE:2001,NO_IDENTIFIER:2002,NO_USERSIG:2003,NO_TINYID:2022,NO_A2KEY:2023,USER_NOT_LOGGED_IN:2024,REPEAT_LOGIN:2025,COS_UNDETECTED:2040,COS_GET_SIG_FAIL:2041,MSG_SEND_FAIL:2100,MSG_SEND_FAIL_NOT_IN_AVCHATROOM:2101,MSG_INSTANCE_REQUIRED:2105,MSG_INVALID_CONV_TYPE:2106,MSG_F_IS_EMPTY:2108,MSG_ONPROGRESS_FUNCTION_ERROR:2109,MSG_REVOKE_FAIL:2110,MSG_DELETE_FAIL:2111,MSG_UNREAD_ALL_FAIL:2112,READ_RECEIPT_MSG_LIST_EMPTY:2114,MSG_SEND_GRP_WITH_TOPIC_FAIL:2115,CANNOT_DELETE_GRP_SYSTEM_NOTICE:2116,TRANSLATE_TEXT_FAIL:2117,VOICE_TO_TEXT_FAIL:2118,UNSUPPORTED_VOICE_FORMAT:2119,MSG_I_SELECT_F_FIRST:2251,MSG_I_TYPES_LIMIT:2252,MSG_I_SIZE_LIMIT:2253,MSG_A_UPLOAD_FAIL:2300,MSG_A_SIZE_LIMIT:2301,MSG_V_UPLOAD_FAIL:2350,MSG_V_SIZE_LIMIT:2351,MSG_V_TYPES_LIMIT:2352,MSG_F_UPLOAD_FAIL:2400,MSG_F_SELECT_F_FIRST:2401,MSG_F_SIZE_LIMIT:2402,MSG_F_URL_IS_EMPTY:2403,MSG_MERGER_TYPE_INVALID:2450,MSG_MERGER_KEY_INVALID:2451,MSG_MERGER_DOWNLOAD_FAIL:2452,MSG_FORWARD_TYPE_INVALID:2453,MSG_FORWARD_INVALID_ELEMENTS:2454,MSG_MODIFY_CONFLICT:2480,MSG_MODIFY_DISABLED_IN_AVCHATROOM:2481,CONV_NOT_FOUND:2500,USER_OR_GRP_NOT_FOUND:2501,CONV_UN_RECORDED_TYPE:2502,INVALID_CONV_ID:2503,ILLEGAL_GRP_TYPE:2600,CANNOT_JOIN_WORK:2601,ILLEGAL_GRP_ID:2602,CANNOT_FIND_GRP:2603,CANNOT_CHANGE_OWNER_IN_AVCHATROOM:2620,CANNOT_CHANGE_OWNER_TO_SELF:2621,CANNOT_DISMISS_WORK:2622,MEMBER_NOT_IN_GRP:2623,JOIN_GRP_FAIL:2660,CANNOT_ADD_MEMBER_IN_AVCHATROOM:2661,CANNOT_JOIN_NON_AVCHATROOM_WITHOUT_LOGIN:2662,NOT_OWNER:2681,CANNOT_SET_MEMBER_ROLE_IN_WORK_AND_AVCHATROOM:2682,INVALID_MEMBER_ROLE:2683,CANNOT_SET_SELF_MEMBER_ROLE:2684,CANNOT_MUTE_SELF:2685,BAN_DURATION_INVALID:2686,OPERATION_NOT_SUPPORTED_IN_AVCHATROOM:2687,NOT_MY_FRIEND:2700,ALREADY_MY_FRIEND:2701,FRIEND_GRP_EXISTED:2710,FRIEND_GRP_NOT_EXIST:2711,FRIEND_APPLICATION_NOT_EXIST:2716,UPDATE_PROFILE_INVALID_PARAM:2721,UPDATE_PROFILE_NO_KEY:2722,CANNOT_ADD_SELF_TO_BLACKLIST:2742,NETWORK_ERROR:2800,NETWORK_TIMEOUT:2801,NO_NETWORK:2805,UNCAUGHT_ERROR:2903,INVALID_OPERATION:2905,INVALID_TRTC_CMD:2995,OVER_FREQUENCY_LIMIT:2996,CANNOT_FIND_PROTOCOL:2997,CANNOT_FIND_MODULE:2998,SDK_IS_NOT_READY:2999,LOGGING_IN:3e3,LOGIN_FAILED:3001,KICKED_OUT_MULT_DEVICE:3002,KICKED_OUT_MULT_ACCOUNT:3003,KICKED_OUT_USERSIG_EXPIRED:3004,LOGGED_OUT:3005,KICKED_OUT_REST_API:3006,ILLEGAL_TOPIC_ID:3021,CANNOT_USE_COMMERCIAL_ABILITY:3122,PROFANITY_FOUND:3123,OPTIONS_IS_EMPTY:3153,MSG_A2KEY_EXPIRED:20002,ACCOUNT_A2KEY_EXPIRED:70001,HELLO_ANSWER_KICKED_OUT:1002,OPEN_SERVICE_OVERLOAD_ERROR:60022,SIGNALING_INVALID_INVITE_ID:8010,SIGNALING_NO_PERMISSION:8011,SIGNALING_ALREADY_EXISTS:8012,INVALID_CANCEL_MESSAGE:8020,MSG_SEARCH_CURSOR_INVALID:27002,MSG_SEARCH_CURSOR_EXPIRED:27003},Fn=null,Nn=(e(ko,[{key:"isLoggedIn",value:function(){return this._m.get(12).isLoggedIn()}},{key:"isOversea",value:function(){return this._m.get(12).isOversea()}},{key:"isPrivateNetWork",value:function(){return this._m.get(12).isPrivateNetWork()}},{key:"getFileDownloadProxy",value:function(){return this._m.get(12).getFileDownloadProxy()}},{key:"getMyUserID",value:function(){return this._m.get(12).getUserID()}},{key:"getMyTinyID",value:function(){return this._m.get(12).getTinyID()}},{key:"getSDKAppID",value:function(){return this._m.get(12).getSDKAppID()}},{key:"isIntl",value:function(){return this._m.get(12).isIntl()}},{key:"isUsingChatCore",value:function(){return this._m.get(12).isUsingChatCore()}},{key:"isDevMode",value:function(){return this._m.get(12).isDevMode()}},{key:"get",value:function(e){return this._m.get(e)}},{key:"getPlatform",value:function(){return se}},{key:"getCloudConfig",value:function(e){return this._m.get(23).getCloudConfig(e)}},{key:"emitOuterEvent",value:function(e,t){this._m.getOuterEmitterInstance().emit(e,t)}},{key:"emitInnerEvent",value:function(e,t){this._m.getInnerEmitterInstance().emit(e,t)}},{key:"getInnerEmitterInstance",value:function(){return this._m.getInnerEmitterInstance()}},{key:"generateTjgID",value:function(e){return this._m.get(12).getTinyID()+"-"+e.random}},{key:"req",value:function(e){return this._m.get(20).req(e)}},{key:"canIUse",value:function(e){return this._m.get(27).canIUse(e)}},{key:"getErrorMessage",value:function(e,t,n){return this._m.getErrorMessage(e,t,n)}},{key:"outputWarning",value:function(e,t,n){e=this.getErrorMessage(e,t,n);e&&A.w(e)}},{key:"cannotUseCommercialAbility",value:function(e){var t=C.CANNOT_USE_COMMERCIAL_ABILITY;return m({code:t,message:this.getErrorMessage(t,e)})}}]),ko),v={LOGIN:"wslogin",LOGOUT:"wslogout",HELLO:"wshello",KICK_OTHER:"KickOther",SYNC_UNREAD_MSG:"getmsg",SEND_C2C_MSG:"sendmsg",SEND_GRP_MSG:"send_group_msg",GET_USER_PROFILE:"portrait_get_all",UPDATE_MY_PROFILE:"portrait_set",GET_BL:"black_list_get",ADD_TO_BL:"black_list_add",RM_FROM_BL:"black_list_delete",GET_FD_LIST:"friend_get",GET_FD_PROFILE:"friend_get_specified",CHECK_FD:"friend_check",DEL_FD:"friend_delete",ADD_FD:"friend_add",UPDATE_FD:"friend_update",RESPOND_FD_APPLICATION:"friend_response",GET_FD_APPLICATION_LIST:"pendency_get",DEL_FD_APPLICATION:"pendency_delete",REFUSE_FD_APPLICATION:"pendency_refuse",REPORT_FD_APPLICATION:"pendency_report",GET_FD_GRP_LIST:"group_get",CREATE_FD_GRP:"group_add",DEL_FD_GRP:"group_delete",UPDATE_FD_GRP:"group_update",REVOKE_C2C_MSG:"msgwithdraw",SET_C2C_MSG_READ:"msgreaded",SET_C2C_PEER_MUTE_NOTIFICATIONS:"set_c2c_peer_mute_notifications",GET_C2C_PEER_MUTE_NOTIFICATIONS:"get_c2c_peer_mute_notifications",GET_C2C_ROAMING_MSG:"getroammsg",GET_C2C_PEER_READ_TIME:"get_peer_read_time",DEL_C2C_MSG:"delete_c2c_msg_ramble",MODIFY_C2C_MSG:"modify_c2c_msg",MODIFY_C2C_MSG_EXT:"set_key_values",GET_C2C_MSG_EXT:"get_key_values",ADD_C2C_MSG_REACTION:"reaction_add",RM_C2C_MSG_REACTION:"reaction_del",GET_C2C_MSG_REACTIONS:"reaction_multi_stat",GET_C2C_MSG_REACTION_USER_LIST:"reaction_iterate",PAGING_GET_CONV_LIST:"page_get",DEL_CONV:"batch_delete",CLEAR_HISTORY_MSG:"clear_msg",PIN_CONV:"top",DEL_GROUP_AT_TIPS:"deletemsg",SET_CONV_CUSTOM_DATA:"set_conv_custom_data",MARK_CONV:"mark_contact",CREATE_CONV_GRP:"create_contact_group",DEL_CONV_GRP:"del_contact_group",RENAME_CONV_GRP:"update_contact_group",ADD_CONV_TO_GRP:"add_conv_to_group",DEL_CONV_FROM_GRP:"del_conv_from_group",GET_CONV_GRP_LIST:"get_contact_group",SEARCH_CONV_GRP_MARK:"search_contact_group",GET_GRP_LIST:"get_joined_group_list",GET_GRP_PROFILE:"get_group_self_member_info",CREATE_GRP:"create_group",DISMISS_GRP:"destroy_group",UPDATE_GRP_PROFILE:"modify_group_base_info",APPLY_JOIN_GRP:"apply_join_group",APPLY_JOIN_GRP_NOAUTH:"apply_join_group_noauth",QUIT_GRP:"quit_group",SEARCH_GRP:"get_group_public_info",CHANGE_GRP_OWNER:"change_group_owner",HANDLE_GRP_APPLICATION:"handle_apply_join_group",HANDLE_INVITE_JOIN_GRP:"handle_invite_join_permission_group",HANDLE_GRP_INVITATION:"handle_invite_join_group",REVOKE_GRP_MSG:"group_msg_recall",SET_GRP_MSG_READ:"msg_read_report",SET_ALL_MSG_READ:"read_all_unread_msg",GET_GRP_ROAMING_MSG:"group_msg_get",GET_READ_RECEIPT:"get_group_msg_receipt",SEND_READ_RECEIPT:"group_msg_receipt",SEND_C2C_READ_RECEIPT:"c2c_msg_read_receipt",GET_READ_RECEIPT_DETAIL:"get_group_msg_receipt_detail",GET_GRP_PENDENCY:"get_pendency",DEL_GRP_SYSTEM_NOTICE:"deletemsg",AV_POLLING:"get_msg",AV_NOAUTH_POLLING:"get_msg_noauth",GET_ONLINE_MBR_NUM:"get_online_member_num",DEL_GRP_MSG:"delete_group_ramble_msg_by_seq",MODIFY_GRP_MSG:"modify_group_msg",SET_GRP_ATTR:"set_group_attr",MODIFY_GRP_ATTR:"modify_group_attr",DEL_GRP_ATTR:"delete_group_attr",CLEAR_GRP_ATTR:"clear_group_attr",GET_GRP_ATTR:"get_group_attr",MODIFY_GRP_MSG_EXT:"group_set_key_values",GET_GRP_MSG_EXT:"group_get_key_values",GET_GRP_NOTIFY:"batch_get_group_notify",UPDATE_GRP_COUNTER:"update_group_counter",GET_GRP_COUNTER:"get_group_counter",ADD_GRP_MSG_REACTION:"group_reaction_add",RM_GRP_MSG_REACTION:"group_reaction_del",GET_GRP_MSG_REACTIONS:"group_reaction_multi_stat",GET_GRP_MSG_REACTION_USER_LIST:"group_reaction_iterate",GET_GRP_MBR_LIST:"get_group_member_info",GET_AV_MBR_LIST:"get_members",GET_GRP_MBR_PROFILE:"get_specified_group_member_info",ADD_GRP_MBR:"add_group_member",DEL_GRP_MBR:"delete_group_member",BAN_AV_MBR:"ban_group_member",MODIFY_GRP_MBR_INFO:"modify_group_member_info",MARK_AV_MBR_INFO:"modify_user_info",COS_SIGN:"cos",COS_PRE_SIG:"pre_sig",SIMPLE_COS_PRE_SIG:"simple_sig",GET_IMAGE_INFO:"get_imageinfo",GET_IP:"get_final_ip",VIDEO_COVER:"video_cover",SSO_STAT:"tim_web_report_v2",PING:"alive",MSG_PUSH:"msg_push",MSG_CLOUD_SEARCH:"query",MULTI_MSG_PUSH:"multi_msg_push_ws",MSG_PUSH_ACK:"ws_msg_push_ack",STATUS_FORCE_OFFLINE:"stat_forceoffline",UPLOAD_MERGER_MSG:"save_relay_json_msg",DOWNLOAD_MERGER_MSG:"get_relay_json_msg",FETCH_CLOUD_CTRL_CONFIG:"fetch_config",PUSHED_CLOUD_CTRL_CONFIG:"push_configv2",FETCH_COMMERCIAL_CONFIG:"fetch_imsdk_purchase_bitsv2",PUSHED_COMMERCIAL_CONFIG:"push_imsdk_purchase_bitsv2",OVERLOAD_NOTIFY:"notify2",CREATE_TOPIC:"create_topic",DEL_TOPIC:"destroy_topic",UPDATE_TOPIC_PROFILE:"modify_topic",GET_TOPIC_LIST:"get_topic",SET_SELF_STATUS:"ws_set_custom_status",GET_USER_STATUS:"ws_get_user_status",SUB_USER_STATUS:"ws_status_subscribe",UNSUB_USER_STATUS:"ws_status_unsubscribe",STAT_BACKGROUND:"ws_stat_background",STAT_FOREGROUND:"ws_stat_foreground",SET_TOKEN:"ws_stat_settoken",PUSH_REPORT:"uniapp_sdk_report",GET_PROFANITY_LIST:"get_local_words",TRANSLATE_TEXT:"ws_batch_trans_text",VOICE_TO_TEXT:"ws_sentence_recognition",FOLLOW:"follow_add",UNFOLLOW:"follow_delete",GET_FOLLOW:"follow_get",GET_FOLLOW_INFO:"follow_get_info",CHECK_FOLLOW_TYPE:"follow_check",SET_ALL_RECEIVE_MSG_OPT:"ws_set_do_not_disturb",GET_ALL_RECEIVE_MSG_OPT:"ws_get_do_not_disturb"},wn="networkRTT",qn="messageE2EDelay",xn="sendMessageC2C",Vn="sendMessageGroup",Hn="sendMessageGroupAV",Bn="sendMessageRichMedia",Kn="cosUpload",Wn="messageReceivedGroup",Yn="messageReceivedGroupAVPush",jn="messageReceivedGroupAVPull",Jn=(c(On={},wn,2),c(On,qn,3),c(On,xn,4),c(On,Vn,5),c(On,Hn,6),c(On,Bn,7),c(On,Wn,8),c(On,Yn,9),c(On,jn,10),c(On,Kn,11),On),zn={info:4,warning:5,error:6},Xn={wifi:1,"2g":2,"3g":3,"4g":4,"5g":5,unknown:6,none:7,online:8},Zn={login:4,plugin_search:16,plugin_translate:16,plugin_voice_to_text:16,plugin_cs:16,plugin_push:16,plugin_bot:16,plugin_emoji_reaction:16},M=(e(Ao,[{key:"updateTimeStamp",value:function(){this.timestamp=Oe()}},{key:"start",value:function(e){return this._startts=e,this}},{key:"end",value:function(){var e,t=this,n=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this._sentFlag||(this._netMonitorModule&&(e=this._netMonitorModule.getNetworkType(),this.setNetworkType(e)),e=Oe(),0===this.costTime&&(this.costTime=e-this._startts),this.setMoreMessage("startts:".concat(this._startts," endts:").concat(e)),n?(this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)):setTimeout(function(){t._sentFlag=!0,t._eventStatModule&&t._eventStatModule.pushIn(t)},0))}},{key:"setError",value:function(e){if(!(e instanceof Error))return A.w("".concat(this._n,".setError value not instanceof Error, please check!")),this;if(this._sentFlag)return this;var t=!0;return(t=this._netMonitorModule?this._netMonitorModule.isOnline():t)?(e.code&&this.setCode(e.code),e.message&&this.setMoreMessage(e.message)):this.setCode(C.NO_NETWORK),this.setLevel("error"),this}},{key:"setCode",value:function(e){return k(e)||this._sentFlag||("ECONNABORTED"===e&&(this.code=103),ze(e)?this.code=e:A.w("".concat(this._n,".setCode value not a number, please check!"),e,r(e))),this}},{key:"setMessage",value:function(e){return k(e)||this._sentFlag||(ze(e)&&(this.message=e.toString()),pt(e)&&(this.message=e)),this}},{key:"setCostTime",value:function(e){return this.costTime=e,this}},{key:"setLevel",value:function(e){return k(e)||this._sentFlag||(this.level=zn[e]),this}},{key:"setMoreMessage",value:function(e){return We(this.moreMessage)?this.moreMessage="".concat(e):this.moreMessage+=" ".concat(e),this}},{key:"setNetworkType",value:function(e){return k(e)?A.w("".concat(this._n,".setNetworkType value is undefined, please check!")):(e=Xn[e.toLowerCase()],k(e)||(this.networkType=e)),this}},{key:"getStartTs",value:function(){return this._startts}},{key:"setUIPlatform",value:function(e){return this.uiPlatform=e,this}},{key:"setExtension",value:function(e){return this.extension=e,this}},{key:"setEventType",value:function(e){return this.eventType=e,this}}],[{key:"bindEventStatModule",value:function(e){Ao.prototype._eventStatModule=e}},{key:"bindNetMonitorModule",value:function(e){Ao.prototype._netMonitorModule=e}}]),Ao),Qn=(e(So,[{key:"setText",value:function(e){this.content.text=e}},{key:"sendable",value:function(){return 0!==this.content.text.length}}]),So),$n=(e(Lo,[{key:"_initImageInfoModel",value:function(){var t=this;this._ImageInfoModel=function(e){this.instanceID=st(9999999),this.sizeType=e.type||0,this.type=0,this.size=e.size||0,this.width=e.width||0,this.height=e.height||0,this.imageUrl=e.imageUrl||e.url||"",this.url=Yt(e.url||t._imageMemoryURL,t._fileDownloadProxy)},this._ImageInfoModel.prototype={setSizeType:function(e){this.sizeType=e},setType:function(e){this.type=e},setImageUrl:function(e){e&&(this.imageUrl=e)},getImageUrl:function(){return this.imageUrl}}}},{key:"initImageInfoArray",value:function(e){for(var t,n=0,o=null;n<=2;)t=k(e)||k(e[n])?{type:0,size:0,width:0,height:0,url:""}:e[n],(o=new this._ImageInfoModel(t)).setSizeType(n+1),o.setType(n),this.addImageInfo(o),n++;this.updateAccessSideImageInfoArray()}},{key:"updateImageInfoArray",value:function(e){for(var t,n=this.content.imageInfoArray.length,o=0;o<n;o++)t=this.content.imageInfoArray[o],e[o].size&&(t.size=e[o].size),e[o].url&&t.setImageUrl(e[o].url),e[o].width&&(t.width=e[o].width),e[o].height&&(t.height=e[o].height)}},{key:"_autoFixUrl",value:function(){for(var e=this.content.imageInfoArray.length,t="",n="",o=["http","https"],i=null,a=0;a<e;a++)this.content.imageInfoArray[a].url&&""!==(i=this.content.imageInfoArray[a]).imageUrl&&(n=i.imageUrl.slice(0,i.imageUrl.indexOf("://")+1),t=i.imageUrl.slice(i.imageUrl.indexOf("://")+1),o.indexOf(n)<0&&(n="https:"),this.content.imageInfoArray[a].setImageUrl([n,t].join("")))}},{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1)}},{key:"updateImageFormat",value:function(e){this.content.imageFormat=Ue[e.toUpperCase()]||Ue.UNKNOWN}},{key:"createImageDataASURLInWeb",value:function(e){void 0!==e&&0<e.files.length&&(this._imageMemoryURL=window.URL.createObjectURL(e.files[0]))}},{key:"createImageDataASURLInWXMiniApp",value:function(e){e&&e.url&&(this._imageMemoryURL=e.url)}},{key:"replaceImageInfo",value:function(e,t){this.content.imageInfoArray[t]instanceof this._ImageInfoModel||(this.content.imageInfoArray[t]=e)}},{key:"addImageInfo",value:function(e){3<=this.content.imageInfoArray.length||this.content.imageInfoArray.push(e)}},{key:"updateAccessSideImageInfoArray",value:function(){var e=this.content.imageInfoArray,t=e[0],n=t.width,n=void 0===n?0:n,t=t.height,t=void 0===t?0:t;0!==n&&0!==t&&(Ut(e),Object.assign(e[2],Pt({originWidth:n,originHeight:t,min:720})))}},{key:"sendable",value:function(){return 0!==this.content.imageInfoArray.length&&""!==this.content.imageInfoArray[0].imageUrl&&0!==this.content.imageInfoArray[0].size}}]),Lo),eo=(e(Eo,[{key:"sendable",value:function(){return null!==this.content}}]),Eo),to=(e(Do,[{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1)}},{key:"updateAudioUrl",value:function(e){this.content.remoteAudioUrl=e}},{key:"sendable",value:function(){return""!==this.content.remoteAudioUrl}}]),Do),no={from:!0,groupID:!0,groupName:!0,to:!0},oo=(e(To,[{key:"_initContent",value:function(t){var n=this;Object.keys(t).forEach(function(e){switch(e){case"remarkInfo":break;case"groupProfile":n.content.groupProfile={},n._initGroupProfile(t[e]);break;case"operatorInfo":break;case"memberInfoList":case"msgMemberInfo":n._updateMemberList(t[e]);break;case"memberExtraInfo":case"onlineMemberInfo":break;case"memberNum":n.content[e]=t[e],n.content.memberCount=t[e];break;case"newGroupProfile":n.content.newGroupProfile={},n._initNewGroupProfile(t[e]);break;default:n.content[e]=t[e]}}),this.content.userIDList||(this.content.userIDList=[this.content.operatorID])}},{key:"_initGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];no[o]&&(this.content.groupProfile[o]=e[o])}}},{key:"_updateMemberList",value:function(e){We(this.content.memberList)?this.content.memberList=e:this.content.memberList.forEach(function(t){e.forEach(function(e){t.userID===e.userID&&Object.assign(t,e)})})}},{key:"_initNewGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];this.content.newGroupProfile[o]="muteAllMembers"!==o?e[o]:1===e[o]}}}]),To),io={from:!0,groupID:!0,groupName:!0,to:!0,groupType:!0},ao=(e(Co,[{key:"_initContent",value:function(t){var n=this;Object.keys(t).forEach(function(e){switch(e){case"memberInfoList":break;case"remarkInfo":n.content.handleMessage=t[e];break;case"groupProfile":n.content.groupProfile={},n._initGroupProfile(t[e]);break;default:n.content[e]=t[e]}})}},{key:"_initGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];io[o]&&("groupName"===o?this.content.groupProfile.name=e[o]:this.content.groupProfile[o]=e[o])}}}]),Co),so=(e(yo,[{key:"_getFileInfo",value:function(e){if(!k(e.fileName)&&!k(e.fileSize))return{size:e.fileSize,name:e.fileName};var t,e=e.file.files[0];return $&&(e.path&&-1!==e.path.indexOf(".")&&(t=e.path.slice(e.path.lastIndexOf(".")+1).toLowerCase(),e.type=t,e.name||(e.name="".concat(st(999999),".").concat(t))),e.name||(e.type="",e.name=e.path.slice(e.path.lastIndexOf("/")+1).toLowerCase()),e.suffix&&(e.type=e.suffix),e.url||(e.url=e.path)),{size:e.size,name:e.name}}},{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1)}},{key:"updateFileUrl",value:function(e){this.content.fileUrl=e}},{key:"sendable",value:function(){return""!==this.content.fileUrl&&""!==this.content.fileName&&0!==this.content.fileSize}}]),yo),ro=(e(Io,[{key:"setData",value:function(e){return this.content.data=e,this}},{key:"setDescription",value:function(e){return this.content.description=e,this}},{key:"setExtension",value:function(e){return this.content.extension=e,this}},{key:"sendable",value:function(){return 0!==this.content.data.length||0!==this.content.description.length||0!==this.content.extension.length}}]),Io),co=(e(Mo,[{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1)}},{key:"updateVideoUrl",value:function(e){e&&(this.content.remoteVideoUrl=e)}},{key:"updateSnapshotInfo",value:function(e){var t=e.snapshotUrl,n=e.snapshotWidth,e=e.snapshotHeight;We(t)||(this.content.thumbUrl=this.content.snapshotUrl=t),We(n)||(this.content.thumbWidth=this.content.snapshotWidth=Number(n)),We(e)||(this.content.thumbHeight=this.content.snapshotHeight=Number(e))}},{key:"sendable",value:function(){return""!==this.content.remoteVideoUrl}}]),Mo),uo=(e(vo,[{key:"sendable",value:function(){return!0}}]),vo),lo=(e(mo,[{key:"_patchRichMediaPayload",value:function(e,t){e===S.MSG_IMAGE?t.imageInfoArray.forEach(function(e){!e.imageUrl&&e.url&&(e.imageUrl=e.url,e.sizeType=e.type,1===e.type?e.type=0:3===e.type&&(e.type=1))}):e===S.MSG_VIDEO?!t.remoteVideoUrl&&t.videoUrl&&(t.remoteVideoUrl=t.videoUrl):e===S.MSG_AUDIO?!t.remoteAudioUrl&&t.url&&(t.remoteAudioUrl=t.url):e===S.MSG_FILE&&!t.fileUrl&&t.url&&(t.fileUrl=t.url,t.url=void 0)}},{key:"_updateRichMediaDownloadUrl",value:function(e,t,n){n&&(e===S.MSG_IMAGE?t.imageInfoArray.forEach(function(e){e.url=Yt(e.url,n)}):e===S.MSG_VIDEO?(t.videoUrl=Yt(t.videoUrl,n),t.snapshotUrl=Yt(t.thumbUrl,n),t.snapshotHeight=t.thumbHeight,t.snapshotWidth=t.thumbWidth):e===S.MSG_AUDIO?t.url=Yt(t.url,n):e===S.MSG_FILE&&(t.fileUrl=Yt(t.fileUrl,n)))}}]),mo),po=(e(fo,[{key:"sendable",value:function(){return!We(this.content.messageList)||!We(this.content.downloadKey)}}]),fo),_o={1:S.MSG_PRIORITY_HIGH,2:S.MSG_PRIORITY_NORMAL,3:S.MSG_PRIORITY_LOW,4:S.MSG_PRIORITY_LOWEST},go=(e(ho,[{key:"elements",get:function(){return this._elements}},{key:"getElements",value:function(){return this._elements}},{key:"extractGroupInfo",value:function(e){null!==e&&(pt(e.nick)&&(this.nick=e.nick),pt(e.avatar)&&(this.avatar=e.avatar),e=e.messageFromAccountExtraInformation,Ze(e)&&pt(e.nameCard)&&(this.nameCard=e.nameCard))}},{key:"handleGroupAtInfo",value:function(e){var t=this;e.payload&&e.payload.atUserList&&e.payload.atUserList.forEach(function(e){e!==S.MSG_AT_ALL?(t._groupAtInfoList.push({groupAtAllFlag:0,groupAtUserID:e}),t.atUserList.push(e)):(t._groupAtInfoList.push({groupAtAllFlag:1}),t.atUserList.push(S.MSG_AT_ALL))}),Qe(e.groupAtInfo)&&e.groupAtInfo.forEach(function(e){0===e.groupAtAllFlag?t.atUserList.push(e.groupAtUserID):1===e.groupAtAllFlag&&t.atUserList.push(S.MSG_AT_ALL)})}},{key:"getGroupAtInfoList",value:function(){return this._groupAtInfoList}},{key:"_initProxy",value:function(){this._elements[0]&&(this.payload=this._elements[0].content,this.type=this._elements[0].type)}},{key:"reInitialize",value:function(e){e&&(this.status=this.from?En:Dn,this.from||(this.from=e)),this._initFlow(e),this._initSequence(e),this._concatConversationID(e),this.generateMessageID()}},{key:"isSendable",value:function(){return 0!==this._elements.length&&(!0===this._relayFlag||"function"==typeof this._elements[0].sendable&&this._elements[0].sendable())}},{key:"_initTo",value:function(e){this.conversationType===S.CONV_GROUP&&(this.to=e.groupID)}},{key:"_initSequence",value:function(e){var t,n,o;0===this.clientSequence&&e&&(this.clientSequence=!!(e=e)&&(void 0===Mt[e]&&(o=new Date,t="3".concat(o.getHours()).slice(-2),n="0".concat(o.getMinutes()).slice(-2),o="0".concat(o.getSeconds()).slice(-2),Mt[e]=parseInt([t,n,o,"0001"].join("")),o=n=t=null,A.l("autoIncrementIndex start index:".concat(Mt[e]))),Mt[e]++)),0===this.sequence&&this.conversationType===S.CONV_C2C&&(this.sequence=this.clientSequence)}},{key:"generateMessageID",value:function(){this.from===S.CONV_SYSTEM&&(this.senderTinyID="144115198244471703"),this.ID="".concat(this.senderTinyID,"-").concat(this.clientTime,"-").concat(this.random)}},{key:"_initFlow",value:function(e){""!==e&&(e===this.from?(this.flow="out",this.isRead=!0):this.flow="in")}},{key:"_concatConversationID",value:function(e){var t=this.to,n=this.conversationType;n!==S.CONV_SYSTEM?(e=n===S.CONV_C2C?e===this.from?t:this.from:this.to,this.conversationID=e?"".concat(n).concat(e):null):this.conversationID=S.CONV_SYSTEM}},{key:"isElement",value:function(e){return e instanceof Qn||e instanceof $n||e instanceof eo||e instanceof to||e instanceof so||e instanceof co||e instanceof oo||e instanceof ao||e instanceof ro||e instanceof uo||e instanceof po}},{key:"setElement",value:function(e,t){var n=this;if(this.isElement(e))return this._elements=[e],void this._initProxy();function o(e){if(e.type&&e.content)switch(e.type){case S.MSG_TEXT:n.setTextElement(e.content);break;case S.MSG_IMAGE:n.setImageElement(e.content,t);break;case S.MSG_AUDIO:n.setAudioElement(e.content,t);break;case S.MSG_FILE:n.setFileElement(e.content,t);break;case S.MSG_VIDEO:n.setVideoElement(e.content,t);break;case S.MSG_CUSTOM:n.setCustomElement(e.content);break;case S.MSG_LOCATION:n.setLocationElement(e.content);break;case S.MSG_GRP_TIP:n.setGroupTipElement(e.content);break;case S.MSG_GRP_SYS_NOTICE:n.setGroupSystemNoticeElement(e.content);break;case S.MSG_FACE:n.setFaceElement(e.content);break;case S.MSG_MERGER:n.setMergerElement(e.content,t)}}if(Qe(e))for(var i=0;i<e.length;i++)o(e[i]);else o(e);this._initProxy()}},{key:"clearElement",value:function(){this._elements.length=0}},{key:"setTextElement",value:function(e){e="string"==typeof e?e:e.text,e=new Qn({text:e});this._elements.push(e)}},{key:"setImageElement",value:function(e,t){e=new $n(e,t);this._elements.push(e)}},{key:"setAudioElement",value:function(e,t){e=new to(e,t);this._elements.push(e)}},{key:"setFileElement",value:function(e,t){e=new so(e,t);this._elements.push(e)}},{key:"setVideoElement",value:function(e,t){e=new co(e,t);this._elements.push(e)}},{key:"setLocationElement",value:function(e){e=new uo(e);this._elements.push(e)}},{key:"setCustomElement",value:function(e){e=new ro(e);this._elements.push(e)}},{key:"setGroupTipElement",value:function(e){var t,n={},o=e.operationType;We(e.memberInfoList)?e.operatorInfo&&(n=e.operatorInfo):o!==S.GRP_TIP_MBR_JOIN&&o!==S.GRP_TIP_MBR_KICKED_OUT&&o!==S.GRP_TIP_MBR_SET_ADMIN&&o!==S.GRP_TIP_MBR_CANCELED_ADMIN||(n=e.memberInfoList[0]),We(e.memberExtraInfo)||(t=e.memberExtraInfo.reason,e.msgMemberInfo.forEach(function(e){e.reason=t}));o=n.nick,n=n.avatar,pt(o)&&(this.nick=o),pt(n)&&(this.avatar=n),o=new oo(e);this._elements.push(o)}},{key:"setGroupSystemNoticeElement",value:function(e){e=new ao(e);this._elements.push(e)}},{key:"setFaceElement",value:function(e){e=new eo(e);this._elements.push(e)}},{key:"setMergerElement",value:function(e,t){e=new po(e,t);this._elements.push(e)}},{key:"setIsRead",value:function(e){this.isRead=e}},{key:"setRelayFlag",value:function(e){this._relayFlag=e}},{key:"_computePriority",value:function(e){if(k(e))return S.MSG_PRIORITY_NORMAL;if(pt(e)&&-1!==Object.values(_o).indexOf(e))return e;if(ze(e)){e=""+e;if(-1!==Object.keys(_o).indexOf(e))return _o[e]}return S.MSG_PRIORITY_NORMAL}},{key:"setNickAndAvatar",value:function(e){var t=e.nick,e=e.avatar;pt(t)&&(this.nick=t),pt(e)&&(this.avatar=e)}},{key:"setNameCard",value:function(e){pt(e)&&(this.nameCard=e)}},{key:"initC2CReadReceiptInfo",value:function(e){this.conversationType===S.CONV_C2C&&!0===this.needReadReceipt&&(this.readReceiptInfo.isPeerRead=1===e)}}]),ho);function ho(e){u(this,ho),this.ID="",this.conversationID=e.conversationID||null,this.conversationType=e.conversationType||S.CONV_C2C,this.conversationSubType=e.conversationSubType,this.time=e.time||Math.ceil(Date.now()/1e3),this.sequence=e.sequence||0,this.clientSequence=e.clientSequence||e.sequence||0,this.random=e.random||0===e.random?e.random:st(),this.priority=this._computePriority(e.priority),this.nick=e.nick||"",this.avatar=e.avatar||"",this.isPeerRead=!1,this.nameCard="",this.hasRiskContent=Xt(e.checkResult),this._elements=[],this.isPlaceMessage=e.isPlaceMessage||0,this.isRevoked=2===e.isPlaceMessage||8===e.msgFlagBits,this.from=e.from||null,this.to=e.to||null,this.flow="",this.isSystemMessage=e.isSystemMessage||!1,this.protocol=e.protocol||"JSON",this.isResend=!1,this.isRead=!1,this.status=e.status||En,this._onlineOnlyFlag=!1,this._groupAtInfoList=[],this._relayFlag=!1,this.atUserList=[],this.cloudCustomData=e.cloudCustomData||"",this.isDeleted=!1,this.isModified=!1,this._isExcludedFromUnreadCount=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromUnreadCount),this._isExcludedFromLastMessage=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromLastMessage),this.clientTime=e.clientTime||Ae()||0,this.senderTinyID=e.senderTinyID||e.tinyID||"",this.readReceiptInfo=e.readReceiptInfo||{readCount:void 0,unreadCount:void 0,isPeerRead:void 0},this.needReadReceipt=!0===e.needReadReceipt||1===e.needReadReceipt,this.version=e.messageVersion||0,this.isBroadcastMessage=e.isBroadcastMessage||!1,this._receiverList=e.receiverList||void 0,this.isSupportExtension=!0===e.isSupportExtension||1===e.isSupportExtension,this._cmConfigID=e.customModerationConfigurationID,this.revoker=e.revokerInfo&&e.revokerInfo.revoker||"",this.revokerInfo=e.revokerInfo||{userID:"",nick:"",avatar:""},this.revokeReason=e.revokeReason||"",this.reInitialize(e.currentUser),this.extractGroupInfo(e.groupProfile||null),this.handleGroupAtInfo(e),this.initC2CReadReceiptInfo(e.readReceiptSentByPeer)}function fo(e,t){var n,o,i,a,s,r,c;u(this,fo),this.type=S.MSG_MERGER,this.content={downloadKey:"",pbDownloadKey:"",messageList:[],title:"",abstractList:[],compatibleText:"",version:0,layersOverLimit:!1},e.downloadKey?(o=e.downloadKey,i=e.pbDownloadKey,a=e.title,s=e.abstractList,r=e.compatibleText,n=e.version,this.content.downloadKey=o,this.content.pbDownloadKey=i,this.content.title=a,this.content.abstractList=s,this.content.compatibleText=r,this.content.version=n||0):We(e.messageList)?1===e.layersOverLimit&&(this.content.layersOverLimit=!0):(o=e.messageList,i=e.title,a=e.abstractList,s=e.compatibleText,r=e.version,c=[],o.forEach(function(e){We(e)||(e=new lo(e,t),c.push(e))}),this.content.messageList=c,this.content.title=i,this.content.abstractList=a,this.content.compatibleText=s,this.content.version=r||0)}function mo(e,t){var n,o;u(this,mo),this.from=e.from,this.messageSender=e.from,this.time=e.time,this.messageSequence=e.sequence,this.clientSequence=e.clientSequence||e.sequence,this.messageRandom=e.random,this.cloudCustomData=e.cloudCustomData||"",this.clientTime=e.clientTime||void 0,e.ID?(this.ID=e.ID||"",this.nick=e.nick||"",this.avatar=e.avatar||"",e.messageBody?this.messageBody=JSON.parse(JSON.stringify(e.messageBody)):this.messageBody=[{type:e.type,payload:e.payload}],e.conversationType?e.conversationType.startsWith(S.CONV_C2C)?this.receiverUserID=e.to:e.conversationType.startsWith(S.CONV_GROUP)&&(this.receiverGroupID=e.to):e.receiverGroupID?this.receiverGroupID=e.receiverGroupID:e.receiverUserID&&(this.receiverUserID=e.receiverUserID),this.messageReceiver=e.to||e.messageReceiver):(this.nick=e.nick||"",this.avatar=e.avatar||"",this.messageBody=[],n=e.elements[0].type,o=e.elements[0].content,this._patchRichMediaPayload(n,o),this._updateRichMediaDownloadUrl(n,o,t),n===S.MSG_MERGER?this.messageBody.push({type:n,payload:new po(o).content}):this.messageBody.push({type:n,payload:o}),e.groupID&&(this.receiverGroupID=e.groupID,this.messageReceiver=e.groupID),e.to&&(this.receiverUserID=e.to,this.messageReceiver=e.to),this.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random))}function vo(e){u(this,vo),this.type=S.MSG_LOCATION;var t=e.description,n=e.longitude,e=e.latitude;this.content={description:t,longitude:n,latitude:e}}function Mo(e,t){u(this,Mo),this.type=S.MSG_VIDEO,this._percent=0,this.content={remoteVideoUrl:e.remoteVideoUrl||e.videoUrl||"",videoFormat:e.videoFormat,videoSecond:parseInt(e.videoSecond,10),videoSize:e.videoSize,videoUrl:Yt(e.videoUrl,t),videoDownloadFlag:2,videoUUID:e.videoUUID,thumbUUID:e.thumbUUID,thumbFormat:e.thumbFormat,thumbWidth:e.thumbWidth,snapshotWidth:e.thumbWidth,thumbHeight:e.thumbHeight,snapshotHeight:e.thumbHeight,thumbSize:e.thumbSize,snapshotSize:e.thumbSize,thumbDownloadFlag:2,thumbUrl:Yt(e.thumbUrl,t),snapshotUrl:Yt(e.thumbUrl,t)}}function Io(e){u(this,Io),this.type=S.MSG_CUSTOM,this.content={data:e.data||"",description:e.description||"",extension:e.extension||""}}function yo(e,t){u(this,yo),this.type=S.MSG_FILE,this._percent=0;var n=this._getFileInfo(e);this.content={downloadFlag:2,fileUrl:Yt(e.url||e.fileUrl,t)||"",uuid:e.uuid,fileName:n.name||"",fileSize:n.size||0}}function Co(e){u(this,Co),this.type=S.MSG_GRP_SYS_NOTICE,this.content={},this._initContent(e)}function To(e){u(this,To),this.type=S.MSG_GRP_TIP,this.content={},this._initContent(e)}function Do(e,t){u(this,Do),this.type=S.MSG_AUDIO,this._percent=0,this.content={downloadFlag:2,second:e.second,size:e.size,url:Yt(e.url,t),remoteAudioUrl:e.url||"",uuid:e.uuid}}function Eo(e){u(this,Eo),this.type=S.MSG_FACE,this.content=e||null}function Lo(e,t){u(this,Lo),this._imageMemoryURL="",this._fileDownloadProxy=t,te?this.createImageDataASURLInWXMiniApp(e.file):this.createImageDataASURLInWeb(e.file),this._initImageInfoModel(),this.type=S.MSG_IMAGE,this._percent=0,this.content={imageFormat:e.imageFormat||Ue.UNKNOWN,uuid:e.uuid,imageInfoArray:[]},this.initImageInfoArray(e.imageInfoArray),this._autoFixUrl()}function So(e){u(this,So),this.type=S.MSG_TEXT,this.content={text:e.text||""}}function Ao(e){u(this,Ao),this._n="SSOLogData",this.eventType=Zn[e]||0,this.timestamp=0,this.networkType=8,this.code=0,this.message="",this.moreMessage="",this.extension=e,this.costTime=0,this.duplicate=!1,this.level=4,this.uiPlatform=void 0,this._sentFlag=!1,this._startts=Oe()}function ko(e){u(this,ko),this._m=e,this._n=""}function Ro(e){u(this,Ro),t=Tn.call(this);var t,n=e.code,o=e.message,e=e.data;return t.code=n,o?t.message=o:t._getErrorMessage&&(t.message=t._getErrorMessage(t.code)),t.data=e||{},t}function Oo(e){if(Ze(e))return{pushFlag:!0===e.disablePush?1:0,title:e.title||"",desc:e.description||"",ext:e.extension||"",apnsInfo:(n=void 0===(n=(t=e).apnsInfo)?{}:n,o=t.ignoreIOSBadge,t=t.disableVoipPush,o=!0===n.ignoreIOSBadge||!0===(void 0!==o&&o)?1:0,i=void 0,k(t)||(i=!1===t?1:0),k(n.disableVoipPush)||(i=!1===n.disableVoipPush?1:0),y(y({},n),{},{badgeMode:o,isVoipPush:i})),androidInfo:(n=void 0===(n=(t=e).androidInfo)?{}:n,t=t.androidOPPOChannelID,t=n.OPPOChannelID||(void 0===t?"":t),y(y({},n),{},{Sound:-1===(i=(o=n.sound||"").lastIndexOf("."))?o:o.slice(0,i),OPPOChannelID:t,GoogleChannelID:n.FCMChannelID||""}))};var t,n,o,i}t(Fo,Nn),No=f(Fo),e(Fo,[{key:"onNewC2CMessage",value:function(e){var t=e.dataList,n=e.isInstantMessage,o=e.C2CRemainingUnreadList,i=e.C2CPairUnreadList,e=e.isSyncingEnded,t=(A.d("".concat(this._n,".onNewC2CMessage count:").concat(t.length," isInstantMessage:").concat(n)),this._newC2CMessageStoredAndSummary({dataList:t,C2CRemainingUnreadList:o,C2CPairUnreadList:i,isInstantMessage:n})),o=t.conversationOptionsList,i=t.messageList,t=t.isUnreadC2CMessage,a=yt(i),a=(0<a.length&&this.emitOuterEvent(G.MESSAGE_MODIFIED,a),this.get(11).onNewMessage({conversationOptionsList:o,isInstantMessage:n,isUnreadC2CMessage:t,isSyncingEnded:e}),Ct(i));n&&0<a.length&&this.emitOuterEvent(G.MESSAGE_RECEIVED,a),i.length=0}},{key:"_newC2CMessageStoredAndSummary",value:function(l){for(var e=l.dataList,d=l.C2CRemainingUnreadList,n=l.C2CPairUnreadList,p=l.isInstantMessage,t=null,o=[],_=[],g={},h=this.get(26),f=!1,i=this.get(11),m=this.get(4),v=this.getFileDownloadProxy(),a=0,M=e.length;a<M;a++)if(this._isC2CNotice(e[a]))this._noticeFromUnreadDBList.push(e[a].eventArray[0].c2CNotifyMsgArray[0]);else{var s=e[a],r=(s.currentUser=this.getMyUserID(),s.conversationType=S.CONV_C2C,s.isSystemMessage=!!s.isSystemMessage,(k(s.nick)||k(s.avatar))&&(f=!0,A.d("".concat(this._n,"._newC2CMessageStoredAndSummary nick or avatar missing!"))),(t=new go(s)).setElement(s.elements,v),t.setNickAndAvatar({nick:s.nick,avatar:s.avatar}),t.conversationID);if(p){if(this._messageFromUnreadDBMap.get(t.ID))continue;var c,u,I=!1,y=(t.from!==this.getMyUserID()?(u=i.getLatestMessageSentByPeer(r))&&(c=u.nick,u=u.avatar,f?t.setNickAndAvatar({nick:c,avatar:u}):c===t.nick&&u===t.avatar||(I=!0)):(c=i.getLatestMessageSentByMe(r))&&(u=c.nick,y=c.avatar,u===t.nick&&y===t.avatar||(i.modifyMessageSentByMe({conversationID:r,latestNick:t.nick,latestAvatar:t.avatar}),m.mockOnNickAvatarModified(t.nick,t.avatar))),1===e[a].isModified);if(i.isMessageSentByCurrentInstance(t)?t.isModified=y:y=!1,0===s.msgLifeTime)t._onlineOnlyFlag=!0,i.isMessageSentByCurrentInstance(t)||_.push(t);else{if(!i.pushIntoMessageList(_,t,y))continue;I&&(i.modifyMessageSentByPeer({conversationID:r,latestNick:t.nick,latestAvatar:t.avatar}),i.updateUserProfileSpecifiedKey({conversationID:r,nick:t.nick,avatar:t.avatar}))}p&&0<t.clientTime&&h.addMessageDelay(t.clientTime)}else this._messageFromUnreadDBMap.set(t.ID,t);if(0!==s.msgLifeTime){if(!1===t._onlineOnlyFlag){I=i.getLastMessageTime(r);if(ze(I)&&t.time<I)continue;k(g[r])?(s=0,"in"===t.flow&&(t._isExcludedFromUnreadCount||(s=1)),g[r]=o.push({conversationID:r,unreadCount:s,type:t.conversationType,subType:t.conversationSubType,lastMessage:t._isExcludedFromLastMessage?"":t})-1):(s=g[r],o[s].type=t.conversationType,o[s].subType=t.conversationSubType,o[s].lastMessage=t._isExcludedFromLastMessage?"":t,"in"===t.flow&&(t._isExcludedFromUnreadCount||o[s].unreadCount++))}}else t._onlineOnlyFlag=!0}this._handleRevokedNoticeFromUnreadDB();var C=!1;if(Qe(n))for(var T=0,D=n.length;T<D;T++)!function(t){var e;0<n[t].unreadCount&&(C=!0,(e=o.find(function(e){return e.conversationID==="C2C".concat(n[t].from)}))?e.unreadCount=n[t].unreadCount:o.push({conversationID:"C2C".concat(n[t].from),unreadCount:n[t].unreadCount,type:S.CONV_C2C}))}(T);if(Qe(d))for(var E=0,L=d.length;E<L;E++)!function(t){o.find(function(e){return e.conversationID==="C2C".concat(d[t].from)})||o.push({conversationID:"C2C".concat(d[t].from),type:S.CONV_C2C,lastMsgTime:d[t].lastMsgTime})}(E);return{conversationOptionsList:o,messageList:_,isUnreadC2CMessage:C}}},{key:"getMessageListFromUnreadDB",value:function(){return T(this._messageFromUnreadDBMap.values())}},{key:"_isC2CNotice",value:function(e){e=e.eventArray;return!(!Qe(e)||10!==e[0].event)}},{key:"_handleRevokedNoticeFromUnreadDB",value:function(){var t,e=this._noticeFromUnreadDBList.length;0!==e&&(A.l("".concat(this._n,"._handleRevokedNoticeFromUnreadDB count:").concat(e)),t=[],this._noticeFromUnreadDBList.forEach(function(e){e.hasOwnProperty("c2cMessageRevokedNotify")&&t.push(e)}),this.onC2CMessageRevoked({dataList:t}),this._noticeFromUnreadDBList.length=0,t.length=0)}},{key:"onC2CMessageRevoked",value:function(e){var a,s=this,r=this.get(11),c=[];e.dataList.forEach(function(e){e.c2cMessageRevokedNotify&&(e=e.c2cMessageRevokedNotify.revokedInfos,k(e)||e.forEach(function(e){var t=s.getMyUserID()===e.from?"".concat(S.CONV_C2C).concat(e.to):"".concat(S.CONV_C2C).concat(e.from);a=r.revoke(t,e.sequence,e.random);var n,o=e.revokerInfo&&e.revokerInfo.revoker,i=e.revokerInfo&&e.revokerInfo.reason||"";a?n=a:(n={conversationID:t,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(n.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)),e.time&&(n.time=e.time)),n&&(n.revoker=o,n.revokeReason=i,n.revokerInfo={userID:o,nick:"",avatar:""},c.push(n))}))}),0!==c.length&&(r.onMessageRevoked(c),A.l("".concat(this._n,".onC2CMessageRevoked count:").concat(c.length)),r.updateRevokerInfo(c).then(function(e){s.emitOuterEvent(G.MESSAGE_REVOKED,e)}))}},{key:"onC2CMessageReadReceipt",value:function(e){var i=this;e.dataList.forEach(function(e){var o;We(e.c2cMessageReadReceipt)||(o=e.c2cMessageReadReceipt.to,e.c2cMessageReadReceipt.uinPairReadArray.forEach(function(e){var e=e.peerReadTime,t=(A.d("".concat(i._n,"._onC2CMessageReadReceipt to:").concat(o," peerReadTime:").concat(e)),"".concat(S.CONV_C2C).concat(o)),n=i.get(11);n.recordPeerReadTime(t,e),n.updateMessageIsPeerReadProperty(t,e)}))})}},{key:"onC2CMessageReadNotice",value:function(e){var o=this;e.dataList.forEach(function(e){var n;We(e.c2cMessageReadNotice)||(n=o.get(11),e.c2cMessageReadNotice.uinPairReadArray.forEach(function(e){var t=e.from,e=e.peerReadTime,t=(A.d("".concat(o._n,".onC2CMessageReadNotice from:").concat(t," lastReadTime:").concat(e)),"".concat(S.CONV_C2C).concat(t));n.updateIsReadAfterReadReport({conversationID:t,lastMessageTime:e}),n.updateUnreadCount(t)}))})}},{key:"onC2CMessageModified",value:function(e){A.d("".concat(this._n,".onC2CMessageModified options:"),JSON.stringify(e));var t=this.get(11);e.dataList.forEach(function(e){t.onMessageModified(y(y({},e),{},{conversationType:S.CONV_C2C}))})}},{key:"onReadReceiptList",value:function(e){A.d("".concat(this._n,".onReadReceiptList options:"),JSON.stringify(e));var e=e.dataList,t=e.userID,e=e.readReceiptList;this.get(11).updateReadReceiptInfo({userID:t,readReceiptList:e})}},{key:"sendMessage",value:function(e,t){e=this._createC2CMessagePack(e,t);return this.req(e)}},{key:"_createC2CMessagePack",value:function(e,t){var n,o,i=null,a=(t&&(t.offlinePushInfo&&(i=t.offlinePushInfo),!0===t.onlineUserOnly&&(i?i.disablePush=!0:i={disablePush:!0})),""),s=(pt(e.cloudCustomData)&&0<e.cloudCustomData.length&&(a=e.cloudCustomData),[]),r=(Ze(t)&&Ze(t.messageControlInfo)&&(r=(o=t.messageControlInfo).excludedFromUnreadCount,n=o.excludedFromLastMessage,o=o.excludedFromContentModeration,!0===r&&s.push("NoUnread"),!0===n&&s.push("NoLastMsg"),!0===o&&s.push("NoMsgCheck")),this.isOnlineMessage(e,t)?0:void 0);return{proto:v.SEND_C2C_MSG,tjgID:this.generateTjgID(e),data:{fromAccount:this.getMyUserID(),toAccount:e.to,msgBody:e.getElements(),cloudCustomData:a,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:r,nick:e.nick,avatar:e.avatar,offlinePushInfo:Oo(i),messageControlInfo:0!==r?s:void 0,clientTime:e.clientTime,needReadReceipt:!0===e.needReadReceipt?1:0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID}}}},{key:"isOnlineMessage",value:function(e,t){return!(!t||!0!==t.onlineUserOnly)}},{key:"revokeMessage",value:function(e){return this.req({proto:v.REVOKE_C2C_MSG,data:{msgInfo:{fromAccount:e.from,toAccount:e.to,msgSeq:e.sequence,msgRandom:e.random,msgTimeStamp:e.time}}})}},{key:"deleteMessage",value:function(e){var t=e.to,e=e.keyList;return A.l("".concat(this._n,".deleteMessage toAccount:").concat(t," count:").concat(e.length)),this.req({proto:v.DEL_C2C_MSG,data:{fromAccount:this.getMyUserID(),to:t,keyList:e}})}},{key:"modifyRemoteMessage",value:function(e){var t=e.from,n=e.to,o=e.version,o=void 0===o?0:o,i=e.sequence,a=e.random,s=e.time,r=e.payload,c=e.type,e=e.cloudCustomData,u=void 0;return Ht(c)&&(u=[]).push({type:c,content:r}),this.req({proto:v.MODIFY_C2C_MSG,data:{from:t,to:n,version:o,sequence:i,random:a,time:s,elements:u,cloudCustomData:e}})}},{key:"setMessageRead",value:function(e){var t=this,n=e.conversationID,o=e.lastMessageTime,i="".concat(this._n,".").concat("setMessageRead"),e="conversationID:".concat(n," lastMessageTime:").concat(o),a=(A.l("".concat(i," ").concat(e)),ze(o)||this.outputWarning("DoNotModifyLastTime"),new M("setMessageRead"));return a.setMessage(e),this.req({proto:v.SET_C2C_MSG_READ,data:{C2CMsgReaded:{cookie:"",C2CMsgReadedItem:[{toAccount:n.replace("C2C",""),lastMessageTime:o,receipt:1}]}}}).then(function(){a.end(),A.l("".concat(i," ok"));var e=t.get(11);return e.updateIsReadAfterReadReport({conversationID:n,lastMessageTime:o}),e.updateUnreadCount(n),yn()}).catch(function(e){return a.setError(e).end(),A.l("".concat(i," failed. error:"),e),m(e)})}},{key:"getRoamingMessage",value:function(e){var a=this,s="".concat(this._n,".getRoamingMessage"),t=e.peerAccount,r=e.conversationID,n=e.count,o=e.lastMessageTime,e=e.messageKey,c="peerAccount:".concat(t," count:").concat(n||15," lastMessageTime:").concat(o||0," messageKey:").concat(e),u=(A.l("".concat(s," ").concat(c)),new M("getC2CRoamingMessages"));return this.req({proto:v.GET_C2C_ROAMING_MSG,data:{peerAccount:t,count:n||15,lastMessageTime:o||0,messageKey:e}}).then(function(e){var e=e.data,t=e.complete,n=e.messageList,o=e.messageKey,e=e.lastMessageTime,i=(k(n)?A.l("".concat(s," ok. complete:").concat(t," but messageList is undefined!")):A.l("".concat(s," ok. complete:").concat(t," count:").concat(n.length)),u.setMessage("".concat(c," complete:").concat(t," length:").concat(n.length)).end(),a.get(11)),t=(1===t&&i.setCompleted(r),i.onRoamingMessage(n,r)),n=(i.modifyMessageList(r),i.updateIsRead(r),i.updateRoamingMessageKeyAndTime(r,o,e),i.getPeerReadTime(r)),e=(A.l("".concat(s," update isPeerRead property. conversationID:").concat(r," peerReadTime:").concat(n)),n?i.updateMessageIsPeerReadProperty(r,n):(o=r.replace(S.CONV_C2C,""),a.getRemotePeerReadTime([o]).then(function(){i.updateMessageIsPeerReadProperty(r,i.getPeerReadTime(r))})),"");return 0<t.length?e=t[0].ID:(n=i.getLocalOldestMessage(r))&&(e=n.ID),A.l("".concat(s," nextReqID:").concat(e," stored message count:").concat(t.length)),{nextReqID:e,storedMessageList:t}}).catch(function(e){return u.setMessage(c).setError(e).end(),A.w("".concat(s," failed. error:"),e),m(e)})}},{key:"getRoamingMessagesHopping",value:function(e){var i=this,a="".concat(this._n,".getRoamingMessagesHopping"),t=e.peerAccount,n=e.time,n=void 0===n?0:n,o=e.count,s=e.direction,r="".concat(S.CONV_C2C).concat(t),c="peerAccount:".concat(t," count:").concat(o," time:").concat(n," direction:").concat(s),u=(A.l("".concat(a," ").concat(c)),new M("getC2CRoamingMessagesHopping"));return this.req({proto:v.GET_C2C_ROAMING_MSG,data:{peerAccount:t,count:o+1,lastMessageTime:n,direction:s}}).then(function(e){var e=e.data,t=e.complete,n=e.messageList,n=void 0===n?[]:n,e=e.lastMessageTime,o=(A.l("".concat(a," ok. complete:").concat(t," count:").concat(n.length)),u.setMessage("".concat(c," complete:").concat(t," length:").concat(n.length)).end(),1!==t&&(1===s?n.pop():n.shift()),i.get(11)),n=o.onRoamingMessage(n,r,!1),t=(i._modifyMessageList(r,n),i._computeResult({complete:t,lastMessageTime:e,resultList:n}));return o.storeHoppingMessageList(t.messageList),yn(t)}).catch(function(e){return u.setMessage(c).setError(e).end(),A.w("".concat(a," failed. error:"),e),m(e)})}},{key:"_computeResult",value:function(e){var t=e.complete,t=void 0===t?0:t,n=e.lastMessageTime,e=e.resultList,e={messageList:T(void 0===e?[]:e),isCompleted:!1,nextMessageTime:""};return 1===t?e.isCompleted=!0:e.nextMessageTime=n,e}},{key:"_modifyMessageList",value:function(e,t){e=this.get(11).getLocalConversation(e);if(e)for(var n=e.userProfile.nick,o=e.userProfile.avatar,e=this.get(4).getNickAndAvatarByUserID(this.getMyUserID()),i=e.nick,a=e.avatar,s=t.length-1;0<=s;s--){var r=t[s];"in"===r.flow&&(r.nick!==n&&r.setNickAndAvatar({nick:n}),r.avatar!==o&&r.setNickAndAvatar({avatar:o})),"out"===r.flow&&(r.nick!==i&&r.setNickAndAvatar({nick:i}),r.avatar!==a&&r.setNickAndAvatar({avatar:a}))}}},{key:"getRemotePeerReadTime",value:function(a){var s=this,r="".concat(this._n,".getRemotePeerReadTime");if(We(a))return A.w("".concat(r," userIDList is empty!")),Promise.resolve();var c=new M("getPeerReadTime");return A.l("".concat(r," userIDList:").concat(a)),this.req({proto:v.GET_C2C_PEER_READ_TIME,data:{userIDList:a}}).then(function(e){var t=e.data.peerReadTimeList;A.l("".concat(r," ok. peerReadTimeList:").concat(t));for(var n="",o=s.get(11),i=0;i<a.length;i++)n+="".concat(a[i],"-").concat(t[i]," "),0<t[i]&&o.recordPeerReadTime("C2C".concat(a[i]),t[i]);c.setMessage(n).end()}).catch(function(e){c.setError(e).end(),A.w("".concat(r," failed. error:"),e)})}},{key:"sendReadReceipt",value:function(e){var t=e[0].conversationID.replace(S.CONV_C2C,""),n=new M("sendReadReceipt"),o=(n.setMessage("peerAccount:".concat(t)),this.getMyUserID()),e=e.filter(function(e){return e.from!==o&&!0===e.needReadReceipt}).map(function(e){return{fromAccount:e.from,toAccount:e.to,sequence:e.sequence,random:e.random,time:e.time,clientTime:e.clientTime}});if(0===e.length)return m({code:C.READ_RECEIPT_MSG_LIST_EMPTY});var i="".concat(this._n,".").concat("sendReadReceipt");return A.l("".concat(i,". peerAccount:").concat(t," length:").concat(e.length)),this.req({proto:v.SEND_C2C_READ_RECEIPT,data:{peerAccount:t,messageInfoList:e}}).then(function(e){return n.end(),A.l("".concat(i," ok")),yn()}).catch(function(e){return n.setError(e).end(),A.w("".concat(i," failed. error:"),e),m(e)})}},{key:"getReadReceiptList",value:function(e){var t="".concat(this._n,".getReadReceiptList"),n=this.getMyUserID(),e=e.filter(function(e){return e.from===n&&!0===e.needReadReceipt});return A.l("".concat(t," userID:").concat(n," messageList length:").concat(e.length)),Cn({messageList:e})}},{key:"getMessageExtensions",value:function(e,t){return A.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t)),this.req({proto:v.GET_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),startSequence:t}})}},{key:"modifyMessageExtensions",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;return A.l("".concat(this._n,".modifyMessageExtensions operateType:").concat(n)),this.req({proto:v.MODIFY_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),extensionList:t,operateType:n}})}},{key:"getMessageKey",value:function(e){var t=e.clientSequence,n=e.random,e=e.time;return"".concat(t,"_").concat(n,"_").concat(e)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._messageFromUnreadDBMap.clear(),this._noticeFromUnreadDBList.length=0}}]);var No,Go=Fo,Po=(e(bo,[{key:"getLocalOldestMessageByConversationID",value:function(e){if(!e)return null;if(!this.list.has(e))return null;e=this.list.get(e).values();return e?e.next().value:null}},{key:"pushIn",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=e.conversationID,o=!0,i=(this.list.has(n)||this.list.set(n,new Map),this._getUniqueIDOfMessage(e));if(this.list.get(n).has(i)){var a=this.list.get(n).get(i);if(!t||!0===a.isModified)return!1}return this.list.get(n).set(i,e),this._setLatestMessageSentByPeer(n,e),this._setLatestMessageSentByMe(n,e),o}},{key:"unshift",value:function(e,t){var n;if(Qe(e)?0<e.length&&(n=e[0].conversationID,this._unshiftMultipleMessages(e,t)):(n=e.conversationID,this._unshiftSingleMessage(e,t)),n){var o=Array.from(this.list.get(n).values()),e=o.length;if(0!==e){for(var i=e-1;0<=i;i--)if("out"===o[i].flow){this._setLatestMessageSentByMe(n,o[i]);break}if(n.startsWith(S.CONV_C2C))for(var a=e-1;0<=a;a--)if("in"===o[a].flow){this._setLatestMessageSentByPeer(n,o[a]);break}}}}},{key:"_unshiftSingleMessage",value:function(e,t){var n=e.conversationID,o=this._getUniqueIDOfMessage(e);if(!this.list.has(n))return this.list.set(n,new Map),this.list.get(n).set(o,e),void t.push(e);var i=this.list.get(n),a=Array.from(i);i.has(o)||(a.unshift([o,e]),this.list.set(n,new Map(a)),t.push(e))}},{key:"_unshiftMultipleMessages",value:function(e,t){for(var n=e.length,o=[],i=e[0].conversationID,a=this.list.get(i),s=this.list.has(i)?Array.from(a):[],r=0;r<n;r++){var c=this._getUniqueIDOfMessage(e[r]);a&&a.has(c)||(o.push([c,e[r]]),t.push(e[r]))}this.list.set(i,new Map(o.concat(s)))}},{key:"remove",value:function(e){var t=e.conversationID,e=this._getUniqueIDOfMessage(e);this.list.has(t)&&this.list.get(t).delete(e)}},{key:"revoke",value:function(e,t,n){var o;return A.d("revoke message",e,t,n),this.list.has(e)?(o=this.list.get(e),this._updateMessageIsRevoked(o,t,n)):this._hoppingMessageMap.has(e)?(o=this._hoppingMessageMap.get(e),this._updateMessageIsRevoked(o,t,n)):null}},{key:"_updateMessageIsRevoked",value:function(e,t,n){var o,i=N(e);try{for(i.s();!(o=i.n()).done;){var a=I(o.value,2)[1];if(a.sequence===t&&(k(n)||a.random===n))return a.isRevoked||(a.isRevoked=!0),a}}catch(e){i.e(e)}finally{i.f()}}},{key:"removeByConversationID",value:function(e){var t=this.list.has(e);A.l("".concat(this._n,".removeByConversationID conversationID:").concat(e," has:").concat(t)),t&&(this.list.delete(e),this._latestMessageSentByPeerMap.delete(e),this._latestMessageSentByMeMap.delete(e))}},{key:"findMessage",value:function(e){var t=null;return t=(t=this._findMessage(e,this.list))?t:this._findMessage(e,this._hoppingMessageMap)}},{key:"_findMessage",value:function(e,t){var n,o=null,i=N(t);try{for(i.s();!(n=i.n()).done;)for(var a=T(I(n.value,2)[1].values()),s=a.length,r=0;r<s;r++)if(a[r].ID===e){o=a[r];break}}catch(e){i.e(e)}finally{i.f()}return o}},{key:"updateMessageIsPeerReadProperty",value:function(e,t){var n,o=[];return this.list.has(e)?(n=this.list.get(e),o=this._updateMessageIsPeerReadProperty(n,t)):this._hoppingMessageMap.has(e)&&(n=this._hoppingMessageMap.get(e),o=this._updateMessageIsPeerReadProperty(n,t)),A.l("".concat(this._n,".updateMessageIsPeerReadProperty conversationID:").concat(e," peerReadTime:").concat(t," count:").concat(o.length)),o}},{key:"_updateMessageIsPeerReadProperty",value:function(e,t){var n,o=[],i=N(e);try{for(i.s();!(n=i.n()).done;){var a=I(n.value,2)[1];a.time<=t&&!a.isPeerRead&&"out"===a.flow&&(a.isPeerRead=!0,o.push(a))}}catch(e){i.e(e)}finally{i.f()}return o}},{key:"updateMessageIsModifiedProperty",value:function(e){var t=e.conversationID;this.list.has(t)&&(e=this._getUniqueIDOfMessage(e),(t=this.list.get(t).get(e))&&(t.isModified=!0))}},{key:"hasLocalMessageList",value:function(e){return this.list.has(e)}},{key:"getLocalMessageList",value:function(e){return this.hasLocalMessageList(e)?T(this.list.get(e).values()):[]}},{key:"getLocalMaxSequence",value:function(e){if(!this.hasLocalMessageList(e))return 0;e=T(this.list.get(e).values()).map(function(e){return e.sequence});return Math.max.apply(Math,T(e))}},{key:"getLocalMaxTime",value:function(e){if(!this.hasLocalMessageList(e))return 0;e=T(this.list.get(e).values()).map(function(e){return e.time});return Math.max.apply(Math,T(e))}},{key:"hasLocalMessage",value:function(e,t){for(var n=!1,o=this.getLocalMessageList(e),i=o.length,a=0;a<i;a++)o[a].ID===t&&(n=!0);return n}},{key:"getLocalMessage",value:function(e,t){for(var n=null,o=this.getLocalMessageList(e),i=o.length,a=0;a<i;a++)if(o[a].ID===t){n=o[a];break}return n}},{key:"getLocalLastMessage",value:function(e){e=this.getLocalMessageList(e);return e[e.length-1]}},{key:"getLocalSecondLastMessage",value:function(e){e=this.getLocalMessageList(e);return e[e.length-2]}},{key:"getLocalOldestMessage",value:function(e){return this.getLocalMessageList(e)[0]}},{key:"_setLatestMessageSentByPeer",value:function(e,t){e.startsWith(S.CONV_C2C)&&"in"===t.flow&&this._latestMessageSentByPeerMap.set(e,t)}},{key:"_setLatestMessageSentByMe",value:function(e,t){"out"===t.flow&&this._latestMessageSentByMeMap.set(e,t)}},{key:"getLatestMessageSentByPeer",value:function(e){return this._latestMessageSentByPeerMap.get(e)}},{key:"getLatestMessageSentByMe",value:function(e){return this._latestMessageSentByMeMap.get(e)}},{key:"modifyMessageSentByPeer",value:function(e){var t=e.conversationID,n=e.latestNick,o=e.latestAvatar,e=this.list.get(t);if(!We(e)){var i=Array.from(e.values()),e=i.length;if(0!==e){for(var a=null,s=0,r=!1,c=e-1;0<=c;c--)"in"===i[c].flow&&((a=i[c]).nick!==n&&(a.setNickAndAvatar({nick:n}),r=!0),a.avatar!==o&&(a.setNickAndAvatar({avatar:o}),r=!0),r&&(s+=1));A.l("".concat(this._n,".modifyMessageSentByPeer conversationID:").concat(t," count:").concat(s))}}}},{key:"modifyMessageSentByMe",value:function(e){var t=e.conversationID,n=e.latestNick,o=e.latestAvatar,e=this.list.get(t);if(!We(e)){var i=Array.from(e.values()),e=i.length;if(0!==e){for(var a=null,s=0,r=!1,c=e-1;0<=c;c--)"out"===i[c].flow&&((a=i[c]).nick!==n&&(a.setNickAndAvatar({nick:n}),r=!0),a.avatar!==o&&(a.setNickAndAvatar({avatar:o}),r=!0),r&&(s+=1));A.l("".concat(this._n,".modifyMessageSentByMe conversationID:").concat(t," count:").concat(s))}}}},{key:"getTopicConversationIDList",value:function(t){return T(this.list.keys()).filter(function(e){return e.startsWith("".concat(S.CONV_GROUP).concat(t))})}},{key:"traversal",value:function(){if(0!==this.list.size&&-1===A.getLevel()){console.group("conversationID-messageCount");var e,t=N(this.list);try{for(t.s();!(e=t.n()).done;){var n=I(e.value,2),o=n[0],i=n[1];console.log("".concat(o,"-").concat(i.size))}}catch(e){t.e(e)}finally{t.f()}console.groupEnd()}}},{key:"onMessageModified",value:function(e,t){if(!this.list.has(e)&&!this._hoppingMessageMap.has(e))return{isUpdated:!1,message:null};var n="".concat(this._n,".onMessageModified"),o=this._getUniqueIDOfMessage(t),i=this._getTargetMessage(e,o),a=!!i;return A.l("".concat(n," conversationID:").concat(e," uniqueID:").concat(o," has:").concat(a)),a?(e=t.messageVersion,o=t.elements,a=t.cloudCustomData,t=t.checkResult,A.l("".concat(n," localVersion:").concat(i.version," remoteVersion:").concat(e)),i.version<e?(i.version=e,i._elements=JSON.parse(JSON.stringify(o)),i.payload=JSON.parse(JSON.stringify(o[0].content)),i.type=o[0].type,i.cloudCustomData=a,i.isModified=!0,i.hasRiskContent=Xt(t),{isUpdated:!0,message:i}):{isUpdated:!1,message:i}):{isUpdated:!1,message:null}}},{key:"_getUniqueIDOfMessage",value:function(e){var t=e.from,n=e.to,o=e.random,i=e.sequence,e=e.time;return"".concat(t,"-").concat(n,"-").concat(o,"-").concat(i,"-").concat(e)}},{key:"_getTargetMessage",value:function(e,t){if(this.list.has(e))return this.list.get(e).get(t);var n=void 0;if(this._hoppingMessageMap.has(e))for(var o=T(this._hoppingMessageMap.get(e).values()),i=0;i<o.length;i++)if(this._getUniqueIDOfMessage(o[i])===t){n=o[i];break}return n}},{key:"storeHoppingMessageList",value:function(e){if(0!==e.length){var t=e[0].conversationID,n=e.length;this._hoppingMessageMap.has(t)||this._hoppingMessageMap.set(t,new Map);for(var o=this._hoppingMessageMap.get(t),i=0;i<n;i++){var a=e[i];o.has(a.ID)||o.set(a.ID,a)}}}},{key:"getHoppingMessage",value:function(e,t){if(this._hoppingMessageMap.has(e))return this._hoppingMessageMap.get(e).get(t)}},{key:"reset",value:function(){this.list.clear(),this._latestMessageSentByPeerMap.clear(),this._latestMessageSentByMeMap.clear(),this._hoppingMessageMap.clear()}}]),bo),Uo={A2KEY_AND_TINYID_UPDATED:"_inner".concat(1),CLOUD_CONFIG_UPDATED:"_inner".concat(2),PROFILE_UPDATED:"_inner".concat(3),CONV_SYNC_COMPLETED:"_inner".concat(4),C2C_UNREAD_HANDLE_COMPLETED:"_inner".concat(5)};function bo(){u(this,bo),this.list=new Map,this._n="MessageListHandler",this._latestMessageSentByPeerMap=new Map,this._latestMessageSentByMeMap=new Map,this._hoppingMessageMap=new Map}function Fo(e){return u(this,Fo),(e=No.call(this,e))._n="C2CModule",e._messageFromUnreadDBMap=new Map,e._noticeFromUnreadDBList=[],e}function wo(e){this.mixin(e)}wo.mixin=function(e){e=e.prototype||e;e._isReady=!1,e.ready=function(e){if(e)return this._isReady?void(1<arguments.length&&void 0!==arguments[1]&&arguments[1]?e.call(this):setTimeout(e,1)):(this._readyQueue=this._readyQueue||[],void this._readyQueue.push(e))},e.triggerReady=function(){var t=this;this._isReady=!0,setTimeout(function(){var e=t._readyQueue;t._readyQueue=[],e&&0<e.length&&e.forEach(function(e){e.call(this)},t)},1)},e.resetReady=function(){this._isReady=!1,this._readyQueue=[]},e.isReady=function(){return this._isReady}};function qo(e,t,n){return k(e)?{lastTime:0,lastSequence:0,fromAccount:"",messageForShow:"",payload:null,type:"",isRevoked:!1,cloudCustomData:"",onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:!1,revoker:null}:n&&e.ID||e instanceof go?{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",messageForShow:Vt(e.type,e.payload,t),payload:e.payload||null,type:e.type||null,isRevoked:e.isRevoked||!1,cloudCustomData:e.cloudCustomData||"",onlineOnlyFlag:e._onlineOnlyFlag||!1,nick:e.nick||"",nameCard:e.nameCard||"",version:e.version||0,isPeerRead:e.isPeerRead||!1,revoker:e.revoker||null}:y(y({},e),{},{messageForShow:Vt(e.type,e.payload,t)})}function xo(e,t){return We(e)?{lastTime:0,lastSequence:0,fromAccount:"",payload:null,type:"",messageForShow:"",nick:"",avatar:"",version:0,cloudCustomData:"",isRevoked:!1,revoker:null}:{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",payload:e.payload||null,type:e.type||"",messageForShow:Vt(e.type,e.payload,t),nick:e.nick||"",avatar:e.avatar||"",version:e.version||0,cloudCustomData:e.cloudCustomData||"",isRevoked:e.isRevoked||!1,revoker:e.revoker||null}}function Vo(e){var t=String(e).replace(/[=]+$/,""),n="";if(t.length%4==1)return"";for(var o,i,a=0,s=0;i=t.charAt(s++);~i&&(o=a%4?64*o+i:i,a++%4)&&(n+=String.fromCharCode(255&o>>(-2*a&6))))i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);try{return decodeURIComponent(escape(n))}catch(e){return""}}var Ho,Bo,Ko,Wo,Yo,jo=["jpg","jpeg","gif","png","bmp","image","webp"],Jo=["mp4","quicktime","mov"],zo=(e(Qi,[{key:"validate",value:function(e){var t,n=!0,o="";if(We(e))return{valid:!1,tips:"empty options"};if(e.profileCustomField)for(var i=e.profileCustomField.length,a=null,s=0;s<i;s++){if(a=e.profileCustomField[s],!pt(a.key)||-1===a.key.indexOf("Tag_Profile_Custom"))return{valid:!1,tips:"The prefix of keys of the custom profile key-value pairs (which is profileCustomField) must be Tag_Profile_Custom"};if(!pt(a.value))return{valid:!1,tips:"The type of values of the custom profile key-value pairs (which is profileCustomField) must be String"}}for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if("profileCustomField"===t)continue;if(We(e[t])&&!pt(e[t])&&!ze(e[t])){o="key:"+t+", invalid value:"+e[t],n=!1;continue}switch(t){case"nick":pt(e[t])||(n=!(o="nick must be a string")),500<at(e[t])&&(o="nick name limited: must less than or equal to ".concat(500," bytes, current size: ").concat(at(e[t])," bytes"),n=!1);break;case"gender":ct(we,e.gender)||(o="key:gender, invalid value:"+e.gender,n=!1);break;case"birthday":ze(e.birthday)||(n=!(o="birthday must be a number"));break;case"location":pt(e.location)||(n=!(o="location must be a string"));break;case"selfSignature":pt(e.selfSignature)||(n=!(o="selfSignature must be a string"));break;case"allowType":ct(xe,e.allowType)||(o="key:allowType, invalid value:"+e.allowType,n=!1);break;case"language":ze(e.language)||(n=!(o="language must be a number"));break;case"avatar":pt(e.avatar)||(n=!(o="avatar must be a string"));break;case"messageSettings":0!==e.messageSettings&&1!==e.messageSettings&&(n=!(o="messageSettings must be 0 or 1"));break;case"adminForbidType":ct(qe,e.adminForbidType)||(o="key:adminForbidType, invalid value:"+e.adminForbidType,n=!1);break;case"level":ze(e.level)||(n=!(o="level must be a number"));break;case"role":ze(e.role)||(n=!(o="role must be a number"));break;default:o="unknown key:"+t+"  "+e[t],n=!1}}return{valid:n,tips:o}}}]),Qi),Xo=e(function e(t){u(this,e),this.value=t,this.next=null}),Zo=(e(Zi,[{key:"set",value:function(e){var t,n=new Xo(e);this.map.size<this.MAX_LENGTH?null===this.pTail?(this.pTail=n,this.pNodeToDel=n):(this.pTail.next=n,this.pTail=n):(t=this.pNodeToDel,this.pNodeToDel=this.pNodeToDel.next,this.map.delete(t.value),t.next=null,t=null,this.pTail.next=n,this.pTail=n),this.map.set(e,1)}},{key:"has",value:function(e){return this.map.has(e)}},{key:"delete",value:function(e){this.has(e)&&this.map.delete(e)}},{key:"tail",value:function(){return this.pTail}},{key:"size",value:function(){return this.map.size}},{key:"data",value:function(){return Array.from(this.map.keys())}},{key:"reset",value:function(){for(var e;null!==this.pNodeToDel;)e=this.pNodeToDel,this.pNodeToDel=this.pNodeToDel.next,e.next=null,e=null;this.pTail=null,this.map.clear()}}]),Zi),Qo=["groupID","name","avatar","type","introduction","notification","ownerID","selfInfo","createTime","infoSequence","lastInfoTime","lastMessage","nextMessageSeq","memberNum","maxMemberNum","memberList","joinOption","groupCustomField","muteAllMembers","isSupportTopic","inviteOption","_lastRevokedTime"],$o=(e(Xi,[{key:"memberNum",get:function(){return this.memberCount},set:function(e){}},{key:"maxMemberNum",get:function(){return this.maxMemberCount},set:function(e){}},{key:"_initGroup",value:function(e){for(var t in e)Qo.indexOf(t)<0||("selfInfo"!==t?("memberNum"===t&&(this.memberCount=e[t]),"maxMemberNum"===t&&(this.maxMemberCount=e[t]),"isSupportTopic"!==t?this[t]=e[t]:this.isSupportTopic=1===e[t]):this.updateSelfInfo(e[t]))}},{key:"updateGroup",value:function(e){var t=this,e=(e.appid=void 0,e.grossTopicNextMsgSeq=void 0,e.selfInfo&&(e.selfInfo.grossTopicReadSeq=void 0),JSON.parse(JSON.stringify(e)));e.lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),k(e.muteAllMembers)||("On"===e.muteAllMembers?e.muteAllMembers=!0:e.muteAllMembers=!1),e.groupCustomField&&It(this.groupCustomField,e.groupCustomField),k(e.memberNum)||(this.memberCount=e.memberNum),k(e.maxMemberNum)||(this.maxMemberCount=e.maxMemberNum),k(e.isSupportTopic)||(this.isSupportTopic=ze(e.isSupportTopic)?1===e.isSupportTopic:e.isSupportTopic),ot(this,e,["members","errorCode","lastMsgTime","groupCustomField","memberNum","maxMemberNum","isSupportTopic"]),Qe(e.members)&&0<e.members.length&&e.members.forEach(function(e){e.userID===t.selfInfo.userID&&ot(t.selfInfo,e,["sequence"])})}},{key:"updateSelfInfo",value:function(e){e={nameCard:e.nameCard,joinTime:e.joinTime,role:e.role,messageRemindType:e.messageRemindType,readedSequence:e.readedSequence,excludedUnreadSequenceList:e.excludedUnreadSequenceList};ot(this.selfInfo,y({},e),[],["",null,void 0,0,NaN])}},{key:"setSelfNameCard",value:function(e){this.selfInfo.nameCard=e}}]),Xi),ei=(e(zi,[{key:"toAccount",get:function(){return this.conversationID.startsWith(S.CONV_C2C)?this.conversationID.replace(S.CONV_C2C,""):this.conversationID.startsWith(S.CONV_GROUP)?this.conversationID.replace(S.CONV_GROUP,""):""}},{key:"_initProfile",value:function(t){var n=this;Object.keys(t).forEach(function(e){switch(e){case"userProfile":n.userProfile=t.userProfile;break;case"groupProfile":n.groupProfile=t.groupProfile}}),k(this.userProfile)&&this.type===S.CONV_C2C?this.userProfile=new zo({userID:t.conversationID.replace("C2C","")}):k(this.groupProfile)&&this.type===S.CONV_GROUP&&(this.groupProfile=new $o({groupID:t.conversationID.replace("GROUP","")}))}},{key:"updateUnreadCount",value:function(e){var t=e.nextUnreadCount,n=e.isFromGetConversations,e=e.isUnreadC2CMessage;k(t)||(Tt(this.subType)?this.unreadCount=0:n&&this.type===S.CONV_GROUP||n&&this.type===S.CONV_TOPIC||e&&this.type===S.CONV_C2C?this.unreadCount=t:this.unreadCount=this.unreadCount+t)}},{key:"updateLastMessage",value:function(e){this.lastMessage=qo(e)}},{key:"updateGroupAtInfoList",value:function(e){var t;this._isNeedMergeGroupAtInfo(e)||(-1!==(t=(D(t=e.groupAtType)||E(t)||L(t)||O()).slice(0)).indexOf(S.CONV_AT_ME)&&-1!==t.indexOf(S.CONV_AT_ALL)&&(t=[S.CONV_AT_ALL_AT_ME]),t={from:e.from,groupID:e.groupID,topicID:e.topicID,messageSequence:e.sequence,atTypeArray:t,__random:e.__random,__sequence:e.__sequence},this.groupAtInfoList.push(t))}},{key:"_isNeedMergeGroupAtInfo",value:function(t){var e=t.groupID,n=t.sequence;if(!Dt({groupID:e}))return!1;var o=!1;return this.groupAtInfoList.forEach(function(e){e.messageSequence===n&&(-1<e.atTypeArray.indexOf(S.CONV_AT_ME)&&-1<t.groupAtType.indexOf(S.CONV_AT_ALL)&&(e.atTypeArray=[S.CONV_AT_ALL_AT_ME]),-1<e.atTypeArray.indexOf(S.CONV_AT_ALL)&&-1<t.groupAtType.indexOf(S.CONV_AT_ME)&&(e.atTypeArray=[S.CONV_AT_ALL_AT_ME],e.__random=t.__random,e.__sequence=t.__sequence),o=!0)}),o}},{key:"clearGroupAtInfoList",value:function(){this.groupAtInfoList.length=0}},{key:"reduceUnreadCount",value:function(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}},{key:"isLastMessageRevoked",value:function(e){var t=e.sequence,e=e.time;return this.type===S.CONV_C2C&&t===this.lastMessage.lastSequence&&e===this.lastMessage.lastTime||this.type===S.CONV_GROUP&&t===this.lastMessage.lastSequence}},{key:"setLastMessageRevoked",value:function(e){this.lastMessage.isRevoked=e}},{key:"setLastMessageRevoker",value:function(e){this.lastMessage.revoker=e}},{key:"setDraftText",value:function(e){this.draftText=e}}]),zi),ti=(c(re={},S.MSG_REMIND_ACPT_AND_NOTE,0),c(re,S.MSG_REMIND_DISCARD,1),c(re,S.MSG_REMIND_ACPT_NOT_NOTE,2),re),ni=(e(Ji,[{key:"onAllReceiveMessageOptNotify",value:function(e){e=this._handleResult(e);this._convM.emitOuterEvent(G.ALL_RECEIVE_MESSAGE_OPT_UPDATED,e)}},{key:"getC2CMessageRemindType",value:function(t){var n=this,o="".concat(this._n,".getC2CMessageRemindType");return this._convM.req({proto:v.GET_C2C_PEER_MUTE_NOTIFICATIONS,data:{toAccount:this._convM.getMyUserID(),userIDList:t}}).then(function(e){A.l("".concat(o," ok. userIDList:").concat(t));e=e.data.muteFlagList;n._convM.onC2CMessageRemindTypeFetched(e)}).catch(function(e){A.e("".concat(o," failed. error:"),e)})}},{key:"set",value:function(e){return e.groupID?this._setGroupMessageRemindType(e):Qe(e.userIDList)?this._setC2CMessageRemindType(e):void 0}},{key:"_setGroupMessageRemindType",value:function(t){var n=this,o="".concat(this._n,"._setGroupMessageRemindType"),e=t.groupID,i=t.messageRemindType,a="groupID:".concat(e," messageRemindType:").concat(i),s=new M("setMessageRemindType"),r=(s.setMessage(a),this._get(7));return r?r.modifyGroupMemberInfo({groupID:e,messageRemindType:i,userID:this._convM.getMyUserID()}).then(function(){s.end(),A.l("".concat(o," ok. ").concat(a));var e=n.onGroupMessageRemindTypeUpdated(t);return n._convM.emitTotalUnreadMessageCountUpdate(),yn(e)}).catch(function(e){return s.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)}):m({code:C.CANNOT_FIND_MODULE})}},{key:"onGroupMessageRemindTypeUpdated",value:function(e){var t,n,o=e.groupID,e=e.messageRemindType,i=(A.l("".concat(this._n,".onGroupMessageRemindTypeUpdated groupID:").concat(o," messageRemindType:").concat(e)),this._get(7).getLocalGroupProfile(o));return i&&(i.selfInfo.messageRemindType=e),Et(o)?(t=xt(n=o),(n=this._get(10).getLocalTopic(t,n))&&(n.updateSelfInfo({messageRemindType:e}),this._convM.emitOuterEvent(G.TOPIC_UPDATED,{groupID:t,topic:n})),{topic:n}):(this._convM.patchMessageRemindType({ID:o,isC2CConversation:!1,messageRemindType:e})&&this._emitConversationUpdate(),{group:i})}},{key:"_setC2CMessageRemindType",value:function(e){var i=this,a="".concat(this._n,"._setC2CMessageRemindType"),t=e.userIDList,s=e.messageRemindType,r=t.slice(0,30),e=ti[s]||0,c="userIDList:".concat(r," messageRemindType:").concat(s),u=new M("setMessageRemindType");return u.setMessage(c),this._convM.req({proto:v.SET_C2C_PEER_MUTE_NOTIFICATIONS,data:{userIDList:r,muteFlag:e}}).then(function(e){u.end();var e=e.data.errorList,t=[],n=[],e=(Qe(e)&&e.forEach(function(e){t.push(e.userID),n.push({userID:e.userID,code:e.errorCode})}),r.filter(function(e){return-1===t.indexOf(e)})),o=(A.l("".concat(a," ok. ").concat(c," successUserIDList:").concat(e," failureUserIDList:").concat(JSON.stringify(n))),0);return e.forEach(function(e){i._convM.patchMessageRemindType({ID:e,isC2CConversation:!0,messageRemindType:s})&&(o+=1)}),1<=o&&i._emitConversationUpdate(),r.length=t.length=0,i._convM.emitTotalUnreadMessageCountUpdate(),Cn({successUserIDList:e.map(function(e){return{userID:e}}),failureUserIDList:n})}).catch(function(e){return u.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e)})}},{key:"_get",value:function(e){return this._convM.get(e)}},{key:"_emitConversationUpdate",value:function(){this._convM.emitConversationUpdate(!0,!1)}},{key:"setAllReceiveMessageOpt",value:function(e){var t="".concat(this._n,".").concat("setAllReceiveMessageOpt"),n=e.messageRemindType,n=void 0===n?S.MSG_REMIND_ACPT_NOT_NOTE:n,o=e.isRepeated,o=void 0===o||o,i=this._calcStartAndEndTime(e),a=i.startTime,a=void 0===a?0:a,i=i.endTime,i=void 0===i?0:i,e=JSON.stringify(e),s=new M("setAllReceiveMessageOpt");return s.setMessage(e),A.l("".concat(t," options:").concat(e)),this._convM.req({proto:v.SET_ALL_RECEIVE_MSG_OPT,data:{messageRemindType:ti[n],startTime:a,endTime:i,isRepeated:o?1:0}}).then(function(e){return s.end(),A.l("".concat(t," ok.")),yn(e)}).catch(function(e){return s.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"_calcStartAndEndTime",value:function(e){var t=e.startHour,t=void 0===t?0:t,n=e.startMinute,n=void 0===n?0:n,o=e.startSecond,o=void 0===o?0:o,i=e.duration,i=void 0===i?0:i,e=e.isRepeated,e=void 0===e||e,a=new Date,s=a.getFullYear(),r=a.getMonth(),a=a.getDate(),s=Math.round(new Date(s,r,a,t,n,o).getTime()/1e3);return{startTime:s,endTime:e&&86400<=i?s+86400:s+i}}},{key:"getAllReceiveMessageOpt",value:function(){var t=this,n="".concat(this._n,".").concat("getAllReceiveMessageOpt"),o=new M("getAllReceiveMessageOpt");return this._convM.req({proto:v.GET_ALL_RECEIVE_MSG_OPT,data:{toAccount:this._convM.getMyUserID()}}).then(function(e){e=e.data,o.setMessage(JSON.stringify(e)).end(),A.l("".concat(n," ok. data:").concat(JSON.stringify(e))),e=t._handleResult(e);return yn(e)}).catch(function(e){return o.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"_handleResult",value:function(e){var t=e.messageRemindType,n=e.startTime,o=e.endTime,e=e.isRepeated,i=S.MSG_REMIND_ACPT_AND_NOTE;return 1===t&&(i=S.MSG_REMIND_DISCARD),{messageRemindType:i=2===t?S.MSG_REMIND_ACPT_NOT_NOTE:i,startTime:n,endTime:o,isRepeated:1===e}}},{key:"reset",value:function(){A.l("".concat(this._n,".reset"))}}]),Ji),oi=(e(ji,[{key:"setConvCustomData",value:function(e){var i=this,a="".concat(this._n,".").concat("setConvCustomData"),t=e.conversationIDList,s=e.customData,r=(A.l("".concat(a," options:"),e),new M("setConvCustomData")),n=(r.setMessage(JSON.stringify(e)),{fromAccount:this._getMyUserID(),itemList:[]}),c=[],u=[];return t.forEach(function(e){if(!i._hasLocalConversation(e))return i._onConversationNotFound(u,e),!0;if(!Lt(e)&&!St(e))return i._onConversationIDInvalid(u,e),!0;var t={operationType:2,contactItem:void 0,customMark:s};Lt(e)?t.contactItem={type:1,toAccount:e.replace(S.CONV_C2C,"")}:St(e)&&(t.contactItem={type:2,groupID:e.replace(S.CONV_GROUP,"")}),n.itemList.push(t)}),u.length===t.length?Cn({successConversationIDList:c,failureConversationIDList:u}):this._convM.req({proto:v.SET_CONV_CUSTOM_DATA,data:n}).then(function(e){r.end(),A.l("".concat(a," ok"));var t,n,o,e=e.data.resultItem;return Qe(e)&&(o=!1,e.forEach(function(e){t=i._concatConversationID(e.contactItem),0===e.resultCode?(c.push(t),(n=i._getLocalConversation(t))&&n.customData!==s&&(n.customData=s,o=!0)):u.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===o&&i._emitConversationUpdate()),yn({successConversationIDList:c,failureConversationIDList:u})}).catch(function(e){return r.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e)})}},{key:"markConversation",value:function(e){var a=this;if(!this._convM.canIUse(H.CONV_MARK))return this._convM.cannotUseCommercialAbility("markConversation");var t="".concat(this._n,".").concat("markConversation"),n=e.conversationIDList,s=e.markType,r=e.enableMark,c=(A.l("".concat(t," options:"),e),new M("markConversation")),o=(c.setMessage(JSON.stringify(e)),void 0),i=void 0,e=this._getFlagBit(s),d=(!0===r?i=[e]:o=[e],{fromAccount:this._getMyUserID(),itemList:[]}),u=[],l=[];return n.forEach(function(e){if(!a._hasLocalConversation(e))return a._onConversationNotFound(l,e),!0;if(!Lt(e)&&!St(e))return a._onConversationIDInvalid(l,e),!0;var t={operationType:1,contactItem:void 0,clearMark:o,setMark:i};Lt(e)?t.contactItem={type:1,toAccount:e.replace(S.CONV_C2C,"")}:St(e)&&(t.contactItem={type:2,groupID:e.replace(S.CONV_GROUP,"")}),d.itemList.push(t)}),l.length===n.length?Cn({successConversationIDList:u,failureConversationIDList:l}):this._convM.req({proto:v.MARK_CONV,data:d}).then(function(e){c.end(),A.l("".concat(t," ok"));var n,o,i,e=e.data.resultItem;return Qe(e)&&(i=!1,e.forEach(function(e){var t;n=a._concatConversationID(e.contactItem),0===e.resultCode?(u.push(n),(o=a._getLocalConversation(n))&&(t=o.markList.indexOf(s),!0===r?-1===t&&(o.markList.push(s),i=!0):-1!==t&&(o.markList.splice(t,1),i=!0))):l.push({conversationID:n,code:e.resultCode,message:e.resultInfo})}),!0===i&&a._emitConversationUpdate()),yn({successConversationIDList:u,failureConversationIDList:l})}).catch(function(e){return c.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"getLocalConvGroupList",value:function(){var e=this;return A.l("".concat(this._n,".getLocalConvGroupList pagingStatus:").concat(this._pagingStatus)),this._pagingStatus===Rn?this.getRemoteConvGroupList().then(function(){return yn(T(e._convGroupMap.values()))}):Cn(T(this._convGroupMap.values()))}},{key:"searchConvGroupAndMark",value:function(e,t){var n=this,o="".concat(this._n,".searchConvGroupAndMark"),i=[];return e.forEach(function(e){1===t?i.push({type:1,toAccount:e}):2===t&&i.push({type:2,groupID:e})}),A.l("".concat(o," type:").concat(t," list:"),e),this._convM.req({proto:v.SEARCH_CONV_GRP_MARK,data:{fromAccount:this._getMyUserID(),contactItem:i}}).then(function(e){var e=e.data,t=e.contactItem,e=e.groupItem;A.l("".concat(o," ok. contactItem:"),t,"groupItem:",e),n._fillConvGroupMap(e),n._handleContactItem(t),n._emitConversationUpdate()}).catch(function(e){A.w("".concat(o," failed. error:"),e)})}},{key:"_fillConvGroupMap",value:function(e){var n=this;Qe(e)&&e.forEach(function(e){var t=e.convGroupID,e=e.groupName;n._convGroupMap.set(t,e)})}},{key:"_handleContactItem",value:function(e){var a,s=this;Qe(e)&&e.forEach(function(e){var t=[],n=e.standardMark,o=e.customData,i=e.convGroupIDList;Qe(i)&&i.forEach(function(e){s._convGroupMap.has(e)&&t.push(s._convGroupMap.get(e))}),a=s._concatConversationID(e),(a=s._getLocalConversation(a))&&(a.markList=Bt(n),a.customData=o||"",a.conversationGroupList=[].concat(t))})}},{key:"getRemoteConvGroupList",value:function(){var i=this,a="".concat(this._n,".getRemoteConvGroupList");return this._pagingStatus=An,this._convM.req({proto:v.GET_CONV_GRP_LIST,data:{fromAccount:this._getMyUserID(),startIndex:this._startIndex}}).then(function(e){var e=e.data,t=e.completeFlag,n=e.contactItem,o=e.nextStartIndex,o=void 0===o?0:o,e=e.groupItem;if(i._startIndex=o,A.l("".concat(a," completeFlag:").concat(t," nextStartIndex:").concat(o,", groupItem:"),e,"contactItem:",n),i._fillConvGroupMap(e),i._handleContactItem(n),0===t)return i.getRemoteConvGroupList();1===t&&(i._pagingStatus=kn,i._emitConversationUpdate(),i._emitConvGroupListUpdate())}).catch(function(e){i._pagingStatus=Rn,A.w("".concat(a," failed. error:"),e)})}},{key:"createConvGroup",value:function(e){var a=this,t="createConversationGroup";if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.cannotUseCommercialAbility(t);var s="".concat(this._n,".").concat(t),r=(A.l("".concat(s," options:"),e),new M(t)),c=(r.setMessage(JSON.stringify(e)),e.groupName),t=e.conversationIDList,n={fromAccount:this._getMyUserID(),itemList:[{groupName:c,contactItem:[]}]},u=[],l=[];return t.forEach(function(e){return a._hasLocalConversation(e)?Lt(e)||St(e)?void(Lt(e)?n.itemList[0].contactItem.push({type:1,toAccount:e.replace(S.CONV_C2C,"")}):St(e)&&n.itemList[0].contactItem.push({type:2,groupID:e.replace(S.CONV_GROUP,"")})):(a._onConversationIDInvalid(l,e),!0):(a._onConversationNotFound(l,e),!0)}),l.length===t.length?Cn({successConversationIDList:u,failureConversationIDList:l}):this._convM.req({proto:v.CREATE_CONV_GRP,data:n}).then(function(e){r.end(),A.l("".concat(s," ok"));var t,n,o,e=e.data.groupResultItem[0],i=e.groupItem,e=e.resultItem;return Ze(i)&&(a._convGroupMap.set(i.convGroupID,i.groupName),a._emitConvGroupListUpdate()),Qe(e)&&(o=!1,e.forEach(function(e){t=a._concatConversationID(e.contactItem),0===e.resultCode?(u.push(t),(n=a._getLocalConversation(t))&&-1===n.conversationGroupList.indexOf(c)&&(n.conversationGroupList.push(c),o=!0)):l.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===o&&(a._emitConversationUpdate(),a._emitConvGroupListUpdate())),yn({successConversationIDList:u,failureConversationIDList:l})}).catch(function(e){return r.setError(e).end(),A.e("".concat(s," failed. error:"),e),m(e)})}},{key:"deleteConvGroup",value:function(n){var o=this,e="deleteConversationGroup";if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.cannotUseCommercialAbility(e);var i="".concat(this._n,".").concat(e),a=(A.l("".concat(i," groupName:").concat(n)),new M(e));return a.setMessage(n),this._convM.req({proto:v.DEL_CONV_GRP,data:{fromAccount:this._getMyUserID(),groupName:[n]}}).then(function(e){a.end(),A.l("".concat(i," ok"));var t,e=e.data.groupItem;Qe(e)&&(t=!1,e.forEach(function(e){o._convGroupMap.has(e.convGroupID)&&(o._convGroupMap.delete(e.convGroupID),t=!0)}),!0===t&&o._emitConvGroupListUpdate()),o._eraseFromConversationGroupList([n])}).catch(function(e){return a.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"renameConvGroup",value:function(e){var i=this,t="renameConversationGroup";if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.cannotUseCommercialAbility(t);var a="".concat(this._n,".").concat(t),s=(A.l("".concat(a," options:"),e),new M(t)),r=(s.setMessage(JSON.stringify(e)),e.oldName),c=e.newName;return this._convM.req({proto:v.RENAME_CONV_GRP,data:{fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:1,oldName:r,newName:c}}}).then(function(e){s.end(),A.l("".concat(a," ok"));e=e.data.updateGroupResult.convGroupID;i._convGroupMap.set(e,c),i._emitConvGroupListUpdate();var t,n,e=i._convM.getLocalConversationList(),o=!1;e.forEach(function(e){t=e.conversationGroupList,-1!==(n=t.indexOf(r))&&(t.splice(n,1,c),o=!0)}),!0===o&&i._emitConversationUpdate()}).catch(function(e){return s.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e)})}},{key:"addConvsToGroup",value:function(e){var i=this,t="addConversationsToGroup";if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.cannotUseCommercialAbility(t);var a="".concat(this._n,".").concat(t),s=(A.l("".concat(a," options:"),e),new M(t)),t=(s.setMessage(JSON.stringify(e)),e.conversationIDList),r=e.groupName,n={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:r,updateItem:[]}},c=[],u=[];return t.forEach(function(e){return i._hasLocalConversation(e)?Lt(e)||St(e)?void(Lt(e)?n.updateGroup.updateItem.push({operationType:1,contactItem:{type:1,toAccount:e.replace(S.CONV_C2C,"")}}):St(e)&&n.updateGroup.updateItem.push({operationType:1,contactItem:{type:2,groupID:e.replace(S.CONV_GROUP,"")}})):(i._onConversationIDInvalid(u,e),!0):(i._onConversationNotFound(u,e),!0)}),u.length===t.length?Cn({successConversationIDList:c,failureConversationIDList:u}):this._convM.req({proto:v.ADD_CONV_TO_GRP,data:n}).then(function(e){s.end(),A.l("".concat(a," ok"));var t,n,o,e=e.data.updateGroupResult.contactResultItem;return Qe(e)&&(o=!1,e.forEach(function(e){t=i._concatConversationID(e.contactItem),0===e.resultCode?(n=i._getLocalConversation(t))&&-1===n.conversationGroupList.indexOf(r)&&(n.conversationGroupList.push(r),c.push(t),o=!0):u.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===o&&(i._emitConversationUpdate(),i._emitConvInGroupUpdate(r))),yn({successConversationIDList:c,failureConversationIDList:u})}).catch(function(e){return s.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e)})}},{key:"deleteConvsFromGroup",value:function(e){var a=this,t="deleteConversationsFromGroup";if(!this._convM.canIUse(H.CONV_GROUP))return this._convM.cannotUseCommercialAbility(t);var s="".concat(this._n,".").concat(t),r=(A.l("".concat(s," options:"),e),new M(t)),t=(r.setMessage(JSON.stringify(e)),e.conversationIDList),c=e.groupName,n={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:c,updateItem:[]}},u=[],l=[];return t.forEach(function(e){return a._hasLocalConversation(e)?Lt(e)||St(e)?void(Lt(e)?n.updateGroup.updateItem.push({operationType:2,contactItem:{type:1,toAccount:e.replace(S.CONV_C2C,"")}}):St(e)&&n.updateGroup.updateItem.push({operationType:2,contactItem:{type:2,groupID:e.replace(S.CONV_GROUP,"")}})):(a._onConversationIDInvalid(l,e),!0):(a._onConversationNotFound(l,e),!0)}),l.length===t.length?Cn({successConversationIDList:u,failureConversationIDList:l}):this._convM.req({proto:v.DEL_CONV_FROM_GRP,data:n}).then(function(e){r.end(),A.l("".concat(s," ok"));var n,o,i,e=e.data.updateGroupResult.contactResultItem;return Qe(e)&&(i=!1,e.forEach(function(e){var t;n=a._concatConversationID(e.contactItem),0===e.resultCode?!(o=a._getLocalConversation(n))||-1!==(t=o.conversationGroupList.indexOf(c))&&(o.conversationGroupList.splice(t,1),u.push(n),i=!0):l.push({conversationID:n,code:e.resultCode,message:e.resultInfo})}),!0===i&&(a._emitConversationUpdate(),a._emitConvInGroupUpdate(c))),yn({successConversationIDList:u,failureConversationIDList:l})}).catch(function(e){return r.setError(e).end(),A.e("".concat(s," failed. error:"),e),m(e)})}},{key:"onConvMarkUpdated",value:function(e){var i,a,s=this;We(e)||(A.l("".concat(this._n,".onConvMarkUpdated markItemList:"),e),a=!1,e.forEach(function(e){var t=e.recentContactItem,n=e.optType,o=e.standardMark,e=e.customMark;i=s._concatConversationID(t),(i=s._getLocalConversation(i))&&(1===n?a=s._diffStandardMark(i,o):2===n?a=s._diffCustomMark(i,e):3===n&&(a=s._diffStandardMark(i,o)||s._diffCustomMark(i,e)))}),!0===a&&this._emitConversationUpdate())}},{key:"_diffStandardMark",value:function(e,t){var t=Bt(t),n=!1;return!0!==function(e,t){if(e===t)return!0;if(!e||!t)return!1;if(e.length!==t.length)return!1;for(var n=0,o=e.length;n<o;n++)if(e[n]!==t[n])return!1;return!0}(e.markList,t)&&(e.markList=t,n=!0),n}},{key:"_diffCustomMark",value:function(e,t){var n=!1;return e.customData!==t&&void 0!==t&&(e.customData=t,n=!0),n}},{key:"onConvGroupCreated",value:function(e){var a=this,s=(A.l("".concat(this._n,".onConvGroupCreated resultList:"),e),!1),r=!1;Qe(e)&&(e.forEach(function(e){var t=e.msgGroupItem,n=t.groupID,o=t.groupName;a._convGroupMap.get(n)!==o&&(a._convGroupMap.set(n,o),r=!0);var i,t=e.msgRecentContactItem;Qe(t)&&t.forEach(function(e){i=a._concatConversationID(e),(i=a._getLocalConversation(i))&&-1===i.conversationGroupList.indexOf(o)&&(i.conversationGroupList.push(o),s=!0)})}),!0===s&&this._emitConversationUpdate(),!0===r&&this._emitConvGroupListUpdate())}},{key:"onConvGroupDeleted",value:function(e){var n,o=this,i=(A.l("".concat(this._n,".onConvGroupDeleted groupItemList:"),e),[]);Qe(e)&&(n=!1,e.forEach(function(e){var t=e.groupID,e=e.groupName;o._convGroupMap.has(t)&&(o._convGroupMap.delete(t),n=!0,i.push(e))}),!0===n&&this._emitConvGroupListUpdate()),this._eraseFromConversationGroupList(i)}},{key:"_eraseFromConversationGroupList",value:function(t){We(t)||(this._convM.getLocalConversationList().forEach(function(e){e.conversationGroupList=e.conversationGroupList.filter(function(e){return!t.includes(e)})}),this._emitConversationUpdate())}},{key:"onConvGroupNameUpdated",value:function(e){A.l("".concat(this._n,".onConvGroupNameUpdated options:"),e);var t,n,o,i=e.groupID,a=e.groupName,s=e.oldGroupName;this._convGroupMap.get(i)!==a&&(this._convGroupMap.set(i,a),this._emitConvGroupListUpdate(),e=this._convM.getLocalConversationList(),o=!1,e.forEach(function(e){t=e.conversationGroupList,-1!==(n=t.indexOf(s))&&(t.splice(n,1,a),o=!0)}),!0===o&&this._emitConversationUpdate())}},{key:"onConvInGroupUpdated",value:function(e){var n,o,i,a=this,s=(A.l("".concat(this._n,".onConvInGroupUpdated options:"),e),e.oldGroupName),e=e.recentContactUpdateGroupItem;Qe(e)&&(i=!1,e.forEach(function(e){var t=e.contactOptType,e=e.recentContactItem;n=a._concatConversationID(e),(n=a._getLocalConversation(n))&&(o=n.conversationGroupList.indexOf(s),1===t?-1===o&&(n.conversationGroupList.push(s),i=!0):2===t&&-1!==o&&(n.conversationGroupList.splice(o,1),i=!0))}),!0===i&&(this._emitConversationUpdate(),this._emitConvInGroupUpdate(s)))}},{key:"onConvAddedToOrDeletedFromGroup",value:function(e){var n,o,i=this,t=(A.l("".concat(this._n,".onConvAddedToOrDeletedFromGroup options:"),e),e.msgRecentContactItem),e=e.msgRecentContactUpdateContactItem,t=this._concatConversationID(t),a=this._getLocalConversation(t);a&&Qe(e)&&(o=!1,e.forEach(function(e){var t=e.groupOptType,e=e.recentContactGroupItem.groupName;n=a.conversationGroupList.indexOf(e),1===t?-1===n&&(a.conversationGroupList.push(e),o=!0):2===t&&-1!==n&&(a.conversationGroupList.splice(n,1),o=!0),!0===o&&i._emitConvInGroupUpdate(e)}),!0===o&&this._emitConversationUpdate())}},{key:"onConvGroupListSynced",value:function(e){Qe(e)&&0!==e.length&&(A.l("".concat(this._n,".onConvGroupListSynced groupItem:"),e),this._fillConvGroupMap(e))}},{key:"getConvGroupListByID",value:function(e){var t,n=this;if(!We(e))return t=[],e.forEach(function(e){n._convGroupMap.has(e)&&t.push(n._convGroupMap.get(e))}),t}},{key:"_onConversationNotFound",value:function(e,t){e.push({conversationID:t,code:C.CONV_NOT_FOUND,message:this._convM.getErrorMessage(C.CONV_NOT_FOUND)})}},{key:"_onConversationIDInvalid",value:function(e,t){e.push({conversationID:t,code:C.INVALID_CONV_ID,message:this._convM.getErrorMessage(C.INVALID_CONV_ID)})}},{key:"_getFlagBit",value:function(e){for(var t=e.toString(2),n=t.length,o=n-1;0<=o;o--)if("1"===t[o])return n-o-1}},{key:"_concatConversationID",value:function(e){var t,n=e.type,o=e.to,i=e.groupID,e=e.userID;return 1===n?k(e)?k(o)||(t="".concat(S.CONV_C2C).concat(o)):t="".concat(S.CONV_C2C).concat(e):2===n&&(t="".concat(S.CONV_GROUP).concat(i)),t}},{key:"_getMyUserID",value:function(){return this._convM.getMyUserID()}},{key:"_getLocalConversation",value:function(e){return this._convM.getLocalConversation(e)}},{key:"_hasLocalConversation",value:function(e){return this._convM.hasLocalConversation(e)}},{key:"_emitConversationUpdate",value:function(){this._convM.emitConversationUpdate(!0,!1)}},{key:"_emitConvGroupListUpdate",value:function(){this._convM.emitOuterEvent(G.CONVERSATION_GROUP_LIST_UPDATED,T(this._convGroupMap.values()))}},{key:"_emitConvInGroupUpdate",value:function(t){var e={groupName:t,conversationList:[]},n=this._convM.getLocalConversationList();e.conversationList=n.filter(function(e){return e.conversationGroupList.includes(t)}),this._convM.emitOuterEvent(G.CONVERSATION_IN_GROUP_UPDATED,e)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._convGroupMap.clear(),this._startIndex=0,this._pagingStatus=Sn}}]),ji),ii=(t(Yi,Nn),Yo=f(Yi),e(Yi,[{key:"_initListeners",value:function(){var e=this.getInnerEmitterInstance();e.on(Uo.A2KEY_AND_TINYID_UPDATED,this._init,this),e.on(Uo.PROFILE_UPDATED,this._onProfileUpdated,this)}},{key:"onCheckTimer",value:function(e){e%60==0&&this._messageListHandler.traversal()}},{key:"_init",value:function(){var e=this,t=(A.l("".concat(this._n,"._init")),this.get(13).getItem("conversationMap")),n=this.isIntl(),o=this.isUsingChatCore();if(t){for(var i=t.length,a=0;a<i;a++){var s=t[a];if(s){if(this._isNonExistentAccount(s.conversationID))continue;if(s.groupProfile){var r=s.groupProfile.type;if(Tt(r))continue}}this._conversationMap.set(s.conversationID,new ei(t[a],n,o))}this.emitConversationUpdate(!0,!1)}this.ready(function(){0<e._tmpGroupList.length&&(e.updateConversationGroupProfile(e._tmpGroupList),e._tmpGroupList.length=0)}),this.syncConversationList()}},{key:"_isNonExistentAccount",value:function(e){var t;return"@TLS#ERROR"===(t=e.startsWith(S.CONV_C2C)?e.replace(S.CONV_C2C,""):t)||"@TLS#NOT_FOUND"===t}},{key:"onMessageSent",value:function(e){this._onSendOrReceiveMessage({conversationOptionsList:e.conversationOptionsList,isInstantMessage:!0})}},{key:"onNewMessage",value:function(e){this._onSendOrReceiveMessage(e)}},{key:"_onSendOrReceiveMessage",value:function(e){var t=this,n=e.conversationOptionsList,o=e.isInstantMessage,o=void 0===o||o,i=e.isUnreadC2CMessage,i=void 0!==i&&i,a=e.updateUnreadCount,a=void 0===a||a,s=e.isSyncingEnded,s=void 0!==s&&s;this._isReady?0!==n.length?(!0===o&&this._checkNewConversation(n),this._updateLocalConversationList({conversationOptionsList:n,isInstantMessage:o,isUnreadC2CMessage:i,isFromGetConversations:!1,updateUnreadCount:a}),o||(this._convIDFromUnreadDBMap=new Map([].concat(T(this._convIDFromUnreadDBMap),T(n.map(function(e){return[e.conversationID,1]})))),this._diffAndDeleteConversation(),s&&this.emitInnerEvent(Uo.C2C_UNREAD_HANDLE_COMPLETED)),0<n.filter(function(e){return!t._isConvNeedShow(e.conversationID)}).length||this.emitConversationUpdate()):s&&this.emitInnerEvent(Uo.C2C_UNREAD_HANDLE_COMPLETED):this.ready(function(){t._onSendOrReceiveMessage(e)})}},{key:"updateConversationGroupProfile",value:function(e){var n,o=this;Qe(e)&&0===e.length||(0!==this._conversationMap.size?(n=!1,e.forEach(function(e){var t="GROUP".concat(e.groupID);o._conversationMap.has(t)&&(n=!0,(t=o._conversationMap.get(t)).groupProfile=JSON.parse(JSON.stringify(e)),t.lastMessage.lastSequence<e.nextMessageSeq&&(t.lastMessage.lastSequence=e.nextMessageSeq-1),t.subType||(t.subType=e.type))}),n&&this.emitConversationUpdate(!0,!1)):this._tmpGroupList=e)}},{key:"_updateConversationUserProfile",value:function(e){var n=this;e.data.forEach(function(e){var t="C2C".concat(e.userID);n._conversationMap.has(t)&&(n._conversationMap.get(t).userProfile=e)}),this.emitConversationUpdate(!0,!1)}},{key:"onMessageRevoked",value:function(e){var t,n,o,i=this;0!==e.length&&(t=null,n=!1,o=[],e.forEach(function(e){(t=i._conversationMap.get(e.conversationID))&&(t.reduceUnreadCount()&&(n=t.type!==S.CONV_TOPIC),t.type===S.CONV_TOPIC?o.push(e):t.isLastMessageRevoked({sequence:e.sequence,time:e.time})&&(t.setLastMessageRevoked(!0),t.setLastMessageRevoker(e.revoker),n=!0))}),this.get(10).onMessageRevoked(o),n&&this.emitConversationUpdate(!0,!1))}},{key:"updateRevokerInfo",value:function(u){for(var e=new Set,t=0;t<u.length;t++){var n=u[t].revoker;e.add(n)}var o=T(e),i=this.get(4);return new Promise(function(c){i.getUserProfile({userIDList:o}).then(function(e){e=e.data;if(!Qe(e)||0===e.length)return c(u);var t,n={},o=N(e);try{for(o.s();!(t=o.n()).done;){var i=t.value,a=i.userID,s=i.nick,r=i.avatar;n[a]={nick:s,avatar:r}}}catch(e){o.e(e)}finally{o.f()}u.forEach(function(e){var t=e.revoker;n[t]&&(e.revokerInfo.nick=n[t].nick||"",e.revokerInfo.avatar=n[t].avatar||"")}),c(u)}).catch(function(){c(u)})})}},{key:"isLastMessageRevoked",value:function(e){var t=!1,n=e.conversationID,o=e.sequence,i=e.time,a=this._conversationMap.get(n);return a&&(t=a.type===S.CONV_TOPIC?this.get(10).isLastMessageRevoked({topicID:n.replace(S.CONV_GROUP,""),sequence:o}):a.isLastMessageRevoked({sequence:o,time:i})),A.l("".concat(this._n,".isLastMessageRevoked options:").concat(JSON.stringify(e)," ret:").concat(t)),t}},{key:"onMessageDeleted",value:function(e){var t=this;if(0!==e.length){var n=null;e.forEach(function(e){(n=t._messageListHandler.getLocalMessage(e.conversationID,e.ID))&&(n.isDeleted=!0),e!==n&&(e.isDeleted=!0)});for(var e=e[0].conversationID,o=this._messageListHandler.getLocalMessageList(e),i={},a=o.length-1;0<=a;a--)if(!o[a].isDeleted){i=o[a];break}var s,r=this._conversationMap.get(e);r&&(s=!1,r.lastMessage.lastSequence===i.sequence&&r.lastMessage.lastTime===i.time||(We(i)&&(i=void 0),r.updateLastMessage(i),r.type!==S.CONV_TOPIC&&(s=!0),A.l("".concat(this._n,".onMessageDeleted. update conversationID:").concat(e," with lastMessage:"),r.lastMessage)),e.startsWith(S.CONV_C2C)&&this.updateUnreadCount(e),s&&this.emitConversationUpdate(!0,!1))}}},{key:"onMessageModified",value:function(e){var t="".concat(this._n,".onMessageModified"),n=e.conversationType,o=e.from,i=e.to,l=e.time,d=e.sequence,a=e.elements,p=e.cloudCustomData,s=e.messageVersion,r=this.getMyUserID(),c="".concat(n).concat(i),r=(i===r&&n===S.CONV_C2C&&(c="".concat(n).concat(o)),this._messageListHandler.onMessageModified(c,e)),n=r.isUpdated,r=r.message,u=(!0===n&&this.emitOuterEvent(G.MESSAGE_MODIFIED,[r]),this._isTopicConversation(c));return null===r?A.l("".concat(t," message is null! options:").concat(JSON.stringify(e),"}")):A.l("".concat(t," isUpdated:").concat(n," isTopicMessage:").concat(u," from:").concat(o," to:").concat(i," sequence:").concat(r.sequence," time:").concat(r.time)),u?this.get(10).onMessageModified(e):!(n=this._conversationMap.get(c))||(o=n.lastMessage)&&o.lastTime===l&&o.lastSequence===d&&o.version!==s&&(A.l("".concat(t," conversationID:").concat(c," lastMessage updated")),o.type=a[0].type,o.payload=a[0].content,o.messageForShow=Vt(o.type,o.payload,this.isIntl()),o.cloudCustomData=p,o.version=s,this.emitConversationUpdate(!0,!1)),r}},{key:"onNewGroupAtTips",value:function(e){var t=this,e=e.dataList,n=null;e.forEach(function(e){e.groupAtTips?n=e.groupAtTips:e.elements?n=y(y({},e.elements),{},{sync:!0}):e.groupAtType&&(n=y(y({},e),{},{sync:!0})),n.__random=e.random,n.__sequence=e.clientSequence,t._tmpGroupAtTipsList.push(n)}),A.d("".concat(this._n,".onNewGroupAtTips isReady:").concat(this._isReady),this._tmpGroupAtTipsList),this._isReady&&this._handleGroupAtTipsList()}},{key:"_handleGroupAtTipsList",value:function(){var s,r=this;0!==this._tmpGroupAtTipsList.length&&(s=!1,this._tmpGroupAtTipsList.forEach(function(e){var t,n=e.groupID,o=e.from,i=e.topicID,i=void 0===i?void 0:i,a=e.sync,a=void 0!==a&&a;o!==r.getMyUserID()&&(k(i)?(o=r._conversationMap.get("".concat(S.CONV_GROUP).concat(n)))&&(o.updateGroupAtInfoList(e),s=!0):((n=r._conversationMap.get("".concat(S.CONV_GROUP).concat(i)))&&(n.updateGroupAtInfoList(e),o=r.get(10),t=n.groupAtInfoList,o.onConversationProxy({topicID:i,groupAtInfoList:t})),We(n)&&a&&(r.updateTopicConversation([{conversationID:"".concat(S.CONV_GROUP).concat(i),type:S.CONV_TOPIC}]),r._conversationMap.get("".concat(S.CONV_GROUP).concat(i)).updateGroupAtInfoList(e))))}),s&&this.emitConversationUpdate(!0,!1),this._tmpGroupAtTipsList.length=0)}},{key:"_checkNewConversation",value:function(e){var t=this,n=[],o=[];e.forEach(function(e){t._conversationMap.has(e.conversationID)||(e.type===S.CONV_C2C?n.push(e.conversationID.replace(S.CONV_C2C,"")):e.type===S.CONV_GROUP&&o.push(e.conversationID.replace(S.CONV_GROUP,"")))}),0<n.length&&(this._onNewC2CConversation(n),n=null),0<o.length&&(this._onNewGroupConversation(o),o=null)}},{key:"_onNewC2CConversation",value:function(e){this.get(6).getRemotePeerReadTime(e),this._messageRemindHandler.getC2CMessageRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,1)}},{key:"_onNewGroupConversation",value:function(e){var t=this.get(7);t&&t.getMessageRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,2)}},{key:"_setStorageConversationList",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=this.getLocalConversationList().filter(function(e){return e.type===S.CONV_C2C||e.type===S.CONV_GROUP&&e.lastMessage.type!==S.MSG_GRP_TIP}).slice(0,20).map(function(e){return{conversationID:e.conversationID,type:e.type,subType:e.subType,lastMessage:e.lastMessage,groupProfile:e.groupProfile,userProfile:e.userProfile}});this.get(13).setItem("conversationMap",t,e)}},{key:"emitConversationUpdate",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this.getLocalConversationList();!t||(t=this.get(7))&&t.updateGroupLastMessage(n),e&&(this.get(12).isPartialUpdatedConvs()?(this._diffConvMap(this._convMapForDiff,this._conversationMap),0<this._partialUpdatedConvMap.size&&(this.emitOuterEvent(G.CONVERSATION_LIST_UPDATED),this.emitTotalUnreadMessageCountUpdate(),this._convMapForDiff.clear(),this._convMapForDiff=it(this._conversationMap,!0)),0===this._convMapForDiff.size&&(this._convMapForDiff=it(this._conversationMap,!0))):(this.emitOuterEvent(G.CONVERSATION_LIST_UPDATED),this.emitTotalUnreadMessageCountUpdate()))}},{key:"_diffConvMap",value:function(e,t){var n,o=N(e);try{for(o.s();!(n=o.n()).done;){var i=I(n.value,2),a=i[0],s=i[1];t.has(a)&&s===JSON.stringify(t.get(a))||this._partialUpdatedConvMap.set(a,t.get(a))}}catch(e){o.e(e)}finally{o.f()}}},{key:"getPartialUpdatedConvs",value:function(){var e=T(it(this._partialUpdatedConvMap,!1).values());return this._partialUpdatedConvMap.clear(),e}},{key:"getLocalConversationList",value:function(){var t=this;return T(this._conversationMap.values()).filter(function(e){return t._isConvNeedShow(e.conversationID)})}},{key:"getLocalConversation",value:function(e){return this._conversationMap.get(e)}},{key:"hasLocalConversation",value:function(e){return this._conversationMap.has(e)}},{key:"getLocalOldestMessage",value:function(e){return this._messageListHandler.getLocalOldestMessage(e)}},{key:"syncConversationList",value:function(){var o=this,e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i="syncConversationList",a=new M(i);return this._pagingStatus===Sn&&this._conversationMap.clear(),this._pagingGetConversationList(e).then(function(e){var t=Jt(o._pagingGetCostList),n=jt(o._pagingGetCostList),n=(o._pagingGetCostList.length=0,o._pagingStatus=kn,o._diffAndDeleteConversation(),o.emitConversationUpdate(!0,!1),o._setStorageConversationList(),o._handleC2CPeerReadTime(),o.emitInnerEvent(Uo.CONV_SYNC_COMPLETED),"count:".concat(o._conversationMap.size," sum:").concat(n," avg:").concat(t));return A.l("".concat(o._n,".").concat(i,". ").concat(n)),a.setMessage(n).end(),e}).catch(function(e){return o._pagingStatus=Rn,a.setMessage(o._pagingTimeStamp).setError(e).end(),m(e)})}},{key:"_diffAndDeleteConversation",value:function(){var n,o=this;this._isSyncCompleted()&&(n=[],this._conversationMap.forEach(function(e,t){!o._pagingConvIDMap.has(t)&&o._convIDFromUnreadDBMap.has(t)&&(o._conversationMap.delete(t),n.push(t))}),A.l("".concat(this._n,"._diffAndDeleteConversation list:").concat(n)),n=null)}},{key:"_pagingGetConversationList",value:function(){var r=this,e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],c="".concat(this._n,"._pagingGetConversationList"),u=(A.l("".concat(c," incrementalPullFlag:").concat(e," timeStamp:").concat(this._pagingTimeStamp," startIndex:").concat(this._pagingStartIndex)+" pinnedTimeStamp:".concat(this._pagingPinnedTimeStamp," pinnedStartIndex:").concat(this._pagingPinnedStartIndex)),Date.now());return this._pagingStatus=An,this.req({proto:v.PAGING_GET_CONV_LIST,data:{fromAccount:this.getMyUserID(),timeStamp:e?this._pagingTimeStamp:0,startIndex:e?this._pagingStartIndex:0,pinnedTimeStamp:e?this._pagingPinnedTimeStamp:0,pinnedStartIndex:e?this._pagingPinnedStartIndex:0,orderType:1}}).then(function(e){var e=e.data,t=e.completeFlag,n=e.conversations,n=void 0===n?[]:n,o=e.timeStamp,i=e.startIndex,a=e.pinnedTimeStamp,s=e.pinnedStartIndex,e=e.groupItem;if(r._pagingGetCostList.push(zt(u,!1)),A.l("".concat(c," ok. completeFlag:").concat(t," count:").concat(n.length," cost:").concat(zt(u))),r._convGroupHandler.onConvGroupListSynced(e),0<n.length&&(e=r._getConversationOptions(n),r._pagingConvIDMap=new Map([].concat(T(r._pagingConvIDMap),T(e.map(function(e){return[e.conversationID,1]})))),r._updateLocalConversationList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0}),r.isLoggedIn()&&r.emitConversationUpdate()),!r._isReady){if(!r.isLoggedIn())return Cn();r.triggerReady()}return r._pagingTimeStamp=o,r._pagingStartIndex=i,r._pagingPinnedTimeStamp=a,r._pagingPinnedStartIndex=s,1!==t?r._pagingGetConversationList():(r._handleGroupAtTipsList(),r._convGroupHandler.getRemoteConvGroupList(),Cn())}).catch(function(e){throw r.isLoggedIn()&&(r._isReady||(A.w("".concat(c," failed. error:"),e),r.triggerReady())),e})}},{key:"_updateLocalConversationList",value:function(e){var t=e.isFromGetConversations,n=Date.now(),e=this._getTmpConversationListMapping(e);this._conversationMap=new Map(this._sortConversationList([].concat(T(e.toBeUpdatedConversationList),T(this._conversationMap)))),t||this._updateUserOrGroupProfile(e.newConversationList),A.l("".concat(this._n,"._updateLocalConversationList cost:").concat(zt(n)))}},{key:"_getTmpConversationListMapping",value:function(e){for(var l=e.conversationOptionsList,d=e.isFromGetConversations,p=e.isInstantMessage,_=e.isUnreadC2CMessage,g=void 0!==_&&_,h=e.updateUnreadCount,t=[],f=[],m=this.get(7),v=this.get(8),M=this.isIntl(),I=this.isUsingChatCore(),n=0,y=l.length;n<y;n++){var o,i,a,s,r=new ei(l[n],M,I),c=r.conversationID;this._isNonExistentAccount(c)||(this._conversationMap.has(c)?(o=this._conversationMap.get(c),!(i=["unreadCount","allowType","adminForbidType","payload"])===p&&i.push("lastMessage"),"boolean"==typeof p&&i.push("isPinned"),s=l[n].lastMessage,(a=!k(s))||l[n].type===S.CONV_TOPIC||this._onLastMessageNotExist(l[n]),k(p)&&a&&null===o.lastMessage.payload&&(o.lastMessage.payload=s.payload),We(o.lastMessage.revoker)||(o.lastMessage.revoker=null),ot(o,r,i,[null,void 0,"",0,NaN]),!0===h&&o.updateUnreadCount({nextUnreadCount:r.unreadCount,isFromGetConversations:d,isUnreadC2CMessage:g}),p&&a&&(s.payload&&(o.lastMessage.payload=s.payload),o.type===S.CONV_GROUP&&(o.lastMessage.nameCard=s.nameCard,o.lastMessage.nick=s.nick)),a&&o.lastMessage.cloudCustomData!==s.cloudCustomData&&(o.lastMessage.cloudCustomData=s.cloudCustomData||""),this._conversationMap.delete(c),t.push([c,o])):(r.type===S.CONV_GROUP&&m?(i=r.groupProfile.groupID,(a=m.getLocalGroupProfile(i))&&(r.groupProfile=a,!0===h&&r.updateUnreadCount({nextUnreadCount:0}))):r.type===S.CONV_C2C&&(s=c.replace(S.CONV_C2C,""),v&&v.isMyFriend(s)&&(r.remark=v.getFriendRemark(s))),f.push(r),t.push([c,r])))}for(var C,T,u,D=this.get(10),E=t.length,L=0;L<E;L++)t[L][1].type===S.CONV_TOPIC&&(C=(u=t[L][1]).conversationID,T=u.unreadCount,u=u.groupAtInfoList,D.onConversationProxy({topicID:C.replace(S.CONV_GROUP,""),unreadCount:T,groupAtInfoList:We(u)?void 0:u}));return{toBeUpdatedConversationList:t,newConversationList:f}}},{key:"_onLastMessageNotExist",value:function(e){new M("lastMessageNotExist").setMessage(JSON.stringify(e)).end()}},{key:"_sortConversationList",value:function(e){var t=[],n=[],o=[],i=[];return e.forEach(function(e){(!0===e[1].isPinned?We(e[1].lastMessage.lastTime)?n:t:We(e[1].lastMessage.lastTime)?i:o).push(e)}),t.sort(function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime}).concat(n).concat(o.sort(function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime})).concat(i)}},{key:"_sortConversationListAndEmitEvent",value:function(){this._conversationMap=new Map(this._sortConversationList(T(this._conversationMap))),this.emitConversationUpdate(!0,!1)}},{key:"_updateUserOrGroupProfile",value:function(e){var n,o,t,i,a=this;0!==e.length&&(n=[],o=[],t=this.get(4),i=this.get(7),e.forEach(function(e){var t;e.type===S.CONV_C2C?n.push(e.toAccount):e.type===S.CONV_GROUP&&(t=e.toAccount,i.hasLocalGroup(t)?e.groupProfile=i.getLocalGroupProfile(t):o.push(t))}),A.l("".concat(this._n,"._updateUserOrGroupProfile c2cUserIDList:").concat(n," groupIDList:").concat(o)),0<n.length&&t.getUserProfile({userIDList:n}).then(function(e){e=e.data;Qe(e)?e.forEach(function(e){a._doUpdateUserProfile("C2C".concat(e.userID),e)}):a._doUpdateUserProfile("C2C".concat(e.userID),e)}),0<o.length&&i.getGroupProfileAdvance({groupIDList:o,responseFilter:{groupBaseInfoFilter:["Type","Name","FaceUrl"]}}).then(function(e){var e=e.data.successGroupList,n=!1;e.forEach(function(e){var t="GROUP".concat(e.groupID);a._conversationMap.has(t)&&(t=a._conversationMap.get(t),ot(t.groupProfile,e,[],[null,void 0,"",0,NaN]),!t.subType&&e.type&&(t.subType=e.type),n=!0)}),n&&a.emitConversationUpdate()}))}},{key:"_doUpdateUserProfile",value:function(e,t){this.hasLocalConversation(e)&&(this.getLocalConversation(e).userProfile=t,this.emitConversationUpdate())}},{key:"_getConversationOptions",value:function(e){var n=this,o=[],e=e.filter(function(e){var t=e.type,e=e.userID;return 1===t&&!n._isNonExistentAccount(e)||2===t}),i=this.getMyUserID(),e=e.map(function(e){var t;return k(e.lastMsg)&&(e.lastMsg={elements:[]}),1===e.type?(t={userID:e.userID,nick:e.peerNick,avatar:e.peerAvatar},o.push(t),{conversationID:"C2C".concat(e.userID),type:"C2C",lastMessage:{lastTime:e.time,lastSequence:e.sequence,fromAccount:e.lastC2CMsgFromAccount,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:null,payload:e.lastMsg.elements[0]?n._amendLayersOverLimitProperty(e.lastMsg.elements[0].content):null,cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:8===e.lastMessageFlag,onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:e.lastC2CMsgFromAccount===i&&e.time<=e.c2cPeerReadTime,revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null},userProfile:new zo(t),peerReadTime:e.c2cPeerReadTime,isPinned:1===e.isPinned,customData:e.customMark||"",markList:Bt(e.standardMark),conversationGroupList:n._convGroupHandler.getConvGroupListByID(e.contactGroupId),remark:e.friendRemark||"",messageRemindType:n._transMessageRemindType(e.messageRemindType)}):{conversationID:"GROUP".concat(e.groupID),type:"GROUP",lastMessage:y(y({lastTime:e.time,lastSequence:e.sequence,fromAccount:e.msgGroupFromAccount},n._patchTypeAndPayload(e)),{},{cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:2===e.lastMessageFlag,onlineOnlyFlag:!1,nick:e.senderNick||"",nameCard:e.senderNameCard||"",revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null}),groupProfile:new $o({groupID:e.groupID,name:e.groupNick,avatar:e.groupImage,type:e.groupType,nextMessageSeq:e.nextMessageSeq}),unreadCount:n._computeGroupUnreadCount(e),peerReadTime:0,isPinned:1===e.isPinned,version:0,customData:e.customMark||"",markList:Bt(e.standardMark),conversationGroupList:n._convGroupHandler.getConvGroupListByID(e.contactGroupId),messageRemindType:n._transMessageRemindType(e.messageRemindType)}});return 0<o.length&&this.get(4).onConversationsProfileUpdated(o),e}},{key:"_transMessageRemindType",value:function(e){var t="";return 0===e?t=S.MSG_REMIND_ACPT_AND_NOTE:1===e?t=S.MSG_REMIND_DISCARD:2===e?t=S.MSG_REMIND_ACPT_NOT_NOTE:3===e&&(t=S.RECEIVE_WITH_OFFLINE_PUSH_EXCEPT_AT),t}},{key:"_computeGroupUnreadCount",value:function(e){var t=e.unreadCount,e=e.noUnreadCount,t=(void 0===t?0:t)-(void 0===e?0:e);return 0<t?t:0}},{key:"_patchTypeAndPayload",value:function(e){var e=e.lastMsg,t=e.event,n=e.elements,n=void 0===n?[]:n,e=e.groupTips,e=void 0===e?{}:e;return k(void 0===t?void 0:t)||We(e)?{type:n[0]?n[0].type:null,payload:n[0]?this._amendLayersOverLimitProperty(n[0].content):null}:((t=new go(e)).setElement({type:S.MSG_GRP_TIP,content:y(y({},e.elements),{},{groupProfile:e.groupProfile})}),n=JSON.parse(JSON.stringify(t.payload)),t=null,{type:S.MSG_GRP_TIP,payload:n})}},{key:"_amendLayersOverLimitProperty",value:function(e){var t=e.layersOverLimit;return 0===t?e.layersOverLimit=!1:1===t&&(e.layersOverLimit=!0),e}},{key:"getLocalMessageList",value:function(e){return this._messageListHandler.getLocalMessageList(e)}},{key:"deleteLocalMessage",value:function(e){e instanceof go&&this._messageListHandler.remove(e)}},{key:"onConversationDeleted",value:function(e){Qe(e)&&(e=e.map(function(e){var t=e.type,n=e.userID,e=e.groupID;return 1===t?"".concat(S.CONV_C2C).concat(n):2===t?"".concat(S.CONV_GROUP).concat(e):void 0}),A.l("".concat(this._n,".onConversationDeleted conversationIDList:").concat(e)),this.deleteLocalConversationList(e))}},{key:"onConversationPinned",value:function(e){var i,a=this;Qe(e)&&(i=!1,e.forEach(function(e){var t,n=e.type,o=e.userID,e=e.groupID;1===n?t=a.getLocalConversation("".concat(S.CONV_C2C).concat(o)):2===n&&(t=a.getLocalConversation("".concat(S.CONV_GROUP).concat(e))),t&&(A.l("".concat(a._n,".onConversationPinned conversationID:").concat(t.conversationID," isPinned:").concat(t.isPinned)),t.isPinned||(t.isPinned=!0,i=!0))}),i&&this._sortConversationListAndEmitEvent())}},{key:"onConversationUnpinned",value:function(e){var i,a=this;Qe(e)&&(i=!1,e.forEach(function(e){var t,n=e.type,o=e.userID,e=e.groupID;1===n?t=a.getLocalConversation("".concat(S.CONV_C2C).concat(o)):2===n&&(t=a.getLocalConversation("".concat(S.CONV_GROUP).concat(e))),t&&(A.l("".concat(a._n,".onConversationUnpinned conversationID:").concat(t.conversationID," isPinned:").concat(t.isPinned)),t.isPinned&&(t.isPinned=!1,i=!0))}),i&&this._sortConversationListAndEmitEvent())}},{key:"getMessageList",value:function(e){var a=this,s=e.conversationID,t=e.nextReqMessageID,e=e.count,r="".concat(this._n,".getMessageList"),n=this.getLocalConversation(s),o="";if(n&&n.groupProfile&&(o=n.groupProfile.type),Tt(o))return A.l("".concat(r," not available in avchatroom. conversationID:").concat(s)),Cn({messageList:[],nextReqMessageID:"",isCompleted:!0});(k(e)||15<e)&&(e=15),!t&&this._isNotInCommunity(s)&&(this._messageListHandler.removeByConversationID(s),this._completedMap.delete(s),this._roamingMessageSequenceMap.delete(s));var c=this._computeRemainingCount({conversationID:s,nextReqMessageID:t}),n=this._completedMap.has(s);if(A.l("".concat(r," conversationID:").concat(s," nextReqMessageID:").concat(t)+" remainingCount:".concat(c," count:").concat(e," isCompleted:").concat(n)),this._needGetHistory({conversationID:s,remainingCount:c,count:e}))return this.getHistoryMessages({conversationID:s,nextReqMessageID:t,count:20}).then(function(e){var t=e.nextReqID,e=e.storedMessageList,n=a._completedMap.has(s),o=e,i={nextReqMessageID:n?"":t,messageList:o=0<c?a._messageListHandler.getLocalMessageList(s).slice(0,e.length+c):o,isCompleted:n},t=i.messageList.filter(function(e){return e.isRevoked})||[],e=o.map(function(e){return e.sequence});return A.l("".concat(r," ret.nextReqMessageID:").concat(i.nextReqMessageID," ret.isCompleted:").concat(i.isCompleted," ret.length:").concat(o.length," sequenceList:"),e),Qe(t)&&0!==t.length?a.updateRevokerInfo(t).then(function(e){return e.forEach(function(t){var n=t.revokerInfo;i.messageList=i.messageList.map(function(e){return e.ID===t.ID&&n&&(e.revokeReason=n.reason||"",e.revokerInfo={userID:n.revoker||e.revoker,nick:n.nick,avatar:n.avatar}),e})}),yn(i)}):yn(i)});this.modifyMessageList(s);o=this._getMessageListFromMemory({conversationID:s,nextReqMessageID:t,count:e});return Cn(o)}},{key:"_getMessageListFromMemory",value:function(e){var t=e.conversationID,n=e.nextReqMessageID,e=e.count,o="".concat(this._n,"._getMessageListFromMemory"),i=this._messageListHandler.getLocalMessageList(t),a=i.length,s=0,r={isCompleted:!1,nextReqMessageID:"",messageList:[]};return n?(s=i.findIndex(function(e){return e.ID===n}))>e?(r.messageList=i.slice(s-e,s),r.nextReqMessageID=i[s-e].ID):(r.messageList=i.slice(0,s),r.isCompleted=!0):e<a?(r.messageList=i.slice(s=a-e,a),r.nextReqMessageID=i[s].ID):(r.messageList=i.slice(0,a),r.isCompleted=!0),A.l("".concat(o," conversationID:").concat(t)+" ret.nextReqMessageID:".concat(r.nextReqMessageID," ret.isCompleted:").concat(r.isCompleted," ret.length:").concat(r.messageList.length)),r}},{key:"getMessageListHopping",value:function(e){var t,n,o=e.conversationID,i=e.sequence,a=e.time,s=e.count,e=e.direction,e=void 0===e?0:e;return(k(s)||15<s)&&(s=15),o.startsWith(S.CONV_C2C)?(t=this.get(6),n=o.replace(S.CONV_C2C,""),t.getRoamingMessagesHopping({peerAccount:n,time:a,count:s,direction:e})):o.startsWith(S.CONV_GROUP)?(t=this.get(7),n=o.replace(S.CONV_GROUP,""),t.getRoamingMessagesHopping({groupID:n,sequence:i,count:s,direction:e})):void 0}},{key:"_computeRemainingCount",value:function(e){var t=e.conversationID,n=e.nextReqMessageID,e=this._messageListHandler.getLocalMessageList(t),o=e.length;if(A.l("".concat(this._n,"._computeRemainingCount conversationID:").concat(t," nextReqMessageID:").concat(n," length:").concat(o)),!n)return o;o=0;return Lt(t)?o=e.findIndex(function(e){return e.ID===n}):St(t)&&(o=-1!==n.indexOf("-")?e.findIndex(function(e){return e.ID===n}):e.findIndex(function(e){return e.sequence===n})),o=-1===o?0:o}},{key:"_getMessageListSize",value:function(e){return this._messageListHandler.getLocalMessageList(e).length}},{key:"_needGetHistory",value:function(e){var t=e.conversationID,n=e.remainingCount,e=e.count,o=this.getLocalConversation(t),i="";if(o&&o.groupProfile&&(i=o.groupProfile.type),At(t)||Tt(i))return!1;o=!1,i="".concat(this._n,"._needGetHistory conversationID:").concat(t);if(St(t)){var a=this._isPagingGetGroupListCompleted(),s=this._getLocalGroupCount(),r=this._hasLocalGroup(t),c=this._isTopicConversation(t);if(A.l("".concat(i," isGroupListCompleted:").concat(a," localGroupCount:").concat(s)+" isGroupInList:".concat(r," isTopic:").concat(c)),a&&s<=500&&!r&&!c)return o}return o=n<=e&&!this._completedMap.has(t),A.l("".concat(i," ret:").concat(o)),o}},{key:"_isTopicConversation",value:function(e){e=e.replace(S.CONV_GROUP,"");return Et(e)}},{key:"getHistoryMessages",value:function(e){var t=e.conversationID,e=e.count;if(t===S.CONV_SYSTEM)return Cn();var n=15,e=(20<e&&(n=20),null);if(Lt(t))return o=this._roamingMessageKeyAndTimeMap.has(t),(e=this.get(6))?e.getRoamingMessage({conversationID:t,peerAccount:t.replace(S.CONV_C2C,""),count:n,lastMessageTime:o?this._roamingMessageKeyAndTimeMap.get(t).lastMessageTime:0,messageKey:o?this._roamingMessageKeyAndTimeMap.get(t).messageKey:""}):m({code:C.CANNOT_FIND_MODULE});if(St(t)){if(!(e=this.get(7)))return m({code:C.CANNOT_FIND_MODULE});var o=t.replace(S.CONV_GROUP,""),i=null,a=0,i=((i=this._conversationMap.has(t)&&!Et(o)?this._conversationMap.get(t).lastMessage:i)&&(a=i.lastSequence),this._roamingMessageSequenceMap.get(t));return e.getRoamingMessage({conversationID:t,groupID:o,count:n,sequence:i||a})}return Cn()}},{key:"patchConversationLastMessage",value:function(e){var t,n,o=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=this.getLocalConversation(e);i&&(t=(n=i.lastMessage).messageForShow,n=n.payload,!(We(t)||We(n)||o)||0!==(t=this._messageListHandler.getLocalMessageList(e)).length&&(n=t[t.length-1],A.l("".concat(this._n,".patchConversationLastMessage bForceUpdate:").concat(o," conversationID:").concat(e," payload:"),n.payload),i.updateLastMessage(n)))}},{key:"onRoamingMessage",value:function(){for(var e,t,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],u=1<arguments.length?arguments[1]:void 0,l=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],o=u.startsWith(S.CONV_C2C)?S.CONV_C2C:S.CONV_GROUP,i=null,a=[],s=[],r=0,d=n.length,c=o===S.CONV_GROUP,p=this.getFileDownloadProxy(),_=function(){c?--r:++r},g=function(){return c?d<=r:r<d},r=c?n.length-1:0,d=c?0:n.length;g();_())c&&1===n[r].sequence&&l&&this.setCompleted(u),1!==n[r].isPlaceMessage&&((i=new go(n[r])).to=n[r].to,o!==S.CONV_GROUP||k(n[r].topicID)||(i.to=n[r].topicID),i.isSystemMessage=!!n[r].isSystemMessage,i.conversationType=o,e=4===n[r].event?{type:S.MSG_GRP_TIP,content:y(y({},n[r].elements),{},{groupProfile:n[r].groupProfile})}:n[r].elements,c||i.setNickAndAvatar({nick:n[r].nick,avatar:n[r].avatar}),We(e)?((t=new M("emptyMessageBody")).setMessage("from:".concat(i.from," to:").concat(i.to," sequence:").concat(i.sequence," event:").concat(n[r].event)),t.setLevel("warning").end()):(i.setElement(e,p),i.reInitialize(this.getMyUserID()),a.push(i)));return _=g=null,l?(this._messageListHandler.unshift(a,s),a=null,s):(s=null,a)}},{key:"findMessage",value:function(e){return this._messageListHandler.findMessage(e)}},{key:"_isNotInCommunity",value:function(e){var t=!1;return e.startsWith(S.CONV_GROUP)&&this._isTopicConversation(e)&&(e=xt(e.replace(S.CONV_GROUP,"")),this.get(7).hasLocalGroup(e)||(t=!0)),t}},{key:"deleteTopicRoamingMessageInfo",value:function(e){var t=this;Dt({groupID:e})&&this._messageListHandler.getTopicConversationIDList(e).forEach(function(e){t._completedMap.delete(e),t._roamingMessageSequenceMap.delete(e)})}},{key:"deleteGroupRoamingMessageInfo",value:function(e){e="".concat(S.CONV_GROUP).concat(e);this._completedMap.delete(e),this._roamingMessageSequenceMap.delete(e)}},{key:"setMessageRead",value:function(e){var t=e.conversationID,n=this.getLocalConversation(t),e="".concat(this._n,".setMessageRead");if(A.l("".concat(e," conversationID:").concat(t," unreadCount:").concat(n?n.unreadCount:0)),!n)return Cn();if(n.type!==S.CONV_GROUP&&n.type!==S.CONV_TOPIC||We(n.groupAtInfoList)||this.deleteGroupAtTips(t),0===n.unreadCount)return Cn();var o=this._messageListHandler.getLocalLastMessage(t),i=n.lastMessage.lastTime,a=this._messageListHandler.getLocalMaxTime(t),a=(i<a&&(A.l("".concat(e," update lastMessageTime from ").concat(i," to ").concat(a)),i=a),this._messageListHandler.getLocalMaxSequence(t)),s=n.lastMessage.lastSequence,r=(s<a&&(A.l("".concat(e," update lastMessageSeq from ").concat(s," to ").concat(a)),s=a),n.type===S.CONV_TOPIC&&k(o)&&(e=this.get(10),o=xt(a=t.replace(S.CONV_GROUP,"")),(e=e.getLocalTopic(o,a))&&(s=e.nextMessageSeq-1)),null);switch(n.type){case S.CONV_C2C:return(r=this.get(6))?r.setMessageRead({conversationID:t,lastMessageTime:i}):m({code:C.CANNOT_FIND_MODULE});case S.CONV_GROUP:case S.CONV_TOPIC:return(r=this.get(7))?r.setMessageRead({conversationID:t,lastMessageSeq:s}):m({code:C.CANNOT_FIND_MODULE});case S.CONV_SYSTEM:return n.unreadCount=0,this.emitConversationUpdate(!0,!1),Cn();default:return Cn()}}},{key:"setAllMessageRead",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e="setAllMessageRead",o="".concat(this._n,".").concat(e),i=(n.scope||(n.scope=S.READ_ALL_MSG),A.l("".concat(o," options:"),n),this._createSetAllMessageReadPack(n));if(0===i.readAllC2CMessage&&0===i.groupMessageReadInfoList.length)return Cn();var a=new M(e);return this.req({proto:v.SET_ALL_MSG_READ,data:i}).then(function(e){e=e.data,e=t._handleAllMessageRead(e);return a.setMessage("scope:".concat(n.scope," failureGroups:").concat(JSON.stringify(e))).end(),Cn()}).catch(function(e){return a.setError(e).end(),A.w("".concat(o," failed. error:"),e),m({code:e&&e.code?e.code:C.MSG_UNREAD_ALL_FAIL,message:e&&e.message?e.message:void 0})})}},{key:"setConversationCustomData",value:function(e){return this._convGroupHandler.setConvCustomData(e)}},{key:"markConversation",value:function(e){return this._convGroupHandler.markConversation(e)}},{key:"getConversationGroupList",value:function(){return this._convGroupHandler.getLocalConvGroupList()}},{key:"createConversationGroup",value:function(e){return this._convGroupHandler.createConvGroup(e)}},{key:"deleteConversationGroup",value:function(e){return this._convGroupHandler.deleteConvGroup(e)}},{key:"renameConversationGroup",value:function(e){return this._convGroupHandler.renameConvGroup(e)}},{key:"addConversationsToGroup",value:function(e){return this._convGroupHandler.addConvsToGroup(e)}},{key:"deleteConversationsFromGroup",value:function(e){return this._convGroupHandler.deleteConvsFromGroup(e)}},{key:"onConversationMarkUpdated",value:function(e){this._convGroupHandler.onConvMarkUpdated(e)}},{key:"onConversationGroupCreated",value:function(e){this._convGroupHandler.onConvGroupCreated(e)}},{key:"onConversationGroupDeleted",value:function(e){this._convGroupHandler.onConvGroupDeleted(e)}},{key:"onConversationGroupNameUpdated",value:function(e){this._convGroupHandler.onConvGroupNameUpdated(e)}},{key:"onConversationInGroupUpdated",value:function(e){this._convGroupHandler.onConvInGroupUpdated(e)}},{key:"onConversationAddedToOrDeletedFromGroup",value:function(e){this._convGroupHandler.onConvAddedToOrDeletedFromGroup(e)}},{key:"_getConversationLastMessageSequence",value:function(e){var t=this._messageListHandler.getLocalLastMessage(e.conversationID),e=e.lastMessage.lastSequence;return e=t&&e<t.sequence?t.sequence:e}},{key:"_getConversationLastMessageTime",value:function(e){var t=this._messageListHandler.getLocalLastMessage(e.conversationID),e=e.lastMessage.lastTime;return e=t&&e<t.time?t.time:e}},{key:"_createSetAllMessageReadPack",value:function(e){var t,n={readAllC2CMessage:0,groupMessageReadInfoList:[]},o=e.scope,i=N(this._conversationMap);try{for(i.s();!(t=i.n()).done;){var a,s=I(t.value,2)[1];if(0<s.unreadCount)if(s.type===S.CONV_C2C&&0===n.readAllC2CMessage){if(o===S.READ_ALL_MSG)n.readAllC2CMessage=1;else if(o===S.READ_ALL_C2C_MSG){n.readAllC2CMessage=1;break}}else s.type!==S.CONV_GROUP||o!==S.READ_ALL_GROUP_MSG&&o!==S.READ_ALL_MSG||(a=this._getConversationLastMessageSequence(s),n.groupMessageReadInfoList.push({groupID:s.groupProfile.groupID,messageSequence:a}))}}catch(e){i.e(e)}finally{i.f()}return n}},{key:"onPushedAllMessageRead",value:function(e){this._handleAllMessageRead(e)}},{key:"_handleAllMessageRead",value:function(e){var t=e.groupMessageReadInfoList,e=e.readAllC2CMessage,t=this._parseGroupReadInfo(t);return 1<=this._updateAllConversationUnreadCount({readAllC2CMessage:e})&&this.emitConversationUpdate(!0,!1),t}},{key:"_parseGroupReadInfo",value:function(e){var t=[];if(e&&e.length)for(var n=0,o=e.length;n<o;n++){var i=e[n],a=i.groupID,s=i.sequence,r=i.retCode,i=i.lastMessageSeq;k(r)?this._remoteGroupReadSequenceMap.set(a,i):(this._remoteGroupReadSequenceMap.set(a,s),0!==r&&t.push("".concat(a,"-").concat(s,"-").concat(r)))}return t}},{key:"_updateAllConversationUnreadCount",value:function(l){var e,d=l.readAllC2CMessage,t=0,n=N(this._conversationMap);try{for(n.s();!(e=n.n()).done;){var o,i,a,s,r=I(e.value,2),c=r[0],u=r[1];1<=u.unreadCount&&(1===d&&u.type===S.CONV_C2C?(o=this._getConversationLastMessageTime(u),this.updateIsReadAfterReadReport({conversationID:c,lastMessageTime:o})):u.type===S.CONV_GROUP&&(i=c.replace(S.CONV_GROUP,""),this._remoteGroupReadSequenceMap.has(i)&&(a=this._remoteGroupReadSequenceMap.get(i),s=this._getConversationLastMessageSequence(u),this.updateIsReadAfterReadReport({conversationID:c,remoteReadSequence:a}),a<=s&&this._remoteGroupReadSequenceMap.delete(i))),this.updateUnreadCount(c,!1)&&(t+=1))}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"isRemoteRead",value:function(e){var t,n=e.conversationID,e=e.sequence,o=n.replace(S.CONV_GROUP,""),i=!1;return this._remoteGroupReadSequenceMap.has(o)&&(e<=(t=this._remoteGroupReadSequenceMap.get(o))&&(i=!0,A.l("".concat(this._n,".isRemoteRead conversationID:").concat(n," messageSequence:").concat(e," remoteReadSequence:").concat(t))),t+10<=e&&this._remoteGroupReadSequenceMap.delete(o)),i}},{key:"updateIsReadAfterReadReport",value:function(e){var t=e.conversationID,n=e.lastMessageSeq,o=e.lastMessageTime,i=this._messageListHandler.getLocalMessageList(t);if(0!==i.length)for(var a,s=i.length-1;0<=s;s--)if(a=i[s],!(o&&a.time>o||n&&a.sequence>n)){if("in"===a.flow&&a.isRead)break;a.setIsRead(!0)}}},{key:"updateUnreadCount",value:function(e){var t,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],o=!1,i=this.getLocalConversation(e),a=this._messageListHandler.getLocalMessageList(e);if(i)return(t=i.unreadCount)!==(a=a.filter(function(e){return!e.isRead&&!e._onlineOnlyFlag&&!e.isDeleted}).length)&&(i.unreadCount=a,o=!0,A.l("".concat(this._n,".updateUnreadCount from ").concat(t," to ").concat(a,", conversationID:").concat(e)),!0===n&&this.emitConversationUpdate(!0,!1)),o&&i.type===S.CONV_TOPIC&&(t=i.unreadCount,a=this.get(10),n=e.replace(S.CONV_GROUP,""),a.onConversationProxy({topicID:n,unreadCount:t})),o}},{key:"clearGroupAtInfoList",value:function(e){var t,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],o=this.getLocalConversation(e);o&&0<o.groupAtInfoList.length&&(o.clearGroupAtInfoList(),A.l("".concat(this._n,".clearGroupAtInfoList conversationID:").concat(e)),o.type===S.CONV_TOPIC&&(o=o.groupAtInfoList,t=this.get(10),e=e.replace(S.CONV_GROUP,""),t.onConversationProxy({topicID:e,groupAtInfoList:o})),!0===n&&this.emitConversationUpdate(!0,!1))}},{key:"updateReadReceiptInfo",value:function(e){var a,s,o,r=this,t=e.userID,i=void 0===t?void 0:t,t=e.groupID,c=void 0===t?void 0:t,t=e.readReceiptList;We(t)||(a=[],k(i)?k(c)||(s="".concat(S.CONV_GROUP).concat(c),t.forEach(function(e){var t=e.tinyID,n=e.clientTime,o=e.random,i=e.readCount,e=e.unreadCount,t="".concat(t,"-").concat(n,"-").concat(o),n=r._messageListHandler.getLocalMessage(s,t)||r._messageListHandler.getHoppingMessage(s,t),o={groupID:c,messageID:t,readCount:0,unreadCount:0};n&&(ze(i)&&(n.readReceiptInfo.readCount=i,o.readCount=i),ze(e)&&(n.readReceiptInfo.unreadCount=e,o.unreadCount=e),a.push(o))})):(o="".concat(S.CONV_C2C).concat(i),t.forEach(function(e){var t=e.tinyID,n=e.clientTime,e=e.random,t="".concat(t,"-").concat(n,"-").concat(e),n=r._messageListHandler.getLocalMessage(o,t)||r._messageListHandler.getHoppingMessage(o,t);n&&!n.readReceiptInfo.isPeerRead&&(n.readReceiptInfo.isPeerRead=!0,a.push({userID:i,messageID:t,isPeerRead:!0}))})),0<a.length&&this.emitOuterEvent(G.MESSAGE_READ_RECEIPT_RECEIVED,a))}},{key:"updateIsRead",value:function(e){var t=this.getLocalConversation(e),n=this.getLocalMessageList(e);if(t&&0!==n.length&&!At(t.type)){for(var o=[],i=0,a=n.length;i<a;i++)"in"!==n[i].flow?"out"!==n[i].flow||n[i].isRead||n[i].setIsRead(!0):o.push(n[i]);var s=0;s=t.type===S.CONV_C2C?(e=o.slice(-t.unreadCount).filter(function(e){return e.isRevoked}).length,o.length-t.unreadCount-e):o.length-t.unreadCount;for(var r=0;r<s&&!o[r].isRead;r++)o[r].setIsRead(!0)}}},{key:"deleteGroupAtTips",value:function(e){var t=this,n="".concat(this._n,".deleteGroupAtTips"),o=(A.l("".concat(n)),this._conversationMap.get(e));if(!o)return Promise.resolve();var i=o.groupAtInfoList;if(0===i.length)return Promise.resolve();var o=void 0,a=(e.startsWith(S.CONV_GROUP)&&(o=e.replace(S.CONV_GROUP,"")),T(i));if((Dt({groupID:o})||Et(o))&&0===(a=i.filter(function(e){return!e.atTypeArray.includes(S.CONV_AT_ALL)})).length)return this.clearGroupAtInfoList(e,!1),Promise.resolve();var s=this.getMyUserID();return this.req({proto:v.DEL_GROUP_AT_TIPS,data:{messageListToDelete:a.map(function(e){return{from:e.from,to:s,messageSeq:e.__sequence,messageRandom:e.__random,groupID:k(e.topicID)?e.groupID:e.topicID}})}}).then(function(){return A.l("".concat(n," ok. count:").concat(i.length)),t.clearGroupAtInfoList(e,!1),Promise.resolve()}).catch(function(e){return A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"appendToMessageList",value:function(e){return this._messageListHandler.pushIn(e)}},{key:"setMessageRandom",value:function(e){this.singlyLinkedList.set(e.random)}},{key:"deleteMessageRandom",value:function(e){this.singlyLinkedList.delete(e.random)}},{key:"pushIntoMessageList",value:function(e,t,n){return!(!this._messageListHandler.pushIn(t,n)||this._isMessageFromCurrentInstance(t)&&!n||(e.push(t),0))}},{key:"_isMessageFromCurrentInstance",value:function(e){return this.singlyLinkedList.has(e.random)}},{key:"revoke",value:function(e,t,n){return this._messageListHandler.revoke(e,t,n)}},{key:"getPeerReadTime",value:function(e){return this._peerReadTimeMap.get(e)}},{key:"recordPeerReadTime",value:function(e,t){(!this._peerReadTimeMap.has(e)||this._peerReadTimeMap.get(e)<t)&&this._peerReadTimeMap.set(e,t)}},{key:"updateMessageIsPeerReadProperty",value:function(e,t){var n;e.startsWith(S.CONV_C2C)&&0<t&&(0<(n=this._messageListHandler.updateMessageIsPeerReadProperty(e,t)).length&&this.emitOuterEvent(G.MESSAGE_READ_BY_PEER,n),this._conversationMap.has(e)&&(We(n=this._conversationMap.get(e).lastMessage)||n.fromAccount===this.getMyUserID()&&n.lastTime<=t&&!n.isPeerRead&&(n.isPeerRead=!0,this.emitConversationUpdate(!0,!1))))}},{key:"updateMessageIsModifiedProperty",value:function(e){this._messageListHandler.updateMessageIsModifiedProperty(e)}},{key:"setCompleted",value:function(e){A.l("".concat(this._n,".setCompleted. conversationID:").concat(e)),this._completedMap.set(e,!0)}},{key:"updateRoamingMessageKeyAndTime",value:function(e,t,n){this._roamingMessageKeyAndTimeMap.set(e,{messageKey:t,lastMessageTime:n})}},{key:"updateRoamingMessageSequence",value:function(e,t){this._roamingMessageSequenceMap.set(e,t)}},{key:"getConversationList",value:function(t){var n,o=this,i="".concat(this._n,".").concat("getConversationList"),e="pagingStatus:".concat(this._pagingStatus,", local conversation count:").concat(this._conversationMap.size,", options:").concat(JSON.stringify(t));if(A.l("".concat(i,". ").concat(e)),this._pagingStatus===Rn)return(n=new M("getConversationList")).setMessage(e),this.syncConversationList().then(function(){n.end();var e=o._getConversationList(t);return yn({conversationList:e,isSyncCompleted:o._isSyncCompleted()})}).catch(function(e){return n.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)});e=this._getConversationList(t);return A.l("".concat(i,". returned conversation count:").concat(e.length)),Cn({conversationList:e,isSyncCompleted:this._isSyncCompleted()})}},{key:"_getConversationList",value:function(t){var n,o,i,a,s,r=this;return k(t)?this.getLocalConversationList():Qe(t)?0===t.length?[]:this.getLocalConversationList().filter(function(e){return t.includes(e.conversationID)}):Ze(t)?(n=t.type,o=t.markType,i=t.groupName,a=t.hasUnreadCount,s=t.hasGroupAtInfo,this.getLocalConversationList().filter(function(e){return r._filterType(e,n)&&r._filterMarkType(e,o)&&r._filterGroupName(e,i)&&r._filterUnreadCount(e,a)&&r._filterGroupAtInfo(e,s)})):[]}},{key:"_filterType",value:function(e,t){return t!==S.CONV_C2C&&t!==S.CONV_GROUP||e.type===t}},{key:"_filterGroupName",value:function(e,t){return!pt(t)||(""===t?0===e.conversationGroupList.length:e.conversationGroupList.includes(t))}},{key:"_filterMarkType",value:function(e,t){return!ze(t)||(0===t?0===e.markList.length:e.markList.includes(t))}},{key:"_filterUnreadCount",value:function(e,t){var n=!0;return!0===t?n=1<=e.unreadCount:!1===t&&(n=0===e.unreadCount),n}},{key:"_filterGroupAtInfo",value:function(e,t){var n=!0;return!0===t?n=1<=e.groupAtInfoList.length:!1===t&&(n=0===e.groupAtInfoList.length),n}},{key:"_handleC2CPeerReadTime",value:function(){var e,t=N(this._conversationMap);try{for(t.s();!(e=t.n()).done;){var n=I(e.value,2),o=n[0],i=n[1];i.type===S.CONV_C2C&&(A.d("".concat(this._n,"._handleC2CPeerReadTime conversationID:").concat(o," peerReadTime:").concat(i.peerReadTime)),this.recordPeerReadTime(o,i.peerReadTime))}}catch(e){t.e(e)}finally{t.f()}}},{key:"_isPagingGetGroupListCompleted",value:function(){var e=this.get(7);return!e||e.isPagingGetCompleted()}},{key:"_getLocalGroupCount",value:function(){var e=this.get(7);return e?e.getLocalGroupList().length:0}},{key:"_hasLocalGroup",value:function(e){var t=this.get(7);return!!t&&t.hasLocalGroup(e.replace(S.CONV_GROUP,""))}},{key:"getConversationProfile",value:function(o){var i,a=this;if((i=this._conversationMap.has(o)?this._conversationMap.get(o):new ei({conversationID:o,type:o.slice(0,3)===S.CONV_C2C?S.CONV_C2C:S.CONV_GROUP},this.isIntl(),this.isUsingChatCore()))._isInfoCompleted||i.type===S.CONV_SYSTEM)return Cn({conversation:i});if(St(o)&&!this._hasLocalGroup(o))return Cn({conversation:i});var s="".concat(this._n,".").concat("getConversationProfile"),r=new M("getConversationProfile");return A.l("".concat(s,". conversationID:").concat(o," remark:").concat(i.remark," lastMessage:"),i.lastMessage),this._updateUserOrGroupProfileCompletely(i).then(function(e){r.setMessage("conversationID:".concat(o," unreadCount:").concat(e.data.conversation.unreadCount)).end();var t,n=a.get(8);return n&&i.type===S.CONV_C2C&&(t=o.replace(S.CONV_C2C,""),n.isMyFriend(t)&&(n=n.getFriendRemark(t),i.remark!==n&&(i.remark=n,A.l("".concat(s,". conversationID:").concat(o," patch remark:").concat(i.remark))))),A.l("".concat(s," ok. conversationID:").concat(o)),e}).catch(function(e){return r.setError(e).setMessage("conversationID:".concat(o)).end(),A.e("".concat(s," failed. error:"),e),m(e)})}},{key:"_updateUserOrGroupProfileCompletely",value:function(t){var n=this;return t.type===S.CONV_C2C?this.get(4).getUserProfile({userIDList:[t.toAccount]}).then(function(e){e=e.data;return 0===e.length?m(new bn({code:C.USER_OR_GRP_NOT_FOUND})):(t.userProfile=e[0],t._isInfoCompleted=!0,n._unshiftConversation(t),Cn({conversation:t}))}):this.get(7).getGroupProfile({groupID:t.toAccount}).then(function(e){return t.groupProfile=e.data.group,t._isInfoCompleted=!0,n._unshiftConversation(t),Cn({conversation:t})})}},{key:"_unshiftConversation",value:function(e){e instanceof ei&&!this._conversationMap.has(e.conversationID)&&(this._conversationMap=new Map([[e.conversationID,e]].concat(T(this._conversationMap))),this._setStorageConversationList(),this.emitConversationUpdate(!0,!1))}},{key:"_onProfileUpdated",value:function(e){var n=this;e.data.forEach(function(e){var t=e.userID;t===n.getMyUserID()?n._onMyProfileModified({latestNick:e.nick,latestAvatar:e.avatar}):(t=n._conversationMap.get("".concat(S.CONV_C2C).concat(t)))&&(t.userProfile=e)})}},{key:"_isSyncCompleted",value:function(){return this._pagingStatus===kn}},{key:"_errorLog",value:function(e,t,n,o){var i=new Error("Params validate failed."),a="".concat(this.getErrorMessage("API_REFER")).concat(e);throw A.w("[".concat(e,"] | ").concat(t," | ").concat(this.getErrorMessage(n,o),", ").concat(a)),A.e("[".concat(e,"] Invalid ").concat(t,": type check failed for ").concat(t,".")),i}},{key:"_isValidConversationID",value:function(e){return Lt(e)||St(e)||At(e)}},{key:"deleteConversation",value:function(e){var t=this,n="deleteConversation";return pt(e)||Xe(e)||this._errorLog(n,"options","StringOrObjectRequiredLog"),pt(e)?(this._isValidConversationID(e)||this._errorLog(n,"options","InvalidConversationID",e),A.l("".concat(this._n,".").concat(n," conversationID:").concat(e)),this.deleteConversationList({conversationIDList:[e],flag:1})):(Qe(e.conversationIDList)||this._errorLog(n,"conversationIDList","ArrayRequiredLog"),0===e.conversationIDList.length&&this._errorLog(n,"conversationIDList","NonEmptyArrayLog"),e.conversationIDList.forEach(function(e){t._isValidConversationID(e)||t._errorLog(n,"conversationIDList","InvalidConversationID",e)}),"clearHistoryMessage"in e&&"boolean"!=typeof e.clearHistoryMessage&&this._errorLog(n,"clearHistoryMessage","BooleanRequiredLog"),100<e.conversationIDList.length&&(e.conversationIDList=e.conversationIDList.slice(0,100)),this.deleteConversationList(e))}},{key:"deleteConversationList",value:function(e){var t=e.conversationIDList,t=void 0===t?[]:t,n=e.clearHistoryMessage,n=void 0===n||n,e=e.flag,o=void 0===e?0:e,i="".concat(this._n,".").concat("deleteConversationList"),a=(A.l("".concat(i," conversationIDList.length:").concat(t.length," clearHistoryMessage:").concat(n)),new M("deleteConversationList"));return a.setMessage("conversationIDList:".concat(t)),Promise.all([this.rmLocalOnlyConversationList(t),this.rmLocalAndRemoteConversationList(t,n)]).then(function(e){a.end();e=[].concat(T(e[0]),T(e[1]));return 0===e.length?m(new bn({code:C.CONV_NOT_FOUND})):(A.l("".concat(i," ok")),Cn(1===o?{conversationID:e[0]}:{conversationIDList:e}))}).catch(function(e){return a.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"rmLocalOnlyConversationList",value:function(e){var n=this;return e.filter(function(e){if(!n._conversationMap.has(e))return!1;var t=n.getLocalConversation(e).type;return t!==S.CONV_GROUP||n._hasLocalGroup(e)?t===S.CONV_SYSTEM&&(n.get(7).deleteGroupSystemNotice({messageList:n._messageListHandler.getLocalMessageList(e)}),n.deleteLocalConversation(e),!0):(n.deleteLocalConversation(e),!0)})}},{key:"rmLocalAndRemoteConversationList",value:function(e,t){var n=this,o={fromAccount:this.getMyUserID(),conversationList:[],clearHistoryMessage:t?1:0};return e.forEach(function(e){var t;n._conversationMap.has(e)&&((t=n.getLocalConversation(e).type)===S.CONV_C2C?o.conversationList.push({toAccount:e.replace(t,""),type:1}):t===S.CONV_GROUP&&n._hasLocalGroup(e)&&o.conversationList.push({toGroupID:e.replace(t,""),type:2}))}),0===o.conversationList.length?[]:this.req({proto:v.DEL_CONV,data:o}).then(function(e){var t=[];return 0<e.data.resultList.length&&e.data.resultList.map(function(e){0===e.code&&(e=1===e.type?"".concat(S.CONV_C2C).concat(e.to):"".concat(S.CONV_GROUP).concat(e.groupID),t.push(e))}),n.deleteLocalConversationList(t),t})}},{key:"setConversationDraft",value:function(e){var t=e.conversationID,e=e.draftText,n="".concat(this._n,".").concat("setConversationDraft");if(A.l("".concat(n," conversationID:").concat(t," draftText:").concat(e)),!this._conversationMap.has(t))return m({code:C.CONV_NOT_FOUND});n=this._conversationMap.get(t);return n.setDraftText(e),Cn({code:0,conversation:n})}},{key:"clearHistoryMessage",value:function(t){var n=this,e={fromAccount:this.getMyUserID(),toAccount:void 0,type:void 0,toGroupID:void 0};if(!this._conversationMap.has(t))return m({code:C.CONV_NOT_FOUND});var o=this._conversationMap.get(t).type;if(o===S.CONV_C2C)e.type=1,e.toAccount=t.replace(S.CONV_C2C,"");else{if(o!==S.CONV_GROUP)return o===S.CONV_SYSTEM?(this.get(7).deleteGroupSystemNotice({messageList:this._messageListHandler.getLocalMessageList(t)}),Cn({conversationID:t})):m({code:C.CONV_UN_RECORDED_TYPE});e.type=2,e.toGroupID=t.replace(S.CONV_GROUP,"")}var i="".concat(this._n,".").concat("clearHistoryMessage"),a=new M("clearHistoryMessage");return a.setMessage("conversationID:".concat(t)),A.l("".concat(i,". conversationID:").concat(t)),this.setMessageRead({conversationID:t}).then(function(){return n.req({proto:v.CLEAR_HISTORY_MSG,data:e})}).then(function(){a.end(),A.l("".concat(i," ok")),n._messageListHandler.removeByConversationID(t),n.setCompleted(t);var e=n.getLocalConversation(t);return e&&(e.updateLastMessage(),n._sortConversationListAndEmitEvent()),Cn({conversationID:t})}).catch(function(e){return a.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"pinConversation",value:function(e){var t=this,n=e.conversationID,o=e.isPinned;if(!this._conversationMap.has(n))return m({code:C.CONV_NOT_FOUND});var i=this.getLocalConversation(n);if(i.isPinned===o)return Cn({conversationID:n});var a="".concat(this._n,".").concat("pinConversation"),s=new M("pinConversation"),e=(s.setMessage("conversationID:".concat(n," isPinned:").concat(o)),A.l("".concat(a,". conversationID:").concat(n," isPinned:").concat(o)),null);return Lt(n)?e={type:1,toAccount:n.replace(S.CONV_C2C,"")}:St(n)&&(e={type:2,groupID:n.replace(S.CONV_GROUP,"")}),this.req({proto:v.PIN_CONV,data:{fromAccount:this.getMyUserID(),operationType:!0===o?1:2,itemList:[e]}}).then(function(){return s.end(),A.l("".concat(a," ok")),i.isPinned!==o&&(i.isPinned=o,t._sortConversationListAndEmitEvent()),yn({conversationID:n})}).catch(function(e){return s.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e)})}},{key:"setMessageRemindType",value:function(e){return this._messageRemindHandler.set(e)}},{key:"patchMessageRemindType",value:function(e){var t=e.ID,n=e.isC2CConversation,o=e.messageRemindType,i=!1,n=this.getLocalConversation("".concat(n?S.CONV_C2C:S.CONV_GROUP).concat(t));return n&&n.messageRemindType!==o&&(n.messageRemindType=o,i=!0),A.d("".concat(this._n,".patchMessageRemindType options:"),e,"ret:".concat(i)),i}},{key:"onC2CMessageRemindTypeFetched",value:function(e){var n,o=this;Qe(e)&&0<e.length&&(n=0,e.forEach(function(e){var t=e.userID,e=e.muteFlag,e=o._transMessageRemindType(e);!0===o.patchMessageRemindType({ID:t,isC2CConversation:!0,messageRemindType:e})&&(n+=1)}),A.l("".concat(this._n,".onC2CMessageRemindTypeFetched updateCount:").concat(n)),1<=n&&this.emitConversationUpdate(!0,!1))}},{key:"onC2CMessageRemindTypeSynced",value:function(e){var n=this,o="".concat(this._n,".onC2CMessageRemindTypeSynced");A.d(o,e),e.dataList.forEach(function(e){var t;We(e.muteNotificationsSync)||(t=(e=e.muteNotificationsSync).to,e=e.muteFlag,e=n._transMessageRemindType(e),n.patchMessageRemindType({ID:t,isC2CConversation:!(t=0),messageRemindType:e})&&(t+=1),A.l("".concat(o," updateCount:").concat(t)),1<=t&&n.emitConversationUpdate(!0,!1))})}},{key:"onGroupMessageRemindTypeUpdated",value:function(e){A.d("".concat(this._n,".onGroupMessageRemindTypeUpdated options:"),e),this._messageRemindHandler.onGroupMessageRemindTypeUpdated(e)}},{key:"deleteLocalConversation",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this._conversationMap.has(e);A.l("".concat(this._n,".deleteLocalConversation conversationID:").concat(e," has:").concat(n)),n&&(this._conversationMap.delete(e),this._roamingMessageKeyAndTimeMap.has(e)&&this._roamingMessageKeyAndTimeMap.delete(e),this._roamingMessageSequenceMap.has(e)&&this._roamingMessageSequenceMap.delete(e),this._setStorageConversationList(),this._messageListHandler.removeByConversationID(e),this._completedMap.delete(e),t)&&(n=!this._isTopicConversation(e),this.emitConversationUpdate(n,!1))}},{key:"recoverMessageOnInviteGroup",value:function(e){var t,n,o,i,a=this.get(7);a&&(i=this.getLocalLastMessage(e),t=this.getLocalSecondLastMessage(e),o=n=1,i&&(n=i.sequence),t&&(o=t.sequence),i=a.getGroupRemoteLastSeq(e.replace(S.CONV_GROUP,"")),A.l("".concat(this._n,".recoverMessageOnInviteGroup conversationID:").concat(e," localLastSeq:").concat(n," localSecondLastSeq:").concat(o)+" remoteLastSeq:".concat(i)),this._roamingMessageSequenceMap.has(e)&&this._roamingMessageSequenceMap.delete(e),this._messageListHandler.removeByConversationID(e),this._completedMap.delete(e),1<n-o?this._recursiveGetMessageList([],e,!1,n,o):1<i-n&&this._recursiveGetMessageList([],e,!0,i,n))}},{key:"_recursiveGetMessageList",value:function(n,o,i,a,s,e){var r=this;this.getMessageList({conversationID:o,nextReqMessageID:e}).then(function(e){var e=e.data.messageList,t=e.filter(function(e){return i?e.sequence>s&&e.sequence<=a:e.sequence>s&&e.sequence<a});n.unshift.apply(n,T(t)),0<e.length&&e[0].sequence>s&&n.length<100?r._recursiveGetMessageList(n,o,i,a,s,e[0].ID):r._emitMessageReceived(o,n)})}},{key:"_emitMessageReceived",value:function(e,t){var n,o=this;0<t.length&&(n=this.hasLocalConversation(e),A.l("".concat(this._n,"._emitMessageReceived conversationID:").concat(e," has:").concat(n," sequenceList:"),t.map(function(e){return e.sequence})),this.emitOuterEvent(G.MESSAGE_RECEIVED,t),n?this.patchConversationLastMessage(e,!0):this.getConversationProfile(e).then(function(){o.patchConversationLastMessage(e,!0)}))}},{key:"deleteLocalConversationList",value:function(e){var t=this,n=!1;e.forEach(function(e){t._conversationMap.has(e)&&(t.deleteLocalConversation(e,!1),n=!0)}),A.l("".concat(this._n,".deleteLocalConversationList conversationIDList.length:").concat(e.length," isConvIDExisted:").concat(n)),n&&this.emitConversationUpdate(!0,!1)}},{key:"isMessageSentByCurrentInstance",value:function(e){return!(!this._messageListHandler.hasLocalMessage(e.conversationID,e.ID)&&!this.singlyLinkedList.has(e.random))}},{key:"modifyMessageList",value:function(e){var t,n;e.startsWith(S.CONV_C2C)&&this._conversationMap.has(e)&&(n=this._conversationMap.get(e),t=Date.now(),this._messageListHandler.modifyMessageSentByPeer({conversationID:e,latestNick:n.userProfile.nick,latestAvatar:n.userProfile.avatar}),n=this.get(4).getNickAndAvatarByUserID(this.getMyUserID()),this._messageListHandler.modifyMessageSentByMe({conversationID:e,latestNick:n.nick,latestAvatar:n.avatar}),A.l("".concat(this._n,".modifyMessageList conversationID:").concat(e," cost:").concat(zt(t))))}},{key:"updateUserProfileSpecifiedKey",value:function(e){A.l("".concat(this._n,".updateUserProfileSpecifiedKey options:"),e);var t=e.conversationID,n=e.nick,e=e.avatar;this._conversationMap.has(t)&&(t=this._conversationMap.get(t).userProfile,pt(n)&&t.nick!==n&&(t.nick=n),pt(e)&&t.avatar!==e&&(t.avatar=e),this.emitConversationUpdate(!0,!1))}},{key:"_onMyProfileModified",value:function(t){var n=this,e=this.getLocalConversationList(),o=Date.now();e.forEach(function(e){n.modifyMessageSentByMe(y({conversationID:e.conversationID},t))}),A.l("".concat(this._n,"._onMyProfileModified. modify all messages sent by me, cost:").concat(zt(o)))}},{key:"modifyMessageSentByMe",value:function(e){this._messageListHandler.modifyMessageSentByMe(e)}},{key:"getLatestMessageSentByMe",value:function(e){return this._messageListHandler.getLatestMessageSentByMe(e)}},{key:"modifyMessageSentByPeer",value:function(e){this._messageListHandler.modifyMessageSentByPeer(e)}},{key:"getLatestMessageSentByPeer",value:function(e){return this._messageListHandler.getLatestMessageSentByPeer(e)}},{key:"pushIntoNoticeResult",value:function(e,t){return!(!this._messageListHandler.pushIn(t)||this.singlyLinkedList.has(t.random)||(e.push(t),0))}},{key:"getLocalLastMessage",value:function(e){return this._messageListHandler.getLocalLastMessage(e)}},{key:"getLocalSecondLastMessage",value:function(e){return this._messageListHandler.getLocalSecondLastMessage(e)}},{key:"checkAndPatchRemark",value:function(){var e,n,o=this.get(8);0===this._conversationMap.size||!o||0!==(e=T(this._conversationMap.values()).filter(function(e){return e.type===S.CONV_C2C})).length&&(n=0,e.forEach(function(e){var t=e.conversationID.replace(S.CONV_C2C,"");o.isMyFriend(t)&&(t=o.getFriendRemark(t),e.remark!==t&&(e.remark=t,n+=1))}),A.l("".concat(this._n,".checkAndPatchRemark. c2c conversation count:").concat(e.length,", patched count:").concat(n)))}},{key:"updateTopicConversation",value:function(e){this._updateLocalConversationList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0})}},{key:"sendReadReceipt",value:function(e){var t=e[0],n=null;return t.conversationType===S.CONV_C2C?n=this._m.get(6):t.conversationType===S.CONV_GROUP&&(n=this._m.get(7)),n?n.sendReadReceipt(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getReadReceiptList",value:function(e){var t=e[0],n=null;return t.conversationType===S.CONV_C2C?n=this._m.get(6):t.conversationType===S.CONV_GROUP&&(n=this._m.get(7)),n?n.getReadReceiptList(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getLastMessageTime",value:function(e){e=this.getLocalConversation(e);return e?e.lastMessage.lastTime:0}},{key:"getTotalUnreadMessageCount",value:function(){var e=this.getLocalConversationList(),t=0;return e.forEach(function(e){e.type!==S.CONV_SYSTEM&&(""!==e.messageRemindType&&e.messageRemindType!==S.MSG_REMIND_ACPT_AND_NOTE||(t+=e.unreadCount))}),t}},{key:"emitTotalUnreadMessageCountUpdate",value:function(){var e=this.getTotalUnreadMessageCount();this._convTotalUnreadCount!==e&&(A.l("".concat(this._n,".emitTotalUnreadMessageCountUpdate from ").concat(this._convTotalUnreadCount," to ").concat(e)),this._convTotalUnreadCount=e,this.emitOuterEvent(G.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED))}},{key:"_isConvNeedShow",value:function(e){e=this.getLocalConversation(e);if(k(e))return!0;var t=e.type===S.CONV_TOPIC,n=e.type===S.CONV_GROUP&&e.groupProfile.type===S.GRP_ROOM,e=e.type===S.CONV_GROUP&&e.groupProfile.type===S.GRP_LIVE;return!(t||n||e)}},{key:"setAllReceiveMessageOpt",value:function(e){return this._messageRemindHandler.setAllReceiveMessageOpt(e)}},{key:"getAllReceiveMessageOpt",value:function(){return this._messageRemindHandler.getAllReceiveMessageOpt()}},{key:"onAllReceiveMessageOptNotify",value:function(e){this._messageRemindHandler.onAllReceiveMessageOptNotify(e)}},{key:"clearUnreadCount",value:function(e){e=this.getLocalConversation(e);e&&0<e.unreadCount&&(e.unreadCount=0,this.emitConversationUpdate(!0,!1))}},{key:"storeHoppingMessageList",value:function(e){this._messageListHandler.storeHoppingMessageList(e)}},{key:"getHoppingMessage",value:function(e,t){return this._messageListHandler.getHoppingMessage(e,t)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._setStorageConversationList(!0),this._pagingStatus=Sn,this._messageListHandler.reset(),this._messageRemindHandler.reset(),this._roamingMessageKeyAndTimeMap.clear(),this._roamingMessageSequenceMap.clear(),this.singlyLinkedList.reset(),this._peerReadTimeMap.clear(),this._completedMap.clear(),this._conversationMap.clear(),this._pagingTimeStamp=0,this._pagingStartIndex=0,this._pagingPinnedTimeStamp=0,this._pagingPinnedStartIndex=0,this._remoteGroupReadSequenceMap.clear(),this._convTotalUnreadCount=0,this._pagingGetCostList.length=0,this._pagingConvIDMap.clear(),this._convIDFromUnreadDBMap.clear(),this._pagingGetCostList.length=0,this._convMapForDiff.clear(),this._partialUpdatedConvMap.clear(),this.resetReady()}}]),Yi),ai=(e(Wi,[{key:"onCheckTimer",value:function(e){e%1==0&&0<this._cachedGroupTipsMap.size&&this._checkCachedGroupTips()}},{key:"_checkCachedGroupTips",value:function(){var i=this;this._cachedGroupTipsMap.forEach(function(e,t){var n=i._checkCountMap.get(t),o=i._grpM.hasLocalGroup(t);A.l("".concat(i._n,"._checkCachedGroupTips groupID:").concat(t," hasLocalGroup:").concat(o," checkCount:").concat(n)),o?(i._notifyCachedGroupTips(t),i._checkCountMap.delete(t),i._grpM.deleteUnjoinedAVChatRoom(t)):n>=i.MAX_CHECK_COUNT?(i._deleteCachedGroupTips(t),i._checkCountMap.delete(t)):i._checkCountMap.set(t,++n)})}},{key:"onNewGroupTips",value:function(e){A.l("".concat(this._n,".onNewGroupTips options:").concat(JSON.stringify(e.dataList)));var e=this.newGroupTipsStoredAndSummary(e),t=e.eventDataList,n=e.result,e=e.AVChatRoomMessageList;0<e.length&&this._grpM.onAVChatRoomMessage(e),0<t.length&&(this._grpM.updateNextMessageSeq(t),this._grpM.get(11).onNewMessage({conversationOptionsList:t,isInstantMessage:!0})),0<n.length&&(this._grpM.emitOuterEvent(G.MESSAGE_RECEIVED,n),this.handleMessageList(n))}},{key:"newGroupTipsStoredAndSummary",value:function(l){for(var e=l.event,d=l.dataList,t=null,n=[],p=[],_={},g=[],h=0,f=d.length;h<f;h++){var o=lt(d[h]);if(6===e){if(this._grpM.isGroupAttributesUpdatedNotice(o))continue;if(this._grpM.isGroupCountersNotice(o))continue}var i=o.groupProfile,a=i.groupID,s=i.communityType,s=void 0===s?0:s,r=i.topicID,r=void 0===r?void 0:r,i=i.invisible,m=void 0,c=this._grpM.isMessageFromTopic(s,r),u=(c&&(m=S.CONV_TOPIC,o.to=r),this._grpM.hasLocalGroup(a));if(u||!this._grpM.isUnjoinedAVChatRoom(a))if(u||c)if(this._grpM.isMessageFromOrToAVChatroom(a))o.event=e,g.push(o);else if(o.currentUser=this._grpM.getMyUserID(),o.conversationType=S.CONV_GROUP,(t=new go(o)).setElement({type:S.MSG_GRP_TIP,content:y(y({},o.elements),{},{groupProfile:o.groupProfile})}),t.isSystemMessage=!1,1!==i){var u=this._grpM.get(11),c=t,i=c.conversationID,c=c.sequence;if(6===e)t._onlineOnlyFlag=!0,p.push(t);else if(!u.pushIntoNoticeResult(p,t))continue;this._grpM.isMessageFromCommunityOfTopic(s,r)||6===e&&u.getLocalConversation(i)||(6!==e&&this._qualityStat(t),s=u.isRemoteRead({conversationID:i,sequence:c}),k(_[i])?(r=0,"in"===t.flow&&(t._isExcludedFromUnreadCount||t._onlineOnlyFlag||s||(r=1)),_[i]=n.push({conversationID:i,unreadCount:r,type:k(m)?t.conversationType:m,subType:t.conversationSubType,lastMessage:t._isExcludedFromLastMessage?"":t})-1):(n[u=_[i]].type=t.conversationType,n[u].subType=t.conversationSubType,n[u].lastMessage=t._isExcludedFromLastMessage?"":t,"in"===t.flow&&(t._isExcludedFromUnreadCount||t._onlineOnlyFlag||s||n[u].unreadCount++)))}else this._qualityStat(t);else this._cacheGroupTipsAndProbe({groupID:a,event:e,item:o})}return{eventDataList:n,result:p,AVChatRoomMessageList:g}}},{key:"_qualityStat",value:function(e){this._grpM.get(26).addMessageSequence({key:Wn,message:e})}},{key:"handleMessageList",value:function(e){var t=this;e.forEach(function(e){switch(e.payload.operationType){case 1:t._onNewMemberComeIn(e);break;case 2:t._onMemberQuit(e);break;case 3:t._onMemberKickedOut(e);break;case 4:t._onMemberSetAdmin(e);break;case 5:t._onMemberCancelledAdmin(e);break;case 6:t._onGroupProfileModified(e);break;case 7:t._onMemberInfoModified(e);break;case 8:t._onTopicProfileUpdated(e);break;default:A.w("".concat(t._n,".handleMessageList unknown operationType:").concat(e.payload.operationType))}})}},{key:"_onNewMemberComeIn",value:function(e){var e=e.payload,t=e.memberNum,e=e.groupProfile.groupID,e=this._grpM.getLocalGroupProfile(e);e&&ze(t)&&e.memberCount!==t&&(e.memberCount=t,this._updateConversationGroupProfile(e))}},{key:"_onMemberQuit",value:function(e){var t=e.payload,n=t.memberNum,t=t.groupProfile.groupID,o=this._grpM.getLocalGroupProfile(t);o&&ze(n)&&o.memberCount!==n&&(o.memberCount=n,this._updateConversationGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(t,e.payload.userIDList)}},{key:"_onMemberKickedOut",value:function(e){var t=e.payload,n=t.memberNum,t=t.groupProfile.groupID,o=this._grpM.getLocalGroupProfile(t);o&&ze(n)&&o.memberCount!==n&&(o.memberCount=n,this._updateConversationGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(t,e.payload.userIDList)}},{key:"_updateConversationGroupProfile",value:function(e){this._grpM.get(11).updateConversationGroupProfile([e])}},{key:"_onMemberSetAdmin",value:function(e){var t=e.payload.groupProfile.groupID,e=e.payload.userIDList,n=this._grpM.getGroupMemberHandler();e.forEach(function(e){e=n.getLocalGroupMemberInfo(t,e);e&&e.updateRole(S.GRP_MBR_ROLE_ADMIN)})}},{key:"_onMemberCancelledAdmin",value:function(e){var t=e.payload.groupProfile.groupID,e=e.payload.userIDList,n=this._grpM.getGroupMemberHandler();e.forEach(function(e){e=n.getLocalGroupMemberInfo(t,e);e&&e.updateRole(S.GRP_MBR_ROLE_MEMBER)})}},{key:"_onGroupProfileModified",value:function(e){var t=this,e=e.payload,n=e.newGroupProfile,e=e.groupProfile.groupID,o=this._grpM.getLocalGroupProfile(e),e=(Object.keys(n).forEach(function(e){switch(e){case"ownerID":t._ownerChanged(o,n);break;case"groupName":o.name=n[e];break;default:o[e]=n[e]}}),!o.isSupportTopic);this._grpM.emitGroupListUpdate(!0,e)}},{key:"_ownerChanged",value:function(e,t){var e=e.groupID,n=this._grpM.getLocalGroupProfile(e),o=this._grpM.getMyUserID();o===t.ownerID&&(n.updateGroup({selfInfo:{role:S.GRP_MBR_ROLE_OWNER}}),n=(t=this._grpM.getGroupMemberHandler()).getLocalGroupMemberInfo(e,o),o=this._grpM.getLocalGroupProfile(e).ownerID,t=t.getLocalGroupMemberInfo(e,o),n&&n.updateRole(S.GRP_MBR_ROLE_OWNER),t&&t.updateRole(S.GRP_MBR_ROLE_MEMBER))}},{key:"_onMemberInfoModified",value:function(e){var t=e.to,n=e.payload,o=n.groupProfile,n=n.memberList,i=o.groupID,a=(Et(t)&&this._updateTopicMuteTime(e),this._grpM.getGroupMemberHandler());n.forEach(function(e){var t=a.getLocalGroupMemberInfo(i,e.userID);t&&ze(e.muteTime)&&t.updateMuteUntil(e.muteTime)})}},{key:"_updateTopicMuteTime",value:function(e){var t=e.to,e=e.payload,n=e.groupProfile,e=e.memberList,o=void 0===e?[]:e,e=this._grpM.get(10),n=n.groupID,i=e.getLocalTopic(n,t);if(i){for(var a=!1,s=0;s<o.length;s++){var r=o[s];if(r.userID===this._grpM.getMyUserID()&&0<=r.muteTime){i.updateSelfInfo({muteTime:r.muteTime}),a=!0;break}}a&&this._grpM.emitOuterEvent(G.TOPIC_UPDATED,{groupID:n,topic:i})}}},{key:"_onTopicProfileUpdated",value:function(e){var t=e.payload,n=t.groupProfile.groupID,t=t.newTopicInfo;this._grpM.get(10).onTopicProfileUpdated(y({groupID:n,topicID:e.to},t))}},{key:"_cacheGroupTips",value:function(e,t){this._cachedGroupTipsMap.has(e)||this._cachedGroupTipsMap.set(e,[]),this._cachedGroupTipsMap.get(e).push(t)}},{key:"_deleteCachedGroupTips",value:function(e){this._cachedGroupTipsMap.has(e)&&this._cachedGroupTipsMap.delete(e)}},{key:"_notifyCachedGroupTips",value:function(e){var t=this,n=this._cachedGroupTipsMap.get(e)||[];n.forEach(function(e){t.onNewGroupTips(e)}),this._deleteCachedGroupTips(e),A.l("".concat(this._n,"._notifyCachedGroupTips groupID:").concat(e," count:").concat(n.length))}},{key:"_cacheGroupTipsAndProbe",value:function(e){var t=this,n=e.groupID,o=e.event,e=e.item;this._cacheGroupTips(n,{event:o,dataList:[e]}),this._grpM.getGroupSimplifiedInfo(n).then(function(e){e.type===S.GRP_AVCHATROOM?t._grpM.hasLocalGroup(n)?t._notifyCachedGroupTips(n):t._grpM.setUnjoinedAVChatRoom(n):(t._grpM.updateGroupMap([e]),t._notifyCachedGroupTips(n))}),this._checkCountMap.has(n)||this._checkCountMap.set(n,0),A.l("".concat(this._n,"._cacheGroupTipsAndProbe groupID:").concat(n))}},{key:"reset",value:function(){this._cachedGroupTipsMap.clear(),this._checkCountMap.clear()}}]),Wi),si=(e(Ki,[{key:"onCheckTimer",value:function(e){e%1==0&&0<this._cachedGroupMessageMap.size&&this._checkCachedGroupMessage()}},{key:"_checkCachedGroupMessage",value:function(){var i=this;this._cachedGroupMessageMap.forEach(function(e,t){var n=i._checkCountMap.get(t),o=i._grpM.hasLocalGroup(t);A.l("".concat(i._n,"._checkCachedGroupMessage groupID:").concat(t," hasLocalGroup:").concat(o," checkCount:").concat(n)),o?(i._notifyCachedGroupMessage(t),i._checkCountMap.delete(t),i._grpM.deleteUnjoinedAVChatRoom(t)):n>=i.MAX_CHECK_COUNT?(i._deleteCachedGroupMessage(t),i._checkCountMap.delete(t)):i._checkCountMap.set(t,++n)})}},{key:"handleUpdateGroupLastMessage",value:function(e){var t="".concat(this._n,".handleUpdateGroupLastMessage");if(0!==this._grpM.getGroupMap().size){for(var n,o,i,a,s=!1,r=0,c=e.length;r<c;r++)(n=e[r]).type===S.CONV_GROUP&&0!==n.lastMessage.lastSequence&&null!==n.lastMessage.payload&&(o=n.conversationID.split(/^GROUP/)[1],(o=this._grpM.getLocalGroupProfile(o))&&(i=o.lastMessage,a=n.lastMessage,JSON.stringify(i)!==JSON.stringify(a)&&(o.lastMessage=y({},n.lastMessage),s=!0)));A.l("".concat(t," conversation count:").concat(e.length,", local group count:").concat(this._grpM.getLocalGroupList().length," isGroupListUpdated:").concat(s)),s&&(this._grpM.sortLocalGroupList(),this._grpM.emitGroupListUpdate(!0,!1))}else this.tempConversationList=e}},{key:"onNewGroupMessage",value:function(e){A.d("".concat(this._n,".onNewGroupMessage count:").concat(e.dataList.length));var t=this._newGroupMessageStoredAndSummary(e),n=t.conversationOptionsList,o=t.messageList,t=t.AVChatRoomMessageList,t=(0<t.length&&this._grpM.onAVChatRoomMessage(t),yt(o)),t=(0<t.length&&this._grpM.emitOuterEvent(G.MESSAGE_MODIFIED,t),0<n.length&&(this._grpM.updateNextMessageSeq(n),this._grpM.get(11).onNewMessage({conversationOptionsList:n,isInstantMessage:e.isInstantMessage||!0,updateUnreadCount:e.updateUnreadCount||!0})),Ct(o));0<t.length&&this._grpM.emitOuterEvent(G.MESSAGE_RECEIVED,t),o.length=0}},{key:"_newGroupMessageStoredAndSummary",value:function(l){var d=l.dataList,p=l.event,_=l.isInstantMessage,e=null,t=[],g=[],h=[],f={},m=this._grpM.getFileDownloadProxy(),v=d.length;1<v&&d.sort(function(e,t){return e.sequence-t.sequence});for(var n=this._grpM.get(11),M=this._grpM.get(4),I=0;I<v;I++){var o,i=lt(d[I]),a=i.groupProfile,y=a.groupID,s=a.communityType,s=void 0===s?0:s,r=a.topicID,r=void 0===r?void 0:r,a=a.invisible,C=void 0,c=this._grpM.isMessageFromTopic(s,r),u=(c&&(C=S.CONV_TOPIC,i.to=r),this._grpM.hasLocalGroup(y));!u&&this._grpM.isUnjoinedAVChatRoom(y)||(u||c?this._grpM.isMessageFromOrToAVChatroom(y)?(i.event=p,h.push(i)):(i.currentUser=this._grpM.getMyUserID(),i.conversationType=S.CONV_GROUP,i.isSystemMessage=!!i.isSystemMessage,(e=new go(i)).setElement(i.elements,m),1!==a?(u=1===d[I].isModified,n.isMessageSentByCurrentInstance(e)?e.isModified=u:u=!1,1===i.onlineOnlyFlag?(e._onlineOnlyFlag=!0,n.isMessageSentByCurrentInstance(e)||g.push(e)):this._grpM.isMessageFromCommunityOfTopic(s,r)?g.push(e):(e.from!==this._grpM.getMyUserID()||(c=n.getLatestMessageSentByMe(e.conversationID))&&(a=c.nick,s=c.avatar,a===e.nick&&s===e.avatar||(n.modifyMessageSentByMe({conversationID:o,latestNick:e.nick,latestAvatar:e.avatar}),M.mockOnNickAvatarModified(e.nick,e.avatar))),n.pushIntoMessageList(g,e,u)&&(this._qualityStat(_,e),o=(r=e).conversationID,c=r.sequence,a=n.isRemoteRead({conversationID:o,sequence:c}),k(f[o])?(s=0,"in"===e.flow&&(e._isExcludedFromUnreadCount||a||(s=1)),f[o]=t.push({conversationID:o,unreadCount:s,type:k(C)?e.conversationType:C,subType:e.conversationSubType,lastMessage:e._isExcludedFromLastMessage?"":e})-1):(t[u=f[o]].type=k(C)?e.conversationType:C,t[u].subType=e.conversationSubType,t[u].lastMessage=e._isExcludedFromLastMessage?"":e,"in"===e.flow&&(e._isExcludedFromUnreadCount||a||t[u].unreadCount++))))):this._qualityStat(_,e)):this._cacheGroupMessageAndProbe({groupID:y,event:p,item:i}))}return{conversationOptionsList:t,messageList:g,AVChatRoomMessageList:h}}},{key:"_qualityStat",value:function(e,t){var n=this._grpM.get(26);n.addMessageSequence({key:Wn,message:t}),e&&0<t.clientTime&&n.addMessageDelay(t.clientTime)}},{key:"onGroupMessageRevoked",value:function(e){var t=this,u=this._grpM.get(11),l=[],d=[];e.dataList.forEach(function(e){var t=e.elements.revokedInfos,s=e.revokerInfo,r=e.groupProfile,c=!1;r&&(c=Dt({groupID:r.groupID})||!We(r.topicID)),k(t)||t.forEach(function(e){var t,n=We(e.topicID)?"GROUP".concat(e.groupID):"GROUP".concat(e.topicID),o=u.getLocalConversation(n),i=e.revokerInfo&&e.revokerInfo.revoker||s&&s.revoker,a=s&&s.reason||"";o&&Tt(o.type)?t={conversationID:n,sequence:e.sequence,ID:"".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)}:(o=u.revoke(n,e.sequence,e.random))?t=o:(t={conversationID:n,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(t.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)),e.time&&(t.time=e.time)),t&&(t.revoker=i,t.revokeReason=a,t.revokerInfo={userID:i,nick:"",avatar:""},c?(t.revokerInfo.nick=r.nick,t.revokerInfo.avatar=r.avatar,l.push(t)):d.push(t))})}),0===d.length&&0===l.length||(u.onMessageRevoked([].concat(l,d)),0<l.length&&this._grpM.emitOuterEvent(G.MESSAGE_REVOKED,l),0<d.length&&u.updateRevokerInfo(d).then(function(e){t._grpM.emitOuterEvent(G.MESSAGE_REVOKED,e)}))}},{key:"_groupListTreeShaking",value:function(e){for(var n=new Map(T(this._grpM.getGroupMap())),t=0,o=e.length;t<o;t++)n.delete(e[t].groupID);this._grpM.hasJoinedAVChatRoom()&&this._grpM.getJoinedAVChatRoom().forEach(function(e){n.delete(e)}),this._grpM.getGroupMap().forEach(function(e,t){e.isSupportTopic&&n.delete(t)});for(var i=T(n.keys()),a=0,s=i.length;a<s;a++)this._grpM.deleteGroup(i[a])}},{key:"syncGroupList",value:function(){var o=this,e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=(this._pagingStatus===Sn&&this._grpM.clearGroupMap(),["Type","Name","FaceUrl","NextMsgSeq","LastMsgTime","AtInfoList","LastRecallTime"]),n=this.PAGING_GRP_COUNT_LIMIT,i=[];if(!0===e)return this._pagingGetGroupListWithTopic({limit:n,offset:0,groupBaseInfoFilter:t,groupList:i});var e="syncGroupList",a="".concat(this._n,".").concat(e),s=new M(e);return this._pagingGetGroupList({limit:n,offset:0,groupBaseInfoFilter:t,groupList:i}).then(function(){var e=Jt(o._pagingGetCostList),t=jt(o._pagingGetCostList),n=(o._pagingGetCostList.length=0,o._pagingStatus=kn,o._groupListTreeShaking(i),o._grpM.updateGroupMap(i),o._grpM.getLocalGroupList().length),n="count:".concat(n," sum:").concat(t," avg:").concat(e);return A.l("".concat(a," ok. ").concat(n)),s.setMessage(n).end(),o.tempConversationList&&(o.handleUpdateGroupLastMessage(o.tempConversationList),o.tempConversationList=null),o._grpM.emitGroupListUpdate(!0,!0),yn({groupList:o._grpM.getLocalGroupList()})}).catch(function(e){return o._pagingStatus=Rn,s.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e)})}},{key:"getGroupList",value:function(){var t=this,n="".concat(this._n,".").concat("getGroupList");if(A.l("".concat(n," pagingStatus:").concat(this._pagingStatus)),this._pagingStatus===Rn||this._pagingStatus===Sn)return this.syncGroupList().then(function(){var e=t._grpM.getLocalGroupList();return yn({groupList:e,isSyncCompleted:t.isPagingGetCompleted()})}).catch(function(e){return A.e("".concat(n," failed. error:"),e),m(e)});var e=this._grpM.getLocalGroupList();return A.l("".concat(n,". returned group count:").concat(e.length)),Cn({groupList:e,isSyncCompleted:this.isPagingGetCompleted()})}},{key:"isPagingGetCompleted",value:function(){return this._pagingStatus===kn}},{key:"_pagingGetGroupList",value:function(e){var o=this,i="".concat(this._n,".").concat("_pagingGetGroupList"),t=e.isCommunityRelay,a=void 0!==t&&t,s=e.limit,r=e.offset,c=e.groupBaseInfoFilter,u=e.groupList,l=Date.now();return this._grpM.req({proto:v.GET_GRP_LIST,data:{type:a?S.GRP_COMMUNITY:void 0,memberAccount:this._grpM.getMyUserID(),limit:s,offset:r,responseFilter:{groupBaseInfoFilter:c,selfInfoFilter:["Role","JoinTime","MsgFlag","MsgSeq"]}}}).then(function(e){var e=e.data,t=e.groups,t=void 0===t?[]:t,e=e.totalCount,t=(u.push.apply(u,T(t)),o._handleGroupAtInfoWithoutTopic(a,t),r+s),n=!(t<e),e="offset:".concat(r," limit:").concat(s," totalCount:").concat(e," isCompleted:").concat(n," ")+"currentCount:".concat(u.length," isCommunityRelay:").concat(a);return o._pagingGetCostList.push(zt(l,!1)),A.l("".concat(i," ok. ").concat(e," cost:").concat(zt(l))),a||n?!a&&n?(A.l("".concat(i," start to get community list")),r=0,o._pagingGetGroupList({limit:s,offset:r,groupBaseInfoFilter:c,groupList:u,isCommunityRelay:!0})):a&&!n?(r=t,o._pagingGetGroupList({limit:s,offset:r,groupBaseInfoFilter:c,groupList:u,isCommunityRelay:!0})):yn({groupList:u}):(r=t,o._pagingGetGroupList({limit:s,offset:r,groupBaseInfoFilter:c,groupList:u}))}).catch(function(e){return 10018===e.code?(A.w("".concat(o.logPrefix," response size exceeds the limit, request count:").concat(s)),s=50,o._pagingGetGroupList({limit:s,offset:r,groupBaseInfoFilter:c,groupList:u,isCommunityRelay:a})):a?(11e3===e.code&&A.l("".concat(i," ok. community unavailable")),Cn({groupList:u})):m(e)})}},{key:"_pagingGetGroupListWithTopic",value:function(e){var o=this,i="".concat(this._n,"._pagingGetGroupListWithTopic"),a=e.limit,s=e.offset,r=e.groupBaseInfoFilter,c=e.groupList,u=Date.now();return this._grpM.req({proto:v.GET_GRP_LIST,data:{type:S.GRP_COMMUNITY,memberAccount:this._grpM.getMyUserID(),limit:a,offset:s,responseFilter:{groupBaseInfoFilter:r,selfInfoFilter:["Role","JoinTime","MsgFlag","MsgSeq"]},isSupportTopic:1}}).then(function(e){var e=e.data,t=e.groups,e=e.totalCount,t=(c.push.apply(c,T(void 0===t?[]:t)),s+a),n=!(t<e);if(A.l("".concat(i," ok. offset:").concat(s," limit:").concat(a," totalCount:").concat(e," isCompleted:").concat(n," currentCount:").concat(c.length," cost:").concat(zt(u))),!n)return s=t,o._pagingGetGroupListWithTopic({limit:a,offset:s,groupBaseInfoFilter:r,groupList:c});o._grpM.updateGroupMap(c),o._grpM.emitGroupListUpdate(!0,!1);e=o._grpM.getLocalGroupList().filter(function(e){return!0===e.isSupportTopic});return yn({groupList:e})}).catch(function(e){return 10018===e.code?(A.w("".concat(o.logPrefix," response size exceeds the limit, request count:").concat(a)),a=50,o._pagingGetGroupListWithTopic({limit:a,offset:s,groupBaseInfoFilter:r,groupList:c})):m(e)})}},{key:"_cacheGroupMessage",value:function(e,t){this._cachedGroupMessageMap.has(e)||this._cachedGroupMessageMap.set(e,[]),this._cachedGroupMessageMap.get(e).push(t)}},{key:"_deleteCachedGroupMessage",value:function(e){this._cachedGroupMessageMap.has(e)&&this._cachedGroupMessageMap.delete(e)}},{key:"_notifyCachedGroupMessage",value:function(e){var t=this,n=this._cachedGroupMessageMap.get(e)||[];n.forEach(function(e){t.onNewGroupMessage(e)}),this._deleteCachedGroupMessage(e),A.l("".concat(this._n,"._notifyCachedGroupMessage groupID:").concat(e," count:").concat(n.length))}},{key:"_cacheGroupMessageAndProbe",value:function(e){var t=this,n=e.groupID,o=e.event,e=e.item;this._cacheGroupMessage(n,{event:o,dataList:[e]}),this._grpM.getGroupSimplifiedInfo(n).then(function(e){e.type===S.GRP_AVCHATROOM?t._grpM.hasLocalGroup(n)?t._notifyCachedGroupMessage(n):t._grpM.setUnjoinedAVChatRoom(n):(t._grpM.updateGroupMap([e]),t._notifyCachedGroupMessage(n))}),this._checkCountMap.has(n)||this._checkCountMap.set(n,0),A.l("".concat(this._n,"._cacheGroupMessageAndProbe groupID:").concat(n))}},{key:"_handleGroupAtInfoWithoutTopic",value:function(e,t){var o=this;e&&0!==t.length&&t.forEach(function(e){var t=e.groupID,e=e.groupAtInfoList,n=[];k(e)||(e.forEach(function(e){n.push(y(y({},e),{},{groupID:t}))}),o._grpM.get(11).onNewGroupAtTips({dataList:n}))})}},{key:"setPagingGroupCount",value:function(e){k(e)||(this.PAGING_GRP_COUNT_LIMIT=parseInt(e,10))}},{key:"reset",value:function(){this.PAGING_GRP_COUNT_LIMIT=200,this._cachedGroupMessageMap.clear(),this._checkCountMap.clear(),this._pagingStatus=Sn,this._pagingGetCostList=[]}}]),Ki),ri=(e(Bi,[{key:"_onCloudConfigUpdated",value:function(){var e=this._grpM.getCloudConfig("grp_attr_cache_time");k(e)||(this.CACHE_EXPIRE_TIME=Number(e))}},{key:"updateLocalMainSequenceOnReconnected",value:function(){this._groupAttributesMap.forEach(function(e){e.localMainSequence=0})}},{key:"isGroupAttributesUpdatedNotice",value:function(e){var t=e.to,e=e.elements.newGroupProfile,n=!k(e)&&!We(e.groupAttributeOption);return n&&this._onGroupAttributesUpdated({groupID:t,groupAttributeOption:e.groupAttributeOption}),n}},{key:"_onGroupAttributesUpdated",value:function(e){var t=this,n=e.groupID,e=e.groupAttributeOption,o=e.mainSequence,i=e.isWithChangedAttributeInfo,a=e.groupAttributeList,a=void 0===a?[]:a,e=e.operationType;if(A.l("".concat(this._n,".onGroupAttributesUpdated. ")+"groupID:".concat(n," isWithChangedAttributeInfo:").concat(i," operationType:").concat(e)),!k(e)){this._groupAttributesCopy=this._getCachedAttributes({groupID:n});var s=o-this._getLocalGroupAttributes(n).localMainSequence;if(0!=s){if(1===i&&1==s)return this._refreshCachedGroupAttributes({groupID:n,remoteMainSequence:o,groupAttributeList:a,operationType:e}),void this._emitGroupAttributesUpdated(n);this._hasLocalGroupAttributes(n)&&(i=this._getLocalGroupAttributes(n).avChatRoomKey,this._getGroupAttributes({groupID:n,avChatRoomKey:i}).then(function(){t._emitGroupAttributesUpdated(n)}))}}}},{key:"initGroupAttributesCache",value:function(e){var t=e.groupID,e=e.avChatRoomKey,e=void 0===e?void 0:e;this._groupAttributesMap.set(t,{lastUpdateTime:0,localMainSequence:0,remoteMainSequence:0,attributes:new Map,avChatRoomKey:e}),A.l("".concat(this._n,".initGroupAttributesCache groupID:").concat(t," avChatRoomKey:").concat(e))}},{key:"initGroupAttributes",value:function(e){var n=this,o=e.groupID,i=e.groupAttributes,e=this._getLocalGroupAttributes(o),t=e.remoteMainSequence,e=e.avChatRoomKey,a=new M("initGroupAttributes");return a.setMessage("groupID:".concat(o," avChatRoomKey:").concat(e," mainSequence:").concat(t)),this._grpM.req({proto:v.SET_GRP_ATTR,data:{groupID:o,avChatRoomKey:e,mainSequence:t,groupAttributeList:this._transformGroupAttributes(i)}}).then(function(e){A.l("".concat(n._n,".").concat("initGroupAttributes"," ok. groupID:").concat(o));var e=e.data,t=e.mainSequence,e=T(e.groupAttributeList);return e.forEach(function(e){e.value=i[e.key]}),n._groupAttributesCopy=n._getCachedAttributes({groupID:o}),n._refreshCachedGroupAttributes({groupID:o,remoteMainSequence:t,groupAttributeList:e,operationType:1}),n._emitGroupAttributesUpdated(o),a.end(),yn({groupAttributes:i})}).catch(function(e){return a.setError(e).end(),m(e)})}},{key:"setGroupAttributes",value:function(e){var n=this,o="".concat(this._n,".").concat("setGroupAttributes"),i=e.groupID,a=e.groupAttributes,e=this._getLocalGroupAttributes(i),t=e.remoteMainSequence,s=e.avChatRoomKey,r=e.attributes,e=this._transformGroupAttributes(a),c=(e.forEach(function(e){var t=e.key;e.sequence=0,r.has(t)&&(e.sequence=r.get(t).sequence)}),new M("setGroupAttributes"));return c.setMessage("groupID:".concat(i," groupAttributes:").concat(JSON.stringify(a))),A.l("".concat(o,". groupID:").concat(i," mainSequence:").concat(t)),this._grpM.req({proto:v.MODIFY_GRP_ATTR,data:{groupID:i,avChatRoomKey:s,mainSequence:t,groupAttributeList:e}}).then(function(e){A.l("".concat(o," ok."));var e=e.data,t=e.mainSequence,e=T(e.groupAttributeList);return e.forEach(function(e){e.value=a[e.key]}),n._groupAttributesCopy=n._getCachedAttributes({groupID:i}),n._refreshCachedGroupAttributes({groupID:i,remoteMainSequence:t,groupAttributeList:e,operationType:2}),n._emitGroupAttributesUpdated(i),c.end(),yn({groupAttributes:a})}).catch(function(e){return c.setError(e).end(),m(e)})}},{key:"deleteGroupAttributes",value:function(e){var t=this,n=e.groupID,e=e.keyList,e=void 0===e?[]:e,o=this._getLocalGroupAttributes(n),i=o.remoteMainSequence,a=o.avChatRoomKey,s=o.attributes,r=T(s.keys()),o=v.CLEAR_GRP_ATTR,l=3,a={groupID:n,avChatRoomKey:a,mainSequence:i},c=[],u=(0<e.length&&(r=[],o=v.DEL_GRP_ATTR,l=4,e.forEach(function(e){var t=0;s.has(e)&&(t=s.get(e).sequence,r.push(e)),c.push({key:e,sequence:t})}),a.groupAttributeList=c),new M("deleteGroupAttributes"));return u.setMessage("groupID:".concat(n," mainSequence:").concat(i," keyList:").concat(e," proto:").concat(o)),this._grpM.req({proto:o,data:a}).then(function(e){A.l("".concat(t._n,".").concat("deleteGroupAttributes"," ok. groupID:").concat(n));e=e.data.mainSequence;return t._groupAttributesCopy=t._getCachedAttributes({groupID:n}),t._refreshCachedGroupAttributes({groupID:n,remoteMainSequence:e,groupAttributeList:c,operationType:l}),t._emitGroupAttributesUpdated(n),u.end(),yn({keyList:r})}).catch(function(e){return u.setError(e).end(),m(e)})}},{key:"getGroupAttributes",value:function(t){var n=this,o="".concat(this._n,".").concat("getGroupAttributes"),i=t.groupID,e=this._getLocalGroupAttributes(i),a=e.avChatRoomKey,s=e.lastUpdateTime,r=e.localMainSequence,e=e.remoteMainSequence,c=new M("getGroupAttributes");if(c.setMessage("groupID:".concat(i," localMainSequence:").concat(r," remoteMainSequence:").concat(e," keyList:").concat(t.keyList)),Date.now()-s>=this.CACHE_EXPIRE_TIME||r<e)return this._getGroupAttributes({groupID:i,avChatRoomKey:a}).then(function(e){c.setMoreMessage("get attributes from remote. count:".concat(e.length)).end(),A.l("".concat(o," from remote. groupID:").concat(i));e=n._getCachedAttributes(t);return yn({groupAttributes:e})}).catch(function(e){return c.setError(e).end(),m(e)});c.setMoreMessage("get attributes from cache").end(),A.l("".concat(o," from cache. groupID:").concat(i));s=this._getCachedAttributes(t);return Cn({groupAttributes:s})}},{key:"_getGroupAttributes",value:function(o){var i=this,e=0;return k(o.avChatRoomKey)||(e=1),this._grpM.req({proto:v.GET_GRP_ATTR,data:y(y({},o),{},{groupType:e})}).then(function(e){A.l("".concat(i._n,"._getGroupAttributes ok. groupID:").concat(o.groupID));var e=e.data,t=e.mainSequence,e=e.groupAttributeList,n=T(e);return k(t)||i._refreshCachedGroupAttributes({groupID:o.groupID,remoteMainSequence:t,groupAttributeList:n,operationType:5}),e}).catch(function(e){return m(e)})}},{key:"_refreshCachedGroupAttributes",value:function(e){var t=e.groupID,n=e.remoteMainSequence,o=e.groupAttributeList,e=e.operationType;if(this._hasLocalGroupAttributes(t)){var i=this._getLocalGroupAttributes(t),a=i.localMainSequence;if(5===e||n-a==1)i.remoteMainSequence=n,i.localMainSequence=n,i.lastUpdateTime=Date.now(),this._updateCachedAttributes({groupAttributes:i,groupAttributeList:o,operationType:e});else{if(a===n)return;i.remoteMainSequence=n}this._groupAttributesMap.set(t,i);o="operationType:".concat(e," localMainSequence:").concat(a," remoteMainSequence:").concat(n);A.l("".concat(this._n,"._refreshCachedGroupAttributes. ").concat(o))}}},{key:"_getCachedAttributes",value:function(e){var t=e.groupID,e=e.keyList,e=void 0===e?[]:e,n={};if(this._hasLocalGroupAttributes(t)){var o=this._getLocalGroupAttributes(t).attributes;if(0<e.length)e.forEach(function(e){o.has(e)&&(n[e]=o.get(e).value)});else{var i,a=N(o.keys());try{for(a.s();!(i=a.n()).done;){var s=i.value;n[s]=o.get(s).value}}catch(e){a.e(e)}finally{a.f()}}}return n}},{key:"_updateCachedAttributes",value:function(e){var o=e.groupAttributes,t=e.groupAttributeList,e=e.operationType;3!==e?4!==e?(1===e&&o.attributes.clear(),t.forEach(function(e){var t=e.key,n=e.value,e=e.sequence;o.attributes.set(t,{value:n,sequence:e})})):t.forEach(function(e){o.attributes.delete(e.key)}):o.attributes.clear()}},{key:"_hasLocalGroupAttributes",value:function(e){return this._groupAttributesMap.has(e)}},{key:"_getLocalGroupAttributes",value:function(e){return this._hasLocalGroupAttributes(e)||this.initGroupAttributesCache({groupID:e}),this._groupAttributesMap.get(e)}},{key:"_transformGroupAttributes",value:function(t){var n=[];return Object.keys(t).forEach(function(e){n.push({key:e,value:t[e]})}),n}},{key:"_emitGroupAttributesUpdated",value:function(e){var t=this._getCachedAttributes({groupID:e}),n=this._computeAttrChangedInfo(t),o=n.updatedKeyList,n=n.deletedKeyList;A.l("".concat(this._n,"._emitGroupAttributesUpdated update:").concat(o.length,", delete:").concat(n.length)),0===o.length&&0===n.length||this._grpM.emitOuterEvent(G.GROUP_ATTRIBUTES_UPDATED,{groupID:e,groupAttributes:t,updatedKeyList:o,deletedKeyList:n})}},{key:"_computeAttrChangedInfo",value:function(t){var n=this,o=[],i=[];return Object.keys(t).forEach(function(e){t[e]!==n._groupAttributesCopy[e]&&o.push(e)}),Object.keys(this._groupAttributesCopy).forEach(function(e){k(t[e])&&i.push(e)}),this._groupAttributesCopy={},{updatedKeyList:o,deletedKeyList:i}}},{key:"deleteLocalGroupAttributes",value:function(e){this._hasLocalGroupAttributes(e)&&this._groupAttributesMap.delete(e)}},{key:"reset",value:function(){this._groupAttributesMap.clear(),this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4}}]),Bi),ci=(e(Hi,[{key:"_onCloudConfigUpdated",value:function(){var e=this._grpM.getCloudConfig("grp_counter_expire_time");k(e)||(this.EXPIRE_TIME=Number(e))}},{key:"isGroupCountersNotice",value:function(e){var t=e.to,e=e.elements.groupCounterInfo,n=!1;return We(e)||(this._onGroupCountersUpdated({groupID:t,groupCounterInfo:e}),n=!0),n}},{key:"_onGroupCountersUpdated",value:function(e){var o=this,i=e.groupID;e.groupCounterInfo.forEach(function(e){var t=e.type,n=e.groupCounterSeq,e=e.counterList,e=void 0===e?[]:e;0!==t&&2!==t||(o._updateLocalGroupCounters({groupID:i,groupCounterSeq:n,counterList:e}),e.forEach(function(e){o._grpM.emitOuterEvent(G.GROUP_COUNTER_UPDATED,{groupID:i,key:e.key,value:e.value})})),1===t&&o._deleteLocalGroupCounters({groupID:i,groupCounterSeq:n,counterList:e})}),A.l("".concat(this._n,"._onGroupCountersUpdated groupID:").concat(i))}},{key:"initGroupCountersCache",value:function(e){var t=e.groupID,e=e.avChatRoomKey;this._groupCountersMap.set(t,{lastUpdateTime:0,groupCounterSeq:0,counters:new Map,avChatRoomKey:e}),A.l("".concat(this._n,".initGroupCountersCache groupID:").concat(t," avChatRoomKey:").concat(e))}},{key:"setGroupCounters",value:function(e){if(!this._grpM.canIUse(H.GRP_COUNTER))return this._grpM.cannotUseCommercialAbility("setGroupCounters");var t="".concat(this._n,".").concat("setGroupCounters"),n=e.groupID,e=e.counters,e=this._convertObjectToList(e),o=this._getLocalGroupCounters(n).avChatRoomKey,i="groupID:".concat(n," count:").concat(e.length),a=new M("setGroupCounters");return a.setMessage("".concat(i)),A.l("".concat(t,". ").concat(i)),this._updateGroupCounters({groupID:n,counterList:e,avChatRoomKey:o,mode:"Set"}).then(function(e){return a.end(),A.l("".concat(t," ok.")),yn({counters:e})}).catch(function(e){return a.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"increaseGroupCounter",value:function(e){var t="increaseGroupCounter";if(!this._grpM.canIUse(H.GRP_COUNTER))return this._grpM.cannotUseCommercialAbility(t);var n="".concat(this._n,".").concat(t),o=e.groupID,i=e.key,e=e.value,a=this._getLocalGroupCounters(o).avChatRoomKey,s="groupID:".concat(o," key:").concat(i," value:").concat(e),r=new M(t);return r.setMessage("".concat(s)),A.l("".concat(n,". ").concat(s)),this._updateGroupCounters({groupID:o,counterList:[{key:i,value:e}],avChatRoomKey:a,mode:"Increase"}).then(function(e){return r.end(),A.l("".concat(n," ok.")),yn({counters:e})}).catch(function(e){return r.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"decreaseGroupCounter",value:function(e){var t="decreaseGroupCounter";if(!this._grpM.canIUse(H.GRP_COUNTER))return this._grpM.cannotUseCommercialAbility(t);var n="".concat(this._n,".").concat(t),o=e.groupID,i=e.key,e=e.value,a=this._getLocalGroupCounters(o).avChatRoomKey,s="groupID:".concat(o," key:").concat(i," value:").concat(e),r=new M(t);return r.setMessage("".concat(s)),A.l("".concat(n,". ").concat(s)),this._updateGroupCounters({groupID:o,counterList:[{key:i,value:e}],avChatRoomKey:a,mode:"Decrease"}).then(function(e){return r.end(),A.l("".concat(n," ok.")),yn({counters:e})}).catch(function(e){return r.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"getGroupCounters",value:function(e){var t=this;if(!this._grpM.canIUse(H.GRP_COUNTER))return this._grpM.cannotUseCommercialAbility("getGroupCounters");var n="".concat(this._n,".").concat("getGroupCounters"),o=e.groupID,e=e.keyList,i=void 0===e?[]:e,e=this._getLocalGroupCounters(o),a=e.avChatRoomKey,e=e.lastUpdateTime,s=new M("getGroupCounters");if(s.setMessage("groupID:".concat(o)),Date.now()-e>=this.EXPIRE_TIME)return this._getRemoteGroupCounters({groupID:o,avChatRoomKey:a}).then(function(e){s.setMoreMessage("from remote. count:".concat(e.length)).end(),A.l("".concat(n," from remote. groupID:").concat(o));e=t._getLocalCounters(o,i);return yn({counters:e})}).catch(function(e){return s.setError(e).end(),m(e)});s.setMoreMessage("from cache").end(),A.l("".concat(n," from cache. groupID:").concat(o));e=this._getLocalCounters(o,i);return Cn({counters:e})}},{key:"_getRemoteGroupCounters",value:function(n){var o=this;return this._grpM.req({proto:v.GET_GRP_COUNTER,data:y({},n)}).then(function(e){var e=e.data,t=e.counterList,t=void 0===t?[]:t,e=e.groupCounterSeq;return o._updateLocalGroupCounters({groupID:n.groupID,counterList:t,groupCounterSeq:e}),A.l("".concat(o._n,"._getRemoteGroupCounters ok. groupID:").concat(n.groupID)),t}).catch(function(e){return m(e)})}},{key:"_convertObjectToList",value:function(t){var n=[];return Object.keys(t).forEach(function(e){n.push({key:e,value:t[e]})}),n}},{key:"_updateGroupCounters",value:function(e){var t="".concat(this._n,"._updateGroupCounters"),n=e.groupID,o=e.avChatRoomKey,i=e.mode;return A.l("".concat(t,". groupID:").concat(n," avChatRoomKey:").concat(o," mode:").concat(i)),this._grpM.req({proto:v.UPDATE_GRP_COUNTER,data:y({},e)}).then(function(e){A.l("".concat(t," ok."));var e=e.data.counterList,n={};return(void 0===e?[]:e).forEach(function(e){var t=e.key,e=e.value;n[t]=e}),n}).catch(function(e){return m(e)})}},{key:"_hasLocalGroupCounters",value:function(e){return this._groupCountersMap.has(e)}},{key:"_getLocalGroupCounters",value:function(e){return this._hasLocalGroupCounters(e)||this.initGroupCountersCache({groupID:e}),this._groupCountersMap.get(e)}},{key:"_updateLocalGroupCounters",value:function(e){var n,t,o,i=e.groupID,a=e.counterList,a=void 0===a?[]:a,e=e.groupCounterSeq;this._hasLocalGroupCounters(i)&&(o=this._getLocalGroupCounters(i),n=o.counters,t=o.avChatRoomKey,o=o.groupCounterSeq,0<e&&e<o||(a.forEach(function(e){var t=e.key,e=e.value;n.set(t,e)}),this._groupCountersMap.set(i,{lastUpdateTime:Date.now(),groupCounterSeq:e,counters:n,avChatRoomKey:t})))}},{key:"_deleteLocalGroupCounters",value:function(e){var t,n,o=e.groupID,i=e.counterList,i=void 0===i?[]:i,e=e.groupCounterSeq;this._hasLocalGroupCounters(o)&&(n=this._getLocalGroupCounters(o),t=n.counters,n=n.avChatRoomKey,i.forEach(function(e){t.delete(e.key)}),this._groupCountersMap.set(o,{lastUpdateTime:Date.now(),groupCounterSeq:e,counters:t,avChatRoomKey:n}))}},{key:"_getLocalCounters",value:function(e,t){var n={};if(!this._hasLocalGroupCounters(e))return n;var o=this._getLocalGroupCounters(e).counters;if(0<t.length)t.forEach(function(e){o.has(e)&&(n[e]=o.get(e))});else{var i,a=N(o.keys());try{for(a.s();!(i=a.n()).done;){var s=i.value;n[s]=o.get(s)}}catch(e){a.e(e)}finally{a.f()}}return n}},{key:"reset",value:function(){this._groupCountersMap.clear(),this.EXPIRE_TIME=3e4}}]),Hi),ui=(e(Vi,[{key:"start",value:function(){var e=this._grpM.isLoggedIn();e||(this._proto=v.AV_NOAUTH_POLLING),A.l("".concat(this._n,".start pollingInterval:").concat(this._manager.getPollingInterval()," isLoggedIn:").concat(e)),this._isRunning=!0,this._request()}},{key:"isRunning",value:function(){return this._isRunning}},{key:"_request",value:function(){var t=this,e=this._onInit(this._groupID);this._grpM.req({proto:this._proto,data:e}).then(function(e){t._onSuccess(t._groupID,e),t.isRunning()&&(clearTimeout(t._timeoutID),t._timeoutID=setTimeout(t._request.bind(t),t._manager.getPollingInterval()))}).catch(function(e){t._onFail(t._groupID,e),t.isRunning()&&(clearTimeout(t._timeoutID),t._timeoutID=setTimeout(t._request.bind(t),t._manager.MAX_POLLING_INTERVAL))})}},{key:"stop",value:function(){A.l("".concat(this._n,".stop")),0<this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=-1),this._isRunning=!1}},{key:"getPollingTimerID",value:function(){return this._timeoutID}}]),Vi),li={3:!0,4:!0,5:!0,6:!0,17:!0,20:!0,21:!0,100:!0},di=(e(xi,[{key:"hasJoinedAVChatRoom",value:function(){var e=[];return 0<(e=0<this._joinedGroupMap.size?T(this._joinedGroupMap.values()).filter(function(e){return e.type===S.GRP_AVCHATROOM}):e).length}},{key:"getJoinedLiveList",value:function(){var e=[];return e=0<this._joinedGroupMap.size?T(this._joinedGroupMap.values()).filter(function(e){return e.type===S.GRP_LIVE}):e}},{key:"checkJoinedAVChatRoomByID",value:function(e){return this._joinedGroupMap.has(e)}},{key:"getJoinedAVChatRoom",value:function(){return 0<this._joinedGroupMap.size?T(this._joinedGroupMap.keys()):[]}},{key:"_updatedata",value:function(e){var t=this._pollingRequestInfoMap.get(e);return e===T(this._pollingInstanceMap.keys())[0]?y(y({},t),{},{startBroadcastSeq:this._startBroadcastSeq,simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG}):y(y({},t),{},{simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG})}},{key:"_handleSuccess",value:function(e,t){var n,o=t.data,i=o.key,a=o.nextSeq,s=o.rspMsgList,r=o.errorCode,c=o.nextBroadcastSeq,o=o.broadcastMessageList;0!==r?(r=this._pollingRequestInfoMap.get(e),n=new M("longPollingAVError"),r=r?"".concat(r.key,"-").concat(r.startSeq):"requestInfo is undefined",n.setMessage("".concat(e,"-").concat(r,"-").concat(t.errorInfo)).setCode(t.errorCode).end(!0)):this.checkJoinedAVChatRoomByID(e)&&(pt(i)&&ze(a)&&this._pollingRequestInfoMap.set(e,{key:i,startSeq:a}),ze(c)&&c>this._startBroadcastSeq&&(this._startBroadcastSeq=c),Qe(s)&&0<s.length?(s.forEach(function(e){e.to=e.groupID}),this.onMessage(s,e)):(this._pollingNoMessageCount+=1,this._pollingNoMessageCount===this.DEFAULT_POLLING_NO_MESSAGE_COUNT&&(this._pollingInterval=this.DEFAULT_POLLING_INTERVAL+this.DEFAULT_POLLING_INTERVAL_PLUS)),this._onBroadcastMessage(o))}},{key:"_handleFailure",value:function(e,t){}},{key:"onMessage",value:function(e,t){if(Qe(e)&&0!==e.length){var n="".concat(this._n,".onMessage"),o=(t&&(n+=" groupID:".concat(t)),0!==this._pollingNoMessageCount&&(this._pollingNoMessageCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL),null),i=[],l=this._get(11),a=this._get(26),d=e.length,p=(1<d&&e.sort(function(e,t){return e.sequence-t.sequence}),this._get(12).isUnlimitedAVChatRoom()),s=!1;A.getLevel()<=0&&(t=e.map(function(e){return e.sequence}),A.l("".concat(n," count:").concat(t.length," sequenceList:").concat(t)),t.length=0);for(var _=0;_<d;_++){var r=this.restoreMessageFromSimplified(e[_]);if(li[r.event]){if(6===r.event){if(this._grpM.isGroupAttributesUpdatedNotice(r))continue;if(this._grpM.isGroupCountersNotice(r))continue}if(20!==r.event)if(21!==r.event)if(100!==r.event){var o=this.packMessage(r,r.event),c=1===r.isModified,s=1===r.isHistoryMessage;if(!p){if(this.sequencesLinkedList.has(o.sequence))continue;this.sequencesLinkedList.set(o.sequence)}var u=this.messageIDLinkedList.has(o.ID);u?A.w("".concat(n," ID:").concat(o.ID," has:").concat(u)):(this.messageIDLinkedList.set(o.ID),u=!1,!s&&this._isMessageSentByCurrentInstance(o)?c&&(u=!0,o.isModified=c,l.updateMessageIsModifiedProperty(o)):u=!0,u&&(o.conversationType===S.CONV_SYSTEM&&5===o.payload.operationType&&this._onGroupDismissed(o.payload.groupProfile.groupID),s||o.conversationType===S.CONV_SYSTEM||(c=o.conversationID.replace(S.CONV_GROUP,""),this._pollingInstanceMap.has(c)?this._grpM.isLoggedIn()&&a.addMessageSequence({key:jn,message:o}):(o.type!==S.MSG_GRP_TIP&&0<o.clientTime&&a.addMessageDelay(o.clientTime),a.addMessageSequence({key:Yn,message:o}))),i.push(o)))}else this.onRoomCustomData(r);else this._get(34).onMessageReactionNotify({event:21,dataList:r.elements.messageReactionNotifyList});else this.handleMessageRevokedNotice(r)}else A.w("".concat(n,". unknown event:").concat(r.event))}0!==i.length&&(0<(t=yt(i)).length&&this._grpM.emitOuterEvent(G.MESSAGE_MODIFIED,t),s||0<(t=this.packConversationOption(i)).length&&l.onNewMessage({conversationOptionsList:t,isInstantMessage:!0}),this._checkMessageStacked(i),0<(t=Ct(i)).length&&this._grpM.emitOuterEvent(G.MESSAGE_RECEIVED,t),i.length=0)}}},{key:"handleMessageRevokedNotice",value:function(e){var t=this,i=e.groupID,n=e.elements.revokeMsgList,a=e.revokerInfo,s=[];n.forEach(function(e){var t=e.tinyID,n=e.clientTime,o=e.random,e=e.sequence,t={conversationID:"".concat(S.CONV_GROUP).concat(i),ID:"".concat(t,"-").concat(n,"-").concat(o),revoker:a.revoker,revokeReason:a.reason||"",revokerInfo:{userID:a.revoker,nick:"",avatar:""},sequence:e};s.push(t)}),0!==s.length&&this._get(11).updateRevokerInfo(s).then(function(e){t._grpM.emitOuterEvent(G.MESSAGE_REVOKED,e)})}},{key:"isBroadcastOrNormal",value:function(e){return 3===e||17===e}},{key:"isGroupTip",value:function(e){return 4===e||6===e}},{key:"isGroupSystemNotice",value:function(e){return 5===e}},{key:"restoreGroupTipElements",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.operatorInfo,t=void 0===t?{}:t,n=e.operatorID,o=e.userIDList,o=void 0===o?[]:o,i=e.operationType,i=(ze(e.groupJoinType)||1!==i&&2!==i||(e.groupJoinType=2===i?0:1),t.userID),a=t.avatar,t=t.nick,n=(e.operatorInfo={userID:void 0===i?n:i,avatar:void 0===a?"":a,nick:void 0===t?"":t},o.map(function(e){return{userID:e}}));return e.memberInfoList=e.memberInfoList||n,e}},{key:"restoreMessageFromSimplified",value:function(n){var e,t,o,i=n.event;return this.isBroadcastOrNormal(i)&&(n.cloudCustomData=n.cloudCustomData||"",n.elements=n.elements.map(function(e){var t;return e.type===S.MSG_CUSTOM&&(t=e.content,e.content=y({data:"",description:"",extension:""},void 0===t?{}:t)),e})),(this.isGroupTip(i)||this.isGroupSystemNotice(i))&&(n.from=n.from||"@TIM#SYSTEM"),this.isGroupTip(i)&&(n.elements=this.restoreGroupTipElements(n.elements),t=(o=void 0===(o=n.elements)?{}:o).operationType,e=o.operatorInfo,1===t&&(t=[{userID:(void 0===e?{}:e).userID}],o.memberInfoList=o.memberInfoList||t)),this.isGroupSystemNotice(i)&&(o=(e=n.elements).memberInfoList,t=e.operatorInfo,n.elements.memberInfoList=y({userID:n.elements.operatorID,avatar:"",nick:""},o=o||(void 0===t?{}:t)),n.elements=y({authentication:"",remarkInfo:"",messageKey:1e3*n.time},n.elements),i=Object.keys(n.elements).filter(function(e){return"operatorInfo"!==e}).reduce(function(e,t){return y(y({},e),{},c({},t,n.elements[t]))},{}),n.elements=i),n}},{key:"_onGroupDismissed",value:function(e){A.l("".concat(this._n,"._onGroupDismissed groupID:").concat(e)),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e)}},{key:"_checkMessageStacked",value:function(e){var t="MessageStacked",e=e.length;100<=e&&(this._grpM.outputWarning(t,e),this._reportMessageStackedCount<5&&(new M(t).setMessage("count:".concat(e," groupID:").concat(T(this._joinedGroupMap.keys()))).setLevel("warning").end(),this._reportMessageStackedCount+=1))}},{key:"_isMessageSentByCurrentInstance",value:function(e){return!!this._get(11).isMessageSentByCurrentInstance(e)}},{key:"packMessage",value:function(e,t){e.currentUser=this._grpM.getMyUserID(),e.conversationType=5===t?S.CONV_SYSTEM:S.CONV_GROUP,e.isSystemMessage=!!e.isSystemMessage;var n=new go(e),e=this.packElements(e,t);return n.setElement(e,this._grpM.getFileDownloadProxy()),n}},{key:"packElements",value:function(e,t){return 4===t||6===t?(this._updateMemberCountByGroupTips(e),{type:S.MSG_GRP_TIP,content:y(y({},e.elements),{},{groupProfile:e.groupProfile})}):5===t?{type:S.MSG_GRP_SYS_NOTICE,content:y(y({},e.elements),{},{groupProfile:y(y({},e.groupProfile),{},{groupID:e.groupID})})}:e.elements}},{key:"packConversationOption",value:function(e){for(var t=new Map,n=0;n<e.length;n++){var o,i=e[n],a=i.conversationID;t.has(a)?"in"===((o=t.get(a)).lastMessage=i).flow&&o.unreadCount++:t.set(a,{conversationID:i.conversationID,unreadCount:"out"===i.flow?0:1,type:i.conversationType,subType:i.conversationSubType,lastMessage:i})}return T(t.values())}},{key:"_updateMemberCountByGroupTips",value:function(e){var t,n,o,i=e.groupProfile.groupID,e=e.elements.onlineMemberInfo,e=void 0===e?void 0:e;We(e)||(t=void 0===(t=e.onlineMemberNum)?0:t,e=void 0===(e=e.expireTime)?this.DEFAULT_EXPIRE_TIME:e,n=this._onlineMemberCountMap.get(i)||{},o=Date.now(),We(n)?Object.assign(n,{lastReqTime:0,lastSyncTime:0,latestUpdateTime:o,memberCount:t,expireTime:e}):(n.latestUpdateTime=o,n.memberCount=t),this._onlineMemberCountMap.set(i,n))}},{key:"_onBroadcastMessage",value:function(e){if(!We(e)){for(var t=[],n=e.length,o=null,i=0;i<n;i++){var a=this.restoreMessageFromSimplified(e[i]);li[a.event]?((o=this.packMessage(a,a.event)).isBroadcastMessage=!0,this._broadcastMessageIDMap.has(o.ID)||(t.push(o),this._broadcastMessageIDMap.set(o.ID,1))):A.w("".concat(this._n,"._onBroadcastMessage unknown event:").concat(a.event))}0<t.length&&this._grpM.emitOuterEvent(G.MESSAGE_RECEIVED,t)}}},{key:"start",value:function(e){var t;this._pollingInstanceMap.has(e)?(t=this._pollingInstanceMap.get(e)).isRunning()||t.start():((t=new ui({manager:this,groupID:e,onInit:this._updatedata.bind(this),onSuccess:this._handleSuccess.bind(this),onFail:this._handleFailure.bind(this)})).start(),this._pollingInstanceMap.set(e,t),A.l("".concat(this._n,".start groupID:").concat(e)))}},{key:"handleJoinResult",value:function(o){var i=this;return this._preCheck(o.group).then(function(){var e=o.longPollingKey,t=o.group,n=t.groupID;return i._joinedGroupMap.set(n,t),i._grpM.updateGroupMap([t]),i._grpM.deleteUnjoinedAVChatRoom(n),i._grpM.emitGroupListUpdate(!0,!1),k(e)?Cn({status:Ve,group:t}):Promise.resolve()})}},{key:"startRunLoop",value:function(i){var a=this;return this.handleJoinResult(i).then(function(){var e=i.longPollingKey,t=i.group,n=i.startSeq,o=t.groupID;return a._pollingRequestInfoMap.set(o,{key:e,startSeq:void 0===n?0:n}),a.start(o),a._grpM.isLoggedIn()?Cn({status:Ve,group:t}):Cn({status:Ve})})}},{key:"_preCheck",value:function(e){if(this._get(12).isUnlimitedAVChatRoom())return Promise.resolve();if(!this.hasJoinedAVChatRoom())return Promise.resolve();if(e.type===S.GRP_LIVE)return Promise.resolve();var e=I(this._joinedGroupMap.entries().next().value,2),t=e[0],e=e[1];if(this._grpM.isLoggedIn()){if(e.selfInfo.role!==S.GRP_MBR_ROLE_OWNER&&e.ownerID!==this._grpM.getMyUserID())return this._grpM.quitGroup(t);this._grpM.deleteLocalGroupAndConversation(t)}else this._grpM.deleteLocalGroupAndConversation(t);return this.reset(t),Promise.resolve()}},{key:"joinWithoutAuth",value:function(e){var n=this,o=e.groupID,i="".concat(this._n,".").concat("joinWithoutAuth"),a=new M("joinWithoutAuth");return this._grpM.req({proto:v.APPLY_JOIN_GRP_NOAUTH,data:e}).then(function(e){e=e.data.longPollingKey;if(a.setMessage("groupID:".concat(o," longPollingKey:").concat(e)).end(!0),k(e))return m({code:C.CANNOT_JOIN_NON_AVCHATROOM_WITHOUT_LOGIN});A.l("".concat(i," ok. groupID:").concat(o)),n._get(11).setCompleted("".concat(S.CONV_GROUP).concat(o));var t=new $o({groupID:o});return n.startRunLoop({group:t,longPollingKey:e}),yn({status:Ve})}).catch(function(e){return A.e("".concat(i," failed. groupID:").concat(o," error:"),e),a.setError(e).setMessage("groupID:".concat(o)).end(!0),m(e)}).finally(function(){n._grpM.get(14).reportAtOnce()})}},{key:"getGroupOnlineMemberCount",value:function(e){var t=this._onlineMemberCountMap.get(e)||{},n=Date.now();return We(t)||n-t.lastSyncTime>1e3*t.expireTime&&1e4<n-t.latestUpdateTime&&3e3<n-t.lastReqTime?(t.lastReqTime=n,this._onlineMemberCountMap.set(e,t),this._getGroupOnlineMemberCount(e).then(function(e){return yn({memberCount:e.memberCount})}).catch(function(e){return m(e)})):Cn({memberCount:t.memberCount})}},{key:"_getGroupOnlineMemberCount",value:function(i){var a=this,s="".concat(this._n,".").concat("_getGroupOnlineMemberCount"),t=new M("_getGroupOnlineMemberCount");return this._grpM.requestOnlineCount(i).then(function(e){var t=a._onlineMemberCountMap.get(i)||{},e=e.data,n=e.memberCount,n=void 0===n?0:n,e=e.expireTime,e=void 0===e?a.DEFAULT_EXPIRE_TIME:e,o=(A.l("".concat(s," ok. groupID:").concat(i," memberCount:").concat(n," expireTime:").concat(e)),Date.now());return We(t)&&(t.lastReqTime=o),a._onlineMemberCountMap.set(i,Object.assign(t,{lastSyncTime:o,latestUpdateTime:o,memberCount:n,expireTime:e})),{memberCount:n}}).catch(function(e){return A.w("".concat(s," failed. error:"),e),t.setCode(e.code).setMessage("groupID:".concat(i," error:").concat(JSON.stringify(e))).end(),Promise.reject(e)})}},{key:"_get",value:function(e){return this._grpM.get(e)}},{key:"setPollingInterval",value:function(e){k(e)||(ze(e)?this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=e:this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=parseInt(e,10))}},{key:"setPollingIntervalPlus",value:function(e){k(e)||(ze(e)?this.DEFAULT_POLLING_INTERVAL_PLUS=e:this.DEFAULT_POLLING_INTERVAL_PLUS=parseInt(e,10))}},{key:"setPollingNoMessageCount",value:function(e){k(e)||(ze(e)?this.DEFAULT_POLLING_NO_MESSAGE_COUNT=e:this.DEFAULT_POLLING_NO_MESSAGE_COUNT=parseInt(e,10))}},{key:"setPollingSimplifiedMessage",value:function(e){k(e)||"0"!==e&&"1"!==e||(this.DEFAULT_POLLING_SIMPLIFIED_MSG=parseInt(e,10))}},{key:"getPollingInterval",value:function(){return this._pollingInterval}},{key:"onAVChatRoomMemberBanned",value:function(e){e=e.payload.groupProfile.groupID;A.l("".concat(this._n,".onAVChatRoomMemberBanned groupID:").concat(e)),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e)}},{key:"restartPolling",value:function(){A.l("".concat(this._n,".restartPolling count:").concat(this._pollingInstanceMap.size));var e,t=N(this._pollingInstanceMap.values());try{for(t.s();!(e=t.n()).done;){var n=e.value;n.stop(),n.start()}}catch(e){t.e(e)}finally{t.f()}}},{key:"getPollingTimerID",value:function(e){if(!this._pollingInstanceMap.has(e))return-1;var t=this._pollingInstanceMap.get(e).getPollingTimerID();return A.l("".concat(this._n,".getPollingTimerID groupID:").concat(e," timerID:").concat(t)),t}},{key:"hasPollingInstance",value:function(e){return this._pollingInstanceMap.has(e)}},{key:"onRoomCustomData",value:function(e){var t=e.groupID,n=e.sequence,o=e.time,e=e.elements,e=e&&e.content;this._get(30).onRoomCustomDataReceived(e),A.l("".concat(this._n,".onRoomCustomData groupID:").concat(t," sequence:").concat(n," time:").concat(o," data:").concat(e))}},{key:"reset",value:function(e){if(e){A.l("".concat(this._n,".reset groupID:").concat(e));var t=this._pollingInstanceMap.get(e);t&&t.stop(),this._pollingInstanceMap.delete(e),this._joinedGroupMap.delete(e),this._pollingRequestInfoMap.delete(e),this._onlineMemberCountMap.delete(e)}else{A.l("".concat(this._n,".reset all"));var n,o=N(this._pollingInstanceMap.values());try{for(o.s();!(n=o.n()).done;)n.value.stop()}catch(e){o.e(e)}finally{o.f()}this._pollingInstanceMap.clear(),this._joinedGroupMap.clear(),this._pollingRequestInfoMap.clear(),this._onlineMemberCountMap.clear(),this._broadcastMessageIDMap.clear()}this.sequencesLinkedList.reset(),this.messageIDLinkedList.reset(),this._reportMessageStackedCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=300,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0}}]),xi),pi=(e(qi,[{key:"updateMember",value:function(e){k(e.onlineStatus)||(this.isOnline="Online"===e.onlineStatus);var t=[null,void 0,"",0,NaN];e.memberCustomField&&It(this.memberCustomField,e.memberCustomField),ot(this,e,["memberCustomField","marks","onlineStatus"],t)}},{key:"updateRole",value:function(e){["Owner","Admin","Member"].indexOf(e)<0||(this.role=e)}},{key:"updateMuteUntil",value:function(e){k(e)||(this.muteUntil=Math.floor((Date.now()+1e3*e)/1e3))}},{key:"updateNameCard",value:function(e){k(e)||(this.nameCard=e)}},{key:"updateMemberCustomField",value:function(e){e&&It(this.memberCustomField,e)}}]),qi),_i=(e(wi,[{key:"_onProfileUpdated",value:function(e){for(var n=this,o=e.data,t=0;t<o.length;t++)!function(e){var t=o[e];n.groupMemberListMap.forEach(function(e){e.has(t.userID)&&e.get(t.userID).updateMember({nick:t.nick,avatar:t.avatar})})}(t)}},{key:"deleteGroupMemberList",value:function(e){this.groupMemberListMap.delete(e)}},{key:"getGroupMemberList",value:function(e){var t,o=this,i=e.groupID,n=e.role,n=void 0===n?void 0:n,a=e.offset,s=void 0===a?0:a,a=e.count,r=void 0===a?15:a,a=e.filter,e=void 0===a?void 0:a,c="".concat(this._n,".").concat("getGroupMemberList"),a=this._grpM.hasLocalGroup(i);if(A.l("".concat(c," groupID:").concat(i," role:").concat(n," offset:").concat(s," count:").concat(r," hasLocalGroup:").concat(a)),!a)return Cn({memberList:[],offset:0});if(this._grpM.getLocalGroupProfile(i).type===S.GRP_AVCHATROOM){if(this._grpM.canIUse(H.AV_MBR_LIST))return this._getAVChatRoomMemberList({groupID:i,offset:s,filter:e});this._grpM.outputWarning("LiveOnlineMember")}n!==S.GRP_MBR_ROLE_ADMIN&&n!==S.GRP_MBR_ROLE_OWNER&&n!==S.GRP_MBR_ROLE_MEMBER||(t=n);var l=new M("getGroupMemberList"),u=0,a={groupID:i,limit:100<r?100:r,memberRoleFilter:t?[t]:void 0,memberInfoFilter:this.DEFAULT_MEMBER_INFO_FILTER},d=(Dt({groupID:i})?a.next="".concat(s):(a.offset=s,u=s+r),[]);return this._grpM.req({proto:v.GET_GRP_MBR_LIST,data:a}).then(function(e){var e=e.data,t=e.members,n=e.memberNum,e=e.next,e=void 0===e?void 0:e;return k(e)||(u=We(e)?0:e),Qe(t)&&0!==t.length?(o._grpM.hasLocalGroup(i)&&(o._grpM.getLocalGroupProfile(i).memberNum=n),d=o._updateLocalGroupMemberMap(i,t),o._grpM.get(4).getUserProfile({userIDList:t.map(function(e){return e.userID}),tagList:[be.NICK,be.AVATAR]})):(u=0,Promise.resolve([]))}).then(function(e){e=e.data;if(!Qe(e)||0===e.length)return Cn({memberList:[],offset:u});e=e.map(function(e){return{userID:e.userID,nick:e.nick,avatar:e.avatar}});return o._updateLocalGroupMemberMap(i,e),d.length<r&&(u=0),l.setMessage("groupID:".concat(i," offset:").concat(s," count:").concat(r)).end(),A.l("".concat(c," ok.")),yn({memberList:d,offset:u})}).catch(function(e){return l.setError(e).end(),A.e("".concat(c," failed. error:"),e),m(e)})}},{key:"_getAVChatRoomMemberList",value:function(e){var n=this,o=e.groupID,t=e.offset,e=e.filter,i="".concat(this._n,".").concat("_getAVChatRoomMemberList"),a=new M("_getAVChatRoomMemberList");return a.setMessage("groupID:".concat(o," offset:").concat(t," filter:").concat(e)),this._grpM.req({proto:v.GET_AV_MBR_LIST,data:{groupID:o,offset:t,filter:e}}).then(function(e){var e=e.data,t=e.memberList,t=void 0===t?[]:t,e=e.offset,e=void 0===e?0:e,t=(a.end(),A.l("".concat(i," ok. member count:").concat(t.length,", next request timestamp:").concat(e)),t.map(function(e){return y(y({},e),{},{onlineStatus:"Online"})})),t=n._updateLocalGroupMemberMap(o,t);return yn({memberList:t,offset:e})}).catch(function(e){return a.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"getGroupMemberProfile",value:function(e){var t=this,n="getGroupMemberProfile",o="".concat(this._n,".").concat(n),i="groupID:".concat(e.groupID),a=(5<e.userIDList.length?i+=" userIDList.length:".concat(e.userIDList.length):i+=" userIDList:".concat(e.userIDList),A.l("".concat(o," ").concat(i)),50<e.userIDList.length&&(e.userIDList=e.userIDList.slice(0,50)),e.groupID),s=e.userIDList,o=this._grpM.getLocalGroupProfile(a);if(o&&Tt(o.type))return m({code:o=C.OPERATION_NOT_SUPPORTED_IN_AVCHATROOM,message:this._grpM.getErrorMessage(o,n)});var r=new M(n);return r.setMessage(i),this._getGroupMemberProfileAdvance(y(y({},e),{},{userIDList:s})).then(function(e){e=e.data.members;return Qe(e)&&0!==e.length?(t._updateLocalGroupMemberMap(a,e),t._grpM.get(4).getUserProfile({userIDList:e.map(function(e){return e.userID}),tagList:[be.NICK,be.AVATAR]})):Cn([])}).then(function(e){e=e.data.map(function(e){return{userID:e.userID,nick:e.nick,avatar:e.avatar}}),t._updateLocalGroupMemberMap(a,e),e=s.filter(function(e){return t.hasLocalGroupMember(a,e)}).map(function(e){return t.getLocalGroupMemberInfo(a,e)});return r.end(),yn({memberList:e})})}},{key:"addGroupMember",value:function(a){var s=this,r="".concat(this._n,".").concat("addGroupMember"),e=a.groupID,c=this._grpM.getLocalGroupProfile(e),t=c.type,u=new M("addGroupMember");return u.setMessage("groupID:".concat(e," groupType:").concat(t)),Tt(t)?(t=new bn({code:C.CANNOT_ADD_MEMBER_IN_AVCHATROOM}),u.setError(t).end(),m(t)):(a.userIDList=a.userIDList.map(function(e){return{userID:e}}),A.l("".concat(r," groupID:").concat(e)),this._grpM.req({proto:v.ADD_GRP_MBR,data:a}).then(function(e){var e=e.data.members,t=(A.l("".concat(r," ok")),e.filter(function(e){return 1===e.result}).map(function(e){return e.userID})),n=e.filter(function(e){return 0===e.result}).map(function(e){return e.userID}),o=e.filter(function(e){return 2===e.result}).map(function(e){return e.userID}),e=e.filter(function(e){return 4===e.result}).map(function(e){return e.userID}),i="groupID:".concat(a.groupID,", ")+"successUserIDList:".concat(t,", ")+"failureUserIDList:".concat(n,", ")+"existedUserIDList:".concat(o,", ")+"overLimitUserIDList:".concat(e);return u.setMoreMessage(i).end(),0===t.length?yn({successUserIDList:t,failureUserIDList:n,existedUserIDList:o,overLimitUserIDList:e}):(s._updateConversationGroupProfile(c),yn({successUserIDList:t,failureUserIDList:n,existedUserIDList:o,overLimitUserIDList:e,group:c}))}).catch(function(e){return u.setError(e).end(),A.e("".concat(r," failed. error:"),e),m(e)}))}},{key:"deleteGroupMember",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteGroupMember"),o=e.groupID,i=e.userIDList,a=this._grpM.getLocalGroupProfile(o);if(k(a))return m({code:C.CANNOT_FIND_GRP});if(Tt(a.type))return this._grpM.canIUse(H.AV_BAN_MBR)?this._banAVChatRoomMember(e):this._grpM.cannotUseCommercialAbility("deleteGroupMember");var s="groupID:".concat(o," ").concat(5<i.length?"userIDList.length:".concat(i.length):"userIDList:".concat(i)),r=(A.l("".concat(n," groupID:").concat(o," userIDList:"),i),new M("deleteGroupMember"));return r.setMessage(s),this._grpM.req({proto:v.DEL_GRP_MBR,data:e}).then(function(){return r.end(),A.l("".concat(n," ok")),t._updateConversationGroupProfile(a),t.deleteLocalGroupMembers(o,i),yn({group:a,userIDList:i})}).catch(function(e){return r.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"_updateConversationGroupProfile",value:function(e){this._grpM.get(11).updateConversationGroupProfile([e])}},{key:"_banAVChatRoomMember",value:function(e){var t=this,n="".concat(this._n,".").concat("_banAVChatRoomMember"),o=e.groupID,i=e.userIDList,a="groupID:".concat(o," ").concat(5<i.length?"userIDList.length:".concat(i.length):"userIDList:".concat(i)),s=new M("_banAVChatRoomMember"),r=(s.setMessage(a),A.l("".concat(n," groupID:").concat(o," userIDList:"),i),this._grpM.getLocalGroupProfile(o));return k(e.duration)||0===e.duration?m({code:C.BAN_DURATION_INVALID}):this._grpM.req({proto:v.BAN_AV_MBR,data:e}).then(function(){return s.end(),A.l("".concat(n," ok")),t.deleteLocalGroupMembers(o,i),yn({group:r,userIDList:i})}).catch(function(e){return s.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"setGroupMemberMuteTime",value:function(e){var n=this,o=e.groupID,t=e.userID,e=e.muteTime,i="".concat(this._n,".").concat("setGroupMemberMuteTime");if(t===this._grpM.getMyUserID())return m({code:C.CANNOT_MUTE_SELF});var a="groupID:".concat(o," userID:").concat(t," muteTime:").concat(e),s=(A.l("".concat(i," ").concat(a)),new M("setGroupMemberMuteTime"));return s.setMessage(a),this.modifyGroupMemberInfo({groupID:o,userID:t,muteTime:e}).then(function(e){s.end(),A.l("".concat(i," ok"));var t=n._grpM.getLocalGroupProfile(o);return yn({group:t,member:e})}).catch(function(e){return s.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"setGroupMemberRole",value:function(e){var t="".concat(this._n,".").concat("setGroupMemberRole"),n=e.groupID,o=e.userID,e=e.role,i="groupID:".concat(n," userID:").concat(o," role:").concat(e),a=this._grpM.getLocalGroupProfile(n);if(!a||a.type===S.GRP_WORK||a.type===S.GRP_AVCHATROOM)return m({code:C.CANNOT_SET_MEMBER_ROLE_IN_WORK_AND_AVCHATROOM});if(a&&a.selfInfo.role!==S.GRP_MBR_ROLE_OWNER)return m({code:C.NOT_OWNER});var s=[S.GRP_MBR_ROLE_ADMIN,S.GRP_MBR_ROLE_MEMBER];if(Dt({groupID:n})&&s.push(S.GRP_MBR_ROLE_CUSTOM),s.indexOf(e)<0)return m({code:C.INVALID_MEMBER_ROLE});if(o===this._grpM.getMyUserID())return m({code:C.CANNOT_SET_SELF_MEMBER_ROLE});var r=new M("setGroupMemberRole");return r.setMessage(i),A.l("".concat(t," ").concat(i)),this.modifyGroupMemberInfo({groupID:n,userID:o,role:e}).then(function(e){return r.end(),A.l("".concat(t," ok")),yn({group:a,member:e})}).catch(function(e){return r.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"_filterProfanity",value:function(e,t){var n=this._grpM.get(29);if(!n)return!0;var n=n.filterText(t[e],"group_member_profile"),o=n.isAllowedToSend,n=n.modifiedText;return!0===o&&(t[e]=n,!0)}},{key:"setGroupMemberNameCard",value:function(e){var n=this,t="setGroupMemberNameCard",o="".concat(this._n,".").concat(t);if(e.nameCard&&!1===this._filterProfanity("nameCard",e))return m({code:C.PROFANITY_FOUND});var i=e.groupID,a=e.userID,s=void 0===a?this._grpM.getMyUserID():a,r=e.nameCard,a="groupID:".concat(i," userID:").concat(s," nameCard:").concat(r),e=(A.l("".concat(o," ").concat(a)),this._grpM.getLocalGroupProfile(i));if(e&&Tt(e.type))return m({code:e=C.OPERATION_NOT_SUPPORTED_IN_AVCHATROOM,message:this._grpM.getErrorMessage(e,t)});var c=new M(t);return c.setMessage(a),this.modifyGroupMemberInfo({groupID:i,userID:s,nameCard:r}).then(function(e){A.l("".concat(o," ok")),c.end();var t=n._grpM.getLocalGroupProfile(i);return s===n._grpM.getMyUserID()&&t&&t.setSelfNameCard(r),yn({group:t,member:e})}).catch(function(e){return c.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"setGroupMemberCustomField",value:function(e){var n=this,t="setGroupMemberCustomField",o="".concat(this._n,".").concat(t),i=e.groupID,a=e.userID,a=void 0===a?this._grpM.getMyUserID():a,e=e.memberCustomField,s="groupID:".concat(i," userID:").concat(a," memberCustomField:").concat(JSON.stringify(e)),r=(A.l("".concat(o," ").concat(s)),this._grpM.getLocalGroupProfile(i));if(r&&Tt(r.type))return m({code:r=C.OPERATION_NOT_SUPPORTED_IN_AVCHATROOM,message:this._grpM.getErrorMessage(r,t)});var c=new M(t);return c.setMessage(s),this.modifyGroupMemberInfo({groupID:i,userID:a,memberCustomField:e}).then(function(e){c.end(),A.l("".concat(o," ok"));var t=n._grpM.getLocalGroupProfile(i);return yn({group:t,member:e})}).catch(function(e){return c.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"modifyGroupMemberInfo",value:function(t){var n=this,o=t.groupID,i=t.userID,e=void 0;return Et(o)&&(o=xt(e=o)),this._grpM.req({proto:v.MODIFY_GRP_MBR_INFO,data:y(y({},t),{},{groupID:o,topicID:e})}).then(function(){if(n.hasLocalGroupMember(o,i))return e=n.getLocalGroupMemberInfo(o,i),k(t.muteTime)||e.updateMuteUntil(t.muteTime),k(t.role)||e.updateRole(t.role),k(t.nameCard)||e.updateNameCard(t.nameCard),k(t.memberCustomField)||e.updateMemberCustomField(t.memberCustomField),e;var e=n._grpM.getLocalGroupProfile(o);return e&&!Tt(e.type)?n.getGroupMemberProfile({groupID:o,userIDList:[i]}).then(function(e){return I(e.data.memberList,1)[0]}):void 0})}},{key:"markGroupMemberList",value:function(e){var o="".concat(this._n,".").concat("markGroupMemberList"),t=e.groupID,n=e.markType,i=e.enableMark,e=e.userIDList,a=void 0===e?[]:e,e="groupID:".concat(t," markType:").concat(n," enableMark:").concat(i," userIDList count:").concat(a.length),s=(A.l("".concat(o," ").concat(e)),2),r=[],i=(!0===i&&(s=1),T(a)),c=(500<a.length&&(i=a.slice(0,500),A.w("".concat(o," ").concat(Wt(500)))),i.forEach(function(e){r.push({userID:e,markType:[n]})}),i=null,new M("markGroupMemberList"));return c.setMessage(e),this._grpM.req({proto:v.MARK_AV_MBR_INFO,data:{groupID:t,operationType:s,memberList:r}}).then(function(e){var e=e.data.memberList,e=void 0===e?[]:e,t=[],n=[],e=(e.length===a.length?t.push.apply(t,T(a)):(e.forEach(function(e){t.push(e.userID)}),a.forEach(function(e){t.includes(e)||n.push(e)})),"success count:".concat(t.length," fail count:").concat(n.length));return c.setMessage(e).end(),A.l("".concat(o," ok. ").concat(e)),yn({successUserIDList:t,failureUserIDList:n})}).catch(function(e){return c.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"_getGroupMemberProfileAdvance",value:function(e){return this._grpM.req({proto:v.GET_GRP_MBR_PROFILE,data:y(y({},e),{},{memberInfoFilter:e.memberInfoFilter||this.DEFAULT_MEMBER_INFO_FILTER})})}},{key:"_updateLocalGroupMemberMap",value:function(t,e){var n=this;return Qe(e)&&0!==e.length?e.map(function(e){return n.hasLocalGroupMember(t,e.userID)?n.getLocalGroupMemberInfo(t,e.userID).updateMember(e):n.setLocalGroupMember(t,new pi(e)),n.getLocalGroupMemberInfo(t,e.userID)}):[]}},{key:"deleteLocalGroupMembers",value:function(e,t){var n=this.groupMemberListMap.get(e);n&&t.forEach(function(e){n.delete(e)})}},{key:"getLocalGroupMemberInfo",value:function(e,t){return this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).get(t):null}},{key:"setLocalGroupMember",value:function(e,t){this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).set(t.userID,t):(t=(new Map).set(t.userID,t),this.groupMemberListMap.set(e,t))}},{key:"getLocalGroupMemberList",value:function(e){return this.groupMemberListMap.get(e)}},{key:"hasLocalGroupMember",value:function(e,t){return this.groupMemberListMap.has(e)&&this.groupMemberListMap.get(e).has(t)}},{key:"hasLocalGroupMemberMap",value:function(e){return this.groupMemberListMap.has(e)}},{key:"reset",value:function(){this.groupMemberListMap.clear()}}]),wi),gi=(e(Fi,[{key:"onNewGroupSystemNotice",value:function(e){var t=e.dataList,n=e.isSyncingEnded,e=e.isInstantMessage,t=(A.d("".concat(this._n,".onReceiveSystemNotice count:").concat(t.length)),this.newSystemNoticeStoredAndSummary({notifiesList:t,isInstantMessage:e})),o=t.eventDataList,t=t.result;0<o.length&&(this._grpM.get(11).onNewMessage({conversationOptionsList:o,isInstantMessage:e}),this._onReceivedGroupSystemNotice({result:t,isInstantMessage:e})),e?0<t.length&&this._grpM.emitOuterEvent(G.MESSAGE_RECEIVED,t):!0===n&&this._clearGroupSystemNotice()}},{key:"newSystemNoticeStoredAndSummary",value:function(e){for(var t=e.notifiesList,l=e.isInstantMessage,n=null,d=t.length,o=0,i=[],a={conversationID:S.CONV_SYSTEM,unreadCount:0,type:S.CONV_SYSTEM,subType:null,lastMessage:null},o=0;o<d;o++){var s=t[o],r=s.groupProfile,p=r.communityType,r=r.topicID,r=void 0===r?void 0:r,c=s.elements,u=c.topicIDList,u=void 0===u?void 0:u,c=c.operationType;if(!(2!==(void 0===p?0:p)||We(r)&&We(u))){if([17,18,20].includes(c)){this._handleTopicSystemNotice(s);continue}We(r)||(s.to=r)}15!==s.elements.operationType&&(s.currentUser=this._grpM.getMyUserID(),s.conversationType=S.CONV_SYSTEM,s.conversationID=S.CONV_SYSTEM,(n=new go(s)).setElement({type:S.MSG_GRP_SYS_NOTICE,content:y(y({},s.elements),{},{groupProfile:y({},s.groupProfile)})}),n.isSystemMessage=!0,(1===n.sequence&&1===n.random||2===n.sequence&&2===n.random)&&(n.sequence=st(),n.random=st(),n.generateMessageID(),A.l("".concat(this._n,".newSystemNoticeStoredAndSummary sequence and random maybe duplicated, regenerate. ID:").concat(n.ID))),this._grpM.get(11).pushIntoNoticeResult(i,n)&&(l?a.unreadCount++:n.setIsRead(!0),a.subType=n.conversationSubType))}return a.lastMessage=i[i.length-1],{eventDataList:0<i.length?[a]:[],result:i}}},{key:"_clearGroupSystemNotice",value:function(){var a=this;this._getPendencyList().then(function(e){e.forEach(function(e){a.pendencyMap.set("".concat(e.from,"_").concat(e.groupID,"_").concat(e.to),e)});var e=a._grpM.get(11).getLocalMessageList(S.CONV_SYSTEM),i=[];e.forEach(function(e){var t=e.payload,n=t.operatorID,o=t.operationType,t=t.groupProfile;1===o&&(o="".concat(n,"_").concat(t.groupID,"_").concat(t.to),(n=a.pendencyMap.get(o))&&ze(n.handled)&&0!==n.handled&&i.push(e))}),a.deleteGroupSystemNotice({messageList:i})})}},{key:"deleteGroupSystemNotice",value:function(e){var n=this,o="".concat(this._n,".deleteGroupSystemNotice");return Qe(e.messageList)&&0!==e.messageList.length?(A.l("".concat(o," ")+e.messageList.map(function(e){return e.ID})),this._grpM.req({proto:v.DEL_GRP_SYSTEM_NOTICE,data:{messageListToDelete:e.messageList.map(function(e){return{from:S.CONV_SYSTEM,messageSeq:e.clientSequence,messageRandom:e.random}})}}).then(function(){A.l("".concat(o," ok"));var t=n._grpM.get(11);return e.messageList.forEach(function(e){t.deleteLocalMessage(e)}),yn()}).catch(function(e){return A.e("".concat(o," error:"),e),m(e)})):Cn()}},{key:"_getPendencyList",value:function(){var n=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.type,o=e.startTime,e=e.limit;return this._grpM.req({proto:v.GET_GRP_PENDENCY,data:{type:void 0===t?void 0:t,startTime:void 0===o?0:o,limit:void 0===e?20:e,handleAccount:this._grpM.getMyUserID()}}).then(function(e){var t=e.data.pendencyList;return 0!==e.data.nextStartTime?n._getPendencyList({startTime:e.data.nextStartTime}).then(function(e){return[].concat(T(t),T(e))}):t})}},{key:"getGroupApplicationList",value:function(){var n=this;return this._getPendencyList().then(function(t){return n._getPendencyList({type:S.GRP_COMMUNITY}).then(function(e){return t.push.apply(t,T(e)),n._handlePendencyResult(t)}).catch(function(e){return n._handlePendencyResult(t)})})}},{key:"_handlePendencyResult",value:function(e){var t=this,n=[];return e.forEach(function(e){t.pendencyMap.set("".concat(e.from,"_").concat(e.groupID,"_").concat(e.to),e),0===e.handled&&n.push({applicant:e.from,applicantNick:e.fromUserNickName,groupName:e.groupName,groupID:e.groupID,authentication:e.authentication,messageKey:e.time,applicationType:e.applicationType,userID:e.userID,note:e.note})}),Cn({applicationList:n})}},{key:"_onReceivedGroupSystemNotice",value:function(e){var t=this,n=e.result;e.isInstantMessage&&n.forEach(function(e){switch(e.payload.operationType){case 1:break;case 2:t._onApplyJoinGroup(e);break;case 3:break;case 4:t._onMemberKicked(e);break;case 5:t._onGroupDismissed(e);break;case 6:break;case 7:t._onInviteGroup(e);break;case 8:t._onQuitGroup(e);break;case 9:t._onSetManager(e);break;case 10:t._onDeleteManager(e);break;case 11:case 12:case 15:break;case 20:t._onMessageRemindTypeSynced(e);break;case 21:t._grpM.onAVChatRoomMemberBanned(e)}})}},{key:"_onApplyJoinGroup",value:function(e){var t=this,e=e.payload.groupProfile,n=e.groupID,e=e.groupType,o=this._grpM.hasLocalGroup(n);A.l("".concat(this._n,"._onApplyJoinGroup groupID:").concat(n," groupType:").concat(e," hasGroup:").concat(o)),o||Tt(e)||this._grpM.getGroupProfile({groupID:n}).then(function(e){var e=e.data.group;e&&(t._grpM.updateGroupMap([e]),e=!e.isSupportTopic,t._grpM.emitGroupListUpdate(!0,e))})}},{key:"_onMemberKicked",value:function(e){e=e.payload.groupProfile.groupID;this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e)}},{key:"_onGroupDismissed",value:function(e){var e=e.payload.groupProfile.groupID,t=(this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e),this._grpM._AVChatRoomHandler);t&&t.checkJoinedAVChatRoomByID(e)&&t.reset(e)}},{key:"_onInviteGroup",value:function(e){var t=this,n=e.payload.groupProfile.groupID,e=this._grpM.hasLocalGroup(n);A.l("".concat(this._n,"._onInviteGroup groupID:").concat(n," hasGroup:").concat(e)),this._grpM.getGroupProfile({groupID:n}).then(function(){t._grpM.emitGroupListUpdate(),t._grpM.get(11).recoverMessageOnInviteGroup("".concat(S.CONV_GROUP).concat(n))})}},{key:"_onQuitGroup",value:function(e){var e=e.payload.groupProfile,t=e.groupID,e=e.groupType,n=this._grpM.hasLocalGroup(t);A.l("".concat(this._n,"._onQuitGroup groupID:").concat(t," groupType:").concat(e," hasGroup:").concat(n)),n&&this._grpM.deleteLocalGroupAndConversation(t)}},{key:"_onSetManager",value:function(e){var e=e.payload.groupProfile,t=e.to,e=e.groupID,e=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(e,t);e&&e.updateRole(S.GRP_MBR_ROLE_ADMIN)}},{key:"_onDeleteManager",value:function(e){var e=e.payload.groupProfile,t=e.to,e=e.groupID,e=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(e,t);e&&e.updateRole(S.GRP_MBR_ROLE_MEMBER)}},{key:"_onMessageRemindTypeSynced",value:function(e){var t=e.payload.groupProfile.groupID,e=e.payload.messageRemindType;this._grpM.get(11).onGroupMessageRemindTypeUpdated({groupID:t,messageRemindType:e})}},{key:"_handleTopicSystemNotice",value:function(e){var t=e.groupProfile,n=t.groupID,t=t.topicID,e=e.elements,o=e.operationType,i=e.topicIDList,e=e.messageRemindType,a=this._grpM.get(10);17===o?a.onTopicCreated({groupID:n,topicID:t}):18===o?a.onTopicDeleted({groupID:n,topicIDList:i}):20===o&&a.onTopicMessageRemindTypeUpdated({groupID:n,topicID:t,messageRemindType:e})}},{key:"reset",value:function(){this.pendencyMap.clear()}}]),Fi),hi=["relayFlag"],fi=(t(bi,Nn),Wo=f(bi),e(bi,[{key:"_onCloudConfigUpdated",value:function(){var e=this.getCloudConfig("polling_interval"),t=this.getCloudConfig("polling_interval_plus"),n=this.getCloudConfig("polling_no_msg_count"),o=this.getCloudConfig("polling_simplified_msg"),i=this.getCloudConfig("paging_grp_count");A.l("".concat(this._n,"._onCloudConfigUpdated pollingInterval:").concat(e)+" pollingIntervalPlus:".concat(t," pollingNoMessageCount:").concat(n)+" pollingSimplifiedMessage:".concat(o," pagingGroupCount:").concat(i)),this._AVChatRoomHandler.setPollingInterval(e),this._AVChatRoomHandler.setPollingIntervalPlus(t),this._AVChatRoomHandler.setPollingNoMessageCount(n),this._AVChatRoomHandler.setPollingSimplifiedMessage(o),this._commonGroupHandler.setPagingGroupCount(i)}},{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&(this._commonGroupHandler.onCheckTimer(e),this._groupTipsHandler.onCheckTimer(e))}},{key:"guardForAVChatRoom",value:function(t){var n,o=this;return t.conversationType===S.CONV_GROUP?(n=Et(t.to)?xt(t.to):t.to,this.hasLocalGroup(n)?Cn():this.getGroupProfile({groupID:n}).then(function(e){var e=e.data.group.type;return A.l("".concat(o._n,".guardForAVChatRoom. groupID:").concat(n," type:").concat(e)),e===S.GRP_AVCHATROOM?m(new bn({code:e=C.MSG_SEND_FAIL_NOT_IN_AVCHATROOM,message:o.getErrorMessage(e,t.from,n),data:{message:t}})):Cn()})):Cn()}},{key:"checkJoinedAVChatRoomByID",value:function(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}},{key:"onNewGroupMessage",value:function(e){this._commonGroupHandler.onNewGroupMessage(e)}},{key:"updateNextMessageSeq",value:function(e){var n,o=this;Qe(e)&&(n=this.get(10),e.forEach(function(e){var t=e.conversationID.replace(S.CONV_GROUP,"");Et(t)&&n.updateLastMessage(t,e.lastMessage),o.groupMap.has(t)&&(o.groupMap.get(t).nextMessageSeq=e.lastMessage.sequence+1)}))}},{key:"onNewGroupTips",value:function(e){this._groupTipsHandler.onNewGroupTips(e)}},{key:"onGroupMessageRevoked",value:function(e){this._commonGroupHandler.onGroupMessageRevoked(e)}},{key:"onNewGroupSystemNotice",value:function(e){this._groupSystemNoticeHandler.onNewGroupSystemNotice(e)}},{key:"onGroupMessageReadNotice",value:function(e){var a=this;e.dataList.forEach(function(e){var i,e=e.elements.groupMessageReadNotice;k(e)||(i=a.get(11),e.forEach(function(e){var t=e.groupID,n=e.topicID,n=void 0===n?void 0:n,e=e.lastMessageSeq,t=(A.d("".concat(a._n,".onGroupMessageReadNotice groupID:").concat(t," lastMessageSeq:").concat(e)),"".concat(S.CONV_GROUP).concat(t)),o=!0;We(n)||(t="".concat(S.CONV_GROUP).concat(n),o=!1),i.updateIsReadAfterReadReport({conversationID:t,lastMessageSeq:e}),i.updateUnreadCount(t,o),i.clearGroupAtInfoList(t,o)}))})}},{key:"onReadReceiptList",value:function(e){var o=this;A.d("".concat(this._n,".onReadReceiptList options:"),JSON.stringify(e)),e.dataList.forEach(function(e){var t=e.groupProfile,e=e.elements,t=t.groupID,n=o.get(11),e=e.readReceiptList;n.updateReadReceiptInfo({groupID:t,readReceiptList:e})})}},{key:"onGroupMessageModified",value:function(e){A.d("".concat(this._n,".onGroupMessageModified options:"),JSON.stringify(e));var t=this.get(11);e.dataList.forEach(function(e){t.onMessageModified(y(y({},e),{},{conversationType:S.CONV_GROUP,to:e.topicID||e.groupID}))})}},{key:"deleteGroupSystemNotice",value:function(e){this._groupSystemNoticeHandler.deleteGroupSystemNotice(e)}},{key:"initGroupMap",value:function(e){this.groupMap.set(e.groupID,new $o(e))}},{key:"clearGroupMap",value:function(){this.groupMap.clear()}},{key:"deleteGroup",value:function(e){this.groupMap.delete(e)}},{key:"updateGroupMap",value:function(e){var t,n=this,o=this.get(11);e.forEach(function(e){t=e.groupID,n.groupMap.has(t)?n.groupMap.get(t).updateGroup(e):(n.groupMap.set(t,new $o(e)),o.deleteGroupRoamingMessageInfo(t))});var i,a=this.getMyUserID(),s=N(this.groupMap);try{for(s.s();!(i=s.n()).done;){var r=I(i.value,2)[1];r.selfInfo.userID=a,"Owner"===r.selfInfo.role&&(r.ownerID=a)}}catch(e){s.e(e)}finally{s.f()}}},{key:"getGroupMap",value:function(){return this.groupMap}},{key:"getLocalGroupList",value:function(){return T(this.groupMap.values()).filter(function(e){return e.type!==S.GRP_ROOM&&e.type!==S.GRP_LIVE})}},{key:"getLocalGroupProfile",value:function(e){return this.groupMap.get(e)}},{key:"sortLocalGroupList",value:function(){var e=T(this.groupMap).filter(function(e){e=I(e,2);return e[0],!We(e[1].lastMessage)});e.sort(function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime}),this.groupMap=new Map(T(e))}},{key:"updateGroupLastMessage",value:function(e){this._commonGroupHandler.handleUpdateGroupLastMessage(e)}},{key:"emitGroupListUpdate",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this.getLocalGroupList();e&&this.emitOuterEvent(G.GROUP_LIST_UPDATED),t&&(e=JSON.parse(JSON.stringify(n)),this.get(11).updateConversationGroupProfile(e))}},{key:"getMyNameCardByGroupID",value:function(e){e=this.getLocalGroupProfile(e);return e?e.selfInfo.nameCard:""}},{key:"isPagingGetCompleted",value:function(){return this._commonGroupHandler.isPagingGetCompleted()}},{key:"getMessageRemindType",value:function(e){var n=this;!Qe(e)||0===e.length||0!==(e=e.filter(function(e){return!Tt(n.getLocalGroupProfile(e).type)})).length&&(A.l("".concat(this._n,".getMessageRemindType groupIDList:").concat(e)),this.getGroupProfileAdvance({groupIDList:e,responseFilter:{memberInfoFilter:["MsgFlag"]}}).then(function(e){var e=e.data.successGroupList,t=n.get(11);e.forEach(function(e){t.onGroupMessageRemindTypeUpdated({groupID:e.groupID,messageRemindType:Qe(e.members)?e.members[0].messageRemindType:""})})}))}},{key:"getGroupList",value:function(){return this._commonGroupHandler.getGroupList()}},{key:"syncCommunityWithTopic",value:function(){return this._commonGroupHandler.syncGroupList(!0)}},{key:"getGroupProfile",value:function(t){var n=this,o="".concat(this._n,".").concat("getGroupProfile"),i=new M("getGroupProfile"),a=t.groupID,e=t.groupCustomFieldFilter;return A.l("".concat(o," groupID:").concat(a)),this.getGroupProfileAdvance({groupIDList:[a],responseFilter:{groupBaseInfoFilter:["Type","Name","Introduction","Notification","FaceUrl","Owner_Account","CreateTime","InfoSeq","LastInfoTime","LastMsgTime","MemberNum","MaxMemberNum","ApplyJoinOption","NextMsgSeq","ShutUpAllMember","InviteJoinOption"],groupCustomFieldFilter:e,memberInfoFilter:["Role","JoinTime","MsgSeq","MsgFlag","NameCard"]}}).then(function(e){var e=e.data,t=e.successGroupList,e=e.failureGroupList;return A.l("".concat(o," ok")),0<e.length?m(e[0]):((e=Tt(t[0].type)&&!n.hasLocalGroup(a)?new $o(t[0]):(n.updateGroupMap(t),n.getLocalGroupProfile(a))).isSupportTopic||n.get(11).updateConversationGroupProfile([e]),i.setMessage("groupID:".concat(a," type:").concat(e.type," muteAllMembers:").concat(e.muteAllMembers," ownerID:").concat(e.ownerID)).end(),yn({group:e}))}).catch(function(e){return i.setError(e).setMessage("groupID:".concat(t.groupID)).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"getGroupProfileAdvance",value:function(e){var t,n="".concat(this._n,".getGroupProfileAdvance"),o=e.groupIDList,i=(Qe(o)&&50<o.length&&(this.outputWarning("GetGroupProfileLimit"),o.length=50),[]),a=[],o=(o.forEach(function(e){(Dt({groupID:e})?a:i).push(e)}),[]);return 0<i.length&&(t=this._getGroupProfileAdvance(y(y({},e),{},{groupIDList:i})),o.push(t)),0<a.length&&(t=this._getGroupProfileAdvance(y(y({},e),{},{groupIDList:a,relayFlag:0<i.length})),o.push(t)),Promise.all(o).then(function(e){var t=[],n=[];return e.forEach(function(e){t.push.apply(t,T(e.successGroupList)),n.push.apply(n,T(e.failureGroupList))}),yn({successGroupList:t,failureGroupList:n})}).catch(function(e){return A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"_getGroupProfileAdvance",value:function(t){var n=this,e=t.relayFlag,o=void 0!==e&&e,i=h(t,hi);return this.req({proto:v.GET_GRP_PROFILE,data:i}).then(function(e){A.l("".concat(n._n,"._getGroupProfileAdvance ok. options:"),i);e=e.data.groups;return{successGroupList:e.filter(function(e){return k(e.errorCode)||0===e.errorCode}),failureGroupList:e.filter(function(e){return e.errorCode&&0!==e.errorCode}).map(function(e){return new bn({code:e.errorCode,message:e.errorInfo,data:{groupID:e.groupID}})})}}).catch(function(e){return o&&Dt({groupID:t.groupIDList[0]})?{successGroupList:[],failureGroupList:[]}:m(e)})}},{key:"createGroup",value:function(s){var r=this,e=[S.GRP_PUBLIC,S.GRP_WORK,S.GRP_MEETING,S.GRP_AVCHATROOM,S.GRP_COMMUNITY],c="".concat(this._n,".").concat("createGroup"),t=s.type,n=s.groupID;if(s.name&&!1===this._filterProfanity("name",s))return m({code:C.PROFANITY_FOUND});if(s.introduction&&!1===this._filterProfanity("introduction",s))return m({code:C.PROFANITY_FOUND});if(s.notification&&!1===this._filterProfanity("notification",s))return m({code:C.PROFANITY_FOUND});if(!e.includes(t))return m({code:C.ILLEGAL_GRP_TYPE});if(!Dt({type:t})){if(!We(n)&&Dt({groupID:n}))return m({code:C.ILLEGAL_GRP_ID});s.isSupportTopic=void 0}if(Tt(t)&&!k(s.memberList)&&0<s.memberList.length&&(s.memberList=void 0),this._canIUseJoinOption(t)||k(s.joinOption)||(s.joinOption=void 0),Dt({type:t})){if(!We(n)&&!Dt({groupID:n}))return m({code:C.ILLEGAL_GRP_ID});s.isSupportTopic=!0===s.isSupportTopic?1:0}var u=new M("createGroup"),l=(A.l("".concat(c," options:"),s),null),d=[];return this.req({proto:v.CREATE_GRP,data:y(y({},s),{},{ownerID:this.getMyUserID(),webPushFlag:1})}).then(function(e){var e=e.data,t=e.groupID,e=e.overLimitUserIDList,n=void 0===e?[]:e,e=(l=t,d=n,"groupType:".concat(s.type," groupID:").concat(t," overLimitUserIDList:").concat(n));if(u.setMessage(e).end(),A.l("".concat(c," ok. ").concat(e)),s.type===S.GRP_AVCHATROOM)return r.getGroupProfile({groupID:t});if(s.type===S.GRP_COMMUNITY&&1===s.isSupportTopic)return r.getGroupProfile({groupID:t});We(s.memberList)||We(n)||(s.memberList=s.memberList.filter(function(e){return-1===n.indexOf(e.userID)})),r.updateGroupMap([y(y({},s),{},{groupID:t})]);var e=r.get(2),o="",i=0,a=(s.type===S.GRP_COMMUNITY?(o=r.isIntl()?"Create Community":"创建社群",i=1):o=r.isIntl()?"Create Group":"创建群组",r.get(4).getMyNick()),o=e.createCustomMessage({to:t,conversationType:S.CONV_GROUP,payload:{data:JSON.stringify({businessID:"group_create",content:o,cmd:i,opUser:a||r.getMyUserID(),version:4})}});return e.sendMessageInstance(o),r.emitGroupListUpdate(),r.getGroupProfile({groupID:t})}).then(function(e){var e=e.data.group,t=e.selfInfo,n=t.nameCard,t=t.joinTime;return e.updateSelfInfo({nameCard:n,joinTime:t,messageRemindType:S.MSG_REMIND_ACPT_AND_NOTE,role:S.GRP_MBR_ROLE_OWNER}),yn({group:e,overLimitUserIDList:d})}).catch(function(e){var t;return u.setMessage("groupType:".concat(s.type)).setError(e).end(),10010===e.code||10007===e.code?(r._silentlyGetGroupProfile(e.code,l),r.updateGroupMap([y(y({},s),{},{groupID:l})]),(t=r.getLocalGroupProfile(l)).selfInfo.role=S.GRP_MBR_ROLE_OWNER,yn({group:t,overLimitUserIDList:d})):(A.e("".concat(c," failed. error:"),e),m(e))})}},{key:"dismissGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("dismissGroup"),o="groupID:".concat(e);if(this.hasLocalGroup(e)&&this.getLocalGroupProfile(e).type===S.GRP_WORK)return m(new bn({code:C.CANNOT_DISMISS_WORK}));var i=new M("dismissGroup");return i.setMessage(o),A.l("".concat(n," ").concat(o)),this.req({proto:v.DISMISS_GRP,data:{groupID:e}}).then(function(){return i.end(),A.l("".concat(n," ok")),t.deleteLocalGroupAndConversation(e),t.checkJoinedAVChatRoomByID(e)&&t._AVChatRoomHandler.reset(e),t._groupAttributesHandler.deleteLocalGroupAttributes(e),yn({groupID:e})}).catch(function(e){return i.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"updateGroupProfile",value:function(e){var t,n=this,o="".concat(this._n,".").concat("updateGroupProfile");if(this.hasLocalGroup(e.groupID)&&(t=this.getLocalGroupProfile(e.groupID).type,this._canIUseJoinOption(t)||k(e.joinOption)||(A.w("".concat(o," joinOption is unavailable for Work/Meeting/AVChatRoom")),e.joinOption=void 0)),k(e.muteAllMembers)||(e.muteAllMembers?e.muteAllMembers="On":e.muteAllMembers="Off"),e.name&&!1===this._filterProfanity("name",e))return m({code:C.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return m({code:C.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return m({code:C.PROFANITY_FOUND});var i=new M("updateGroupProfile");return i.setMessage(JSON.stringify(e)),A.l("".concat(o," groupID:").concat(e.groupID)),this.req({proto:v.UPDATE_GRP_PROFILE,data:e}).then(function(){return i.end(),A.l("".concat(o," ok")),n.hasLocalGroup(e.groupID)&&n.groupMap.get(e.groupID).updateGroup(e),yn({group:n.groupMap.get(e.groupID)})}).catch(function(e){return i.setError(e).end(),A.l("".concat(o," failed. error:"),e),m(e)})}},{key:"_filterProfanity",value:function(e,t){var n=this.get(29);if(!n)return!0;var n=n.filterText(t[e],B),o=n.isAllowedToSend,n=n.modifiedText;return!0===o&&(t[e]=n,!0)}},{key:"joinGroup",value:function(t){var n=this,o=t.groupID,e=t.type,i="".concat(this._n,".joinGroup");if(e===S.GRP_WORK)return m({code:C.CANNOT_JOIN_WORK});if(this.deleteUnjoinedAVChatRoom(o),this.hasLocalGroup(o)){if(!this.isLoggedIn())return Cn({status:S.JOIN_STATUS_ALREADY_IN_GROUP});var a=new M("applyJoinGroup");return this.getGroupProfile({groupID:o}).then(function(){return a.setMessage("groupID:".concat(o," joinedStatus:").concat(S.JOIN_STATUS_ALREADY_IN_GROUP)).end(),Cn({status:S.JOIN_STATUS_ALREADY_IN_GROUP})}).catch(function(e){return a.setMessage("groupID:".concat(o," unjoined")).end(),A.w("".concat(i," ").concat(o," was unjoined, now join!")),n.groupMap.delete(o),n.applyJoinGroup(t)})}return A.l("".concat(i," groupID:").concat(o)),this.isLoggedIn()?this.applyJoinGroup(t):this._AVChatRoomHandler.joinWithoutAuth(t)}},{key:"applyJoinGroup",value:function(e){var c=this,u="".concat(this._n,".").concat("applyJoinGroup"),l=e.groupID;if(!We(e.applyMessage)&&!1===this._filterProfanity("applyMessage",e))return m({code:C.PROFANITY_FOUND});var d=new M("applyJoinGroup"),e=y({},e),p=this.canIUse(H.AV_HISTORY_MSG);return p&&(e.historyMessageFlag=1),this.get(11).deleteTopicRoamingMessageInfo(l),this.req({proto:v.APPLY_JOIN_GRP,data:e}).then(function(e){var e=e.data,t=e.joinedStatus,n=e.longPollingKey,o=e.startSeq,i=e.avChatRoomFlag,a=e.avChatRoomKey,s=e.messageList,e="groupID:".concat(l," joinedStatus:").concat(t," longPollingKey:").concat(n," startSeq:").concat(o)+" avChatRoomFlag:".concat(i," canGetAVChatRoomHistoryMessage:").concat(p,",")+" history message count:".concat(We(s)?0:s.length);switch(d.setMessage(e).end(),A.l("".concat(u," ok. ").concat(e)),t){case He:return yn({status:He});case Ve:return c.getGroupProfile({groupID:l}).then(function(e){e=e.data.group;return c._handleJoinResult({group:e,avChatRoomFlag:i,longPollingKey:n,startSeq:o,avChatRoomKey:a,messageList:s})}).catch(function(e){var t;return 10010===e.code||10007===e.code?(c._silentlyGetGroupProfile(e.code,l),t=new $o({groupID:l}),c.updateGroupMap([t]),c._handleJoinResult({group:t,avChatRoomFlag:i,longPollingKey:n,startSeq:o,avChatRoomKey:a,messageList:s})):(A.e("".concat(u," failed. error:"),e),m(e))});default:var r=new bn({code:C.JOIN_GRP_FAIL});return A.e("".concat(u," failed. error:"),r),m(r)}}).catch(function(e){return d.setMessage("groupID:".concat(l)).setError(e).end(),A.e("".concat(u," failed. error:"),e),m(e)})}},{key:"_handleJoinResult",value:function(e){var t=this,n=e.group,o=e.avChatRoomFlag,i=e.longPollingKey,a=e.startSeq,s=e.avChatRoomKey,r=e.messageList,c=n.groupID;return 1===o?(this.get(11).setCompleted("".concat(S.CONV_GROUP).concat(c)),this._groupAttributesHandler.initGroupAttributesCache({groupID:c,avChatRoomKey:s}),this._groupCountersHandler.initGroupCountersCache({groupID:c,avChatRoomKey:s}),(e=k(i)?this._AVChatRoomHandler.handleJoinResult({group:n}):this._AVChatRoomHandler.startRunLoop({group:n,longPollingKey:i,startSeq:a})).then(function(){t._onAVChatRoomHistoryMessage(r,c)}),e):(this.emitGroupListUpdate(!0,!1),yn({status:Ve,group:n}))}},{key:"quitGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("quitGroup"),o="groupID:".concat(e),i=(A.l("".concat(n," ").concat(o)),this.checkJoinedAVChatRoomByID(e));if(!i&&!this.hasLocalGroup(e))return m({code:C.MEMBER_NOT_IN_GRP});if(i&&!this.isLoggedIn())return A.l("".concat(n," anonymously ok. ").concat(o)),this.deleteLocalGroupAndConversation(e),this._AVChatRoomHandler.reset(e),Cn({groupID:e});var a=new M("quitGroup");return a.setMessage(o),this.req({proto:v.QUIT_GRP,data:{groupID:e}}).then(function(){return a.end(),A.l("".concat(n," ok")),t.deleteLocalGroupAndConversation(e),i&&t._AVChatRoomHandler.reset(e),t._groupAttributesHandler.deleteLocalGroupAttributes(e),yn({groupID:e})}).catch(function(e){return a.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"searchGroupByID",value:function(e){var t="".concat(this._n,".").concat("searchGroupByID"),n={groupIDList:[e]},o=new M("searchGroupByID");return o.setMessage("groupID:".concat(e)),A.l("".concat(t," groupID:").concat(e)),this.req({proto:v.SEARCH_GRP,data:n}).then(function(e){e=e.data.groupProfile;if(0!==e[0].errorCode)throw new bn({code:e[0].errorCode,message:e[0].errorInfo});return o.end(),A.l("".concat(t," ok")),yn({group:new $o(e[0])})}).catch(function(e){return o.setError(e).end(),A.w("".concat(t," failed. error:"),e),m(e)})}},{key:"changeGroupOwner",value:function(i){var a=this,s="".concat(this._n,".").concat("changeGroupOwner");if(this.hasLocalGroup(i.groupID)&&this.getLocalGroupProfile(i.groupID).type===S.GRP_AVCHATROOM)return m({code:C.CANNOT_CHANGE_OWNER_IN_AVCHATROOM});if(i.newOwnerID===this.getMyUserID())return m({code:C.CANNOT_CHANGE_OWNER_TO_SELF});var r=new M("changeGroupOwner");return r.setMessage("groupID:".concat(i.groupID," newOwnerID:").concat(i.newOwnerID)),A.l("".concat(s," groupID:").concat(i.groupID)),this.req({proto:v.CHANGE_GRP_OWNER,data:i}).then(function(){r.end(),A.l("".concat(s," ok"));var e,t=i.groupID,n=i.newOwnerID,o=(a.groupMap.get(t).ownerID=n,a._groupMemberHandler.getLocalGroupMemberList(t));return o instanceof Map&&(e=o.get(a.getMyUserID()),k(e)||(e.updateRole("Member"),a.groupMap.get(t).selfInfo.role="Member"),e=o.get(n),k(e)||e.updateRole("Owner")),a.emitGroupListUpdate(!0,!1),yn({group:a.groupMap.get(t)})}).catch(function(e){return r.setError(e).end(),A.e("".concat(s," failed. error:"),e),m(e)})}},{key:"getGroupApplicationList",value:function(){return this._groupSystemNoticeHandler.getGroupApplicationList()}},{key:"handleGroupApplication",value:function(e){var t,n,o,i,a,l=this,s="".concat(this._n,".").concat("handleGroupApplication"),d=e.handleAction,p=e.handleMessage,r=e.message,c=e.application,_=(r?(t=r.payload.operatorID,n=r.payload.groupProfile.groupID,o=r.payload.authentication,i=r.payload.messageKey):c&&(t=c.applicant,n=c.groupID,o=c.authentication,i=c.messageKey),v.HANDLE_GRP_APPLICATION),u=(c&&2===c.applicationType&&(_=v.HANDLE_INVITE_JOIN_GRP,a=c.userID),new M("handleGroupApplication"));return u.setMessage("groupID:".concat(n)),A.l("".concat(s," groupID:").concat(n)),this.req({proto:_,data:{handleAction:d,handleMessage:p,applicant:t,invitee:a,groupID:n,authentication:o,messageKey:i}}).then(function(){return u.end(),A.l("".concat(s," ok")),r&&l._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),yn({group:l.getLocalGroupProfile(n)})}).catch(function(e){return u.setError(e).end(),A.e("".concat(s," failed. error"),e),m(e)})}},{key:"handleGroupInvitation",value:function(e){var t=this,n="".concat(this._n,".").concat("handleGroupInvitation"),o=e.message.payload,i=o.groupProfile.groupID,a=o.authentication,s=o.messageKey,o=o.operatorID,r=e.handleAction,c=new M("handleGroupInvitation");return c.setMessage("groupID:".concat(i," inviter:").concat(o," handleAction:").concat(r)),A.l("".concat(n," groupID:").concat(i," inviter:").concat(o," handleAction:").concat(r)),this.req({proto:v.HANDLE_GRP_INVITATION,data:y(y({},e),{},{inviter:o,groupID:i,authentication:a,messageKey:s})}).then(function(){return c.end(),A.l("".concat(n," ok")),t._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),yn({group:t.getLocalGroupProfile(i)})}).catch(function(e){return c.setError(e).end(),A.e("".concat(n," failed. error"),e),m(e)})}},{key:"getGroupOnlineMemberCount",value:function(t){var n=this,o="".concat(this._n,".getGroupOnlineMemberCount"),e=this._AVChatRoomHandler.checkJoinedAVChatRoomByID(t),i=this.hasLocalGroup(t);if(A.l("".concat(o," groupID:").concat(t," isAVChatRoom:").concat(e," has:").concat(i)),e)return this._AVChatRoomHandler.getGroupOnlineMemberCount(t);if(!i)return Cn({memberCount:0});e=Date.now();if(this._onlineMemberCountMap.has(t)){i=this._onlineMemberCountMap.get(t);if(e-i.lastReqTime<=6e4)return Cn({memberCount:i.memberCount});i.lastReqTime=e}return this.requestOnlineCount(t).then(function(e){e=e.data.memberCount,e=void 0===e?0:e;return n._onlineMemberCountMap.set(t,{lastReqTime:Date.now(),memberCount:e}),A.l("".concat(o," ok. groupID:").concat(t," memberCount:").concat(e)),Cn({memberCount:e})}).catch(function(e){return A.w("".concat(o," failed. error:"),e),Promise.reject(e)})}},{key:"requestOnlineCount",value:function(e){return this.req({proto:v.GET_ONLINE_MBR_NUM,data:{groupID:e}})}},{key:"hasLocalGroup",value:function(e){return this.groupMap.has(e)}},{key:"deleteLocalGroupAndConversation",value:function(e){var t,n=this.checkJoinedAVChatRoomByID(e),o=(A.l("".concat(this._n,".deleteLocalGroupAndConversation groupID:").concat(e," isJoinedAVChatRoom:").concat(n)),this.get(11)),i="".concat(S.CONV_GROUP).concat(e);n&&o.deleteLocalConversation(i),Dt({groupID:e})&&(t=this.getLocalGroupProfile(e))&&!0===t.isSupportTopic&&this.get(10).deleteTopicListInCommunity(e),o.clearUnreadCount(i),this._deleteLocalGroup(e),this._onlineMemberCountMap.delete(e),this.emitGroupListUpdate(!0,!1)}},{key:"_deleteLocalGroup",value:function(e){this.groupMap.delete(e),this._groupMemberHandler.deleteGroupMemberList(e)}},{key:"sendMessage",value:function(e,t){if(Qe(e._receiverList)&&0<e._receiverList.length&&!this.canIUse(H.MSG_TO_SPECIFIED_GRP_MBR))return this.cannotUseCommercialAbility("group direct messages");e=this.createGroupMessagePack(e,t);return this.req(e)}},{key:"createGroupMessagePack",value:function(e,t){var n=null,o=(t&&t.offlinePushInfo&&(n=t.offlinePushInfo),""),i=(pt(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData),[]),a=(Ze(t)&&Ze(t.messageControlInfo)&&(a=(r=t.messageControlInfo).excludedFromUnreadCount,s=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===a&&i.push("NoUnread"),!0===s&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),void 0),s=(Qe(e._receiverList)&&0<e._receiverList.length&&(a=e._receiverList,50<e._receiverList.length&&(a=e._receiverList.slice(0,50),this.outputWarning("ReceiverListLimit"))),this.isOnlineMessage(e,t)?1:0),r=e.getGroupAtInfoList(),t={fromAccount:this.getMyUserID(),groupID:e.to,msgBody:e.getElements(),cloudCustomData:o,random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:e.type!==S.MSG_TEXT||We(r)?void 0:r,onlineOnlyFlag:s,clientTime:e.clientTime,offlinePushInfo:Oo(n),messageControlInfo:0==s?i:void 0,needReadReceipt:!0!==e.needReadReceipt||this.isMessageFromOrToAVChatroom(e.to)?0:1,receiverList:a,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID};return Et(e.to)&&(t.groupID=xt(e.to),t.topicID=e.to),{proto:v.SEND_GRP_MSG,tjgID:this.generateTjgID(e),data:t}}},{key:"revokeMessage",value:function(e){var t={groupID:e.to,msgSeqList:[{msgSeq:e.sequence}]};return Et(e.to)&&(t.groupID=xt(e.to),t.topicID=e.to),this.req({proto:v.REVOKE_GRP_MSG,data:t})}},{key:"deleteMessage",value:function(e){var t=e.to,e=e.keyList,e=(A.l("".concat(this._n,".deleteMessage groupID:").concat(t," count:").concat(e.length)),{groupID:t,deleter:this.getMyUserID(),keyList:e});return Et(t)&&(e.groupID=xt(t),e.topicID=t),this.req({proto:v.DEL_GRP_MSG,data:e})}},{key:"modifyRemoteMessage",value:function(e){var t=e.to,n=e.sequence,o=e.payload,i=e.type,a=e.version,a=void 0===a?0:a,e=e.cloudCustomData,s=t,r=void 0,t=(Et(t)&&(s=xt(t),r=t),void 0);return Ht(i)&&(t=[]).push({type:i,content:o}),this.req({proto:v.MODIFY_GRP_MSG,data:{groupID:s,topicID:r,sequence:n,version:a,elements:t,cloudCustomData:e}})}},{key:"getRoamingMessage",value:function(e){var s=this,r="".concat(this._n,".getRoamingMessage"),c=e.conversationID,u=e.groupID,e=e.sequence,l=new M("getGroupRoamingMessages"),d=0,p=void 0;return Et(u)&&(u=xt(p=u)),this._computeLastSequence({groupID:u,topicID:p,sequence:e}).then(function(e){return d=e,A.l("".concat(r," groupID:").concat(u," startSequence:").concat(d)),s.req({proto:v.GET_GRP_ROAMING_MSG,data:{groupID:u,count:21,sequence:d,topicID:p}})}).then(function(e){var t=e.data,n=t.messageList,o=t.complete,t=t.invisibleSequenceList,t=void 0===t?[]:t,e=e.data.nextSequence,e=void 0===e?0:e,i=(k(n)?A.l("".concat(r," ok. complete:").concat(o," nextSequence:").concat(e," but messageList is undefined!")):A.l("".concat(r," ok. complete:").concat(o," nextSequence:").concat(e," count:").concat(n.length)),l.setMessage("groupID:".concat(u," topicID:").concat(p," startSequence:").concat(d," complete:").concat(o," nextSequence:").concat(e)).end(),s.get(11)),a=[];return We(n)?1<=e&&i.updateRoamingMessageSequence(c,e):(i.updateRoamingMessageSequence(c,e),a=i.onRoamingMessage(n,c),i.updateIsRead(c),i.patchConversationLastMessage(c)),(2===o||e<1)&&(i.setCompleted(c),e=""),A.l("".concat(r," nextReqID:").concat(e,", stored message count:").concat(a.length,", invisible sequence count:").concat(t.length)),{nextReqID:e+"",storedMessageList:a}}).catch(function(e){return l.setError(e).setMessage("groupID:".concat(u," topicID:").concat(p," startSequence:").concat(d)).end(),A.w("".concat(r," failed. error:"),e),m(e)})}},{key:"_getGroupIDOfMessage",value:function(e){return e.conversationID.replace(S.CONV_GROUP,"")}},{key:"getReadReceiptList",value:function(n){var t="".concat(this._n,".").concat("getReadReceiptList"),e=this._getGroupIDOfMessage(n[0]),o=this.getMyUserID(),i=n.filter(function(e){return e.from===o&&!0===e.needReadReceipt}).map(function(e){return{sequence:e.sequence}});if(A.l("".concat(t," groupID:").concat(e," sequenceList:").concat(JSON.stringify(i))),0===i.length)return Cn({messageList:n});var a=new M("getReadReceiptList");return a.setMessage("groupID:".concat(e)),this.req({proto:v.GET_READ_RECEIPT,data:{groupID:e,sequenceList:i}}).then(function(e){a.end(),A.l("".concat(t," ok"));e=e.data.readReceiptList;return Qe(e)&&e.forEach(function(t){n.forEach(function(e){0===t.code&&t.sequence===e.sequence&&(e.readReceiptInfo.readCount=t.readCount,e.readReceiptInfo.unreadCount=t.unreadCount)})}),yn({messageList:n})}).catch(function(e){return a.setError(e).end(),A.w("".concat(t," failed. error:"),e),m(e)})}},{key:"sendReadReceipt",value:function(e){var t="".concat(this._n,".").concat("sendReadReceipt"),n=this._getGroupIDOfMessage(e[0]),o=new M("sendReadReceipt"),i=(o.setMessage("groupID:".concat(n)),this.getMyUserID()),e=e.filter(function(e){return e.from!==i&&!0===e.needReadReceipt}).map(function(e){return{sequence:e.sequence}});return 0===e.length?m({code:C.READ_RECEIPT_MSG_LIST_EMPTY}):(A.l("".concat(t,". sequenceList:").concat(JSON.stringify(e))),this.req({proto:v.SEND_READ_RECEIPT,data:{groupID:n,sequenceList:e}}).then(function(e){return o.end(),A.l("".concat(t," ok")),yn()}).catch(function(e){return o.setError(e).end(),A.w("".concat(t," failed. error:"),e),m(e)}))}},{key:"getReadReceiptDetail",value:function(e){var l=this,t=e.message,n=e.filter,o=e.cursor,e=e.count,i=this._getGroupIDOfMessage(t),a=t.ID,t=t.sequence,s="".concat(this._n,".").concat("getReadReceiptDetail"),d=this._receiptDetailCompleteMap.get(a)||!1,r=0!==n&&1!==n?0:n,n=pt(o)?o:"",o=!ze(e)||e<=0||100<=e?100:e,e="groupID:".concat(i," sequence:").concat(t," cursor:").concat(n," filter:").concat(r," completeFlag:").concat(d),c=(A.l("".concat(s," ").concat(e)),{cursor:"",isCompleted:!1,messageID:a,unreadUserIDList:[],readUserIDList:[]}),u=new M("getReadReceiptDetail");return u.setMessage(e),this.req({proto:v.GET_READ_RECEIPT_DETAIL,data:{groupID:i,sequence:t,flag:r,cursor:n,count:o}}).then(function(e){u.end();var e=e.data,t=e.cursor,n=e.isCompleted,o=e.unreadUserIDList,e=e.readUserIDList;return c.cursor=t,1===n&&(c.isCompleted=!0,l._receiptDetailCompleteMap.set(a,!0)),0===r?c.readUserIDList=e.map(function(e){return e.userID}):1===r&&(c.unreadUserIDList=o.map(function(e){return e.userID})),A.l("".concat(s," ok")),yn(c)}).catch(function(e){return u.setError(e).end(),A.w("".concat(s," failed. error:"),e),m(e)})}},{key:"getRoamingMessagesHopping",value:function(o){var i=this,a="".concat(this._n,".getRoamingMessagesHopping"),t=o.groupID,n=o.count,s=o.sequence,r=o.direction,e=s;if(k(s)){if(1===r)return Cn({messageList:[],isCompleted:!0,nextMessageSeq:""});this.hasLocalGroup(t)&&(e=1<(c=this.getLocalGroupProfile(t).nextMessageSeq)?c-1:0),Et(t)&&(e=0)}else 1===r&&(e=s+n-1);var c=void 0,u=(Et(t)&&(t=xt(c=t)),"".concat(c?"topicID:".concat(c):"groupID:".concat(t)," sequence:").concat(s," direction:").concat(r)),l=(A.l("".concat(a," ").concat(u)),new M("getGroupRoamingMessagesHopping"));return this.req({proto:v.GET_GRP_ROAMING_MSG,data:{groupID:t,topicID:c,count:n,sequence:e}}).then(function(e){var e=e.data,t=e.messageList,e=e.complete,n="complete:".concat(e," count:").concat(t?t.length:0);if(A.l("".concat(a," ok. ").concat(n)),l.setMessage("".concat(u," ").concat(n)).end(),2===e||We(t))return n=i._computeResult(),yn(n);e="".concat(S.CONV_GROUP).concat(o.groupID),n=i.get(11),e=n.onRoamingMessage(t,e,!1),t=i._computeResult({direction:r,sequence:s,remoteMessageList:t,processedMessageList:e});return n.storeHoppingMessageList(t.messageList),yn(t)}).catch(function(e){return l.setError(e).setMessage("groupID:".concat(t," sequence:").concat(s," count:").concat(n)).end(),A.w("".concat(a," failed. error:"),e),m(e)})}},{key:"_computeResult",value:function(e){var t={messageList:[],isCompleted:!1,nextMessageSeq:""};if(k(e))return t.isCompleted=!0,t;var n=e.direction,o=e.sequence,i=e.remoteMessageList,i=void 0===i?[]:i,e=e.processedMessageList,e=void 0===e?[]:e,a=i.length;return 1===n?(t.nextMessageSeq=i[0].sequence+1,e.forEach(function(e){e.sequence>=o&&t.messageList.push(e)}),0===t.messageList.length&&i[0].sequence<o&&(t.isCompleted=!0,t.nextMessageSeq="")):(t.nextMessageSeq=i[a-1].sequence-1,t.messageList=T(e),0===t.nextMessageSeq&&(t.isCompleted=!0,t.nextMessageSeq="")),t}},{key:"setMessageRead",value:function(e){var o=this,i=e.conversationID,a=e.lastMessageSeq,s="".concat(this._n,".").concat("setMessageRead"),e="conversationID:".concat(i," lastMessageSeq:").concat(a),r=(A.l("".concat(s," ").concat(e)),ze(a)||this.outputWarning("DoNotModifyLastSeq"),new M("setMessageRead")),c=(r.setMessage(e),i.replace(S.CONV_GROUP,"")),u=void 0;return Et(c)&&(c=xt(u=c)),this.req({proto:v.SET_GRP_MSG_READ,data:{groupID:c,topicID:u,messageReadSeq:a}}).then(function(){r.end(),A.l("".concat(s," ok"));var e,t=o.get(11),n=(t.updateIsReadAfterReadReport({conversationID:i,lastMessageSeq:a}),!0);return k(u)||(n=!1,(e=o.get(10).getLocalTopic(c,u))&&e.updateSelfInfo({readedSequence:a})),t.updateUnreadCount(i,n),yn()}).catch(function(e){return r.setError(e).end(),A.l("".concat(s," failed. error:"),e),m(e)})}},{key:"_computeLastSequence",value:function(e){var t=e.groupID,n=e.topicID,n=void 0===n?void 0:n,e=e.sequence;return 0<e?Promise.resolve(e):k(n)?this.getGroupLastSequence(t):Promise.resolve(0)}},{key:"getGroupLastSequence",value:function(e){var t="".concat(this._n,".").concat("getGroupLastSequence"),n=new M("getGroupLastSequence"),o=0,i="",a="groupID:".concat(e);if(this.hasLocalGroup(e)){var s=this.getLocalGroupProfile(e),r=s.lastMessage;if(0<r.lastSequence&&!1===r.onlineOnlyFlag)return o=r.lastSequence,i="".concat(a,", ").concat(o," from group.lastMessage.lastSequence"),A.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o);if(1<s.nextMessageSeq)return o=s.nextMessageSeq-1,i="".concat(a,", ").concat(o," from group.nextMessageSeq"),A.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o)}r=this.get(11).getLocalConversation("GROUP".concat(e));return r&&r.lastMessage.lastSequence&&!1===r.lastMessage.onlineOnlyFlag?(o=r.lastMessage.lastSequence,i="".concat(a,", ").concat(o," from conversation.lastMessage.lastSequence"),A.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o)):this.getGroupProfileAdvance({groupIDList:[e],responseFilter:{groupBaseInfoFilter:["NextMsgSeq"]}}).then(function(e){e=e.data.successGroupList;return We(e)?A.w("".concat(t," ").concat(a,", empty successGroupList")):(o=e[0].nextMessageSeq-1,i="".concat(a,", ").concat(o," from remote"),A.l("".concat(t," ").concat(i))),n.setMessage(i).end(),o}).catch(function(e){return n.setError(e).setMessage(a).end(),A.w("".concat(t," failed. error:"),e),m(e)})}},{key:"isMessageFromOrToAVChatroom",value:function(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}},{key:"hasJoinedAVChatRoom",value:function(){return this._AVChatRoomHandler.hasJoinedAVChatRoom()}},{key:"getJoinedAVChatRoom",value:function(){return this._AVChatRoomHandler.getJoinedAVChatRoom()}},{key:"getGroupRemoteLastSeq",value:function(e){e=this.getLocalGroupProfile(e);return e?e.nextMessageSeq-1:1}},{key:"isOnlineMessage",value:function(e,t){return!(!this._canIUseOnlineOnlyFlag(e)||!t||!0!==t.onlineUserOnly)}},{key:"_canIUseOnlineOnlyFlag",value:function(e){var t=this.getJoinedAVChatRoom();return!t||!t.includes(e.to)||e.conversationType!==S.CONV_GROUP}},{key:"_onAVChatRoomHistoryMessage",value:function(e,t){var n;We(e)||(A.l("".concat(this._n,"._onAVChatRoomHistoryMessage groupID:").concat(t," count:").concat(e.length)),n=[],e.forEach(function(e){n.push(y(y({},e),{},{isHistoryMessage:1}))}),this.onAVChatRoomMessage(n,t))}},{key:"onAVChatRoomMessage",value:function(e){this._AVChatRoomHandler.onMessage(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:"")}},{key:"onAVChatRoomMemberBanned",value:function(e){this._AVChatRoomHandler.onAVChatRoomMemberBanned(e)}},{key:"getGroupSimplifiedInfo",value:function(t){var n=new M("getGroupSimplifiedInfo");return this.getGroupProfileAdvance({groupIDList:[t],responseFilter:{groupBaseInfoFilter:["Type","Name"]}}).then(function(e){e=e.data.successGroupList;return n.setMessage("groupID:".concat(t," type:").concat(e[0].type)).end(),e[0]}).catch(function(e){n.setError(e).setMessage("groupID:".concat(t)).end()})}},{key:"setUnjoinedAVChatRoom",value:function(e){this._unjoinedAVChatRoomList.set(e,1)}},{key:"deleteUnjoinedAVChatRoom",value:function(e){this._unjoinedAVChatRoomList.has(e)&&this._unjoinedAVChatRoomList.delete(e)}},{key:"isUnjoinedAVChatRoom",value:function(e){return this._unjoinedAVChatRoomList.has(e)}},{key:"isGroupAttributesUpdatedNotice",value:function(e){return this._groupAttributesHandler.isGroupAttributesUpdatedNotice(e)}},{key:"updateLocalMainSequenceOnReconnected",value:function(){this._groupAttributesHandler.updateLocalMainSequenceOnReconnected()}},{key:"initGroupAttributes",value:function(e){return this._groupAttributesHandler.initGroupAttributes(e)}},{key:"setGroupAttributes",value:function(e){return this._groupAttributesHandler.setGroupAttributes(e)}},{key:"deleteGroupAttributes",value:function(e){return this._groupAttributesHandler.deleteGroupAttributes(e)}},{key:"getGroupAttributes",value:function(e){return this._groupAttributesHandler.getGroupAttributes(e)}},{key:"isMessageFromTopic",value:function(e,t){return 2===e&&!We(t)}},{key:"isMessageFromCommunityOfTopic",value:function(e,t){return 2===e&&We(t)}},{key:"getMessageExtensions",value:function(e,t){return A.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t)),this.req({proto:v.GET_GRP_MSG_EXT,data:{groupID:e.to,messageSequence:e.sequence,startSequence:t}})}},{key:"modifyMessageExtensions",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;return A.l("".concat(this._n,".modifyMessageExtensions operateType:").concat(n)),this.req({proto:v.MODIFY_GRP_MSG_EXT,data:{groupID:e.to,messageSequence:e.sequence,extensionList:t,operateType:n}})}},{key:"_genNotifyReqList",value:function(e){for(var t=[],n=0,o=e.length;n<o;n++){var i=e[n],a=this.getLocalGroupProfile(i).type,s=this._getGroupLastRevokedTime(i),r=1e3*Oe(),a={notifyType:1,limit:20,type:Dt({type:a,groupID:i})?S.GRP_COMMUNITY:void 0,groupID:i,beginTime:s,endTime:r};t.push(a)}return t}},{key:"getGroupNotify",value:function(e){var a=this,t="".concat(this._n,".getGroupNotify"),n=e.filter(function(e){var t=a.getLocalGroupProfile(e),n=t.type,t=t.isSupportTopic;return a.hasLocalGroup(e)&&!Tt(n)&&!t}),o="filteredGroupIDList.length:".concat(n.length);n.length<=10&&(o="filteredGroupIDList:".concat(JSON.stringify(n))),A.l("".concat(t," ").concat(o)),0!==n.length&&this.req({proto:v.GET_GRP_NOTIFY,data:{notifyReqList:this._genNotifyReqList(e)}}).then(function(e){var o,e=e.data.notifyRspList,i=[],e=(Qe(e)&&(o={dataList:[]},e.forEach(function(e){var t=e.nextRevokedTime,n=e.groupID;o.dataList.push({elements:{revokedInfos:a._genRevokedInfos(e)}}),0!==t?(a._setGroupLastRevokedTime(n,t),i.push(n)):a._setGroupLastRevokedTime(n,1e3*Oe())}),a.onGroupMessageRevoked(o)),0<i.length&&a.getGroupNotify(i),"nextGroupIDList.length:".concat(i.length));i.length<=10&&(e="nextGroupIDList:".concat(JSON.stringify(i))),A.l("".concat(t," ").concat(e))}).catch(function(e){A.e("".concat(t," failed. error:"),e)})}},{key:"_genRevokedInfos",value:function(e){var t=e.notifyList,n=e.groupID,o=[];return Qe(t)&&t.forEach(function(e){o.push({groupID:n,sequence:e.sequence,random:e.random,revokerInfo:y({},e.revokerInfo)})}),o}},{key:"_getGroupLastRevokedTime",value:function(e){return this.hasLocalGroup(e)?this.getLocalGroupProfile(e)._lastRevokedTime:0}},{key:"_setGroupLastRevokedTime",value:function(e,t){this.hasLocalGroup(e)&&(this.getLocalGroupProfile(e)._lastRevokedTime=t)}},{key:"isGroupCountersNotice",value:function(e){return this._groupCountersHandler.isGroupCountersNotice(e)}},{key:"setGroupCounters",value:function(e){return this._groupCountersHandler.setGroupCounters(e)}},{key:"increaseGroupCounter",value:function(e){return this._groupCountersHandler.increaseGroupCounter(e)}},{key:"decreaseGroupCounter",value:function(e){return this._groupCountersHandler.decreaseGroupCounter(e)}},{key:"getGroupCounters",value:function(e){return this._groupCountersHandler.getGroupCounters(e)}},{key:"getGroupMemberHandler",value:function(){return this._groupMemberHandler}},{key:"getGroupMemberList",value:function(e){return this._groupMemberHandler.getGroupMemberList(e)}},{key:"getGroupMemberProfile",value:function(e){return this._groupMemberHandler.getGroupMemberProfile(e)}},{key:"addGroupMember",value:function(e){return this._groupMemberHandler.addGroupMember(e)}},{key:"deleteGroupMember",value:function(e){return this._groupMemberHandler.deleteGroupMember(e)}},{key:"setGroupMemberMuteTime",value:function(e){return this._groupMemberHandler.setGroupMemberMuteTime(e)}},{key:"setGroupMemberRole",value:function(e){return this._groupMemberHandler.setGroupMemberRole(e)}},{key:"setGroupMemberNameCard",value:function(e){return this._groupMemberHandler.setGroupMemberNameCard(e)}},{key:"setGroupMemberCustomField",value:function(e){return this._groupMemberHandler.setGroupMemberCustomField(e)}},{key:"markGroupMemberList",value:function(e){return this._groupMemberHandler.markGroupMemberList(e)}},{key:"modifyGroupMemberInfo",value:function(e){return this._groupMemberHandler.modifyGroupMemberInfo(e)}},{key:"restartPolling",value:function(){this._AVChatRoomHandler.restartPolling()}},{key:"getPollingTimerID",value:function(e){if(!e)return-1;var t=this.getLocalGroupProfile(e);return t&&Tt(t.type)?this._AVChatRoomHandler.getPollingTimerID(e):-1}},{key:"_canIUseJoinOption",value:function(e){return e===S.GRP_PUBLIC||Dt({type:e})}},{key:"_silentlyGetGroupProfile",value:function(e,t){var n=setTimeout(this.getGroupProfile.bind(this,{groupID:t}),3e3);this._timeoutIDs.push(n),A.l("".concat(this._n,"._silentlyGetGroupProfile errorCode:").concat(e," groupID:").concat(t," timeoutIDs:").concat(this._timeoutIDs))}},{key:"_clearTimeoutIDs",value:function(){this._timeoutIDs.forEach(function(e){clearTimeout(e)}),this._timeoutIDs=[]}},{key:"startMessageLongPolling",value:function(e){var t=e.groupID,n=e.longPollingKey,e=e.longPollingSequence,e=void 0===e?1:e,o=this.get(12).isUnlimitedAVChatRoom(),i=(this._AVChatRoomHandler.hasPollingInstance(t)&&this.stopMessageLongPolling({groupID:t}),this._AVChatRoomHandler.getJoinedLiveList()),o=(!o&&0<i.length&&this.stopMessageLongPolling({groupID:i[0]}),new $o({groupID:t,type:S.GRP_LIVE}));return A.l("".concat(this._n,".startMessageLongPolling groupID:").concat(t," longPollingKey:").concat(n," longPollingSequence:").concat(e)),this._AVChatRoomHandler.startRunLoop({group:o,longPollingKey:n,startSeq:e})}},{key:"stopMessageLongPolling",value:function(e){var e=e.groupID,t=this.get(11);return this._AVChatRoomHandler.reset(e),this._deleteLocalGroup(e),t.deleteLocalConversation("".concat(S.CONV_GROUP).concat(e)),A.l("".concat(this._n,".stopMessageLongPolling ok, groupID:").concat(e)),Cn({groupID:e})}},{key:"reset",value:function(){this.groupMap.clear(),this._unjoinedAVChatRoomList.clear(),this._receiptDetailCompleteMap.clear(),this._onlineMemberCountMap.clear(),this._commonGroupHandler.reset(),this._groupSystemNoticeHandler.reset(),this._groupTipsHandler.reset(),this._groupAttributesHandler.reset(),this._groupCountersHandler.reset(),this._AVChatRoomHandler.reset(),this._groupMemberHandler.reset(),this._clearTimeoutIDs()}}]),bi),mi=["topicID","topicName","avatar","introduction","notification","unreadCount","muteAllMembers","customData","groupAtInfoList","nextMessageSeq","selfInfo"],vi=(e(Ui,[{key:"_initTopic",value:function(e){for(var t in e)mi.indexOf(t)<0||("selfInfo"===t?this.updateSelfInfo(e[t]):this[t]="muteAllMembers"===t?1===e[t]:e[t])}},{key:"updateUnreadCount",value:function(){this.unreadCount=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0}},{key:"updateNextMessageSeq",value:function(e){this.nextMessageSeq=e}},{key:"updateLastMessage",value:function(e){this.lastMessage=xo(e)}},{key:"updateGroupAtInfoList",value:function(e){this.groupAtInfoList=JSON.parse(JSON.stringify(e))}},{key:"updateTopic",value:function(e){k(e.selfInfo)||this.updateSelfInfo(e.selfInfo),k(e.muteAllMembers)||(this.muteAllMembers=1===e.muteAllMembers),ot(this,e,["groupID","lastMessageTime","selfInfo","muteAllMembers","lastMsg"])}},{key:"updateSelfInfo",value:function(e){return 0!==ot(this.selfInfo,e,[],[""])}},{key:"reduceUnreadCount",value:function(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}},{key:"isLastMessageRevoked",value:function(e){return e.sequence===this.lastMessage.lastSequence}},{key:"setLastMessageRevoked",value:function(e){this.lastMessage.isRevoked=e}},{key:"setLastMessageRevoker",value:function(e){this.lastMessage.revoker=e}}]),Ui),Mi=(t(Pi,Nn),Ko=f(Pi),e(Pi,[{key:"_onCloudConfigUpdated",value:function(){var e=this.getCloudConfig("topic_cache_time"),t=this.getCloudConfig("topic_last_active_time");k(e)||(this.TOPIC_CACHE_TIME=Number(e)),k(t)||(this.TOPIC_LAST_ACTIVE_TIME=Number(t))}},{key:"onTopicCreated",value:function(e){var t=e.groupID;this.resetGetTopicTime(t),this.emitOuterEvent(G.TOPIC_CREATED,e)}},{key:"onTopicDeleted",value:function(e){var t=this,n=e.groupID,o=e.topicIDList;(void 0===o?[]:o).forEach(function(e){t._deleteLocalTopic(n,e)}),this.emitOuterEvent(G.TOPIC_DELETED,e)}},{key:"onTopicMessageRemindTypeUpdated",value:function(e){var t,n=e.groupID,o=e.topicID,e=e.messageRemindType,i=this.getLocalTopic(n,o);i&&((t=i.updateSelfInfo({messageRemindType:e}))&&this.emitOuterEvent(G.TOPIC_UPDATED,{groupID:n,topic:i}),A.l("".concat(this._n,".onTopicMessageRemindTypeUpdated topicID:").concat(o)+" messageRemindType:".concat(e," isTopicUpdated:").concat(t)))}},{key:"onTopicProfileUpdated",value:function(e){var t=e.groupID,n=e.topicID,n=this.getLocalTopic(t,n);n&&(n.updateTopic(e),this.emitOuterEvent(G.TOPIC_UPDATED,{groupID:t,topic:n}))}},{key:"onConversationProxy",value:function(e){var t=e.topicID,n=e.unreadCount,e=e.groupAtInfoList,o=xt(t),t=this.getLocalTopic(o,t),i=!1;t&&(k(n)||t.unreadCount===n||(t.updateUnreadCount(n),i=!0),k(e)||(t.updateGroupAtInfoList(e),i=!0)),i&&this.emitOuterEvent(G.TOPIC_UPDATED,{groupID:o,topic:t})}},{key:"onMessageSent",value:function(e){var t=e.groupID,n=e.topicID,e=e.lastMessage,n=this.getLocalTopic(t,n);n&&(n.nextMessageSeq+=1,n.updateLastMessage(e),this.emitOuterEvent(G.TOPIC_UPDATED,{groupID:t,topic:n}))}},{key:"onMessageModified",value:function(e){var t,n=e.to,o=e.time,i=e.sequence,a=e.elements,s=e.cloudCustomData,r=e.messageVersion,c=xt(n),u=this.getLocalTopic(c,n);u&&(t=u.lastMessage,A.d("".concat(this._n,".onMessageModified topicID:").concat(n," lastMessage:"),JSON.stringify(t),"options:",JSON.stringify(e)),t&&(null===t.payload||t.lastTime===o&&t.lastSequence===i&&t.version!==r)&&(t.type=a[0].type,t.payload=a[0].content,t.messageForShow=Vt(t.type,t.payload,this.isIntl()),t.cloudCustomData=s,t.version=r,t.lastSequence=i,t.lastTime=o,this.emitOuterEvent(G.TOPIC_UPDATED,{groupID:c,topic:u})))}},{key:"onMessageRevoked",value:function(e){var n,o,i,a=this;0!==e.length&&(o=n=null,i=!1,e.forEach(function(e){var t=e.to;o=xt(t),(n=a.getLocalTopic(o,t))&&(n.reduceUnreadCount()&&(i=!0),n.isLastMessageRevoked(e)&&(n.setLastMessageRevoked(!0),n.setLastMessageRevoker(e.revoker),i=!0))}),i&&this.emitOuterEvent(G.TOPIC_UPDATED,{groupID:o,topic:n}))}},{key:"isLastMessageRevoked",value:function(e){var t=e.topicID,e=e.sequence,n=xt(t),n=this.getLocalTopic(n,t),t=!1;return t=n?n.isLastMessageRevoked({sequence:e}):t}},{key:"getJoinedCommunityList",value:function(){return this.get(7).syncCommunityWithTopic()}},{key:"createTopicInCommunity",value:function(t){var n=this,o="".concat(this._n,".").concat("createTopicInCommunity"),e=t.topicID;if(!k(e)&&!Et(e))return m({code:C.ILLEGAL_TOPIC_ID});if(t.topicName&&!1===this._filterProfanity("topicName",t))return m({code:C.PROFANITY_FOUND});if(t.introduction&&!1===this._filterProfanity("introduction",t))return m({code:C.PROFANITY_FOUND});if(t.notification&&!1===this._filterProfanity("notification",t))return m({code:C.PROFANITY_FOUND});var i=new M("createTopicInCommunity");return this.req({proto:v.CREATE_TOPIC,data:y({},t)}).then(function(e){e=e.data.topicID;return i.setMessage("topicID:".concat(e)).end(),A.l("".concat(o," ok. topicID:").concat(e)),n._updateTopicMap([y(y({},t),{},{topicID:e})]),yn({topicID:e})}).catch(function(e){return i.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"deleteTopicFromCommunity",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteTopicFromCommunity"),a=e.groupID,e=e.topicIDList,e=void 0===e?[]:e,s=new M("deleteTopicFromCommunity");return s.setMessage("groupID:".concat(a," topicIDList:").concat(e)),this.req({proto:v.DEL_TOPIC,data:{groupID:a,topicIDList:e}}).then(function(e){var e=e.data.resultList,o=[],i=[],e=((void 0===e?[]:e).forEach(function(e){var t=e.topicID,n=e.errorCode,e=e.errorInfo;0===n?o.push({topicID:t}):i.push({topicID:t,code:n,message:e})}),"success count:".concat(o.length,", fail count:").concat(i.length));return s.setMoreMessage(e).end(),A.l("".concat(n," ok. ").concat(e)),o.forEach(function(e){t._deleteLocalTopic(a,e.topicID)}),yn({successTopicList:o,failureTopicList:i})}).catch(function(e){return s.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"updateTopicProfile",value:function(e){var t=this,n="".concat(this._n,".").concat("updateTopicProfile");if(A.l("".concat(n," options:"),e),e.topicName&&!1===this._filterProfanity("topicName",e))return m({code:C.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return m({code:C.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return m({code:C.PROFANITY_FOUND});var o=new M("updateTopicProfile");return o.setMessage("groupID:".concat(e.groupID," topicID:").concat(e.topicID)),k(e.muteAllMembers)||(e.muteAllMembers=!0===e.muteAllMembers?"On":"Off"),this.req({proto:v.UPDATE_TOPIC_PROFILE,data:y({},e)}).then(function(){return o.end(),A.l("".concat(n," ok")),t._updateTopicMap([e]),yn({topic:t.getLocalTopic(e.groupID,e.topicID)})}).catch(function(e){return o.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"getTopicList",value:function(e){var t=this,n="".concat(this._n,".").concat("getTopicList"),o=e.groupID,e=e.topicIDList,e=void 0===e?[]:e,i=0===e.length,c=new M("getTopicList");if(c.setMessage("groupID:".concat(o)),this._getTopicTimeMap.has(o)){var a=this._getTopicTimeMap.get(o),s=a.isGetAll,a=a.time;if((s||!s&&!i)&&Date.now()-a<1e3*this.TOPIC_CACHE_TIME){s=this._getLocalTopicList(o,e);if(i||s.length===e.length)return c.setMoreMessage("from cache, topic count:".concat(s.length)).end(),A.l("".concat(n," groupID:").concat(o," from cache, topic count:").concat(s.length)),Cn({successTopicList:s,failureTopicList:[]})}}return this.req({proto:v.GET_TOPIC_LIST,data:{groupID:o,topicIDList:e}}).then(function(e){var e=e.data.topicInfoList,a=[],s=[],r=[],e=((void 0===e?[]:e).forEach(function(e){var t=e.topic,n=e.selfInfo,o=e.errorCode,e=e.errorInfo,i=t.topicID;0===o?(a.push(y(y({},t),{},{selfInfo:n})),s.push(i)):r.push({topicID:i,code:o,message:e})}),t._updateTopicMap(a),t._handleTopicAtInfo(a),"success count:".concat(s.length,", fail count:").concat(r.length)),e=(c.setMoreMessage(e).end(),A.l("".concat(n," groupID:").concat(o," from remote, ").concat(e)),[]);return We(s)||(t._getTopicTimeMap.set(o,{time:Date.now(),isGetAll:i}),e=t._getLocalTopicList(o,s)),yn({successTopicList:e,failureTopicList:r})}).catch(function(e){return c.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"hasLocalTopic",value:function(e,t){return!!this._topicMap.has(e)&&this._topicMap.get(e).has(t)}},{key:"getLocalTopic",value:function(e,t){var n=null;return n=this._topicMap.has(e)?this._topicMap.get(e).get(t):n}},{key:"_getLocalTopicList",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],e=this._topicMap.get(e),n=[];return e&&(n=T(e.values())),0===t.length?n:n.filter(function(e){return t.includes(e.topicID)})}},{key:"_deleteLocalTopic",value:function(e,t){this._topicMap.has(e)&&this._topicMap.get(e).has(t)&&(this._topicMap.get(e).delete(t),A.l("".concat(this._n,"._deleteLocalTopic groupID:").concat(e," topicID:").concat(t)))}},{key:"_updateTopicMap",value:function(e){var i=this,a=[];e.forEach(function(e){var t=e.groupID,n=e.topicID,o=null,e=(i._topicMap.has(t)||i._topicMap.set(t,new Map),i._topicMap.get(t).has(n)?(o=i._topicMap.get(t).get(n)).updateTopic(e):(i._getTopicLastMessage(e),o=new vi(e,i.isIntl()),i._topicMap.get(t).set(n,o)),i._computeUnreadCount(o));o.updateUnreadCount(e),a.push({conversationID:"".concat(S.CONV_GROUP).concat(n),type:S.CONV_TOPIC,unreadCount:e})}),0<a.length&&this.get(11).updateTopicConversation(a)}},{key:"resetGetTopicTime",value:function(e){var t=this;k(e)?T(this._getTopicTimeMap.keys()).forEach(function(e){t._getTopicTimeMap.set(e,0)}):this._getTopicTimeMap.set(e,0)}},{key:"getTopicListOnReconnected",value:function(){var o=this,e=T(this._topicMap.keys()),i=[],a=this.get(11);e.forEach(function(e){var n=[],t=o._getLocalTopicList(e);a.deleteTopicRoamingMessageInfo(e),t.forEach(function(e){var t=e.lastMessage.lastTime,t=void 0===t?0:t;Date.now()-1e3*t<1e3*o.TOPIC_LAST_ACTIVE_TIME&&n.push(e.topicID)}),0<n.length&&i.push({groupID:e,topicIDList:n})}),A.l("".concat(this._n,".getTopicListOnReconnected. active community count:").concat(i.length)),this._relayGetTopicList(i)}},{key:"_relayGetTopicList",value:function(t){var e,n,o,i=this;0!==t.length&&(n=5<(e=t.shift()).topicIDList.length?"topicIDList.length:".concat(e.topicIDList.length):"topicIDList:".concat(e.topicIDList),(o=new M("relayGetTopicList")).setMessage(n),A.l("".concat(this._n,"._relayGetTopicList. ").concat(n)),this.getTopicList(e).then(function(){o.end(),i._relayGetTopicList(t)}).catch(function(e){o.setError(e).end(),i._relayGetTopicList(t)}))}},{key:"_handleTopicAtInfo",value:function(e){var i=this;0!==e.length&&e.forEach(function(e){var t=e.groupID,n=e.topicID,e=e.groupAtInfoList,o=[];k(e)||(e.forEach(function(e){o.push(y(y({},e),{},{groupID:t,topicID:n}))}),i.get(11).onNewGroupAtTips({dataList:o}))})}},{key:"_getTopicLastMessage",value:function(e){var t;k(e.lastMsg)||(t={time:e.lastMsg.time,sequence:e.lastMsg.sequence,from:e.lastMsg.from,payload:e.lastMsg.elements[0]?e.lastMsg.elements[0].content:null,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:"",nick:e.lastMsg.nick,avatar:e.lastMsg.avatar,version:e.lastMsg.messageVersion,cloudCustomData:e.lastMsg.cloudCustomData,isRevoked:2===e.lastMsg.isPlaceMessage,revoker:We(e.lastMsg.revokerInfo)?null:e.lastMsg.revokerInfo.revoker},e.lastMessage=t)}},{key:"deleteTopicListInCommunity",value:function(t){var n=this,e=this._getLocalTopicList(t),o=this.get(11);e.forEach(function(e){e=e.topicID;n._deleteLocalTopic(t,e),n._getTopicTimeMap.delete(t),o.deleteLocalConversation("".concat(S.CONV_GROUP).concat(e))})}},{key:"_computeUnreadCount",value:function(t){var n,e=t.selfInfo,o=e.excludedUnreadSequenceList,i=e.readedSequence,e=t.nextMessageSeq-t.selfInfo.readedSequence-1;return Qe(o)&&(n=0,o.forEach(function(e){i<=e&&e<=t.nextMessageSeq-1&&(n+=1)}),1<=n&&(e-=n)),e<0?0:e}},{key:"_filterProfanity",value:function(e,t){var n=this.get(29);if(!n)return!0;var n=n.filterText(t[e],B),o=n.isAllowedToSend,n=n.modifiedText;return!0===o&&(t[e]=n,!0)}},{key:"updateLastMessage",value:function(e,t){var n,o=xt(e),e=this.getLocalTopic(o,e);e&&(n=t.sequence+1,e.updateNextMessageSeq(n),e.updateLastMessage(t),this.emitOuterEvent(G.TOPIC_UPDATED,{groupID:o,topic:e}))}},{key:"getMessageExtensions",value:function(e,t){A.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t));var n=xt(e.to);return this.req({proto:v.GET_GRP_MSG_EXT,data:{groupID:n,topicID:e.to,messageSequence:e.sequence,startSequence:t}})}},{key:"modifyMessageExtensions",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,o=(A.l("".concat(this._n,".modifyMessageExtensions operateType:").concat(n)),xt(e.to));return this.req({proto:v.MODIFY_GRP_MSG_EXT,data:{groupID:o,topicID:e.to,messageSequence:e.sequence,extensionList:t,operateType:n}})}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._topicMap.clear(),this._getTopicTimeMap.clear(),this.TOPIC_CACHE_TIME=300,this.TOPIC_LAST_ACTIVE_TIME=3600}}]),Pi),Ii=(e(Gi,[{key:"setExpirationTime",value:function(e){this.expirationTime=e}},{key:"getUserProfile",value:function(e){var t=this,n="".concat(this._n,".").concat("getUserProfile"),o=e.userIDList;e.fromAccount=this._userM.getMyAccount(),100<o.length&&(A.w("".concat(n," ").concat(Wt(100))),o.length=100);for(var i,a=[],s=[],r=0,l=o.length;r<l;r++)i=o[r],this._userM.isMyFriend(i)&&this._contains(i)?s.push(this._getProfileFromMap(i)):a.push(i);if(0===a.length)return Cn(s);e.toAccount=a;var d=e.bFromGetMyProfile||!1,c=[],u=(e.toAccount.forEach(function(e){c.push({toAccount:e,standardSequence:0,customSequence:0})}),e.userItem=c,new M("getUserProfile"));return u.setMessage(5<o.length?"userIDList.length:".concat(o.length):"userIDList:".concat(o)),this._userM.req({proto:v.GET_USER_PROFILE,data:e}).then(function(e){u.end(),A.i("".concat(n," ok"));e=t._handleResponse(e).concat(s);return yn(d?e[0]:e)}).catch(function(e){return u.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"getMyProfile",value:function(){var e,t=this._userM.getMyAccount(),n="".concat(this._n,".getMyProfile");return A.l("".concat(n," myAccount:").concat(t)),this._fill(),this._contains(t)?(e=this._getProfileFromMap(t),A.d("".concat(n," from cache, myProfile:").concat(JSON.stringify(e))),Cn(e)):this.getUserProfile({fromAccount:t,userIDList:[t],bFromGetMyProfile:!0})}},{key:"_handleResponse",value:function(e){var t=e.data.userProfileItem;if(!Qe(t))return[];for(var n=[],e=Date.now(),o=0,i=t.length;o<i;o++){var a=t[o],s=a.to,a=a.profileItem;"@TLS#NOT_FOUND"!==s&&""!==s&&(s=this._update(s,this._getLatestProfileFromResponse(s,a)).latestProfile,n.push(s))}return A.l("".concat(this._n,"._handleResponse cost:").concat(zt(e))),n}},{key:"_getLatestProfileFromResponse",value:function(e,t){var n={userID:e,profileCustomField:[]};if(!We(t))for(var o=0,i=t.length;o<i;o++)if(-1<t[o].tag.indexOf("Tag_Profile_Custom"))n.profileCustomField.push({key:t[o].tag,value:t[o].value});else switch(t[o].tag){case be.NICK:n.nick=t[o].value;break;case be.GENDER:n.gender=t[o].value;break;case be.BIRTHDAY:n.birthday=t[o].value;break;case be.LOCATION:n.location=t[o].value;break;case be.SELFSIGNATURE:n.selfSignature=t[o].value;break;case be.ALLOWTYPE:n.allowType=t[o].value;break;case be.LANGUAGE:n.language=t[o].value;break;case be.AVATAR:n.avatar=t[o].value;break;case be.MESSAGESETTINGS:n.messageSettings=t[o].value;break;case be.ADMINFORBIDTYPE:n.adminForbidType=t[o].value;break;case be.LEVEL:n.level=t[o].value;break;case be.ROLE:n.role=t[o].value;break;default:A.w("".concat(this._n,"._getLatestProfileFromResponse unknown tag:"),t[o].tag,t[o].value)}return n}},{key:"updateMyProfile",value:function(o){var i=this,a="".concat(this._n,".").concat("updateMyProfile");if(o.nick&&!1===this._userM.filterProfanity("nick",o))return m({code:C.PROFANITY_FOUND});if(o.selfSignature&&!1===this._userM.filterProfanity("selfSignature",o))return m({code:C.PROFANITY_FOUND});var s=new M("updateMyProfile"),e=(s.setMessage(JSON.stringify(o)),(new zo).validate(o));if(!e.valid)return s.setCode(C.UPDATE_PROFILE_INVALID_PARAM).setMoreMessage("info:".concat(e.tips)).end(),A.e("".concat(a," info:").concat(e.tips)),m({code:C.UPDATE_PROFILE_INVALID_PARAM});var t,n=[];for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&("profileCustomField"===t?o.profileCustomField.forEach(function(e){n.push({tag:e.key,value:e.value})}):n.push({tag:be[t.toUpperCase()],value:o[t]}));if(0===n.length)return e=new bn({code:C.UPDATE_PROFILE_NO_KEY}),s.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e);var r=this._userM.getMyAccount();return this._userM.req({proto:v.UPDATE_MY_PROFILE,data:{fromAccount:r,profileItem:n}}).then(function(e){s.end(),A.i("".concat(a," ok"));var t=i._update(r,o),n=t.isProfileUpdated,t=t.latestProfile;return!0===n&&i._userM.emitOuterEvent(G.PROFILE_UPDATED,[t]),Cn(t)}).catch(function(e){return s.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e)})}},{key:"onProfileModified",value:function(e){var t=e.dataList;if(!We(t)){var n=t.length;A.d("".concat(this._n,".onProfileModified count:").concat(n," dataList:"),e.dataList);for(var o=[],i=0;i<n;i++){var a=t[i].userID,a=this._update(a,this._getLatestProfileFromResponse(a,t[i].profileList)),s=a.isProfileUpdated,a=a.latestProfile;!0===s&&o.push(a)}0<o.length&&(this._userM.emitInnerEvent(Uo.PROFILE_UPDATED,o),this._userM.emitOuterEvent(G.PROFILE_UPDATED,o))}}},{key:"_fill",value:function(){if(0===this.accountProfileMap.size){for(var e=this._getCachedProfiles(),t=Date.now(),n=0,o=e.length;n<o;n++)t-e[n].lastUpdatedTime<this.expirationTime&&this.accountProfileMap.set(e[n].userID,e[n]);A.l("".concat(this._n,"._fill from cache, size:").concat(this.accountProfileMap.size))}}},{key:"_update",value:function(e,t){var n,o=!1,i=Date.now();return this._contains(e)?(n=this._getProfileFromMap(e),t.profileCustomField&&!0===It(n.profileCustomField,t.profileCustomField)&&(n.lastUpdatedTime=i,o=!0),0<ot(n,t,["profileCustomField"])&&(n.lastUpdatedTime=i,o=!0)):(n=new zo(t),!this._userM.isMyFriend(e)&&e!==this._userM.getMyAccount()||(n.lastUpdatedTime=i,o=!0,this.accountProfileMap.set(e,n))),this._flush(e===this._userM.getMyAccount()),!0===o&&A.l("".concat(this._n,"._update account:").concat(e," isProfileUpdated:").concat(o)),{isProfileUpdated:o,latestProfile:n}}},{key:"_flush",value:function(e){var t=T(this.accountProfileMap.values()),n=this._userM.getStorageModule();A.d("".concat(this._n,"._flush length:").concat(t.length," flushAtOnce:").concat(e)),n.setItem(this.TAG,t,e)}},{key:"_contains",value:function(e){return this.accountProfileMap.has(e)}},{key:"_getProfileFromMap",value:function(e){return this.accountProfileMap.get(e)}},{key:"_getCachedProfiles",value:function(){var e=this._userM.getStorageModule().getItem(this.TAG);return We(e)?[]:e}},{key:"onConversationsProfileUpdated",value:function(e){for(var t,n,o,i=[],a=0,s=e.length;a<s;a++)n=(t=e[a]).userID,this._userM.isMyFriend(n)&&(this._contains(n)?(o=this._getProfileFromMap(n),0<ot(o,t)&&i.push(n)):i.push(t.userID));0!==i.length&&(A.i("".concat(this._n,".onConversationsProfileUpdated toAccountList:").concat(i)),this.getUserProfile({userIDList:i}))}},{key:"getNickAndAvatarByUserID",value:function(e){return this._contains(e)?{nick:(e=this._getProfileFromMap(e)).nick,avatar:e.avatar}:{nick:"",avatar:""}}},{key:"getUserNickAndAvatar",value:function(e){var t=this,n=T(new Set(e)),o=(A.l("".concat(this._n,".getUserNickAndAvatar userIDList.length:").concat(e.length," uniqueUserIDList.length:").concat(n.length)),[]);if(0===e.length)return Promise.resolve(o);var e=this._createUserIDListGroup(n),i=[];return e.forEach(function(e){i.push(t.getUserProfile({userIDList:e}))}),Promise.all(i).then(function(e){return e.forEach(function(e){e=e.data.map(function(e){return{userID:e.userID,nick:e.nick,avatar:e.avatar}});o.push.apply(o,T(e))}),o})}},{key:"_createUserIDListGroup",value:function(e){for(var t=[],n=0;n<e.length;)t.push(e.slice(n,n+=100));return t}},{key:"reset",value:function(){this._flush(!0),this.accountProfileMap.clear()}}]),Gi),yi=e(function e(t){u(this,e)}),Ci=(e(Ni,[{key:"getLocalBlacklist",value:function(){return T(this._blacklistMap.keys())}},{key:"getBlacklist",value:function(){var o=this,i="".concat(this._n,".getBlacklist"),e={fromAccount:this._userM.getMyAccount(),maxLimited:this.maxLimited,startIndex:0,lastSequence:this.currentSequence},a=new M("getBlacklist");return this._userM.req({proto:v.GET_BL,data:e}).then(function(e){var e=e.data,t=e.blackListItem,e=e.currentSequence,n=We(t)?0:t.length;a.setMessage("count:".concat(n)).end(),A.i("".concat(i," ok")),o.currentSequence=e,o._handleResponse(t,!0),o._userM.emitOuterEvent(G.BLACKLIST_UPDATED,T(o._blacklistMap.keys()))}).catch(function(e){return a.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"addBlacklist",value:function(t){var e,n,o=this,i=new M("addToBlacklist"),a="".concat(this._n,".addBlacklist"),s=this._userM.getMyAccount();return 1===t.userIDList.length&&t.userIDList[0]===s?(n=this._userM.getErrorMessage(e=C.CANNOT_ADD_SELF_TO_BLACKLIST),i.setCode(e).setMessage(n).end(),n=new bn({code:e}),A.e("".concat(a," failed. error:"),n),m(n)):(t.userIDList.includes(s)&&(t.userIDList=t.userIDList.filter(function(e){return e!==s})),t.fromAccount=this._userM.getMyAccount(),t.toAccount=t.userIDList,this._userM.req({proto:v.ADD_TO_BL,data:t}).then(function(e){return i.setMessage(5<t.userIDList.length?"userIDList.length:".concat(t.userIDList.length):"userIDList:".concat(t.userIDList)).end(),A.i("".concat(a," ok")),o._handleResponse(e.resultItem,!0),yn(T(o._blacklistMap.keys()))}).catch(function(e){return i.setError(e).end(),A.e("".concat(a," failed. error:"),e),m(e)}))}},{key:"_handleResponse",value:function(e,t){if(!We(e))for(var n,o,i,a=0,s=e.length;a<s;a++)o=e[a].to,i=e[a].resultCode,!k(i)&&0!==i||(t?((n=this._blacklistMap.has(o)?this._blacklistMap.get(o):new yi).userID=o,We(e[a].addBlackTimeStamp)||(n.timeStamp=e[a].addBlackTimeStamp),this._blacklistMap.set(o,n)):this._blacklistMap.has(o)&&(n=this._blacklistMap.get(o),this._blacklistMap.delete(o)));A.l("".concat(this._n,"._handleResponse total:").concat(this._blacklistMap.size," bAdd:").concat(t))}},{key:"deleteBlacklist",value:function(t){var n=this,o="".concat(this._n,".deleteBlacklist"),i=new M("removeFromBlacklist");return t.fromAccount=this._userM.getMyAccount(),t.toAccount=t.userIDList,this._userM.req({proto:v.RM_FROM_BL,data:t}).then(function(e){return i.setMessage(5<t.userIDList.length?"userIDList.length:".concat(t.userIDList.length):"userIDList:".concat(t.userIDList)).end(),A.i("".concat(o," ok")),n._handleResponse(e.data.resultItem,!1),yn(T(n._blacklistMap.keys()))}).catch(function(e){return i.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"onAccountDeleted",value:function(e){for(var t=0,n=e.length;t<n;t++){var o=e[t];this._blacklistMap.has(o)&&this._blacklistMap.delete(o)}var i=e.length;0<i&&(A.l("".concat(this._n,".onAccountDeleted count:").concat(i," ").concat(i<30?"userIDList:".concat(e):"")),this._userM.emitOuterEvent(G.BLACKLIST_UPDATED,T(this._blacklistMap.keys())))}},{key:"onAccountAdded",value:function(e){for(var t,n=[],o=0,i=e.length;o<i;o++)t=e[o],this._blacklistMap.has(t)||(this._blacklistMap.set(t,new yi({userID:t})),n.push(t));0<n.length&&(A.l("".concat(this._n,".onAccountAdded count:").concat(n.length," userIDList:"),n),this._userM.emitOuterEvent(G.BLACKLIST_UPDATED,T(this._blacklistMap.keys())))}},{key:"reset",value:function(){this._blacklistMap.clear(),this.startIndex=0,this.maxLimited=100,this.currentSequence=0}}]),Ni),Ti=(e(Oi,[{key:"_onCloudConfigUpdated",value:function(){var e=this._userM.getCloudConfig("status_query_count"),t=this._userM.getCloudConfig("status_sub_count"),n=this._userM.getCloudConfig("status_unsub_count");A.l("".concat(this._n,"._onCloudConfigUpdated statusQueryCount:").concat(e," statusSubscribeCount:").concat(t)+" statusUnsubscribeCount:".concat(n)),k(e)||(this.MAX_QUERY_USER_COUNT=parseInt(e,10)),k(e)||(this.MAX_SUBSCRIBE_USER_COUNT=parseInt(t,10)),k(e)||(this.MAX_UNSUBSCRIBE_USER_COUNT=parseInt(n,10))}},{key:"onUserStatusUpdated",value:function(e){var e=e.dataList,o=this._userM.getMyUserID(),i=this._userM.get(12),e=e.map(function(e){var t=e.to,n=e.statusType,e=e.customStatus,e=Vo(e);return t===o&&i.setCustomStatus(e),{userID:t,statusType:n,customStatus:e}});A.l("".concat(this._n,".onUserStatusUpdated list:").concat(JSON.stringify(e))),this._userM.emitOuterEvent(G.USER_STATUS_UPDATED,e)}},{key:"setSelfStatus",value:function(e){var t=this,n="".concat(this._n,".setSelfStatus");if(!1===this._userM.filterProfanity("customStatus",e))return m({code:C.PROFANITY_FOUND});var o=new M("setSelfStatus"),i=e.customStatus;return this._userM.req({proto:v.SET_SELF_STATUS,data:{customStatus:i}}).then(function(e){return o.setMessage("customStatus:".concat(i)).end(),A.l("".concat(n," ok. customStatus:").concat(i)),t._userM.get(12).setCustomStatus(i),yn({userID:t._userM.getMyUserID(),statusType:1,customStatus:i})}).catch(function(e){return o.setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"getUserStatus",value:function(e){var o="".concat(this._n,".").concat("getUserStatus"),e=e.userIDList,i=void 0===e?[]:e,e=this._userM.getMyUserID(),t=T(i),a=void 0,n=t.indexOf(e);if(-1<n&&(t.splice(n,1),a={userID:e,statusType:1,customStatus:this._userM.get(12).getCustomStatus()}),0===t.length)return Cn({successUserList:[a],failureUserList:[]});if(!this._userM.canIUse(H.USER_STATUS))return this._userM.cannotUseCommercialAbility("getUserStatus");t.length>this.MAX_QUERY_USER_COUNT&&(A.w("".concat(o," ").concat(Wt(this.MAX_QUERY_USER_COUNT))),t=i.slice(0,this.MAX_QUERY_USER_COUNT));var s=new M("getUserStatus");return this._userM.req({proto:v.GET_USER_STATUS,data:{userIDList:t}}).then(function(e){var e=e.data,t=e.successUserList,t=void 0===t?[]:t,e=e.failureUserList,e=void 0===e?[]:e,t=t.map(function(e){var t=e.userID,n=e.statusType,e=e.customStatus;return{userID:t,statusType:n,customStatus:Vo(e)}}),e=e.map(function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode,e=e.errorInfo;return{userID:We(n)?t:n,code:o,message:e}}),n=(k(a)||t.unshift(a),"userID count:".concat(i.length,", success count:").concat(t.length,", fail count:").concat(e.length));return s.setMessage("".concat(n)).end(),A.l("".concat(o," ok. ").concat(n,".")),yn({successUserList:t,failureUserList:e})}).catch(function(e){return s.setMessage("userID count:".concat(i.length)).setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"subscribeUserStatus",value:function(e){var t="subscribeUserStatus";if(!this._userM.canIUse(H.USER_STATUS))return this._userM.cannotUseCommercialAbility(t);var n="".concat(this._n,".").concat(t),e=e.userIDList,e=void 0===e?[]:e,o=T(e),i=(o.length>this.MAX_SUBSCRIBE_USER_COUNT&&(A.w("".concat(n," ").concat(Wt(this.MAX_SUBSCRIBE_USER_COUNT))),o=e.slice(0,this.MAX_SUBSCRIBE_USER_COUNT)),new M(t)),a="userID count:".concat(e.length);return A.l("".concat(n," ").concat(a)),this._userM.req({proto:v.SUB_USER_STATUS,data:{userIDList:o}}).then(function(e){e=e.data.failureUserList,e=(void 0===e?[]:e).map(function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode,e=e.errorInfo;return{userID:We(n)?t:n,code:o,message:e}});return i.setMessage("".concat(a," fail count:").concat(e.length)).end(),A.l("".concat(n," ok. fail count:").concat(e.length,".")),yn({failureUserList:e})}).catch(function(e){return i.setMessage(a).setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"unsubscribeUserStatus",value:function(e){var t="unsubscribeUserStatus";if(!this._userM.canIUse(H.USER_STATUS))return this._userM.cannotUseCommercialAbility(t);var n="".concat(this._n,".").concat(t),e=(e||{}).userIDList,e=void 0===e?[]:e,o=T(e),i=(e.length>this.MAX_UNSUBSCRIBE_USER_COUNT&&(A.w("".concat(n," ").concat(Wt(this.MAX_UNSUBSCRIBE_USER_COUNT))),o=e.slice(0,this.MAX_UNSUBSCRIBE_USER_COUNT)),new M(t)),a="userID count:".concat(e.length),t=(A.l("".concat(n," ").concat(a)),{userIDList:o});return 0===o.length&&(t.userIDList=void 0,t.unsubscribeAll=1),this._userM.req({proto:v.UNSUB_USER_STATUS,data:t}).then(function(e){e=e.data.failureUserList,e=(void 0===e?[]:e).map(function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode,e=e.errorInfo;return{userID:We(n)?t:n,code:o,message:e}});return i.setMessage("".concat(a," fail count:").concat(e.length)).end(),A.l("".concat(n," ok. fail count:").concat(e.length,".")),yn({failureUserList:e})}).catch(function(e){return i.setMessage("".concat(a)).setError(e).end(),A.e("".concat(n," failed. error:"),e),m(e)})}},{key:"reset",value:function(){this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100}}]),Oi),Di=(t(Ri,Nn),Bo=f(Ri),e(Ri,[{key:"onContextUpdated",value:function(e){this._profileHandler.getMyProfile(),this._blacklistHandler.getBlacklist()}},{key:"mockOnNickAvatarModified",value:function(e,t){A.l("".concat(this._n,"._mockOnNickAvatarModified nick:").concat(e," avatar:").concat(t)),this.onProfileModified({dataList:[{pushType:1,userID:this.getMyUserID(),profileList:[{tag:be.NICK,value:e},{tag:be.AVATAR,value:t}]}]})}},{key:"onProfileModified",value:function(e){this._profileHandler.onProfileModified(e)}},{key:"onRelationChainModified",value:function(e){var t,n,e=e.dataList;We(e)||(t=[],e.forEach(function(e){e.blackListDelAccount&&t.push.apply(t,T(e.blackListDelAccount))}),0<t.length&&this._blacklistHandler.onAccountDeleted(t),n=[],e.forEach(function(e){e.blackListAddAccount&&n.push.apply(n,T(e.blackListAddAccount))}),0<n.length&&this._blacklistHandler.onAccountAdded(n))}},{key:"onConversationsProfileUpdated",value:function(e){this._profileHandler.onConversationsProfileUpdated(e)}},{key:"getMyAccount",value:function(){return this.getMyUserID()}},{key:"getMyNick",value:function(){return this._profileHandler.getNickAndAvatarByUserID(this.getMyUserID()).nick}},{key:"getMyProfile",value:function(){return this._profileHandler.getMyProfile()}},{key:"getStorageModule",value:function(){return this.get(13)}},{key:"filterProfanity",value:function(e,t){var n=this.get(29);if(!n)return!0;var n=n.filterText(t[e],"user_profile"),o=n.isAllowedToSend,n=n.modifiedText;return!0===o&&(t[e]=n,!0)}},{key:"isMyFriend",value:function(e){var t=this.get(8);return!!t&&t.isMyFriend(e)}},{key:"getUserProfile",value:function(e){return this._profileHandler.getUserProfile(e)}},{key:"updateMyProfile",value:function(e){return this._profileHandler.updateMyProfile(e)}},{key:"getNickAndAvatarByUserID",value:function(e){return this._profileHandler.getNickAndAvatarByUserID(e)}},{key:"getUserNickAndAvatar",value:function(e){return this._profileHandler.getUserNickAndAvatar(e)}},{key:"getLocalBlacklist",value:function(){var e=this._blacklistHandler.getLocalBlacklist();return Cn(e)}},{key:"addBlacklist",value:function(e){return this._blacklistHandler.addBlacklist(e)}},{key:"deleteBlacklist",value:function(e){return this._blacklistHandler.deleteBlacklist(e)}},{key:"onUserStatusUpdated",value:function(e){this._userStatusHandler.onUserStatusUpdated(e)}},{key:"setSelfStatus",value:function(e){return this._userStatusHandler.setSelfStatus(e)}},{key:"getUserStatus",value:function(e){return this._userStatusHandler.getUserStatus(e)}},{key:"subscribeUserStatus",value:function(e){return this._userStatusHandler.subscribeUserStatus(e)}},{key:"unsubscribeUserStatus",value:function(e){return this._userStatusHandler.unsubscribeUserStatus(e)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._profileHandler.reset(),this._blacklistHandler.reset(),this._userStatusHandler.reset()}}]),Ri),Ei=(e(ki,[{key:"isLoggedIn",value:function(){return this._isLoggedIn}},{key:"isOversea",value:function(){return this._oversea}},{key:"isPrivateNetWork",value:function(){return this._proxyServer}},{key:"isDevMode",value:function(){return this._isDevMode}},{key:"isTestEnv",value:function(){return this._isTestEnv}},{key:"isPartialUpdatedConvs",value:function(){return this._isPartialUpdatedConvs}},{key:"isSingaporeSite",value:function(){return 2e7<=this._SDKAppID&&this._SDKAppID<3e7||172e7<=this._SDKAppID&&this._SDKAppID<173e7}},{key:"isKoreaSite",value:function(){return 3e7<=this._SDKAppID&&this._SDKAppID<4e7||173e7<=this._SDKAppID&&this._SDKAppID<174e7}},{key:"isGermanySite",value:function(){return 4e7<=this._SDKAppID&&this._SDKAppID<5e7||174e7<=this._SDKAppID&&this._SDKAppID<175e7}},{key:"isIndiaSite",value:function(){return 5e7<=this._SDKAppID&&this._SDKAppID<6e7||175e7<=this._SDKAppID&&this._SDKAppID<176e7}},{key:"isJapanSite",value:function(){return 6e7<=this._SDKAppID&&this._SDKAppID<7e7||176e7<=this._SDKAppID&&this._SDKAppID<177e7}},{key:"isUSASite",value:function(){return 7e7<=this._SDKAppID&&this._SDKAppID<8e7||177e7<=this._SDKAppID&&this._SDKAppID<178e7}},{key:"isIndonesiaSite",value:function(){return 8e7<=this._SDKAppID&&this._SDKAppID<9e7||178e7<=this._SDKAppID&&this._SDKAppID<179e7}},{key:"isIntl",value:function(){return 0===(e=this._SDKAppID)||2e7<=e&&e<9e7||172e7<=e&&e<179e7;var e}},{key:"isUnlimitedAVChatRoom",value:function(){return this._unlimitedAVChatRoom}},{key:"isUsingChatCore",value:function(){return this._isUsingChatCore}},{key:"setUsingChatCore",value:function(e){this._isUsingChatCore=e}},{key:"getUIPlatform",value:function(){return this._uiPlatform}},{key:"setUIPlatform",value:function(e){this._uiPlatform=e}},{key:"setUserID",value:function(e){this._userID=e}},{key:"getUserID",value:function(){return this._userID}},{key:"setUserSig",value:function(e){this._userSig=e}},{key:"getUserSig",value:function(){return this._userSig}},{key:"getSDKAppID",value:function(){return this._SDKAppID}},{key:"setTinyID",value:function(e){this._tinyID=e,this._isLoggedIn=!0}},{key:"getTinyID",value:function(){return this._tinyID}},{key:"setCustomStatus",value:function(e){this._customStatus=e}},{key:"getCustomStatus",value:function(){return this._customStatus}},{key:"getScene",value:function(){return Ie?window.tencent_cloud_im_csig_flutter_for_web_25F_cy:this._isTUIKit()?"tuikit":this._scene}},{key:"getInstanceID",value:function(){return this._instanceID}},{key:"getStatusInstanceID",value:function(){return this._statusInstanceID}},{key:"setStatusInstanceID",value:function(e){this._statusInstanceID=e}},{key:"getVersion",value:function(){return this._version}},{key:"getA2Key",value:function(){return this._a2Key}},{key:"setA2Key",value:function(e){this._a2Key=e}},{key:"getContentType",value:function(){return this._contentType}},{key:"getProxyServer",value:function(){return this._proxyServer}},{key:"getFileUploadProxy",value:function(){return this._fileUploadProxy}},{key:"getFileDownloadProxy",value:function(){return this._fileDownloadProxy}},{key:"setApplicationID",value:function(e){this._applicationID=e}},{key:"getApplicationID",value:function(){return this._applicationID}},{key:"_isTUIKit",value:function(){var e=!1,t=!1,n=!1,o=!1,i=[];te&&(i=Object.keys(oe));for(var a=0,s=(i=ne?ee?Object.keys(uni):Object.keys(window):i).length;a<s;a++)if(i[a].toLowerCase().includes("uikit")){e=!0;break}var r,i=null,c=(te&&!$e(oe.createGamePortal)&&$e(getApp)&&!k(getApp())&&(r=getApp().globalData,Ze(r)&&!0===r.isTUIKit&&(t=!0)),!0===this._m.get(13).getStorageSync("TIM_".concat(this._SDKAppID,"_isTUIKit"))&&(n=!0),null);if(Y&&!z&&"undefined"==typeof uni&&__wxConfig&&(c=__wxConfig.pages),J&&"undefined"==typeof uni&&__qqConfig&&(c=__qqConfig.pages),Qe(c)&&0<c.length){for(var u=0,l=c.length;u<l;u++)if(c[u].toLowerCase().includes("tui")){o=!0;break}c=null}return e||t||n||o}},{key:"reset",value:function(){this._isLoggedIn=!1,this._userSig="",this._a2Key="",this._tinyID="",this._customStatus="",this._statusInstanceID=0}}]),ki),Li={"k-vue2-pc":1,"k-vue2-h5":2,"k-vue2-h5-uni":3,"k-vue2-app-uni":4,"k-vue2-mp-uni":5,"k-vue2-pc-uni":6,"k-vue3-pc":7,"k-vue3-h5":8,"k-vue3-h5-uni":9,"k-vue3-app-uni":10,"k-vue3-mp-uni":11,"k-vue3-pc-uni":12},Si=(t(Ai,Nn),Ho=f(Ai),e(Ai,[{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&e%this._helloInterval==0&&this._hello()}},{key:"getPushModule",value:function(){var e=void 0,t=this.get(36),n=this.get(28);return t.canIUseTIMPush()?e=t:n.canIUseOfflinePush()&&(e=n),e}},{key:"login",value:function(e){if(this.isLoggedIn())return t=this.getMyUserID(),(t=this.getErrorMessage("RepeatLogin",t))&&A.w(t),Cn({actionStatus:"OK",errorCode:0,errorInfo:t,repeatLogin:!0});if(Date.now()-this._lastLoginTs<=15e3)return this.outputWarning("LoggingIn",e.userID),m({code:C.REPEAT_LOGIN});A.l("".concat(this._n,".login userID:").concat(e.userID));var t=this._checkLoginInfo(e);if(0!==t.code)return m(t);var t=this.get(12),n=e.userID,e=e.userSig;return t.setUserID(n),t.setUserSig(e),this.get(20).updateProtocolConfig(),this._login()}},{key:"_login",value:function(){var p=this,_=this.get(12),g=_.getScene(),e=0,t=g,h=(g&&g.startsWith("k-")&&(t=Li[g],g="tuikit"),new M("login")),n=(h.setMessage("".concat(t)).setMoreMessage("identifier:".concat(this.getMyUserID())),"tuikit"===g),o=0,n=(ee?o=n?3===t||4===t||5===t||6===t?31:9===t||10===t||11===t||12===t?32:4:3:te?o=j?36:"tuikit"===g?12:11:ne&&(o=Ie?"flutter_web_uikit"===g?21:20:this._isReactUIKit()?Me?25:24:n?1===t||2===t?29:7===t||8===t?30:Me?17:14:Me?16:13),h.setUIPlatform(o),_.setUIPlatform(o),this.getPushModule()),f=(n&&(this._isWebUniapp=n.getUniAppPlatform(),t=this._getStatusInstanceID(),_.setStatusInstanceID(t),this.get(20).updateProtocolConfig(),e=n.getDeviceBrand()),"".concat(this._n,"._login"));return this._lastLoginTs=Date.now(),this.req({proto:v.LOGIN,data:{deviceBrand:e,isWebUniapp:this._isWebUniapp}}).then(function(e){p._lastLoginTs=0;var t=Date.now(),n=null,o=e.data,i=o.a2Key,l=o.tinyID,d=o.helloInterval,a=o.instanceID,s=o.timeStamp,r=o.customStatus,r=void 0===r?"":r,o=o.purchaseBits,c=1e3*s,u=t-h.getStartTs(),u=c+parseInt(u/2)-t,t=h.getStartTs()+u;if(h.start(t),t=c,Re=u,(c=new Date).setTime(t),A.i("baseTime from server:".concat(c," offset:").concat(Re)),!l)throw n=new bn({code:C.NO_TINYID}),h.setError(n).end(),n;if(!i)throw n=new bn({code:C.NO_A2KEY}),h.setError(n).end(),n;t=Vo(r),c="scene:".concat(g," helloInterval:").concat(d," instanceID:").concat(a," timeStamp:").concat(s," offset:").concat(u," customStatus:").concat(t," "),A.l("".concat(f," ok. ").concat(c)),n="",r="",Y&&$e(oe.getAccountInfoSync)&&((s=oe.getAccountInfoSync().miniProgram)&&(n=s.appId,r=s.envVersion)),h.setMoreMessage("".concat(c," href:").concat(ne?window.location.href:""," mpAppId:").concat(n," envVersion:").concat(r)).end(),_.setA2Key(i),_.setTinyID(l),_.setStatusInstanceID(a),_.setCustomStatus(t),o&&p.get(27).onPushedConfig({errorCode:0,expiredTime:0,purchaseBits:o}),p.get(20).updateProtocolConfig(),p.emitInnerEvent(Uo.A2KEY_AND_TINYID_UPDATED),p._helloInterval=d,p.triggerReady(),u=p.getPushModule();return u&&(uni.setStorageSync("timUniAppInstanceID",a),u.init()),p._fetchCloudControlConfig(),p.get(29).init(),e}).catch(function(e){return h.setError(e).end(!0),p._m.setNotReadyReason(C.LOGIN_FAILED),A.e("".concat(f," failed. error:"),e),p._lastLoginTs=0,p._m.onLoginFailed(),m(e)})}},{key:"logout",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;if(!this.isLoggedIn())return m({code:C.USER_NOT_LOGGED_IN});new M("logout").setMessage("identifier:".concat(this.getMyUserID())).end(!0);var n="".concat(this._n,".logout");return A.i("".concat(n," type:").concat(e)),0===e&&this._m.setNotReadyReason(C.LOGGED_OUT),this.req({proto:v.LOGOUT,data:{type:e}}).then(function(){return t.resetReady(),Cn({})}).catch(function(e){return A.e("".concat(n," error:"),e),t.resetReady(),Cn({})})}},{key:"getLoginUser",value:function(){return this.isLoggedIn()?this.getMyUserID():""}},{key:"_fetchCloudControlConfig",value:function(){this.get(23).fetchConfig()}},{key:"_getStatusInstanceID",value:function(){return uni.getStorageSync("timUniAppInstanceID")||0}},{key:"_hello",value:function(){var t=this;this._lastWsHelloTs=Date.now(),this.req({proto:v.HELLO,data:{isWebUniapp:this._isWebUniapp}}).catch(function(e){A.w("".concat(t._n,"._hello error:"),e)})}},{key:"getLastWsHelloTs",value:function(){return this._lastWsHelloTs}},{key:"_checkLoginInfo",value:function(e){var t=0;return We(this.get(12).getSDKAppID())?t=C.NO_SDKAPPID:We(e.userID)?t=C.NO_IDENTIFIER:We(e.userSig)&&(t=C.NO_USERSIG),{code:t}}},{key:"_isReactUIKit",value:function(){return ne&&void 0!==window.tencent_cloud_im_csig_react_uikit_23F_xa}},{key:"onMultipleAccountKickedOut",value:function(e){var t=this;new M("kickedOut").setMessage("type:".concat(S.KICKED_OUT_MULT_ACCOUNT," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),A.w("".concat(this._n,".onMultipleAccountKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),this.logout(1).then(function(){t.emitOuterEvent(G.KICKED_OUT,{type:S.KICKED_OUT_MULT_ACCOUNT}),t._m.setNotReadyReason(C.KICKED_OUT_MULT_ACCOUNT),t._m.reset()})}},{key:"onMultipleDeviceKickedOut",value:function(e){var t=this;new M("kickedOut").setMessage("type:".concat(S.KICKED_OUT_MULT_DEVICE," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),A.w("".concat(this._n,".onMultipleDeviceKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),this.logout(1).then(function(){t.emitOuterEvent(G.KICKED_OUT,{type:S.KICKED_OUT_MULT_DEVICE}),t._m.setNotReadyReason(C.KICKED_OUT_MULT_DEVICE),t._m.reset()})}},{key:"onUserSigExpired",value:function(){new M("kickedOut").setMessage(S.KICKED_OUT_USERSIG_EXPIRED).end(!0),A.w("".concat(this._n,".onUserSigExpired userID:").concat(this.getMyUserID())),0!==this.get(12).getStatusInstanceID()&&(this.emitOuterEvent(G.KICKED_OUT,{type:S.KICKED_OUT_USERSIG_EXPIRED}),this._m.setNotReadyReason(C.KICKED_OUT_USERSIG_EXPIRED),this._m.reset())}},{key:"onRestApiKickedOut",value:function(e){new M("kickedOut").setMessage("type:".concat(S.KICKED_OUT_REST_API," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),A.w("".concat(this._n,".onRestApiKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),0!==this.get(12).getStatusInstanceID()&&(this.emitOuterEvent(G.KICKED_OUT,{type:S.KICKED_OUT_REST_API}),this._m.setNotReadyReason(C.KICKED_OUT_REST_API),this._m.reset(),this.get(21).onRestApiKickedOut())}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this.resetReady(),this._helloInterval=120,this._lastLoginTs=0,this._lastWsHelloTs=0,this._isWebUniapp=0}}]),Ai);function Ai(e){return u(this,Ai),(e=Ho.call(this,e))._n="SignModule",e._helloInterval=120,e._lastLoginTs=0,e._lastWsHelloTs=0,e._isWebUniapp=0,wo.mixin(g(e)),e}function ki(e,t){u(this,ki),this._m=e,this._isLoggedIn=!1,this._SDKAppID=t.SDKAppID,this._userID=t.userID||"",this._userSig=t.userSig||"",this._version="3.3.5",this._a2Key="",this._tinyID="",this._customStatus="",this._contentType="json",this._unlimitedAVChatRoom=t.unlimitedAVChatRoom,this._scene=t.scene||"",this._oversea=t.oversea,this._instanceID=t.instanceID,this._statusInstanceID=0,this._isDevMode=t.devMode,this._isTestEnv=t.testEnv,this._proxyServer=t.proxyServer,this._fileUploadProxy=t.fileUploadProxy,this._fileDownloadProxy=t.fileDownloadProxy,this._applicationID=0,this._isPartialUpdatedConvs=t.partialUpdatedConversations,this._isUsingChatCore=!1,this._uiPlatform=0}function Ri(e){return u(this,Ri),(e=Bo.call(this,e))._n="UserModule",e._profileHandler=new Ii(g(e)),e._blacklistHandler=new Ci(g(e)),e._userStatusHandler=new Ti(g(e)),e.getInnerEmitterInstance().on(Uo.A2KEY_AND_TINYID_UPDATED,e.onContextUpdated,g(e)),e}function Oi(e){u(this,Oi),this._userM=e,this._n="UserStatusHandler",this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100,this._userM.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}function Ni(e){u(this,Ni),this._userM=e,this._n="BlacklistHandler",this._blacklistMap=new Map,this.startIndex=0,this.maxLimited=100,this.currentSequence=0}function Gi(e){u(this,Gi),this._userM=e,this._n="ProfileHandler",this.TAG="profile",this.accountProfileMap=new Map,this.expirationTime=864e5}function Pi(e){return u(this,Pi),(e=Ko.call(this,e))._n="TopicModule",e._topicMap=new Map,e._getTopicTimeMap=new Map,e.TOPIC_CACHE_TIME=300,e.TOPIC_LAST_ACTIVE_TIME=3600,e.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,e._onCloudConfigUpdated,g(e)),e}function Ui(e,t){u(this,Ui),this.topicID="",this.topicName="",this.avatar="",this.introduction="",this.notification="",this.unreadCount=0,this.muteAllMembers=!1,this.customData="",this.groupAtInfoList=[],this.nextMessageSeq=0,this.lastMessage=xo(e.lastMessage,t),this.selfInfo={muteTime:0,readedSequence:0,messageRemindType:"",excludedUnreadSequenceList:void 0},this._initTopic(e)}function bi(e){return u(this,bi),(e=Wo.call(this,e))._n="GroupModule",e._commonGroupHandler=new si(g(e)),e._groupAttributesHandler=new ri(g(e)),e._groupCountersHandler=new ci(g(e)),e._AVChatRoomHandler=new di(g(e)),e._groupTipsHandler=new ai(g(e)),e._groupSystemNoticeHandler=new gi(g(e)),e._groupMemberHandler=new _i(g(e)),e.groupMap=new Map,e._unjoinedAVChatRoomList=new Map,e._receiptDetailCompleteMap=new Map,e._onlineMemberCountMap=new Map,e._timeoutIDs=[],e.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,e._onCloudConfigUpdated,g(e)),e}function Fi(e){u(this,Fi),this._grpM=e,this._n="GroupSystemNoticeHandler",this.pendencyMap=new Map}function wi(e){u(this,wi),this._grpM=e,this._n="GroupMemberHandler",this.groupMemberListMap=new Map,this.DEFAULT_MEMBER_INFO_FILTER=["Role","JoinTime","NameCard","ShutUpUntil","OnlineStatus"],this._grpM.getInnerEmitterInstance().on(Uo.PROFILE_UPDATED,this._onProfileUpdated,this)}function qi(e){u(this,qi),this.userID="",this.avatar="",this.nick="",this.role="",this.joinTime="",this.lastSendMsgTime="",this.nameCard="",this.muteUntil=0,this.memberCustomField=[],this.isOnline=!1,this.updateMember(e)}function xi(e){u(this,xi),this._grpM=e,this._n="AVChatRoomHandler",this._joinedGroupMap=new Map,this._pollingRequestInfoMap=new Map,this._pollingInstanceMap=new Map,this.sequencesLinkedList=new Zo(200),this.messageIDLinkedList=new Zo(100),this._reportMessageStackedCount=0,this._onlineMemberCountMap=new Map,this.DEFAULT_EXPIRE_TIME=60,this.DEFAULT_POLLING_INTERVAL=300,this.MAX_POLLING_INTERVAL=2e3,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0,this._startBroadcastSeq=1,this._broadcastMessageIDMap=new Map,this.DEFAULT_POLLING_SIMPLIFIED_MSG=0}function Vi(e){u(this,Vi);var t=e.manager,n=e.groupID,o=e.onInit,i=e.onSuccess,e=e.onFail;this._n="Polling",this._manager=t,this._grpM=t._grpM,this._onInit=o,this._onSuccess=i,this._onFail=e,this._groupID=n,this._timeoutID=-1,this._isRunning=!1,this._proto=v.AV_POLLING}function Hi(e){u(this,Hi),this._grpM=e,this._n="GroupCountersHandler",this._groupCountersMap=new Map,this.EXPIRE_TIME=3e4,this._grpM.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}function Bi(e){u(this,Bi),this._grpM=e,this._n="GroupAttributesHandler",this._groupAttributesMap=new Map,this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4,this._grpM.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}function Ki(e){u(this,Ki),this._grpM=e,this._n="CommonGroupHandler",this.tempConversationList=null,this._cachedGroupMessageMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4,this.PAGING_GRP_COUNT_LIMIT=200,this._pagingStatus=Sn,this._pagingGetCostList=[],e.getInnerEmitterInstance().on(Uo.A2KEY_AND_TINYID_UPDATED,this.syncGroupList,this)}function Wi(e){u(this,Wi),this._grpM=e,this._n="GroupTipsHandler",this._cachedGroupTipsMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4}function Yi(e){return u(this,Yi),(e=Yo.call(this,e))._n="ConversationModule",wo.mixin(g(e)),e._messageListHandler=new Po,e._messageRemindHandler=new ni(g(e)),e._convGroupHandler=new oi(g(e)),e.singlyLinkedList=new Zo(100),e._pagingStatus=Sn,e._pagingTimeStamp=0,e._pagingStartIndex=0,e._pagingPinnedTimeStamp=0,e._pagingPinnedStartIndex=0,e._pagingConvIDMap=new Map,e._convIDFromUnreadDBMap=new Map,e._conversationMap=new Map,e._tmpGroupList=[],e._tmpGroupAtTipsList=[],e._peerReadTimeMap=new Map,e._completedMap=new Map,e._roamingMessageKeyAndTimeMap=new Map,e._roamingMessageSequenceMap=new Map,e._remoteGroupReadSequenceMap=new Map,e._convTotalUnreadCount=0,e._pagingGetCostList=[],e._convMapForDiff=new Map,e._partialUpdatedConvMap=new Map,e._initListeners(),e}function ji(e){u(this,ji),this._convM=e,this._n="ConvGroupHandler",this._convGroupMap=new Map,this._startIndex=0,this._pagingStatus=Sn}function Ji(e){u(this,Ji),this._convM=e,this._n="MessageRemindHandler"}function zi(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];u(this,zi),this.conversationID=e.conversationID||"",this.unreadCount=e.unreadCount||0,this.type=e.type||"",this.lastMessage=qo(e.lastMessage,t,n),e.lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),this._isInfoCompleted=!1,this.peerReadTime=e.peerReadTime||0,this.groupAtInfoList=[],this.remark="",this.isPinned=e.isPinned||!1,this.messageRemindType=e.messageRemindType,this.markList=e.markList||[],this.customData=e.customData||"",this.conversationGroupList=e.conversationGroupList||[],this.draftText=e.draftText||"",this._initProfile(e),this.subType=this.groupProfile?this.groupProfile.type:""}function Xi(e){u(this,Xi),this.groupID="",this.name="",this.avatar="",this.type="",this.introduction="",this.notification="",this.ownerID="",this.createTime="",this.infoSequence="",this.lastInfoTime="",this.selfInfo={messageRemindType:"",joinTime:"",nameCard:"",role:"",userID:"",memberCustomField:void 0,readedSequence:0,excludedUnreadSequenceList:void 0},this.lastMessage={lastTime:"",lastSequence:"",fromAccount:"",messageForShow:""},this.nextMessageSeq="",this.memberNum="",this.memberCount="",this.maxMemberNum="",this.maxMemberCount="",this.joinOption="",this.inviteOption="",this.groupCustomField=[],this.muteAllMembers=!1,this.isSupportTopic=!1,this._lastRevokedTime=0,this._initGroup(e)}function Zi(e){u(this,Zi),this.MAX_LENGTH=e,this.pTail=null,this.pNodeToDel=null,this.map=new Map}function Qi(e){var t=this;u(this,Qi),We(e)||(this.userID=e.userID||"",this.nick=e.nick||"",this.gender=e.gender||"",this.birthday=e.birthday||0,this.location=e.location||"",this.selfSignature=e.selfSignature||"",this.allowType=e.allowType||S.ALLOW_TYPE_ALLOW_ANY,this.language=e.language||0,this.avatar=e.avatar||"",this.messageSettings=e.messageSettings||0,this.adminForbidType=e.adminForbidType||S.FORBID_TYPE_NONE,this.level=e.level||0,this.role=e.role||0,this.lastUpdatedTime=0,this.profileCustomField=[],We(e.profileCustomField)||e.profileCustomField.forEach(function(e){t.profileCustomField.push({key:e.key,value:e.value})}))}function $i(){return null}function ea(e){var t=e.get(12);return{SDKType:10,SDKAppID:t.getSDKAppID(),SDKVersion:t.getVersion(),tinyID:Number(t.getTinyID()),userID:t.getUserID(),platform:e.getPlatform(),instanceID:t.getInstanceID(),traceID:Oe()}}e(da,[{key:"_errorTolerantHandle",value:function(){te||!k(window)&&this._canIUseCookies()||(this.getItem=$i,this.setItem=$i,this.removeItem=$i,this.clear=$i)}},{key:"onCheckTimer",value:function(e){e%20==0&&0!==this._storageQueue.size&&this._doFlush()}},{key:"_doFlush",value:function(){try{var e,t=N(this._storageQueue);try{for(t.s();!(e=t.n()).done;){var n=I(e.value,2),o=n[0],i=n[1];this._setStorageSync(this._getKey(o),i)}}catch(e){t.e(e)}finally{t.f()}this._storageQueue.clear()}catch(e){A.w("".concat(this._n,"._doFlush error:"),e)}}},{key:"_getPrefix",value:function(){var e=this._m.get(12);return"TIM_".concat(e.getSDKAppID(),"_").concat(e.getUserID(),"_")}},{key:"_getKey",value:function(e){return"".concat(this._getPrefix()).concat(e)}},{key:"getItem",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];try{var n=t?this._getKey(e):e;return this.getStorageSync(n)}catch(e){return A.w("".concat(this._n,".getItem error:"),e),{}}}},{key:"setItem",value:function(e,t){var n;2<arguments.length&&void 0!==arguments[2]&&arguments[2]?(n=!(3<arguments.length&&void 0!==arguments[3])||arguments[3]?this._getKey(e):e,this._setStorageSync(n,t)):this._storageQueue.set(e,t)}},{key:"clear",value:function(){try{te?oe.clearStorageSync():this._canIUseCookies()&&localStorage.clear()}catch(e){A.w("".concat(this._n,".clear error:"),e)}}},{key:"removeItem",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];try{var n=t?this._getKey(e):e;this._removeStorageSync(n)}catch(e){A.w("".concat(this._n,".removeItem error:"),e)}}},{key:"getSize",value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"b";try{var o={size:0,limitSize:5242880,unit:n};if(Object.defineProperty(o,"leftSize",{enumerable:!0,get:function(){return o.limitSize-o.size}}),te&&(o.limitSize=1024*oe.getStorageInfoSync().limitSize),e)o.size=JSON.stringify(this.getItem(e)).length+this._getKey(e).length;else if(te)oe.getStorageInfoSync().keys.forEach(function(e){o.size+=JSON.stringify(t.getStorageSync(e)).length+t._getKey(e).length});else if(this._canIUseCookies())for(var i in localStorage)localStorage.hasOwnProperty(i)&&(o.size+=localStorage.getItem(i).length+i.length);return this._convertUnit(o)}catch(e){A.w("".concat(this._n," error:"),e)}}},{key:"_convertUnit",value:function(e){var t,n={},o=e.unit;for(t in n.unit=o,e)"number"==typeof e[t]&&("kb"===o.toLowerCase()?n[t]=Math.round(e[t]/1024):"mb"===o.toLowerCase()?n[t]=Math.round(e[t]/1024/1024):n[t]=e[t]);return n}},{key:"_setStorageSync",value:function(e,t){te?Z?my.setStorageSync({key:e,data:t}):oe.setStorageSync(e,t):this._canIUseCookies()&&localStorage.setItem(e,JSON.stringify(t))}},{key:"getStorageSync",value:function(e){return te?Z?my.getStorageSync({key:e}).data:oe.getStorageSync(e):this._canIUseCookies()?JSON.parse(localStorage.getItem(e)):{}}},{key:"_removeStorageSync",value:function(e){te?Z?my.removeStorageSync({key:e}):oe.removeStorageSync(e):this._canIUseCookies()&&localStorage.removeItem(e)}},{key:"_canIUseCookies",value:function(){return navigator&&navigator.cookieEnabled&&localStorage}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._doFlush()}}]);var ta,na=da,oa=(e(la,[{key:"pushIn",value:function(e){A.d("".concat(this._n,".pushIn"),this._report.length,e),this._report.push(e)}},{key:"backfill",value:function(e){var t;Qe(e)&&0!==e.length&&(A.d("".concat(this._n,".backfill"),this._report.length,e.length),(t=this._report).unshift.apply(t,T(e)))}},{key:"getLogsNumInMemory",value:function(){return this._report.length}},{key:"isEmpty",value:function(){return 0===this._report.length}},{key:"_reset",value:function(){this._report.length=0,this._report=[]}},{key:"getLogsInMemory",value:function(){var e=this._report.slice();return this._reset(),e}}]),la),ia=(t(ua,Nn),ta=f(ua),e(ua,[{key:"reportAtOnce",value:function(){this._report()}},{key:"_onLoginSuccess",value:function(){var t=this,e=this.get(13),n=e.getItem(this.TAG,!1);!We(n)&&$e(n.forEach)&&(A.l("".concat(this._n,"._onLoginSuccess. logs count:").concat(n.length)),n.forEach(function(e){t._reportBody.pushIn(e)}),e.removeItem(this.TAG,!1))}},{key:"_onCloudConfigUpdated",value:function(){var e=this.getCloudConfig("evt_rpt_threshold"),t=this.getCloudConfig("evt_rpt_waiting"),n=this.getCloudConfig("evt_rpt_level"),o=this.getCloudConfig("evt_rpt_sdkappid_bl"),i=this.getCloudConfig("evt_rpt_tinyid_wl");k(e)||(this.MIN_THRESHOLD=Number(e)),k(t)||(this.WAITING_TIME=Number(t)),k(n)||(this.REPORT_LEVEL=n.split(",").map(function(e){return Number(e)})),k(o)||(this.REPORT_SDKAPPID_BLACKLIST=o.split(",").map(function(e){return Number(e)})),k(i)||(this.REPORT_TINYID_WHITELIST=i.split(","))}},{key:"pushIn",value:function(e){e instanceof M&&(e.updateTimeStamp(),this._reportBody.pushIn(e),this._reportBody.getLogsNumInMemory()>=this.MIN_THRESHOLD&&this._report())}},{key:"onCheckTimer",value:function(){Date.now()<this._lastReportTime+this.WAITING_TIME||this._reportBody.isEmpty()||this._report()}},{key:"_filterLogs",value:function(e){var t=this,n=this.get(12),o=n.getSDKAppID(),n=n.getTinyID();return wt(this.REPORT_SDKAPPID_BLACKLIST,o)&&!qt(this.REPORT_TINYID_WHITELIST,n)?[]:e.filter(function(e){return t.REPORT_LEVEL.includes(e.level)})}},{key:"_report",value:function(){var t,e,n=this;this._reportBody.isEmpty()||(t=this._reportBody.getLogsInMemory(),0!==(e=this._filterLogs(t)).length?(e={header:ea(this),event:e},this.req({proto:v.SSO_STAT,data:y({},e)}).then(function(){n._lastReportTime=Date.now()}).catch(function(e){A.w("".concat(n._n,"._report failed. error:"),e),n._lastReportTime=Date.now(),n._reportBody.backfill(t),n._reportBody.getLogsNumInMemory()>n.MAX_THRESHOLD&&n._flushAtOnce()})):this._lastReportTime=Date.now())}},{key:"_flushAtOnce",value:function(){var e=this.get(13),t=e.getItem(this.TAG,!1),n=this._reportBody.getLogsInMemory(),o="".concat(this._n,"._flushAtOnce");We(t)?(A.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)):((n=n.concat(t)).length>this.MAX_THRESHOLD&&(n=n.slice(0,this.MAX_THRESHOLD)),A.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1))}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._lastReportTime=0,this._report(),this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[]}}]),ua),aa="none",sa="online",ra=(e(ca,[{key:"start",value:function(){var t=this,n="".concat(this._n,".start");te?(oe.getNetworkType({success:function(e){t._networkType=e.networkType||e.subtype||"",e.networkType===aa?A.w("".concat(n," no network, please check!")):A.i("".concat(n," networkType:").concat(e.networkType))}}),this._mpNetworkStatusCallback=this._onNetworkStatusChange.bind(this),oe.onNetworkStatusChange(this._mpNetworkStatusCallback)):(this._networkType=sa,this._webOnlineCallback=this._onWebOnline.bind(this),this._webOfflineCallback=this._onWebOffline.bind(this),window&&(window.addEventListener("online",this._webOnlineCallback),window.addEventListener("offline",this._webOfflineCallback)))}},{key:"_onWebOnline",value:function(){this._onNetworkStatusChange({isConnected:!0,networkType:sa})}},{key:"_onWebOffline",value:function(){this._onNetworkStatusChange({isConnected:!1,networkType:aa})}},{key:"_onNetworkStatusChange",value:function(e){var t=e.isConnected,e=e.networkType,n="".concat(this._n,"._onNetworkStatusChange"),o=!1,i="previous:".concat(this._networkType," current:").concat(e);t?(A.i("".concat(n," ").concat(i)),this._networkType!==e&&(o=!0,this._networkType=e,this._m.get(21).reConnect(!0))):this._networkType!==e&&(o=!0,this._networkType=e,A.w("".concat(n," no network, please check!")),this._m.get(21).offline()),o&&new M("networkChange").setMessage("isConnected:".concat(t," ").concat(i)).end()}},{key:"isOnline",value:function(){return this._networkType!==aa}},{key:"getNetworkType",value:function(){return this._networkType}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),te?null!==this._mpNetworkStatusCallback&&(oe.offNetworkStatusChange&&($||z?oe.offNetworkStatusChange(this._mpNetworkStatusCallback):oe.offNetworkStatusChange()),this._mpNetworkStatusCallback=null):window&&(null!==this._webOnlineCallback&&(window.removeEventListener("online",this._webOnlineCallback),this._webOnlineCallback=null),null!==this._onWebOffline&&(window.removeEventListener("offline",this._webOfflineCallback),this._webOfflineCallback=null))}}]),ca);function ca(e){u(this,ca),this._m=e,this._networkType=sa,this._n="NetMonitorModule",this.MAX_WAIT_TIME=3e3,this._mpNetworkStatusCallback=null,this._webOnlineCallback=null,this._webOfflineCallback=null}function ua(e){u(this,ua),(e=ta.call(this,e))._n="EventStatModule",e.TAG="im-ssolog-event",e._reportBody=new oa,e.MIN_THRESHOLD=20,e.MAX_THRESHOLD=100,e.WAITING_TIME=6e4,e.REPORT_LEVEL=[4,5,6],e.REPORT_SDKAPPID_BLACKLIST=[],e.REPORT_TINYID_WHITELIST=[],e._lastReportTime=Date.now();var t=e.getInnerEmitterInstance();return t.on(Uo.A2KEY_AND_TINYID_UPDATED,e._onLoginSuccess,g(e)),t.on(Uo.CLOUD_CONFIG_UPDATED,e._onCloudConfigUpdated,g(e)),e}function la(e){u(this,la),this._n="SSOLogBody",this._report=[]}function da(e){u(this,da),this._m=e,this._n="StorageModule",this._storageQueue=new Map,this._errorTolerantHandle()}function pa(e,t){return e(t={exports:{}},t.exports),t.exports}var _a,ga=pa(function(e){var o=Object.prototype.hasOwnProperty,_="~";function n(){}function a(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,n,o,i){if("function"!=typeof n)throw new TypeError("The listener must be a function");n=new a(n,o||e,i),o=_?_+t:t;return e._events[o]?e._events[o].fn?e._events[o]=[e._events[o],n]:e._events[o].push(n):(e._events[o]=n,e._eventsCount++),e}function c(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function t(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(_=!1)),t.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)o.call(e,t)&&n.push(_?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},t.prototype.listeners=function(e){var e=_?_+e:e,t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var n=0,o=t.length,i=new Array(o);n<o;n++)i[n]=t[n].fn;return i},t.prototype.listenerCount=function(e){e=_?_+e:e,e=this._events[e];return e?e.fn?1:e.length:0},t.prototype.emit=function(e,t,n,o,u,l){var d=_?_+e:e;if(!this._events[d])return!1;var i,a=this._events[d],s=arguments.length;if(a.fn){switch(a.once&&this.removeListener(e,a.fn,void 0,!0),s){case 1:return a.fn.call(a.context),!0;case 2:return a.fn.call(a.context,t),!0;case 3:return a.fn.call(a.context,t,n),!0;case 4:return a.fn.call(a.context,t,n,o),!0;case 5:return a.fn.call(a.context,t,n,o,u),!0;case 6:return a.fn.call(a.context,t,n,o,u,l),!0}for(c=1,i=new Array(s-1);c<s;c++)i[c-1]=arguments[c];a.fn.apply(a.context,i)}else for(var r,p=a.length,c=0;c<p;c++)switch(a[c].once&&this.removeListener(e,a[c].fn,void 0,!0),s){case 1:a[c].fn.call(a[c].context);break;case 2:a[c].fn.call(a[c].context,t);break;case 3:a[c].fn.call(a[c].context,t,n);break;case 4:a[c].fn.call(a[c].context,t,n,o);break;default:if(!i)for(r=1,i=new Array(s-1);r<s;r++)i[r-1]=arguments[r];a[c].fn.apply(a[c].context,i)}return!0},t.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},t.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},t.prototype.removeListener=function(e,t,n,o){e=_?_+e:e;if(!this._events[e])return this;if(!t)return c(this,e),this;var i=this._events[e];if(i.fn)i.fn!==t||o&&!i.once||n&&i.context!==n||c(this,e);else{for(var a=0,s=[],r=i.length;a<r;a++)(i[a].fn!==t||o&&!i[a].once||n&&i[a].context!==n)&&s.push(i[a]);s.length?this._events[e]=1===s.length?s[0]:s:c(this,e)}return this},t.prototype.removeAllListeners=function(e){return e?(e=_?_+e:e,this._events[e]&&c(this,e)):(this._events=new n,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=_,e.exports=t.EventEmitter=t}),ha=["requestSnapshotUrl"],fa=(t(Ca,Nn),_a=f(Ca),e(Ca,[{key:"_init",value:function(){var e=this.get(18);this.TIMUploadPlugin=e.getPlugin("tim-upload-plugin"),this.TIMUploadPlugin?this._initUploaderMethod():(this.COSSDK=e.getPlugin(e=te?"cos-wx-sdk":"cos-js-sdk"),this.COSSDK?(this._getAuthorizationKey(),this.outputWarning("CosReplacement",e)):this.outputWarning("PluginUndetected"))}},{key:"_onCloudConfigUpdated",value:function(){var e="".concat(this._n,"._onCloudConfigUpdated"),t=this.getCloudConfig("upload_size_limit"),n=this.getCloudConfig("simple_cos");if(A.l("".concat(e," uploadSizeLimit:").concat(t," simpleCos:").concat(n)),!k(t))try{var o=JSON.parse(t);this.UPLOAD_SIZE_LIMIT={A:o.a?1048576*parseInt(o.a):this.UPLOAD_SIZE_LIMIT.A,F:o.f?1048576*parseInt(o.f):this.UPLOAD_SIZE_LIMIT.F,I:o.i?1048576*parseInt(o.i):this.UPLOAD_SIZE_LIMIT.I,V:o.v?1048576*parseInt(o.v):this.UPLOAD_SIZE_LIMIT.V}}catch(e){}k(n)||(this.isSimpleCos="1"===n)}},{key:"_getAuthorizationKey",value:function(){var n=this,o="".concat(this._n,".").concat("_getAuthorizationKey"),i=new M("_getAuthorizationKey"),a=Math.ceil(Date.now()/1e3);this.req({proto:v.COS_SIGN,data:{duration:this.expiredTimeLimit}}).then(function(e){var e=e.data,t=(A.l("".concat(o," ok. data:"),e),e.expiredTime-a);i.setMessage("requestId:".concat(e.requestId," requestTime:").concat(a," expiredTime:").concat(e.expiredTime," diff:").concat(t,"s")).end(),!te&&e.region&&(n.region=e.region),n.appid=e.appid,n.bucketName=e.bucketName,n.ciUrl=e.ciUrl,n.directory=e.directory,n.downloadUrl=e.downloadUrl,n.uploadUrl=e.uploadUrl,n.cosOptions={secretId:e.secretId,secretKey:e.secretKey,sessionToken:e.sessionToken,expiredTime:e.expiredTime},A.l("".concat(o," ok. region:").concat(n.region," bucketName:").concat(n.bucketName)),n._initUploaderMethod()}).catch(function(e){i.setError(e).end(),A.w("".concat(o," failed. error:"),e)})}},{key:"_getCosPreSigUrl",value:function(t){var i=this,a="".concat(this._n,".").concat("_getCosPreSigUrl"),s=Math.ceil(Date.now()/1e3),r=new M("_getCosPreSigUrl"),e={uploadMethod:t.uploadMethod,platform:this.getPlatform(),SDKAppID:this.getSDKAppID(),userID:t.userID,conversationType:t.conversationType,uploadConfig:[{fileID:1,fileType:t.fileType,fileName:t.fileName}]},n=v.SIMPLE_COS_PRE_SIG;return this.isSimpleCos||(e={fileType:t.fileType,fileName:t.fileName,uploadMethod:t.uploadMethod,duration:t.duration},n=v.COS_PRE_SIG),this.req({proto:n,data:e}).then(function(e){i.tryCount=0;var t,n,e=e.data||{},o=(A.l("".concat(a," ok. isSimpleCos:").concat(i.isSimpleCos," data:"),e),"");return o=i.isSimpleCos?(t=(n=e.preSig[0]).uploadUrl,n=n.fileKey,"uploadIP:".concat(e.uploadIP," uploadUrl:").concat(t," fileKey:").concat(n," cost:").concat(zt(s))):"requestId:".concat(e.requestId," expiredTime:").concat(e.expiredTime," diff:").concat(e.expiredTime-s,"s"),r.setMessage(o).end(),e}).catch(function(e){return-1===e.code&&(e.code=C.COS_GET_SIG_FAIL),r.setError(e).end(),A.w("".concat(a," failed. error:"),e),i.tryCount<1?(i.tryCount++,i._getCosPreSigUrl(t)):(i.tryCount=0,m({code:C.COS_GET_SIG_FAIL}))})}},{key:"_initUploaderMethod",value:function(){var n=this;if(this.TIMUploadPlugin)return this.timUploadPlugin=new this.TIMUploadPlugin,void(this._cosUploadMethod=function(e,t){n.timUploadPlugin.uploadFile(e,t)});this.appid&&(this.cos=te?new this.COSSDK({ForcePathStyle:!0,getAuthorization:this._getAuthorization.bind(this)}):new this.COSSDK({getAuthorization:this._getAuthorization.bind(this)}),this._cosUploadMethod=te?function(e,t){n.cos.postObject(e,t)}:function(e,t){n.cos.uploadFiles(e,t)})}},{key:"onCheckTimer",value:function(e){this.COSSDK&&(this.TIMUploadPlugin||this.isLoggedIn()&&e%60==0&&Math.ceil(Date.now()/1e3)>=this.cosOptions.expiredTime-120&&this._getAuthorizationKey())}},{key:"_getAuthorization",value:function(e,t){t({TmpSecretId:this.cosOptions.secretId,TmpSecretKey:this.cosOptions.secretKey,XCosSecurityToken:this.cosOptions.sessionToken,ExpiredTime:this.cosOptions.expiredTime})}},{key:"upload",value:function(e){if(!0===e._relayFlag)return Promise.resolve();var t=this.get(26);switch(e.type){case S.MSG_IMAGE:return t.addTotalCount(Kn),this._uploadImage(e);case S.MSG_FILE:return t.addTotalCount(Kn),this._uploadFile(e);case S.MSG_AUDIO:return t.addTotalCount(Kn),this._uploadAudio(e);case S.MSG_VIDEO:return t.addTotalCount(Kn),this._uploadVideo(e);default:return Promise.resolve()}}},{key:"_uploadImage",value:function(v){var M=this,e=this.get(2),I=v.getElements()[0],t=e.getMessageOption(v.clientSequence);return this.doUploadImage({file:t.payload.file,to:t.to,message:v,onProgress:function(e){if(I.updatePercent(e),$e(t.onProgress))try{t.onProgress(e)}catch(e){return m({code:C.MSG_ONPROGRESS_FUNCTION_ERROR})}}}).then(function(e){var t=e.location,l=e.fileType,d=e.fileSize,n=e.width,o=e.height,p=e.smallImageUrl,_=e.smallImageWidth,g=e.smallImageHeight,h=e.largeImageUrl,f=e.largeImageWidth,m=e.largeImageHeight,i=e.imageInfoArray,e=M.isPrivateNetWork()?t:ut(t);I.updateImageFormat(l);var a,s,r={size:d,url:e,width:n,height:o};if(i&&0<i.length)for(var c=0;c<i.length;c++){var u=i[c];1===u.type?a=u:2===u.type?s=u:r=y(y({},r),u)}else s=p&&h?(a={url:p,width:_,height:g},{url:h,width:f,height:m}):(a=Pt({originUrl:e,originWidth:n,originHeight:o,min:198}),Pt({originUrl:e,originWidth:n,originHeight:o,min:720}));return I.updateImageInfoArray([y({},r),y({},s),y({},a)]),v})}},{key:"_uploadFile",value:function(t){var n=this,e=this.get(2),o=t.getElements()[0],i=e.getMessageOption(t.clientSequence);return this.doUploadFile({file:i.payload.file,to:i.to,message:t,onProgress:function(e){if(o.updatePercent(e),$e(i.onProgress))try{i.onProgress(e)}catch(e){return m({code:C.MSG_ONPROGRESS_FUNCTION_ERROR})}}}).then(function(e){e=e.location,e=n.isPrivateNetWork()?e:ut(e);return o.updateFileUrl(e),t})}},{key:"_uploadAudio",value:function(t){var n=this,e=this.get(2),o=t.getElements()[0],i=e.getMessageOption(t.clientSequence);return this.doUploadAudio({file:i.payload.file,to:i.to,message:t,onProgress:function(e){if(o.updatePercent(e),$e(i.onProgress))try{i.onProgress(e)}catch(e){return m({code:C.MSG_ONPROGRESS_FUNCTION_ERROR})}}}).then(function(e){e=e.location,e=n.isPrivateNetWork()?e:ut(e);return o.updateAudioUrl(e),t})}},{key:"_uploadVideo",value:function(n){var o=this,e=this.get(2),i=n.getElements()[0],t=e.getMessageOption(n.clientSequence);return this.doUploadVideo({file:t.payload.file,to:t.to,message:n,onProgress:function(e){if(i.updatePercent(e),$e(t.onProgress))try{t.onProgress(e)}catch(e){return m({code:C.MSG_ONPROGRESS_FUNCTION_ERROR})}}}).then(function(e){var t=e.location,e=e.snapshotInfo,t=o.isPrivateNetWork()?t:ut(t);return i.updateVideoUrl(t),We(e)||i.updateSnapshotInfo(e),n})}},{key:"_checkSizeError",value:function(e){var t="";return"A"===e?t="audio":"I"===e?t="image":"V"===e?t="video":"F"===e&&(t="file"),m({code:C["MSG_".concat(e,"_SIZE_LIMIT")],message:this.getErrorMessage("UploadSizeLimit",t,"".concat(this.UPLOAD_SIZE_LIMIT[e]/1048576,"MB"))})}},{key:"doUploadImage",value:function(e){var n=this;if(!e.file||this._isEmptyFileList(e.file.files))return m({code:C.MSG_I_SELECT_F_FIRST});var t=this._checkImageType(e.file);if(!0!==t)return t;t=this._checkImageSize(e.file);if(!0!==t)return t;var o=null;return this._setUploadFileType(1),this.uploadByCOS(e).then(function(e){if(o=e,n.isPrivateNetWork())return t=n.getFileDownloadProxy(),Rt(Yt(e.location,t));if(Qe(o.imageInfoArray)){var t=o.imageInfoArray.find(function(e){return 3===e.type});if(t)return t}return Rt("https://".concat(e.location))}).then(function(e){return o.width=e.width,o.height=e.height,Promise.resolve(o)})}},{key:"_checkImageType",value:function(e){var t="",t=te?e.url.slice(e.url.lastIndexOf(".")+1):e.files[0].name.slice(e.files[0].name.lastIndexOf(".")+1);return 0<=jo.indexOf(t.toLowerCase())||m({code:C.MSG_I_TYPES_LIMIT})}},{key:"_checkImageSize",value:function(e){return 0===(e=(te?e:e.files[0]).size)?m({code:C.MSG_F_IS_EMPTY}):e<this.UPLOAD_SIZE_LIMIT.I||this._checkSizeError("I")}},{key:"doUploadFile",value:function(e){return!e.file||this._isEmptyFileList(e.file.files)?m({code:C.MSG_F_SELECT_F_FIRST}):e.file.files[0].size>this.UPLOAD_SIZE_LIMIT.F?this._checkSizeError("F"):0===e.file.files[0].size?m({code:C.MSG_F_IS_EMPTY}):(this._setUploadFileType(255),this.uploadByCOS(e))}},{key:"doUploadVideo",value:function(e){return e.file.videoFile.size>this.UPLOAD_SIZE_LIMIT.V?this._checkSizeError("V"):0===e.file.videoFile.size?m({code:C.MSG_F_IS_EMPTY}):-1===Jo.indexOf(e.file.videoFile.type)?m({code:C.MSG_V_TYPES_LIMIT}):(this._setUploadFileType(2),te?this.handleVideoUpload(y(y({},e),{},{file:e.file.videoFile})):ne?this.handleVideoUpload(e):void 0)}},{key:"handleVideoUpload",value:function(n){var o=this;return new Promise(function(t,e){o.uploadByCOS(n).then(function(e){t(e)}).catch(function(){o.uploadByCOS(n).then(function(e){t(e)}).catch(function(){e(new bn({code:C.MSG_V_UPLOAD_FAIL}))})})})}},{key:"doUploadAudio",value:function(e){return e.file?e.file.size>this.UPLOAD_SIZE_LIMIT.A?this._checkSizeError("A"):0===e.file.size?m({code:C.MSG_F_IS_EMPTY}):(this._setUploadFileType(3),this.uploadByCOS(e)):m({code:C.MSG_A_UPLOAD_FAIL})}},{key:"uploadByCOS",value:function(t){var c=this;if(!$e(this._cosUploadMethod))return this.outputWarning("PluginUndetected"),m({code:C.COS_UNDETECTED});if(this.timUploadPlugin)return this._uploadWithPreSigUrl(t);var u=new M("upload"),l="".concat(this._n,".uploadByCOS"),d=Date.now(),p=this._getFile(t);return new Promise(function(a,s){var e=te?c._createCosOptionsWXMiniApp(t):c._createCosOptionsWeb(t),r=c;c._cosUploadMethod(e,function(e,t){var n=Object.create(null);if(t){if(e||Qe(t.files)&&t.files[0].error)return o=new bn({code:C.MSG_F_UPLOAD_FAIL}),u.setError(o).end(),A.l("".concat(l," failed. error:"),t.files[0].error),403===t.files[0].error.statusCode&&(A.w("".concat(l," failed. cos AccessKeyId was invalid, regain auth key!")),c._getAuthorizationKey()),void s(o);n.fileName=p.name,n.fileSize=p.size,n.fileType=p.type.slice(p.type.indexOf("/")+1).toLowerCase(),n.location=(te?t:t.files[0].data).Location;var o=Date.now()-d,t=r._formatFileSize(p.size),i=r._formatSpeed(1e3*p.size/o),t="size:".concat(t," time:").concat(o,"ms speed:").concat(i),i=(A.l("".concat(l," success. name:").concat(p.name," ").concat(t)),a(n),c.get(26));return i.addCost(Kn,o),i.addFileSize(Kn,p.size),void u.setMessage(t).end()}n=new bn({code:C.MSG_F_UPLOAD_FAIL});u.setError(n).end(),A.w("".concat(l," failed. error:"),e),403===e.statusCode&&(A.w("".concat(l," failed. cos AccessKeyId was invalid, regain auth key!")),c._getAuthorizationKey()),s(n)})})}},{key:"_uploadWithPreSigUrl",value:function(e){var p=this,_="".concat(this._n,"._uploadWithPreSigUrl"),g=this._getFile(e);return this._createCosOptionsPreSigUrl(e).then(function(d){return new Promise(function(a,s){var r=new M("upload"),e=d.requestSnapshotUrl,c=void 0===e?void 0:e,u=h(d,ha),l=Date.now();p._cosUploadMethod(u,function(e,t){var n,o,i;return e||403===t.statusCode?(r.setError(new bn(e)).end(),o={HttpStatusCode:9999,CostTime:zt(l,!1),error:e,url:d.url},t.data&&t.data.uploadIP&&(o.uploadIP=t.data.uploadIP),p._uploadSSOLog(o),A.l("".concat(_," failed, error:"),e),void s(new bn({code:C.MSG_F_UPLOAD_FAIL}))):(n=Object.create(null),o=t.data.location||"",p.isPrivateNetWork()||0!==o.indexOf("https://")&&0!==o.indexOf("http://")||(o=o.split("//")[1]),n.fileName=g.name,n.fileSize=g.size,n.fileType=g.type.slice(g.type.indexOf("/")+1).toLowerCase(),n.location=o,e=zt(l,!1),o=p._formatFileSize(g.size),i=p._formatSpeed(1e3*g.size/e),o="size:".concat(o," time:").concat(e,"ms speed:").concat(i," res:").concat(JSON.stringify(t.data)),A.l("".concat(_," ok. name:").concat(g.name," ").concat(o)),r.setMessage(o).end(),i={HttpStatusCode:t.statusCode,FileSize:g.size,CostTime:e,url:d.url},t.data&&t.data.uploadIP&&(i.uploadIP=t.data.uploadIP),p._uploadSSOLog(i),(o=p.get(26)).addCost(Kn,e),o.addFileSize(Kn,g.size),i=[],u.thumbUrl&&u.largeUrl&&i.push.apply(i,[p._getSmallImageInfoByUrl(u.thumbUrl,n),p._getLargeImageInfoByUrl(u.largeUrl,n)]),1===p.uploadFileType&&p.isSimpleCos&&!p.isPrivateNetWork()&&(i.push(p._getImageInfoArray(u.downloadUrl,n)),t.data.uploadIP&&i.push(p._getDownloadIP(u.downloadUrl.split("//")[1].split("/")[0],n))),c&&i.push(p._getSnapshotInfoByUrl(c,n)),0<i.length?Promise.all(i).then(function(){a(n)}):void a(n))})})})}},{key:"_getDownloadIP",value:function(e,n){var o="".concat(this._n,"._getDownloadIP"),i=Date.now();return this.req({proto:v.GET_IP,data:{domainName:e}}).then(function(e){var t;e.data&&e.data.ip&&(A.l("".concat(o," ok. downloadIP:").concat(e.data.ip," cost:").concat(zt(i))),(t=n.location.split("/"))[0]=e.data.ip,n.location=t.join("/"))}).catch(function(e){})}},{key:"_getImageInfoArray",value:function(t,n){var o=this,i="".concat(this._n,"._getImageInfoArray"),a=Date.now();return this.req({proto:v.GET_IMAGE_INFO,data:{imageUrl:t}}).then(function(e){e=e.data||{};return A.l("".concat(i," ok. data: ").concat(JSON.stringify(e)," cost:").concat(zt(a))),n.imageInfoArray=e.imageInfoArray,e}).catch(function(e){n.imageInfoArray=void 0,o._uploadSSOLog({HttpStatusCode:1e4,CostTime:zt(a,!1),url:t})})}},{key:"_uploadSSOLog",value:function(e){var t,n;this.isSimpleCos&&((t=new M).setEventType(18),e.error&&t.setError(new bn(e.error)),n="HttpStatusCode:".concat(e.HttpStatusCode,"|CosRequestId:").concat(e.CosRequestId||"","|")+"FileAlreadyExist:".concat(e.FileAlreadyExist||0,"|FileSize:").concat(e.FileSize||0,"|CostTime:").concat(e.CostTime),e.uploadIP&&(n+="|FinalIP:".concat(e.uploadIP)),t.setMessage("OK").setMoreMessage(e.url).setExtension(n).end())}},{key:"_getRawOrUploadProxyUrl",value:function(e){var t=this.get(12).getFileUploadProxy(),n=e;return n=t?e.replace(/^https:\/\/[^/]+/,t):n}},{key:"_getFile",value:function(e){return Qe(e.file.files)||et(e.file.files)?e.file.files[0]:e.file}},{key:"_formatFileSize",value:function(e){return e<1024?e+"B":e<1048576?Math.floor(e/1024)+"KB":Math.floor(e/1048576)+"MB"}},{key:"_formatSpeed",value:function(e){return e<=1048576?Ft(e/1024,1)+"KB/s":Ft(e/1048576,1)+"MB/s"}},{key:"_createCosOptionsWeb",value:function(t){var e=this._getFile(t),n=e.name,n=n.slice(n.lastIndexOf(".")),n=this._genFileName("".concat(st(999999)).concat(n));return{files:[{Bucket:"".concat(this.bucketName,"-").concat(this.appid),Region:this.region,Key:"".concat(this.directory,"/").concat(n),Body:e}],SliceSize:1048576,onProgress:function(e){if("function"==typeof t.onProgress)try{t.onProgress(e.percent)}catch(e){A.w("onProgress callback error:",e)}},onFileFinish:function(e,t,n){}}}},{key:"_createCosOptionsWXMiniApp",value:function(t){var e=this._getFile(t),n=this._genFileName(e.name),e=e.url;return{Bucket:"".concat(this.bucketName,"-").concat(this.appid),Region:this.region,Key:"".concat(this.directory,"/").concat(n),FilePath:e,onProgress:function(e){if(A.l(JSON.stringify(e)),"function"==typeof t.onProgress)try{t.onProgress(e.percent)}catch(e){A.w("onProgress callback error:",e)}}}}},{key:"_createCosOptionsPreSigUrl",value:function(r){var e,c=this,u="",l="",t=0,n=this._getFile(r),t=te?(u=r.message.type===S.MSG_FILE?(e=(e=n.name).slice(e.lastIndexOf(".")),this._genFileName("".concat(st(999999)).concat(e))):this._genFileName(n.name),l=n.url,1):(e=(e=n.name).slice(e.lastIndexOf(".")),u=this._genFileName("".concat(st(999999)).concat(e)),l=n,0);return this._getCosPreSigUrl({fileType:this.uploadFileType,fileName:u,uploadMethod:t,duration:this.duration,userID:r.message.from,conversationType:Lt(r.message.conversationID)?1:2}).then(function(e){var t=c.isSimpleCos?e.preSig[0]:e,n=t.uploadUrl,o=t.downloadUrl,i=t.requestSnapshotUrl,i=void 0===i?void 0:i,a=t.thumbUrl,s=t.largeUrl,t=t.fileKey,e=e.uploadIP,e=void 0===e?"":e;return{url:c._getRawOrUploadProxyUrl(n),fileType:c.uploadFileType,fileName:u,resources:l,downloadUrl:o,requestSnapshotUrl:i,thumbUrl:a,largeUrl:s,fileKey:t,uploadIP:!c.isPrivateNetWork()&&e,onProgress:function(e){if("function"==typeof r.onProgress)try{r.onProgress(e.percent)}catch(e){A.w("onProgress callback error:",e),A.e(e)}}}})}},{key:"_genFileName",value:function(e){return"".concat(Ot(),"-").concat(e)}},{key:"_setUploadFileType",value:function(e){this.uploadFileType=e}},{key:"_getSnapshotInfoByUrl",value:function(e,o){var i=this,a="_getSnapshotInfoByUrl",s=new M(a);return this.req({proto:v.VIDEO_COVER,data:{platform:this.getPlatform(),coverName:this._genFileName(st(99999)),requestSnapshotUrl:e}}).then(function(e){var t=(e.data||{}).snapshotUrl;if(A.l("".concat(i._n,".").concat(a," ok. snapshotUrl:").concat(t)),s.setMessage("snapshotUrl:".concat(t)).end(),We(t))return{};var n,e=t;return i.isPrivateNetWork()&&(n=i.getFileDownloadProxy(),e=Yt(t,n)),Rt(e).then(function(e){o.snapshotInfo={snapshotUrl:t,snapshotWidth:e.width,snapshotHeight:e.height}})}).catch(function(e){return A.w("".concat(i._n,".").concat(a," failed. error:"),e),s.setCode(e.errorCode).setMessage(e.errorInfo).end(),{}})}},{key:"_getSmallImageInfoByUrl",value:function(t,n){var e,o=t;return this.isPrivateNetWork()&&(e=this.getFileDownloadProxy(),o=Yt(t,e)),Rt(o).then(function(e){n.smallImageUrl=t,n.smallImageWidth=e.width,n.smallImageHeight=e.height})}},{key:"_getLargeImageInfoByUrl",value:function(t,n){var e,o=t;return this.isPrivateNetWork()&&(e=this.getFileDownloadProxy(),o=Yt(t,e)),Rt(o).then(function(e){n.largeImageUrl=t,n.largeImageWidth=e.width,n.largeImageHeight=e.height})}},{key:"_isEmptyFileList",value:function(e){return!(!et(e)||0!==e.length)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset"))}}]),Ca),ma=["downloadKey","pbDownloadKey","messageList"],va=(e(ya,[{key:"uploadMergerMessage",value:function(e,n){var o="".concat(this._n,".").concat("uploadMergerMessage"),e=(A.d("".concat(o," message:"),e,"messageBytes:".concat(n)),e.payload.messageList),i=e.length,a=new M("uploadMergerMessage");return this._msgM.req({proto:v.UPLOAD_MERGER_MSG,data:{messageList:e}}).then(function(e){A.d("".concat(o," ok. response:"),e.data);var e=e.data,t=e.pbDownloadKey,e=e.downloadKey,t={pbDownloadKey:t,downloadKey:e,messageNumber:i};return a.setMessage("".concat(i,"-").concat(n,"-").concat(e)).end(),t}).catch(function(e){throw A.w("".concat(o," failed. error:"),e),a.setError(e).end(),e})}},{key:"downloadMergerMessage",value:function(o){var i="".concat(this._n,".").concat("downloadMergerMessage"),t=(A.d("".concat(i," message:"),o),o.payload.downloadKey),a=this._msgM.getFileDownloadProxy(),s=new M("downloadMergerMessage");return s.setMessage("downloadKey:".concat(t)),this._msgM.req({proto:v.DOWNLOAD_MERGER_MSG,data:{downloadKey:t}}).then(function(e){var t,n;return A.d("".concat(i," ok. response:"),e.data),$e(o.clearElement)?((t=o.payload).downloadKey,t.pbDownloadKey,t.messageList,t=h(t,ma),o.clearElement(),o.setElement({type:o.type,content:y({messageList:e.data.messageList},t)},a)):(n=[],e.data.messageList.forEach(function(e){We(e)||(e=new lo(e,a),n.push(e))}),o.payload.messageList=n,o.payload.downloadKey="",o.payload.pbDownloadKey=""),s.end(),o}).catch(function(e){throw A.w("".concat(i," failed. key:").concat(t," error:"),e),s.setError(e).end(),e})}},{key:"createMergerMessagePack",value:function(e,t,n){return e.conversationType===S.CONV_C2C?this._createC2CMergerMessagePack(e,t,n):this._createGroupMergerMessagePack(e,t,n)}},{key:"_createC2CMergerMessagePack",value:function(e,t,n){var o=null,i=(t&&(t.offlinePushInfo&&(o=t.offlinePushInfo),!0===t.onlineUserOnly&&(o?o.disablePush=!0:o={disablePush:!0})),[]),a=(Ze(t)&&Ze(t.messageControlInfo)&&(a=(r=t.messageControlInfo).excludedFromUnreadCount,s=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===a&&i.push("NoUnread"),!0===s&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),""),s=(pt(e.cloudCustomData)&&0<e.cloudCustomData.length&&(a=e.cloudCustomData),n.pbDownloadKey),r=n.downloadKey,n=n.messageNumber,c=e.payload,l=c.title,d=c.abstractList,c=c.compatibleText,u=this._msgM.get(6),u=u&&u.isOnlineMessage(e,t)?0:void 0;return{proto:v.SEND_C2C_MSG,tjgID:this._msgM.generateTjgID(e),data:{fromAccount:this._msgM.getMyUserID(),toAccount:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:s,downloadKey:r,title:l,abstractList:d,compatibleText:c,messageNumber:n}}],cloudCustomData:a,clientTime:e.clientTime,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:u,offlinePushInfo:Oo(o),messageControlInfo:0!==u?i:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}},{key:"_createGroupMergerMessagePack",value:function(e,t,n){var o=null,i=(t&&t.offlinePushInfo&&(o=t.offlinePushInfo),[]),a=(Ze(t)&&Ze(t.messageControlInfo)&&(a=(r=t.messageControlInfo).excludedFromUnreadCount,s=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===a&&i.push("NoUnread"),!0===s&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),""),s=(pt(e.cloudCustomData)&&0<e.cloudCustomData.length&&(a=e.cloudCustomData),n.pbDownloadKey),r=n.downloadKey,n=n.messageNumber,c=e.payload,l=c.title,d=c.abstractList,c=c.compatibleText,u=this._msgM.get(7),t=u&&u.isOnlineMessage(e,t)?1:0;return{proto:v.SEND_GRP_MSG,tjgID:this._msgM.generateTjgID(e),data:{fromAccount:this._msgM.getMyUserID(),groupID:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:s,downloadKey:r,title:l,abstractList:d,compatibleText:c,messageNumber:n}}],random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:void 0,cloudCustomData:a,onlineOnlyFlag:t,offlinePushInfo:Oo(o),clientTime:e.clientTime,needReadReceipt:!0!==e.needReadReceipt||u.isMessageFromOrToAVChatroom(e.to)?0:1,messageControlInfo:0==t?i:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}}]),ya),Ma={ERR_SVR_COMM_SENSITIVE_TEXT:80001,ERR_SVR_COMM_BODY_SIZE_LIMIT:80002,OPEN_SERVICE_OVERLOAD_ERROR:60022,ERR_SVR_MSG_PKG_PARSE_FAILED:20001,ERR_SVR_MSG_INTERNAL_AUTH_FAILED:20002,ERR_SVR_MSG_INVALID_ID:20003,ERR_SVR_MSG_PUSH_DENY:20006,ERR_SVR_MSG_IN_PEER_BLACKLIST:20007,ERR_SVR_MSG_BOTH_NOT_FRIEND:20009,ERR_SVR_MSG_NOT_PEER_FRIEND:20010,ERR_SVR_MSG_NOT_SELF_FRIEND:20011,ERR_SVR_MSG_SHUTUP_DENY:20012,ERR_SVR_GROUP_INVALID_PARAMETERS:10004,ERR_SVR_GROUP_PERMISSION_DENY:10007,ERR_SVR_GROUP_NOT_FOUND:10010,ERR_SVR_GROUP_INVALID_GROUPID:10015,ERR_SVR_GROUP_REJECT_FROM_THIRDPARTY:10016,ERR_SVR_GROUP_SHUTUP_DENY:10017,MSG_SEND_FAIL:2100,OVER_FREQUENCY_LIMIT:2996},Ia=[C.MSG_ONPROGRESS_FUNCTION_ERROR,C.MSG_I_SELECT_F_FIRST,C.MSG_I_TYPES_LIMIT,C.MSG_F_IS_EMPTY,C.MSG_I_SIZE_LIMIT,C.MSG_F_SELECT_F_FIRST,C.MSG_F_SIZE_LIMIT,C.MSG_V_SIZE_LIMIT,C.MSG_V_TYPES_LIMIT,C.MSG_A_UPLOAD_FAIL,C.MSG_A_SIZE_LIMIT,C.COS_UNDETECTED];function ya(e){u(this,ya),this._n="MergerMessageHandler",this._msgM=e}function Ca(e){u(this,Ca),(e=_a.call(this,e))._n="UploadModule",e.TIMUploadPlugin=null,e.timUploadPlugin=null,e.COSSDK=null,e._cosUploadMethod=null,e.expiredTimeLimit=600,e.appid=0,e.bucketName="",e.ciUrl="",e.directory="",e.downloadUrl="",e.uploadUrl="",e.region="ap-shanghai",e.cos=null,e.cosOptions={secretId:"",secretKey:"",sessionToken:"",expiredTime:0},e.uploadFileType="",e.duration=900,e.tryCount=0,e.UPLOAD_SIZE_LIMIT={A:20971520,F:104857600,I:20971520,V:104857600},e.isSimpleCos=!1;var t=e.getInnerEmitterInstance();return t.on(Uo.A2KEY_AND_TINYID_UPDATED,e._init,g(e)),t.on(Uo.CLOUD_CONFIG_UPDATED,e._onCloudConfigUpdated,g(e)),e}function Ta(e){var t=!1;return Object.values(Ma).includes(e)&&(t=!0),t=120001<=e&&e<=13e4||10100<=e&&e<=10200?!0:t}var Da,Ea,La,Sa,Aa,ka,Ra=["conversationID","timePosition","timePeriod"],Oa=(t(Ba,Nn),ka=f(Ba),e(Ba,[{key:"createTextMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new go(e)),e=pt(e.payload)?e.payload:e.payload.text,e=new Qn({text:e}),t=this._getNickAndAvatarByUserID(t);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createImageMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new go(e));if(te){var o=e.payload.file;if(Je(o))return void this.outputWarning("FileUnsupportedInMP","createImageMessage");var i=o.tempFiles[0].path||o.tempFiles[0].tempFilePath,o={url:i,name:i.slice(i.lastIndexOf("/")+1),size:o.tempFiles&&o.tempFiles[0].size||1,type:i.slice(i.lastIndexOf(".")+1).toLowerCase()};e.payload.file=o}else ne&&(Je(e.payload.file)?(i=e.payload.file,e.payload.file={files:[i]}):Ze(e.payload.file)&&"undefined"!=typeof uni&&(o=e.payload.file.tempFiles[0],e.payload.file={files:[o]}));i=new $n({imageFormat:Ue.UNKNOWN,uuid:this._generateUUID(e.payload.file),file:e.payload.file}),o=this._getNickAndAvatarByUserID(t);return n.setElement(i),n.setNickAndAvatar(o),n.setNameCard(this._getNameCardByGroupID(n)),this._messageOptionsMap.set(n.clientSequence,e),n}},{key:"createAudioMessage",value:function(e){var t=e.payload.file,n=(te&&(n={url:t.tempFilePath,name:t.tempFilePath.slice(t.tempFilePath.lastIndexOf("/")+1),size:t.fileSize,second:parseInt(t.duration)/1e3,type:t.tempFilePath.slice(t.tempFilePath.lastIndexOf(".")+1).toLowerCase()},e.payload.file=n),this.getMyUserID()),o=(e.currentUser=n,e.senderTinyID=this.getMyTinyID(),new go(e)),t=new to({second:Math.floor(t.duration/1e3),size:t.fileSize||t.size,url:t.tempFilePath,uuid:this._generateUUID(e.payload.file)}),n=this._getNickAndAvatarByUserID(n);return o.setElement(t),o.setNickAndAvatar(n),o.setNameCard(this._getNameCardByGroupID(o)),this._messageOptionsMap.set(o.clientSequence,e),o}},{key:"createVideoMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),e.payload.file.thumbUrl="",e.payload.file.thumbSize=0,{});if(te){if(Z)return void this.outputWarning("VideoUnsupportedInAlipay");if(Je(e.payload.file))return void this.outputWarning("FileUnsupportedInMP","createVideoMessage");var o=e.payload.file;Qe(o.tempFiles)&&(o=o.tempFiles[0]),n.url=o.tempFilePath,n.name=o.tempFilePath.slice(o.tempFilePath.lastIndexOf("/")+1),n.size=o.size||1,n.second=o.duration||0,n.type=o.tempFilePath.slice(o.tempFilePath.lastIndexOf(".")+1).toLowerCase()}else ne&&(Je(e.payload.file)?(o=e.payload.file,e.payload.file.files=[o]):Ze(e.payload.file)&&"undefined"!=typeof uni&&(o=e.payload.file.tempFile,e.payload.file.files=[o]),o=e.payload.file,n.url=window.URL.createObjectURL(o.files[0]),n.name=o.files[0].name,n.size=o.files[0].size||1,n.second=o.files[0].duration||0,n.type=o.files[0].type.split("/")[1]);e.payload.file.videoFile=n;o=new go(e),n=new co({videoFormat:n.type,videoSecond:Ft(n.second,0),videoSize:n.size,remoteVideoUrl:"",videoUrl:n.url,videoUUID:this._generateUUID(e.payload.file.videoFile),thumbUUID:this._generateUUID(e.payload.file.videoFile),thumbWidth:e.payload.file.width||200,thumbHeight:e.payload.file.height||200,thumbUrl:e.payload.file.thumbUrl,thumbSize:e.payload.file.thumbSize,thumbFormat:e.payload.file.thumbUrl.slice(e.payload.file.thumbUrl.lastIndexOf(".")+1).toLowerCase()}),t=this._getNickAndAvatarByUserID(t);return o.setElement(n),o.setNickAndAvatar(t),o.setNameCard(this._getNameCardByGroupID(o)),this._messageOptionsMap.set(o.clientSequence,e),o}},{key:"createCustomMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new go(e)),e=new ro({data:e.payload.data,description:e.payload.description,extension:e.payload.extension}),t=this._getNickAndAvatarByUserID(t);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createFaceMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new go(e)),e=new eo(e.payload),t=this._getNickAndAvatarByUserID(t);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createMergerMessage",value:function(e){var t=this.getMyUserID(),t=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),this._getNickAndAvatarByUserID(t)),n=new go(e),e=new po(e.payload);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n.setRelayFlag(!0),n}},{key:"createForwardMessage",value:function(e){var t=e.to,n=e.conversationType,o=e.priority,i=e.payload,a=e.needReadReceipt,s=e.receiverList;if(!Qe(i._elements))return m({code:C.MSG_FORWARD_INVALID_ELEMENTS});var r=this.getMyUserID(),c=this._getNickAndAvatarByUserID(r);if(i.type===S.MSG_GRP_TIP)return m({code:C.MSG_FORWARD_TYPE_INVALID});n={to:t,conversationType:n,conversationID:"".concat(n).concat(t),priority:o,isPlaceMessage:0,status:Dn,currentUser:r,senderTinyID:this.getMyTinyID(),cloudCustomData:e.cloudCustomData||i.cloudCustomData||"",needReadReceipt:a,receiverList:s,isSupportExtension:e.isSupportExtension||!1},t=new go(n);return t.setElement(i._elements[0]),t.setNickAndAvatar(c),t.setNameCard(this._getNameCardByGroupID(i)),t.setRelayFlag(!0),t}},{key:"downloadMergerMessage",value:function(e){return this._mergerMessageHandler.downloadMergerMessage(e)}},{key:"createFileMessage",value:function(e){if(te){if(!Y&&!J&&!$)return;var t=oe.getSystemInfoSync().SDKVersion;if(Y&&Gt(t,"2.5.0")<0)return void this.outputWarning("WXChooseMessageFile");if(J&&Gt(t,"1.18.0")<0)return void this.outputWarning("QQChooseMessageFile")}ne||$?Je(e.payload.file)?(t=e.payload.file,e.payload.file={files:[t]}):Ze(e.payload.file)&&"undefined"!=typeof uni&&(o=(t=e.payload.file).tempFiles,t=t.files,n=null,Qe(o)?n=o[0]:Qe(t)&&(n=t[0]),e.payload.file={files:[n]}):(Y||J)&&(t=y(y({},(o=e.payload.file.tempFiles)[0]),{},{url:o[0].path}),e.payload.file={files:[t]});var n=this.getMyUserID(),o=(e.currentUser=n,e.senderTinyID=this.getMyTinyID(),new go(e)),t=new so({uuid:this._generateUUID(e.payload.file),file:e.payload.file}),n=this._getNickAndAvatarByUserID(n);return o.setElement(t),o.setNickAndAvatar(n),o.setNameCard(this._getNameCardByGroupID(o)),this._messageOptionsMap.set(o.clientSequence,e),o}},{key:"createLocationMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new go(e)),e=new uo(e.payload),t=this._getNickAndAvatarByUserID(t);return n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"_onCannotFindModule",value:function(){return m({code:C.CANNOT_FIND_MODULE})}},{key:"sendMessageInstance",value:function(a,s){var r=this;if(!1===this.get(29).filterMessage(a,s))return a.hasRiskContent=!0,this._onSendMessageFailed(a,new bn({code:C.PROFANITY_FOUND}));var t=null;if(a.conversationType===S.CONV_C2C)t=this.get(6);else{if(a.conversationType!==S.CONV_GROUP)return m({code:C.MSG_INVALID_CONV_TYPE});t=this.get(7)}if(!t)return m({code:C.CANNOT_FIND_MODULE});var c,u="".concat(this._n,".sendMessageInstance"),l=this.get(11),d=t.isOnlineMessage(a,s);return this.get(17).upload(a).then(function(){return r._getSendMessageSpecifiedKey(a)===Bn&&r.get(26).addSuccessCount(Kn),r._guardForGroup(a).then(function(){if(!a.isSendable())return m({code:C.MSG_F_URL_IS_EMPTY});r._addSendMessageTotalCount(a),c=Date.now();var e=function(e){var t="utf-8";ne&&document&&(t=document.charset.toLowerCase());var n,o=0,i=e.length;if("utf-8"===t||"utf8"===t)for(var a=0;a<i;a++)(n=e.codePointAt(a))<=127?o+=1:n<=2047?o+=2:n<=65535?o+=3:(o+=4,a++);else if("utf-16"===t||"utf16"===t)for(var s=0;s<i;s++)(n=e.codePointAt(s))<=65535?o+=2:(o+=4,s++);else o=e.replace(/[^\x00-\xff]/g,"aa").length;return o}(JSON.stringify(a));return a.type===S.MSG_MERGER&&11264<e?r._mergerMessageHandler.uploadMergerMessage(a,e).then(function(e){e=r._mergerMessageHandler.createMergerMessagePack(a,s,e);return r.req(e)}):(l.setMessageRandom(a),t.sendMessage(a,s))}).then(function(e){var t,e=e.data,n=e.time,o=e.sequence,i=e.readReceiptCode,e=e.messageDropReason,i=(ze(i)&&0!==i&&(new M("sendMessageWithReceipt").setMessage("from:".concat(a.from," to:").concat(a.to," sequence:").concat(o," readReceiptCode:").concat(i)).end(),A.w("".concat(u," readReceiptCode:").concat(i," message:").concat(r.getErrorMessage(i)))),e&&(i=new M("messageDropReason"),e="from:".concat(a.from," to:").concat(a.to," sequence:").concat(o," messageDropReason:").concat(e),i.setMessage(e).end(),A.w("".concat(u," ").concat(e))),r._addSendMessageSuccessCount(a,c),r._messageOptionsMap.delete(a.clientSequence),!0===a.isResend&&(t=l.findMessage(a.ID))&&(A.l("".concat(u," resend ok. ID:").concat(t.ID)),l.deleteLocalMessage(t)),a.status=En,a.time=n,!1);return a.conversationType===S.CONV_GROUP?a.sequence=o:a.conversationType!==S.CONV_C2C||(e=l.getLatestMessageSentByMe(a.conversationID))&&(t=e.nick,n=e.avatar,t===a.nick&&n===a.avatar||(i=!0)),i&&l.modifyMessageSentByMe({conversationID:a.conversationID,latestNick:a.nick,latestAvatar:a.avatar}),!0===d?a._onlineOnlyFlag=!0:(l.appendToMessageList(a),o=a,Ze(s)&&Ze(s.messageControlInfo)&&(!0===s.messageControlInfo.excludedFromLastMessage&&(a._isExcludedFromLastMessage=!0,o=""),!0===s.messageControlInfo.excludedFromUnreadCount&&(a._isExcludedFromUnreadCount=!0)),e=a.conversationType,Et(a.to)&&(e=S.CONV_TOPIC,r.get(10).onMessageSent({groupID:xt(a.to),topicID:a.to,lastMessage:o})),l.onMessageSent({conversationOptionsList:[{conversationID:a.conversationID,unreadCount:0,type:e,subType:a.conversationSubType,lastMessage:o}]})),a._relayFlag||"TIMImageElem"!==a.type||Ut(a.payload.imageInfoArray),yn({message:a})})}).catch(function(e){return r._onSendMessageFailed(a,e,d)})}},{key:"_guardForGroup",value:function(e){if(e.conversationType!==S.CONV_GROUP)return Promise.resolve();var t=this.get(7);if(!t)return this._onCannotFindModule();if(Dt({groupID:e.to})){var n=t.getLocalGroupProfile(e.to);if(n&&n.isSupportTopic)return m({code:C.MSG_SEND_GRP_WITH_TOPIC_FAIL})}return t.guardForAVChatRoom(e)}},{key:"_onSendMessageFailed",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],o="".concat(this._n,"._onSendMessageFailed"),i=(e.status=Ln,80001!==t.code&&80004!==t.code||(e.hasRiskContent=!0),this.get(11)),a=(i.deleteMessageRandom(e),10100<=t.code&&t.code<=10200||120001<=t.code&&t.code<=13e4),n=(n||a||!0===i.appendToMessageList(e)&&A.l("".concat(o," message stored, ID:").concat(e.ID)),this._addSendMessageFailCountOnUser(e,t),new M("sendMessage")),a="tjg_id:".concat(this.generateTjgID(e)," type:").concat(e.type," from:").concat(e.from," to:").concat(e.to);return ne&&("connection"in navigator&&(i=navigator.connection,a+=" downlink:".concat(i.downlink," effectiveType:").concat(i.effectiveType," rtt:").concat(i.rtt)),"memory"in window.performance&&(i=window.performance.memory,a+=" usedJSHeapSize:".concat(i.usedJSHeapSize," totalJSHeapSize:").concat(i.totalJSHeapSize," jsHeapSizeLimit:").concat(i.jsHeapSizeLimit))),n.setMessage(a).setError(t).end(),A.e("".concat(o," error:"),t),m(new bn({code:t&&t.code?t.code:C.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}},{key:"_getSendMessageSpecifiedKey",value:function(e){if([S.MSG_IMAGE,S.MSG_AUDIO,S.MSG_VIDEO,S.MSG_FILE].includes(e.type))return Bn;if(e.conversationType===S.CONV_C2C)return xn;if(e.conversationType===S.CONV_GROUP){var t=this.get(7);if(t){t=t.getLocalGroupProfile(e.to);if(t)return e=t.type,Tt(e)?Hn:Vn}}}},{key:"_addSendMessageTotalCount",value:function(e){e=this._getSendMessageSpecifiedKey(e);e&&this.get(26).addTotalCount(e)}},{key:"_addSendMessageSuccessCount",value:function(e,t){var n,e=this._getSendMessageSpecifiedKey(e);e&&((n=this.get(26)).addSuccessCount(e),n.addCost(e,zt(t,!1)))}},{key:"_addSendMessageFailCountOnUser",value:function(e,t){var n,t=t.code,t=void 0===t?-1:t,o=this.get(26),e=this._getSendMessageSpecifiedKey(e);e===Bn&&(n=!1,n=Ia.includes(t)?!0:n)?o.addFailedCountOfUserSide(Kn):Ta(t)&&e&&o.addFailedCountOfUserSide(e)}},{key:"resendMessage",value:function(e,t){return e.isResend=!0,e.status=Dn,this.sendMessageInstance(e,t)}},{key:"revokeMessage",value:function(n){var t=this,e=null;if(n.conversationType===S.CONV_C2C?e=this.get(6):n.conversationType===S.CONV_GROUP&&(e=this.get(7)),!e)return this._onCannotFindModule();var o=new M("revokeMessage"),i=(o.setMessage("tjg_id:".concat(this.generateTjgID(n)," type:").concat(n.type," from:").concat(n.from," to:").concat(n.to)),"".concat(this._n,".").concat("revokeMessage"));return e.revokeMessage(n).then(function(e){var e=e.data.recallRetList;return We(e)||0===e[0].retCode?(A.i("".concat(i," ok. ID:").concat(n.ID)),n.isRevoked=!0,o.end(),t.get(11).onMessageRevoked([n]),yn({message:n})):(e=new bn({code:e[0].retCode,data:{message:n}}),o.setCode(e.code).setMoreMessage(e.message).end(),m(e))}).catch(function(e){o.setError(e).end();var t=new bn({code:e&&e.code?e.code:C.MSG_REVOKE_FAIL,message:e&&e.message?e.message:void 0,data:{message:n}});return A.w("".concat(i," failed. error:"),e),m(t)})}},{key:"deleteMessage",value:function(e){var t=this,n=null,o=e[0],i=o.conversationID,a="",s=[],r=[];if(o.conversationType===S.CONV_C2C)n=this.get(6),a=i.replace(S.CONV_C2C,""),e.forEach(function(e){e&&e.status===En&&e.conversationID===i&&(e._onlineOnlyFlag||s.push("".concat(e.sequence,"_").concat(e.random,"_").concat(e.time)),r.push(e))});else if(o.conversationType===S.CONV_GROUP)n=this.get(7),a=i.replace(S.CONV_GROUP,""),e.forEach(function(e){e&&e.status===En&&e.conversationID===i&&(e._onlineOnlyFlag||s.push("".concat(e.sequence)),r.push(e))});else if(o.conversationType===S.CONV_SYSTEM)return m({code:C.CANNOT_DELETE_GRP_SYSTEM_NOTICE});if(!n)return this._onCannotFindModule();if(0===s.length)return this._onMessageDeleted(r);30<s.length&&(s=s.slice(0,30),r=r.slice(0,30));var c=new M("deleteMessage"),u=(c.setMessage("to:".concat(a," count:").concat(s.length)),"".concat(this._n,".").concat("deleteMessage"));return n.deleteMessage({to:a,keyList:s}).then(function(e){return c.end(),A.i("".concat(u," ok")),t._onMessageDeleted(r)}).catch(function(e){c.setError(e).end(),A.w("".concat(u," failed. error:"),e);e=new bn({code:e&&e.code?e.code:C.MSG_DELETE_FAIL,message:e&&e.message?e.message:void 0});return m(e)})}},{key:"_onMessageDeleted",value:function(e){return this.get(11).onMessageDeleted(e),Cn({messageList:e})}},{key:"translateText",value:function(e){var o="".concat(this._n,".").concat("translateText"),t=e.sourceTextList,n=e.sourceLanguage,e=e.targetLanguage,i=new M("translateText");return i.setMessage("sourceLanguage:".concat(n," targetLanguage:").concat(e)),this.req({proto:v.TRANSLATE_TEXT,data:{sourceTextList:t,source:n||"auto",target:e,from:this.getMyTinyID(),SDKAppID:this.getSDKAppID()}}).then(function(e){var e=e.data,t=e.error,n=e.requestID,e=e.translatedTextList;if(0===t.code)return i.end(),A.i("".concat(o," ok. requestID:").concat(n)),yn({translatedTextList:e});throw y(y({},t),{},{requestID:n})}).catch(function(e){return i.setCode(e.code).setMoreMessage(e.requestID).end(),A.w("".concat(o," failed. error:"),e),m({code:C.TRANSLATE_TEXT_FAIL})})}},{key:"convertVoiceToText",value:function(e){var t=e.message,e=e.language,n=t.payload.url,t=(t.from===this.getMyUserID()&&"out"===t.flow&&(n=t.payload.remoteAudioUrl),/\.(wav|pcm|ogg-opus|speex|silk|mp3|m4a|aac|amr)/);if(!t.test(n))return m({code:C.UNSUPPORTED_VOICE_FORMAT});var t=t.exec(n)[1]||"mp3",o="16k_zh-PY",e=(e?"zh (cmn-Hans-CN)"===e?o="16k_zh":"en-US"===e?o="16k_en":"yue-Hant-HK"===e?o="16k_yue":"ja-JP"===e&&(o="16k_ja"):o="16k_zh-PY","serviceType:".concat(o," url:").concat(n)),i="".concat(this._n,".").concat("convertVoiceToText"),a=(A.i("".concat(i," ").concat(e)),new M("convertVoiceToText"));return a.setMessage(e),this.req({proto:v.VOICE_TO_TEXT,data:{url:n,language:o,SDKAppID:this.getSDKAppID(),format:t}}).then(function(e){var e=e.data,t=e.error,n=e.requestID,e=e.result;if(0===t.code)return a.end(),A.i("".concat(i," ok. requestID:").concat(n)),yn({result:e});throw y(y({},t),{},{requestID:n})}).catch(function(e){return a.setCode(e.code).setMoreMessage(e.requestID||"").end(),A.w("".concat(i," failed. error:"),e),m({code:C.VOICE_TO_TEXT_FAIL})})}},{key:"modifyRemoteMessage",value:function(n){var o=this,e=null,t=n.conversationType,i=n.to,a=this.get(7);if(!a)return this._onCannotFindModule();if(a.isMessageFromOrToAVChatroom(i))return m({code:C.MSG_MODIFY_DISABLED_IN_AVCHATROOM,data:{message:n}});if(!1===this.get(29).filterMessage(n))return n.hasRiskContent=!0,m({code:C.PROFANITY_FOUND,data:{message:n}});t===S.CONV_C2C?e=this.get(6):t===S.CONV_GROUP&&(e=this.get(7));var s=new M("modifyMessage"),r=(s.setMessage("to:".concat(i)),"".concat(this._n,".modifyRemoteMessage"));return e.modifyRemoteMessage(n).then(function(e){s.end(),A.i("".concat(r," ok"));e=o._onModifyRemoteMessageResp(n,e.data);return yn({message:e})}).catch(function(e){var t;return s.setCode(e.code).setMoreMessage(e.message).end(),A.w("".concat(r," failed. error:"),e),20027===e.code?(t=o._onModifyRemoteMessageResp(n,e.data),m({code:C.MSG_MODIFY_CONFLICT,data:{message:t}})):m({code:e.code,message:e.message,data:{message:n}})})}},{key:"_generateSearchdata",value:function(e){var t=e.conversationID,n=e.timePosition,o=e.timePeriod,e=h(e,Ra);return k(t)||(Lt(t)&&(e.account=t.replace(S.CONV_C2C,"")),St(t)&&(e.groupID=t.replace(S.CONV_GROUP,""))),ze(o)&&0<o&&(ze(n)&&0<n?e.startTime=n-o:e.startTime=Ae()-o),e.startTime&&e.startTime<0&&(e.startTime=void 0),ze(n)&&0<n&&(e.endTime=n),e}},{key:"searchCloudMessages",value:function(i){var a=this,e="searchCloudMessages",s="".concat(this._n,".").concat(e);if(!i)return m({code:C.OPTIONS_IS_EMPTY,message:this.getErrorMessage(C.OPTIONS_IS_EMPTY,e)});var t=i.keywordList,n=i.keywordListMatchType,o=i.conversationID,r=i.cursor,l=Qe(i.senderUserIDList)&&0<i.senderUserIDList.length,d=Qe(i.messageTypeList)&&0<i.messageTypeList.length;if(!t&&!l&&!d)throw A.e("[".concat(e,'] Missing required params: "keywordList".')),new Error("Params validate failed.");var p=Date.now(),c=new M(e),u="keywordList:".concat(t," keywordListMatchType:").concat(n," ")+"conversationID:".concat(o," cursor:").concat(r);return A.l("".concat(s," ").concat(u)),this.req({proto:v.MSG_CLOUD_SEARCH,data:this._generateSearchdata(i)}).then(function(e){var t=e.data,n=t.code,t=t.message;if(0!==n)return t=a.getErrorMessage(60020===n?"SearchCloudMessagesUnavailable":n)||t,n=new bn({code:n,message:t}),c.setMessage(u).setError(n).end(),m(n);a.get(27).isSearchCloudMessagesEnabled();var t=e.data,n=t.cursor,e=t.totalCount,t=t.searchResult,o="totalCount:".concat(e," cost:").concat(zt(p)),o=(A.l("".concat(s," ok. cursor:").concat(n," ").concat(o)),c.setMessage("".concat(u," ").concat(o)).end(),a._handleSearchResults(t,!i.conversationID));return yn({searchResultList:o,cursor:n,totalCount:e})}).catch(function(e){return c.setMessage(u).setError(e).end(),m(e)})}},{key:"_handleSearchResults",value:function(e,a){var s=this.get(11);return Qe(e)&&0!==e.length?e.map(function(e){var t=e.groupID,n=e.userID,o=e.messageCount,e=e.messageList,n=t?"".concat(S.CONV_GROUP).concat(t):"".concat(S.CONV_C2C).concat(n),i={conversationID:n,messageCount:o,messageList:[]};return a&&1<o||e&&0<e.length&&(o=s.onRoamingMessage(e,n,!1),t&&o.reverse(),i.messageList=o),i}):[]}},{key:"_onModifyRemoteMessageResp",value:function(e,t){A.d("".concat(this._n,"._onModifyRemoteMessageResp options:"),t);var n=e.conversationType,o=e.from,i=e.to,a=e.random,s=e.sequence,e=e.time,r=t.elements,c=t.messageVersion,t=t.cloudCustomData,t=void 0===t?"":t;return this.get(11).onMessageModified({conversationType:n,from:o,to:i,time:e,random:a,sequence:s,elements:r,cloudCustomData:t,messageVersion:c})}},{key:"_generateUUID",value:function(e){var t=this.get(12),t="".concat(t.getSDKAppID(),"-").concat(t.getUserID(),"-").concat(rt()),e=e.name||e.value||e.url||e.tempFilePath,e=e&&e.slice(e.lastIndexOf(".")+1);return t=e?"".concat(t,".").concat(e):t}},{key:"getMessageOption",value:function(e){return this._messageOptionsMap.get(e)}},{key:"_getNickAndAvatarByUserID",value:function(e){return this.get(4).getNickAndAvatarByUserID(e)}},{key:"_getNameCardByGroupID",value:function(e){if(e.conversationType===S.CONV_GROUP){var t=this.get(7);if(t)return t.getMyNameCardByGroupID(e.to)}return""}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._messageOptionsMap.clear()}}]),Ba),Na=(t(Ha,Nn),Aa=f(Ha),e(Ha,[{key:"onMessageExtensionNotify",value:function(e){var o=this,e=e.dataList,t=e.messageInfo,i=e.operateType,n=e.operateResultList,l=e.tinyID,e=e.globalSequence,d=t.clientTime,t=t.random,a="".concat(l,"-").concat(d,"-").concat(t),s=[],r=[],c=(A.l("".concat(this._n,".onMessageExtensionNotify messageID:").concat(a," operateType:").concat(i," globalSequence:").concat(e)),this._updateGlobalSequence(a,e),!1),u=!1;n.forEach(function(e){var t=e.extensions,t=void 0===t?[]:t,n=e.clearSequence;1===i?(c=!0,t.forEach(function(e){s.push({key:e.key,value:e.value})}),o._updateLocalExtension(a,t)):2===i?(u=!0,t.forEach(function(e){r.push(e.key)}),o._updateLocalExtension(a,t)):3===i&&(u=!0,o._hasLocalExtension(a)&&o._getLocalExtension(a).forEach(function(e,t){e.seq<=n&&!We(e.value)&&r.push(t)}),o._clearLocalExtension(a,n))}),c&&this.emitOuterEvent(G.MESSAGE_EXTENSIONS_UPDATED,{messageID:a,extensions:s}),u&&this.emitOuterEvent(G.MESSAGE_EXTENSIONS_DELETED,{messageID:a,keyList:r})}},{key:"setMessageExtensions",value:function(e,t){var n="setMessageExtensions";if(!this.canIUse(H.MSG_EXT))return this.cannotUseCommercialAbility(n);var o="".concat(this._n,".").concat(n),i=e.ID,a=e.conversationID,s=e.sequence,r=e.time,c=T(t),t=(20<t.length&&(c=t.slice(0,20),A.w("".concat(o,". the length of extensions cannot exceed 20."))),"conversationID:".concat(a," messageID:").concat(i," sequence:").concat(s," time:").concat(r," count:").concat(c.length)),u=new M(n);return u.setMessage(t),A.l("".concat(o," ").concat(t)),this._modifyMessageExtensions(e,c).then(function(e){var t=e.resultList,n=e.successCount,e=e.failureCount,n="success count:".concat(n," fail count:").concat(e);return u.setMoreMessage(n).end(),A.l("".concat(o," ok. ").concat(n)),yn({extensions:t})}).catch(function(e){return u.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"getMessageExtensions",value:function(e){var t=this,n="getMessageExtensions";if(!this.canIUse(H.MSG_EXT))return this.cannotUseCommercialAbility(n);var o="".concat(this._n,".").concat(n),i=e.ID,a=e.conversationID,s=e.sequence,r=e.time,a="conversationID:".concat(a," messageID:").concat(i," sequence:").concat(s," time:").concat(r),c=new M(n),u=(c.setMessage(a),A.l("".concat(o," ").concat(a)),void 0);return this.getMessageExtensionsMap.has(i)&&(u=this._getGlobalSequence(i)),this._getMessageExtensions(e,u).then(function(e){return c.end(),A.l("".concat(o," ok. total count:").concat(e.length)),k(u)&&0<e.length&&t.getMessageExtensionsMap.set(i,1),yn({extensions:e})}).catch(function(e){return c.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"deleteMessageExtensions",value:function(e,t){var n="deleteMessageExtensions";if(!this.canIUse(H.MSG_EXT))return this.cannotUseCommercialAbility(n);var i="".concat(this._n,".").concat(n),o=[],a=3,t=(We(t)||(a=2,t.forEach(function(e){o.push({key:e,value:"",seq:0})})),e.ID),s=e.conversationID,r=e.sequence,c=e.time,s="conversationID:".concat(s," messageID:").concat(t," sequence:").concat(r," time:").concat(c," operateType:").concat(a),u=new M(n);return u.setMessage(s),A.l("".concat(i," ").concat(s)),this._modifyMessageExtensions(e,o,a).then(function(e){var t=e.resultList,n=e.successCount,e=e.failureCount,o="";return 2===a&&(o="success count:".concat(n," fail count:").concat(e)),u.setMoreMessage("".concat(o)).end(),A.l("".concat(i," ok. ").concat(o)),yn({extensions:t})}).catch(function(e){return u.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"_modifyMessageExtensions",value:function(n,e){var o=this,t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,i=Et(n.to)?S.CONV_TOPIC:n.conversationType,a=void 0,s=(3!==t&&(a=this._getRequestExtensions(n,e)),null);switch(i){case S.CONV_C2C:s=this.get(6);break;case S.CONV_GROUP:s=this.get(7);break;case S.CONV_TOPIC:s=this.get(10);break;default:return m({code:C.CANNOT_FIND_MODULE})}return s.modifyMessageExtensions(n,a,t).then(function(e){var e=e.data,t=e.extensions,e=e.seq,i=[],a=0,s=0,r=[];return(t=We(t)?[]:t).forEach(function(e){var t=e.errorCode,e=e.extension,n=e.key,o=e.value,e=e.seq;i.push({code:t,key:n,value:o}),0===t?a++:s++,r.push({key:n,value:o,seq:e})}),o._updateGlobalSequence(n.ID,e),0<r.length&&(o._updateLocalExtension(n.ID,r),r=null),{resultList:i,successCount:a,failureCount:s}}).catch(function(e){return m(e)})}},{key:"_getRequestExtensions",value:function(e,t){var o,i=[];return this._hasLocalExtension(e.ID)?(o=this._getLocalExtension(e.ID),t.forEach(function(e){var t=e.key,e=e.value,n=0;o.has(t)&&(n=o.get(t).seq),i.push({key:t,value:e,seq:n})})):t.forEach(function(e){var t=e.key,e=e.value;i.push({key:t,value:e,seq:0})}),i}},{key:"_getMessageExtensions",value:function(i,e){var a=this,s="".concat(this._n,"._getMessageExtensions"),r=i.ID,t=i.to,n=null;switch(Et(t)?S.CONV_TOPIC:i.conversationType){case S.CONV_C2C:n=this.get(6);break;case S.CONV_GROUP:n=this.get(7);break;case S.CONV_TOPIC:n=this.get(10);break;default:return m({code:C.CANNOT_FIND_MODULE})}return n.getMessageExtensions(i,e).then(function(e){var e=e.data,t=e.extensions,n=e.completeFlag,o=e.globalSequence,e=e.clearSequence,t=We(t)?[]:t;return A.l("".concat(s," ok. completeFlag:").concat(n," globalSequence:").concat(o," clearSequence:").concat(e," count:").concat(t.length)),a._updateLocalExtension(r,t),a._clearLocalExtension(r,e),a._updateGlobalSequence(r,o),1!==n?(e=t.slice(-1)[0].seq+1,a._getMessageExtensions(i,e)):a._getLocalExtensions(r)}).catch(function(e){return m(e)})}},{key:"_hasLocalExtension",value:function(e){return this.messageExtensionMap.has(e)}},{key:"_getLocalExtension",value:function(e){return this.messageExtensionMap.get(e)}},{key:"_updateLocalExtension",value:function(e,t){this._hasLocalExtension(e)||this.messageExtensionMap.set(e,new Map);var o=this._getLocalExtension(e);t.forEach(function(e){var t=e.key,n=e.value,e=e.seq;o.set(t,{value:void 0===n?"":n,seq:e})})}},{key:"_clearLocalExtension",value:function(e,n){var o;n<=0||!this._hasLocalExtension(e)||(o=this._getLocalExtension(e)).forEach(function(e,t){e.seq<=n&&o.delete(t)})}},{key:"_getLocalExtensions",value:function(e){var n=[];return this._hasLocalExtension(e)&&this._getLocalExtension(e).forEach(function(e,t){e=e.value;We(e)||n.push({key:t,value:e})}),n}},{key:"_getGlobalSequence",value:function(e){return this.globalSeqMap.get(e)}},{key:"_updateGlobalSequence",value:function(e,t){this.globalSeqMap.set(e,t)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this.messageExtensionMap.clear(),this.globalSeqMap.clear(),this.getMessageExtensionsMap.clear()}}]),Ha),Ga=(t(Va,Nn),Sa=f(Va),e(Va,[{key:"onMessageReactionNotifyList",value:function(e){var a=this,e=(e||{}).dataList;(void 0===e?[]:e).forEach(function(e){var t=e.C2CMessageInfo,n=e.groupMessageInfo,n=void 0===n?{}:n,e=e.reactionList,e=void 0===e?[]:e,t=y(y({},void 0===t?{}:t),n),n=t.tinyID,o=t.clientTime,t=t.random,n="".concat(n,"-").concat(o,"-").concat(t),i=[];e.forEach(function(e){k(e.userIDList)&&(e.userIDList=[],e.count=0),i.push.apply(i,T(e.userIDList))}),A.l("".concat(a._n,".onMessageReactionNotifyList messageID:").concat(n," reactionList:").concat(e.length)),a._handleReactionSummary([{messageID:n,reactionList:e}],i).then(function(e){a.emitOuterEvent(G.MESSAGE_REACTIONS_UPDATED,y({},e[0]))})})}},{key:"onMessageReactionNotify",value:function(e){var e=e.dataList||{},t=e.C2CMessageInfo,n=e.groupMessageInfo,n=void 0===n?{}:n,o=e.reactionID,e=e.operateType,t=y(y({},void 0===t?{}:t),n),n=t.tinyID,i=t.clientTime,t=t.random,n="".concat(n,"-").concat(i,"-").concat(t),i=(A.l("".concat(this._n,".onMessageReactionNotify messageID:").concat(n," reactionID:").concat(o," operateType:").concat(e)),1===e?this._addReactedByMyselfMap(n,o):this._removeReactedByMyselfMap(n,o),"".concat(n,"-").concat(o));this._reactionInfoMap.has(i)&&((t=this._reactionInfoMap.get(i)).reactedByMyself=1===e,this.emitOuterEvent(G.MESSAGE_REACTIONS_UPDATED,{messageID:n,reactionList:[t]}))}},{key:"addMessageReaction",value:function(t,n){var o=this,e="addMessageReaction";if(!this.canIUse(H.MSG_REACTION))return this.cannotUseCommercialAbility(e);var i="".concat(this._n,".").concat(e),a=t.ID,s=t.conversationID,s="conversationID:".concat(s," messageID:").concat(a," reactionID:").concat(n),r=new M(e),a=(r.setMessage(s),A.l("".concat(i," ").concat(s)),this._createReactionOperationPack(t,n,1));return this._addReactedByMyselfMap(t.ID,n),this.req(a).then(function(){return r.end(),A.l("".concat(i," ok.")),yn()}).catch(function(e){return o._removeReactedByMyselfMap(t.ID,n),r.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"removeMessageReaction",value:function(e,t){var n="removeMessageReaction";if(!this.canIUse(H.MSG_REACTION))return this.cannotUseCommercialAbility(n);var o="".concat(this._n,".").concat(n),i=e.ID,a=e.conversationID,a="conversationID:".concat(a," messageID:").concat(i," reactionID:").concat(t),s=new M(n),i=(s.setMessage(a),A.l("".concat(o," ").concat(a)),this._createReactionOperationPack(e,t,2));return this._removeReactedByMyselfMap(e.ID,t),this.req(i).then(function(){return s.end(),A.l("".concat(o," ok.")),yn()}).catch(function(e){return s.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"getMessageReactions",value:function(e){var t=this,n="getMessageReactions";if(!this.canIUse(H.MSG_REACTION))return this.cannotUseCommercialAbility(n);var o="".concat(this._n,".").concat(n),i=e.messageList,a=e.maxUserCountPerReaction,s=i[0].conversationID,s="conversationID:".concat(s," maxUserCountPerReaction:").concat(a," messageList:").concat(i.length),r=new M(n),c=(r.setMessage(s),A.l("".concat(o," ").concat(s)),new Map),a=this._createReactionSummaryPack(y(y({},e),{},{messageIDMap:c}));return this.req(a).then(function(e){var e=e.data.resultList,o=[],i=[];return(void 0===e?[]:e).forEach(function(e){var t=e.messageKey,t=void 0===t?void 0:t,n=e.messageSequence,n=void 0===n?void 0:n,e=e.reactionList,e=void 0===e?[]:e,n=k(t)?c.get(n):c.get(t);o.push({messageID:n,reactionList:e}),e.forEach(function(e){i.push.apply(i,T(e.userIDList))})}),t._handleReactionSummary(o,i)}).then(function(e){return r.end(),A.l("".concat(o," ok.")),c.clear(),yn({resultList:e})}).catch(function(e){return r.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"getAllUserListOfMessageReaction",value:function(e){var n=this,t="getAllUserListOfMessageReaction";if(!this.canIUse(H.MSG_REACTION))return this.cannotUseCommercialAbility(t);var o="".concat(this._n,".").concat(t),i=e.message,a=e.reactionID,s=e.nextSeq,l=e.count,r=i.ID,i=i.conversationID,i="conversationID:".concat(i," messageID:").concat(r," reactionID:").concat(a," nextSeq:").concat(s," count:").concat(l),c=new M(t),u=(c.setMessage(i),A.l("".concat(o," ").concat(i)),{userList:[],nextSeq:0,isCompleted:!1}),r=this._createReactionUserListPack(e);return this.req(r).then(function(e){var e=e.data,t=e.userIDList,t=void 0===t?[]:t,e=e.nextSeq,e=void 0===e?0:e;return u.nextSeq=e,u.isCompleted=0===e,n.get(4).getUserNickAndAvatar(t)}).then(function(e){return u.userList=e,c.end(),A.l("".concat(o," ok.")),yn(u)}).catch(function(e){return c.setError(e).end(),A.e("".concat(o," failed. error:"),e),m(e)})}},{key:"_createReactionOperationPack",value:function(e,t,n){var o,i,a=void 0,t={reactionID:t,userIDList:[this.getMyUserID()]};return e.conversationType===S.CONV_C2C&&(o=this.get(6),a=1===n?v.ADD_C2C_MSG_REACTION:v.RM_C2C_MSG_REACTION,t.from=e.from,t.to=e.to,t.messageKey=o.getMessageKey(e)),e.conversationType===S.CONV_GROUP&&(o=void 0,i=e.to,Et(e.to)&&(i=xt(o=e.to)),a=1===n?v.ADD_GRP_MSG_REACTION:v.RM_GRP_MSG_REACTION,t.groupID=i,t.topicID=o,t.messageSequence=e.sequence),{proto:a,data:t}}},{key:"_createReactionSummaryPack",value:function(e){var n,t,o,i=e.messageList,a=e.maxUserCountPerReaction,a=void 0===a?10:a,s=e.messageIDMap,e=i[0],r=void 0,c=void 0;return e.conversationType===S.CONV_C2C&&(n=this.get(6),t=i.map(function(e){var t=n.getMessageKey(e);return s.set(t,e.ID),t}),r=v.GET_C2C_MSG_REACTIONS,c={from:e.from,to:e.to,messageKeyList:t,count:a}),e.conversationType===S.CONV_GROUP&&(t=void 0,o=e.to,Et(e.to)&&(o=xt(t=e.to)),e=i.map(function(e){return s.set(e.sequence,e.ID),e.sequence}),r=v.GET_GRP_MSG_REACTIONS,c={groupID:o,topicID:t,messageSequenceList:e,count:a}),{proto:r,data:c}}},{key:"_createReactionUserListPack",value:function(e){var t=e.message,n=e.reactionID,o=e.nextSeq,e=e.count,e=void 0===e?100:e,i=void 0,n={reactionID:n,nextSeq:void 0===o?0:o,count:100<e?100:e};return t.conversationType===S.CONV_C2C&&(o=this.get(6),i=v.GET_C2C_MSG_REACTION_USER_LIST,n.from=t.from,n.to=t.to,n.messageKey=o.getMessageKey(t)),t.conversationType===S.CONV_GROUP&&(e=void 0,o=t.to,Et(t.to)&&(o=xt(e=t.to)),i=v.GET_GRP_MSG_REACTION_USER_LIST,n.groupID=o,n.topicID=e,n.messageSequence=t.sequence),{proto:i,data:n}}},{key:"_handleReactionSummary",value:function(t,e){var c=this;return this.get(4).getUserNickAndAvatar(e).then(function(r){var e=[];return t.forEach(function(a){var s=[];a.reactionList.forEach(function(e){var t=e.reactionID,n=e.count,o=e.userIDList,e=e.reactedByMyself,e=void 0===e?void 0:e,i=[],o=(o.forEach(function(t){r.forEach(function(e){t===e.userID&&i.push(e)})}),{reactionID:t,totalUserCount:n,partialUserList:i,reactedByMyself:c._computeReactedByMyself({reactedByMyself:e,messageID:a.messageID,reactionID:t})});s.push(o),k(e)&&!c._reactedByMyselfMap.has(a.messageID)&&(n="".concat(a.messageID,"-").concat(t),c._reactionInfoMap.set(n,o))}),e.push({messageID:a.messageID,reactionList:s})}),e})}},{key:"_addReactedByMyselfMap",value:function(e,t){this._reactedByMyselfMap.has(e)||this._reactedByMyselfMap.set(e,[]);e=this._reactedByMyselfMap.get(e);-1===e.indexOf(t)&&e.push(t)}},{key:"_removeReactedByMyselfMap",value:function(e,t){!this._reactedByMyselfMap.has(e)||-1<(t=(e=this._reactedByMyselfMap.get(e)).indexOf(t))&&e.splice(t,1)}},{key:"_computeReactedByMyself",value:function(e){var t=e.reactedByMyself,n=e.messageID,e=e.reactionID;return k(t)?!!this._reactedByMyselfMap.has(n)&&this._reactedByMyselfMap.get(n).includes(e):1===t}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._reactedByMyselfMap.clear(),this._reactionInfoMap.clear()}}]),Va),Pa=(t(xa,Nn),La=f(xa),e(xa,[{key:"sendMessage",value:function(e){var o=this,i=this._constructMessageInstance(e);if(null===i)return m({code:C.MSG_SEND_FAIL});this._addSendMessageTotalCount(i);var a=Date.now();return this.get(11).setMessageRandom(i),this._sendComboMessage(i,e).then(function(e){var e=e.data,t=e.time,n=e.sequence,e=e.readReceiptCode,e=(ze(e)&&0!==e&&(new M("sendMessageWithReceipt").setMessage("from:".concat(i.from," to:").concat(i.to," sequence:").concat(n," readReceiptCode:").concat(e)).end(),A.w("".concat(o._n,".sendMessage readReceiptCode:").concat(e," message:").concat(o.getErrorMessage(e)))),o._addSendMessageSuccessCount(i,a),o.get(11)),t=(i.status=En,i.time=t,i.conversationType===S.CONV_GROUP&&(i.sequence=n),e.appendToMessageList(i),i);return!0===i._isExcludedFromLastMessage&&(t=""),e.onMessageSent({conversationOptionsList:[{conversationID:i.conversationID,unreadCount:0,type:i.conversationType,subType:i.conversationSubType,lastMessage:t}]}),yn({message:i})}).catch(function(e){return o._onSendMessageFailed(i,e)})}},{key:"_sendComboMessage",value:function(e,t){var n=this._m.get(20),o="";return e.conversationType===S.CONV_C2C&&(o="".concat(a.NAME.OPEN_IM,".").concat(v.SEND_C2C_MSG)),e.conversationType===S.CONV_GROUP&&(o="".concat(a.NAME.GROUP,".").concat(v.SEND_GRP_MSG)),n.sendComboMessage({servcmd:o,data:t})}},{key:"_constructMessageInstance",value:function(e){var t="".concat(this._n,"._constructMessageInstance"),n=null;try{var o,i=this.getMyUserID(),a={};a.senderTinyID=this.getMyTinyID(),a.currentUser=i,a.from=e.From_Account||i,e.GroupId?(a.conversationID="".concat(S.CONV_GROUP).concat(e.GroupId),a.conversationType=S.CONV_GROUP,a.to=e.GroupId):e.To_Account&&(a.conversationID="".concat(S.CONV_C2C).concat(e.To_Account),a.conversationType=S.CONV_C2C,a.to=e.To_Account),a.time=e.MsgTimeStamp||0,a.random=e.Random||e.MsgRandom||0,a.priority=e.MsgPriority,pt(e.CloudCustomData)&&0<e.CloudCustomData.length&&(a.cloudCustomData=e.CloudCustomData),Qe(e.SendMsgControl)&&(a.messageControlInfo={},e.SendMsgControl.includes("NoUnread")&&(a.messageControlInfo.excludedFromUnreadCount=1),e.SendMsgControl.includes("NoLastMsg")&&(a.messageControlInfo.excludedFromLastMessage=1)),a.conversationType===S.CONV_GROUP&&Qe(e.To_Account)&&0<e.To_Account.length&&(o=e.To_Account,50<e.To_Account.length&&(o=e.To_Account.slice(0,50),A.w("".concat(t," To_Account must be less than or equal to 50."))),a.receiverList=T(o),e.To_Account=T(o)),1!==e.IsNeedReadReceipt&&1!==e.NeedReadReceipt||(a.needReadReceipt=!0),1===e.SupportMessageExtension&&(a.isSupportExtension=!0),(n=new go(a)).status=Dn,e.MsgClientTime=n.clientTime,n.conversationType===S.CONV_C2C&&(e.MsgSeq=n.sequence);for(var s,r=e.MsgBody.length,c=0;c<r;c++)"TIMTextElem"===(s=e.MsgBody[c]).MsgType?n.setTextElement(s.MsgContent.Text):"TIMCustomElem"===s.MsgType?n.setCustomElement({data:s.MsgContent.Data||"",description:s.MsgContent.Desc||"",extension:s.MsgContent.Ext||""}):"TIMFaceElem"===s.MsgType&&n.setFaceElement({index:s.MsgContent.Index,data:s.MsgContent.Data});var u=n.getElements();n.payload=u[0].content,n.type=u[0].type}catch(e){n=null,A.e("".concat(t," failed. error:"),e)}return n}},{key:"_onSendMessageFailed",value:function(e,t){return e.status=Ln,this.get(11).deleteMessageRandom(e),this._addSendMessageFailCountOnUser(e,t),new M("sendMessage").setMessage("tjg_id:".concat(this.generateTjgID(e)," type:").concat(e.type," from:").concat(e.from," to:").concat(e.to)).setError(t).end(),A.e("".concat(this._n,"._onSendMessageFailed error:"),t),m(new bn({code:t&&t.code?t.code:C.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}},{key:"_getSendMessageSpecifiedKey",value:function(e){if(e.conversationType===S.CONV_C2C)return xn;if(e.conversationType===S.CONV_GROUP){var e=this.get(7).getLocalGroupProfile(e.to);if(e)return e=e.type,Tt(e)?Hn:Vn}}},{key:"_addSendMessageTotalCount",value:function(e){e=this._getSendMessageSpecifiedKey(e);e&&this.get(26).addTotalCount(e)}},{key:"_addSendMessageSuccessCount",value:function(e,t){var n,e=this._getSendMessageSpecifiedKey(e);e&&((n=this.get(26)).addSuccessCount(e),n.addCost(e,zt(t,!1)))}},{key:"_addSendMessageFailCountOnUser",value:function(e,t){var t=t.code,t=void 0===t?-1:t,n=this.get(26),e=this._getSendMessageSpecifiedKey(e);Ta(t)&&e&&n.addFailedCountOfUserSide(e)}}]),xa),Ua=(t(qa,Nn),Ea=f(qa),e(qa,[{key:"registerPlugin",value:function(t){var n=this;Object.keys(t).forEach(function(e){n.plugins[e]=t[e]}),new M("registerPlugin").setMessage("".concat(Object.keys(t))).end()}},{key:"getPlugin",value:function(e){return this.plugins[e]}},{key:"reset",value:function(){}}]),qa),ba=(t(wa,Nn),Da=f(wa),e(wa,[{key:"_onLoginSuccess",value:function(e){this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0})}},{key:"_startSync",value:function(e){var o=this,t=e.cookie,n=e.syncFlag,e=e.isOnlineSync,i="".concat(this._n,"._startSync");A.l("".concat(i," cookie:").concat(t," syncFlag:").concat(n," isOnlineSync:").concat(e)),this.req({proto:v.SYNC_UNREAD_MSG,data:{cookie:t,syncFlag:n,isOnlineSync:e}}).then(function(e){var t=e.data,n=t.cookie,t=t.syncFlag;We(o._cookie=n)||(0===t||1===t?(o._dispatchUnreadMessage(y(y({},e.data),{},{isSyncingEnded:!1})),o._startSync({cookie:n,syncFlag:t,isOnlineSync:0})):2===t&&o._dispatchUnreadMessage(y(y({},e.data),{},{isSyncingEnded:!0})))}).catch(function(e){A.e("".concat(i," failed. error:"),e)})}},{key:"_dispatchUnreadMessage",value:function(e){e.eventArray&&this.get(20).onMessage({head:{},body:{eventArray:e.eventArray,isInstantMessage:this._onlineSyncFlag,isSyncingEnded:e.isSyncingEnded}}),this.get(6).onNewC2CMessage({dataList:e.messageList,isInstantMessage:!!e.isSyncingEnded&&this._onlineSyncFlag,C2CRemainingUnreadList:e.C2CRemainingUnreadList,C2CPairUnreadList:e.C2CPairUnreadList,isSyncingEnded:e.isSyncingEnded})}},{key:"startOnlineSync",value:function(){A.l("".concat(this._n,".startOnlineSync")),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:1})}},{key:"startSyncOnReconnected",value:function(){A.l("".concat(this._n,".startSyncOnReconnected.")),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0})}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._onlineSyncFlag=!1,this._cookie=""}}]),wa),Fa={request:{toAccount:"To_Account",fromAccount:"From_Account",to:"To_Account",from:"From_Account",groupID:"GroupId",groupAtUserID:"GroupAt_Account",extension:"Ext",data:"Data",description:"Desc",elements:"MsgBody",sizeType:"Type",downloadFlag:"Download_Flag",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",videoUrl:"",imageUrl:"URL",fileUrl:"Url",uuid:"UUID",priority:"MsgPriority",receiverUserID:"To_Account",receiverGroupID:"GroupId",messageSender:"SenderId",messageReceiver:"ReceiverId",nick:"From_AccountNick",avatar:"From_AccountHeadurl",messageNumber:"MsgNum",pbDownloadKey:"PbMsgKey",downloadKey:"JsonMsgKey",applicationType:"PendencyType",userIDList:"To_Account",groupNameList:"GroupName",userID:"To_Account",groupAttributeList:"GroupAttr",mainSequence:"AttrMainSeq",avChatRoomKey:"BytesKey",attributeControl:"AttrControl",sequence:"seq",messageControlInfo:"SendMsgControl",updateSequence:"UpdateSeq",clientTime:"MsgClientTime",sequenceList:"MsgSeqList",topicID:"TopicId",customData:"CustomString",isSupportTopic:"SupportTopic",isWebUniapp:"is_web_uniapp",isSupportExtension:"SupportMessageExtension",messageSequence:"MsgSeq",messageKey:"MsgKey",startSequence:"startSeq",simplifiedMessage:"DownsizeFlag",isRelayMessage:"IsRelayMsg",reactionID:"Reaction",messageSequenceList:"MsgSeqList",messageKeyList:"MsgKeyList",cmConfigID:"CustomModerationConfigID"},response:{MsgPriority:"priority",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",Download_Flag:"downloadFlag",GroupId:"groupID",Member_Account:"userID",MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",MsgSeq:"sequence",MsgRandom:"random",MsgTime:"time",MsgTimeStamp:"time",MsgContent:"content",MsgBody:"elements",From_AccountNick:"nick",From_AccountHeadurl:"avatar",GroupWithdrawInfoArray:"revokedInfos",GroupReadInfoArray:"groupMessageReadNotice",LastReadMsgSeq:"lastMessageSeq",WithdrawC2cMsgNotify:"c2cMessageRevokedNotify",C2cWithdrawInfoArray:"revokedInfos",C2cReadedReceipt:"c2cMessageReadReceipt",ReadC2cMsgNotify:"c2cMessageReadNotice",LastReadTime:"peerReadTime",MsgRand:"random",MsgType:"type",MsgShow:"messageShow",NextMsgSeq:"nextMessageSeq",FaceUrl:"avatar",ProfileDataMod:"profileModify",Profile_Account:"userID",ValueBytes:"value",ValueNum:"value",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgFrom_AccountExtraInfo:"messageFromAccountExtraInformation",Operator_Account:"operatorID",OpType:"operationType",ReportType:"operationType",UserId:"userID",User_Account:"userID",List_Account:"userIDList",MsgOperatorMemberExtraInfo:"operatorInfo",MsgMemberExtraInfo:"memberInfoList",ImageUrl:"avatar",NickName:"nick",MsgGroupNewInfo:"newGroupProfile",MsgAppDefinedData:"groupCustomField",Owner_Account:"ownerID",GroupFaceUrl:"avatar",GroupIntroduction:"introduction",GroupNotification:"notification",GroupApplyJoinOption:"joinOption",MsgKey:"messageKey",GroupInfo:"groupProfile",ShutupTime:"muteTime",Desc:"description",Ext:"extension",GroupAt_Account:"groupAtUserID",MsgNum:"messageNumber",PbMsgKey:"pbDownloadKey",JsonMsgKey:"downloadKey",MsgModifiedFlag:"isModified",PendencyItem:"applicationItem",PendencyType:"applicationType",AddTime:"time",AddSource:"source",AddWording:"wording",ProfileImImage:"avatar",PendencyAdd:"friendApplicationAdded",FrienPencydDel_Account:"friendApplicationDeletedUserIDList",Peer_Account:"userID",GroupAttr:"groupAttributeList",GroupAttrAry:"groupAttributeList",AttrMainSeq:"mainSequence",seq:"sequence",GroupAttrOption:"groupAttributeOption",BytesChangedKeys:"changedKeyList",GroupAttrInfo:"groupAttributeList",GroupAttrSeq:"mainSequence",PushChangedAttrValFlag:"isWithChangedAttributeInfo",SubKeySeq:"sequence",Val:"value",MsgGroupFromCardName:"senderNameCard",MsgGroupFromNickName:"senderNick",C2cNick:"peerNick",C2cImage:"peerAvatar",SendMsgControl:"messageControlInfo",NoLastMsg:"excludedFromLastMessage",NoUnread:"excludedFromUnreadCount",UpdateSeq:"updateSequence",MuteNotifications:"muteFlag",MsgClientTime:"clientTime",TinyId:"tinyID",GroupMsgReceiptList:"readReceiptList",ReadNum:"readCount",UnreadNum:"unreadCount",TopicId:"topicID",MillionGroupFlag:"communityType",SupportTopic:"isSupportTopic",MsgTopicNewInfo:"newTopicInfo",ShutupAll:"muteAllMembers",CustomString:"customData",TopicFaceUrl:"avatar",TopicIntroduction:"introduction",TopicNotification:"notification",TopicIdArray:"topicIDList",MsgVersion:"messageVersion",C2cMsgModNotifys:"c2cMessageModified",GroupMsgModNotifys:"groupMessageModified",ApplyJoinOption:"joinOption",MsgFlag:"messageRemindType",AtInfoList:"groupAtInfoList",AtFlagList:"groupAtType",AtMsgSeq:"sequence",BanDuration:"duration",BanDescription:"reason",NotVisible:"invisible",BytesTag:"tag",BytesValue:"value",RptBytesValue:"value",LatestSeq:"globalSequence",ClearSeq:"clearSequence",SupportMessageExtension:"isSupportExtension",ExtensionList:"extensions",GroupCounter:"counterList",Revoker_Account:"revoker",MsgExtensionNotify:"messageExtensionNotify",ExtensionC2cMsgInfo:"messageInfo",ExtensionGroupMsgInfo:"messageInfo",MsgOptType:"operateType",SetKVInfo:"operateResultList",DeleteKVInfo:"operateResultList",ClearKVInfo:"operateResultList",MsgKeyValue:"extensions",ClearMsgSeq:"clearSequence",MsgLastSeq:"globalSequence",InviteJoinOption:"inviteOption",MemberList_Account:"inviteeList",MsgMemberExtraInfoList:"inviteeInfoList",E:"event",GInf:"groupProfile",MCT:"clientTime",MR:"random",MP:"priority",MTS:"time",GId:"groupID",MS:"sequence",CCD:"cloudCustomData",F_Account:"from",F_Hd:"avatar",F_NN:"nick",GN:"groupName",GT:"groupType",IsSys:"isSystemMessage",OpInf:"operatorInfo",Img:"avatar",NN:"nick",OnlineInf:"onlineMemberInfo",ET:"expireTime",Num:"onlineMemberNum",Opt:"operationType",O_Account:"operatorID",RT:"operationType",UDF:"userDefinedField",L_Account:"userIDList",IsPlaceMsg:"isPlaceMessage",MsgCheckResult:"checkResult",Results:"resultList",Reaction:"reactionID",Reaction_Account:"userIDList",MsgReactionNotifyList:"messageReactionNotifyList",MsgReactionNotify:"messageReactionNotify",MsgReactionSummary:"reactionList",C2CMsgInfo:"C2CMessageInfo",GroupMsgInfo:"groupMessageInfo",int32_err_code:"errorCode",str_err_msg:"errorMsg",MsgDropReason:"messageDropReason",ReactedByMe:"reactedByMyself",Level:"messageRemindType"},ignoreKeyWord:["C2C","ID","USP"]};function wa(e){return u(this,wa),(e=Da.call(this,e))._n="SyncUnreadMessageModule",e._cookie="",e._onlineSyncFlag=!1,e.getInnerEmitterInstance().on(Uo.A2KEY_AND_TINYID_UPDATED,e._onLoginSuccess,g(e)),e}function qa(e){return u(this,qa),(e=Ea.call(this,e))._n="PluginModule",e.plugins={},e}function xa(e){return u(this,xa),(e=La.call(this,e))._n="ComboMessageModule",e}function Va(e){return u(this,Va),(e=Sa.call(this,e))._n="MessageReactionModule",e._reactedByMyselfMap=new Map,e._reactionInfoMap=new Map,e}function Ha(e){return u(this,Ha),(e=Aa.call(this,e))._n="MessageExtensionModule",e.messageExtensionMap=new Map,e.globalSeqMap=new Map,e.getMessageExtensionsMap=new Map,e}function Ba(e){return u(this,Ba),(e=ka.call(this,e))._n="MessageModule",e._messageOptionsMap=new Map,e._mergerMessageHandler=new va(g(e)),e}function Ka(e,t){if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");return t=Object.assign({pascalCase:!1},t),0===(e=Array.isArray(e)?e.map(function(e){return e.trim()}).filter(function(e){return e.length}).join("-"):e.trim()).length?"":1===e.length?t.pascalCase?e.toUpperCase():e.toLowerCase():(e=e=(e=e!==e.toLowerCase()?Wa(e):e).replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,function(e,t){return t.toUpperCase()}).replace(/\d+(\w|$)/g,function(e){return e.toUpperCase()}),t.pascalCase?e.charAt(0).toUpperCase()+e.slice(1):e)}var Wa=function(e){for(var t=!1,n=!1,o=!1,i=0;i<e.length;i++){var a=e[i];t&&/[a-zA-Z]/.test(a)&&a.toUpperCase()===a?(e=e.slice(0,i)+"-"+e.slice(i),o=n,n=!(t=!1),i++):n&&o&&/[a-zA-Z]/.test(a)&&a.toLowerCase()===a?(e=e.slice(0,i-1)+"-"+e.slice(i-1),o=n,t=!(n=!1)):(t=a.toLowerCase()===a&&a.toUpperCase()!==a,o=n,n=a.toUpperCase()===a&&a.toLowerCase()!==a)}return e};function Ya(e,t){var r=0;return function n(e,i){return 100<++r?(r--,e):Qe(e)?(t=e.map(function(e){return Xe(e)?n(e,i):e}),r--,t):Xe(e)?(o=e,a=function(e,t){if(!nt(t))return!1;if(t!==Ka(t))for(var n=0;n<Fa.ignoreKeyWord.length&&!t.includes(Fa.ignoreKeyWord[n]);n++);var o;return k(i[t])?"OPPOChannelID"===(o=t)?o:o[0].toUpperCase()+Ka(o).slice(1):i[t]},s=Object.create(null),Object.keys(o).forEach(function(e){var t=a(o[e],e);t&&(s[t]=o[e])}),t=kt(t=s,function(e,t){return Qe(e)||Xe(e)?n(e,i):e}),r--,t):void 0;var t,o,a,s}(e,t)}for(var ja,Ja=String.fromCharCode,za=function(e){var t=0|e.charCodeAt(0);if(55296<=t)if(t<56320){e=0|e.charCodeAt(1);if(56320<=e&&e<=57343){if(65535<(t=(t<<10)+e-56613888|0))return Ja(240|t>>>18,128|t>>>12&63,128|t>>>6&63,128|63&t)}else t=65533}else t<=57343&&(t=65533);return t<=2047?Ja(192|t>>>6,128|63&t):Ja(224|t>>>12,128|t>>>6&63,128|63&t)},Xa=function(e){for(var t=void 0===e?"":(""+e).replace(/[\x80-\uD7ff\uDC00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]?/g,za),n=0|t.length,o=new Uint8Array(n),i=0;i<n;i=i+1|0)o[i]=0|t.charCodeAt(i);return o},Za=(e(Is,[{key:"getID",value:function(){return this._id}},{key:"_onOpen",value:function(e){this._handler.onOpen({id:this._id,res:JSON.stringify(e)})}},{key:"_onClose",value:function(e){this._handler.onClose({id:this._id,e:e})}},{key:"_onMessage",value:function(e){e=this._canIUseBinaryFrame?this._isAppCompressedData(e.data)?this._handler.inflate(e.data):function(e){for(var t=new Uint8Array(e),n="",o=0,i=t.length;o<i;){var a=t[o],s=0,r=0;if(a<=127?(s=0,r=255&a):a<=223?(s=1,r=31&a):a<=239?(s=2,r=15&a):a<=244&&(s=3,r=7&a),0<i-o-s)for(var c=0;c<s;)r=r<<6|63&(a=t[o+c+1]),c+=1;else r=65533,s=i-o;n+=String.fromCodePoint(r),o+=s+1}return n}(e.data):e.data;this._handler.onMessage({data:e})}},{key:"_isAppCompressedData",value:function(e){e=new Uint8Array(e);return 67===e[0]&&79===e[1]&&77===e[2]&&80===e[3]}},{key:"_onError",value:function(e){this._handler.onError({id:this._id,e:e})}},{key:"setIsWorkerEnabled",value:function(e){this._isWorkerEnabled=!0}},{key:"close",value:function(e){if(this._workerSocket&&(this._workerSocket.postMessage({cmd:"stop",code:e}),this._workerSocket.terminate(),this._workerSocket=null),Z)return oe.offSocketClose(),oe.offSocketMessage(),oe.offSocketOpen(),oe.offSocketError(),void oe.closeSocket();this._socket&&(te?(this._socket.onClose(function(){}),this._socket.onOpen(function(){}),this._socket.onMessage(function(){}),this._socket.onError(function(){})):ne&&(this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null),X?this._socket.close({code:e}):this._socket.close(e),this._socket=null)}},{key:"send",value:function(e){this._workerSocket?this._workerSocket.postMessage({cmd:"sendMessage",data:this._canIUseBinaryFrame?Xa(e.data).buffer:e.data}):Z?oe.sendSocketMessage({data:e.data,fail:function(){e.fail&&e.requestID&&e.fail(e.requestID)}}):this._socket&&(te?this._socket.send({data:this._canIUseBinaryFrame?Xa(e.data).buffer:e.data,fail:function(){e.fail&&e.requestID&&e.fail(e.requestID)}}):ne&&this._socket.send(this._canIUseBinaryFrame?Xa(e.data):e.data))}}]),Is),Qa=["keyMap"],$a=["keyMap"],es="connected",ts="connecting",ns="disconnected",os=(e(Ms,[{key:"_setWebsocketHost",value:function(){var e=this._chM.get(12);this._currentSite=V,this._chM.isOversea()&&(this._currentSite="OVERSEA"),e.isSingaporeSite()?this._currentSite="SINGAPORE":e.isKoreaSite()?this._currentSite="KOREA":e.isGermanySite()?this._currentSite="GERMANY":e.isIndiaSite()?this._currentSite="IND":e.isJapanSite()?this._currentSite="JPN":e.isUSASite()?this._currentSite="USA":e.isIndonesiaSite()&&(this._currentSite="INDONESIA"),a.HOST.setCurrent(this._currentSite)}},{key:"_initConnection",value:function(){k(a.HOST.CURRENT.BACKUP)||""===this._url?this._url=a.HOST.CURRENT.DEFAULT:this._url===a.HOST.CURRENT.DEFAULT?this._url=a.HOST.CURRENT.BACKUP:this._url===a.HOST.CURRENT.BACKUP?this._url=this._canIUseAnyCast()?a.HOST.CURRENT.ANYCAST:a.HOST.CURRENT.DEFAULT:this._url===a.HOST.CURRENT.ANYCAST&&(a.HOST.CURRENT.ANYCAST="",this._url=a.HOST.CURRENT.DEFAULT);var e=this._chM.get(12),t=e.getProxyServer();We(t)||(this._url=t),e.isTestEnv()&&(this._url=F.TEST[this._currentSite].DEFAULT),this._connect(),this._nextPingTs=0}},{key:"_canIUseAnyCast",value:function(){return ne&&a.HOST.CURRENT.ANYCAST}},{key:"onCheckTimer",value:function(e){e%1==0&&(this._checkPromiseMap(),this._checkNativeAppWS())}},{key:"_checkPromiseMap",value:function(){var i=this;0!==this._promiseMap.size&&this._promiseMap.forEach(function(e,t){var n=e.reject,e=e.timestamp,o=15e3;-1!==t.indexOf(v.LOGIN)?o=9e4:-1!==t.indexOf(v.PING)&&(o=3e3),Date.now()-e>=o&&(A.l("".concat(i._n,"._checkPromiseMap request timeout, delete requestID:").concat(t)),i._promiseMap.delete(t),n(new bn({code:C.NETWORK_TIMEOUT})),i._chM.onRequestTimeout())})}},{key:"_checkNativeAppWS",value:function(){$&&!this.isConnected()&&this._reConnect()}},{key:"onOpen",value:function(e){var t,n;this._readyState!==ns&&(this._onOpenTs=Date.now(),n=e.id,e=e.res,this._socketID=n,t=zt(this._startTs,!1),n="socketID:".concat(n," res:").concat(e),A.l("".concat(this._n,"._onOpen cost:").concat(t," ms. ").concat(n)),new M("wsOnOpen").setMessage(t).setCostTime(t).setMoreMessage(n).end(),this._readyState=es,this._reConnectCount=0,this._resend(),!0===this._reConnectFlag&&(this._chM.onReconnected(),this._reConnectFlag=!1),this._chM.onOpen())}},{key:"onClose",value:function(e){var t=new M("wsOnClose"),n=e.id,e=e.e,o="sourceSocketID:".concat(n," currentSocketID:").concat(this._socketID," code:").concat(e.code," reason:").concat(e.reason),i=0;0!==this._onOpenTs&&(i=Date.now()-this._onOpenTs),t.setMessage(i).setCostTime(i).setMoreMessage(o).setCode(e.code).end(!0),A.l("".concat(this._n,"._onClose ").concat(o," onlineTime:").concat(i)),n===this._socketID&&(this._readyState=ns,i<1e3?this._chM.onReconnectFailed():this._chM.onClose())}},{key:"onError",value:function(e){var t=e.id,e=e.e,n="sourceSocketID:".concat(t," currentSocketID:").concat(this._socketID);new M("wsOnError").setMessage(e.errMsg||ft(e)).setMoreMessage(n).setLevel("error").end(!0),A.w("".concat(this._n,"._onError"),e,n),t===this._socketID&&(this._readyState=ns,this._chM.onError())}},{key:"onMessage",value:function(t){var e;try{e=JSON.parse(t.data)}catch(e){new M("jsonParseError").setMessage(t.data).end()}if(e&&e.head){var n,o,i,t=this._getRequestIDFromHead(e.head),a=e.body;if(this._chM.get(30).isTRTCCommand(t)||(i=bt(e.head),a=function t(e,n){return Qe(e)?e.map(function(e){return Xe(e)?t(e,n):e}):Xe(e)?(o=e,i=function(e,t){return k(n[t])?Ka(t):n[t]},a={},Object.keys(o).forEach(function(e){a[i(o[e],e)]=o[e]}),kt(a,function(e){return Qe(e)||Xe(e)?t(e,n):e})):void 0;var o,i,a}(e.body,this._getResponseKeyMap(i))),A.d("".concat(this._n,".onMessage ret:").concat(JSON.stringify(a)," requestID:").concat(t," has:").concat(this._promiseMap.has(t))),this._setNextPingTs(),this._promiseMap.has(t))return n=(i=this._promiseMap.get(t)).resolve,o=i.reject,i=i.timestamp,this._promiseMap.delete(t),this._calcRTT(i),void(a.errorCode&&0!==a.errorCode?(this._chM.onErrorCodeNotZero(a),o(new bn({code:a.errorCode,message:a.errorInfo||"",data:t.includes(v.MODIFY_C2C_MSG)||t.includes(v.MODIFY_GRP_MSG)?{elements:a.elements,messageVersion:a.messageVersion,cloudCustomData:a.cloudCustomData}:void 0}))):n(yn(a)));this._chM.onMessage({head:e.head,body:a})}}},{key:"_calcRTT",value:function(e){e=Date.now()-e;this._chM.get(26).addRTT(e)}},{key:"_connect",value:function(){this._startTs=Date.now(),this._onOpenTs=0,this._socket=new Za(this),this._socketID=this._socket.getID(),this._readyState=ts,A.l("".concat(this._n,"._connect isWorkerEnabled:").concat(this.getIsWorkerEnabled()," socketID:").concat(this._socketID," url:").concat(this.getURL())),new M("wsConnect").setMessage("socketID:".concat(this._socketID," url:").concat(this.getURL())).end()}},{key:"getURL",value:function(){this._chM.isDevMode()&&(this._canIUseBinaryFrame=!1);var e=Nt(),t=((Z||Y&&"windows"===e||$)&&(this._canIUseBinaryFrame=!1),-1),n=("ios"===e?t=ue||-1:"android"===e&&(t=de||-1),this._chM.get(12)),o=this._chM.getPlatform(),i=n.getSDKAppID(),n=n.getInstanceID(),i="sdkappid=".concat(i,"&instanceid=").concat(n,"&random=").concat(this._getRandom(),"&platform=").concat(o,"&host=").concat(e)+"&version=".concat(t,"&sdkversion=").concat("3.3.5");return j&&(i+="&isminigame=1"),this._chM.canIUseInflate()&&(i+="&compress=gzip"),(this._canIUseBinaryFrame?"".concat(this._url,"/binfo?"):"".concat(this._url,"/info?")).concat(i)}},{key:"_closeConnection",value:function(e){A.l("".concat(this._n,"._closeConnection socketID:").concat(this._socketID)),this._socket&&(this._socket.close(e),this._socketID=-1,this._socket=null,this._readyState=ns)}},{key:"_resend",value:function(){var i=this;if(A.l("".concat(this._n,"._resend reConnectFlag:").concat(this._reConnectFlag),"promiseMap.size:".concat(this._promiseMap.size," simpleRequestMap.size:").concat(this._simpleRequestMap.size)),0<this._promiseMap.size&&this._promiseMap.forEach(function(e,t){var n=e.uplinkData,o=e.resolve,e=e.reject;-1!==t.indexOf(v.AV_POLLING)?i._promiseMap.delete(t):(i._promiseMap.set(t,{resolve:o,reject:e,timestamp:Date.now(),uplinkData:n}),i._execute(t,n))}),0<this._simpleRequestMap.size){var e,t=N(this._simpleRequestMap);try{for(t.s();!(e=t.n()).done;){var n=I(e.value,2),o=n[0],a=n[1];this._execute(o,a)}}catch(e){t.e(e)}finally{t.f()}this._simpleRequestMap.clear()}}},{key:"send",value:function(e){var n=this,o=(e.head.seq=this._getSequence(),e.head.reqtime=Math.floor(Date.now()/1e3),e.keyMap,h(e,Qa)),i=this._getRequestIDFromHead(e.head),a=JSON.stringify(o);return new Promise(function(e,t){n._promiseMap.set(i,{resolve:e,reject:t,timestamp:Date.now(),uplinkData:a}),A.d("".concat(n._n,".send uplinkData:").concat(JSON.stringify(o)," requestID:").concat(i," readyState:").concat(n._readyState)),n._readyState!==es?n._reConnect():(n._execute(i,a),n._chM.get(26).addRequestCount())})}},{key:"simplySend",value:function(e){e.head.seq=this._getSequence(),e.head.reqtime=Math.floor(Date.now()/1e3),e.keyMap;var t=h(e,$a),e=this._getRequestIDFromHead(e.head),t=JSON.stringify(t);this._readyState!==es?(this._simpleRequestMap.size<this.MAX_SIZE?this._simpleRequestMap.set(e,t):A.l("".concat(this._n,".simplySend. simpleRequestMap is full, drop request!")),this._reConnect()):this._execute(e,t)}},{key:"_execute",value:function(e,t){this._socket.send({data:t,fail:te?this._onSendFail.bind(this):void 0,requestID:e})}},{key:"_onSendFail",value:function(e){A.l("".concat(this._n,"._onSendFail requestID:").concat(e)),this._chM.onSendFail()}},{key:"_getSequence",value:function(){var e;if(this._startSequence<2415919103)return e=this._startSequence,this._startSequence+=1,2415919103===this._startSequence&&(this._startSequence=st()),e}},{key:"_getRequestIDFromHead",value:function(e){return e.servcmd+e.seq}},{key:"_getResponseKeyMap",value:function(e){e=this._chM.getKeyMap(e);return y(y({},Fa.response),e.response)}},{key:"_reConnect",value:function(){this._readyState!==es&&this._readyState!==ts&&this.forcedReconnect()}},{key:"forcedReconnect",value:function(){var e="".concat(this._n,".forcedReconnect");A.l("".concat(e," count:").concat(this._reConnectCount," readyState:").concat(this._readyState)),this._reConnectFlag=!0,this._resetRandom(),this._reConnectCount<this.MAX_RECONNECT_COUNT?(this._reConnectCount+=1,this._closeConnection(4001),this._initConnection()):(this._reConnectCount=0,this._chM.get(15).isOnline()?(A.w("".concat(e," disconnected from wsserver but network is ok, continue...")),this._closeConnection(4001),this._initConnection()):this._chM.onReconnectFailed())}},{key:"getReconnectFlag",value:function(){return this._reConnectFlag}},{key:"_setNextPingTs",value:function(){this._nextPingTs=$?Date.now()+5e3:Date.now()+1e4}},{key:"getNextPingTs",value:function(){return this._nextPingTs}},{key:"isConnected",value:function(){return this._readyState===es}},{key:"canIUseBinaryFrame",value:function(){return this._canIUseBinaryFrame}},{key:"inflate",value:function(e){if(this._chM.canIUseInflate())return this._chM.get(37).inflate(e)}},{key:"setIsWorkerEnabled",value:function(e){A.l("".concat(this._n,".setIsWorkerEnabled flag:").concat(e)),this._isWorkerEnabled=e}},{key:"getIsWorkerEnabled",value:function(){return this._isWorkerEnabled&&ve}},{key:"_getRandom",value:function(){return 0===this._random&&(this._random=Math.random()),this._random}},{key:"_resetRandom",value:function(){this._random=0}},{key:"close",value:function(){A.l("".concat(this._n,".close")),this._closeConnection(4e3),this._promiseMap.clear(),this._startSequence=st(),this._readyState=ns,this._simpleRequestMap.clear(),this._reConnectFlag=!1,this._reConnectCount=0,this._onOpenTs=0,this._url="",this._random=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0}}]),Ms),is=function(a,s,r){return new Promise(function(t,e){var n,o,i="application/x-www-form-urlencoded;charset=UTF-8";te?oe.request({url:s,data:r,method:a,timeout:3e3,header:{"content-type":i},success:function(e){e&&e.data&&e.data.NetCheckInfo&&A.l("".concat("getconninfo ok in"," miniapp. ret:"),e.data),t()},fail:function(){e(new bn({code:C.NETWORK_ERROR}))}}):(n=new XMLHttpRequest,o=setTimeout(function(){n.abort(),e(new bn({code:C.NETWORK_TIMEOUT}))},3e3),n.onreadystatechange=function(){4===n.readyState&&(clearTimeout(o),200===n.status||304===n.status?(n.responseText&&-1<n.responseText.indexOf("NetCheckInfo")&&A.l("".concat("getconninfo ok in"," web. ret:"),JSON.parse(n.responseText)),t()):e(new bn({code:C.NETWORK_ERROR})))},n.open(a,s,!0),n.setRequestHeader("Content-type",i),r?n.send(r):n.send())})},as=(t(vs,Nn),ja=f(vs),e(vs,[{key:"onCheckTimer",value:function(e){this._socketHandler&&(this.isLoggedIn()?(0<this._timerForNotLoggedIn&&(clearInterval(this._timerForNotLoggedIn),this._timerForNotLoggedIn=-1),this._socketHandler.onCheckTimer(e)):this._socketHandler.onCheckTimer(1),this._checkNextPing())}},{key:"onErrorCodeNotZero",value:function(e){this.get(20).onErrorCodeNotZero(e)}},{key:"onMessage",value:function(e){this.get(20).onMessage(e)}},{key:"send",value:function(e){return this._socketHandler?this._previousState!==S.NET_STATE_CONNECTED&&e.head.servcmd.includes(v.SSO_STAT)?(this.reConnect(),this.isPrivateNetWork()?Promise.resolve():this._sendLogViaHTTP(e)):this._socketHandler.send(e):Promise.reject()}},{key:"_sendLogViaHTTP",value:function(e){var t=a.HOST.CURRENT.STAT,t="".concat(t,"/v4/imopenstat/tim_web_report_v2?sdkappid=").concat(e.head.sdkappid,"&reqtime=").concat(Date.now()),e=JSON.stringify(e.body);return is("POST",t,e)}},{key:"simplySend",value:function(e){return this._socketHandler?this._socketHandler.simplySend(e):Promise.reject()}},{key:"onOpen",value:function(){this._ping()}},{key:"onClose",value:function(){this._socketHandler&&this._socketHandler.getReconnectFlag()&&this._emitNetStateChangeEvent(S.NET_STATE_DISCONNECTED),this.reConnect()}},{key:"onError",value:function(){te&&!$&&this.outputWarning("DomainNameInMP"),this._emitNetStateChangeEvent(S.NET_STATE_DISCONNECTED)}},{key:"getKeyMap",value:function(e){return this.get(20).getKeyMap(e)}},{key:"_onAppHide",value:function(){this._isAppShowing=!1}},{key:"_onAppShow",value:function(){this._isAppShowing=!0}},{key:"onRequestTimeout",value:function(){3e4<=Date.now()-this._lastDiagnoseTS&&this.diagnose()}},{key:"onSendFail",value:function(){this._emitNetStateChangeEvent(S.NET_STATE_DISCONNECTED)}},{key:"onReconnected",value:function(){A.l("".concat(this._n,".onReconnected cost:").concat(zt(this._disconnectedTS,!0,!0))),this._m.restartTimer(),this.get(20).onReconnected(zt(this._disconnectedTS,!1,!1)),this._disconnectedTS=0,this._emitNetStateChangeEvent(S.NET_STATE_CONNECTED)}},{key:"onReconnectFailed",value:function(){A.l("".concat(this._n,".onReconnectFailed")),this._emitNetStateChangeEvent(S.NET_STATE_DISCONNECTED)}},{key:"setIsWorkerEnabled",value:function(e){this._socketHandler&&this._socketHandler.setIsWorkerEnabled(!1)}},{key:"offline",value:function(){this._emitNetStateChangeEvent(S.NET_STATE_DISCONNECTED)}},{key:"reConnect",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=!1,n=(this._socketHandler&&(t=this._socketHandler.getReconnectFlag()),"forcedFlag:".concat(e," fatalErrorFlag:").concat(this._fatalErrorFlag," previousState:").concat(this._previousState," reconnectFlag:").concat(t));if(A.l("".concat(this._n,".reConnect ").concat(n)),!this._fatalErrorFlag&&this._socketHandler){if(!0===e)this._socketHandler.forcedReconnect();else{if(this._previousState===S.NET_STATE_CONNECTING&&t)return;this._socketHandler.forcedReconnect()}this._emitNetStateChangeEvent(S.NET_STATE_CONNECTING)}}},{key:"_emitNetStateChangeEvent",value:function(e){this._previousState!==e&&(A.l("".concat(this._n,"._emitNetStateChangeEvent from ").concat(this._previousState," to ").concat(e)),e===S.NET_STATE_DISCONNECTED&&0===this._disconnectedTS&&(this._disconnectedTS=Date.now(),this.diagnose()),this._previousState=e,this.emitOuterEvent(G.NET_STATE_CHANGE,{state:e}))}},{key:"_ping",value:function(){var e,n=this;!0!==this._probing&&(this._probing=!0,e=this.get(20).getProtocolData({proto:v.PING}),this.send(e).then(function(){n._probing=!1}).catch(function(e){n._probing=!1;var t=n.get(15).isOnline();if(A.w("".concat(n._n,"._ping failed. bOnline:").concat(t," error:"),e),e&&60002===e.code)return new M("error").setMessage("code:".concat(e.code," message:").concat(e.message)).end(),n._fatalErrorFlag=!0,void n._emitNetStateChangeEvent(S.NET_STATE_DISCONNECTED);t?n.reConnect():n._emitNetStateChangeEvent(S.NET_STATE_DISCONNECTED)}))}},{key:"_checkNextPing",value:function(){this._socketHandler&&this._socketHandler.isConnected()&&Date.now()>=this._socketHandler.getNextPingTs()&&this._ping()}},{key:"dealloc",value:function(){this._socketHandler&&(this._socketHandler.close(),this._socketHandler=null),-1<this._timerForNotLoggedIn&&clearInterval(this._timerForNotLoggedIn)}},{key:"onRestApiKickedOut",value:function(){this._socketHandler&&(this._socketHandler.close(),this.reConnect(!0))}},{key:"canIUseInflate",value:function(){return this._m.canIUseInflate()}},{key:"diagnose",value:function(){this.isPrivateNetWork()||(this._lastDiagnoseTS=Date.now(),this._diagnoseBySSO(),this._diagnoseByCDN())}},{key:"_diagnoseBySSO",value:function(){var t=this,e=this._socketHandler.getURL(),n=e.split("/")[2];n.startsWith("ws")&&(e=e.slice(e.indexOf("info?")+5),n="https://".concat(n,"/v3/netcheck/getconninfo?").concat(e,"&reqtime=").concat(Date.now()),is("GET",n).catch(function(e){A.w("".concat(t._n,"._diagnoseBySSO failed. error:"),e)}))}},{key:"_diagnoseByCDN",value:function(){var t=this,e=this._socketHandler.getURL(),e=e.slice(e.indexOf("info?")+5),e="https://boce-cdn.my-imcloud.com/v3/netcheck/getconninfo?".concat(e,"&reqtime=").concat(Date.now());is("GET",e).catch(function(e){A.w("".concat(t._n,"._diagnoseByCDN failed. error:"),e)})}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._previousState=S.NET_STATE_CONNECTED,this._probing=!1,this._fatalErrorFlag=!1,this._timerForNotLoggedIn=setInterval(this.onCheckTimer.bind(this),1e3),this._disconnectedTS=0,this._lastDiagnoseTS=0}}]),vs),ss=["a2","tinyid"],rs=["a2","tinyid"],cs=(e(ms,[{key:"_fillConfigMap",value:function(){this._configMap.clear();var e=this._sessionM.genCommonHead(),t=this._sessionM.genCosSpecifiedHead(),n=this._sessionM.genSSOReportHead();this._configMap.set(v.LOGIN,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.LOGIN)}),body:{state:"Online",isWebUniapp:0,deviceBrand:0},keyMap:{request:{deviceBrand:"InstType"},response:{InstId:"instanceID",HelloInterval:"helloInterval"}}}),this._configMap.set(v.LOGOUT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.LOGOUT)}),body:{type:0},keyMap:{request:{type:"wslogout_type"}}}),this._configMap.set(v.HELLO,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.HELLO)}),body:{isWebUniapp:0},keyMap:{response:{NewInstInfo:"newInstanceInfo"}}}),this._configMap.set(v.KICK_OTHER,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.STAT_SERVICE,".").concat(v.KICK_OTHER)}),body:{}}),this._configMap.set(v.COS_SIGN,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.IM_COS_SIGN,".").concat(v.COS_SIGN)}),body:{cmd:"open_im_cos_svc",subCmd:"get_cos_token",duration:300,version:2},keyMap:{request:{userSig:"usersig",subCmd:"sub_cmd",cmd:"cmd",duration:"duration",version:"version"},response:{expired_time:"expiredTime",bucket_name:"bucketName",session_token:"sessionToken",tmp_secret_id:"secretId",tmp_secret_key:"secretKey"}}}),this._configMap.set(v.COS_PRE_SIG,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(v.COS_PRE_SIG)}),body:{fileType:void 0,fileName:void 0,uploadMethod:0,duration:900},keyMap:{request:{userSig:"usersig",fileType:"file_type",fileName:"file_name",uploadMethod:"upload_method"},response:{expired_time:"expiredTime",request_id:"requestId",head_url:"headUrl",upload_url:"uploadUrl",download_url:"downloadUrl",ci_url:"ciUrl",snapshot_url:"requestSnapshotUrl"}}}),this._configMap.set(v.SIMPLE_COS_PRE_SIG,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(v.SIMPLE_COS_PRE_SIG)}),body:{uploadMethod:0,platform:2,SDKAppID:0,userID:"",conversationType:1,uploadConfig:[{fileID:1,fileType:1,fileName:""}]},keyMap:{request:{platform:"uint32_platform",SDKAppID:"uint32_sdkappid",userID:"str_user_id",uploadMethod:"uint32_upload_method",conversationType:"uint32_scene",uploadConfig:"rpt_upload_object",fileID:"uint32_file_id",fileType:"uint32_file_type",fileName:"str_file_name"},response:{str_final_ip:"uploadIP",rpt_pre_sig:"preSig",uint32_file_id:"fileID",uint32_exist_flag:"existFlag",str_download_url:"downloadUrl",str_upload_url:"uploadUrl",str_snapshot_url:"requestSnapshotUrl",str_file_key:"fileKey"}}}),this._configMap.set(v.GET_IMAGE_INFO,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(v.GET_IMAGE_INFO)}),body:{imageUrl:""},keyMap:{request:{imageUrl:"str_image_url"},response:{rpt_msg_image_info:"imageInfoArray",uint32_image_type:"type",str_url:"url",uint32_width:"width",uint32_height:"height",str_image_format:"imageFormat"}}}),this._configMap.set(v.GET_IP,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(v.GET_IP)}),body:{domainName:""},keyMap:{request:{domainName:"str_domain"},response:{str_final_ip:"ip"}}}),this._configMap.set(v.VIDEO_COVER,{head:y(y({},t),{},{servcmd:"".concat(a.NAME.CUSTOM_UPLOAD,".").concat(v.VIDEO_COVER)}),body:{version:1,platform:void 0,coverName:void 0,requestSnapshotUrl:void 0},keyMap:{request:{version:"version",platform:"platform",coverName:"cover_name",requestSnapshotUrl:"snapshot_url"},response:{error_code:"errorCode",error_msg:"errorInfo",download_url:"snapshotUrl"}}}),this._configMap.set(v.FETCH_COMMERCIAL_CONFIG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_CONFIG_MANAGER,".").concat(v.FETCH_COMMERCIAL_CONFIG)}),body:{SDKAppID:0},keyMap:{request:{SDKAppID:"uint32_sdkappid"},response:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._configMap.set(v.PUSHED_COMMERCIAL_CONFIG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_CONFIG_MANAGER,".").concat(v.PUSHED_COMMERCIAL_CONFIG)}),body:{},keyMap:{response:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._configMap.set(v.FETCH_CLOUD_CTRL_CONFIG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_CONFIG_MANAGER,".").concat(v.FETCH_CLOUD_CTRL_CONFIG)}),body:{SDKAppID:0,version:0},keyMap:{request:{SDKAppID:"uint32_sdkappid",version:"uint64_version"},response:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._configMap.set(v.PUSHED_CLOUD_CTRL_CONFIG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_CONFIG_MANAGER,".").concat(v.PUSHED_CLOUD_CTRL_CONFIG)}),body:{},keyMap:{response:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._configMap.set(v.OVERLOAD_NOTIFY,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OVERLOAD_PUSH,".").concat(v.OVERLOAD_NOTIFY)}),body:{},keyMap:{response:{OverLoadServCmd:"overloadCommand",DelaySecs:"waitingTime"}}}),this._configMap.set(v.SYNC_UNREAD_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.SYNC_UNREAD_MSG)}),body:{cookie:"",syncFlag:0,needAbstract:1,isOnlineSync:0,needSignaling:1},keyMap:{request:{fromAccount:"From_Account",toAccount:"To_Account",from:"From_Account",to:"To_Account",time:"MsgTimeStamp",sequence:"MsgSeq",random:"MsgRandom",elements:"MsgBody"},response:{MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",ClientSeq:"clientSequence",MsgSeq:"sequence",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgRandom:"random",MsgTimeStamp:"time",MsgContent:"content",ToGroupId:"to",MsgKey:"messageKey",GroupTips:"groupTips",MsgBody:"elements",MsgType:"type",C2CRemainingUnreadCount:"C2CRemainingUnreadList",C2CPairUnreadCount:"C2CPairUnreadList"}}}),this._configMap.set(v.GET_PROFANITY_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_MSG_AUDIT_MGR,".").concat(v.GET_PROFANITY_LIST)}),body:{version:0,deviceID:"",startIndex:void 0},keyMap:{request:{version:"uint64_version",deviceID:"str_device_id",startIndex:"uint64_start_index"},response:{msg_cmd_error_code:"errorInfo",str_err_msg:"errorMessage",uint32_code:"errorCode",msg_scene_ctl_config:"filterConfig",uint64_c2c_custom_msg_flag:"c2c_custom_message",uint64_c2c_text_msg_flag:"c2c_text_message",uint64_group_custom_msg_flag:"group_custom_message",uint64_group_text_msg_flag:"group_text_message",uint64_group_info_flag:"group_profile",uint64_group_member_info_flag:"group_member_profile",uint64_relation_chain_flag:"sns",uint64_user_info_flag:"user_profile",rpt_msg_dirty_word:"lexicon",str_dirty_word:"profanity",str_replaced_content:"replacement",uint64_filter_type:"filterType",uint64_id:"id",uint64_word_type:"profanityType",uint64_complete_flag:"completeFlag",uint64_next_start_index:"nextStartIndex",uint64_version:"version",uint64_expired_time:"expiredTime"}}}),this._configMap.set(v.SEND_C2C_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.SEND_C2C_MSG)}),body:{fromAccount:"",toAccount:"",msgSeq:0,msgRandom:0,msgBody:[],cloudCustomData:void 0,nick:"",avatar:"",msgLifeTime:void 0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:""}},messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0},keyMap:{request:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",count:"MaxCnt",lastMessageTime:"LastMsgTime",messageKey:"MsgKey",peerAccount:"Peer_Account",data:"Data",description:"Desc",extension:"Ext",type:"MsgType",content:"MsgContent",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",nick:"From_AccountNick",avatar:"From_AccountHeadurl",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"IsNeedReadReceipt",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID"}}}),this._configMap.set(v.SEND_GRP_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.SEND_GRP_MSG)}),body:{fromAccount:"",groupID:"",random:0,clientSequence:0,priority:"",msgBody:[],cloudCustomData:void 0,onlineOnlyFlag:0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:""}},groupAtInfo:[],messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,topicID:void 0,receiverList:void 0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0},keyMap:{request:{to:"GroupId",extension:"Ext",data:"Data",description:"Desc",random:"Random",sequence:"ReqMsgSeq",count:"ReqMsgNumber",type:"MsgType",priority:"MsgPriority",content:"MsgContent",elements:"MsgBody",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",clientSequence:"ClientSeq",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"NeedReadReceipt",receiverList:"To_Account",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID"},response:{MsgTime:"time",MsgSeq:"sequence"}}}),this._configMap.set(v.REVOKE_C2C_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.REVOKE_C2C_MSG)}),body:{msgInfo:{fromAccount:"",toAccount:"",msgTimeStamp:0,msgSeq:0,msgRandom:0}},keyMap:{request:{msgInfo:"MsgInfo",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom"}}}),this._configMap.set(v.REVOKE_GRP_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.REVOKE_GRP_MSG)}),body:{groupID:"",msgSeqList:void 0,topicID:""},keyMap:{request:{msgSeqList:"MsgSeqList",msgSeq:"MsgSeq"}}}),this._configMap.set(v.GET_C2C_ROAMING_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.GET_C2C_ROAMING_MSG)}),body:{peerAccount:"",count:15,lastMessageTime:0,messageKey:"",withRecalledMessage:1,direction:0},keyMap:{request:{messageKey:"MsgKey",peerAccount:"Peer_Account",count:"MaxCnt",lastMessageTime:"LastMsgTime",withRecalledMessage:"WithRecalledMsg",direction:"GetDirection"},response:{LastMsgTime:"lastMessageTime",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer"}}}),this._configMap.set(v.MODIFY_C2C_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.MODIFY_C2C_MSG)}),body:{from:"",to:"",sequence:0,random:0,time:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{request:{sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._configMap.set(v.GET_GRP_ROAMING_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_GRP_ROAMING_MSG)}),body:{withRecalledMsg:1,groupID:"",count:15,sequence:"",topicID:void 0},keyMap:{request:{sequence:"ReqMsgSeq",count:"ReqMsgNumber",withRecalledMessage:"WithRecalledMsg"},response:{Random:"random",MsgTime:"time",MsgSeq:"sequence",ReqMsgSeq:"sequence",RspMsgList:"messageList",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgPriority:"priority",MsgBody:"elements",MsgType:"type",MsgContent:"content",IsFinished:"complete",Download_Flag:"downloadFlag",ClientSeq:"clientSequence",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",NextReqMsgSeq:"nextSequence"}}}),this._configMap.set(v.SET_C2C_MSG_READ,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.SET_C2C_MSG_READ)}),body:{C2CMsgReaded:void 0},keyMap:{request:{lastMessageTime:"LastedMsgTime"}}}),this._configMap.set(v.SET_C2C_PEER_MUTE_NOTIFICATIONS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.SET_C2C_PEER_MUTE_NOTIFICATIONS)}),body:{userIDList:void 0,muteFlag:0},keyMap:{request:{userIDList:"Peer_Account",muteFlag:"Mute_Notifications"}}}),this._configMap.set(v.GET_C2C_PEER_MUTE_NOTIFICATIONS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.GET_C2C_PEER_MUTE_NOTIFICATIONS)}),body:{toAccount:void 0,userIDList:void 0},keyMap:{request:{userIDList:"Peer_Account"},response:{MuteNotificationsList:"muteFlagList"}}}),this._configMap.set(v.SET_GRP_MSG_READ,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.SET_GRP_MSG_READ)}),body:{groupID:void 0,messageReadSeq:void 0,topicID:void 0},keyMap:{request:{messageReadSeq:"MsgReadedSeq"}}}),this._configMap.set(v.SET_ALL_MSG_READ,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.SET_ALL_MSG_READ)}),body:{readAllC2CMessage:0,groupMessageReadInfoList:[]},keyMap:{request:{readAllC2CMessage:"C2CReadAllMsg",groupMessageReadInfoList:"GroupReadInfo",messageSequence:"MsgSeq"},response:{C2CReadAllMsg:"readAllC2CMessage",GroupReadInfoArray:"groupMessageReadInfoList"}}}),this._configMap.set(v.DEL_C2C_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.DEL_C2C_MSG)}),body:{fromAccount:"",to:"",keyList:void 0},keyMap:{request:{keyList:"MsgKeyList"}}}),this._configMap.set(v.DEL_GRP_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.DEL_GRP_MSG)}),body:{groupID:"",deleter:"",keyList:void 0,topicID:void 0},keyMap:{request:{deleter:"Deleter_Account",keyList:"Seqs"}}}),this._configMap.set(v.TRANSLATE_TEXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_TRANSLATE,".").concat(v.TRANSLATE_TEXT)}),body:{sourceTextList:void 0,SDKAppID:0,from:0,source:"",target:""},keyMap:{request:{sourceTextList:"SourceText",SDKAppID:"SdkAppId",from:"FromAccount"},response:{TargetText:"translatedTextList",RequestId:"requestID",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._configMap.set(v.VOICE_TO_TEXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_SPEECH,".").concat(v.VOICE_TO_TEXT)}),body:{url:"",SDKAppID:0,format:"",sourceType:0,language:""},keyMap:{request:{url:"BytesUrl",SDKAppID:"Uint32Sdkappid",format:"BytesVoiceFormat",sourceType:"Uint64SourceType",language:"BytesEngServiceType"},response:{BytesRequestid:"requestID",BytesResult:"result",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._configMap.set(v.MODIFY_GRP_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.MODIFY_GRP_MSG)}),body:{groupID:"",topicID:void 0,sequence:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{request:{sequence:"MsgSeq",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._configMap.set(v.GET_READ_RECEIPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_READ_RECEIPT)}),body:{groupID:"",sequenceList:void 0},keyMap:{request:{sequence:"MsgSeq"}}}),this._configMap.set(v.SEND_C2C_READ_RECEIPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.SEND_C2C_READ_RECEIPT)}),body:{peerAccount:"",messageInfoList:void 0},keyMap:{request:{peerAccount:"Peer_Account",messageInfoList:"C2CMsgInfo",fromAccount:"From_Account",toAccount:"To_Account",sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",clientTime:"MsgClientTime"}}}),this._configMap.set(v.SEND_READ_RECEIPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.SEND_READ_RECEIPT)}),body:{groupID:"",sequenceList:void 0},keyMap:{request:{sequenceList:"MsgSeqList",sequence:"MsgSeq"}}}),this._configMap.set(v.GET_READ_RECEIPT_DETAIL,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_READ_RECEIPT_DETAIL)}),body:{groupID:"",sequence:void 0,flag:0,cursor:0,count:0},keyMap:{request:{sequence:"MsgSeq",count:"Num"},response:{ReadList:"readUserIDList",Read_Account:"userID",UnreadList:"unreadUserIDList",Unread_Account:"userID",IsFinish:"isCompleted"}}}),this._configMap.set(v.MODIFY_C2C_MSG_EXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.MODIFY_C2C_MSG_EXT)}),body:{from:void 0,to:void 0,messageKey:void 0,operateType:void 0,extensionList:void 0}}),this._configMap.set(v.GET_C2C_MSG_EXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.GET_C2C_MSG_EXT)}),body:{from:void 0,to:void 0,messageKey:void 0,startSequence:void 0}}),this._configMap.set(v.MODIFY_GRP_MSG_EXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.MODIFY_GRP_MSG_EXT)}),body:{groupID:void 0,topicID:void 0,messageSequence:void 0,operateType:void 0,extensionList:void 0}}),this._configMap.set(v.GET_GRP_MSG_EXT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.GET_GRP_MSG_EXT)}),body:{groupID:void 0,topicID:void 0,messageSequence:void 0,startSequence:void 0}}),this._configMap.set(v.MSG_CLOUD_SEARCH,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.MSG_SEARCH,".").concat(v.MSG_CLOUD_SEARCH)}),body:{keywordList:void 0,keywordListMatchType:"or",account:void 0,groupID:void 0,count:100,cursor:void 0,messageTypeList:void 0,senderUserIDList:void 0,startTime:void 0,endTime:void 0},keyMap:{request:{keywordListMatchType:"MatchType",account:"PeerAccount",groupID:"GroupID",messageTypeList:"MsgTypeList",senderUserIDList:"SendUserIDList"},response:{GroupID:"groupID",UserID:"userID",Count:"messageCount",LastMsgTime:"lastMessageTime",ConversationMsgs:"searchResult",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer",MsgSeq:"sequence",ReqMsgSeq:"sequence",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgContent:"content",ClientSeq:"clientSequence",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",ErrorCode:"code",ErrorInfo:"message"}}}),this._configMap.set(v.ADD_C2C_MSG_REACTION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.ADD_C2C_MSG_REACTION)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{request:{userIDList:"Add_Account"}}}),this._configMap.set(v.RM_C2C_MSG_REACTION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.RM_C2C_MSG_REACTION)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{request:{userIDList:"Del_Account"}}}),this._configMap.set(v.GET_C2C_MSG_REACTIONS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.GET_C2C_MSG_REACTIONS)}),body:{from:void 0,to:void 0,messageKeyList:void 0,count:void 0}}),this._configMap.set(v.GET_C2C_MSG_REACTION_USER_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.GET_C2C_MSG_REACTION_USER_LIST)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,count:void 0}}),this._configMap.set(v.ADD_GRP_MSG_REACTION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.ADD_GRP_MSG_REACTION)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{request:{userIDList:"Add_Account"}}}),this._configMap.set(v.RM_GRP_MSG_REACTION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.RM_GRP_MSG_REACTION)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{request:{userIDList:"Del_Account"}}}),this._configMap.set(v.GET_GRP_MSG_REACTIONS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.GET_GRP_MSG_REACTIONS)}),body:{groupID:void 0,topicID:void 0,messageSequenceList:void 0,count:void 0},keyMap:{response:{MsgSeq:"messageSequence"}}}),this._configMap.set(v.GET_GRP_MSG_REACTION_USER_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM_MSG_EXT,".").concat(v.GET_GRP_MSG_REACTION_USER_LIST)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,nextSeq:void 0,count:void 0}}),this._configMap.set(v.GET_C2C_PEER_READ_TIME,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.GET_C2C_PEER_READ_TIME)}),body:{userIDList:void 0},keyMap:{request:{userIDList:"To_Account"},response:{ReadTime:"peerReadTimeList"}}}),this._configMap.set(v.PAGING_GET_CONV_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.PAGING_GET_CONV_LIST)}),body:{fromAccount:void 0,timeStamp:void 0,startIndex:void 0,pinnedTimeStamp:void 0,pinnedStartIndex:void 0,orderType:void 0,messageAssistFlag:15,assistFlag:31},keyMap:{request:{messageAssistFlag:"MsgAssistFlags",assistFlag:"AssistFlags",pinnedTimeStamp:"TopTimeStamp",pinnedStartIndex:"TopStartIndex"},response:{SessionItem:"conversations",ToAccount:"groupID",To_Account:"userID",UnreadMsgCount:"unreadCount",MsgGroupReadedSeq:"messageReadSeq",C2cPeerReadTime:"c2cPeerReadTime",LastMsgFlags:"lastMessageFlag",TopFlags:"isPinned",TopTimeStamp:"pinnedTimeStamp",TopStartIndex:"pinnedStartIndex",GroupId:"convGroupID",C2cRemark:"friendRemark",MsgRecvOption:"messageRemindType",GroupIgnoredUnreadSeqCount:"noUnreadCount",GroupNextMsgSeq:"nextMessageSeq"}}}),this._configMap.set(v.DEL_CONV,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.DEL_CONV)}),body:{fromAccount:"",conversationList:void 0,clearHistoryMessage:void 0},keyMap:{request:{toGroupID:"ToGroupid",clearHistoryMessage:"ClearRamble",conversationList:"ContactItem"},response:{ResultItem:"resultList",ToGroupid:"groupID",ResultCode:"code",ResultInfo:"info"}}}),this._configMap.set(v.CLEAR_HISTORY_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.CLEAR_HISTORY_MSG)}),body:{fromAccount:"",toAccount:void 0,type:1,toGroupID:void 0},keyMap:{request:{toGroupID:"ToGroupid"}}}),this._configMap.set(v.PIN_CONV,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.PIN_CONV)}),body:{fromAccount:"",operationType:1,itemList:void 0},keyMap:{request:{itemList:"RecentContactItem"}}}),this._configMap.set(v.DEL_GROUP_AT_TIPS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.DEL_GROUP_AT_TIPS)}),body:{messageListToDelete:void 0},keyMap:{request:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._configMap.set(v.SET_CONV_CUSTOM_DATA,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.MARK_CONV)}),body:{fromAccount:"",itemList:void 0},keyMap:{request:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},response:{ToGroupId:"groupID",OptType:"operationType"}}}),this._configMap.set(v.MARK_CONV,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.MARK_CONV)}),body:{fromAccount:"",itemList:void 0},keyMap:{request:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},response:{ToGroupId:"groupID",OptType:"operationType"}}}),this._configMap.set(v.CREATE_CONV_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.CREATE_CONV_GRP)}),body:{fromAccount:"",itemList:void 0},keyMap:{request:{itemList:"GroupContactItem",groupID:"ToGroupId"},response:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType"}}}),this._configMap.set(v.DEL_CONV_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.DEL_CONV_GRP)}),body:{fromAccount:"",groupName:void 0},keyMap:{request:{},response:{GroupId:"convGroupID"}}}),this._configMap.set(v.RENAME_CONV_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:void 0},keyMap:{request:{oldName:"OldGroupName",newName:"NewGroupName",groupID:"ToGroupId",operationType:"ContactOptType",groupName:"OldGroupName",updateItem:"ContactUpdateItem"},response:{ContactOptType:"operationType",ToGroupId:"groupID",GroupId:"convGroupID"}}}),this._configMap.set(v.ADD_CONV_TO_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:{groupName:void 0,updateGroupType:void 0,updateItem:void 0}},keyMap:{request:{},response:{}}}),this._configMap.set(v.DEL_CONV_FROM_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:void 0},keyMap:{request:{},response:{}}}),this._configMap.set(v.GET_CONV_GRP_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.GET_CONV_GRP_LIST)}),body:{fromAccount:"",startIndex:void 0},keyMap:{request:{},response:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList"}}}),this._configMap.set(v.SEARCH_CONV_GRP_MARK,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.RECENT_CONTACT,".").concat(v.SEARCH_CONV_GRP_MARK)}),body:{fromAccount:"",contactItem:void 0},keyMap:{request:{groupID:"ToGroupId"},response:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList",ContactResultItem:"contactItem"}}}),this._configMap.set(v.GET_USER_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.PROFILE,".").concat(v.GET_USER_PROFILE)}),body:{fromAccount:"",userItem:[]},keyMap:{request:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._configMap.set(v.UPDATE_MY_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.PROFILE,".").concat(v.UPDATE_MY_PROFILE)}),body:{fromAccount:"",profileItem:[{tag:be.NICK,value:""},{tag:be.GENDER,value:""},{tag:be.ALLOWTYPE,value:""},{tag:be.AVATAR,value:""}]},keyMap:{request:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._configMap.set(v.GET_BL,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.GET_BL)}),body:{fromAccount:"",startIndex:0,maxLimited:30,lastSequence:0},keyMap:{response:{CurruentSequence:"currentSequence"}}}),this._configMap.set(v.ADD_TO_BL,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.ADD_TO_BL)}),body:{fromAccount:"",toAccount:[]}}),this._configMap.set(v.RM_FROM_BL,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.RM_FROM_BL)}),body:{fromAccount:"",toAccount:[]}}),this._configMap.set(v.SET_SELF_STATUS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.SET_SELF_STATUS)}),body:{customStatus:""},keyMap:{}}),this._configMap.set(v.GET_USER_STATUS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.GET_USER_STATUS)}),body:{userIDList:void 0},keyMap:{response:{UserStatusList:"successUserList",ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID",Status:"statusType"}}}),this._configMap.set(v.SUB_USER_STATUS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.SUB_USER_STATUS)}),body:{userIDList:void 0},keyMap:{response:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._configMap.set(v.UNSUB_USER_STATUS,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.UNSUB_USER_STATUS)}),body:{userIDList:void 0,unsubscribeAll:void 0},keyMap:{response:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._configMap.set(v.GET_FD_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.GET_FD_LIST)}),body:{fromAccount:"",startIndex:0,standardSequence:0,customSequence:0},keyMap:{response:{FriendNum:"friendCount",UserDataItem:"resultList",ValueItem:"tagValueList"}}}),this._configMap.set(v.ADD_FD,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.ADD_FD)}),body:{fromAccount:"",addFriendItem:[],type:""},keyMap:{request:{source:"AddSource",wording:"AddWording",type:"AddType"},response:{ResultItem:"resultList"}}}),this._configMap.set(v.UPDATE_FD,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.UPDATE_FD)}),body:{fromAccount:"",updateItem:void 0},keyMap:{request:{snsItem:"SnsItem"},response:{ResultItem:"resultList"}}}),this._configMap.set(v.DEL_FD,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.DEL_FD)}),body:{fromAccount:"",userIDList:[],type:""},keyMap:{request:{type:"DeleteType"},response:{ResultItem:"resultList"}}}),this._configMap.set(v.GET_FD_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.GET_FD_PROFILE)}),body:{fromAccount:"",userIDList:void 0},keyMap:{response:{InfoItem:"resultList",SnsProfileItem:"tagValueList"}}}),this._configMap.set(v.CHECK_FD,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.CHECK_FD)}),body:{fromAccount:"",userIDList:[],type:""},keyMap:{request:{type:"CheckType"},response:{InfoItem:"resultList"}}}),this._configMap.set(v.GET_FD_APPLICATION_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.GET_FD_APPLICATION_LIST)}),body:{fromAccount:"",applicationType:"",startTime:0,maxLimited:0,lastSequence:0},keyMap:{response:{PendencyItem:"resultList",AddSource:"source",AddTime:"time",AddWording:"wording",Image:"avatar",UnreadPendencyCount:"unreadCount",To_Account:"userID",PendencyType:"type"}}}),this._configMap.set(v.RESPOND_FD_APPLICATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.RESPOND_FD_APPLICATION)}),body:{fromAccount:"",responseFriendItem:[]},keyMap:{request:{tag:"TagName",action:"ResponseAction"},response:{ResultItem:"resultList"}}}),this._configMap.set(v.DEL_FD_APPLICATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.DEL_FD_APPLICATION)}),body:{fromAccount:"",type:"",userIDList:void 0},keyMap:{request:{type:"PendencyType",userIDList:"To_Account"},response:{ResultItem:"resultList"}}}),this._configMap.set(v.REPORT_FD_APPLICATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.REPORT_FD_APPLICATION)}),body:{fromAccount:"",latestTimeStamp:""},keyMap:{request:{latestTimeStamp:"LatestPendencyTimeStamp"}}}),this._configMap.set(v.CREATE_FD_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.CREATE_FD_GRP)}),body:{fromAccount:"",groupName:void 0,userIDList:void 0},keyMap:{request:{groupName:"GroupName",userIDList:"To_Account"},response:{ResultItem:"resultList"}}}),this._configMap.set(v.DEL_FD_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.DEL_FD_GRP)}),body:{fromAccount:"",nameList:void 0},keyMap:{request:{nameList:"GroupName"}}}),this._configMap.set(v.GET_FD_GRP_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.GET_FD_GRP_LIST)}),body:{fromAccount:"",lastSequence:0,needFriend:"Need_Friend_Type_Yes"},keyMap:{response:{ResultItem:"resultList",GroupName:"name",FriendNumber:"friendCount",To_Account:"userIDList"}}}),this._configMap.set(v.UPDATE_FD_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FD,".").concat(v.UPDATE_FD_GRP)}),body:{fromAccount:"",oldName:"",newName:void 0,updateGroupItem:void 0},keyMap:{request:{oldName:"GroupOldName",newName:"GroupNewName"},response:{UpdateType:"type",ResultItem:"resultList"}}}),this._configMap.set(v.GET_GRP_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_GRP_LIST)}),body:{memberAccount:"",limit:void 0,offset:void 0,groupType:void 0,responseFilter:{groupBaseInfoFilter:void 0,selfInfoFilter:void 0},isSupportTopic:0},keyMap:{request:{memberAccount:"Member_Account"},response:{GroupIdList:"groups",NoUnreadSeqList:"excludedUnreadSequenceList",MsgSeq:"readedSequence",LastRecallTime:"_lastRevokedTime"}}}),this._configMap.set(v.GET_GRP_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_GRP_PROFILE)}),body:{groupIDList:void 0,responseFilter:{groupBaseInfoFilter:void 0,groupCustomFieldFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0}},keyMap:{request:{groupIDList:"GroupIdList",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",groupCustomFieldFilter:"AppDefinedDataFilter_Group",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},response:{GroupIdList:"groups",AppDefinedData:"groupCustomField",AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_Group:"groupCustomFieldFilter",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",InfoSeq:"infoSequence",MemberList:"members",GroupInfo:"groups",ShutUpUntil:"muteUntil",ShutUpAllMember:"muteAllMembers"}}}),this._configMap.set(v.CREATE_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.CREATE_GRP)}),body:{type:void 0,name:void 0,groupID:void 0,ownerID:void 0,introduction:void 0,notification:void 0,maxMemberNum:void 0,joinOption:void 0,memberList:void 0,groupCustomField:void 0,memberCustomField:void 0,webPushFlag:1,avatar:"",isSupportTopic:void 0,inviteOption:void 0},keyMap:{request:{ownerID:"Owner_Account",userID:"Member_Account",avatar:"FaceUrl",maxMemberNum:"MaxMemberCount",joinOption:"ApplyJoinOption",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",inviteOption:"InviteJoinOption"},response:{HugeGroupFlag:"avChatRoomFlag",OverJoinedGroupLimit_Account:"overLimitUserIDList"}}}),this._configMap.set(v.DISMISS_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.DISMISS_GRP)}),body:{groupID:void 0}}),this._configMap.set(v.UPDATE_GRP_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.UPDATE_GRP_PROFILE)}),body:{groupID:void 0,name:void 0,introduction:void 0,notification:void 0,avatar:void 0,joinOption:void 0,groupCustomField:void 0,muteAllMembers:void 0,inviteOption:void 0},keyMap:{request:{groupCustomField:"AppDefinedData",muteAllMembers:"ShutUpAllMember",joinOption:"ApplyJoinOption",avatar:"FaceUrl",inviteOption:"InviteJoinOption"},response:{AppDefinedData:"groupCustomField",ShutUpAllMember:"muteAllMembers"}}}),this._configMap.set(v.APPLY_JOIN_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.APPLY_JOIN_GRP)}),body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1,historyMessageFlag:void 0},keyMap:{request:{applyMessage:"ApplyMsg",historyMessageFlag:"HugeGroupHistoryMsgFlag"},response:{HugeGroupFlag:"avChatRoomFlag",AVChatRoomKey:"avChatRoomKey",RspMsgList:"messageList",ToGroupId:"to"}}}),this._configMap.set(v.APPLY_JOIN_GRP_NOAUTH,(e.a2,e.tinyid,{head:y(y({},h(e,ss)),{},{servcmd:"".concat(a.NAME.BIG_GRP_NO_AUTH,".").concat(v.APPLY_JOIN_GRP)}),body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1},keyMap:{request:{applyMessage:"ApplyMsg"},response:{HugeGroupFlag:"avChatRoomFlag"}}})),this._configMap.set(v.QUIT_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.QUIT_GRP)}),body:{groupID:void 0}}),this._configMap.set(v.SEARCH_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.SEARCH_GRP)}),body:{groupIDList:void 0,responseFilter:{groupBasePublicInfoFilter:["Type","Name","Introduction","Notification","FaceUrl","CreateTime","Owner_Account","LastInfoTime","LastMsgTime","NextMsgSeq","MemberNum","MaxMemberNum","ApplyJoinOption","InviteJoinOption"]}},keyMap:{response:{}}}),this._configMap.set(v.CHANGE_GRP_OWNER,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.CHANGE_GRP_OWNER)}),body:{groupID:void 0,newOwnerID:void 0},keyMap:{request:{newOwnerID:"NewOwner_Account"}}}),this._configMap.set(v.HANDLE_GRP_APPLICATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.HANDLE_GRP_APPLICATION)}),body:{groupID:void 0,applicant:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{request:{applicant:"Applicant_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._configMap.set(v.HANDLE_INVITE_JOIN_GRP,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.HANDLE_INVITE_JOIN_GRP)}),body:{groupID:void 0,applicant:void 0,invitee:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,userDefinedField:void 0},keyMap:{request:{applicant:"Applicant_Account",invitee:"Invited_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg"}}}),this._configMap.set(v.HANDLE_GRP_INVITATION,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.HANDLE_GRP_INVITATION)}),body:{groupID:void 0,inviter:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{request:{inviter:"Inviter_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._configMap.set(v.GET_GRP_PENDENCY,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_GRP_PENDENCY)}),body:{startTime:void 0,limit:void 0,handleAccount:void 0},keyMap:{request:{handleAccount:"Handle_Account"},response:{To_Account:"userID",ApplyInviteMsg:"note"}}}),this._configMap.set(v.DEL_GRP_SYSTEM_NOTICE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.DEL_GRP_SYSTEM_NOTICE)}),body:{messageListToDelete:void 0},keyMap:{request:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._configMap.set(v.AV_POLLING,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.BIG_GRP_POLLING,".").concat(v.AV_POLLING)}),body:{USP:1,startSeq:1,startBroadcastSeq:void 0,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{request:{USP:"USP"},response:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}}),this._configMap.set(v.AV_NOAUTH_POLLING,(e.a2,e.tinyid,{head:y(y({},h(e,rs)),{},{servcmd:"".concat(a.NAME.BIG_GRP_POLLING_NO_AUTH,".").concat(v.AV_POLLING)}),body:{USP:1,startSeq:1,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{request:{USP:"USP"},response:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}})),this._configMap.set(v.GET_ONLINE_MBR_NUM,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_ONLINE_MBR_NUM)}),body:{groupID:void 0},keyMap:{response:{OnlineMemberNum:"memberCount"}}}),this._configMap.set(v.SET_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.SET_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{request:{key:"key",value:"value"}}}),this._configMap.set(v.MODIFY_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.MODIFY_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{request:{key:"key",value:"value"}}}),this._configMap.set(v.DEL_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.DEL_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{request:{key:"key"}}}),this._configMap.set(v.CLEAR_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.CLEAR_GRP_ATTR)}),body:{groupID:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]}}),this._configMap.set(v.GET_GRP_ATTR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_ATTR,".").concat(v.GET_GRP_ATTR)}),body:{groupID:void 0,avChatRoomKey:void 0,groupType:1},keyMap:{request:{avChatRoomKey:"Key",groupType:"GroupType"}}}),this._configMap.set(v.GET_GRP_NOTIFY,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_GRP_NOTIFY)}),body:{notifyReqList:[]},keyMap:{request:{notifyReqList:"NotifyReqList"},response:{NextMsgTime:"nextRevokedTime",NotifyMsgList:"notifyList",NotifyRspList:"notifyRspList"}}}),this._configMap.set(v.UPDATE_GRP_COUNTER,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.UPDATE_GRP_COUNTER)}),body:{groupID:void 0,counterList:void 0,avChatRoomKey:void 0,mode:void 0},keyMap:{request:{counterList:"GroupCounter"}}}),this._configMap.set(v.GET_GRP_COUNTER,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_GRP_COUNTER)}),body:{groupID:void 0,keyList:[],avChatRoomKey:void 0},keyMap:{request:{keyList:"GroupCounterKeys"}}}),this._configMap.set(v.CREATE_TOPIC,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_COMMUNITY,".").concat(v.CREATE_TOPIC)}),body:{groupID:void 0,topicName:void 0,avatar:void 0,customData:void 0,topicID:void 0,notification:void 0,introduction:void 0},keyMap:{request:{avatar:"FaceUrl"}}}),this._configMap.set(v.DEL_TOPIC,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_COMMUNITY,".").concat(v.DEL_TOPIC)}),body:{groupID:void 0,topicIDList:void 0},keyMap:{request:{topicIDList:"TopicIdList"},response:{DestroyResultItem:"resultList"}}}),this._configMap.set(v.UPDATE_TOPIC_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_COMMUNITY,".").concat(v.UPDATE_TOPIC_PROFILE)}),body:{groupID:void 0,topicID:void 0,avatar:void 0,customData:void 0,notification:void 0,introduction:void 0,muteAllMembers:void 0,topicName:void 0},keyMap:{request:{avatar:"FaceUrl",muteAllMembers:"ShutUpAllMember"}}}),this._configMap.set(v.GET_TOPIC_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_COMMUNITY,".").concat(v.GET_TOPIC_LIST)}),body:{groupID:void 0,topicIDList:void 0,MemberInfoFilter:["NoUnreadSeqList"]},keyMap:{request:{topicIDList:"TopicIdList"},response:{TopicAndSelfInfo:"topicInfoList",TopicInfo:"topic",GroupID:"groupID",ShutUpTime:"muteTime",ShutUpAllFlag:"muteAllMembers",LastMsgTime:"lastMessageTime",MsgSeq:"readedSequence",LastMsgSeq:"sequence",NoUnreadSeqList:"excludedUnreadSequenceList"}}}),this._configMap.set(v.GET_GRP_MBR_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_GRP_MBR_LIST)}),body:{groupID:void 0,limit:0,offset:void 0,next:void 0,memberRoleFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{request:{memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},response:{AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",MemberList:"members",ShutUpUntil:"muteUntil"}}}),this._configMap.set(v.GET_AV_MBR_LIST,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_AV,".").concat(v.GET_AV_MBR_LIST)}),body:{groupID:void 0,offset:void 0,filter:void 0},keyMap:{request:{offset:"Timestamp",filter:"Mark"},response:{NextTimestamp:"offset"}}}),this._configMap.set(v.GET_GRP_MBR_PROFILE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.GET_GRP_MBR_PROFILE)}),body:{groupID:void 0,userIDList:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{request:{userIDList:"Member_List_Account",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},response:{MemberList:"members",ShutUpUntil:"muteUntil",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",AppMemberDefinedData:"memberCustomField"}}}),this._configMap.set(v.ADD_GRP_MBR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.ADD_GRP_MBR)}),body:{groupID:void 0,silence:void 0,userIDList:void 0},keyMap:{request:{userID:"Member_Account",userIDList:"MemberList"},response:{MemberList:"members"}}}),this._configMap.set(v.DEL_GRP_MBR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.DEL_GRP_MBR)}),body:{groupID:void 0,userIDList:void 0,reason:void 0},keyMap:{request:{userIDList:"MemberToDel_Account"}}}),this._configMap.set(v.BAN_AV_MBR,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.BAN_AV_MBR)}),body:{groupID:void 0,userIDList:void 0,duration:void 0,reason:""},keyMap:{request:{userIDList:"Members_Account",duration:"Duration",reason:"Description"}}}),this._configMap.set(v.MODIFY_GRP_MBR_INFO,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP,".").concat(v.MODIFY_GRP_MBR_INFO)}),body:{groupID:void 0,topicID:void 0,userID:void 0,messageRemindType:void 0,nameCard:void 0,role:void 0,memberCustomField:void 0,muteTime:void 0},keyMap:{request:{userID:"Member_Account",memberCustomField:"AppMemberDefinedData",muteTime:"ShutUpTime",messageRemindType:"MsgFlag"}}}),this._configMap.set(v.MARK_AV_MBR_INFO,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.GRP_AV,".").concat(v.MARK_AV_MBR_INFO)}),body:{groupID:void 0,operationType:1,memberList:[]},keyMap:{request:{operationType:"CommandType",memberList:"MemberList",markType:"Marks",userID:"Member_Account"},response:{CommandType:"operationType",Marks:"markType",Member_Account:"userID"}}}),this._configMap.set(v.SSO_STAT,{head:y(y({},n),{},{servcmd:"".concat(a.NAME.IM_OPEN_STAT,".").concat(v.SSO_STAT)}),body:{header:{},event:[],quality:[]},keyMap:{request:{SDKType:"sdk_type",SDKVersion:"sdk_version",deviceType:"device_type",platform:"platform",instanceID:"instance_id",traceID:"trace_id",SDKAppID:"sdk_app_id",userID:"user_id",tinyID:"tiny_id",extension:"extension",timestamp:"timestamp",networkType:"network_type",eventType:"event_type",code:"error_code",message:"error_message",moreMessage:"more_message",duplicate:"duplicate",costTime:"cost_time",level:"level",qualityType:"quality_type",reportIndex:"report_index",wholePeriod:"whole_period",totalCount:"total_count",rttCount:"success_count_business",successRateOfRequest:"percent_business",countLessThan1Second:"success_count_business",percentOfCountLessThan1Second:"percent_business",countLessThan3Second:"success_count_platform",percentOfCountLessThan3Second:"percent_platform",successCountOfBusiness:"success_count_business",successRateOfBusiness:"percent_business",successCountOfPlatform:"success_count_platform",successRateOfPlatform:"percent_platform",successCountOfMessageReceived:"success_count_business",successRateOfMessageReceived:"percent_business",avgRTT:"average_value",avgDelay:"average_value",avgValue:"average_value",uiPlatform:"ui_platform"}}}),this._configMap.set(v.PING,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.HEARTBEAT,".").concat(v.PING)}),body:{}}),this._configMap.set(v.MSG_PUSH,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_PUSH,".").concat(v.MSG_PUSH)}),body:{},keyMap:{response:{C2cMsgArray:"C2CMessageArray",GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",C2cNotifyMsgArray:"C2CNotifyMessageArray",C2cMsgInfo:"C2CReadReceiptArray",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyAdd_Account:"userID",ProfileImNick:"nick",PendencyType:"applicationType",C2CReadAllMsg:"readAllC2CMessage",IsNeedReadReceipt:"needReadReceipt",Status:"statusType",CurrFollowType:"followType",Follow_Account:"userID"}}}),this._configMap.set(v.MULTI_MSG_PUSH,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_PUSH,".").concat(v.MULTI_MSG_PUSH)}),body:{},keyMap:{response:{GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyType:"applicationType"}}}),this._configMap.set(v.MSG_PUSH_ACK,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OPEN_IM,".").concat(v.MSG_PUSH_ACK)}),body:{sessionData:void 0},keyMap:{request:{sessionData:"SessionData"}}}),this._configMap.set(v.STATUS_FORCE_OFFLINE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.STATUS_FORCE_OFFLINE)}),body:{},keyMap:{response:{C2cNotifyMsgArray:"C2CNotifyMessageArray",NoticeSeq:"noticeSequence",KickoutMsgNotify:"kickoutMsgNotify",NewInstInfo:"newInstanceInfo"}}}),this._configMap.set(v.DOWNLOAD_MERGER_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_LONG_MSG,".").concat(v.DOWNLOAD_MERGER_MSG)}),body:{downloadKey:""},keyMap:{response:{Data:"data",Desc:"description",Ext:"extension",Download_Flag:"downloadFlag",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID"}}}),this._configMap.set(v.UPLOAD_MERGER_MSG,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_LONG_MSG,".").concat(v.UPLOAD_MERGER_MSG)}),body:{messageList:[]},keyMap:{request:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",type:"MsgType",content:"MsgContent",data:"Data",description:"Desc",extension:"Ext",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody"}}}),this._configMap.set(v.FOLLOW,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(v.FOLLOW)}),body:{fromAccount:"",userIDList:[]},keyMap:{request:{userIDList:"FollowItem"},response:{ResultItem:"resultList",To_Account:"userID"}}}),this._configMap.set(v.UNFOLLOW,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(v.UNFOLLOW)}),body:{fromAccount:"",userIDList:[]},keyMap:{request:{userIDList:"To_Account"},response:{ResultItem:"resultList",To_Account:"userID"}}}),this._configMap.set(v.GET_FOLLOW_INFO,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(v.GET_FOLLOW_INFO)}),body:{fromAccount:"",userIDList:[]},keyMap:{request:{userIDList:"To_Account"},response:{FollowInfo:"followInfoList",To_Account:"userID",FollowerCount:"followersCount",FollowingCount:"followingCount",MutualFollowingCount:"mutualFollowersCount"}}}),this._configMap.set(v.GET_FOLLOW,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(v.GET_FOLLOW)}),body:{fromAccount:"",type:1,nextCursor:"",count:500},keyMap:{request:{type:"FollowType",nextCursor:"StartCursor",count:"WantNum"},response:{FollowItem:"resultList",To_Account:"userID",ProfileItem:"profileList"}}}),this._configMap.set(v.CHECK_FOLLOW_TYPE,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.FOLLOW,".").concat(v.CHECK_FOLLOW_TYPE)}),body:{fromAccount:"",userIDList:[]},keyMap:{request:{userIDList:"To_Account"},response:{ResultItem:"resultList",To_Account:"userID"}}}),this._configMap.set(v.SET_TOKEN,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.SET_TOKEN)}),body:{tokenID:"",pushMsg:0,sdkAppID:0,businessID:"",deviceBrand:"",deviceToken:"",isTpns:0,isWebUniapp:0,notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:""},keyMap:{request:{tokenID:"TokenID",pushMsg:"PushMsg",sdkAppID:"EnterVersion",businessID:"BusiID",deviceBrand:"InstType",deviceToken:"VarToken",isTpns:"IsTpns",notificationStatus:"NotificationStatus",deviceModel:"DeviceModel",systemVersion:"SystemVersion",pushVersion:"PushPluginVersion"}}}),this._configMap.set(v.STAT_FOREGROUND,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.STAT_FOREGROUND)}),body:{isWebUniapp:0}}),this._configMap.set(v.STAT_BACKGROUND,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_OPEN_STATUS,".").concat(v.STAT_BACKGROUND)}),body:{C2CUnread:0,GroupUnread:0,isWebUniapp:0},keyMap:{request:{c2cUnreadCount:"C2cUnread",groupUnreadCount:"GrpUnread"}}}),this._configMap.set(v.PUSH_REPORT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.OFFLINE_PUSH_REPORT,".").concat(v.PUSH_REPORT)}),body:{eventList:[]},keyMap:{request:{eventList:"UinappPushEvents",type:"EventType",time:"EventTime",pushId:"ClickExt"}}}),this._configMap.set(v.SET_ALL_RECEIVE_MSG_OPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_MSG_LOGIC,".").concat(v.SET_ALL_RECEIVE_MSG_OPT)}),body:{startTime:0,endTime:0,isRepeated:0,messageRemindType:0},keyMap:{request:{messageRemindType:"Level"}}}),this._configMap.set(v.GET_ALL_RECEIVE_MSG_OPT,{head:y(y({},e),{},{servcmd:"".concat(a.NAME.IM_MSG_LOGIC,".").concat(v.GET_ALL_RECEIVE_MSG_OPT)}),body:{toAccount:void 0}})}},{key:"has",value:function(e){return this._configMap.has(e)}},{key:"get",value:function(e){return this._configMap.get(e)}},{key:"update",value:function(){this._fillConfigMap()}},{key:"getKeyMap",value:function(e){return this.has(e)?this.get(e).keyMap||{}:(A.w("".concat(this._n,".getKeyMap unknown proto:").concat(e)),{})}},{key:"getProtocolData",value:function(e){var t=e.proto,n=e.data,e=this.get(t),t=null;if(n){var o,i=this._simpleDeepCopy(e),i=this._updateService(n,i),a=i.body,s=Object.create(null);for(o in a)if(Object.prototype.hasOwnProperty.call(a,o)){if(s[o]=a[o],void 0===n[o])continue;s[o]=n[o]}i.body=s,t=this._getUplinkData(i)}else t=this._getUplinkData(e);return t}},{key:"_getUplinkData",value:function(e){var e=this._dataCleaner(e),t=bt(e.head),t=Ya(e.body,this._getRequestKeyMap(t));return e.body=t,e}},{key:"_updateService",value:function(e,t){var n,o,i=bt(t.head);return this._isFromGroupRequest(t)&&(n=e.type,o=e.groupID,e=void 0===(e=e.groupIDList)?[]:e,k(o=void 0===o?void 0:o)&&(o=e[0]||""),Dt({type:n,groupID:o})&&(t.head.servcmd="".concat(a.NAME.GRP_COMMUNITY,".").concat(i))),t}},{key:"_isFromGroupRequest",value:function(e){return e.head.servcmd.includes(a.NAME.GRP)||e.head.servcmd.includes(a.NAME.GRP_ATTR)}},{key:"_getRequestKeyMap",value:function(e){e=this.getKeyMap(e);return y(y({},Fa.request),e.request)}},{key:"_dataCleaner",value:function(e){var t,n=Array.isArray(e)?[]:Object.create(null);for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&nt(t)&&null!==e[t]&&void 0!==e[t]&&("object"!==r(e[t])?n[t]=e[t]:n[t]=this._dataCleaner.bind(this)(e[t]));return n}},{key:"_simpleDeepCopy",value:function(e){for(var t,n=Object.keys(e),o={},i=0,a=n.length;i<a;i++)t=n[i],Qe(e[t])?o[t]=Array.from(e[t]):Xe(e[t])?o[t]=this._simpleDeepCopy(e[t]):o[t]=e[t];return o}}]),ms),us=[v.MSG_PUSH_ACK],ls=(e(fs,[{key:"_c2cMessageArrayHandler",value:function(e){var t=this._sessionM.get(6);t&&(e.dataList.forEach(function(e){var t;1===e.isSyncMessage&&(t=e.from,e.from=e.to,e.to=t)}),1===e.needSync&&this._sessionM.get(19).startOnlineSync(),t.onNewC2CMessage({dataList:e.dataList,isInstantMessage:!0}))}},{key:"_c2cMessageModifiedHandler",value:function(e){var t=this._sessionM.get(6);t&&t.onC2CMessageModified(e)}},{key:"_groupMessageArrayHandler",value:function(e){var t=this._sessionM.get(7);t&&t.onNewGroupMessage({event:e.event,dataList:e.dataList,isInstantMessage:!0})}},{key:"_groupMessageModifiedHandler",value:function(e){var t=this._sessionM.get(7);t&&t.onGroupMessageModified(e)}},{key:"_groupTipsHandler",value:function(e){var t=this._sessionM.get(7);if(t){var n=e.event,o=e.dataList,i=e.isInstantMessage,a=void 0===i||i,s=e.isSyncingEnded;switch(n){case 4:case 6:t.onNewGroupTips({event:n,dataList:o});break;case 5:for(var r=0;r<o.length;r++)if(Qe(o[r].elements.revokedInfos))t.onGroupMessageRevoked({dataList:o});else if(Qe(o[r].elements.groupMessageReadNotice))t.onGroupMessageReadNotice({dataList:o});else{if(!Qe(o[r].elements.readReceiptList)){t.onNewGroupSystemNotice({dataList:o,isInstantMessage:a,isSyncingEnded:s});break}t.onReadReceiptList({dataList:o})}break;case 12:this._sessionM.get(11).onNewGroupAtTips({dataList:o});break;default:A.l("".concat(this._n,"._groupTipsHandler unknown event:").concat(n," dataList:"),o)}}}},{key:"_C2CNotifyMessageArrayHandler",value:function(e){var o,i=this,a=e.dataList;Qe(a)&&(o=this._sessionM.get(6),a.forEach(function(e){var t,n;Ze(e)&&(e.hasOwnProperty("kickoutMsgNotify")?(t=(n=e.kickoutMsgNotify).kickType,n=void 0===(n=n.newInstanceInfo)?{}:n,1===t?i._sessionM.onMultipleAccountKickedOut(n):2===t?i._sessionM.onMultipleDeviceKickedOut(n):3===t&&i._sessionM.onRestApiKickedOut(n)):e.hasOwnProperty("c2cMessageRevokedNotify")?o&&o.onC2CMessageRevoked({dataList:a}):e.hasOwnProperty("c2cMessageReadReceipt")?o&&o.onC2CMessageReadReceipt({dataList:a}):e.hasOwnProperty("c2cMessageReadNotice")?o&&o.onC2CMessageReadNotice({dataList:a}):e.hasOwnProperty("muteNotificationsSync")&&i._sessionM.get(11).onC2CMessageRemindTypeSynced({dataList:a}))}))}},{key:"_C2CReadReceiptArrayHandler",value:function(e){this._sessionM.get(6).onReadReceiptList(e)}},{key:"_profileHandler",value:function(e){this._sessionM.get(4).onProfileModified({dataList:e.dataList});var t=this._sessionM.get(8);t&&t.onFriendProfileModified({dataList:e.dataList})}},{key:"_relationChainHandler",value:function(e){this._sessionM.get(4).onRelationChainModified({dataList:e.dataList});var t=this._sessionM.get(8);t&&t.onRelationChainModified({dataList:e.dataList})}},{key:"_recentContactHandler",value:function(e){var i,e=e.dataList;!Qe(e)||(i=this._sessionM.get(11))&&e.forEach(function(e){var t,n,o=e.pushType;1===o?(t=e.recentContactDeleteItem,i.onConversationDeleted(t.recentContactList)):2===o?(t=e.recentContactTopItem,i.onConversationPinned(t.recentContactList)):3===o?(t=e.recentContactTopItem,i.onConversationUnpinned(t.recentContactList)):4===o?(t=e.recentContactMarkContact,i.onConversationMarkUpdated(t.recentContactMarkContactItem)):5===o?(t=e.recentContactCreateContactGroup,i.onConversationGroupCreated(t.msgContactGroupContactItem)):6===o?(t=e.recentContactDelContactGroup,i.onConversationGroupDeleted(t.msgGroupItem)):7===o&&(o=(t=e.recentContactUpdateContactGroup).updateType,e=t.msgUpdateGroup,t=t.msgUpdateContact,1===o?1===(n=e.updateGroupType)?i.onConversationGroupNameUpdated(e):2===n&&i.onConversationInGroupUpdated(e):2===o&&i.onConversationAddedToOrDeletedFromGroup(t))})}},{key:"_allMessageReadHandler",value:function(e){var e=e.dataList,t=this._sessionM.get(11);t&&t.onPushedAllMessageRead(e)}},{key:"_userStatusListHandler",value:function(e){this._sessionM.get(4).onUserStatusUpdated(e)}},{key:"_messageExtensionNotifyHandler",value:function(e){this._sessionM.get(3).onMessageExtensionNotify(e)}},{key:"_messageReactionNotifyListHandler",value:function(e){this._sessionM.get(34).onMessageReactionNotifyList(e)}},{key:"_messageReactionNotifyHandler",value:function(e){this._sessionM.get(34).onMessageReactionNotify(e)}},{key:"_followInfoHandler",value:function(e){this._sessionM.get(35).onFollowInfoNotify(e)}},{key:"onMessage",value:function(e){var t=this,n=e.body;if(this._filterMessageFromIMOpenPush(e)){var o,i=n.eventArray,a=n.isInstantMessage,l=n.isSyncingEnded,d=n.needSync;if(Qe(i))for(var s,r,c,u=0,p=i.length;u<p;u++)100!==(c=(s=i[u]).event)?24!==c?(o=Object.keys(s).find(function(e){return-1!==t._keys.indexOf(e)}))?(r=14===c?{readAllC2CMessage:s[o],groupMessageReadInfoList:s.groupMessageReadNotice||[]}:16===c?{userID:s.userID,readReceiptList:s[o]}:s[o],this._eventHandlerMap.get(o)({event:c,dataList:r,isInstantMessage:a,isSyncingEnded:l,needSync:d})):A.l("".concat(this._n,".onMessage unknown eventItem:").concat(s)):this._onAllReceiveMessageOptNotify(s):this._onRoomCustomData(s.content)}}},{key:"_onRoomCustomData",value:function(e){this._sessionM.get(30).onRoomCustomDataReceived(e),A.l("".concat(this._n,"._onRoomCustomData data:").concat(e))}},{key:"_onAllReceiveMessageOptNotify",value:function(e){this._sessionM.get(11).onAllReceiveMessageOptNotify(e)}},{key:"_filterMessageFromIMOpenPush",value:function(e){var t=e.head,e=e.body,t=t.servcmd,n=!1;return!(n=k(t)?n:t.includes(a.NAME.IM_CONFIG_MANAGER)||t.includes(a.NAME.OVERLOAD_PUSH)||t.includes(a.NAME.STAT_SERVICE))||(t.includes(v.PUSHED_CLOUD_CTRL_CONFIG)?this._sessionM.get(23).onPushedCloudControlConfig(e):t.includes(v.PUSHED_COMMERCIAL_CONFIG)?this._sessionM.get(27).onPushedConfig(e):t.includes(v.OVERLOAD_NOTIFY)?this._sessionM.onPushedServerOverload(e):t.includes(v.KICK_OTHER)&&(n=Date.now(),this._sessionM.reLoginOnKickOther(),e=new M("kickOther"),n=n-(t=this._sessionM.get(1).getLastWsHelloTs()),e.setMessage("last wshello time:".concat(t," diff:").concat(n,"ms")).end()),!1)}}]),fs),ds=[{cmd:v.GET_GRP_PROFILE,interval:1,count:8},{cmd:v.UPDATE_GRP_PROFILE,interval:1,count:8},{cmd:v.GET_AVCHATROOM_MBR_LIST,interval:3,count:1},{cmd:v.GET_GRP_PENDENCY,interval:1,count:15},{cmd:v.GET_TOPIC_LIST,interval:1,count:10},{cmd:v.SET_GRP_ATTR,interval:5,count:10},{cmd:v.MODIFY_GRP_ATTR,interval:5,count:10},{cmd:v.DEL_GRP_ATTR,interval:5,count:10},{cmd:v.CLEAR_GRP_ATTR,interval:5,count:10},{cmd:v.GET_GRP_ATTR,interval:5,count:20},{cmd:v.UPDATE_GRP_COUNTER,interval:5,count:20},{cmd:v.GET_GRP_COUNTER,interval:5,count:20},{cmd:v.SET_ALL_MSG_READ,interval:1,count:1},{cmd:v.GET_USER_STATUS,interval:5,count:20},{cmd:v.SUB_USER_STATUS,interval:5,count:20},{cmd:v.UNSUB_USER_STATUS,interval:5,count:20},{cmd:v.MSG_CLOUD_SEARCH,interval:1,count:2},{cmd:v.CHECK_FOLLOW_TYPE,interval:5,count:20}],ps=new Map,_s=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],gs=0,hs=_s.length;gs<hs;gs++)ps.set(gs,_s[gs]);function fs(e){u(this,fs),this._sessionM=e,this._n="DownlinkHandler",this._eventHandlerMap=new Map,this._eventHandlerMap.set("C2CMessageArray",this._c2cMessageArrayHandler.bind(this)),this._eventHandlerMap.set("groupMessageArray",this._groupMessageArrayHandler.bind(this)),this._eventHandlerMap.set("groupTips",this._groupTipsHandler.bind(this)),this._eventHandlerMap.set("C2CNotifyMessageArray",this._C2CNotifyMessageArrayHandler.bind(this)),this._eventHandlerMap.set("C2CReadReceiptArray",this._C2CReadReceiptArrayHandler.bind(this)),this._eventHandlerMap.set("profileModify",this._profileHandler.bind(this)),this._eventHandlerMap.set("friendListMod",this._relationChainHandler.bind(this)),this._eventHandlerMap.set("recentContactMod",this._recentContactHandler.bind(this)),this._eventHandlerMap.set("readAllC2CMessage",this._allMessageReadHandler.bind(this)),this._eventHandlerMap.set("c2cMessageModified",this._c2cMessageModifiedHandler.bind(this)),this._eventHandlerMap.set("groupMessageModified",this._groupMessageModifiedHandler.bind(this)),this._eventHandlerMap.set("userStatusList",this._userStatusListHandler.bind(this)),this._eventHandlerMap.set("messageExtensionNotify",this._messageExtensionNotifyHandler.bind(this)),this._eventHandlerMap.set("messageReactionNotifyList",this._messageReactionNotifyListHandler.bind(this)),this._eventHandlerMap.set("messageReactionNotify",this._messageReactionNotifyHandler.bind(this)),this._eventHandlerMap.set("follow",this._followInfoHandler.bind(this)),this._keys=T(this._eventHandlerMap.keys())}function ms(e){u(this,ms),this._n="ProtocolHandler",this._sessionM=e,this._configMap=new Map,this._fillConfigMap()}function vs(e){var t,n;return u(this,vs),(e=ja.call(this,e))._n="ChannelModule",e._socketHandler=new os(g(e)),e._probing=!1,e._isAppShowing=!0,e._previousState=S.NET_STATE_CONNECTED,te&&"function"==typeof oe.onAppShow&&"function"==typeof oe.onAppHide&&(t=e._onAppHide.bind(g(e)),n=e._onAppShow.bind(g(e)),"function"==typeof oe.offAppHide&&oe.offAppHide(t),"function"==typeof oe.offAppShow&&oe.offAppShow(n),oe.onAppHide(t),oe.onAppShow(n)),e._timerForNotLoggedIn=-1,e._timerForNotLoggedIn=setInterval(e.onCheckTimer.bind(g(e)),1e3),e._fatalErrorFlag=!1,e._disconnectedTS=0,e._lastDiagnoseTS=0,e}function Ms(e){u(this,Ms),this._chM=e,this._n="SocketHandler",this._promiseMap=new Map,this._readyState=ns,this._simpleRequestMap=new Map,this.MAX_SIZE=100,this._startSequence=st(),this._startTs=0,this._reConnectFlag=!1,this._nextPingTs=0,this._reConnectCount=0,this.MAX_RECONNECT_COUNT=3,this._socketID=-1,this._random=0,this._socket=null,this._url="",this._onOpenTs=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0,this._currentSite=V,this._setWebsocketHost(),this._initConnection()}function Is(e){u(this,Is);var t,i,n=(this._handler=e).getURL();this._socket=null,this._workerSocket=null,this._id=st(),this._handler.getIsWorkerEnabled()?(t=URL.createObjectURL(new Blob([';let _socket = null;onmessage = function(event) {  if (event.data.cmd === "start") {    const url = event.data.url;    _socket = new WebSocket(url);    _socket.binaryType = "arraybuffer";    _socket.onopen = function() {      postMessage({ callback: "onOpen", extensions: _socket.extensions });    };    _socket.onclose = function(e) {      postMessage({ callback: "onOpen", e: { code: e.code, reason: e.reason } });    };    _socket.onmessage = function(e) {      postMessage({ callback: "onMessage", data: e.data });    };    _socket.onerror = function(e) {      postMessage({ callback: "onError", e: { isTrusted: "true" } });    };  } else if (event.data.cmd === "sendMessage") {    if (_socket !== null) {      _socket.send(event.data.data);    }  } else if (event.data.cmd === "stop") {    if (_socket !== null) {      _socket.close(event.data.code);      _socket = null;    }  }};'],{type:"application/javascript; charset=utf-8"})),this._workerSocket=new Worker(t),(i=this)._workerSocket.onmessage=function(e){var t=e.data,n=t.callback,o=t.e,t=t.extensions;"onOpen"===n?i._onOpen(t):"onClose"===n?i._onClose(o):"onError"===n?i._onError(o):"onMessage"===n&&i._onMessage(e.data)},this._workerSocket.postMessage({cmd:"start",id:this._id,url:n})):te?Z?(oe.connectSocket({url:n,header:{"content-type":"application/json"}}),oe.onSocketClose(this._onClose.bind(this)),oe.onSocketOpen(this._onOpen.bind(this)),oe.onSocketMessage(this._onMessage.bind(this)),oe.onSocketError(this._onError.bind(this))):(this._socket=oe.connectSocket({url:n,header:{"content-type":"application/json"},complete:function(){}}),this._socket.onClose(this._onClose.bind(this)),this._socket.onOpen(this._onOpen.bind(this)),this._socket.onMessage(this._onMessage.bind(this)),this._socket.onError(this._onError.bind(this))):ne&&(this._socket=new WebSocket(n),this._socket.binaryType="arraybuffer",this._socket.onopen=this._onOpen.bind(this,this._socket.extensions),this._socket.onmessage=this._onMessage.bind(this),this._socket.onclose=this._onClose.bind(this),this._socket.onerror=this._onError.bind(this)),this._canIUseBinaryFrame=e.canIUseBinaryFrame()}function ys(e){for(var t,n,o=e,i="",a=0,s=(o=e.length%8!=0?"0".repeat(8-e.length%8)+e:o).length;a<s;a+=8)t=parseInt(o.slice(a,a+4),2),n=parseInt(o.slice(a+4,a+8),2),i+=ps.get(t)+ps.get(n);return i}function Cs(e){if(e<0||53<e)return NaN;var t=0|1073741824*Math.random();return 30<e?t+1073741824*(0|Math.random()*(1<<e-30)):t>>>30-e}function Ts(e,t){for(var n=e.toString(16),o=t-n.length,i="0";0<o;o>>>=1,i+=i)1&o&&(n=i+n);return n}t(Vr,Nn),Ps=f(Vr),e(Vr,[{key:"_init",value:function(){this._updateCommandFrequencyLimitMap(ds)}},{key:"_onCloudConfigUpdated",value:function(){var e=this.getCloudConfig("cmd_frequency_limit");k(e)||(e=JSON.parse(e),this._updateCommandFrequencyLimitMap(e))}},{key:"_updateCommandFrequencyLimitMap",value:function(e){var t=this;e.forEach(function(e){t._commandFrequencyLimitMap.set(e.cmd,{interval:e.interval,count:e.count})})}},{key:"updateProtocolConfig",value:function(){this._protocolHandler.update()}},{key:"req",value:function(e){A.d("".concat(this._n,".req options:"),e);var t=e.proto,n=e.tjgID;if(!this._protocolHandler.has(t))return A.w("".concat(this._n,".req unknown proto:").concat(t)),m({code:C.CANNOT_FIND_PROTOCOL});var e=this.getProtocolData(e),o=e.head.servcmd;if(this._isFrequencyOverLimit(o))return m({code:i=C.OVER_FREQUENCY_LIMIT,message:this.getErrorMessage(i,this._getCmd(o))});if(this._isServerOverload(o))return m({code:i=C.OPEN_SERVICE_OVERLOAD_ERROR,message:this.getErrorMessage(i,this._getCmd(o))});We(n)||(e.head.tjgID=n);var i=this.get(21);return us.includes(t)?i.simplySend(e):i.send(e)}},{key:"getKeyMap",value:function(e){return this._protocolHandler.getKeyMap(e)}},{key:"genCommonHead",value:function(){var e=this.get(12);return{ver:"v4",platform:this._platform,websdkappid:x,websdkversion:q,a2:e.getA2Key()||void 0,tinyid:e.getTinyID()||void 0,status_instid:e.getStatusInstanceID(),sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getA2Key()?void 0:e.getUserID(),usersig:e.getA2Key()?void 0:e.getUserSig(),sdkability:192371,sdkability_ext:ys(""),cappid:e.getApplicationID(),tjgID:""}}},{key:"genCosSpecifiedHead",value:function(){var e=this.get(12);return{ver:"v4",platform:this._platform,websdkappid:x,websdkversion:q,sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getUserID(),usersig:e.getUserSig(),status_instid:e.getStatusInstanceID(),sdkability:192371,sdkability_ext:ys(""),cappid:e.getApplicationID()}}},{key:"genSSOReportHead",value:function(){var e=this.get(12);return{ver:"v4",platform:this._platform,websdkappid:x,websdkversion:q,sdkappid:e.getSDKAppID(),contenttype:"",reqtime:0,identifier:"",usersig:"",status_instid:e.getStatusInstanceID(),sdkability:192371,sdkability_ext:ys(""),cappid:e.getApplicationID()}}},{key:"getProtocolData",value:function(e){return this._protocolHandler.getProtocolData(e)}},{key:"trans",value:function(e){var t=e.servcmd,e=e.data,t={head:y(y({},this.genCommonHead()),{},{servcmd:t}),body:e};return this.get(21).send(t)}},{key:"sendComboMessage",value:function(e){var t=e.servcmd,e=e.data,t={head:y(y({},this.genCommonHead()),{},{servcmd:t}),body:e};return this.get(21).send(t)}},{key:"onErrorCodeNotZero",value:function(e){var t,n=e.errorCode;n===C.HELLO_ANSWER_KICKED_OUT&&(t=e.kickType,e=void 0===(e=e.newInstanceInfo)?{}:e,1===t?this.onMultipleAccountKickedOut(e):2===t?this.onMultipleDeviceKickedOut(e):3===t&&this.onRestApiKickedOut(e)),n!==C.MSG_A2KEY_EXPIRED&&n!==C.ACCOUNT_A2KEY_EXPIRED||(this._onUserSigExpired(),this.get(21).reConnect())}},{key:"onMessage",value:function(e){var t=e.body,n=t.needAck,t=t.sessionData;1===(void 0===n?0:n)&&this._sendACK(t),this._messageDispatcher.onMessage(e)}},{key:"onReconnected",value:function(e){this._incrementalPullContactFlag=e<=300,this._reLoginOnReconnected()}},{key:"reLoginOnKickOther",value:function(){A.l("".concat(this._n,".reLoginOnKickOther")),this._reLogin()}},{key:"_reLoginOnReconnected",value:function(){A.l("".concat(this._n,"._reLoginOnReconnected")),this._reLogin()}},{key:"_reLogin",value:function(){var e,t,i,a=this,s="".concat(this._n,"._reLogin");this.isLoggedIn()&&(e=0,(t=this.get(1).getPushModule())&&(e=t.getUniAppPlatform()),i=new M("reLogin"),this.req({proto:v.LOGIN,data:{isWebUniapp:e}}).then(function(e){var e=e.data,t=e.instanceID,e=e.customStatus,n=a.get(12),o=Vo(e),t=(n.setStatusInstanceID(t),"instanceID:".concat(t," customStatus:").concat(o)),t=(i.setMessage(t).end(!0),A.l("".concat(s," ok. ").concat(t)),n.getCustomStatus()!==o&&a.get(4).onUserStatusUpdated({dataList:[{to:a.getMyUserID(),statusType:S.USER_STATUS_ONLINE,customStatus:e}]}),a.get(21).diagnose(),a.get(11).syncConversationList(a._incrementalPullContactFlag).then(function(){A.l("".concat(s,", sync conversation list ok.")),a.get(25).start()}),a.get(7)),n=(t&&t.updateLocalMainSequenceOnReconnected(),a.get(10)),o=(n.resetGetTopicTime(),n.getTopicListOnReconnected(),a.get(35));o&&o.clearCacheOnReconnected()}))}},{key:"onMultipleAccountKickedOut",value:function(e){this.get(1).onMultipleAccountKickedOut(e)}},{key:"onMultipleDeviceKickedOut",value:function(e){this.get(1).onMultipleDeviceKickedOut(e)}},{key:"_onUserSigExpired",value:function(){this.get(1).onUserSigExpired()}},{key:"onRestApiKickedOut",value:function(e){this.get(1).onRestApiKickedOut(e)}},{key:"_sendACK",value:function(e){this.req({proto:v.MSG_PUSH_ACK,data:{sessionData:e}})}},{key:"_isFrequencyOverLimit",value:function(e){e=e.split(".")[1];if(!this._commandFrequencyLimitMap.has(e))return!1;if(!this._commandRequestInfoMap.has(e))return this._commandRequestInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1;var t=this._commandFrequencyLimitMap.get(e),n=t.count,t=t.interval,o=this._commandRequestInfoMap.get(e),i=o.startTime,o=o.requestCount;return Date.now()-i>1e3*t?(this._commandRequestInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1):(this._commandRequestInfoMap.set(e,{startTime:i,requestCount:o+=1}),n<o)}},{key:"_isServerOverload",value:function(e){if(!this._serverOverloadInfoMap.has(e))return!1;var t=this._serverOverloadInfoMap.get(e),n=t.overloadTime,t=t.waitingTime;return Date.now()-n<=1e3*t||(this._serverOverloadInfoMap.delete(e),!1)}},{key:"_getCmd",value:function(e){var t="";if(!e.includes("."))return t;var n,o=e.split(".")[1];for(n in v)if(v[n]===o){t=n;break}return t}},{key:"onPushedServerOverload",value:function(e){var t=e.overloadCommand,e=e.waitingTime;this._serverOverloadInfoMap.set(t,{overloadTime:Date.now(),waitingTime:e}),A.w("".concat(this._n,".onPushedServerOverload waitingTime:").concat(e,"s cmd:").concat(this._getCmd(t)))}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._updateCommandFrequencyLimitMap(ds),this._commandRequestInfoMap.clear(),this._serverOverloadInfoMap.clear(),this._incrementalPullContactFlag=!0}}]);var Ds,Es,Ls,Ss,As,ks,Rs,Os,Ns,Gs,Ps,Us=Vr,bs=(t(xr,Nn),Gs=f(xr),e(xr,[{key:"getCloudConfig",value:function(e){return k(e)?this._cloudConfig:this._cloudConfig.has(e)?this._cloudConfig.get(e):void 0}},{key:"getServerConfig",value:function(e){var t={code:0,data:""};return!k(e)&&this._cloudConfig.has(e)&&(t.data=this._cloudConfig.get(e)),Promise.resolve(t)}},{key:"_canFetchConfig",value:function(){return this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime}},{key:"fetchConfig",value:function(){var t,n=this,e=this._canFetchConfig();A.l("".concat(this._n,".fetchConfig canFetchConfig:").concat(e)),e&&(t=new M("fetchCloudControlConfig"),e=this.get(12).getSDKAppID(),this._isFetching=!0,this.req({proto:v.FETCH_CLOUD_CTRL_CONFIG,data:{SDKAppID:e,version:this._version}}).then(function(e){n._isFetching=!1,t.setMessage("version:".concat(n._version," newVersion:").concat(e.data.version," config:").concat(e.data.cloudControlConfig)).end(),A.l("".concat(n._n,".fetchConfig ok")),n._parseCloudControlConfig(e.data)}).catch(function(e){n._isFetching=!1,t.setError(e).end(),A.l("".concat(n._n,".fetchConfig failed. error:"),e),n._setExpiredTimeOnResponseError(12e4)}))}},{key:"onPushedCloudControlConfig",value:function(e){A.l("".concat(this._n,".onPushedCloudControlConfig")),new M("pushedCloudControlConfig").setMessage("newVersion:".concat(e.version," config:").concat(e.cloudControlConfig)).end(),this._parseCloudControlConfig(e)}},{key:"onCheckTimer",value:function(e){this._canFetchConfig()&&this.fetchConfig()}},{key:"_parseCloudControlConfig",value:function(e){var t=this,n="".concat(this._n,"._parseCloudControlConfig"),o=e.errorCode,i=e.errorMessage,a=e.cloudControlConfig,s=e.version,r=e.expiredTime;if(0===o){if(this._version!==s){var c=null;try{c=JSON.parse(a)}catch(e){this.isPrivateNetWork()||A.e("".concat(n," JSON parse error. cloudControlConfig:"),a)}c&&(this._cloudConfig.clear(),Object.keys(c).forEach(function(e){t._cloudConfig.set(e,c[e])}),this._version=s,this.emitInnerEvent(Uo.CLOUD_CONFIG_UPDATED))}this._expiredTime=Date.now()+1e3*r}else k(o)?(A.l("".concat(n," failed. Invalid message format:"),e),this._setExpiredTimeOnResponseError(36e5)):(A.e("".concat(n," errorCode:").concat(o," errorMessage:").concat(i)),this._setExpiredTimeOnResponseError(12e4))}},{key:"_setExpiredTimeOnResponseError",value:function(e){this._expiredTime=Date.now()+e}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._cloudConfig.clear(),this._expiredTime=0,this._version=0,this._isFetching=!1}}]),xr),Fs=(t(qr,Nn),Ns=f(qr),e(qr,[{key:"start",value:function(){this._recoverGroupChat(),this._recoverC2CChat()}},{key:"_recoverGroupChat",value:function(){var n,o,i,a,s=this,e=this._getLocalConversationList().filter(function(e){return e.type===S.CONV_GROUP&&e.groupProfile.type!==S.GRP_AVCHATROOM}),r=this.get(11),c=[];e.forEach(function(e){var t=e.conversationID,e=e.lastMessage;n=t.replace(S.CONV_GROUP,""),o=r.getLocalLastMessage(t),e&&0!==e.lastSequence&&o?(i=e.lastSequence,o=o.sequence,a=i-o,0<o&&1<=a&&a<300?s._recoverGroupMessage({groupID:n,localLastMessageSequence:o,remoteLastMessageSequence:i}):c.push(n)):c.push(n)}),this._getGroupNotify(c)}},{key:"_recoverC2CChat",value:function(){var n,o,i,a=this,e=this._getLocalConversationList().filter(function(e){return e.type===S.CONV_C2C}),s=this.get(11),r=[Promise.resolve()];e.forEach(function(e){var t=e.conversationID,e=e.lastMessage;n=s.getLocalLastMessage(t),e&&0!==e.lastTime&&n&&(o=e.lastTime,n=n.time,i=o-n,0<n&&1<=i&&i<=600&&r.push(a._recoverC2CMessage({conversationID:t,localLastMessageTime:n,remoteLastMessageTime:o})))}),Promise.all(r).then(function(){A.l("".concat(a._n,"._recoverC2CChat all promise fulfilled, start to sync unread messages")),a.get(19).startSyncOnReconnected()})}},{key:"_getLocalConversationList",value:function(){return this.get(11).getLocalConversationList()}},{key:"_recoverGroupMessage",value:function(e){var r=this,c="".concat(this._n,"._recoverGroupMessage"),u=(A.l("".concat(c," options:"),e),e.groupID),t=e.localLastMessageSequence,l=e.remoteLastMessageSequence;this._getGroupRoamingMessage({groupID:u,sequence:t}).then(function(e){var e=e.data,t=e.complete,n=e.messageList;if(!k(n)){var e=n[0].sequence,o=n.map(function(e){return e.sequence}),o="groupID:".concat(u," pkgLastSequence:").concat(e," remoteLastSequence:").concat(l," complete:").concat(t," sequenceList:").concat(o),i=(A.l("".concat(c," ").concat(o)),e<l&&2!==t&&r._recoverGroupMessage({groupID:u,localLastMessageSequence:e,remoteLastMessageSequence:l}),new M("recoverMessage").setMessage(o).end(),r.get(7));1<n.length&&n.sort(function(e,t){return e.sequence-t.sequence});for(var a=0;a<n.length;a++){var s=n[a];s.from!==S.CONV_SYSTEM?i.onNewGroupMessage({dataList:[s],isInstantMessage:!1,updateUnreadCount:!1}):i.onNewGroupTips({event:s.event,dataList:[s]})}r._getGroupNotify([u])}})}},{key:"_genMultiGroupIDList",value:function(e,t){var n=t&&1<t?t:1,o=e.length,i=[];if(0<o)for(var a=0;a<o;a+=n)i.push(e.slice(a,a+n));return i}},{key:"_getGroupNotify",value:function(e){var t=this._genMultiGroupIDList(e,10);if(0<t.length)for(var n=this.get(7),o=0,i=t.length;o<i;o++)n.getGroupNotify(t[o])}},{key:"_getGroupRoamingMessage",value:function(e){var t=e.groupID,e=e.sequence;return this.req({proto:v.GET_GRP_ROAMING_MSG,data:{groupID:t,count:this.PULL_LIMIT_COUNT,sequence:e+this.PULL_LIMIT_COUNT-1}})}},{key:"_recoverC2CMessage",value:function(e){var i=this,a="".concat(this._n,"._recoverC2CMessage"),s=(A.l("".concat(a," options:"),e),e.conversationID),t=e.localLastMessageTime,r=e.remoteLastMessageTime;return this._getC2CRoamingMessage({conversationID:s,time:t}).then(function(e){var e=e.data,t=e.complete,e=e.messageList;if(!k(e)){var n=e.length,n=(i.get(6).onNewC2CMessage({dataList:e,isInstantMessage:!0}),e[n-1].time),e=e.map(function(e){return e.random}),o=s.replace(S.CONV_C2C,""),o="peerAccount:".concat(o," pkgLastTime:").concat(n," remoteLastTime:").concat(r," complete:").concat(t," randomList:").concat(e);if(A.l("".concat(a," ").concat(o)),new M("recoverMessage").setMessage(o).end(),n<r&&1!==t)return i._recoverC2CMessage({conversationID:s,localLastMessageTime:n,remoteLastMessageTime:r})}})}},{key:"_getC2CRoamingMessage",value:function(e){var t=e.conversationID,e=e.time;return this.req({proto:v.GET_C2C_ROAMING_MSG,data:{peerAccount:t.replace(S.CONV_C2C,""),count:this.PULL_LIMIT_COUNT+1,lastMessageTime:e,direction:1}})}},{key:"reset",value:function(){A.l("".concat(this._n,".reset"))}}]),qr),ws=(e(wr,[{key:"addMessageDelay",value:function(e){e=Ae()-e;0<=e&&this._e2eDelayArray.push(e)}},{key:"_calcAvg",value:function(e,t){if(0===t)return 0;var n=0;return e.forEach(function(e){n+=e}),Ft(n/t,1)}},{key:"_calcCountWithLimit",value:function(e){var t=e.e2eDelayArray,n=e.min,o=e.max;return t.filter(function(e){return n<=e&&e<o}).length}},{key:"_calcPercent",value:function(e,t){e=Ft(e/t*100,2);return e=100<e?100:e}},{key:"_checkE2EDelayException",value:function(e,t){var n,o,i,a=e.filter(function(e){return t<e});0<a.length&&(n=a.length,o=Math.min.apply(Math,T(a)),i=Math.max.apply(Math,T(a)),a=this._calcAvg(a,n),50<(e=Ft(n/e.length*100,2))&&new M("messageE2EDelayException").setMessage("count:".concat(n," min:").concat(o," max:").concat(i," avg:").concat(a," percent:").concat(e)).setLevel("warning").end())}},{key:"getStatResult",value:function(){var e=this._e2eDelayArray.length;if(0===e)return null;var t=T(this._e2eDelayArray),n=this._calcCountWithLimit({e2eDelayArray:t,min:0,max:1}),o=this._calcCountWithLimit({e2eDelayArray:t,min:1,max:3}),i=this._calcPercent(n,e),a=this._calcPercent(o,e),s=this._calcAvg(t,e);return this._checkE2EDelayException(t,3),t.length=0,this.reset(),{totalCount:e,countLessThan1Second:n,percentOfCountLessThan1Second:i,countLessThan3Second:o,percentOfCountLessThan3Second:a,avgDelay:s}}},{key:"reset",value:function(){this._e2eDelayArray.length=0}}]),wr),qs=(e(Fr,[{key:"addRequestCount",value:function(){this._requestCount+=1}},{key:"addRTT",value:function(e){this._rttArray.push(e)}},{key:"_calcTotalCount",value:function(){return this._requestCount}},{key:"_calcRTTCount",value:function(e){return e.length}},{key:"_calcSuccessRateOfRequest",value:function(e,t){if(0===t)return 0;e=Ft(e/t*100,2);return e=100<e?100:e}},{key:"_calcAvg",value:function(e,t){if(0===t)return 0;var n=0;return e.forEach(function(e){n+=e}),parseInt(n/t)}},{key:"_calcMax",value:function(){return Math.max.apply(Math,T(this._rttArray))}},{key:"_calcMin",value:function(){return Math.min.apply(Math,T(this._rttArray))}},{key:"getStatResult",value:function(){var e=this._calcTotalCount(),t=T(this._rttArray);if(0===e)return null;var n=this._calcRTTCount(t),o=this._calcSuccessRateOfRequest(n,e),t=this._calcAvg(t,n);return A.l("".concat(this._n,".getStatResult max:").concat(this._calcMax()," min:").concat(this._calcMin()," avg:").concat(t)),this.reset(),{totalCount:e,rttCount:n,successRateOfRequest:o,avgRTT:t}}},{key:"reset",value:function(){this._requestCount=0,this._rttArray.length=0}}]),Fr),xs=(e(br,[{key:"initMap",value:function(e){var t=this;e.forEach(function(e){t._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]})})}},{key:"addTotalCount",value:function(e){return!(k(e)||!this._map.has(e)||(this._map.get(e).totalCount+=1,0))}},{key:"addSuccessCount",value:function(e){return!(k(e)||!this._map.has(e)||(this._map.get(e).successCount+=1,0))}},{key:"addFailedCountOfUserSide",value:function(e){return!(k(e)||!this._map.has(e)||(this._map.get(e).failedCountOfUserSide+=1,0))}},{key:"addCost",value:function(e,t){return!(k(e)||!this._map.has(e)||(this._map.get(e).costArray.push(t),0))}},{key:"addFileSize",value:function(e,t){return!(k(e)||!this._map.has(e)||(this._map.get(e).fileSizeArray.push(t),0))}},{key:"_calcSuccessRateOfBusiness",value:function(e){if(k(e)||!this._map.has(e))return-1;e=this._map.get(e),e=Ft(e.successCount/e.totalCount*100,2);return e=100<e?100:e}},{key:"_calcSuccessRateOfPlatform",value:function(e){if(k(e)||!this._map.has(e))return-1;var t=this._map.get(e),e=this._calcSuccessCountOfPlatform(e)/t.totalCount*100;return e=100<(e=Ft(e,2))?100:e}},{key:"_calcTotalCount",value:function(e){return k(e)||!this._map.has(e)?-1:this._map.get(e).totalCount}},{key:"_calcSuccessCountOfBusiness",value:function(e){return k(e)||!this._map.has(e)?-1:this._map.get(e).successCount}},{key:"_calcSuccessCountOfPlatform",value:function(e){if(k(e)||!this._map.has(e))return-1;e=this._map.get(e);return e.successCount+e.failedCountOfUserSide}},{key:"_calcAvg",value:function(e){return k(e)||!this._map.has(e)?-1:e===Kn?this._calcAvgSpeed(e):this._calcAvgCost(e)}},{key:"_calcAvgCost",value:function(e){var t=this._map.get(e).costArray.length;if(0===t)return 0;var n=0;return this._map.get(e).costArray.forEach(function(e){n+=e}),parseInt(n/t)}},{key:"_calcAvgSpeed",value:function(e){var t=0,n=0;return this._map.get(e).costArray.forEach(function(e){t+=e}),this._map.get(e).fileSizeArray.forEach(function(e){n+=e}),parseInt(1e3*n/t)}},{key:"getStatResult",value:function(e){var t=this._calcTotalCount(e);if(0===t)return null;var n=this._calcSuccessCountOfBusiness(e),o=this._calcSuccessRateOfBusiness(e),i=this._calcSuccessCountOfPlatform(e),a=this._calcSuccessRateOfPlatform(e),s=this._calcAvg(e);return this.reset(e),{totalCount:t,successCountOfBusiness:n,successRateOfBusiness:o,successCountOfPlatform:i,successRateOfPlatform:a,avgValue:s}}},{key:"reset",value:function(e){k(e)?this._map.clear():this._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]})}}]),br),Vs=(e(Ur,[{key:"initMap",value:function(e){var t=this;e.forEach(function(e){t._lastMap.set(e,new Map),t._currentMap.set(e,new Map)})}},{key:"addMessageSequence",value:function(e){var t=e.key,n=e.message;if(k(t)||!this._lastMap.has(t)||!this._currentMap.has(t))return!1;var o,i,a=n.conversationID,n=n.sequence,a=a.replace(S.CONV_GROUP,"");return 0!==this._lastMap.get(t).size&&this._lastMap.get(t).has(a)?(i=(o=this._lastMap.get(t).get(a)).length-1,n>o[0]&&n<o[i]?(o.push(n),o.sort(),this._lastMap.get(t).set(a,o)):this._addCurrentMap(e)):this._addCurrentMap(e),!0}},{key:"_addCurrentMap",value:function(e){var t=e.key,e=e.message,n=e.conversationID,e=e.sequence,n=n.replace(S.CONV_GROUP,"");this._currentMap.get(t).has(n)||this._currentMap.get(t).set(n,[]),this._currentMap.get(t).get(n).push(e)}},{key:"_copyData",value:function(e){if(!k(e)){this._lastMap.set(e,new Map);var t,n=this._lastMap.get(e),o=N(this._currentMap.get(e));try{for(o.s();!(t=o.n()).done;){var i=I(t.value,2),a=i[0],s=i[1];n.set(a,s)}}catch(e){o.e(e)}finally{o.f()}n=null,this._currentMap.set(e,new Map)}}},{key:"getStatResult",value:function(e){if(k(this._currentMap.get(e))||k(this._lastMap.get(e)))return null;if(0===this._lastMap.get(e).size)return this._copyData(e),null;var o=0,i=0;if(this._lastMap.get(e).forEach(function(e,t){var e=T(e.values()),n=e.length,e=e[n-1]-e[0]+1;o+=e,i+=n}),0===o)return null;var t=Ft(i/o*100,2);return 100<t&&(t=100),this._copyData(e),{totalCount:o,successCountOfMessageReceived:i,successRateOfMessageReceived:t}}},{key:"reset",value:function(){this._currentMap.clear(),this._lastMap.clear()}}]),Ur),Hs=(t(Pr,Nn),Os=f(Pr),e(Pr,[{key:"_onLoginSuccess",value:function(){var t=this,e=(this._rateMessageSent.initMap(this._messageSentItems),this._rateMessageReceived.initMap(this._messageReceivedItems),this.get(13)),n=e.getItem(this.TAG,!1);!We(n)&&$e(n.forEach)&&(A.l("".concat(this._n,"._onLoginSuccess. logs count:").concat(n.length)),n.forEach(function(e){t._statInfoArr.push(e)}),e.removeItem(this.TAG,!1))}},{key:"_onCloudConfigUpdated",value:function(){var e=this.getCloudConfig("q_rpt_interval"),t=this.getCloudConfig("q_rpt_sdkappid_bl"),n=this.getCloudConfig("q_rpt_tinyid_wl");k(e)||(this.REPORT_INTERVAL=Number(e)),k(t)||(this.REPORT_SDKAPPID_BLACKLIST=t.split(",").map(function(e){return Number(e)})),k(n)||(this.REPORT_TINYID_WHITELIST=n.split(","))}},{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&e%this.REPORT_INTERVAL==0&&(this.wholePeriod=!0,this._report())}},{key:"addRequestCount",value:function(){this._avgRTT.addRequestCount()}},{key:"addRTT",value:function(e){this._avgRTT.addRTT(e)}},{key:"addMessageDelay",value:function(e){this._avgE2EDelay.addMessageDelay(e)}},{key:"addTotalCount",value:function(e){this._rateMessageSent.addTotalCount(e)||A.w("".concat(this._n,".addTotalCount invalid key:"),e)}},{key:"addSuccessCount",value:function(e){this._rateMessageSent.addSuccessCount(e)||A.w("".concat(this._n,".addSuccessCount invalid key:"),e)}},{key:"addFailedCountOfUserSide",value:function(e){this._rateMessageSent.addFailedCountOfUserSide(e)||A.w("".concat(this._n,".addFailedCountOfUserSide invalid key:"),e)}},{key:"addCost",value:function(e,t){this._rateMessageSent.addCost(e,t)||A.w("".concat(this._n,".addCost invalid key or cost:"),e,t)}},{key:"addFileSize",value:function(e,t){this._rateMessageSent.addFileSize(e,t)||A.w("".concat(this._n,".addFileSize invalid key or size:"),e,t)}},{key:"addMessageSequence",value:function(e){this._rateMessageReceived.addMessageSequence(e)||A.w("".concat(this._n,".addMessageSequence invalid key:"),e.key)}},{key:"_getQualityItem",value:function(e){var t={},n=Xn[this.get(15).getNetworkType()],n=(k(n)&&(n=8),{qualityType:Jn[e],timestamp:Oe(),networkType:n,extension:""});switch(e){case wn:t=this._avgRTT.getStatResult();break;case qn:t=this._avgE2EDelay.getStatResult();break;case xn:case Vn:case Hn:case Bn:case Kn:t=this._rateMessageSent.getStatResult(e);break;case Wn:case Yn:case jn:t=this._rateMessageReceived.getStatResult(e)}return null===t?null:y(y({},n),t)}},{key:"_report",value:function(e){var t=this,n=[],o=null,e=(k(e)?this._qualityItems.forEach(function(e){null!==(o=t._getQualityItem(e))&&(o.reportIndex=t.reportIndex,o.wholePeriod=t.wholePeriod,n.push(o))}):null!==(o=this._getQualityItem(e))&&(o.reportIndex=this.reportIndex,o.wholePeriod=this.wholePeriod,n.push(o)),A.d("".concat(this._n,"._report"),n),0<this._statInfoArr.length&&(n=n.concat(this._statInfoArr),this._statInfoArr=[]),this.get(12)),i=e.getSDKAppID(),e=e.getTinyID();0<(n=wt(this.REPORT_SDKAPPID_BLACKLIST,i)&&!qt(this.REPORT_TINYID_WHITELIST,e)?[]:n).length&&this._doReport(n)}},{key:"_doReport",value:function(t){var n=this,e={header:ea(this),quality:t};this.req({proto:v.SSO_STAT,data:y({},e)}).then(function(){n.reportIndex++,n.wholePeriod=!1}).catch(function(e){A.w("".concat(n._n,"._doReport failed. error:"),e),n._statInfoArr=n._statInfoArr.concat(t),n._flushAtOnce()})}},{key:"_flushAtOnce",value:function(){var e=this.get(13),t=e.getItem(this.TAG,!1),n=this._statInfoArr,o="".concat(this._n,"._flushAtOnce");We(t)?(A.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)):(10<(n=n.concat(t)).length&&(n=n.slice(0,10)),A.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)),this._statInfoArr=[]}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._report(),this.reportIndex=0,this.wholePeriod=!1,this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._avgRTT.reset(),this._avgE2EDelay.reset(),this._rateMessageSent.reset(),this._rateMessageReceived.reset()}}]),Pr),Bs=e(function e(t){u(this,e),We(t)||(this.userID=t.userID||"",this.nick=t.nick||"",this.avatar=t.avatar||"",this.time=t.time||0,this.source=t.source||"",this.wording=t.wording||"",this.type=t.type||"")}),Ks=(e(Gr,[{key:"getLocalFriendApplicationList",value:function(){return{friendApplicationList:T(this._friendApplicationMap.values()),unreadCount:this._unreadCount}}},{key:"_onFriendApplicationListUpdated",value:function(){this._snsM.emitOuterEvent(G.FRIEND_APPLICATION_LIST_UPDATED,{friendApplicationList:T(this._friendApplicationMap.values()),unreadCount:this._unreadCount})}},{key:"onFriendApplicationRead",value:function(){this._unreadCount=0,this._onFriendApplicationListUpdated()}},{key:"onFriendApplicationAdded",value:function(e,t){var n,o,i=this;We(e)||(n="",n=t===this._snsM.getMyUserID()?S.SNS_APPLICATION_SENT_BY_ME:S.SNS_APPLICATION_SENT_TO_ME,o=!1,e.forEach(function(e){var t="".concat(e.userID,"_").concat(n);n!==S.SNS_APPLICATION_SENT_TO_ME||i._friendApplicationMap.has(t)||(i._unreadCount+=1),i._friendApplicationMap.set(t,new Bs(y(y({},e),{},{type:n}))),o=!0}),o&&this._onFriendApplicationListUpdated())}},{key:"onFriendApplicationDeleted",value:function(e){We(e)||(this._startTime=0,this._currentSequence=0,this.getFriendApplicationList())}},{key:"getFriendApplicationList",value:function(){var a=this,s="".concat(this._n,".").concat("getFriendApplicationList"),r=new M("getFriendApplicationList");return this._snsM.req({proto:v.GET_FD_APPLICATION_LIST,data:{applicationType:S.SNS_APPLICATION_TYPE_BOTH,fromAccount:this._snsM.getMyUserID(),maxLimited:this._maxLimited,startTime:this._startTime,lastSequence:this._currentSequence}}).then(function(e){var e=e.data,t=e.resultList,n=e.unreadCount,o=e.startTime,e=e.currentSequence,i=(a._startTime=o,a._currentSequence=e,a._unreadCount=n,Qe(t)?t.length:0),i="applicationCount:".concat(i," unreadCount:").concat(n," startTime:").concat(o," currentSequence:").concat(e);r.setMessage(i).end(),A.i("".concat(s," ok. ").concat(i)),a._friendApplicationMap.clear(),Qe(t)&&t.forEach(function(e){var t=e.userID,n=e.type,e=new Bs(e);a._friendApplicationMap.set("".concat(t,"_").concat(n),e)}),a._onFriendApplicationListUpdated()}).catch(function(e){return r.setError(e).end(),A.w("".concat(s," failed. error:"),e),m(e)})}},{key:"deleteFriendApplication",value:function(e){var i="".concat(this._n,".").concat("deleteFriendApplication"),a=e.userID,s=e.type;if(s&&(s===S.SNS_APPLICATION_SENT_BY_ME||s===S.SNS_APPLICATION_SENT_TO_ME)||(s=S.SNS_APPLICATION_SENT_TO_ME),!this._friendApplicationMap.has("".concat(a,"_").concat(s)))return m({code:C.FRIEND_APPLICATION_NOT_EXIST});var r=new M("deleteFriendApplication");return r.setMessage("userID:".concat(a," type:").concat(s)),this._snsM.req({proto:v.DEL_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),userIDList:[a],type:s}}).then(function(e){var e=e.data.resultList,t=e[0],n=t.to,o=t.resultCode,t=t.resultInfo;return r.setMoreMessage("resultList:".concat(JSON.stringify(e))).end(),A.i("".concat(i," ok. userID:").concat(a," type:").concat(s)),0===o?yn():m({userID:n,code:o,message:t})}).catch(function(e){return r.setError(e).end(),A.w("".concat(i," failed. error:"),e),m(e)})}},{key:"acceptFriendApplication",value:function(e){var n="".concat(this._n,".").concat("acceptFriendApplication"),o=e.userID,t=e.remark,i=e.tag,a=e.type,s=(a&&(a===S.SNS_APPLICATION_AGREE||a===S.SNS_APPLICATION_AGREE_AND_ADD)||(a=S.SNS_APPLICATION_AGREE_AND_ADD),new M("acceptFriendApplication"));return s.setMessage("userID:".concat(o," type:").concat(a)),this._snsM.req({proto:v.RESPOND_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),responseFriendItem:[{userID:o,remark:t,tag:i,action:a}]}}).then(function(e){s.end();var e=e.data.resultList[0],t=e.resultCode,e=e.resultInfo;if(0!==t)return m({code:t,message:e});A.i("".concat(n," ok. userID:").concat(o," type:").concat(a))}).catch(function(e){return s.setError(e).end(),A.w("".concat(n," failed. error:"),e),m(e)})}},{key:"refuseFriendApplication",value:function(e){var n="".concat(this._n,".").concat("refuseFriendApplication"),o=e.userID,i=new M("refuseFriendApplication");return i.setMessage("userID:".concat(o)),this._snsM.req({proto:v.RESPOND_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),responseFriendItem:[{userID:o,action:"Response_Action_Reject"}]}}).then(function(e){i.end();var e=e.data.resultList[0],t=e.resultCode,e=e.resultInfo;if(0!==t)return m({code:t,message:e});A.i("".concat(n," ok. userID:").concat(o))}).catch(function(e){return i.setError(e).end(),A.w("".concat(n," failed. error:"),e),m(e)})}},{key:"_onFriendApplicationProcessed",value:function(e){var t,n=this;0!==e.length&&(t=!1,e.forEach(function(e){e="".concat(e.to,"_").concat(S.SNS_APPLICATION_SENT_TO_ME);n._friendApplicationMap.has(e)&&(n._friendApplicationMap.delete(e),--n._unreadCount,t=!0)}),this._unreadCount<0&&(this._unreadCount=0),t&&this._onFriendApplicationListUpdated())}},{key:"setFriendApplicationRead",value:function(){var t=this,n="".concat(this._n,".").concat("setFriendApplicationRead"),o=new M("setFriendApplicationRead");return this._snsM.req({proto:v.REPORT_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),latestTimeStamp:Ft(Oe()/1e3,0)}}).then(function(e){o.end(),A.i("".concat(n," ok")),t._unreadCount=0}).catch(function(e){return o.setError(e).end(),A.w("".concat(n," failed. error:"),e),m(e)})}},{key:"reset",value:function(){this._startIndex=0,this._maxLimited=100,this._currentSequence=0,this._unreadCount=0,this._friendApplicationMap.clear()}}]),Gr),Ws=(e(Nr,[{key:"validate",value:function(e){var t,n=!0,o="";if(We(e))return{valid:!1,tips:"empty options"};if(e.profileCustomField)for(var i=e.profileCustomField.length,a=null,s=0;s<i;s++){if(a=e.profileCustomField[s],!pt(a.key)||-1===a.key.indexOf("Tag_Profile_Custom"))return{valid:!1,tips:"The prefix of keys of the custom profile key-value pairs (which is profileCustomField) must be Tag_Profile_Custom"};if(!pt(a.value))return{valid:!1,tips:"The type of values of the custom profile key-value pairs (which is profileCustomField) must be String"}}for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if("profileCustomField"===t)continue;if(We(e[t])&&!pt(e[t])&&!ze(e[t])){o="key:"+t+", invalid value:"+e[t],n=!1;continue}switch(t){case"nick":pt(e[t])||(n=!(o="nick must be a string")),500<at(e[t])&&(o="nick name limited: must less than or equal to ".concat(500," bytes, current size: ").concat(at(e[t])," bytes"),n=!1);break;case"gender":ct(we,e.gender)||(o="key:gender, invalid value:"+e.gender,n=!1);break;case"birthday":ze(e.birthday)||(n=!(o="birthday must be a number"));break;case"location":pt(e.location)||(n=!(o="location must be a string"));break;case"selfSignature":pt(e.selfSignature)||(n=!(o="selfSignature must be a string"));break;case"allowType":ct(xe,e.allowType)||(o="key:allowType, invalid value:"+e.allowType,n=!1);break;case"language":ze(e.language)||(n=!(o="language must be a number"));break;case"avatar":pt(e.avatar)||(n=!(o="avatar must be a string"));break;case"messageSettings":0!==e.messageSettings&&1!==e.messageSettings&&(n=!(o="messageSettings must be 0 or 1"));break;case"adminForbidType":ct(qe,e.adminForbidType)||(o="key:adminForbidType, invalid value:"+e.adminForbidType,n=!1);break;case"level":ze(e.level)||(n=!(o="level must be a number"));break;case"role":ze(e.role)||(n=!(o="role must be a number"));break;default:o="unknown key:"+t+"  "+e[t],n=!1}}return{valid:n,tips:o}}},{key:"update",value:function(e){var t,n="",o=[];this.friendCustomField.forEach(function(e){o.push(e.key)});for(var i=0,a=e.length;i<a;i++)if(n=e[i].tag,t=e[i].value,-1<n.indexOf("Tag_SNS_Custom"))-1<o.indexOf(n)?this.friendCustomField.forEach(function(e){e.key===n&&(e.value=t)}):this.friendCustomField.push({key:n,value:t});else if(-1<n.indexOf("Tag_Profile_Custom")){var s=!1;this.profile.profileCustomField.forEach(function(e){e.key===n&&(e.value=t,s=!0)}),s||this.profile.profileCustomField.push({key:n,value:t})}else switch(n){case be.NICK:this.profile.nick=t;break;case be.GENDER:this.profile.gender=t;break;case be.BIRTHDAY:this.profile.birthday=t;break;case be.LOCATION:this.profile.location=t;break;case be.SELFSIGNATURE:this.profile.selfSignature=t;break;case be.ALLOWTYPE:this.profile.allowType=t;break;case be.LANGUAGE:this.profile.language=t;break;case be.AVATAR:this.profile.avatar=t;break;case be.MESSAGESETTINGS:this.profile.messageSettings=t;break;case be.ADMINFORBIDTYPE:this.profile.adminForbidType=t;break;case be.LEVEL:this.profile.level=t;break;case be.ROLE:this.profile.role=t;break;case Fe.REMARK:this.remark=t;break;case Fe.ADDTIME:this.addTime=t;break;case Fe.GROUP:this.groupList=JSON.parse(JSON.stringify(t));break;case Fe.ADDSOURCE:this.source=t;break;case Fe.ADDWORDING:break;default:A.d("snsProfileItem unkown tag->",e[i].tag)}this.timestamp=Date.now(),o.length=0}},{key:"updateProfile",value:function(e){this.profile=JSON.parse(JSON.stringify(e)),this.timestamp=Date.now()}},{key:"addToGroupList",value:function(e){-1===this.groupList.indexOf(e)&&(this.groupList.push(e),this.count=this.groupList.length)}},{key:"removeFromGroupList",value:function(e){e=this.groupList.indexOf(e);-1<e&&(this.groupList.splice(e,1),this.count=this.groupList.length)}}]),Nr),Ys=(e(Or,[{key:"getLocalFriendList",value:function(){return T(this._friendMap.values())}},{key:"getFriendRemark",value:function(e){return this._friendMap.has(e)?this._friendMap.get(e).remark:""}},{key:"onFriendProfileModified",value:function(e){var o,i=this,e=e.dataList;We(e)||(o=this._snsM.get(11),e.forEach(function(e){var t,n=e.userID,e=e.profileList;i.isMyFriend(n)&&(A.l("".concat(i._n,".onFriendProfileModified. friend account:").concat(n,", profileList:").concat(JSON.stringify(e))),(t=i._friendMap.get(n)).update(e),o.modifyMessageSentByPeer({conversationID:"".concat(S.CONV_C2C).concat(n),latestNick:t.profile.nick,latestAvatar:t.profile.avatar}))}),this._onFriendListUpdated())}},{key:"onFriendAdded",value:function(t){var n=this;0!==t.length&&(A.l("".concat(this._n,".onFriendAdded userIDList:").concat(t)),t.forEach(function(e){n._friendMap.set(e,new Ws(e))}),this.getFriendProfile({userIDList:t}).then(function(e){t.forEach(function(e){var t=n._friendMap.get(e);0<t.groupList.length&&n._snsM.updateWhenFriendAdded({nameList:t.groupList,userID:e})}),n._onFriendListUpdated()}))}},{key:"onFriendDeleted",value:function(e){var n=this;0!==e.length&&(A.l("".concat(this._n,".onFriendDeleted userIDList:").concat(e)),e.forEach(function(e){var t=n._friendMap.get(e);0<t.groupList.length&&n._snsM.updateWhenFriendDeleted({nameList:t.groupList,userID:e}),n._friendMap.delete(e)}),this._onFriendListUpdated())}},{key:"_onFriendListUpdated",value:function(){this._snsM.emitOuterEvent(G.FRIEND_LIST_UPDATED),this._snsM.get(11).checkAndPatchRemark()}},{key:"getFriendProfile",value:function(e){var a=this,t="".concat(this._n,".").concat("getFriendProfile"),e=e.userIDList,s=[],r=[],n=[];if(e.forEach(function(e){var t;a._friendMap.has(e)?(t=a._friendMap.get(e),Date.now()-t.timestamp<a._expirationTime?r.push(t):n.push(e)):s.push({userID:e,code:C.NOT_MY_FRIEND,message:a._snsM.getErrorMessage(C.NOT_MY_FRIEND)})}),0===n.length)return A.i("".concat(t," newUserIDList is empty")),Cn({friendList:r,failureUserIDList:s});var o=new M("getFriendProfile");return o.setMessage("userIDList:".concat(n)),A.i("".concat(t," userIDList:").concat(n)),this._snsM.req({proto:v.GET_FD_PROFILE,data:{fromAccount:this._snsM.getMyUserID(),userIDList:n}}).then(function(e){return o.end(),A.i("".concat(t," ok")),e.data.resultList.forEach(function(e){var t,n=e.to,o=e.resultCode,i=e.resultInfo,e=e.tagValueList;k(o)||0===o?(a._friendMap.has(n)?(t=a._friendMap.get(n)).update(e):(t=new Ws(n,e),a._friendMap.set(n,t)),r.push(t)):s.push({userID:n,code:o,message:i})}),yn({friendList:r,failureUserIDList:s})}).catch(function(e){return o.setError(e).end(),A.w("".concat(t," failed. error:"),e),m(e)})}},{key:"isMyFriend",value:function(e){return this._friendMap.has(e)}},{key:"pagingGetFriendList",value:function(){var s=this,r="".concat(this._n,".").concat("getFriendList"),c=new M("getFriendList"),u=Date.now();this._snsM.req({proto:v.GET_FD_LIST,data:{fromAccount:this._snsM.getMyUserID(),startIndex:this._startIndex,standardSequence:this._standardSequence,customSequence:this._customSequence}}).then(function(e){var e=e.data,t=e.friendCount,n=e.resultList,o=e.nextStartIndex,i=e.standardSequence,a=e.customSequence,e=e.completeFlag,t=(s._startIndex=o,s._standardSequence=i,s._customSequence=a,"friendCount:".concat(t," nextStartIndex:").concat(o," standardSequence:").concat(i," ")+"customSequence:".concat(a," completeFlag:").concat(e," cost:").concat(zt(u)));c.setMessage(t).end(),A.i("".concat(r," ok."),t),We(n)||n.forEach(function(e){var t=e.to,e=e.tagValueList;s._friendMap.set(t,new Ws(t,e))}),0===e?s.pagingGetFriendList():(s._snsM.emitOuterEvent(G.FRIEND_LIST_UPDATED),s._pagingGetFriendProfile())}).catch(function(e){return c.setError(e).end(),A.w("".concat(r," failed. error:"),e),m(e)})}},{key:"_pagingGetFriendProfile",value:function(){var n=this,e=T(this._friendMap.keys()),t=this._snsM.get(4),o=e.length,i=o<=100?1:Math.ceil(o/100);A.l("".concat(this._n,"._pagingGetFriendProfile friendCount:").concat(o," pageCount:").concat(i));for(var a=0;a<i;a++)t.getUserProfile({userIDList:e.slice(100*a,100*(a+1))}).then(function(e){e.data.forEach(function(e){var t=n._friendMap.get(e.userID);t&&t.updateProfile(e)}),n._onFriendListUpdated()})}},{key:"addFriend",value:function(e){var o=this,i="".concat(this._n,".").concat("addFriend");if(this._friendMap.has(e.to))return m({code:C.ALREADY_MY_FRIEND});if(e.wording&&!1===this._snsM.filterProfanity("wording",e))return m({code:C.PROFANITY_FOUND});var t=e.to,n=e.source,a=e.type,s=e.wording,r=e.remark,e=e.groupName,c=a,u=(c&&(c===S.SNS_ADD_TYPE_SINGLE||c===S.SNS_ADD_TYPE_BOTH)||(c=S.SNS_ADD_TYPE_BOTH),new M("addFriend"));return u.setMessage("to:".concat(t," source:").concat(n," type:").concat(c)),this._snsM.req({proto:v.ADD_FD,data:{fromAccount:this._snsM.getMyUserID(),addFriendItem:[{to:t,source:n,wording:s,remark:r,groupName:e}],type:c}}).then(function(e){var e=e.data.resultList,e=(u.setMoreMessage("resultList:".concat(JSON.stringify(e))).end(),e[0]),t=e.to,n=e.resultCode,e=e.resultInfo;return A.i("".concat(i," ok. to:").concat(t," type:").concat(c," code:").concat(n)),k(n)||0===n?yn({userID:t,code:0}):30539===n?yn({userID:t,code:n,message:o._snsM.getErrorMessage(n)}):m({userID:t,code:n,message:o._snsM.getErrorMessage(n)||e})}).catch(function(e){return u.setError(e).end(),A.w("".concat(i," failed. error:"),e),m(e)})}},{key:"deleteFriend",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteFriend"),o=e.userIDList,e=e.type,i=(1e3<o.length&&(A.w("".concat(n," ").concat(Wt(1e3))),o.length=1e3),[]),a=[],s=[];if(o.forEach(function(e){t._friendMap.has(e)?s.push(e):i.push({userID:e,code:C.NOT_MY_FRIEND,message:t._snsM.getErrorMessage(C.NOT_MY_FRIEND)})}),0===s.length)return Cn({successUserIDList:a,failureUserIDList:i});var o=e,r=(o&&(o===S.SNS_DELETE_TYPE_SINGLE||o===S.SNS_DELETE_TYPE_BOTH)||(o=S.SNS_DELETE_TYPE_BOTH),new M("deleteFriend"));return r.setMessage("userIDList:".concat(s," type:").concat(o)),this._snsM.req({proto:v.DEL_FD,data:{fromAccount:this._snsM.getMyUserID(),userIDList:s,type:o}}).then(function(e){r.end(),A.i("".concat(n," ok"));e=e.data.resultList;return We(e)||e.forEach(function(e){var t=e.to,n=e.resultCode,e=e.resultInfo;k(n)||0===n?a.push({userID:t}):i.push({userID:t,code:n,message:e})}),yn({successUserIDList:a,failureUserIDList:i})}).catch(function(e){return r.setError(e).end(),A.w("".concat(n," error:"),e),m(e)})}},{key:"updateFriend",value:function(e){var o=this,t=e.userID,i=e.remark,a=e.friendCustomField;if(!this._friendMap.has(t))return m({code:C.NOT_MY_FRIEND});var s="".concat(this._n,".").concat("updateFriend"),r=new M("updateFriend"),n=(r.setMessage("userID:".concat(t," remark:").concat(i," friendCustomField:").concat(a)),[]);return k(i)||n.push({tag:Fe.REMARK,value:i}),Qe(a)&&0<a.length&&a.forEach(function(e){n.push({tag:e.key,value:e.value})}),this._snsM.req({proto:v.UPDATE_FD,data:{fromAccount:this._snsM.getMyUserID(),updateItem:[{to:t,snsItem:n}]}}).then(function(e){r.end(),A.i("".concat(s," ok"));var e=e.data.resultList[0],t=e.to,n=e.resultCode,e=e.resultInfo;return k(n)||0===n?((t=o._friendMap.get(t))&&(k(i)||(t.remark=i),Qe(a)&&0<a.length&&It(t.friendCustomField,a),o._onFriendListUpdated()),yn(t)):m({code:n,message:e})}).catch(function(e){return r.setError(e).end(),A.w("".concat(s," failed. error:"),e),m(e)})}},{key:"checkFriend",value:function(e){var t="".concat(this._n,".").concat("checkFriend"),n=e.userIDList,o=e.type,s=(o&&(o===S.SNS_CHECK_TYPE_SINGLE||o===S.SNS_CHECK_TYPE_BOTH)||(o=S.SNS_CHECK_TYPE_BOTH),new M("checkFriend"));return s.setMessage("userIDList:".concat(n," type:").concat(o)),this._snsM.req({proto:v.CHECK_FD,data:{fromAccount:this._snsM.getMyUserID(),userIDList:n,type:o}}).then(function(e){s.end(),A.i("".concat(t," ok. userIDList:").concat(n," type:").concat(o));var i=[],a=[],e=e.data.resultList;return Qe(e)&&e.forEach(function(e){var t=e.to,n=e.relation,o=e.resultCode,e=e.resultInfo;k(o)||0===o?i.push({userID:t,code:0,relation:n}):a.push({userID:t,code:o,message:e})}),yn({successUserIDList:i,failureUserIDList:a})}).catch(function(e){return s.setError(e).end(),A.w("".concat(t," failed. error:"),e),m(e)})}},{key:"updateWhenAddedToFriendGroup",value:function(e){var t=this,n=e.name,e=e.userIDList;A.l("".concat(this._n,".updateWhenAddedToFriendGroup groupName:").concat(n," userIDList:").concat(e)),n&&!We(e)&&e.forEach(function(e){t._friendMap.has(e)&&t._friendMap.get(e).addToGroupList(n)})}},{key:"updateWhenRemovedFromFriendGroup",value:function(e){var t=this,n=e.name,e=e.userIDList;A.l("".concat(this._n,".updateWhenRemovedFromFriendGroup groupName:").concat(n," userIDList:").concat(e)),n&&!We(e)&&e.forEach(function(e){t._friendMap.has(e)&&t._friendMap.get(e).removeFromGroupList(n)})}},{key:"reset",value:function(){this._friendMap.clear(),this._startIndex=0,this._standardSequence=0,this._customSequence=0}}]),Or),js=(e(Rr,[{key:"addToUserIDList",value:function(e){-1===this.userIDList.indexOf(e)&&(this.userIDList.push(e),this.count=this.userIDList.length)}},{key:"removeFromUserIDList",value:function(e){e=this.userIDList.indexOf(e);-1<e&&(this.userIDList.splice(e,1),this.count=this.userIDList.length)}}]),Rr),Js=(e(kr,[{key:"getLocalFriendGroupList",value:function(){return T(this._friendGroupMap.values())}},{key:"_emitFriendGroupListUpdated",value:function(){var e=T(this._friendGroupMap.values());this._snsM.emitOuterEvent(G.FRIEND_GROUP_LIST_UPDATED,e)}},{key:"getFriendGroupList",value:function(){var n=this,t="".concat(this._n,".").concat("getFriendGroupList"),o=new M("getFriendGroupList");return this._snsM.req({proto:v.GET_FD_GRP_LIST,data:{fromAccount:this._snsM.getMyUserID()}}).then(function(e){o.end();e=e.data.resultList;We(e)?A.i("".concat(t," ok. friend group count:0")):(A.i("".concat(t," ok. friend group count:").concat(e.length)),n._friendGroupMap.clear(),e.forEach(function(e){var t=new js(e);n._friendGroupMap.set(e.name,t)}),n._emitFriendGroupListUpdated())}).catch(function(e){return o.setError(e).end(),A.w("".concat(t," error:"),e),m(e)})}},{key:"createFriendGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("createFriendGroup"),o=e.name,s=e.userIDList;if(this._friendGroupMap.has(o))return m({code:C.FRIEND_GRP_EXISTED});var r=new M("createFriendGroup");return r.setMessage("name:".concat(o," userIDList:").concat(s)),this._snsM.req({proto:v.CREATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),groupName:[o],userIDList:Qe(s)?s:void 0}}).then(function(e){r.end(),A.l("".concat(n," ok. name:").concat(o," userIDList:").concat(s));var e=e.data.resultList,i=[],a=[],e=(e&&e.forEach(function(e){var t=e.to,n=e.resultCode,o=e.resultInfo;k(n)||0===n?i.push(t):(t={userID:e.to,code:n,message:o},a.push(t))}),new js({name:o,userIDList:i}));return t._friendGroupMap.set(o,e),t._snsM.updateWhenAddedToFriendGroup({name:o,userIDList:i}),t._emitFriendGroupListUpdated(),yn({friendGroup:e,failureUserIDList:a})}).catch(function(e){return r.setError(e).end(),A.w("".concat(n," failed. error:"),e),m(e)})}},{key:"deleteFriendGroup",value:function(e){var n=this,o="".concat(this._n,".").concat("deleteFriendGroup"),i=e.name;if(!this._friendGroupMap.has(i))return m({code:C.FRIEND_GRP_NOT_EXIST});var a=new M("deleteFriendGroup");return a.setMessage("name:".concat(i)),this._snsM.req({proto:v.DEL_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),nameList:[i]}}).then(function(e){a.end(),A.l("".concat(o," ok. name:").concat(i));var t=n._friendGroupMap.get(i);return t&&(n._snsM.updateWhenRemovedFromFriendGroup({name:i,userIDList:t.userIDList}),n._friendGroupMap.delete(i),t.userIDList.length=0),n._emitFriendGroupListUpdated(),yn(t)}).catch(function(e){return a.setError(e).end(),A.w("".concat(o," failed. error:"),e),m(e)})}},{key:"renameFriendGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("renameFriendGroup"),o=e.oldName,i=e.newName;if(!this._friendGroupMap.has(o))return m({code:C.FRIEND_GRP_NOT_EXIST});var a=new M("renameFriendGroup");return a.setMessage("oldName:".concat(o," newName:").concat(i)),this._snsM.req({proto:v.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,newName:i}}).then(function(){var e;return a.end(),A.l("".concat(n," ok. oldName:").concat(o," newName:").concat(i)),t._friendGroupMap.has(o)?((e=t._friendGroupMap.get(o)).name=i,t._friendGroupMap.delete(o),t._friendGroupMap.set(i,e),t._snsM.updateWhenRemovedFromFriendGroup({name:o,userIDList:e.userIDList}),t._snsM.updateWhenAddedToFriendGroup({name:i,userIDList:e.userIDList}),t._emitFriendGroupListUpdated(),yn(e)):yn()}).catch(function(e){return a.setError(e).end(),A.w("".concat(n," failed. error:"),e),m(e)})}},{key:"addToFriendGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("addToFriendGroup"),o=e.name,e=e.userIDList;if(!this._friendGroupMap.has(o))return this._onFriendGroupNotExist(o);var i=new M("addToFriendGroup");return i.setMessage("name:".concat(o," userIDList:").concat(e)),A.l("".concat(n," name:").concat(o," userIDList:").concat(e)),this._snsM.req({proto:v.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,updateGroupItem:e.filter(function(e){return t._snsM.isMyFriend(e)}).map(function(e){return{to:e,updateType:"Update_Type_Add"}})}}).then(function(e){return i.end(),t._onFriendGroupUpdated(o,e)}).catch(function(e){return i.setError(e).end(),A.w("".concat(n," failed. error:"),e),m(e)})}},{key:"removeFromFriendGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("removeFromFriendGroup"),o=e.name,e=e.userIDList;if(!this._friendGroupMap.has(o))return this._onFriendGroupNotExist(o);var i=new M("removeFromFriendGroup");return i.setMessage("name:".concat(o," userIDList:").concat(e)),A.l("".concat(n," name:").concat(o," userIDList:").concat(e)),this._snsM.req({proto:v.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,updateGroupItem:e.filter(function(e){return t._snsM.isMyFriend(e)}).map(function(e){return{to:e,updateType:"Update_Type_Delete"}})}}).then(function(e){return i.end(),t._onFriendGroupUpdated(o,e)}).catch(function(e){return i.setError(e).end(),A.w("".concat(n," failed. error:"),e),m(e)})}},{key:"_onFriendGroupUpdated",value:function(e,t){var t=t.data.resultList,a=this._friendGroupMap.get(e),s=[],r=[],c=[];return Qe(t)&&t.forEach(function(e){var t=e.to,n=e.resultCode,o=e.resultInfo,i=e.type;0===n?"Update_Type_Add"===i?a&&(a.addToUserIDList(t),r.push(t)):"Update_Type_Delete"===i&&a&&(a.removeFromUserIDList(t),c.push(t)):s.push({to:e.to,code:n,message:o})}),A.l("".concat(this._n,"._onFriendGroupUpdated name:").concat(e," userIDList:").concat(a.userIDList)),0<r.length&&this._snsM.updateWhenAddedToFriendGroup({name:e,userIDList:r}),0<c.length&&this._snsM.updateWhenRemovedFromFriendGroup({name:e,userIDList:c}),yn({friendGroup:a,failureUserIDList:s})}},{key:"updateWhenFriendAdded",value:function(e){var t=this,n=e.nameList,o=e.userID;A.l("".concat(this._n,".updateWhenFriendAdded userID:").concat(o," nameList:").concat(n)),We(n)||n.forEach(function(e){t._friendGroupMap.has(e)&&t._friendGroupMap.get(e).addToUserIDList(o)})}},{key:"updateWhenFriendDeleted",value:function(e){var t=this,n=e.nameList,o=e.userID;A.l("".concat(this._n,".updateWhenFriendDeleted userID:").concat(o," nameList:").concat(n)),We(n)||n.forEach(function(e){t._friendGroupMap.has(e)&&t._friendGroupMap.get(e).removeFromUserIDList(o)})}},{key:"reset",value:function(){this._friendGroupMap.clear()}}]),kr),zs=(t(Ar,Nn),Rs=f(Ar),e(Ar,[{key:"onContextUpdated",value:function(e){this._friendHandler.pagingGetFriendList(),this._friendGroupHandler.getFriendGroupList(),this._friendApplicationHandler.getFriendApplicationList()}},{key:"onRelationChainModified",value:function(e){var n,o,i,a,s,r,c=this,e=e.dataList;We(e)||(n=[],o=[],i=[],s=!(a=[]),r="",e.forEach(function(e){var t;3!==e.pushType&&4!==e.pushType||!e.from||(r=e.from),e.friendAddAccount&&(n.push.apply(n,T(e.friendAddAccount)),a.push.apply(a,T(e.friendAddAccount))),e.friendDelAccount&&o.push.apply(o,T(e.friendDelAccount)),e.friendApplicationAdded&&i.push.apply(i,T(e.friendApplicationAdded)),e.friendApplicationDeletedUserIDList&&a.push.apply(a,T(e.friendApplicationDeletedUserIDList)),e.reportTime&&7===e.pushType&&(s=!0),e.friendUpInfo&&(t={dataList:[]},e.friendUpInfo.forEach(function(e){t.dataList.push({userID:e.friendAccount,profileList:T(e.sns)})}),c.onFriendProfileModified(t))}),s&&this._friendApplicationHandler.onFriendApplicationRead(),this._friendApplicationHandler.onFriendApplicationAdded(i,r),this._friendApplicationHandler.onFriendApplicationDeleted(a),this._friendHandler.onFriendAdded(n),this._friendHandler.onFriendDeleted(o))}},{key:"isMyFriend",value:function(e){return this._friendHandler.isMyFriend(e)}},{key:"filterProfanity",value:function(e,t){var n=this.get(29);if(!n)return!0;var n=n.filterText(t[e],"sns"),o=n.isAllowedToSend,n=n.modifiedText;return!0===o&&(t[e]=n,!0)}},{key:"onFriendProfileModified",value:function(e){this._friendHandler.onFriendProfileModified(e)}},{key:"getLocalFriendList",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=this._friendHandler.getLocalFriendList();return e?Cn(t):t}},{key:"getFriendRemark",value:function(e){return this._friendHandler.getFriendRemark(e)}},{key:"getFriendList",value:function(){return this._friendHandler.pagingGetFriendList()}},{key:"addFriend",value:function(e){return this._friendHandler.addFriend(e)}},{key:"deleteFriend",value:function(e){return this._friendHandler.deleteFriend(e)}},{key:"checkFriend",value:function(e){return this._friendHandler.checkFriend(e)}},{key:"getFriendProfile",value:function(e){return this._friendHandler.getFriendProfile(e)}},{key:"updateFriend",value:function(e){return this._friendHandler.updateFriend(e)}},{key:"updateWhenAddedToFriendGroup",value:function(e){this._friendHandler.updateWhenAddedToFriendGroup(e)}},{key:"updateWhenRemovedFromFriendGroup",value:function(e){this._friendHandler.updateWhenRemovedFromFriendGroup(e)}},{key:"getLocalFriendApplicationList",value:function(){var e=this._friendApplicationHandler.getLocalFriendApplicationList();return Cn(e)}},{key:"deleteFriendApplication",value:function(e){return this._friendApplicationHandler.deleteFriendApplication(e)}},{key:"refuseFriendApplication",value:function(e){return this._friendApplicationHandler.refuseFriendApplication(e)}},{key:"acceptFriendApplication",value:function(e){return this._friendApplicationHandler.acceptFriendApplication(e)}},{key:"setFriendApplicationRead",value:function(e){return this._friendApplicationHandler.setFriendApplicationRead(e)}},{key:"getLocalFriendGroupList",value:function(){var e=this._friendGroupHandler.getLocalFriendGroupList();return Cn(e)}},{key:"createFriendGroup",value:function(e){return this._friendGroupHandler.createFriendGroup(e)}},{key:"deleteFriendGroup",value:function(e){return this._friendGroupHandler.deleteFriendGroup(e)}},{key:"addToFriendGroup",value:function(e){return this._friendGroupHandler.addToFriendGroup(e)}},{key:"removeFromFriendGroup",value:function(e){return this._friendGroupHandler.removeFromFriendGroup(e)}},{key:"renameFriendGroup",value:function(e){return this._friendGroupHandler.renameFriendGroup(e)}},{key:"onAddToFriendGroup",value:function(e){return this._friendGroupHandler.onAddToFriendGroup(e)}},{key:"updateWhenFriendAdded",value:function(e){this._friendGroupHandler.updateWhenFriendAdded(e)}},{key:"updateWhenFriendDeleted",value:function(e){this._friendGroupHandler.updateWhenFriendDeleted(e)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._friendHandler.reset(),this._friendGroupHandler.reset(),this._friendApplicationHandler.reset()}}]),Ar),Xs=(t(Sr,Nn),ks=f(Sr),e(Sr,[{key:"isWorkerEnabled",value:function(){return this._isWorkerEnabled&&ve}},{key:"startWorkerTimer",value:function(){A.l("".concat(this._n,".startWorkerTimer")),this._workerTimer&&this._workerTimer.postMessage("start")}},{key:"stopWorkerTimer",value:function(){A.l("".concat(this._n,".stopWorkerTimer")),this._workerTimer&&this._workerTimer.postMessage("stop")}},{key:"_init",value:function(){var e,t;ve&&(e=URL.createObjectURL(new Blob(['let interval = -1;onmessage = function(event) {  if (event.data === "start") {    if (interval > 0) {      clearInterval(interval);    }    interval = setInterval(() => {      postMessage("");    }, 1000);    postMessage(interval);  } else if (event.data === "stop") {    clearInterval(interval);    interval = -1;  }};'],{type:"application/javascript; charset=utf-8"})),this._workerTimer=new Worker(e),(t=this)._workerTimer.onmessage=function(e){e.data?(t._timerID=e.data,A.l("".concat(t._n,"._init seed:").concat(t._timerID))):t._m.onCheckTimer()})}},{key:"_onCloudConfigUpdated",value:function(){var e=this.getCloudConfig("enable_worker");A.l("".concat(this._n,"._onCloudConfigUpdated enableWorker:").concat(e)),k(e)||"1"===e?!this._isWorkerEnabled&&ve&&(this._isWorkerEnabled=!0,this.startWorkerTimer(),this._m.onWorkerTimerEnabled()):this._isWorkerEnabled&&ve&&(this._isWorkerEnabled=!1,this.stopWorkerTimer(),this._m.onWorkerTimerDisabled())}},{key:"terminate",value:function(){A.l("".concat(this._n,".terminate")),this._workerTimer&&(this._workerTimer.terminate(),this._workerTimer=null,this._timerID=-1)}},{key:"getTimerID",value:function(){return this._timerID}},{key:"reset",value:function(){A.l("".concat(this._n,".reset"))}}]),Sr),Zs=(e(Lr,[{key:"isValidPurchaseBits",value:function(e){return e&&"string"==typeof e&&1<=e.length&&e.length<=64&&/[01]{1,64}/.test(e)}},{key:"parsePurchaseBits",value:function(e){if(this.isValidPurchaseBits(e)){this._featureMap.clear();for(var t,n=e.length-1,o=0;0<=n;n--,o++)t=(o<32?new b(0,Math.pow(2,o)):new b(Math.pow(2,o-32),0)).toString(),"1"===e[n]?this._featureMap.set(t,!0):this._featureMap.set(t,!1)}else A.w("".concat(this._n,".parsePurchaseBits invalid purchasebits:").concat(e))}},{key:"hasPurchasedFeature",value:function(e){return!!this._featureMap.get(e)}},{key:"isFeatureEnabled",value:function(e){for(var t=parseInt(e).toString(2),n=void 0,o=!0,i=t.length-1,a=0;0<=i;i--,a++)if("1"===t.charAt(i)&&(n=(a<32?new b(0,Math.pow(2,a)):new b(Math.pow(2,a-32),0)).toString(),!this._featureMap.get(n))){o=!1;break}return A.l("".concat(this._n,".isFeatureEnabled decimalNumber:").concat(e," key:").concat(n," ret:").concat(o)),Cn({enabled:o})}},{key:"isFeatureEnabledForStat",value:function(e){for(var t=parseInt(e).toString(2),n=t.length-1,o=0;0<=n;n--,o++)if("1"===t.charAt(n)){if(i=(o<32?new b(0,Math.pow(2,o)):new b(Math.pow(2,o-32),0)).toString(),!this._featureMap.get(i))break;var i,a="",s=0;i===H.PLUGIN_TRANSLATE?(a="plugin_translate",s=16):i===H.PLUGIN_VOICE_TO_TEXT?(a="plugin_voice_to_text",s=17):i===H.PLUGIN_CS?(a="plugin_cs",s=14):i===H.PLUGIN_PUSH?(a="plugin_push",s=13):i===H.PLUGIN_BOT?(a="plugin_bot",s=15):i===H.MSG_REACTION&&(a="plugin_emoji_reaction",s=18),""!==a&&(i=this._commercialConfigM.get(12).getUIPlatform(),new M(a).setCode(s).setUIPlatform(i).end(),A.l("".concat(this._n,".isFeatureEnabledForStat ").concat(a," code:").concat(s," uiPlatform:").concat(i)))}}},{key:"isSearchCloudMessagesEnabled",value:function(){var e;this._isSCMReported||(e=this._commercialConfigM.get(12).getUIPlatform(),new M("plugin_search").setCode(6).setUIPlatform(e).end(),this._isSCMReported=!0)}},{key:"clear",value:function(){this._featureMap.clear(),this._isSCMReported=!1}}]),Lr),Qs=(e(Er,[{key:"_canFetch",value:function(){return this.get(12).isLoggedIn()?!this._isFetching&&Date.now()>=this._expiredTime:(this._expiredTime=Date.now()+2e3,!1)}},{key:"onCheckTimer",value:function(e){this._canFetch()&&this.fetchConfig()}},{key:"fetchConfig",value:function(){var t,e,n=this,o=this._canFetch(),i="".concat(this._n,".fetchConfig");A.l("".concat(i," canFetch:").concat(o)),o&&(t=new M("fetchCommercialConfig"),o=this.get(12).getSDKAppID(),e=this.get(20),this._isFetching=!0,e.req({proto:v.FETCH_COMMERCIAL_CONFIG,data:{SDKAppID:o}}).then(function(e){t.setMessage("purchaseBits:".concat(e.data.purchaseBits)).end(),A.l("".concat(i," ok.")),n._parseConfig(e.data),n._isFetching=!1}).catch(function(e){t.setError(e).end(),n._isFetching=!1}))}},{key:"onPushedConfig",value:function(e){var t="".concat(this._n,".onPushedConfig data:").concat(JSON.stringify(e));A.l("".concat(t)),new M("pushedCommercialConfig").setMessage("purchaseBits:".concat(e.purchaseBits)).end(),this._parseConfig(e)}},{key:"_parseConfig",value:function(e){var t="".concat(this._n,"._parseConfig"),n=e.errorCode,o=e.errorMessage,i=e.purchaseBits,a=e.expiredTime;0===n?(this._purchasedFeatureHandler.parsePurchaseBits(i),this._expiredTime=Date.now()+1e3*a):k(n)?(A.l("".concat(t," failed. Invalid message format:"),e),this._setExpiredTimeOnResponseError(36e5)):(A.e("".concat(t," errorCode:").concat(n," errorMessage:").concat(o)),this._setExpiredTimeOnResponseError(12e4))}},{key:"_setExpiredTimeOnResponseError",value:function(e){this._expiredTime=Date.now()+e}},{key:"canIUse",value:function(e){return this._purchasedFeatureHandler.hasPurchasedFeature(e)}},{key:"isFeatureEnabled",value:function(e){return this._purchasedFeatureHandler.isFeatureEnabled(e)}},{key:"isFeatureEnabledForStat",value:function(e){this._purchasedFeatureHandler.isFeatureEnabledForStat(e)}},{key:"isSearchCloudMessagesEnabled",value:function(){this._purchasedFeatureHandler.isSearchCloudMessagesEnabled()}},{key:"get",value:function(e){return this._m.get(e)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler.clear()}}]),Er),$s=(t(Dr,Nn),As=f(Dr),e(Dr,[{key:"registerPlugin",value:function(e){var t,n,o,i,a,s,r,c,l,d,p,_,u;$?(this._offlinePushPlugin=e["tim-offline-push-plugin"],t=(u=e.offlinePushConfig||{}).huaweiBusinessID,n=u.xiaomiBusinessID,o=u.xiaomiAppID,i=u.xiaomiAppKey,a=u.meizuBusinessID,s=u.meizuAppID,r=u.meizuAppKey,c=u.vivoBusinessID,l=u.oppoBusinessID,d=u.oppoAppKey,p=u.oppoAppSecret,_=u.honorBusinessID,u=u.iosBusinessID,this._androidPushConfig.huaweiPushBussinessId=t,this._androidPushConfig.xiaomiPushBussinessId=n,this._androidPushConfig.xiaomiPushAppId=o,this._androidPushConfig.xiaomiPushAppKey=i,this._androidPushConfig.meizuPushBussinessId=a,this._androidPushConfig.meizuPushAppId=s,this._androidPushConfig.meizuPushAppKey=r,this._androidPushConfig.vivoPushBussinessId=c,this._androidPushConfig.oppoPushBussinessId=l,this._androidPushConfig.oppoPushAppKey=d,this._androidPushConfig.oppoPushAppSecret=p,this._androidPushConfig.honorPushBussinessId=_,new M("registerPlugin").setMessage("tim-offline-push-plugin").setMoreMessage("isExist:".concat(!k(this._offlinePushPlugin))).end(!0),A.l("".concat(this._n,".").concat("registerPlugin"," ok. offlinePushConfig:").concat(JSON.stringify(e.offlinePushConfig))),this._iosBusinessID=u,this._setAppShowListener()):this.outputWarning("OfflinePushInUniapp")}},{key:"init",value:function(){this._isWebUniapp=this.getUniAppPlatform(),this._getDeviceToken()}},{key:"_getDeviceToken",value:function(){var c,u=this,l="".concat(this._n,".").concat("_getDeviceToken");$e(this._offlinePushPlugin.getDeviceToken)?(c="androidPushConfig:".concat(JSON.stringify(this._androidPushConfig),", iosBusinessID:").concat(this._iosBusinessID),A.l("".concat(l," start. ").concat(c)),new M("_getDeviceToken").setMessage("".concat(c)).end(!0),this._offlinePushPlugin.getDeviceToken(this._androidPushConfig,function(e){var t,n,o,i,a=new M("getDeviceTokenRes"),s=e.code,r=e.msg;0===s?(t=(i=e.data).deviceToken,n=i.deviceBrand,o=i.deviceType,i=i.bussinessId,u._deviceToken=t,u._businessID=i||u._iosBusinessID,c="deviceToken:".concat(t,", deviceBrand:").concat(n||o,", businessID:").concat(u._businessID),A.l("".concat(l," ok. ").concat(c)),a.setMessage(c).end(!0),u._setToken()):(a.setMessage("code:".concat(s,", msg:").concat(r)).end(!0),A.e("".concat(l," failed. error:"),e))})):A.e("".concat(l," getDeviceToken is not a function"))}},{key:"canIUseOfflinePush",value:function(){return $&&!k(this._offlinePushPlugin)}},{key:"_setAppShowListener",value:function(){var t=this,n="".concat(this._n,".").concat("_setAppShowListener");k(this._offlinePushPlugin)?A.e("".concat(n," offlinePushPlugin is undefined")):$e(this._offlinePushPlugin.setAppShowListener)?(new M("_setAppShowListener").end(!0),A.l("".concat(n," start")),this._offlinePushPlugin.setAppShowListener(function(e){e=(e||{}).appShow;new M("setAppShowListenerRes").setMessage("appShow:".concat(e)).end(!0),A.l("".concat(n," ok. appShow:").concat(e)),t._m.isReady()&&(0===e?(t._getConvUnreadCount(),t._onBackground()):1===e&&t._onForeground())})):A.e("".concat(n," setAppShowListener is not a function"))}},{key:"getDeviceBrand",value:function(){var e;if(!k(this._offlinePushPlugin)&&$e(this._offlinePushPlugin.getDeviceType))return e=(this._offlinePushPlugin.getDeviceType()||{}).deviceType,A.l("".concat(this._n,".getDeviceBrand ok. deviceType:").concat(e)),e}},{key:"_setToken",value:function(){var t="".concat(this._n,"._setToken"),e=this.get(12),n=1,o="",i="",a=(We(this._deviceToken)&&(n=0),this.getUniAppPlatform()),s=this.getDeviceBrand(),r=(a===w.IOS||a===w.IPAD||a===w.MAC?i=this._deviceToken:a===w.ANDROID&&(o=this._deviceToken),new M("offlinePushSetToken")),a="deviceToken:".concat(i||o,", businessID:").concat(this._businessID,", ")+"deviceBrand:".concat(s,", isWebUniapp:").concat(this._isWebUniapp,", pushMsg:").concat(n,", platform:").concat(a);return r.setMessage("".concat(a)),A.l("".concat(t," ").concat(a)),this.req({proto:v.SET_TOKEN,data:{tokenID:o,pushMsg:n,sdkAppID:e.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:s,deviceToken:i,isWebUniapp:this._isWebUniapp}}).then(function(e){return r.end(),A.l("".concat(t," ok")),e}).catch(function(e){return r.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"_getConvUnreadCount",value:function(){var t=this;this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(11).getLocalConversationList().forEach(function(e){e.type===S.CONV_C2C&&(t._c2cUnreadCount+=e.unreadCount),e.type===S.CONV_GROUP&&(t._groupUnreadCount+=e.unreadCount)})}},{key:"_onBackground",value:function(){var t=this,n="".concat(this._n,".").concat("_onBackground"),o=new M("_onBackground");this.req({proto:v.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then(function(e){return o.setMessage("c2cUnreadCount: ".concat(t._c2cUnreadCount,", groupUnreadCount: ").concat(t._groupUnreadCount)).end(),A.l("".concat(n," ok")),e}).catch(function(e){o.setError(e).end(),A.e("".concat(n," failed. error:"),e)})}},{key:"_onForeground",value:function(){var t="".concat(this._n,".").concat("_onForeground"),n=new M("_onForeground");this.req({proto:v.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then(function(e){return n.end(),A.l("".concat(t," ok")),e}).catch(function(e){n.setError(e).end(),A.e("".concat(t," failed. error:"),e)})}},{key:"getUniAppPlatform",value:function(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return"ios"===e?w.IOS:"android"===e?w.ANDROID:1002===t?w.IPAD:1001===t?w.MAC:void 0}},{key:"reset",value:function(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,A.l("".concat(this._n,".reset"))}}]),Dr),er=(t(Tr,Nn),Ss=f(Tr),e(Tr,[{key:"registerPlugin",value:function(e){var t,n,o;$?(t="".concat(this._n,".").concat("registerPlugin"),this._pushPlugin=e["tim-push"],this._getDeviceInfo(),n=(o=e.pushConfig||{}).androidConfig,o=o.iOSConfig,Xe(n)&&(this._androidPushConfig=n[this._deviceInfo.packageName]),n=(o||{}).iOSBusinessID,this._iOSBusinessID=n,o=!k(this._pushPlugin),new M("registerPlugin").setMessage(this._pluginName).setMoreMessage("isExisted:".concat(o)).end(!0),A.l("".concat(t," ok. pushConfig:").concat(JSON.stringify(e.pushConfig))),o?(this._setAppShowListener(),this._setPushEventReportListener()):A.e("".concat(t," ").concat(this._pluginName," is undefined"))):this.outputWarning("TIMPushInUniapp")}},{key:"init",value:function(){this._isWebUniapp=this.getUniAppPlatform(),this._reportEventCacheList(),this._getDeviceToken(),this.get(27).isFeatureEnabledForStat(Math.pow(2,41))}},{key:"_reportEventCacheList",value:function(){var a=this,s="".concat(this._n,".").concat("_reportEventCacheList");$e(this._pushPlugin.getPushEventCacheList)?(new M("_reportEventCacheList").end(!0),this._pushPlugin.getPushEventCacheList(function(e){var t=e.code,n=e.data.eventList,o=new M("getPushEventCacheListRes");if(o.setCode(t),0!==t)o.setMessage("res:".concat(JSON.stringify(e))).end(!0),A.e("".concat(s," failed. error:").concat(JSON.stringify(e)));else{t=n.length<10?"eventList:".concat(JSON.stringify(n)):"eventList.length:".concat(n.length);A.l("".concat(s," ok. ").concat(t)),o.setMessage(t).end(!0);for(var i=y(y({},e.data),{},{eventList:[]});0<n.length;)i.eventList=n.splice(0,40),a._pushReport(i)}})):A.e("".concat(this._pluginName,".getPushEventCacheList is not a function"))}},{key:"_getDeviceToken",value:function(){var r,c=this,u="".concat(this._n,".").concat("_getDeviceToken");$e(this._pushPlugin.getDeviceToken)?(r="androidPushConfig:".concat(JSON.stringify(this._androidPushConfig)," iOSBusinessID:").concat(this._iOSBusinessID),A.l("".concat(u," start. ").concat(r)),new M("_getDeviceToken").setMessage("".concat(r)).end(!0),this._pushPlugin.getDeviceToken(this._androidPushConfig,function(e){var t,n,o,i=e.code,a=e.msg,s=new M("getDeviceTokenRes");if(s.setCode(i),0===i)return t=(i=e.data).deviceToken,n=i.deviceBrand,o=i.deviceType,i=i.bussinessId,c._deviceToken=t,c._businessID=i||c._iOSBusinessID,r="deviceToken:".concat(t," deviceBrand:").concat(n||o," businessID:").concat(c._businessID),A.l("".concat(u," ok. ").concat(r)),s.setMessage(r).end(!0),void c._setToken();s.setMessage(a).end(!0),A.e("".concat(u," failed. error:").concat(JSON.stringify(e)))})):A.e("".concat(this._pluginName,".getDeviceToken is not a function"))}},{key:"_getDeviceInfo",value:function(){var e="".concat(this._n,".").concat("_getDeviceInfo");if($e(this._pushPlugin.getDeviceInfo)){var t=this._pushPlugin.getDeviceInfo(),n=t.code,o=t.data,i=new M("_getDeviceInfo");if(i.setCode(n),0===n)return this._deviceInfo=y(y({},this._deviceInfo),o),this._deviceInfo.pushVersion||(this._deviceInfo.pushVersion="1.0.1"),n="deviceInfo:".concat(JSON.stringify(this._deviceInfo)),A.l("".concat(e," ok. ").concat(n)),void i.setMessage(n).end(!0);i.setMessage("deviceInfoRes:".concat(JSON.stringify(t))).end(!0),A.e("".concat(e," failed. error:").concat(JSON.stringify(t)))}else A.e("".concat(this._pluginName,".getDeviceInfo is not a function"))}},{key:"canIUseTIMPush",value:function(){return $&&!k(this._pushPlugin)}},{key:"_setAppShowListener",value:function(){var t=this,n="".concat(this._n,".").concat("_setAppShowListener");$e(this._pushPlugin.setAppShowListener)?(new M("_setAppShowListener").end(!0),A.l("".concat(n," start")),this._pushPlugin.setAppShowListener(function(e){e=(e||{}).appShow;new M("setAppShowListenerRes").setMessage("appShow:".concat(e)).end(!0),A.l("".concat(n," ok. appShow:").concat(e)),t._m.isReady()&&(0===e?(t._getConvUnreadCount(),t._onBackground()):1===e&&t._onForeground())})):A.e("".concat(this._pluginName,".setAppShowListener is not a function"))}},{key:"_setPushEventReportListener",value:function(){var a=this,s="".concat(this._n,".").concat("_setPushEventReportListener");$e(this._pushPlugin.setPushEventReportListener)?(new M("_setPushEventReportListener").end(!0),this._pushPlugin.setPushEventReportListener(function(e){var t=e.code,n=e.data,o=n.eventList,i=new M("setPushEventReportListenerRes");if(i.setCode(t),0===t)return t="eventList:".concat(JSON.stringify(o)),A.l("".concat(s," ok. ").concat(t)),i.setMessage(t).end(!0),void(a._m.isReady()&&Qe(o)&&0<o.length&&a._pushReport(n));i.setMessage("res:".concat(JSON.stringify(e))).end(!0),A.e("".concat(s," failed. error:").concat(JSON.stringify(e)))})):A.e("".concat(this._pluginName,".setPushEventReportListener is not a function"))}},{key:"getDeviceBrand",value:function(){var e;if(!k(this._pushPlugin)&&$e(this._pushPlugin.getDeviceType))return e=(this._pushPlugin.getDeviceType()||{}).deviceType,A.l("".concat(this._n,".getDeviceBrand ok. deviceType:").concat(e)),e}},{key:"_setToken",value:function(){var t="".concat(this._n,".").concat("_setToken"),e=this.get(12),n=1,o="",i="",a=(We(this._deviceToken)&&(n=0),this.getUniAppPlatform()),s=this.getDeviceBrand(),a=(a===w.IOS||a===w.IPAD||a===w.MAC?i=this._deviceToken:a===w.ANDROID&&(o=this._deviceToken),y({tokenID:o,pushMsg:n,sdkAppID:e.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:s,deviceToken:i,isWebUniapp:this._isWebUniapp},this._deviceInfo)),r=new M("_setToken"),o="data:".concat(JSON.stringify(a));r.setMessage("".concat(o)),A.l("".concat(t," ").concat(o)),this.req({proto:v.SET_TOKEN,data:a}).then(function(){r.end(),A.w("".concat(t," ok"))}).catch(function(e){r.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"_getConvUnreadCount",value:function(){var t=this;this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(11).getLocalConversationList().forEach(function(e){e.type===S.CONV_C2C&&(t._c2cUnreadCount+=e.unreadCount),e.type===S.CONV_GROUP&&(t._groupUnreadCount+=e.unreadCount)})}},{key:"_onBackground",value:function(){var e=this,t="".concat(this._n,".").concat("_onBackground"),n=new M("_onBackground");this.req({proto:v.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then(function(){n.setMessage("c2cUnreadCount:".concat(e._c2cUnreadCount," groupUnreadCount:").concat(e._groupUnreadCount)).end(),A.l("".concat(t," ok"))}).catch(function(e){n.setError(e).end(),A.e("".concat(t," failed. error:"),e)})}},{key:"_onForeground",value:function(){var t="".concat(this._n,".").concat("_onForeground"),n=new M("_onForeground");this.req({proto:v.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then(function(){n.end(),A.l("".concat(t," ok"))}).catch(function(e){n.setError(e).end(),A.e("".concat(t," failed. error:"),e)})}},{key:"_pushReport",value:function(e){var t=this,n="".concat(this._n,".").concat("_pushReport"),o=new M("_pushReport");this.req({proto:v.PUSH_REPORT,data:{eventList:e.eventList}}).then(function(){o.end(),t._notifyReportSuccess(e)}).catch(function(e){o.setError(e).end(),A.e("".concat(n," failed. error:"),e)})}},{key:"_notifyReportSuccess",value:function(e){!k(this._pushPlugin)&&$e(this._pushPlugin.notifyReportSuccess)&&(this._pushPlugin.notifyReportSuccess(e),A.l("".concat(this._n,"._notifyReportSuccess ok")))}},{key:"getUniAppPlatform",value:function(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return"ios"===e?w.IOS:"android"===e?w.ANDROID:1002===t?w.IPAD:1001===t?w.MAC:void 0}},{key:"reset",value:function(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,A.l("".concat(this._n,".reset"))}}]),Tr),tr=(t(Cr,Nn),Ls=f(Cr),e(Cr,[{key:"init",value:function(){var e=this.get(18).getPlugin("tim-profanity-filter-plugin");e&&(this._plugin=new e({logger:A,isArray:Qe,isMap:Ye,isDevMode:this.isDevMode()}),this._getLexicon())}},{key:"onCheckTimer",value:function(){this._plugin&&this._canIUseLexicon&&this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime&&this._getLexicon()}},{key:"filterMessage",value:function(e,t){var n=!0;if(!this._plugin||!this._canIUseLexicon)return n;if(t&&t.messageControlInfo&&!0===t.messageControlInfo.excludedFromContentModeration)return n;var t=e.type,o=e.conversationType;if(t!==S.MSG_TEXT&&t!==S.MSG_CUSTOM)return n;var i,a="".concat(this._n,".filterMessage");if(A.l("".concat(a)),t===S.MSG_TEXT){if(o===S.CONV_C2C?i="c2c_text_message":o===S.CONV_GROUP&&(i="group_text_message"),!this._isConfigOn(i))return n;var s=this._plugin.filter(e.payload.text),r=s.type,s=s.modifiedText;1===r?n=!1:2===r&&(e.payload.text=s)}else if(t===S.MSG_CUSTOM){if(o===S.CONV_C2C?i="c2c_custom_message":o===S.CONV_GROUP&&(i="group_custom_message"),!this._isConfigOn(i))return n;r=this._plugin.filter(e.payload.data),s=this._plugin.filter(e.payload.description),t=this._plugin.filter(e.payload.extension);1===r.type||1===s.type||1===t.type?n=!1:(2===r.type&&(e.payload.data=r.modifiedText),2===s.type&&(e.payload.description=s.modifiedText),2===t.type&&(e.payload.extension=t.modifiedText))}return A.l("".concat(a," done. isAllowedToSend:").concat(n)),n}},{key:"filterText",value:function(e,t){var n="".concat(this._n,".filterText"),o={isAllowedToSend:!0,modifiedText:e};if(!this._plugin||!this._canIUseLexicon)return o;if(!this._isConfigOn(t))return o;A.l("".concat(n));t=this._plugin.filter(e),e=t.type,t=t.modifiedText;return 1===e?o.isAllowedToSend=!1:2===e&&(o.modifiedText=t),A.l("".concat(n," done. ret:"),o),o}},{key:"_getLexicon",value:function(){var l=this,d=new M("profanityFilter"),p="".concat(this._n,"._getLexicon");this._isFetching=!0,this.req({proto:v.GET_PROFANITY_LIST,data:{startIndex:this._startIndex,version:this._version}}).then(function(e){var e=e.data,t=e.errorInfo,n=e.filterConfig,o=e.lexicon,i=e.strToken,a=e.completeFlag,s=e.nextStartIndex,r=e.version,e=e.expiredTime,c=t.errorCode,u=t.errorMessage;return 0!==c?(l._isFetching=!1,A.w("".concat(p," failed. error:"),t),void d.setCode(c).setMessage(u).end()):(l._onFilterConfig(n),l._getToken(i),1===a?(A.l("".concat(p," done. version:").concat(r," expiredTime:").concat(e)),l._version=r,l._canIUseLexicon=!0,l._isFetching=!1,l._expiredTime=Date.now()+1e3*e,void l._plugin.onLexiconCompleted(o)):(l._startIndex=s,l._plugin.onLexiconSliced(o),void l._getLexicon()))}).catch(function(e){d.setError(e).end(),l._isFetching=!1,A.l("".concat(p," failed. error:"),e)})}},{key:"_onFilterConfig",value:function(t){var n=this;We(t)||(this._filterConfigMap.clear(),Object.keys(t).forEach(function(e){n._filterConfigMap.set(e,t[e])}),A.l("".concat(this._n,"._onFilterConfig. keys:").concat(Array.from(this._filterConfigMap.keys())," values:").concat(Array.from(this._filterConfigMap.values()))))}},{key:"_isConfigOn",value:function(e){return 1===this._filterConfigMap.get(e)}},{key:"_getToken",value:function(e){if(pt(e)){var t=e.length,n="";if(t%2==0)for(var o=0;o<=t-1;o+=2)n=(n+=e[o+1])+e[o];else{for(var i=0;i<t-1;i+=2)n=(n+=e[i+1])+e[i];n+=e[t-1]}this._plugin.onToken(n)}}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._plugin&&(this._plugin.reset(),this._plugin=null),this._filterConfigMap.clear(),this._startIndex=0,this._version=0,this._canIUseLexicon=!1,this._isFetching=!1,this._expiredTime=0}}]),Cr),nr=(e(yr,[{key:"_onCloudConfigUpdated",value:function(){var t=this,e=this._m.get(23).getCloudConfig("rtc_cmd");k(e)||((e=JSON.parse(e)).forEach(function(e){t._TRTCCommandList.includes(e)||t._TRTCCommandList.push(e)}),this._setTRTCCommandMap())}},{key:"_setTRTCCommandMap",value:function(){for(var e,t=0,n=this._TRTCCommandList.length;t<n;t++)e=this._TRTCCommandList[t].split(".")[0],this._TRTCCommandMap.set(e,1)}},{key:"onRoomCustomDataReceived",value:function(e){this._m.getOuterEmitterInstance().emit(G.ROOM_CUSTOM_DATA_RECEIVED,e)}},{key:"sendTRTCCustomData",value:function(e){var t=e.serviceCommand,e=e.data,n="".concat(a.NAME.TUIROOM_SVR,".*");return k(t)||(n=t),this._isValidServiceCommand(n)?this._trans({servcmd:n,data:e}):m({code:C.INVALID_TRTC_CMD})}},{key:"_trans",value:function(e){A.d("".concat(this._n,"._trans. options:").concat(JSON.stringify(e)));var t=e.servcmd,e=e.data;return this._m.get(20).trans({servcmd:t,data:pt(e)?JSON.parse(e):e})}},{key:"_isValidServiceCommand",value:function(e){if(e.endsWith(".*"))return this._TRTCCommandList.includes(e);e=e.split(".")[0];return this._TRTCCommandMap.has(e)}},{key:"isTRTCCommand",value:function(e){e=e.split(".")[0];return this._TRTCCommandMap.has(e)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset"))}}]),yr),or=(e(Ir,[{key:"_init",value:function(){var e,t=this._getStorageModule().getItem(this.TIM_ERROR_ASSISTANCE,!1);if(t){try{e=JSON.parse(t)}catch(e){this._getStorageModule().removeItem(this.TIM_ERROR_ASSISTANCE,!1),A.w("".concat(this._n,"._init error:"),e)}e&&(this._needToUpdate(e)?this._fetch():this._fillMap(e.message))}else this._fetch()}},{key:"_needToUpdate",value:function(e){var t=e.localSavedTime,e=e.localSavedVersion,t=t&&(new Date).getTime()-t>=this.STORAGE_EXPIRES_TIME,e=!e||"3.3.5"!==e;return A.l("".concat(this._n,"._needToUpdate isTimeout:").concat(t," isDifferentVersion:").concat(e)),t||e}},{key:"_fetch",value:function(){var e,t,n,o,i,a;this._m.get(12).isPrivateNetWork()||(e="https://web.sdk.qcloud.com/im/download/error-message/v3/0.0.5/tim-error-message.txt",t="application/x-www-form-urlencoded;charset=UTF-8",n="".concat(this._n,"._fetch ok in"),o=this,te?oe.request({url:e,method:"GET",timeout:3e3,header:{"content-type":t},dataType:"text",success:function(e){o._fillAndSave(e.data),A.l("".concat(n," mini program"))},fail:function(){}}):(i=new XMLHttpRequest,a=setTimeout(function(){i.abort()},3e3),i.onreadystatechange=function(){4===i.readyState&&(clearTimeout(a),200!==i.status&&304!==i.status||(A.l("".concat(n," browser")),o._fillAndSave(i.responseText)))},i.open("GET",e,!0),i.setRequestHeader("Content-type",t),i.send()))}},{key:"_fillAndSave",value:function(e){this._fillMap(e),this._getStorageModule().setItem(this.TIM_ERROR_ASSISTANCE,JSON.stringify({message:e,localSavedTime:(new Date).getTime(),localSavedVersion:"3.3.5"}),!0,!1)}},{key:"_getStorageModule",value:function(){return this._m.get(13)}},{key:"_fillMap",value:function(e){this._map.clear();for(var t,n,o=e.split(";\n"),i=o.length,a=new RegExp(/'/g),s=0;s<i;s++)if(n=o[s].indexOf(":"),t=o[s].slice(0,n),n=o[s].slice(n+1,o[s].length),!t.startsWith("//")){if(k(n))continue;this._map.set(t,n.replace(a,""))}}},{key:"get",value:function(e){var t=e.isIntl,n=e.key,o=e.replacement1,e=e.replacement2,t="".concat(n,t?"_en":"_cn"),n=(!this._map.has(t)&&this._map.has(n)&&(t=n),"");return this._map.has(t)&&(n=this._map.get(t),k(o)||(n=n.replace("$replacement1",o)),k(e)||(n=n.replace("$replacement2",e))),n}},{key:"reset",value:function(){A.l("".concat(this._n,".reset"))}}]),Ir),ir=(e(Mr,[{key:"onNewMessageList",value:function(e){var n=this,e=this._sigM.filterMessageList(e);0<e.length&&e.forEach(function(e){var t=n.getPayloadData(e);t&&n._handleActionType(t,e)})}},{key:"onMessageModified",value:function(e){var n=this,e=this._sigM.filterMessageList(e);0<e.length&&e.forEach(function(e){var t=n.getPayloadData(e);t&&n._onInvitationModified(t,e)})}},{key:"getPayloadData",value:function(t){var n="".concat(this._n,".getPayloadData"),t=t.payload.data;try{return JSON.parse(t)}catch(e){return A.e("".concat(n," JSON parse error. signalingData:").concat(t)),null}}},{key:"_handleActionType",value:function(e,t){switch(e.actionType){case P.ACTION_TYPE_INVITE:this._onNewInvitationReceived(e,t);break;case P.ACTION_TYPE_REJECT_INVITE:this._onInviteeRejected(e);break;case P.ACTION_TYPE_ACCEPT_INVITE:this._onInviteeAccepted(e);break;case P.ACTION_TYPE_CANCEL_INVITE:this._onInvitationCancelled(e);break;case P.ACTION_TYPE_INVITE_TIMEOUT:this._onInvitationTimeout(e)}}},{key:"_createDefaultEmitData",value:function(e){return{inviteID:e.inviteID,inviter:e.inviter,groupID:e.groupID,data:e.data||""}}},{key:"_onNewInvitationReceived",value:function(e,t){var n="".concat(this._n,"._onNewInvitationReceived"),o=e.inviteID,i=e.inviteeList,a=e.groupID,l=e.inviter,s=this._sigM.getMyUserID(),r=i.includes(s),c=e.timeout,u=(Le().getTime()-1e3*t.time)/1e3,n=(0<c&&0<u&&u<c&&(c-=u),"".concat(n," myselfIncluded:").concat(r," groupID:").concat(a," signalObj:").concat(JSON.stringify(e)));A.l("".concat(n," timeout:").concat(c,"s delta:").concat(u,"s")),(a&&r||!a)&&((n=this._sigM.getInviteInfo(o))&&n===e||(n||this._sigM.setInviteInfo(o,y(y({},e),{},{message:t})),this._sigM.emitEvent(P.NEW_INVITATION_RECEIVED,y(y({},this._createDefaultEmitData(e)),{},{inviteeList:i})),l!==s&&this._sigM.startTimer(y(y({},e),{},{timeout:c}))))}},{key:"_onInviteeRejected",value:function(e){var t="".concat(this._n,"._onInviteeRejected"),n=e.inviteID,o=e.inviter,i=e.groupID,a=this._sigM.hasInviteInfo(n);A.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(a," inviter:").concat(o," groupID:").concat(i)),a&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(P.INVITEE_REJECTED,y(y({},this._createDefaultEmitData(e)),{},{invitee:e.inviteeList[0]})))}},{key:"_onInviteeAccepted",value:function(e){var t="".concat(this._n,"._onInviteeAccepted"),n=e.inviteID,o=e.inviter,i=e.groupID,a=this._sigM.hasInviteInfo(n);A.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(a," inviter:").concat(o," groupID:").concat(i)),a&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(P.INVITEE_ACCEPTED,y(y({},this._createDefaultEmitData(e)),{},{invitee:e.inviteeList[0]})))}},{key:"_onInvitationCancelled",value:function(e){var t="".concat(this._n,"._onInvitationCancelled"),n=e.inviteID,o=e.inviter,i=e.groupID,a=this._sigM.hasInviteInfo(n);A.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(a," inviter:").concat(o," groupID:").concat(i)),a&&(this._sigM.deleteInviteInfo(n),this._sigM.emitEvent(P.INVITATION_CANCELLED,this._createDefaultEmitData(e)))}},{key:"_onInvitationTimeout",value:function(e){var t="".concat(this._n,"._onInvitationTimeout"),n=e.inviteID,o=e.inviter,i=e.groupID,a=e.inviteeList,s=this._sigM.hasInviteInfo(n);A.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(s," inviter:").concat(o," groupID:").concat(i,"  data:").concat(e.data)),s&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(P.INVITATION_TIMEOUT,y(y({},this._createDefaultEmitData(e)),{},{inviteeList:a,isSelfTimeout:!1})))}},{key:"_onInvitationModified",value:function(e,t){var n="".concat(this._n,"._onInvitationModified"),o=e.inviteID,i=e.data;A.l("".concat(n," inviteID:").concat(o," data:").concat(i)),this._sigM.setInviteInfo(o,y(y({},e),{},{message:t})),this._sigM.emitEvent(P.INVITATION_MODIFIED,{inviteID:o,data:i})}}]),Mr),ar=(e(vr,[{key:"generateInviteID",value:function(){var e,t=(t=Ts)((e=Cs)(32),8)+"-"+t(e(16),4)+"-"+t(16384|e(12),4)+"-"+t(32768|e(14),4)+"-"+t(e(48),12);return A.l("".concat(this._n,".generateInviteID inviteID:").concat(t)),t}},{key:"createInviteInfo",value:function(e){var t=this.generateInviteID(),e=this.createInviteCustomData(y(y({},e),{},{inviteID:t})),n=e.groupID,o=e.inviteeList,n=n||o[0];return{customData:e,message:this.createSignalingMessage(e,n),inviteID:t}}},{key:"_createDefaultCustomData",value:function(e){var t=e.data,n=e.inviteID,e=e.groupID;return{businessID:1,timeout:0,data:void 0===t?"":t,inviteID:void 0===n?"":n,groupID:void 0===e?"":e}}},{key:"createInviteCustomData",value:function(e){var t=e.userID,n=e.timeout,n=void 0===n?0:n,o=e.groupID,o=void 0===o?"":o,i=this._sigM.getMyUserID(),i=y(y({},this._createDefaultCustomData(e)),{},{actionType:P.ACTION_TYPE_INVITE,inviter:i,inviteeList:o?e.inviteeList:[t],timeout:n});return A.l("".concat(this._n,".createInviteCustomData customData:").concat(JSON.stringify(i))),i}},{key:"createCancelCustomData",value:function(e){var t,n="".concat(this._n,".createCancelCustomData"),o=e.inviteID,i=this._sigM.getMyUserID(),o=this._sigM.getInviteInfo(o),a=o.inviteeList,s=o.groupID,o=o.inviter;return o===i?t=y(y({},this._createDefaultCustomData(e)),{},{actionType:P.ACTION_TYPE_CANCEL_INVITE,groupID:s,inviter:i,inviteeList:a}):A.e("".concat(n," unmatched inviter:").concat(o," and my userID:").concat(i)),A.l("".concat(n," customData:").concat(JSON.stringify(t))),t}},{key:"createAcceptCustomData",value:function(e){var t,n="".concat(this._n,".createAcceptCustomData"),o=e.inviteID,i=this._sigM.getMyUserID(),a=this._sigM.getInviteInfo(o),s=a.inviter,r=a.groupID;return a.inviteeList.includes(i)?t=y(y({},this._createDefaultCustomData(e)),{},{actionType:P.ACTION_TYPE_ACCEPT_INVITE,groupID:r,inviter:s,inviteeList:[i]}):A.e("".concat(n," userID:").concat(i," not in inviteeList. inviteID:").concat(o," groupID:").concat(r)),A.l("".concat(n," customData:").concat(JSON.stringify(t))),t}},{key:"createRejectCustomData",value:function(e){var t,n="".concat(this._n,".createRejectCustomData"),o=e.inviteID,i=this._sigM.getMyUserID(),a=this._sigM.getInviteInfo(o),s=a.inviter,r=a.groupID;return a.inviteeList.includes(i)?t=y(y({},this._createDefaultCustomData(e)),{},{actionType:P.ACTION_TYPE_REJECT_INVITE,groupID:r,inviter:s,inviteeList:[i]}):A.e("".concat(n," userID:").concat(i," not in inviteeList. inviteID:").concat(o," groupID:").concat(r)),A.l("".concat(n," customData:").concat(JSON.stringify(t))),t}},{key:"createTimeoutCustomData",value:function(e){var t="".concat(this._n,".createTimeoutCustomData"),n=e.inviteeList,o=e.inviter,i=e.isInviter,i=void 0!==i&&i,a=this._sigM.getMyUserID(),e=y(y({},this._createDefaultCustomData(e)),{},{actionType:P.ACTION_TYPE_INVITE_TIMEOUT,inviter:o,inviteeList:i?n:[a]});return A.l("".concat(t," customData:").concat(JSON.stringify(e))),e}},{key:"createSignalingMessage",value:function(e,t){var n=e.groupID,o=e.inviter,i=this._sigM.get(2),t={to:t||n||o,conversationType:n?S.CONV_GROUP:S.CONV_C2C,priority:S.MSG_PRIORITY_HIGH,payload:{data:JSON.stringify(e)}},o=i.createCustomMessage(t);return A.d("".concat(this._n,".createSignalingMessage. message:").concat(JSON.stringify(o))),o}}]),vr),sr=(e(mr,[{key:"getHistorySignaling",value:function(){var t=this,e=this._sigM.get(11).getLocalConversationList();We(e)||(this._getC2CSignalingList(),e=this._getValidConversationList(e),this._getGroupSignalingList(e).then(function(e){t._handleSignalingList(e)}))}},{key:"_getC2CSignalingList",value:function(){var e=this._sigM.get(6).getMessageListFromUnreadDB(),e=this._filterMessageList(e);this._getSignalingRelatedToMeMap(e)}},{key:"_getGroupSignalingList",value:function(e){var n=this,e=this._createPromiseList(e);return We(e)?Promise.resolve(this._sortSignaling(this._signalingRelatedToMeMap)):this._concurrentGetMessageList(e).then(function(e){var t=new Map;return e.forEach(function(e){e=e.signalingList,e=n._getSignalingRelatedToMeMap(e);t=new Map([].concat(T(t),T(e)))}),n._sortSignaling(t)})}},{key:"_handleSignalingList",value:function(e){We(e)||(A.d("".concat(this._n,"._handleSignalingList signalingList:").concat(JSON.stringify(e))),this._sigM.onNewMessageList(e))}},{key:"_filterMessageList",value:function(e){return this._sigM.filterMessageList(e)}},{key:"_getValidConversationList",value:function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n],i=o.type,o=o.unreadCount;i===S.CONV_GROUP&&o&&t.push(e[n])}return t}},{key:"_createPromiseList",value:function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n],i=o.conversationID,a=o.unreadCount,o=o.type===S.CONV_C2C?a:this.COUNT,a=(this._signalingMap.set(i,{needMessageCount:o,signalingList:[]}),this._sigM.get(11).getMessageList({conversationID:i}));t.push(a)}return t}},{key:"_concurrentGetMessageList",value:function(e){var i=this,a=[];return Promise.all(e).then(function(e){for(var t=0;t<e.length;t++){var n=e[t],o=n.code,n=n.data;0===o&&0!==n.messageList.length&&(i._handleMessageList(n.messageList),(o=i._relayGetMessageList(n))&&a.push(o))}return 0<a.length?i._concurrentGetMessageList(a):i._signalingMap})}},{key:"_relayGetMessageList",value:function(e){var t=e.messageList,n=e.nextReqMessageID,e=e.isCompleted;if(0===t.length)return null;var t=t[0],o=t.conversationID,t=t.conversationType,i=this._signalingMap.get(o).needMessageCount;return t===S.CONV_GROUP||0===i||e?null:this._sigM.get(11).getMessageList({conversationID:o,nextReqMessageID:n,count:i})}},{key:"_handleMessageList",value:function(e){var t=e.length,n=e[0].conversationID,o=this._signalingMap.get(n),i=o.needMessageCount,o=o.signalingList;this._signalingMap.set(n,{needMessageCount:0<i-t?i-t:0,signalingList:o.concat(this._filterMessageList(e))})}},{key:"_getSignalingRelatedToMeMap",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];this._saveSignalingRelatedToMe(n)}return this._signalingRelatedToMeMap}},{key:"_saveSignalingRelatedToMe",value:function(e){var t=this._sigM.getRemoteSignalingHandler().getPayloadData(e)||{},n=t.actionType,t=t.inviteID,o=void 0===t?"":t;switch(void 0===n?"":n){case P.ACTION_TYPE_INVITE:this._setHistoryInviteInfo(e);break;case P.ACTION_TYPE_REJECT_INVITE:case P.ACTION_TYPE_ACCEPT_INVITE:this.updateHistoryInviteInfo(e);break;case P.ACTION_TYPE_CANCEL_INVITE:this.deleteHistoryInviteInfo(o);break;case P.ACTION_TYPE_INVITE_TIMEOUT:this.updateHistoryInviteInfo(e)}}},{key:"_setHistoryInviteInfo",value:function(e){var t=this._sigM.getRemoteSignalingHandler().getPayloadData(e)||{},n=t.inviteID,n=void 0===n?"":n,o=t.inviteeList,o=void 0===o?[]:o,i=t.timeout,i=void 0===i?0:i,a=this._sigM.getMyUserID();o.includes(a)&&(o=Ae()-e.time,0<i&&i<o&&0!==i||this._signalingRelatedToMeMap.set(n,y(y({},t),{},{messageList:[e]})))}},{key:"deleteHistoryInviteInfo",value:function(e){this._signalingRelatedToMeMap.has(e)&&this._signalingRelatedToMeMap.delete(e)}},{key:"updateHistoryInviteInfo",value:function(e){var t=this._sigM.getRemoteSignalingHandler().getPayloadData(e)||{},n=t.inviteID,n=void 0===n?"":n,t=t.inviteeList,o=void 0===t?[]:t;if(this._signalingRelatedToMeMap.has(n)){for(var t=this._signalingRelatedToMeMap.get(n),i=t.inviteeList,t=t.messageList,a=0;a<o.length;a++){var s=o[a];i.includes(s)&&i.splice(i.indexOf(s),1)}0===i.length?this.deleteHistoryInviteInfo(n):t.push(e)}else this.deleteHistoryInviteInfo(n)}},{key:"_sortSignaling",value:function(e){var t=[];return e.forEach(function(e){t=[].concat(T(t),T(e.messageList))}),t.sort(function(e,t){return(e.time||0)-(t.time||0)})}},{key:"reset",value:function(){this._signalingMap.clear(),this._signalingRelatedToMeMap.clear()}}]),mr),rr=e(function e(t,n){u(this,e),this.businessID=t.businessID||1,this.inviteID=t.inviteID,this.groupID=t.groupID||"",this.inviter=t.inviter||"",this.inviteeList=t.inviteeList||[],this.data=t.data||"",this.actionType=t.actionType||P.ACTION_TYPE_INVITE,this.timeout=t.timeout||0}),cr=["message"],ur=["message"],lr=(t(fr,Nn),Es=f(fr),e(fr,[{key:"onC2CUnreadHandleCompleted",value:function(){this._isC2CUnreadHandleCompleted=!0,this._isC2CUnreadHandleCompleted&&this._isConvSyncCompleted&&!this._isSyncCompleted&&this.onReady()}},{key:"onConvSyncCompleted",value:function(){this._isConvSyncCompleted=!0,this._isC2CUnreadHandleCompleted&&this._isConvSyncCompleted&&!this._isSyncCompleted&&this.onReady()}},{key:"onReady",value:function(){A.l("".concat(this._n,".onReady")),this._isSyncCompleted=!0,this._historySignalingHandler.getHistorySignaling()}},{key:"onNewMessageList",value:function(e){return this._remoteSignalingHandler.onNewMessageList(e)}},{key:"onMessageModified",value:function(e){return this._remoteSignalingHandler.onMessageModified(e)}},{key:"hasInviteInfo",value:function(e){return this._inviteInfoMap.has(e)}},{key:"getInviteInfo",value:function(e){return this._inviteInfoMap.get(e)}},{key:"setInviteInfo",value:function(e,t){var n=t.message,t=h(t,cr);A.l("".concat(this._n,".setInviteInfo inviteID:").concat(e," data:").concat(JSON.stringify(t))),this._inviteInfoMap.set(e,y(y({},t),{},{message:n}))}},{key:"deleteInviteInfo",value:function(e){this.hasInviteInfo(e)&&(A.l("".concat(this._n,".deleteInviteInfo inviteID:").concat(e,".")),this._inviteInfoMap.delete(e))}},{key:"updateInviteInfo",value:function(e){var t="".concat(this._n,".updateInviteInfo"),n=e.inviteID,o=e.inviter,i=e.inviteeList,e=e.groupID;A.l("".concat(t," inviteID:").concat(n," inviter:").concat(o," groupID:").concat(e)),e&&this.hasInviteInfo(n)?(o=i[0],(e=this.getInviteInfo(n).inviteeList).includes(o)&&(e.splice(e.indexOf(o),1),A.l("".concat(t," remove ").concat(o,". localInviteeList.length:").concat(e.length))),0===e.length&&this.deleteInviteInfo(n)):this.deleteInviteInfo(n)}},{key:"getLocalSignalingHandler",value:function(){return this._localSignalingHandler}},{key:"getRemoteSignalingHandler",value:function(){return this._remoteSignalingHandler}},{key:"canIUseSignaling",value:function(){return this._canIUseSignaling}},{key:"emitEvent",value:function(e,t){this._outerEmitter.emit(e,t)}},{key:"addSignalingListener",value:function(e,t,n){this._canIUseSignaling||(this._canIUseSignaling=!0),this._outerEmitter.on(e,t,n)}},{key:"removeSignalingListener",value:function(e,t,n){this._outerEmitter.off(e,t,n),0===this._outerEmitter.eventNames().length&&(this._canIUseSignaling=!1)}},{key:"invite",value:function(e){var t=this,n="".concat(this._n,".").concat("invite"),o=this._localSignalingHandler.createInviteInfo(e),i=o.message,a=o.customData,s=o.inviteID;return A.l("".concat(n," options:").concat(JSON.stringify(e)," inviteID:").concat(s)),this.sendSignaling(i,e).then(function(e){return e&&0===e.code?(t.setInviteInfo(s,y(y({},a),{},{message:i})),t.startTimer(y(y({},a),{},{inviteID:s})),y(y({},e),{},{inviteID:s})):e}).catch(function(e){return m(e)})}},{key:"inviteSync",value:function(e,t,n){var o=this,i="".concat(this._n,".").concat("inviteSync"),a=this._localSignalingHandler.createInviteInfo(e),s=a.message,r=a.customData,c=a.inviteID;return A.l("".concat(i," options:").concat(JSON.stringify(e)," inviteID:").concat(c)),this.sendSignaling(s,e).then(function(e){if(e&&0===e.code)return o.setInviteInfo(c,y(y({},r),{},{message:s})),o.startTimer(y(y({},r),{},{inviteID:c})),t&&t({inviteID:c}),{inviteID:c};n&&n(0===e.code,e.message||"")}).catch(function(e){return n&&n(e.code,e.message),m(e)}),c}},{key:"_handleImResponse",value:function(e,t,n){t&&0===t.code&&(this._isHandling=!1,n?this.deleteInviteInfo(e.inviteID):this.updateInviteInfo(e))}},{key:"cancel",value:function(t){var n=this,e="".concat(this._n,".").concat("cancel");if(A.l("".concat(e," options:").concat(JSON.stringify(t))),!this.hasInviteInfo(t.inviteID)||this._isHandling)return m({code:C.INVALID_CANCEL_MESSAGE});this._isHandling=!0;var o=this._localSignalingHandler.createCancelCustomData(t);if(!o)return this._isHandling=!1,m({code:C.SIGNALING_NO_PERMISSION});var e=o.groupID,i=o.inviteeList,e=e||i[0],i=this._localSignalingHandler.createSignalingMessage(o,e);return this.sendSignaling(i,t).then(function(e){return n._handleImResponse(o,e,!0),0===e.code?y(y({},e),{},{inviteID:t.inviteID}):e}).catch(function(e){return m(e)})}},{key:"accept",value:function(t){var n=this,e="".concat(this._n,".").concat("accept");if(A.l("".concat(e," options:").concat(JSON.stringify(t))),!this.hasInviteInfo(t.inviteID)||this._isHandling)return m({code:C.SIGNALING_INVALID_INVITE_ID});this._isHandling=!0;var o=this._localSignalingHandler.createAcceptCustomData(t);if(!o)return this._isHandling=!1,m({code:C.SIGNALING_NO_PERMISSION});e=this._localSignalingHandler.createSignalingMessage(o);return this.sendSignaling(e,t).then(function(e){return n._handleImResponse(o,e),0===e.code?y(y({},e),{},{inviteID:t.inviteID}):e}).catch(function(e){return m(e)})}},{key:"reject",value:function(t){var n=this,e="".concat(this._n,".").concat("reject");if(A.l("".concat(e," options:").concat(JSON.stringify(t))),!this.hasInviteInfo(t.inviteID)||this._isHandling)return m({code:C.SIGNALING_INVALID_INVITE_ID});this._isHandling=!0;var o=this._localSignalingHandler.createRejectCustomData(t);if(!o)return this._isHandling=!1,m({code:C.SIGNALING_NO_PERMISSION});e=this._localSignalingHandler.createSignalingMessage(o);return this.sendSignaling(e,t).then(function(e){return n._handleImResponse(o,e,!0),0===e.code?y(y({},e),{},{inviteID:t.inviteID}):e}).catch(function(e){return m(e)})}},{key:"getSignalingInfo",value:function(e){var t="".concat(this._n,".getSignalingInfo"),n=e.ID,o=e.from,i=e.to,a=this._filterSignalingMessage(e),s=null,e=(a&&(e=this._remoteSignalingHandler.getPayloadData(e),s=new rr(e)),a?"actionType:".concat(s.actionType):"");return A.l("".concat(t," messageID:").concat(n," from:").concat(o," to:").concat(i," ")+"".concat(e," isSignaling:").concat(a)),s}},{key:"modifyInvitation",value:function(e){var t=this,n=e.inviteID,o=e.data;if(!this.hasInviteInfo(e.inviteID)||this._isHandling)return m({code:C.SIGNALING_INVALID_INVITE_ID});this._isHandling=!0;var e=this.getInviteInfo(n),i=e.message,a=h(e,ur),s=i.payload.data;return a.data=o,i.payload.data=JSON.stringify(a),this.get(2).modifyRemoteMessage(i).then(function(e){return t.setInviteInfo(n,y(y({},a),{},{message:i})),t._isHandling=!1,e}).catch(function(e){return t._isHandling=!1,i.payload.data=s,m(e)})}},{key:"_genMessageControlInfo",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.data,t=void 0===t?"":t,n=e.onlineUserOnly,o=e.inviteID,o=void 0===o?"":o,i=e.offlinePushInfo,e=e.actionType,a={_onlineOnlyFlag:!1},o={onlineUserOnly:(a=o&&this.getInviteInfo(o)?this.getInviteInfo(o).message:a)._onlineOnlyFlag||n||!1,offlinePushInfo:i,messageControlInfo:{excludedFromContentModeration:!0,excludedFromUnreadCount:!1,excludedFromLastMessage:!1}};if(e===P.ACTION_TYPE_INVITE_TIMEOUT)return a=!!t.match(/excludeTimeoutSignalingFromHistoryMessage/),o.messageControlInfo.excludedFromUnreadCount=a,o.messageControlInfo.excludedFromLastMessage=a,o;n=!!t.match(/excludeFromHistoryMessage/),i=!!t.match(/excludeOriginalSignalingFromHistoryMessage/);return o.messageControlInfo.excludedFromUnreadCount=n||i,o.messageControlInfo.excludedFromLastMessage=n||i,o}},{key:"sendSignaling",value:function(e,t){var n=this;return this.get(2).sendMessageInstance(e,this._genMessageControlInfo(t)).catch(function(e){return n._isHandling=!1,m(e)})}},{key:"filterMessageList",value:function(e){var t=this;return e.filter(function(e){return t._filterSignalingMessage(e)})}},{key:"_filterSignalingMessage",value:function(e){var t,n,o=!1;return e.type&&e.type===S.MSG_CUSTOM&&(t=e.cloudCustomData,e=void 0===(e=e.payload.data)?"":e,t=(void 0===t?"":t).match(/"type":"tsignaling"/),n=e.match(/inviteID/),e=e.match(/actionType/),o=t||n&&e),!!o}},{key:"startTimer",value:function(t){var n,o,i,a=this,s="".concat(this._n,".startTimer"),e=t.timeout,r=t.inviteID,c=t.inviter,l=t.groupID,u=c===this.getMyUserID();A.l("".concat(s," timeout:").concat(e," isInviter:").concat(u," groupID:").concat(l)),e<=0||(n=u?e+5:e,o=1,i=setInterval(function(){var e=a._hasLocalInviteInfo(t,u);o<n&&e?++o:(e&&a._sendTimeoutNotice(r,u),A.l("".concat(s," end.")),clearInterval(i))},1e3))}},{key:"_hasLocalInviteInfo",value:function(e,t){var n=e.inviteID,e=e.groupID;if(!this.hasInviteInfo(n))return!1;var o="".concat(this._n,"._hasLocalInviteInfo"),i=this.getInviteInfo(n).inviteeList;return A.l("".concat(o," inviteID:").concat(n," inviteeList:").concat(i," groupID:").concat(e)),!e||(t?0<i.length:0<i.length&&i.includes(this.getMyUserID()))}},{key:"_getReceiver",value:function(e,t){var n=t.groupID,o=t.inviteeList,t=t.inviter;return e?n||o[0]:n||t}},{key:"_sendTimeoutNotice",value:function(i,a){var s=this,e=this.getInviteInfo(i),t=this._getReceiver(a,e),r=(A.l("".concat(this._n,"._sendTimeoutNotice inviteID:").concat(i," to:").concat(t," isInviter:").concat(a)),this._localSignalingHandler.createTimeoutCustomData(y(y({},e),{},{isInviter:a}))),c=this._localSignalingHandler.createSignalingMessage(r,t);return this.sendSignaling(c,r).then(function(e){var t,n,o;e&&0===e.code&&(e=r.data,t=r.groupID,n=r.inviteeList,o=r.inviter,s.emitEvent(P.INVITATION_TIMEOUT,{data:e,groupID:t,inviteID:i,inviteeList:n,inviter:o,isSelfTimeout:!0,message:c}),a?s.deleteInviteInfo(i):s.updateInviteInfo(r))})}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._inviteInfoMap.clear(),this._canIUseSignaling=!1,this._isHandling=!1,this._historySignalingHandler.reset(),this._isC2CUnreadHandleCompleted=!1,this._isConvSyncCompleted=!1,this._isSyncCompleted=!1}}]),fr),dr=["followTypeList"],pr={NONE:0,FOLLOWERS:1,FOLLOWING:2,MUTUAL:3},_r=(t(hr,Nn),Ds=f(hr),e(hr,[{key:"_onCloudConfigUpdated",value:function(){var e=this.getCloudConfig("follow_req_count");k(e)||(e=Number(e),this.DEFAULT_COUNT=e>this.MAX_COUNT?this.MAX_COUNT:e,this._clearFollowList())}},{key:"clearCacheOnReconnected",value:function(){this._clearFollowList(),this._followType.clear()}},{key:"onFollowInfoNotify",value:function(e){var e=e.dataList||{},t=e.followAddList,t=void 0===t?[]:t,n=e.followDeleteList,n=void 0===n?[]:n,e=e.pushType,o=this._initFollowInfo();1===e?this._handleFollowAddList({followAddList:t,followInfo:o}):this._handleFollowDeleteList({followDeleteList:n,followInfo:o}),this._emitEvent(o),A.l("".concat(this._n,".onFollowInfoNotify pushType:").concat(e," followAddList:").concat(t.length," followDeleteList:").concat(n.length))}},{key:"_initFollowInfo",value:function(){var t={};return Object.values(pr).forEach(function(e){e!==pr.NONE&&(t[e]={userInfoList:[],isAdd:!1})}),t}},{key:"_handleFollowAddList",value:function(e){var o=this,t=e.followAddList,i=e.followInfo;t.forEach(function(e){var t=e.followTypeList,t=void 0===t?[]:t,n=h(e,dr);t.forEach(function(e){i[e].userInfoList.push(n),i[e].isAdd=!0}),o._setFollowType(e.userID,e.followType)})}},{key:"_handleFollowDeleteList",value:function(e){var o=this,t=e.followDeleteList,i=e.followInfo;t.forEach(function(e){var t=e.followTypeList,t=void 0===t?[]:t,n=e.userID;t.forEach(function(e){i[e].userInfoList.push(n),i[e].isAdd=!1}),o._setFollowType(e.userID,e.followType)})}},{key:"_emitEvent",value:function(n){var o=this;Object.keys(n).forEach(function(e){var e=Number(e),t=n[e];0<t.userInfoList.length&&(e===pr.FOLLOWERS&&(o._clearFollowList(pr.FOLLOWERS),o.emitOuterEvent(G.MY_FOLLOWERS_LIST_UPDATED,t)),e===pr.FOLLOWING&&(o._clearFollowList(pr.FOLLOWING),o.emitOuterEvent(G.MY_FOLLOWING_LIST_UPDATED,t)),e===pr.MUTUAL&&(o._clearFollowList(pr.MUTUAL),o.emitOuterEvent(G.MUTUAL_FOLLOWERS_LIST_UPDATED,t)))})}},{key:"followUser",value:function(e){if(!this.canIUse(H.FOLLOW))return this.cannotUseCommercialAbility("followUser");var t="".concat(this._n,".").concat("followUser"),n="userIDList:".concat(e.length),o=new M("followUser");return o.setMessage(n),A.l("".concat(t," ").concat(n)),this.req({proto:v.FOLLOW,data:{fromAccount:this.getMyUserID(),userIDList:e.map(function(e){return{userID:e}})}}).then(function(e){return o.end(),A.l("".concat(t," ok.")),yn(e.data.resultList)}).catch(function(e){return o.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"unfollowUser",value:function(e){if(!this.canIUse(H.FOLLOW))return this.cannotUseCommercialAbility("unfollowUser");var t="".concat(this._n,".").concat("unfollowUser"),n="userIDList:".concat(e.length),o=new M("unfollowUser");return o.setMessage(n),A.l("".concat(t," ").concat(n)),this.req({proto:v.UNFOLLOW,data:{fromAccount:this.getMyUserID(),userIDList:e}}).then(function(e){return o.end(),A.l("".concat(t," ok.")),yn(e.data.resultList)}).catch(function(e){return o.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"getMyFollowersList",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMyFollowersList";if(!this.canIUse(H.FOLLOW))return this.cannotUseCommercialAbility(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myFollowersList.has(i)){var e=this._myFollowersList.get(i),a=e.resultList,s=e.nextCursor,e=e.lastUpdateTime;if(Date.now()-e<this.MAX_CATCH_TIME&&0<a.length)return A.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Cn({resultList:a,nextCursor:s})}return this._getFollowList(n,pr.FOLLOWERS).then(function(e){return t._myFollowersList.set(i,y(y({},e),{},{lastUpdateTime:Date.now()})),A.l("".concat(t._n,".").concat(o," nextCursor:").concat(n," from remote.")),yn(e)})}},{key:"getMyFollowingList",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMyFollowingList";if(!this.canIUse(H.FOLLOW))return this.cannotUseCommercialAbility(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myFollowingList.has(i)){var e=this._myFollowingList.get(i),a=e.resultList,s=e.nextCursor,e=e.lastUpdateTime;if(Date.now()-e<this.MAX_CATCH_TIME&&0<a.length)return A.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Cn({resultList:a,nextCursor:s})}return this._getFollowList(n,pr.FOLLOWING).then(function(e){return t._myFollowingList.set(i,y(y({},e),{},{lastUpdateTime:Date.now()})),A.l("".concat(t._n,".").concat(o," nextCursor:").concat(n," from remote.")),yn(e)})}},{key:"getMutualFollowersList",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMutualFollowersList";if(!this.canIUse(H.FOLLOW))return this.cannotUseCommercialAbility(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myMutualFollowersList.has(i)){var e=this._myMutualFollowersList.get(i),a=e.resultList,s=e.nextCursor,e=e.lastUpdateTime;if(Date.now()-e<this.MAX_CATCH_TIME&&0<a.length)return A.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Cn({resultList:a,nextCursor:s})}return this._getFollowList(n,pr.MUTUAL).then(function(e){return t._myMutualFollowersList.set(i,y(y({},e),{},{lastUpdateTime:Date.now()})),A.l("".concat(t._n,".").concat(o," nextCursor:").concat(n," from remote.")),yn(e)})}},{key:"_getFollowList",value:function(e,t){var i=this,n=new M("_getFollowList");return n.setMessage("nextCursor:".concat(e," type:").concat(t)),this.req({proto:v.GET_FOLLOW,data:{fromAccount:this.getMyUserID(),count:this.DEFAULT_COUNT,nextCursor:e,type:t}}).then(function(e){n.end();var e=e.data,t=e.resultList,t=void 0===t?[]:t,e=e.nextCursor,e=void 0===e?"":e,o=[];return t.forEach(function(e){var t=e.userID,n=e.followTime,e=e.profileList;o.push(y({userID:t,followTime:n},i._handleProfileItem(void 0===e?[]:e)))}),{resultList:o,nextCursor:e}}).catch(function(e){return n.setError(e).end(),A.e("".concat(i._n,"._getFollowList failed. error:"),e),m(e)})}},{key:"_handleProfileItem",value:function(e){var t={};return e.forEach(function(e){switch(e.tag){case be.NICK:t.nick=e.value;break;case be.GENDER:t.gender=e.value;break;case be.BIRTHDAY:t.birthday=e.value;break;case be.LOCATION:t.location=e.value;break;case be.SELFSIGNATURE:t.selfSignature=e.value;break;case be.ALLOWTYPE:t.allowType=e.value;break;case be.LANGUAGE:t.language=e.value;break;case be.AVATAR:t.avatar=e.value;break;case be.MESSAGESETTINGS:t.messageSettings=e.value;break;case be.ADMINFORBIDTYPE:t.adminForbidType=e.value;break;case be.LEVEL:t.level=e.value;break;case be.ROLE:t.role=e.value;break;default:t[e.tag]=e.value}}),t}},{key:"getUserFollowInfo",value:function(e){if(!this.canIUse(H.FOLLOW))return this.cannotUseCommercialAbility("getUserFollowInfo");var t=e,n=!1,i=(k(e)&&(t=[this.getMyUserID()],n=!0),"".concat(this._n,".").concat("getUserFollowInfo")),e="userIDList:".concat(t.length," isGetMyFollowInfo:").concat(n),a=new M("getUserFollowInfo");return a.setMessage(e),A.l("".concat(i," ").concat(e)),this.req({proto:v.GET_FOLLOW_INFO,data:{fromAccount:this.getMyUserID(),userIDList:t}}).then(function(e){a.end(),A.l("".concat(i," ok."));var e=e.data.followInfoList,o=[];return(void 0===e?[]:e).forEach(function(e){var t=e.followersCount,n=e.followingCount,e=e.mutualFollowersCount;o.push({followersCount:t,followingCount:n,mutualFollowersCount:e})}),yn(o)}).catch(function(e){return a.setError(e).end(),A.e("".concat(i," failed. error:"),e),m(e)})}},{key:"checkFollowType",value:function(e){var n=this;if(!this.canIUse(H.FOLLOW))return this.cannotUseCommercialAbility("checkFollowType");100<e.length&&(e=e.slice(0,100),A.w("".concat(t," ").concat(Wt(100))));var t="".concat(this._n,".").concat("checkFollowType"),o="userIDList length:".concat(e.length," "),i=new M("checkFollowType"),a=(i.setMessage(o),A.l("".concat(t," ").concat(o)),[]),s=[];return e.forEach(function(e){var t;n._followType.has(e)?(t=n._followType.get(e),a.push({userID:e,followType:t})):s.push(e)}),A.l("".concat(t," from local count:").concat(a.length,", from remote count:").concat(s.length,".")),0===s.length?Cn(a):this.req({proto:v.CHECK_FOLLOW_TYPE,data:{fromAccount:this.getMyUserID(),userIDList:s}}).then(function(e){i.end(),A.l("".concat(t," ok."));e=e.data.resultList;return(void 0===e?[]:e).forEach(function(e){var t=e.userID,e=e.followType;n._setFollowType(t,e),a.push({userID:t,followType:e})}),yn(a)}).catch(function(e){return i.setError(e).end(),A.e("".concat(t," failed. error:"),e),m(e)})}},{key:"_setFollowType",value:function(e,t){this._followType.set(e,t)}},{key:"_clearFollowList",value:function(e){if(k(e))return this._myFollowersList.clear(),this._myFollowingList.clear(),void this._myMutualFollowersList.clear();e!==pr.FOLLOWERS?e!==pr.FOLLOWING?e!==pr.MUTUAL||this._myMutualFollowersList.clear():this._myFollowingList.clear():this._myFollowersList.clear()}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._clearFollowList(),this._followType.clear()}}]),hr),gr=pa(function(e,t){var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;t.assign=function(e){for(var t,n,o=Array.prototype.slice.call(arguments,1);o.length;){var i=o.shift();if(i){if("object"!==r(i))throw new TypeError(i+"must be non-object");for(var a in i)t=i,n=a,Object.prototype.hasOwnProperty.call(t,n)&&(e[a]=i[a])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var o={arraySet:function(e,t,n,o,i){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+o),i);else for(var a=0;a<o;a++)e[i+a]=t[n+a]},flattenChunks:function(e){for(var t,n,o,i=0,a=0,s=e.length;a<s;a++)i+=e[a].length;for(o=new Uint8Array(i),a=t=0,s=e.length;a<s;a++)n=e[a],o.set(n,t),t+=n.length;return o}},i={arraySet:function(e,t,n,o,i){for(var a=0;a<o;a++)e[i+a]=t[n+a]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,o)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,i))},t.setTyped(n)});function hr(e){return u(this,hr),(e=Ds.call(this,e))._n="FollowModule",e._myFollowersList=new Map,e._myFollowingList=new Map,e._myMutualFollowersList=new Map,e._followType=new Map,e.MAX_CATCH_TIME=6e5,e.FIRST_PAGE_INDEX=rt(),e.DEFAULT_COUNT=500,e.MAX_COUNT=1e3,e.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,e._onCloudConfigUpdated,g(e)),e}function fr(e){return u(this,fr),(e=Es.call(this,e))._n="SignalingModule",e._inviteInfoMap=new Map,e._outerEmitter=new ga,e._outerEmitter._emit=e._outerEmitter.emit,e._outerEmitter.emit=function(){this._outerEmitter._emit.apply(this._outerEmitter,[].concat([arguments.length<=0?void 0:arguments[0],{name:arguments.length<=0?void 0:arguments[0],data:arguments.length<=1?void 0:arguments[1]}]))}.bind(g(e)),e._canIUseSignaling=!1,e._isHandling=!1,e._remoteSignalingHandler=new ir(g(e)),e._localSignalingHandler=new ar(g(e)),e._historySignalingHandler=new sr(g(e)),e._isC2CUnreadHandleCompleted=!1,e._isConvSyncCompleted=!1,e._isSyncCompleted=!1,e.getInnerEmitterInstance().on(Uo.C2C_UNREAD_HANDLE_COMPLETED,e.onC2CUnreadHandleCompleted,g(e)),e.getInnerEmitterInstance().on(Uo.CONV_SYNC_COMPLETED,e.onConvSyncCompleted,g(e)),e}function mr(e){u(this,mr),this._n="HistorySignalingHandler",this._sigM=e,this.COUNT=20,this._signalingMap=new Map,this._signalingRelatedToMeMap=new Map}function vr(e){u(this,vr),this._n="LocalSignalingHandler",this._sigM=e}function Mr(e){u(this,Mr),this._n="RemoteSignalingHandler",this._sigM=e}function Ir(e){u(this,Ir),this._m=e,this._n="ErrorMessageModule",this.TIM_ERROR_ASSISTANCE="tim_error_assistance",this.STORAGE_EXPIRES_TIME=6048e5,this._map=new Map,this._init()}function yr(e){u(this,yr),this._m=e,this._n="TransCmdModule",this._TRTCCommandList=["tui_room_svr.*","callkit_records_svr.*","room_engine_srv.*","room_engine_http_srv.*","room_engine_mic.*","live_engine_srv.*","live_engine_http_srv.*"],this._TRTCCommandMap=new Map,this._setTRTCCommandMap(),this._m.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}function Cr(e){return u(this,Cr),(e=Ls.call(this,e))._n="ProfanityFilterModule",e._plugin=null,e._filterConfigMap=new Map,e._startIndex=0,e._version=0,e._canIUseLexicon=!1,e._isFetching=!1,e._expiredTime=0,e}function Tr(e){var t;return u(this,Tr),(t=Ss.call(this,e))._m=e,t._n="TIMPushModule",t._pluginName="TIMPush",t._pushPlugin=void 0,t._androidPushConfig={},t._deviceToken="",t._businessID=0,t._iOSBusinessID=0,t._c2cUnreadCount=0,t._groupUnreadCount=0,t._isWebUniapp=0,t._deviceInfo={notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:"1.0.1",packageName:""},t}function Dr(e){var t;return u(this,Dr),(t=As.call(this,e))._m=e,t._n="OfflinePushModule",t._offlinePushPlugin=void 0,t._androidPushConfig={huaweiPushBussinessId:"",xiaomiPushBussinessId:"",xiaomiPushAppId:"",xiaomiPushAppKey:"",meizuPushBussinessId:"",meizuPushAppId:"",meizuPushAppKey:"",vivoPushBussinessId:"",fcmPushBussinessId:"",oppoPushBussinessId:"",oppoPushAppKey:"",oppoPushAppSecret:"",honorPushBussinessId:""},t._deviceToken="",t._businessID=0,t._iosBusinessID=0,t._c2cUnreadCount=0,t._groupUnreadCount=0,t._isWebUniapp=0,t}function Er(e){u(this,Er),this._m=e,this._n="CommercialConfigModule",this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler=new Zs(this)}function Lr(e){u(this,Lr),this._commercialConfigM=e,this._n="PurchasedFeatureHandler",this._isSCMReported=!1,this._featureMap=new Map}function Sr(e){return u(this,Sr),(e=ks.call(this,e))._n="WorkerTimerModule",e._isWorkerEnabled=!0,e._workerTimer=null,e._timerID=-1,e._init(),e.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,e._onCloudConfigUpdated,g(e)),e}function Ar(e){return u(this,Ar),(e=Rs.call(this,e))._n="SnsModule",e._friendHandler=new Ys(g(e)),e._friendApplicationHandler=new Ks(g(e)),e._friendGroupHandler=new Js(g(e)),e.getInnerEmitterInstance().on(Uo.A2KEY_AND_TINYID_UPDATED,e.onContextUpdated,g(e)),e}function kr(e){u(this,kr),this._snsM=e,this._n="FriendGroupHandler",this._friendGroupMap=new Map}function Rr(e){u(this,Rr),We(e)||(this.name=e.name||"",this.userIDList=e.userIDList||[],this.count=this.userIDList.length||0)}function Or(e){u(this,Or),this._snsM=e,this._n="FriendHandler",this._friendMap=new Map,this._startIndex=0,this._standardSequence=0,this._customSequence=0,this._expirationTime=18e4}function Nr(e,t){u(this,Nr),this.userID=e,this.remark="",this.groupList=[],this.source="",this.addTime=0,this.friendCustomField=[],this.timestamp=0;var n={},o=[];if(n.userID=e,!We(t))for(var i,a="",s=0,r=t.length;s<r;s++)if(a=t[s].tag,i=t[s].value,-1<a.indexOf("Tag_SNS_Custom"))this.friendCustomField.push({key:a,value:i});else if(-1<a.indexOf("Tag_Profile_Custom"))o.push({key:a,value:i});else switch(a){case be.NICK:n.nick=i;break;case be.GENDER:n.gender=i;break;case be.BIRTHDAY:n.birthday=i;break;case be.LOCATION:n.location=i;break;case be.SELFSIGNATURE:n.selfSignature=i;break;case be.ALLOWTYPE:n.allowType=i;break;case be.LANGUAGE:n.language=i;break;case be.AVATAR:n.avatar=i;break;case be.MESSAGESETTINGS:n.messageSettings=i;break;case be.ADMINFORBIDTYPE:n.adminForbidType=i;break;case be.LEVEL:n.level=i;break;case be.ROLE:n.role=i;break;case Fe.REMARK:this.remark=i;break;case Fe.ADDTIME:this.addTime=i;break;case Fe.GROUP:this.groupList=JSON.parse(JSON.stringify(i));break;case Fe.ADDSOURCE:this.source=i;break;case Fe.ADDWORDING:break;default:A.l("snsProfileItem unknown tag->",t[s].tag)}this.profile=new zo(y(y({},n),{},{profileCustomField:o}))}function Gr(e){u(this,Gr),this._snsM=e,this._n="FriendApplicationHandler",this._startTime=0,this._maxLimited=100,this._currentSequence=0,this._friendApplicationMap=new Map,this._unreadCount=0}function Pr(e){u(this,Pr),(e=Os.call(this,e))._n="QualityStatModule",e.TAG="im-ssolog-quality-stat",e.reportIndex=0,e.wholePeriod=!1,e._qualityItems=[wn,qn,xn,Vn,Hn,Bn,Kn,Wn,Yn,jn],e._messageSentItems=[xn,Vn,Hn,Bn,Kn],e._messageReceivedItems=[Wn,Yn,jn],e.REPORT_INTERVAL=120,e.REPORT_SDKAPPID_BLACKLIST=[],e.REPORT_TINYID_WHITELIST=[],e._statInfoArr=[],e._avgRTT=new qs,e._avgE2EDelay=new ws,e._rateMessageSent=new xs,e._rateMessageReceived=new Vs;var t=e.getInnerEmitterInstance();return t.on(Uo.A2KEY_AND_TINYID_UPDATED,e._onLoginSuccess,g(e)),t.on(Uo.CLOUD_CONFIG_UPDATED,e._onCloudConfigUpdated,g(e)),e}function Ur(){u(this,Ur),this._lastMap=new Map,this._currentMap=new Map}function br(){u(this,br),this._map=new Map}function Fr(){u(this,Fr),this._n="AvgRTT",this._requestCount=0,this._rttArray=[]}function wr(){u(this,wr),this._n="AvgE2EDelay",this._e2eDelayArray=[]}function qr(e){return u(this,qr),(e=Ns.call(this,e))._n="RecoverMessageModule",e.PULL_LIMIT_COUNT=15,e}function xr(e){return u(this,xr),(e=Gs.call(this,e))._n="CloudControlModule",e._cloudConfig=new Map,e._expiredTime=0,e._version=0,e._isFetching=!1,e}function Vr(e){return u(this,Vr),(e=Ps.call(this,e))._n="SessionModule",e._platform=e.getPlatform(),e._protocolHandler=new cs(g(e)),e._messageDispatcher=new ls(g(e)),e._commandFrequencyLimitMap=new Map,e._commandRequestInfoMap=new Map,e._serverOverloadInfoMap=new Map,e._incrementalPullContactFlag=!0,e._init(),e.getInnerEmitterInstance().on(Uo.CLOUD_CONFIG_UPDATED,e._onCloudConfigUpdated,g(e)),e}gr.assign,gr.shrinkBuf,gr.setTyped,gr.Buf8,gr.Buf16,gr.Buf32;function Hr(e,t,n,o){for(var i=65535&e|0,a=e>>>16&65535|0,s=0;0!==n;){for(n-=s=2e3<n?2e3:n;a=a+(i=i+t[o++]|0)|0,--s;);i%=65521,a%=65521}return i|a<<16|0}function Br(e,t,n,o){var i=Wr,a=o+n;e^=-1;for(var s=o;s<a;s++)e=e>>>8^i[255&(e^t[s])];return-1^e}function Kr(l,d,p,_,g,h,e,f){for(var t,m,v,M,I,y,C,T,D,E=f.bits,n=0,o=0,i=0,a=0,s=0,r=0,c=0,L=0,S=0,u=0,A=null,k=0,R=new gr.Buf16(16),O=new gr.Buf16(16),N=null,G=0,n=0;n<=15;n++)R[n]=0;for(o=0;o<_;o++)R[d[p+o]]++;for(s=E,a=15;1<=a&&0===R[a];a--);if(a<s&&(s=a),0===a)return g[h++]=20971520,g[h++]=20971520,f.bits=1,0;for(i=1;i<a&&0===R[i];i++);for(s<i&&(s=i),n=L=1;n<=15;n++)if((L=(L<<1)-R[n])<0)return-1;if(0<L&&(0===l||1!==a))return-1;for(O[1]=0,n=1;n<15;n++)O[n+1]=O[n]+R[n];for(o=0;o<_;o++)0!==d[p+o]&&(e[O[d[p+o]]++]=o);if(y=0===l?(A=N=e,19):1===l?(A=Yr,k-=257,N=jr,G-=257,256):(A=Jr,N=zr,-1),n=i,I=h,c=o=u=0,v=-1,M=(S=1<<(r=s))-1,1===l&&852<S||2===l&&592<S)return 1;for(;;){for(D=e[o]<y?(T=0,e[o]):e[o]>y?(T=N[G+e[o]],A[k+e[o]]):(T=96,0),t=1<<(C=n-c),i=m=1<<r;g[I+(u>>c)+(m-=t)]=C<<24|T<<16|D|0,0!==m;);for(t=1<<n-1;u&t;)t>>=1;if(0!==t?u=(u&t-1)+t:u=0,o++,0==--R[n]){if(n===a)break;n=d[p+e[o]]}if(s<n&&(u&M)!==v){for(I+=i,L=1<<(r=n-(c=0===c?s:c));r+c<a&&!((L-=R[r+c])<=0);)r++,L<<=1;if(S+=1<<r,1===l&&852<S||2===l&&592<S)return 1;g[v=u&M]=s<<24|r<<16|I-h|0}}return 0!==u&&(g[I+u]=n-c<<24|64<<16|0),f.bits=s,0}var Wr=function(){for(var e=[],t=0;t<256;t++){for(var n=t,o=0;o<8;o++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n}return e}(),Yr=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],jr=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],Jr=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],zr=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function Xr(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function Zr(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new gr.Buf16(320),this.work=new gr.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function Qr(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new gr.Buf32(852),t.distcode=t.distdyn=new gr.Buf32(592),t.sane=1,t.back=-1,0):-2}function $r(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,Qr(e)):-2}function ec(e,t){var n,o;return e&&e.state?(o=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?-2:(null!==o.window&&o.wbits!==t&&(o.window=null),o.wrap=n,o.wbits=t,$r(e))):-2}function tc(e,t){var n;return e?(n=new Zr,(e.state=n).window=null,0!==(n=ec(e,t))&&(e.state=null),n):-2}var nc,oc,ic=!0;function ac(e,t,n,o){var i,e=e.state;return null===e.window&&(e.wsize=1<<e.wbits,e.wnext=0,e.whave=0,e.window=new gr.Buf8(e.wsize)),o>=e.wsize?(gr.arraySet(e.window,t,n-e.wsize,e.wsize,0),e.wnext=0,e.whave=e.wsize):((i=e.wsize-e.wnext)>o&&(i=o),gr.arraySet(e.window,t,n-o,i,e.wnext),(o-=i)?(gr.arraySet(e.window,t,n-o,o,0),e.wnext=o,e.whave=e.wsize):(e.wnext+=i,e.wnext===e.wsize&&(e.wnext=0),e.whave<e.wsize&&(e.whave+=i))),0}var sc={inflateReset:$r,inflateReset2:ec,inflateResetKeep:Qr,inflateInit:function(e){return tc(e,15)},inflateInit2:tc,inflate:function(e,l){var t,n,d,o,p,i,_,a,s,g,h,r,f,m,v,M,I,y,C,T,D,E,L,S,A=0,k=new gr.Buf8(4),R=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return-2;12===(t=e.state).mode&&(t.mode=13),p=e.next_out,d=e.output,_=e.avail_out,o=e.next_in,n=e.input,i=e.avail_in,a=t.hold,s=t.bits,g=i,h=_,E=0;e:for(;;)switch(t.mode){case 1:if(0===t.wrap){t.mode=13;break}for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(2&t.wrap&&35615===a){k[t.check=0]=255&a,k[1]=a>>>8&255,t.check=Br(t.check,k,2,0),s=a=0,t.mode=2;break}if(t.flags=0,t.head&&(t.head.done=!1),!(1&t.wrap)||(((255&a)<<8)+(a>>8))%31){e.msg="incorrect header check",t.mode=30;break}if(8!=(15&a)){e.msg="unknown compression method",t.mode=30;break}if(s-=4,D=8+(15&(a>>>=4)),0===t.wbits)t.wbits=D;else if(D>t.wbits){e.msg="invalid window size",t.mode=30;break}t.dmax=1<<D,e.adler=t.check=1,t.mode=512&a?10:12,s=a=0;break;case 2:for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(t.flags=a,8!=(255&t.flags)){e.msg="unknown compression method",t.mode=30;break}if(57344&t.flags){e.msg="unknown header flags set",t.mode=30;break}t.head&&(t.head.text=a>>8&1),512&t.flags&&(k[0]=255&a,k[1]=a>>>8&255,t.check=Br(t.check,k,2,0)),s=a=0,t.mode=3;case 3:for(;s<32;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}t.head&&(t.head.time=a),512&t.flags&&(k[0]=255&a,k[1]=a>>>8&255,k[2]=a>>>16&255,k[3]=a>>>24&255,t.check=Br(t.check,k,4,0)),s=a=0,t.mode=4;case 4:for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}t.head&&(t.head.xflags=255&a,t.head.os=a>>8),512&t.flags&&(k[0]=255&a,k[1]=a>>>8&255,t.check=Br(t.check,k,2,0)),s=a=0,t.mode=5;case 5:if(1024&t.flags){for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}t.length=a,t.head&&(t.head.extra_len=a),512&t.flags&&(k[0]=255&a,k[1]=a>>>8&255,t.check=Br(t.check,k,2,0)),s=a=0}else t.head&&(t.head.extra=null);t.mode=6;case 6:if(1024&t.flags&&((r=(r=t.length)>i?i:r)&&(t.head&&(D=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Array(t.head.extra_len)),gr.arraySet(t.head.extra,n,o,r,D)),512&t.flags&&(t.check=Br(t.check,n,r,o)),i-=r,o+=r,t.length-=r),t.length))break e;t.length=0,t.mode=7;case 7:if(2048&t.flags){if(0===i)break e;for(r=0;D=n[o+r++],t.head&&D&&t.length<65536&&(t.head.name+=String.fromCharCode(D)),D&&r<i;);if(512&t.flags&&(t.check=Br(t.check,n,r,o)),i-=r,o+=r,D)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=8;case 8:if(4096&t.flags){if(0===i)break e;for(r=0;D=n[o+r++],t.head&&D&&t.length<65536&&(t.head.comment+=String.fromCharCode(D)),D&&r<i;);if(512&t.flags&&(t.check=Br(t.check,n,r,o)),i-=r,o+=r,D)break e}else t.head&&(t.head.comment=null);t.mode=9;case 9:if(512&t.flags){for(;s<16;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(a!==(65535&t.check)){e.msg="header crc mismatch",t.mode=30;break}s=a=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),e.adler=t.check=0,t.mode=12;break;case 10:for(;s<32;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}e.adler=t.check=Xr(a),s=a=0,t.mode=11;case 11:if(0===t.havedict)return e.next_out=p,e.avail_out=_,e.next_in=o,e.avail_in=i,t.hold=a,t.bits=s,2;e.adler=t.check=1,t.mode=12;case 12:if(5===l||6===l)break e;case 13:if(t.last){a>>>=7&s,s-=7&s,t.mode=27;break}for(;s<3;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}switch(t.last=1&a,--s,3&(a>>>=1)){case 0:t.mode=14;break;case 1:O=N=void 0;var O,N=t;if(ic){for(nc=new gr.Buf32(512),oc=new gr.Buf32(32),O=0;O<144;)N.lens[O++]=8;for(;O<256;)N.lens[O++]=9;for(;O<280;)N.lens[O++]=7;for(;O<288;)N.lens[O++]=8;for(Kr(1,N.lens,0,288,nc,0,N.work,{bits:9}),O=0;O<32;)N.lens[O++]=5;Kr(2,N.lens,0,32,oc,0,N.work,{bits:5}),ic=!1}if(N.lencode=nc,N.lenbits=9,N.distcode=oc,N.distbits=5,t.mode=20,6!==l)break;a>>>=2,s-=2;break e;case 2:t.mode=17;break;case 3:e.msg="invalid block type",t.mode=30}a>>>=2,s-=2;break;case 14:for(a>>>=7&s,s-=7&s;s<32;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if((65535&a)!=(a>>>16^65535)){e.msg="invalid stored block lengths",t.mode=30;break}if(t.length=65535&a,s=a=0,t.mode=15,6===l)break e;case 15:t.mode=16;case 16:if(r=t.length){if(0===(r=_<(r=i<r?i:r)?_:r))break e;gr.arraySet(d,n,o,r,p),i-=r,o+=r,_-=r,p+=r,t.length-=r;break}t.mode=12;break;case 17:for(;s<14;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(t.nlen=257+(31&a),a>>>=5,s-=5,t.ndist=1+(31&a),a>>>=5,s-=5,t.ncode=4+(15&a),a>>>=4,s-=4,286<t.nlen||30<t.ndist){e.msg="too many length or distance symbols",t.mode=30;break}t.have=0,t.mode=18;case 18:for(;t.have<t.ncode;){for(;s<3;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}t.lens[R[t.have++]]=7&a,a>>>=3,s-=3}for(;t.have<19;)t.lens[R[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,L={bits:t.lenbits},E=Kr(0,t.lens,0,19,t.lencode,0,t.work,L),t.lenbits=L.bits,E){e.msg="invalid code lengths set",t.mode=30;break}t.have=0,t.mode=19;case 19:for(;t.have<t.nlen+t.ndist;){for(;M=(A=t.lencode[a&(1<<t.lenbits)-1])>>>16&255,I=65535&A,!((v=A>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(I<16)a>>>=v,s-=v,t.lens[t.have++]=I;else{if(16===I){for(S=v+2;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(a>>>=v,s-=v,0===t.have){e.msg="invalid bit length repeat",t.mode=30;break}D=t.lens[t.have-1],r=3+(3&a),a>>>=2,s-=2}else if(17===I){for(S=v+3;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}D=0,r=3+(7&(a>>>=v)),a>>>=3,s=s-v-3}else{for(S=v+7;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}D=0,r=11+(127&(a>>>=v)),a>>>=7,s=s-v-7}if(t.have+r>t.nlen+t.ndist){e.msg="invalid bit length repeat",t.mode=30;break}for(;r--;)t.lens[t.have++]=D}}if(30===t.mode)break;if(0===t.lens[256]){e.msg="invalid code -- missing end-of-block",t.mode=30;break}if(t.lenbits=9,L={bits:t.lenbits},E=Kr(1,t.lens,0,t.nlen,t.lencode,0,t.work,L),t.lenbits=L.bits,E){e.msg="invalid literal/lengths set",t.mode=30;break}if(t.distbits=6,t.distcode=t.distdyn,L={bits:t.distbits},E=Kr(2,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,L),t.distbits=L.bits,E){e.msg="invalid distances set",t.mode=30;break}if(t.mode=20,6===l)break e;case 20:t.mode=21;case 21:if(6<=i&&258<=_){e.next_out=p,e.avail_out=_,e.next_in=o,e.avail_in=i,t.hold=a,t.bits=s,K=H=F=b=U=P=c=G=oe=ne=te=ee=$=Q=Z=X=z=J=j=Y=W=u=B=V=x=void 0;var G,c,P,U,b,F,w=e,q=h,x=w.state,V=w.next_in,H=w.input,B=V+(w.avail_in-5),u=w.next_out,K=w.output,W=u-(q-w.avail_out),Y=u+(w.avail_out-257),j=x.dmax,J=x.wsize,z=x.whave,X=x.wnext,Z=x.window,Q=x.hold,$=x.bits,ee=x.lencode,te=x.distcode,ne=(1<<x.lenbits)-1,oe=(1<<x.distbits)-1;t:do{for($<15&&(Q+=H[V++]<<$,$+=8,Q+=H[V++]<<$,$+=8),G=ee[Q&ne];;){if(Q>>>=c=G>>>24,$-=c,0==(c=G>>>16&255))K[u++]=65535&G;else{if(!(16&c)){if(0==(64&c)){G=ee[(65535&G)+(Q&(1<<c)-1)];continue}if(32&c){x.mode=12;break t}w.msg="invalid literal/length code",x.mode=30;break t}for(P=65535&G,(c&=15)&&($<c&&(Q+=H[V++]<<$,$+=8),P+=Q&(1<<c)-1,Q>>>=c,$-=c),$<15&&(Q+=H[V++]<<$,$+=8,Q+=H[V++]<<$,$+=8),G=te[Q&oe];;){if(Q>>>=c=G>>>24,$-=c,!(16&(c=G>>>16&255))){if(0==(64&c)){G=te[(65535&G)+(Q&(1<<c)-1)];continue}w.msg="invalid distance code",x.mode=30;break t}if(U=65535&G,$<(c&=15)&&(Q+=H[V++]<<$,($+=8)<c&&(Q+=H[V++]<<$,$+=8)),(U+=Q&(1<<c)-1)>j){w.msg="invalid distance too far back",x.mode=30;break t}if(Q>>>=c,$-=c,U>(c=u-W)){if((c=U-c)>z&&x.sane){w.msg="invalid distance too far back",x.mode=30;break t}if(F=Z,(b=0)===X){if(b+=J-c,c<P){for(P-=c;K[u++]=Z[b++],--c;);b=u-U,F=K}}else if(X<c){if(b+=J+X-c,(c-=X)<P){for(P-=c;K[u++]=Z[b++],--c;);if(b=0,X<P){for(P-=c=X;K[u++]=Z[b++],--c;);b=u-U,F=K}}}else if(b+=X-c,c<P){for(P-=c;K[u++]=Z[b++],--c;);b=u-U,F=K}for(;2<P;)K[u++]=F[b++],K[u++]=F[b++],K[u++]=F[b++],P-=3;P&&(K[u++]=F[b++],1<P&&(K[u++]=F[b++]))}else{for(b=u-U;K[u++]=K[b++],K[u++]=K[b++],K[u++]=K[b++],2<(P-=3););P&&(K[u++]=K[b++],1<P&&(K[u++]=K[b++]))}break}}break}}while(V<B&&u<Y);V-=P=$>>3,Q&=(1<<($-=P<<3))-1,w.next_in=V,w.next_out=u,w.avail_in=V<B?B-V+5:5-(V-B),w.avail_out=u<Y?Y-u+257:257-(u-Y),x.hold=Q,x.bits=$,p=e.next_out,d=e.output,_=e.avail_out,o=e.next_in,n=e.input,i=e.avail_in,a=t.hold,s=t.bits,12===t.mode&&(t.back=-1);break}for(t.back=0;M=(A=t.lencode[a&(1<<t.lenbits)-1])>>>16&255,I=65535&A,!((v=A>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(M&&0==(240&M)){for(y=v,C=M,T=I;M=(A=t.lencode[T+((a&(1<<y+C)-1)>>y)])>>>16&255,I=65535&A,!(y+(v=A>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}a>>>=y,s-=y,t.back+=y}if(a>>>=v,s-=v,t.back+=v,t.length=I,0===M){t.mode=26;break}if(32&M){t.back=-1,t.mode=12;break}if(64&M){e.msg="invalid literal/length code",t.mode=30;break}t.extra=15&M,t.mode=22;case 22:if(t.extra){for(S=t.extra;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}t.length+=a&(1<<t.extra)-1,a>>>=t.extra,s-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=23;case 23:for(;M=(A=t.distcode[a&(1<<t.distbits)-1])>>>16&255,I=65535&A,!((v=A>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(0==(240&M)){for(y=v,C=M,T=I;M=(A=t.distcode[T+((a&(1<<y+C)-1)>>y)])>>>16&255,I=65535&A,!(y+(v=A>>>24)<=s);){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}a>>>=y,s-=y,t.back+=y}if(a>>>=v,s-=v,t.back+=v,64&M){e.msg="invalid distance code",t.mode=30;break}t.offset=I,t.extra=15&M,t.mode=24;case 24:if(t.extra){for(S=t.extra;s<S;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}t.offset+=a&(1<<t.extra)-1,a>>>=t.extra,s-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){e.msg="invalid distance too far back",t.mode=30;break}t.mode=25;case 25:if(0===_)break e;if(t.offset>(r=h-_)){if((r=t.offset-r)>t.whave&&t.sane){e.msg="invalid distance too far back",t.mode=30;break}f=r>t.wnext?(r-=t.wnext,t.wsize-r):t.wnext-r,r>t.length&&(r=t.length),m=t.window}else m=d,f=p-t.offset,r=t.length;for(_-=r=_<r?_:r,t.length-=r;d[p++]=m[f++],--r;);0===t.length&&(t.mode=21);break;case 26:if(0===_)break e;d[p++]=t.length,_--,t.mode=21;break;case 27:if(t.wrap){for(;s<32;){if(0===i)break e;i--,a|=n[o++]<<s,s+=8}if(h-=_,e.total_out+=h,t.total+=h,h&&(e.adler=t.check=(t.flags?Br:Hr)(t.check,d,h,p-h)),h=_,(t.flags?a:Xr(a))!==t.check){e.msg="incorrect data check",t.mode=30;break}s=a=0}t.mode=28;case 28:if(t.wrap&&t.flags){for(;s<32;){if(0===i)break e;i--,a+=n[o++]<<s,s+=8}if(a!==(4294967295&t.total)){e.msg="incorrect length check",t.mode=30;break}s=a=0}t.mode=29;case 29:E=1;break e;case 30:E=-3;break e;case 31:return-4;default:return-2}return e.next_out=p,e.avail_out=_,e.next_in=o,e.avail_in=i,t.hold=a,t.bits=s,(t.wsize||h!==e.avail_out&&t.mode<30&&(t.mode<27||4!==l))&&ac(e,e.output,e.next_out,h-e.avail_out),g-=e.avail_in,h-=e.avail_out,e.total_in+=g,e.total_out+=h,t.total+=h,t.wrap&&h&&(e.adler=t.check=(t.flags?Br:Hr)(t.check,d,h,e.next_out-h)),e.data_type=t.bits+(t.last?64:0)+(12===t.mode?128:0)+(20===t.mode||15===t.mode?256:0),E=(0==g&&0===h||4===l)&&0===E?-5:E},inflateEnd:function(e){if(!e||!e.state)return-2;var t=e.state;return t.window&&(t.window=null),e.state=null,0},inflateGetHeader:function(e,t){var n;return!e||!e.state||0==(2&(n=e.state).wrap)?-2:((n.head=t).done=!1,0)},inflateSetDictionary:function(e,t){var n,o=t.length;return!e||!e.state||0!==(n=e.state).wrap&&11!==n.mode?-2:11===n.mode&&Hr(1,t,o,0)!==n.check?-3:ac(e,t,o,o)?(n.mode=31,-4):(n.havedict=1,0)},inflateInfo:"pako inflate (from Nodeca project)"},rc=!0,cc=!0;try{String.fromCharCode.apply(null,[0])}catch(e){rc=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){cc=!1}for(var uc=new gr.Buf8(256),lc=0;lc<256;lc++)uc[lc]=252<=lc?6:248<=lc?5:240<=lc?4:224<=lc?3:192<=lc?2:1;uc[254]=uc[254]=1;function dc(e,l){for(var t,n,o=l||e.length,i=new Array(2*o),a=0,s=0;s<o;)if((t=e[s++])<128)i[a++]=t;else if(4<(n=uc[t]))i[a++]=65533,s+=n-1;else{for(t&=2===n?31:3===n?15:7;1<n&&s<o;)t=t<<6|63&e[s++],n--;1<n?i[a++]=65533:t<65536?i[a++]=t:(t-=65536,i[a++]=55296|t>>10&1023,i[a++]=56320|1023&t)}var r=i,c=a;if(c<65534&&(r.subarray&&cc||!r.subarray&&rc))return String.fromCharCode.apply(null,gr.shrinkBuf(r,c));for(var d="",u=0;u<c;u++)d+=String.fromCharCode(r[u]);return d}function pc(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function _c(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var gc={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8},hc={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},fc=Object.prototype.toString;function mc(e){if(!(this instanceof mc))return new mc(e);this.options=gr.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options,e=(t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new pc,this.strm.avail_out=0,sc.inflateInit2(this.strm,t.windowBits));if(e!==gc.Z_OK)throw new Error(hc[e]);if(this.header=new _c,sc.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=function(e){for(var t,n,o,i,a=e.length,s=0,r=0;r<a;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<a&&56320==(64512&(o=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(o-56320),r++),s+=n<128?1:n<2048?2:n<65536?3:4;for(t=new gr.Buf8(s),r=i=0;i<s;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<a&&56320==(64512&(o=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(o-56320),r++),n<128?t[i++]=n:(n<2048?t[i++]=192|n>>>6:(n<65536?t[i++]=224|n>>>12:(t[i++]=240|n>>>18,t[i++]=128|n>>>12&63),t[i++]=128|n>>>6&63),t[i++]=128|63&n);return t}(t.dictionary):"[object ArrayBuffer]"===fc.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(e=sc.inflateSetDictionary(this.strm,t.dictionary))!==gc.Z_OK))throw new Error(hc[e])}function vc(e,t){t=new mc(t);if(t.push(e,!0),t.err)throw t.msg||hc[t.err];return t.result}mc.prototype.push=function(e,t){var n,o,i,a,s,r=this.strm,c=this.options.chunkSize,l=this.options.dictionary,u=!1;if(this.ended)return!1;o=t===~~t?t:!0===t?gc.Z_FINISH:gc.Z_NO_FLUSH,"string"==typeof e?r.input=function(e){for(var t=new gr.Buf8(e.length),n=0,o=t.length;n<o;n++)t[n]=e.charCodeAt(n);return t}(e):"[object ArrayBuffer]"===fc.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;do{if(0===r.avail_out&&(r.output=new gr.Buf8(c),r.next_out=0,r.avail_out=c),(n=(n=sc.inflate(r,gc.Z_NO_FLUSH))===gc.Z_NEED_DICT&&l?sc.inflateSetDictionary(this.strm,l):n)===gc.Z_BUF_ERROR&&!0===u&&(n=gc.Z_OK,u=!1),n!==gc.Z_STREAM_END&&n!==gc.Z_OK)return this.onEnd(n),!(this.ended=!0);r.next_out&&(0!==r.avail_out&&n!==gc.Z_STREAM_END&&(0!==r.avail_in||o!==gc.Z_FINISH&&o!==gc.Z_SYNC_FLUSH)||("string"===this.options.to?(i=function(e,t){for(var n=(t=(t=t||e.length)>e.length?e.length:t)-1;0<=n&&128==(192&e[n]);)n--;return!(n<0||0===n)&&n+uc[e[n]]>t?n:t}(r.output,r.next_out),a=r.next_out-i,s=dc(r.output,i),r.next_out=a,r.avail_out=c-a,a&&gr.arraySet(r.output,r.output,i,a,0),this.onData(s)):this.onData(gr.shrinkBuf(r.output,r.next_out)))),0===r.avail_in&&0===r.avail_out&&(u=!0)}while((0<r.avail_in||0===r.avail_out)&&n!==gc.Z_STREAM_END);return(o=n===gc.Z_STREAM_END?gc.Z_FINISH:o)===gc.Z_FINISH?(n=sc.inflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===gc.Z_OK):o!==gc.Z_SYNC_FLUSH||(this.onEnd(gc.Z_OK),!(r.avail_out=0))},mc.prototype.onData=function(e){this.chunks.push(e)},mc.prototype.onEnd=function(e){e===gc.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=gr.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Q={},Mc=((0,gr.assign)(Q,{Inflate:mc,inflate:vc,inflateRaw:function(e,t){return(t=t||{}).raw=!0,vc(e,t)},ungzip:vc},gc),Q),Ic=(e(Ac,[{key:"inflate",value:function(e){var t,e=new Uint8Array(e).slice(4),n=Date.now();try{t=Mc.inflate(e,{to:"string"}),this._bLogForInflateOK||(this._bLogForInflateOK=!0,new M("inflateOK").end())}catch(e){return this._bLogForInflateError?void 0:(this._bLogForInflateError=!0,void new M("inflateError").setMessage(e).end())}var e=e.length+4,o=t.length;return A.d("inflate ok. zipped:".concat(e," unzipped:").concat(o)+" compression ratio:".concat(Math.round(100*(o-e)/o),"% cost:").concat(Date.now()-n)),t}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._bLogForInflateOK=!1,this._bLogForInflateError=!1}}]),Ac),yc=(e(Sc,[{key:"_startTimer",value:function(){var e=this._moduleMap.get(24),t=e.isWorkerEnabled();A.l("".concat(this._n,".startTimer isWorkerEnabled:").concat(t," seed:").concat(this._checkTimer)),t?e.startWorkerTimer():this._startMainThreadTimer()}},{key:"_startMainThreadTimer",value:function(){this._checkTimer<0&&(this._checkTimer=setInterval(this.onCheckTimer.bind(this),1e3)),A.l("".concat(this._n,"._startMainThreadTimer seed:").concat(this._checkTimer))}},{key:"stopTimer",value:function(){var e=this._moduleMap.get(24),t=e.isWorkerEnabled();A.l("".concat(this._n,".stopTimer isWorkerEnabled:").concat(t," seed:").concat(this._checkTimer)),t?e.stopWorkerTimer():this._stopMainThreadTimer()}},{key:"_stopMainThreadTimer",value:function(){A.l("".concat(this._n,"._stopMainThreadTimer")),0<this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=-1,this._checkCount=0)}},{key:"_stopMainThreadSocket",value:function(){A.l("".concat(this._n,"._stopMainThreadSocket"));var e=this._moduleMap.get(21);e.setIsWorkerEnabled(!0),e.reConnect()}},{key:"_startMainThreadSocket",value:function(){A.l("".concat(this._n,"._startMainThreadSocket"));var e=this._moduleMap.get(21);e.setIsWorkerEnabled(!1),e.reConnect()}},{key:"onWorkerTimerEnabled",value:function(){A.l("".concat(this._n,".onWorkerTimerEnabled, disable main thread timer and socket")),this._stopMainThreadTimer(),this._stopMainThreadSocket()}},{key:"onWorkerTimerDisabled",value:function(){A.l("".concat(this._n,".onWorkerTimerDisabled, enable main thread timer and socket")),this._startMainThreadTimer(),this._startMainThreadSocket()}},{key:"onCheckTimer",value:function(){this._checkCount+=1;var e,t=N(this._moduleMap);try{for(t.s();!(e=t.n()).done;){var n=I(e.value,2)[1];n.onCheckTimer&&n.onCheckTimer(this._checkCount)}}catch(e){t.e(e)}finally{t.f()}}},{key:"_initReadyList",value:function(){var t=this;this._readyList=[this._moduleMap.get(1)],this._readyList.forEach(function(e){e.ready(function(){return t._onModuleReady()})})}},{key:"_onModuleReady",value:function(){var e,t,n=!0;this._readyList.forEach(function(e){e.isReady()||(n=!1)}),n&&!this._isReady&&(this._isReady=!0,this._outerEmitter.emit(G.SDK_READY),e=Date.now()-this._startLoginTs,A.w("SDK is ready. cost ".concat(e," ms")),this._startLoginTs=Date.now(),t=this._ssoLogForReady.getStartTs()+Re,this._ssoLogForReady.setMessage(e).start(t).end())}},{key:"login",value:function(){0===this._startLoginTs&&(Se(),this._startLoginTs=Date.now(),this._startTimer(),this._moduleMap.get(15).start(),this._ssoLogForReady=new M("sdkReady"),this._reason=C.LOGGING_IN)}},{key:"onLoginFailed",value:function(){this._startLoginTs=0}},{key:"getOuterEmitterInstance",value:function(){return null===this._outerEmitter&&(this._outerEmitter=new ga,e=this._outerEmitter,Fn=e,this._outerEmitter._emit=this._outerEmitter.emit,this._outerEmitter.emit=function(e,t){var n,o,i=this;this._canIUseSignaling()&&(e===G.MESSAGE_RECEIVED&&this.get(33).onNewMessageList(t),e===G.MESSAGE_MODIFIED&&this.get(33).onMessageModified(t)),e===G.CONVERSATION_LIST_UPDATED||e===G.FRIEND_LIST_UPDATED||e===G.GROUP_LIST_UPDATED||e===G.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED?!1!==this._eventThrottling?this._eventThrottleMap.has(e)?(n=Date.now())-(o=this._eventThrottleMap.get(e)).last<=1e3?(o.timeoutID&&clearTimeout(o.timeoutID),o.timeoutID=setTimeout(function(){o.last=Date.now(),i._outerEmitter._emit.apply(i._outerEmitter,[e,{name:e,data:i._getEventData(e)}])},1e3)):(o.last=n,this._outerEmitter._emit.apply(this._outerEmitter,[e,{name:e,data:this._getEventData(e)}])):(this._eventThrottleMap.set(e,{last:Date.now(),timeoutID:-1}),this._outerEmitter._emit.apply(this._outerEmitter,[e,{name:e,data:this._getEventData(e)}])):this._outerEmitter._emit.apply(this._outerEmitter,[e,{name:e,data:this._getEventData(e)}]):this._outerEmitter._emit.apply(this._outerEmitter,[e,{name:e,data:t}])}.bind(this)),this._outerEmitter;var e}},{key:"_canIUseSignaling",value:function(){var e=this.get(33);return!!e&&e.canIUseSignaling()}},{key:"_getEventData",value:function(e){return e===G.CONVERSATION_LIST_UPDATED?this._moduleMap.get(12).isPartialUpdatedConvs()?this._moduleMap.get(11).getPartialUpdatedConvs():this._moduleMap.get(11).getLocalConversationList():e===G.FRIEND_LIST_UPDATED?this._moduleMap.get(8).getLocalFriendList(!1):e===G.GROUP_LIST_UPDATED?this._moduleMap.get(7).getLocalGroupList():e===G.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED?this._moduleMap.get(11).getTotalUnreadMessageCount():e===G.CONVERSATION_ID_LIST_UPDATED?this._moduleMap.get(11).getUpdatedConvIDList():void 0}},{key:"getInnerEmitterInstance",value:function(){return null===this._innerEmitter&&(this._innerEmitter=new ga,this._innerEmitter._emit=this._innerEmitter.emit,this._innerEmitter.emit=function(e,t){e=Ze(t)&&t.data?[e,{name:e,data:t.data}]:[e,{name:e,data:t}];this._innerEmitter._emit.apply(this._innerEmitter,e)}.bind(this)),this._innerEmitter}},{key:"hasModule",value:function(e){return this._moduleMap.has(e)}},{key:"get",value:function(e){return this._moduleMap.get(e)}},{key:"canIUseModule",value:function(e){return!this._moduleMap.get(12).isUsingChatCore()||this._optionalModuleMap.has(e)}},{key:"canIUseInflate",value:function(){return!!this._moduleMap.get(37)}},{key:"isReady",value:function(){return this._isReady}},{key:"isIntl",value:function(){return this.get(12).isIntl()}},{key:"getNotReadyReason",value:function(){return this._reason}},{key:"setNotReadyReason",value:function(e){this._reason=e}},{key:"getErrorMessage",value:function(e,t,n){return this._moduleMap.get(32).get({key:e,replacement1:t,replacement2:n,isIntl:this.isIntl()})}},{key:"outputWarning",value:function(e,t,n){e=this.getErrorMessage(e,t,n);e&&A.w(e)}},{key:"onError",value:function(e){var t="code:".concat(e.code," message:").concat(e.message);A.w("Oops! ".concat(t)),new M("error").setMessage(t).setLevel("error").end(),this.getOuterEmitterInstance().emit(G.ERROR,e)}},{key:"restartTimer",value:function(){A.l("".concat(this._n,".restartTimer")),this.stopTimer(),this._startTimer();var e=this.get(7);e&&e.restartPolling()}},{key:"getTimerID",value:function(){var e=this._moduleMap.get(24);return e.isWorkerEnabled()?e.getTimerID():this._checkTimer}},{key:"getPollingTimerID",value:function(e){return this._moduleMap.get(7).getPollingTimerID(e)}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),Se();var e,t=N(this._moduleMap);try{for(t.s();!(e=t.n()).done;){var n=I(e.value,2)[1];n.reset&&n.reset()}}catch(e){t.e(e)}finally{t.f()}this._startLoginTs=0,this._initReadyList(),this._isReady=!1,this.stopTimer(),this._outerEmitter.emit(G.SDK_NOT_READY);var o,i=N(this._eventThrottleMap);try{for(i.s();!(o=i.n()).done;){var a=I(o.value,2)[1];a.timeoutID&&clearTimeout(a.timeoutID)}}catch(e){i.e(e)}finally{i.f()}this._eventThrottleMap.clear()}}]),Sc),Cc=(e(Lc,[{key:"defense",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;if("string"!=typeof e)return null;if(0===e.length)return null;if("function"!=typeof t)return null;if(this._funcMap.has(e)&&this._funcMap.get(e).has(t))return this._funcMap.get(e).get(t);this._funcMap.has(e)||this._funcMap.set(e,new Map);var o=null;return this._funcMap.get(e).has(t)?o=this._funcMap.get(e).get(t):(o=this._pack(e,t,n),this._funcMap.get(e).set(t,o)),o}},{key:"defenseOnce",value:function(e,t){return"function"!=typeof t?null:this._pack(e,t,2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0)}},{key:"find",value:function(e,t){return"string"!=typeof e||0===e.length||"function"!=typeof t?null:this._funcMap.has(e)&&this._funcMap.get(e).has(t)?this._funcMap.get(e).get(t):(this._m.outputWarning("ListenerFnNotFound",e),null)}},{key:"delete",value:function(e,t){return"function"==typeof t&&!!this._funcMap.has(e)&&!!this._funcMap.get(e).has(t)&&(this._funcMap.get(e).delete(t),0===this._funcMap.get(e).size&&this._funcMap.delete(e),!0)}},{key:"_pack",value:function(o,e,i){var a=this;return function(){try{e.apply(i,Array.from(arguments))}catch(e){var t=Object.values(G).indexOf(o),n="CallbackError";-1!==t&&(t=Object.keys(G)[t],a._m.outputWarning(n,t,e)),a._reportCount<5&&(new M(n).setMessage("eventName:".concat(o)).setMoreMessage(e.message).end(),a._reportCount+=1)}}}},{key:"destroy",value:function(){this._funcMap.clear()}},{key:"reset",value:function(){A.l("".concat(this._n,".reset")),this._reportCount=0}}]),Lc),Tc=(e(Ec,[{key:"onError",value:function(e){this._m.onError(e)}},{key:"login",value:function(e){return this._m.login(),this._get(1).login(e)}},{key:"logout",value:function(){var t=this;return this._get(1).logout().then(function(e){return t._safetyCallbackFactory.reset(),t._m.reset(),e})}},{key:"getLoginUser",value:function(){return this._get(1).getLoginUser()}},{key:"isReady",value:function(){return this._m.isReady()}},{key:"isIntl",value:function(){return this._m.isIntl()}},{key:"getNotReadyReason",value:function(){return this._m.getNotReadyReason()}},{key:"getErrorMessage",value:function(e,t,n){return this._m.getErrorMessage(e,t,n)}},{key:"_get",value:function(e){return this._m.get(e)}},{key:"destroy",value:function(){var n=this;return this.logout().finally(function(){n._safetyCallbackFactory.destroy(),n._m.stopTimer(),n._get(24).terminate(),n._get(21).dealloc();var e=n._m.getOuterEmitterInstance(),t=n._get(12);e.emit(G.SDK_DESTROY,{SDKAppID:t.getSDKAppID()})})}},{key:"on",value:function(e,t,n){A.d("on","eventName:".concat(e)),this._m.getOuterEmitterInstance().on(e,this._safetyCallbackFactory.defense(e,t,n),n)}},{key:"once",value:function(e,t,n){A.d("once","eventName:".concat(e)),this._m.getOuterEmitterInstance().once(e,this._safetyCallbackFactory.defenseOnce(e,t,n),n||this)}},{key:"off",value:function(e,t,n,o){A.d("off","eventName:".concat(e));var i=this._safetyCallbackFactory.find(e,t);null!==i&&(this._m.getOuterEmitterInstance().off(e,i,n,o),this._safetyCallbackFactory.delete(e,t))}},{key:"registerPlugin",value:function(e){(k(e["tim-push"])?k(e["tim-offline-push-plugin"])?this._get(18):this._get(28):this._get(36)).registerPlugin(e)}},{key:"setLogLevel",value:function(e){var t;e<=0&&((t=this.getErrorMessage("TIM_ASCII_ART"))&&console.log(t),(t=this.getErrorMessage("API_REFER"))&&(Kt()?console.log("%c ".concat("IM SDK API ->"," %c"),"background:#ff9d00; padding:1px; border-radius:3px; color: #fff","background:transparent",t):console.log("IM SDK API ->",t)),(t=this.getErrorMessage("DOCS_GUIDE"))&&console.log(t),t=this.getErrorMessage("IOS_WEBVIEW_WARNING"),ye&&t&&console.warn(t)),A.setLevel(e)}},{key:"createTextMessage",value:function(e){return this._get(2).createTextMessage(e)}},{key:"createTextAtMessage",value:function(e){return this._get(2).createTextMessage(e)}},{key:"createImageMessage",value:function(e){return this._get(2).createImageMessage(e)}},{key:"createAudioMessage",value:function(e){return this._get(2).createAudioMessage(e)}},{key:"createVideoMessage",value:function(e){return this._get(2).createVideoMessage(e)}},{key:"createCustomMessage",value:function(e){return this._get(2).createCustomMessage(e)}},{key:"createFaceMessage",value:function(e){return this._get(2).createFaceMessage(e)}},{key:"createFileMessage",value:function(e){return this._get(2).createFileMessage(e)}},{key:"createLocationMessage",value:function(e){return this._get(2).createLocationMessage(e)}},{key:"createMergerMessage",value:function(e){return this._get(2).createMergerMessage(e)}},{key:"downloadMergerMessage",value:function(e){return e.type!==S.MSG_MERGER?m({code:C.MSG_MERGER_TYPE_INVALID}):We(e.payload.downloadKey)?m({code:C.MSG_MERGER_KEY_INVALID}):this._get(2).downloadMergerMessage(e).catch(function(e){return m({code:C.MSG_MERGER_DOWNLOAD_FAIL})})}},{key:"createForwardMessage",value:function(e){return this._get(2).createForwardMessage(e)}},{key:"sendMessage",value:function(e,t){return e instanceof go?this._get(2).sendMessageInstance(e,t):m({code:C.MSG_INSTANCE_REQUIRED})}},{key:"searchCloudMessages",value:function(e){return this._get(2).searchCloudMessages(e)}},{key:"callExperimentalAPI",value:function(e,t){return"sendComboMessage"===e?this._get(31).sendMessage(t):"handleGroupInvitation"===e?this._get(7).handleGroupInvitation(t):"isCommercialAbilityEnabled"===e?this._get(27).isFeatureEnabled(t):"isFeatureEnabledForStat"===e?this._get(27).isFeatureEnabledForStat(t):"isIntl"===e?this.isIntl():"sendTRTCCustomData"===e||"sendRoomCustomData"===e?this._get(30).sendTRTCCustomData(t):"getTimerID"===e?this._m.getTimerID():"getPollingTimerID"===e?this._m.getPollingTimerID(t):"setApplicationID"===e?(this._get(12).setApplicationID(t),void this._get(20).updateProtocolConfig()):"getServerConfig"===e?this._get(23).getServerConfig(t):"canIUseModule"===e?this._m.canIUseModule(t):"startMessageLongPolling"===e?this._get(7).startMessageLongPolling(t):"stopMessageLongPolling"===e?this._get(7).stopMessageLongPolling(t):m({code:C.INVALID_OPERATION})}},{key:"revokeMessage",value:function(e){return this._get(2).revokeMessage(e)}},{key:"resendMessage",value:function(e,t){return e instanceof go?this._get(2).resendMessage(e,t):m({code:C.MSG_INSTANCE_REQUIRED})}},{key:"deleteMessage",value:function(e){return this._get(2).deleteMessage(e)}},{key:"translateText",value:function(e){return this._get(2).translateText(e)}},{key:"convertVoiceToText",value:function(e){return this._get(2).convertVoiceToText(e)}},{key:"setMessageExtensions",value:function(e,t){return this._get(3).setMessageExtensions(e,t)}},{key:"getMessageExtensions",value:function(e){return this._get(3).getMessageExtensions(e)}},{key:"deleteMessageExtensions",value:function(e,t){return this._get(3).deleteMessageExtensions(e,t)}},{key:"addMessageReaction",value:function(e,t){return this._get(34).addMessageReaction(e,t)}},{key:"removeMessageReaction",value:function(e,t){return this._get(34).removeMessageReaction(e,t)}},{key:"getMessageReactions",value:function(e){return this._get(34).getMessageReactions(e)}},{key:"getAllUserListOfMessageReaction",value:function(e){return this._get(34).getAllUserListOfMessageReaction(e)}},{key:"modifyMessage",value:function(e){return this._get(2).modifyRemoteMessage(e)}},{key:"getMessageList",value:function(e){return this._get(11).getMessageList(e)}},{key:"getMessageListHopping",value:function(e){return this._get(11).getMessageListHopping(e)}},{key:"sendMessageReadReceipt",value:function(e){return this._get(11).sendReadReceipt(e)}},{key:"getMessageReadReceiptList",value:function(e){return this._get(11).getReadReceiptList(e)}},{key:"getGroupMessageReadMemberList",value:function(e){var t=this._get(7);return t?t.getReadReceiptDetail(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"findMessage",value:function(e){return this._get(11).findMessage(e)}},{key:"setMessageRead",value:function(e){return this._get(11).setMessageRead(e)}},{key:"getConversationList",value:function(e){return this._get(11).getConversationList(e)}},{key:"getConversationProfile",value:function(e){return this._get(11).getConversationProfile(e)}},{key:"deleteConversation",value:function(e){return this._get(11).deleteConversation(e)}},{key:"setConversationDraft",value:function(e){return this._get(11).setConversationDraft(e)}},{key:"clearHistoryMessage",value:function(e){return this._get(11).clearHistoryMessage(e)}},{key:"pinConversation",value:function(e){return this._get(11).pinConversation(e)}},{key:"setAllMessageRead",value:function(e){return this._get(11).setAllMessageRead(e)}},{key:"setMessageRemindType",value:function(e){return this._get(11).setMessageRemindType(e)}},{key:"setAllReceiveMessageOpt",value:function(e){return this._get(11).setAllReceiveMessageOpt(e)}},{key:"getAllReceiveMessageOpt",value:function(){return this._get(11).getAllReceiveMessageOpt()}},{key:"getTotalUnreadMessageCount",value:function(){return this._get(11).getTotalUnreadMessageCount()}},{key:"setConversationCustomData",value:function(e){return this._get(11).setConversationCustomData(e)}},{key:"markConversation",value:function(e){return this._get(11).markConversation(e)}},{key:"getConversationGroupList",value:function(){return this._get(11).getConversationGroupList()}},{key:"createConversationGroup",value:function(e){return this._get(11).createConversationGroup(e)}},{key:"deleteConversationGroup",value:function(e){return this._get(11).deleteConversationGroup(e)}},{key:"renameConversationGroup",value:function(e){return this._get(11).renameConversationGroup(e)}},{key:"addConversationsToGroup",value:function(e){return this._get(11).addConversationsToGroup(e)}},{key:"deleteConversationsFromGroup",value:function(e){return this._get(11).deleteConversationsFromGroup(e)}},{key:"getMyProfile",value:function(){return this._get(4).getMyProfile()}},{key:"getUserProfile",value:function(e){return this._get(4).getUserProfile(e)}},{key:"updateMyProfile",value:function(e){return this._get(4).updateMyProfile(e)}},{key:"getBlacklist",value:function(){return this._get(4).getLocalBlacklist()}},{key:"addToBlacklist",value:function(e){return this._get(4).addBlacklist(e)}},{key:"removeFromBlacklist",value:function(e){return this._get(4).deleteBlacklist(e)}},{key:"setSelfStatus",value:function(e){return this._get(4).setSelfStatus(e)}},{key:"getUserStatus",value:function(e){return this._get(4).getUserStatus(e)}},{key:"subscribeUserStatus",value:function(e){return this._get(4).subscribeUserStatus(e)}},{key:"unsubscribeUserStatus",value:function(e){return this._get(4).unsubscribeUserStatus(e)}},{key:"getFriendList",value:function(){var e=this._get(8);return e?e.getLocalFriendList():m({code:C.CANNOT_FIND_MODULE})}},{key:"addFriend",value:function(e){var t=this._get(8);return t?t.addFriend(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"deleteFriend",value:function(e){var t=this._get(8);return t?t.deleteFriend(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"checkFriend",value:function(e){var t=this._get(8);return t?t.checkFriend(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getFriendProfile",value:function(e){var t=this._get(8);return t?t.getFriendProfile(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"updateFriend",value:function(e){var t=this._get(8);return t?t.updateFriend(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getFriendApplicationList",value:function(){var e=this._get(8);return e?e.getLocalFriendApplicationList():m({code:C.CANNOT_FIND_MODULE})}},{key:"acceptFriendApplication",value:function(e){var t=this._get(8);return t?t.acceptFriendApplication(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"refuseFriendApplication",value:function(e){var t=this._get(8);return t?t.refuseFriendApplication(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"deleteFriendApplication",value:function(e){var t=this._get(8);return t?t.deleteFriendApplication(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"setFriendApplicationRead",value:function(){var e=this._get(8);return e?e.setFriendApplicationRead():m({code:C.CANNOT_FIND_MODULE})}},{key:"getFriendGroupList",value:function(){var e=this._get(8);return e?e.getLocalFriendGroupList():m({code:C.CANNOT_FIND_MODULE})}},{key:"createFriendGroup",value:function(e){var t=this._get(8);return t?t.createFriendGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"deleteFriendGroup",value:function(e){var t=this._get(8);return t?t.deleteFriendGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"addToFriendGroup",value:function(e){var t=this._get(8);return t?t.addToFriendGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"removeFromFriendGroup",value:function(e){var t=this._get(8);return t?t.removeFromFriendGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"renameFriendGroup",value:function(e){var t=this._get(8);return t?t.renameFriendGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"followUser",value:function(e){var t=this._get(35);return t?t.followUser(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"unfollowUser",value:function(e){var t=this._get(35);return t?t.unfollowUser(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getMyFollowersList",value:function(e){var t=this._get(35);return t?t.getMyFollowersList(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getMyFollowingList",value:function(e){var t=this._get(35);return t?t.getMyFollowingList(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getMutualFollowersList",value:function(e){var t=this._get(35);return t?t.getMutualFollowersList(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getUserFollowInfo",value:function(e){var t=this._get(35);return t?t.getUserFollowInfo(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"checkFollowType",value:function(e){var t=this._get(35);return t?t.checkFollowType(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getGroupList",value:function(){var e=this._get(7);return e?e.getGroupList():m({code:C.CANNOT_FIND_MODULE})}},{key:"getGroupProfile",value:function(e){var t=this._get(7);return t?t.getGroupProfile(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"createGroup",value:function(e){var t=this._get(7);return t?t.createGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"dismissGroup",value:function(e){var t=this._get(7);return t?t.dismissGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"updateGroupProfile",value:function(e){var t=this._get(7);return t?t.updateGroupProfile(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"joinGroup",value:function(e){var t=this._get(7);return t?t.joinGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"quitGroup",value:function(e){var t=this._get(7);return t?t.quitGroup(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"searchGroupByID",value:function(e){var t=this._get(7);return t?t.searchGroupByID(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getGroupOnlineMemberCount",value:function(e){var t=this._get(7);return t?t.getGroupOnlineMemberCount(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"changeGroupOwner",value:function(e){var t=this._get(7);return t?t.changeGroupOwner(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getGroupApplicationList",value:function(){var e=this._get(7);return e?e.getGroupApplicationList():m({code:C.CANNOT_FIND_MODULE})}},{key:"handleGroupApplication",value:function(e){var t=this._get(7);return t?t.handleGroupApplication(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"initGroupAttributes",value:function(e){var t=this._get(7);return t?t.initGroupAttributes(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"setGroupAttributes",value:function(e){var t=this._get(7);return t?t.setGroupAttributes(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"deleteGroupAttributes",value:function(e){var t=this._get(7);return t?t.deleteGroupAttributes(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getGroupAttributes",value:function(e){var t=this._get(7);return t?t.getGroupAttributes(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"setGroupCounters",value:function(e){var t=this._get(7);return t?t.setGroupCounters(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"increaseGroupCounter",value:function(e){var t=this._get(7);return t?t.increaseGroupCounter(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"decreaseGroupCounter",value:function(e){var t=this._get(7);return t?t.decreaseGroupCounter(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getGroupCounters",value:function(e){var t=this._get(7);return t?t.getGroupCounters(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getGroupMemberList",value:function(e){var t=this._get(7);return t?t.getGroupMemberList(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getGroupMemberProfile",value:function(e){var t=this._get(7);return t?t.getGroupMemberProfile(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"addGroupMember",value:function(e){var t=this._get(7);return t?t.addGroupMember(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"deleteGroupMember",value:function(e){var t=this._get(7);return t?t.deleteGroupMember(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"setGroupMemberMuteTime",value:function(e){var t=this._get(7);return t?t.setGroupMemberMuteTime(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"setGroupMemberRole",value:function(e){var t=this._get(7);return t?t.setGroupMemberRole(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"setGroupMemberNameCard",value:function(e){var t=this._get(7);return t?t.setGroupMemberNameCard(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"setGroupMemberCustomField",value:function(e){var t=this._get(7);return t?t.setGroupMemberCustomField(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"markGroupMemberList",value:function(e){var t=this._get(7);return t?t.markGroupMemberList(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getJoinedCommunityList",value:function(){return this._get(10).getJoinedCommunityList()}},{key:"createTopicInCommunity",value:function(e){return this._get(10).createTopicInCommunity(e)}},{key:"deleteTopicFromCommunity",value:function(e){return this._get(10).deleteTopicFromCommunity(e)}},{key:"updateTopicProfile",value:function(e){return this._get(10).updateTopicProfile(e)}},{key:"getTopicList",value:function(e){return this._get(10).getTopicList(e)}},{key:"addSignalingListener",value:function(e,t,n){var o=this._get(33);o&&o.addSignalingListener(e,this._safetyCallbackFactory.defense(e,t,n),n)}},{key:"removeSignalingListener",value:function(e,t,n){var o,i=this._safetyCallbackFactory.find(e,t);null===i||(o=this._get(33))&&(o.removeSignalingListener(e,i,n),this._safetyCallbackFactory.delete(e,t))}},{key:"invite",value:function(e){var t=this._get(33);return t?t.invite(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"inviteSync",value:function(e,t,n){var o=this._get(33);return o?o.inviteSync(e,t,n):""}},{key:"inviteInGroup",value:function(e){var t=this._get(33);return t?t.invite(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"inviteInGroupSync",value:function(e,t,n){var o=this._get(33);return o?o.inviteSync(e,t,n):""}},{key:"cancel",value:function(e){var t=this._get(33);return t?t.cancel(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"accept",value:function(e){var t=this._get(33);return t?t.accept(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"reject",value:function(e){var t=this._get(33);return t?t.reject(e):m({code:C.CANNOT_FIND_MODULE})}},{key:"getSignalingInfo",value:function(e){var t=this._get(33);return t?t.getSignalingInfo(e):null}},{key:"modifyInvitation",value:function(e){var t=this._get(33);return t?t.modifyInvitation(e):m({code:C.CANNOT_FIND_MODULE})}}]),Ec),Dc={login:1,logout:1,getLoginUser:1,destroy:1,on:1,off:1,ready:1,setLogLevel:1,joinGroup:1,quitGroup:1,registerPlugin:1,getGroupOnlineMemberCount:1,isReady:1,addSignalingListener:1,removeSignalingListener:1,callExperimentalAPI:1};function Ec(e){u(this,Ec);e={SDKAppID:e.SDKAppID,unlimitedAVChatRoom:e.unlimitedAVChatRoom||!1,scene:e.scene||"",oversea:e.oversea||!1,instanceID:Ot(),devMode:e.devMode||!1,testEnv:e.testEnv||!1,proxyServer:e.proxyServer||void 0,fileUploadProxy:e.fileUploadProxy||void 0,fileDownloadProxy:e.fileDownloadProxy||e.fileUploadProxy||void 0,eventThrottling:!1!==e.eventThrottling,partialUpdatedConversations:!0===e.partialUpdatedConversations,modules:e.modules||void 0};this._m=new yc(e),this._vendorMap=new Map,this._safetyCallbackFactory=new Cc(this._m)}function Lc(e){u(this,Lc),this._funcMap=new Map,this._m=e,this._n="SafetyCallback",this._reportCount=0}function Sc(t){var n=this;u(this,Sc);var o,e=new M("sdkConstruct"),i=(this._n="ModuleManager",this._isReady=!1,this._reason=C.USER_NOT_LOGGED_IN,this._startLoginTs=0,this._moduleMap=new Map,this._optionalModuleMap=new Map,this._innerEmitter=null,this._outerEmitter=null,this._checkCount=0,this._checkTimer=-1,this._moduleMap.set(12,new Ei(this,t)),this._moduleMap.set(37,new Ic(this)),this._moduleMap.set(15,new ra(this)),this._moduleMap.set(27,new Qs(this)),this._moduleMap.set(23,new bs(this)),this._moduleMap.set(24,new Xs(this)),this._moduleMap.set(26,new Hs(this)),this._moduleMap.set(21,new as(this)),this._moduleMap.set(20,new Us(this)),this._moduleMap.set(1,new Si(this)),this._moduleMap.set(2,new Oa(this)),this._moduleMap.set(3,new Na(this)),this._moduleMap.set(34,new Ga(this)),this._moduleMap.set(31,new Pa(this)),this._moduleMap.set(4,new Di(this)),this._moduleMap.set(6,new Go(this)),this._moduleMap.set(11,new ii(this)),this._moduleMap.set(7,new fi(this)),this._moduleMap.set(10,new Mi(this)),this._moduleMap.set(13,new na(this)),this._moduleMap.set(32,new or(this)),this._moduleMap.set(14,new ia(this)),this._moduleMap.set(17,new fa(this)),this._moduleMap.set(18,new Ua(this)),this._moduleMap.set(19,new ba(this)),this._moduleMap.set(25,new Fs(this)),this._moduleMap.set(8,new zs(this)),this._moduleMap.set(28,new $s(this)),this._moduleMap.set(36,new er(this)),this._moduleMap.set(29,new tr(this)),this._moduleMap.set(30,new nr(this)),this._moduleMap.set(33,new lr(this)),this._moduleMap.set(35,new _r(this)),this._eventThrottleMap=new Map,this._eventThrottling=t.eventThrottling,Ze(t.modules)?(Object.keys(t.modules).forEach(function(e){o=t.modules[e],"group-module"===e?n._moduleMap.set(7,new o(n)):"relationship-module"===e?n._moduleMap.set(8,new o(n)):"signaling-module"===e?n._moduleMap.set(33,new o(n)):"follow-module"===e&&n._moduleMap.set(35,new o(n)),n._optionalModuleMap.set(e,1)}),this._moduleMap.get(12).setUsingChatCore(!0)):this._moduleMap.has(7)||this._moduleMap.get(12).setUsingChatCore(!0),t.instanceID),a=t.SDKAppID,s=this._moduleMap.get(12).isIntl(),r=this._moduleMap.get(12).isUsingChatCore(),i="instanceID:".concat(i," SDKAppID:").concat(a," isIntl:").concat(s," isUsingChatCore:").concat(r," host:").concat(Nt()," isIOSWebView:").concat(ye)+" inBrowser:".concat(ne," inMiniApp:").concat(te)+" canIUseInflate:".concat(this.canIUseInflate())+" workerAvailable:".concat(ve," UserAgent:").concat(ie);M.bindEventStatModule(this._moduleMap.get(14)),M.bindNetMonitorModule(this._moduleMap.get(15)),e.setMessage("".concat(i," ").concat(function(){var t="";if(te)try{var e=oe.getSystemInfoSync(),n=e.model,o=e.version,i=e.system,a=e.platform,s=e.SDKVersion,t="model:".concat(n," version:").concat(o," system:").concat(i," platform:").concat(a," SDKVersion:").concat(s)}catch(e){t=""}return t}())).end(),A.i("SDK ".concat(i)),bn.prototype._getErrorMessage=this.getErrorMessage.bind(this),this._readyList=void 0,this._ssoLogForReady=null,this._initReadyList()}function Ac(e){u(this,Ac),this._m=e,this._n="InflateModule",this._bLogForInflateOK=!1,this._bLogForInflateError=!1}var kc={},ae={};return ae.create=function(e){var t="TencentCloudChat.create",n=0,o=e.SDKAppID;if(ze(o))n=o;else if(n=parseInt(o),isNaN(o))return A.e("".concat(t," failed. Failed to parse the SDKAppID, please check the arguments")),null;if(n&&kc[n])return kc[n];A.l("".concat(t));var i,a,o=new Tc(y(y({},e),{},{SDKAppID:n})),e=(o.on(G.SDK_DESTROY,function(e){kc[e.data.SDKAppID]=null,delete kc[e.data.SDKAppID]}),i=o,a=Object.create(null),Object.keys(Un).forEach(function(o){var t;i[o]&&(t=new U,a[o]=function(){var e=Array.from(arguments);return t.use(function(e,t){var n=function(e,t){if(e.isReady()||1===Dc[t])return!0;var n={code:n=e.getNotReadyReason(),message:"".concat(e.getErrorMessage(n)," | ").concat(t," | ").concat(e.getErrorMessage(C.SDK_IS_NOT_READY))};return e.onError(n),n}(i,o);return!0===n?t():m(n)}).use(function(e,t){if(!0===function(n,o,i){if(void 0===o)return!0;var a=!0;if(Ze(o))Object.keys(o).forEach(function(e){var t=1===n.length?n[0][e]:void 0;a=!!Zt(t,o[e],i,e)&&a});else if(Qe(o))for(var e=0;e<o.length;e++)a=!!Zt(n[e],o[e],i,o[e].name)&&a;if(a)return a;throw new Error("Params validate failed.")}(e,Pn[o],o))return t()}).use(function(e,t){return i[o].apply(i,e)}),t.run(e)})}),a);return kc[n]=e,Pn.hookGetAPITips(o.getErrorMessage.bind(o)),A.l("".concat(t," ok")),e},ae.TYPES=S,ae.EVENT=G,ae.TSignaling=P,ae.VERSION="3.3.5",A.l("TencentCloudChat.VERSION:".concat(ae.VERSION)),ae});