"use strict";const e=2,t=4,s=10,o=11,r=12,i=14,n=20,a=23,u=26,p=27,l=29,c=30,h=34;class g{constructor(e=0,t=0){this.high=e,this.low=t}equal(e){return null!==e&&this.low===e.low&&this.high===e.high}toString(){var e=Number(this.high).toString(16);let t=Number(this.low).toString(16);if(t.length<8){let e=8-t.length;for(;e;)t="0"+t,e--}return e+t}}const m={TEST:{CHINA:{DEFAULT:"wss://wss-dev.tim.qq.com"},OVERSEA:{DEFAULT:"wss://wss-dev.tim.qq.com"},SINGAPORE:{DEFAULT:"wss://wsssgp-dev.im.qcloud.com"},KOREA:{DEFAULT:"wss://wsskr-dev.im.qcloud.com"},GERMANY:{DEFAULT:"wss://wssger-dev.im.qcloud.com"},IND:{DEFAULT:"wss://wssind-dev.im.qcloud.com"},JPN:{DEFAULT:"wss://wssjpn-dev.im.qcloud.com"},USA:{DEFAULT:"wss://wssusa-dev.im.qcloud.com"},INDONESIA:{DEFAULT:"wss://wssidn-dev.im.qcloud.com"}},PRODUCTION:{CHINA:{DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.tim.qq.com",STAT:"https://events.im.qcloud.com",ANYCAST:"wss://162.14.13.203"},OVERSEA:{DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.my-imcloud.com",STAT:"https://api.my-imcloud.com"},SINGAPORE:{DEFAULT:"wss://wsssgp.im.qcloud.com",BACKUP:"wss://wsssgp.my-imcloud.com",STAT:"https://apisgp.my-imcloud.com",ANYCAST:"wss://162.14.19.159"},KOREA:{DEFAULT:"wss://wsskr.im.qcloud.com",BACKUP:"wss://wsskr.my-imcloud.com",STAT:"https://apikr.my-imcloud.com",ANYCAST:"wss://162.14.13.104"},GERMANY:{DEFAULT:"wss://wssger.im.qcloud.com",BACKUP:"wss://wssger.my-imcloud.com",STAT:"https://apiger.my-imcloud.com",ANYCAST:"wss://162.14.3.17"},IND:{DEFAULT:"wss://wssind.my-imcloud.com",BACKUP:"wss://wssind.im.qcloud.com",STAT:"https://apiind.my-imcloud.com",ANYCAST:"wss://162.14.18.188"},JPN:{DEFAULT:"wss://wssjpn.im.qcloud.com",BACKUP:"wss://wssjpn.my-imcloud.com",STAT:"https://apijpn.my-imcloud.com"},USA:{DEFAULT:"wss://wssusa.im.qcloud.com",BACKUP:"wss://wssusa.my-imcloud.com",STAT:"https://apiusa.my-imcloud.com",ANYCAST:"wss://162.14.10.42"},INDONESIA:{DEFAULT:"wss://wssidn.im.qcloud.com",BACKUP:"wss://wssidn.my-imcloud.com",STAT:"https://apiidn.my-imcloud.com",ANYCAST:"wss://43.129.34.169"}}},d={ANDROID:2,IOS:3,MAC:4,WEB:7,WX_MP:8,QQ_MP:9,TT_MP:10,BAIDU_MP:11,ALI_MP:12,IPAD:13,UNI_NATIVE_APP:15},_="CHINA",f={HOST:{CURRENT:{DEFAULT:"wss://wss.im.qcloud.com",STAT:"https://events.im.qcloud.com"},setCurrent(e=_){this.CURRENT=m.PRODUCTION[e]}},NAME:{OPEN_IM:"openim",OPEN_IM_MSG_EXT:"openim_msg_ext_http_svc",GRP:"group_open_http_svc",GRP_AV:"group_open_avchatroom_http_svc",GRP_COMMUNITY:"million_group_open_http_svc",GRP_ATTR:"group_open_attr_http_svc",FD:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GRP_NO_AUTH:"group_open_http_noauth_svc",BIG_GRP_POLLING:"group_open_long_polling_http_svc",BIG_GRP_POLLING_NO_AUTH:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat",WEB_IM:"webim",IM_COS_SIGN:"im_cos_sign_svr",CUSTOM_UPLOAD:"im_cos_msg",HEARTBEAT:"heartbeat",IM_OPEN_PUSH:"im_open_push",IM_OPEN_STATUS:"im_open_status",IM_LONG_MSG:"im_long_msg",IM_CONFIG_MANAGER:"im_sdk_config_mgr",STAT_SERVICE:"StatSvc",OVERLOAD_PUSH:"OverLoadPush",IM_MSG_AUDIT_MGR:"im_msg_audit_mgr",TUIROOM_SVR:"tui_room_svr",IM_OPEN_TRANSLATE:"im_open_translate",IM_OPEN_SPEECH:"im_open_speech",MSG_SEARCH:"message_search",FOLLOW:"follow",OFFLINE_PUSH_REPORT:"offline_push_report",IM_MSG_LOGIC:"im_msg_db_logic"}},M={SEARCH_GRP_SNS:new g(0,Math.pow(2,1)).toString(),AV_HISTORY_MSG:new g(0,Math.pow(2,2)).toString(),GRP_COMMUNITY:new g(0,Math.pow(2,3)).toString(),MSG_TO_SPECIFIED_GRP_MBR:new g(0,Math.pow(2,4)).toString(),AV_MBR_LIST:new g(0,Math.pow(2,6)).toString(),USER_STATUS:new g(0,Math.pow(2,7)).toString(),CONV_MARK:new g(0,Math.pow(2,9)).toString(),CONV_GROUP:new g(0,Math.pow(2,10)).toString(),AV_BAN_MBR:new g(0,Math.pow(2,11)).toString(),MSG_EXT:new g(0,Math.pow(2,13)).toString(),GRP_COUNTER:new g(0,Math.pow(2,15)).toString(),PLUGIN_TRANSLATE:new g(Math.pow(2,6)).toString(),PLUGIN_VOICE_TO_TEXT:new g(Math.pow(2,7)).toString(),PLUGIN_CS:new g(Math.pow(2,8)).toString(),PLUGIN_PUSH:new g(Math.pow(2,9)).toString(),PLUGIN_BOT:new g(Math.pow(2,10)).toString(),MSG_REACTION:new g(Math.pow(2,16)).toString(),FOLLOW:new g(Math.pow(2,20)).toString()},I="group_profile",D="group_member_profile",L=(f.HOST.setCurrent(_),"undefined"!=typeof wx&&"function"==typeof wx.getSystemInfoSync&&Boolean(wx.getSystemInfoSync().fontSizeSetting)),y=(L&&wx.createGamePortal,"undefined"!=typeof qq&&"function"==typeof qq.getSystemInfoSync&&Boolean(qq.getSystemInfoSync().fontSizeSetting)),G="undefined"!=typeof tt&&"function"==typeof tt.getSystemInfoSync&&Boolean(tt.getSystemInfoSync().fontSizeSetting),C="undefined"!=typeof swan&&"function"==typeof swan.getSystemInfoSync&&Boolean(swan.getSystemInfoSync().fontSizeSetting),b="undefined"!=typeof my&&"function"==typeof my.getSystemInfoSync&&Boolean(my.getSystemInfoSync().fontSizeSetting),T="undefined"!=typeof jd&&"function"==typeof jd.getSystemInfoSync,A="undefined"!=typeof uni&&"undefined"==typeof window&&"function"==typeof uni.requireNativePlugin,S=L||y||G||C||b||A||T,v=("undefined"!=typeof uni||"undefined"!=typeof window)&&!S,R=(y?qq:G?tt:C?swan:b?my:L?wx:A?uni:T&&jd,v&&window&&window.navigator&&window.navigator.userAgent||""),$=/(micromessenger|webbrowser)/i.test(R),P=/AppleWebKit\/([\d.]+)/i.exec(R),E=(P&&parseFloat(P.pop()),function(){let e="WEB";return $?e="WEB":y?e="QQ_MP":G?e="TT_MP":C?e="BAIDU_MP":b?e="ALI_MP":L?e="WX_MP":A&&(e="UNI_NATIVE_APP"),d[e]}()),w=(!function(){var e=R.match(/OS (\d+)_/i);e&&e[1]&&e[1]}(),function(){var e,t,s=R.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);s&&(e=s[1]&&parseFloat(s[1]),t=s[2]&&parseFloat(s[2]),e&&t&&parseFloat(s[1]+"."+s[2]))}(),function(){var e=R.match(/Chrome\/(\d+)/);e&&e[1]&&parseFloat(e[1])}(),/MSIE/.test(R)||-1<R.indexOf("Trident")&&-1<R.indexOf("rv:11.0"));let U,N;!function(){var e=/MSIE\s(\d+)\.\d/.exec(R),e=e&&parseFloat(e[1]);!e&&/Trident\/7.0/i.test(R)&&/rv:11.0/.test(R)}(),function(){var e=R.match(/TBS\/(\d+)/i);e&&e[1]&&e[1]}(),U="undefined"!=typeof console?console:"undefined"!=typeof global&&global.console?global.console:"undefined"!=typeof window&&window.console?window.console:{};const q=function(){},k=["assert","clear","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"];let O=k.length;for(;O--;)N=k[O],console[N]||(U[N]=q);var F=U;const x="TIMTextElem",V="TIMImageElem",H="TIMSoundElem",j="TIMFileElem",B="TIMFaceElem",K="TIMVideoFileElem",J="TIMLocationElem",W="TIMGroupTipElem",z="TIMGroupSystemNoticeElem",X="TIMCustomElem",Y="TIMRelayElem",Q="High",Z="Normal",ee="Low",te="Lowest",se="C2C",oe="GROUP",re="TOPIC",ie="@TIM#SYSTEM",ne="Private",ae="Public",ue="ChatRoom",pe="AVChatRoom",le="Community",ce="Room",he="Live",ge="Owner",me="Admin",de="Member",_e="Custom",fe=1,Me=3,Ie=4,De=5,Le="AcceptAndNotify",ye="AlreadyInGroup",Ge="__kImSDK_MesssageAtALL__",Ce=function(){return(new Date).getTime()+0},be={JPG:1,JPEG:1,GIF:2,PNG:3,BMP:4,UNKNOWN:255},Te={NICK:"Tag_Profile_IM_Nick",GENDER:"Tag_Profile_IM_Gender",BIRTHDAY:"Tag_Profile_IM_BirthDay",LOCATION:"Tag_Profile_IM_Location",SELFSIGNATURE:"Tag_Profile_IM_SelfSignature",ALLOWTYPE:"Tag_Profile_IM_AllowType",LANGUAGE:"Tag_Profile_IM_Language",AVATAR:"Tag_Profile_IM_Image",MESSAGESETTINGS:"Tag_Profile_IM_MsgSettings",ADMINFORBIDTYPE:"Tag_Profile_IM_AdminForbidType",LEVEL:"Tag_Profile_IM_Level",ROLE:"Tag_Profile_IM_Role"},Ae="JoinedSuccess",Se="WaitAdminApproval",ve="@TGS#_",Re="@TOPIC#_",$e=Object.prototype.hasOwnProperty;function Pe(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(ke(e)){for(const t in e)if($e.call(e,t))return!1;return!0}return!!(Ee(e)||we(e)||Ue(e))&&0===e.size}const Ee=function(e){return"map"===Ve(e)},we=function(e){return"set"===Ve(e)},Ue=function(e){return"file"===Ve(e)},Ne=function(e){return null!==e&&("number"==typeof e&&!isNaN(+e)||"object"==typeof e&&e.constructor===Number)},qe=function(e){return"string"==typeof e},ke=function(e){if("object"!=typeof e||null===e)return!1;e=Object.getPrototypeOf(e);if(null===e)return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return e===t},Oe=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"array"===Ve(e)},Fe=function(e){return void 0===e},xe=function(e){return Oe(e)||null!==e&&"object"==typeof e},Ve=function(e){return Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase()},He=(Date.now||(Date.now=function(){return(new Date).getTime()}),function(s,o,r,i){if(!xe(s)||!xe(o))return 0;let n=0;var a,u=Object.keys(o);for(let e=0,t=u.length;e<t;e++)if(a=u[e],!(Fe(o[a])||r&&r.includes(a)))if(xe(s[a])&&xe(o[a]))n+=He(s[a],o[a],r,i);else{if(i&&i.includes(o[a]))continue;s[a]!==o[a]&&(s[a]=o[a],n+=1)}return n}),je=function(e){e=e||99999999;return Math.round(Math.random()*e)},Be={},Ke=function(e){if(0===Object.getOwnPropertyNames(e).length)return Object.create(null);const t=Array.isArray(e)?[]:Object.create(null);var s;for(const o in e)null!==e[o]?void 0!==e[o]?(s=typeof e[o],0<=["string","number","function","boolean"].indexOf(s)?t[o]=e[o]:t[o]=Ke(e[o])):t[o]=void 0:t[o]=null;return t};function Je(o,e){if(!Oe(o)||!Oe(e))return!1;let r=!1;return e.forEach(({key:t,value:e})=>{const s=o.find(e=>e.key===t);s?s.value!==e&&(s.value=e,r=!0):(o.push({key:t,value:e}),r=!0)}),r}function We(e){return Pe(e)?[]:e.filter(e=>!0===e.isModified)}function ze(e){return Pe(e)?[]:e.filter(e=>!1===e.isModified)}const Xe=e=>e===pe,Ye=({type:e,groupID:t})=>e===le||(""+t).startsWith(ve)&&!(""+t).includes(Re),Qe=e=>(""+e).startsWith(ve)&&(""+e).includes(Re);function Ze(e){return e.split(Re)[0]}function et(){return!w&&!S}function st(t,s){if(t){let e=t;return s&&(t.startsWith("http://")?e=t.replace(/^http:\/\/[^/]+/,s):t.startsWith("https://")&&(e=t.replace(/^https:\/\/[^/]+/,s))),e}}function ot(e,t=!0,s=!0){var o=Date.now();return t?s?o-e+" ms":Math.round((o-e)/1e3)+" s":s?o-e:Math.round((o-e)/1e3)}let rt=0;function it(){return et()?"%c Chat %c":"Chat"}function nt(){const e=function(){const e=new Date;return e.setTime(Ce()),e}();return e.toLocaleTimeString("en-US",{hour12:!1})+"."+function(e){let t;switch(e.toString().length){case 1:t="00"+e;break;case 2:t="0"+e;break;default:t=e}return t}(e.getMilliseconds())}const at={arguments2String(s){let o="";if(1===s.length)o=s[0];else for(let e=0,t=s.length;e<t;e++)xe(s[e])?s[e]instanceof Error?o+=(r=s[e],JSON.stringify(r,["message","code"])):o+=JSON.stringify(s[e]):o+=s[e],o+=" ";var r;return o},_exec(e,t){et()?F[e](it(),"background:#0abf5b; padding:1px; border-radius:3px; color: #fff","background:transparent",nt(),t):F[e](`${it()} ${nt()} `+t)},d:function(){var e;rt<=-1&&(e=this.arguments2String(arguments),this._exec("debug",e))},l:function(){var e;rt<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},log:function(){var e;rt<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},i:function(){var e;rt<=1&&(e=this.arguments2String(arguments),this._exec("info",e))},w:function(){var e;rt<=2&&(e=this.arguments2String(arguments),this._exec("warn",e))},e:function(){var e;rt<=3&&(e=this.arguments2String(arguments),this._exec("error",e))},setLevel:function(e){e<4&&this._exec("log","set level from "+rt+" to "+e),rt=e},getLevel:function(){return rt}},ut=function(e){return{code:0,data:e||{}}};class pt extends Error{constructor(e){super();var{code:e,message:t,data:s}=e;this.code=e,t?this.message=t:this._getErrorMessage&&(this.message=this._getErrorMessage(this.code)),this.data=s||{}}}const lt=2101,ct=2114,ht=2600,gt=2601,mt=2602,dt=2603,_t=2620,ft=2621,Mt=2622,It=2623,Dt=2660,Lt=2661,yt=2662,Gt=2681,Ct=2682,bt=2683,Tt=2684,At=2685,St=2686,vt=2687,Rt=2805,$t=2903,Pt=3122,Et=3123,wt="onMessageReceived",Ut="onMessageModified",Nt="onMessageRevoked",qt="onGroupListUpdated",kt="groupAttributesUpdated",Ot="onGroupCounterUpdated",Ft="onTopicUpdated",xt="error";let Vt=null;const Ht=function(e){return Promise.resolve(ut(e))},jt=function(e,t=!1){if(e instanceof pt)return t&&null!==Vt&&Vt.emit(xt,e),Promise.reject(e);if(e instanceof Error){const e=new pt({code:$t});return t&&null!==Vt&&Vt.emit(xt,e),Promise.reject(e)}if(Fe(e)||Fe(e.code))return Promise.reject(new pt({code:$t}));e=new pt(e);return t&&null!==Vt&&Vt.emit(xt,e),Promise.reject(e)},Bt={A2KEY_AND_TINYID_UPDATED:"_inner1",CLOUD_CONFIG_UPDATED:"_inner2",PROFILE_UPDATED:"_inner3",CONV_SYNC_COMPLETED:"_inner4",C2C_UNREAD_HANDLE_COMPLETED:"_inner5"},Kt="messageReceivedGroup",Jt="messageReceivedGroupAVPush",Wt="messageReceivedGroupAVPull",zt={info:4,warning:5,error:6},Xt={wifi:1,"2g":2,"3g":3,"4g":4,"5g":5,unknown:6,none:7,online:8},Yt={login:4,plugin_search:16,plugin_translate:16,plugin_voice_to_text:16,plugin_cs:16,plugin_push:16,plugin_bot:16,plugin_emoji_reaction:16};class Qt{constructor(e){this._n="SSOLogData",this.eventType=Yt[e]||0,this.timestamp=0,this.networkType=8,this.code=0,this.message="",this.moreMessage="",this.extension=e,this.costTime=0,this.duplicate=!1,this.level=4,this.uiPlatform=void 0,this._sentFlag=!1,this._startts=Ce()}static bindEventStatModule(e){Qt.prototype._eventStatModule=e}static bindNetMonitorModule(e){Qt.prototype._netMonitorModule=e}updateTimeStamp(){this.timestamp=Ce()}start(e){return this._startts=e,this}end(e=!1){if(!this._sentFlag){if(this._netMonitorModule){const e=this._netMonitorModule.getNetworkType();this.setNetworkType(e)}var t=Ce();0===this.costTime&&(this.costTime=t-this._startts),this.setMoreMessage(`startts:${this._startts} endts:`+t),e?(this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)):setTimeout(()=>{this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)},0)}}setError(e){if(!(e instanceof Error))return at.w(this._n+".setError value not instanceof Error, please check!"),this;if(this._sentFlag)return this;let t=!0;if(t=this._netMonitorModule?this._netMonitorModule.isOnline():t)e.code&&this.setCode(e.code),e.message&&this.setMoreMessage(e.message);else{const e=Rt;this.setCode(e)}return this.setLevel("error"),this}setCode(e){return Fe(e)||this._sentFlag||("ECONNABORTED"===e&&(this.code=103),Ne(e)?this.code=e:at.w(this._n+".setCode value not a number, please check!",e,typeof e)),this}setMessage(e){return Fe(e)||this._sentFlag||(Ne(e)&&(this.message=e.toString()),qe(e)&&(this.message=e)),this}setCostTime(e){return this.costTime=e,this}setLevel(e){return Fe(e)||this._sentFlag||(this.level=zt[e]),this}setMoreMessage(e){return Pe(this.moreMessage)?this.moreMessage=""+e:this.moreMessage+=" "+e,this}setNetworkType(e){return Fe(e)?at.w(this._n+".setNetworkType value is undefined, please check!"):(e=Xt[e.toLowerCase()],Fe(e)||(this.networkType=e)),this}getStartTs(){return this._startts}setUIPlatform(e){return this.uiPlatform=e,this}setExtension(e){return this.extension=e,this}setEventType(e){return this.eventType=e,this}}const Zt="send_group_msg",es="get_joined_group_list",ts="get_group_self_member_info",ss="create_group",os="destroy_group",rs="modify_group_base_info",is="apply_join_group",ns="apply_join_group_noauth",as="quit_group",us="get_group_public_info",ps="change_group_owner",ls="handle_apply_join_group",cs="handle_invite_join_permission_group",hs="handle_invite_join_group",gs="group_msg_recall",ms="msg_read_report",ds="group_msg_get",_s="get_group_msg_receipt",fs="group_msg_receipt",Ms="get_group_msg_receipt_detail",Is="get_pendency",Ds="deletemsg",Ls="get_msg",ys="get_msg_noauth",Gs="get_online_member_num",Cs="delete_group_ramble_msg_by_seq",bs="modify_group_msg",Ts="set_group_attr",As="modify_group_attr",Ss="delete_group_attr",vs="clear_group_attr",Rs="get_group_attr",$s="group_set_key_values",Ps="group_get_key_values",Es="batch_get_group_notify",ws="update_group_counter",Us="get_group_counter",Ns="get_group_member_info",qs="get_members",ks="get_specified_group_member_info",Os="add_group_member",Fs="delete_group_member",xs="ban_group_member",Vs="modify_group_member_info",Hs="modify_user_info",js="unSend",Bs="success",Ks="notStart",Js="resolved",Ws="rejected";class zs{constructor(e){this.type=x,this.content={text:e.text||""}}setText(e){this.content.text=e}sendable(){return 0!==this.content.text.length}}class Xs{constructor(e,t){this._imageMemoryURL="",this._fileDownloadProxy=t,S?this.createImageDataASURLInWXMiniApp(e.file):this.createImageDataASURLInWeb(e.file),this._initImageInfoModel(),this.type=V,this._percent=0,this.content={imageFormat:e.imageFormat||be.UNKNOWN,uuid:e.uuid,imageInfoArray:[]},this.initImageInfoArray(e.imageInfoArray),this._autoFixUrl()}_initImageInfoModel(){const t=this;this._ImageInfoModel=function(e){this.instanceID=je(9999999),this.sizeType=e.type||0,this.type=0,this.size=e.size||0,this.width=e.width||0,this.height=e.height||0,this.imageUrl=e.imageUrl||e.url||"",this.url=st(e.url||t._imageMemoryURL,t._fileDownloadProxy)},this._ImageInfoModel.prototype={setSizeType(e){this.sizeType=e},setType(e){this.type=e},setImageUrl(e){e&&(this.imageUrl=e)},getImageUrl(){return this.imageUrl}}}initImageInfoArray(e){let t=0,s=null,o;for(;t<=2;)o=Fe(e)||Fe(e[t])?{type:0,size:0,width:0,height:0,url:""}:e[t],(s=new this._ImageInfoModel(o)).setSizeType(t+1),s.setType(t),this.addImageInfo(s),t++;this.updateAccessSideImageInfoArray()}updateImageInfoArray(t){var s=this.content.imageInfoArray.length;let o;for(let e=0;e<s;e++)o=this.content.imageInfoArray[e],t[e].size&&(o.size=t[e].size),t[e].url&&o.setImageUrl(t[e].url),t[e].width&&(o.width=t[e].width),t[e].height&&(o.height=t[e].height)}_autoFixUrl(){var t=this.content.imageInfoArray.length;let s="",o="";const r=["http","https"];let i=null;for(let e=0;e<t;e++)this.content.imageInfoArray[e].url&&(""!==(i=this.content.imageInfoArray[e]).imageUrl&&(o=i.imageUrl.slice(0,i.imageUrl.indexOf("://")+1),s=i.imageUrl.slice(i.imageUrl.indexOf("://")+1),r.indexOf(o)<0&&(o="https:"),this.content.imageInfoArray[e].setImageUrl([o,s].join(""))))}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateImageFormat(e){this.content.imageFormat=be[e.toUpperCase()]||be.UNKNOWN}createImageDataASURLInWeb(e){void 0!==e&&0<e.files.length&&(this._imageMemoryURL=window.URL.createObjectURL(e.files[0]))}createImageDataASURLInWXMiniApp(e){e&&e.url&&(this._imageMemoryURL=e.url)}replaceImageInfo(e,t){this.content.imageInfoArray[t]instanceof this._ImageInfoModel||(this.content.imageInfoArray[t]=e)}addImageInfo(e){3<=this.content.imageInfoArray.length||this.content.imageInfoArray.push(e)}updateAccessSideImageInfoArray(){var e=this.content.imageInfoArray,{width:t=0,height:s=0}=e[0];if(0!==t&&0!==s){var o=e,r=o[2];o[2]=o[1],o[1]=r;for(let e=0;e<o.length;e++)o[e].setType(e);Object.assign(e[2],function(e){const{originUrl:t,originWidth:s,originHeight:o,min:r=198}=e,i=parseInt(s),n=parseInt(o),a={url:void 0,width:0,height:0};if((i<=n?i:n)<=r)a.url=t,a.width=i,a.height=n;else{n<=i?(a.width=Math.ceil(i*r/n),a.height=r):(a.width=r,a.height=Math.ceil(n*r/i));const e=t&&-1<t.indexOf("?")?t+"&":t+"?";a.url=198===r?e+"imageView2/3/w/198/h/198":e+"imageView2/3/w/720/h/720"}if(Fe(t)){const{url:e,...t}=a;return t}return a}({originWidth:t,originHeight:s,min:720}))}}sendable(){return 0!==this.content.imageInfoArray.length&&""!==this.content.imageInfoArray[0].imageUrl&&0!==this.content.imageInfoArray[0].size}}class Ys{constructor(e){this.type=B,this.content=e||null}sendable(){return null!==this.content}}class Qs{constructor(e,t){this.type=H,this._percent=0,this.content={downloadFlag:2,second:e.second,size:e.size,url:st(e.url,t),remoteAudioUrl:e.url||"",uuid:e.uuid}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateAudioUrl(e){this.content.remoteAudioUrl=e}sendable(){return""!==this.content.remoteAudioUrl}}const Zs={from:!0,groupID:!0,groupName:!0,to:!0};class eo{constructor(e){this.type=W,this.content={},this._initContent(e)}_initContent(t){Object.keys(t).forEach(e=>{switch(e){case"remarkInfo":break;case"groupProfile":this.content.groupProfile={},this._initGroupProfile(t[e]);break;case"operatorInfo":break;case"memberInfoList":case"msgMemberInfo":this._updateMemberList(t[e]);break;case"memberExtraInfo":case"onlineMemberInfo":break;case"memberNum":this.content[e]=t[e],this.content.memberCount=t[e];break;case"newGroupProfile":this.content.newGroupProfile={},this._initNewGroupProfile(t[e]);break;default:this.content[e]=t[e]}}),this.content.userIDList||(this.content.userIDList=[this.content.operatorID])}_initGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var o=s[e];Zs[o]&&(this.content.groupProfile[o]=t[o])}}_updateMemberList(e){Pe(this.content.memberList)?this.content.memberList=e:this.content.memberList.forEach(t=>{e.forEach(e=>{t.userID===e.userID&&Object.assign(t,e)})})}_initNewGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var o=s[e];this.content.newGroupProfile[o]="muteAllMembers"!==o?t[o]:1===t[o]}}}const to={from:!0,groupID:!0,groupName:!0,to:!0,groupType:!0};class so{constructor(e){this.type=z,this.content={},this._initContent(e)}_initContent(t){Object.keys(t).forEach(e=>{switch(e){case"memberInfoList":break;case"remarkInfo":this.content.handleMessage=t[e];break;case"groupProfile":this.content.groupProfile={},this._initGroupProfile(t[e]);break;default:this.content[e]=t[e]}})}_initGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var o=s[e];to[o]&&("groupName"===o?this.content.groupProfile.name=t[o]:this.content.groupProfile[o]=t[o])}}}class oo{constructor(e,t){this.type=j,this._percent=0;var s=this._getFileInfo(e);this.content={downloadFlag:2,fileUrl:st(e.url||e.fileUrl,t)||"",uuid:e.uuid,fileName:s.name||"",fileSize:s.size||0}}_getFileInfo(e){if(!Fe(e.fileName)&&!Fe(e.fileSize))return{size:e.fileSize,name:e.fileName};const t=e.file.files[0];if(A){if(t.path&&-1!==t.path.indexOf(".")){const e=t.path.slice(t.path.lastIndexOf(".")+1).toLowerCase();t.type=e,t.name||(t.name=je(999999)+"."+e)}t.name||(t.type="",t.name=t.path.slice(t.path.lastIndexOf("/")+1).toLowerCase()),t.suffix&&(t.type=t.suffix),t.url||(t.url=t.path)}return{size:t.size,name:t.name}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateFileUrl(e){this.content.fileUrl=e}sendable(){return""!==this.content.fileUrl&&""!==this.content.fileName&&0!==this.content.fileSize}}class ro{constructor(e){this.type=X,this.content={data:e.data||"",description:e.description||"",extension:e.extension||""}}setData(e){return this.content.data=e,this}setDescription(e){return this.content.description=e,this}setExtension(e){return this.content.extension=e,this}sendable(){return 0!==this.content.data.length||0!==this.content.description.length||0!==this.content.extension.length}}class io{constructor(e,t){this.type=K,this._percent=0,this.content={remoteVideoUrl:e.remoteVideoUrl||e.videoUrl||"",videoFormat:e.videoFormat,videoSecond:parseInt(e.videoSecond,10),videoSize:e.videoSize,videoUrl:st(e.videoUrl,t),videoDownloadFlag:2,videoUUID:e.videoUUID,thumbUUID:e.thumbUUID,thumbFormat:e.thumbFormat,thumbWidth:e.thumbWidth,snapshotWidth:e.thumbWidth,thumbHeight:e.thumbHeight,snapshotHeight:e.thumbHeight,thumbSize:e.thumbSize,snapshotSize:e.thumbSize,thumbDownloadFlag:2,thumbUrl:st(e.thumbUrl,t),snapshotUrl:st(e.thumbUrl,t)}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateVideoUrl(e){e&&(this.content.remoteVideoUrl=e)}updateSnapshotInfo(e){var{snapshotUrl:e,snapshotWidth:t,snapshotHeight:s}=e;Pe(e)||(this.content.thumbUrl=this.content.snapshotUrl=e),Pe(t)||(this.content.thumbWidth=this.content.snapshotWidth=Number(t)),Pe(s)||(this.content.thumbHeight=this.content.snapshotHeight=Number(s))}sendable(){return""!==this.content.remoteVideoUrl}}class no{constructor(e){this.type=J;var{description:e,longitude:t,latitude:s}=e;this.content={description:e,longitude:t,latitude:s}}sendable(){return!0}}class ao{constructor(e,t){var s,o;this.from=e.from,this.messageSender=e.from,this.time=e.time,this.messageSequence=e.sequence,this.clientSequence=e.clientSequence||e.sequence,this.messageRandom=e.random,this.cloudCustomData=e.cloudCustomData||"",this.clientTime=e.clientTime||void 0,e.ID?(this.ID=e.ID||"",this.nick=e.nick||"",this.avatar=e.avatar||"",e.messageBody?this.messageBody=JSON.parse(JSON.stringify(e.messageBody)):this.messageBody=[{type:e.type,payload:e.payload}],e.conversationType?e.conversationType.startsWith(se)?this.receiverUserID=e.to:e.conversationType.startsWith(oe)&&(this.receiverGroupID=e.to):e.receiverGroupID?this.receiverGroupID=e.receiverGroupID:e.receiverUserID&&(this.receiverUserID=e.receiverUserID),this.messageReceiver=e.to||e.messageReceiver):(this.nick=e.nick||"",this.avatar=e.avatar||"",this.messageBody=[],s=e.elements[0].type,o=e.elements[0].content,this._patchRichMediaPayload(s,o),this._updateRichMediaDownloadUrl(s,o,t),s===Y?this.messageBody.push({type:s,payload:new uo(o).content}):this.messageBody.push({type:s,payload:o}),e.groupID&&(this.receiverGroupID=e.groupID,this.messageReceiver=e.groupID),e.to&&(this.receiverUserID=e.to,this.messageReceiver=e.to),this.ID=`${e.tinyID}-${e.clientTime}-`+e.random)}_patchRichMediaPayload(e,t){e===V?t.imageInfoArray.forEach(e=>{!e.imageUrl&&e.url&&(e.imageUrl=e.url,e.sizeType=e.type,1===e.type?e.type=0:3===e.type&&(e.type=1))}):e===K?!t.remoteVideoUrl&&t.videoUrl&&(t.remoteVideoUrl=t.videoUrl):e===H?!t.remoteAudioUrl&&t.url&&(t.remoteAudioUrl=t.url):e===j&&!t.fileUrl&&t.url&&(t.fileUrl=t.url,t.url=void 0)}_updateRichMediaDownloadUrl(e,t,s){s&&(e===V?t.imageInfoArray.forEach(e=>{e.url=st(e.url,s)}):e===K?(t.videoUrl=st(t.videoUrl,s),t.snapshotUrl=st(t.thumbUrl,s),t.snapshotHeight=t.thumbHeight,t.snapshotWidth=t.thumbWidth):e===H?t.url=st(t.url,s):e===j&&(t.fileUrl=st(t.fileUrl,s)))}}var uo=class{constructor(e,t){if(this.type=Y,this.content={downloadKey:"",pbDownloadKey:"",messageList:[],title:"",abstractList:[],compatibleText:"",version:0,layersOverLimit:!1},e.downloadKey){const{downloadKey:t,pbDownloadKey:s,title:o,abstractList:r,compatibleText:i,version:n}=e;this.content.downloadKey=t,this.content.pbDownloadKey=s,this.content.title=o,this.content.abstractList=r,this.content.compatibleText=i,this.content.version=n||0}else if(Pe(e.messageList))1===e.layersOverLimit&&(this.content.layersOverLimit=!0);else{const{messageList:a,title:u,abstractList:l,compatibleText:h,version:g}=e,p=[];a.forEach(e=>{Pe(e)||(e=new ao(e,t),p.push(e))}),this.content.messageList=p,this.content.title=u,this.content.abstractList=l,this.content.compatibleText=h,this.content.version=g||0}}sendable(){return!Pe(this.content.messageList)||!Pe(this.content.downloadKey)}};const po={1:Q,2:Z,3:ee,4:te};class lo{constructor(e){this.ID="",this.conversationID=e.conversationID||null,this.conversationType=e.conversationType||se,this.conversationSubType=e.conversationSubType,this.time=e.time||Math.ceil(Date.now()/1e3),this.sequence=e.sequence||0,this.clientSequence=e.clientSequence||e.sequence||0,this.random=e.random||0===e.random?e.random:je(),this.priority=this._computePriority(e.priority),this.nick=e.nick||"",this.avatar=e.avatar||"",this.isPeerRead=!1,this.nameCard="",this.hasRiskContent=function(e){let t=e&&1<e?!0:!1;return t}(e.checkResult),this._elements=[],this.isPlaceMessage=e.isPlaceMessage||0,this.isRevoked=2===e.isPlaceMessage||8===e.msgFlagBits,this.from=e.from||null,this.to=e.to||null,this.flow="",this.isSystemMessage=e.isSystemMessage||!1,this.protocol=e.protocol||"JSON",this.isResend=!1,this.isRead=!1,this.status=e.status||Bs,this._onlineOnlyFlag=!1,this._groupAtInfoList=[],this._relayFlag=!1,this.atUserList=[],this.cloudCustomData=e.cloudCustomData||"",this.isDeleted=!1,this.isModified=!1,this._isExcludedFromUnreadCount=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromUnreadCount),this._isExcludedFromLastMessage=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromLastMessage),this.clientTime=e.clientTime||Math.floor(Ce()/1e3)||0,this.senderTinyID=e.senderTinyID||e.tinyID||"",this.readReceiptInfo=e.readReceiptInfo||{readCount:void 0,unreadCount:void 0,isPeerRead:void 0},this.needReadReceipt=!0===e.needReadReceipt||1===e.needReadReceipt,this.version=e.messageVersion||0,this.isBroadcastMessage=e.isBroadcastMessage||!1,this._receiverList=e.receiverList||void 0,this.isSupportExtension=!0===e.isSupportExtension||1===e.isSupportExtension,this._cmConfigID=e.customModerationConfigurationID,this.revoker=e.revokerInfo&&e.revokerInfo.revoker||"",this.revokerInfo=e.revokerInfo||{userID:"",nick:"",avatar:""},this.revokeReason=e.revokeReason||"",this.reInitialize(e.currentUser),this.extractGroupInfo(e.groupProfile||null),this.handleGroupAtInfo(e),this.initC2CReadReceiptInfo(e.readReceiptSentByPeer)}get elements(){return this._elements}getElements(){return this._elements}extractGroupInfo(e){null!==e&&(qe(e.nick)&&(this.nick=e.nick),qe(e.avatar)&&(this.avatar=e.avatar),e=e["messageFromAccountExtraInformation"],ke(e)&&qe(e.nameCard)&&(this.nameCard=e.nameCard))}handleGroupAtInfo(e){e.payload&&e.payload.atUserList&&e.payload.atUserList.forEach(e=>{e!==Ge?(this._groupAtInfoList.push({groupAtAllFlag:0,groupAtUserID:e}),this.atUserList.push(e)):(this._groupAtInfoList.push({groupAtAllFlag:1}),this.atUserList.push(Ge))}),Oe(e.groupAtInfo)&&e.groupAtInfo.forEach(e=>{0===e.groupAtAllFlag?this.atUserList.push(e.groupAtUserID):1===e.groupAtAllFlag&&this.atUserList.push(Ge)})}getGroupAtInfoList(){return this._groupAtInfoList}_initProxy(){this._elements[0]&&(this.payload=this._elements[0].content,this.type=this._elements[0].type)}reInitialize(e){e&&(this.status=this.from?Bs:js,this.from||(this.from=e)),this._initFlow(e),this._initSequence(e),this._concatConversationID(e),this.generateMessageID()}isSendable(){return 0!==this._elements.length&&(!0===this._relayFlag||"function"==typeof this._elements[0].sendable&&this._elements[0].sendable())}_initTo(e){this.conversationType===oe&&(this.to=e.groupID)}_initSequence(e){0===this.clientSequence&&e&&(this.clientSequence=function(o){if(!o)return!1;if(void 0===Be[o]){const r=new Date;let e=("3"+r.getHours()).slice(-2),t=("0"+r.getMinutes()).slice(-2),s=("0"+r.getSeconds()).slice(-2);Be[o]=parseInt([e,t,s,"0001"].join("")),e=null,t=null,s=null,at.l("autoIncrementIndex start index:"+Be[o])}return Be[o]++}(e)),0===this.sequence&&this.conversationType===se&&(this.sequence=this.clientSequence)}generateMessageID(){this.from===ie&&(this.senderTinyID="144115198244471703"),this.ID=`${this.senderTinyID}-${this.clientTime}-`+this.random}_initFlow(e){""!==e&&(e===this.from?(this.flow="out",this.isRead=!0):this.flow="in")}_concatConversationID(e){var t=this["to"],s=this.conversationType;s!==ie?(e=s===se?e===this.from?t:this.from:this.to,this.conversationID=e?""+s+e:null):this.conversationID=ie}isElement(e){return e instanceof zs||e instanceof Xs||e instanceof Ys||e instanceof Qs||e instanceof oo||e instanceof io||e instanceof eo||e instanceof so||e instanceof ro||e instanceof no||e instanceof uo}setElement(t,s){if(this.isElement(t))return this._elements=[t],void this._initProxy();var o=e=>{if(e.type&&e.content)switch(e.type){case x:this.setTextElement(e.content);break;case V:this.setImageElement(e.content,s);break;case H:this.setAudioElement(e.content,s);break;case j:this.setFileElement(e.content,s);break;case K:this.setVideoElement(e.content,s);break;case X:this.setCustomElement(e.content);break;case J:this.setLocationElement(e.content);break;case W:this.setGroupTipElement(e.content);break;case z:this.setGroupSystemNoticeElement(e.content);break;case B:this.setFaceElement(e.content);break;case Y:this.setMergerElement(e.content,s)}};if(Oe(t))for(let e=0;e<t.length;e++)o(t[e]);else o(t);this._initProxy()}clearElement(){this._elements.length=0}setTextElement(e){e="string"==typeof e?e:e.text,e=new zs({text:e});this._elements.push(e)}setImageElement(e,t){e=new Xs(e,t);this._elements.push(e)}setAudioElement(e,t){e=new Qs(e,t);this._elements.push(e)}setFileElement(e,t){e=new oo(e,t);this._elements.push(e)}setVideoElement(e,t){e=new io(e,t);this._elements.push(e)}setLocationElement(e){e=new no(e);this._elements.push(e)}setCustomElement(e){e=new ro(e);this._elements.push(e)}setGroupTipElement(e){let t={};var s=e.operationType;if(Pe(e.memberInfoList)?e.operatorInfo&&(t=e.operatorInfo):s!==fe&&s!==Me&&s!==Ie&&s!==De||(t=e.memberInfoList[0]),!Pe(e.memberExtraInfo)){const t=e.memberExtraInfo["reason"];e.msgMemberInfo.forEach(e=>{e.reason=t})}var{nick:s,avatar:o}=t,s=(qe(s)&&(this.nick=s),qe(o)&&(this.avatar=o),new eo(e));this._elements.push(s)}setGroupSystemNoticeElement(e){e=new so(e);this._elements.push(e)}setFaceElement(e){e=new Ys(e);this._elements.push(e)}setMergerElement(e,t){e=new uo(e,t);this._elements.push(e)}setIsRead(e){this.isRead=e}setRelayFlag(e){this._relayFlag=e}_computePriority(e){if(Fe(e))return Z;if(qe(e)&&-1!==Object.values(po).indexOf(e))return e;if(Ne(e)){e=""+e;if(-1!==Object.keys(po).indexOf(e))return po[e]}return Z}setNickAndAvatar(e){var{nick:e,avatar:t}=e;qe(e)&&(this.nick=e),qe(t)&&(this.avatar=t)}setNameCard(e){qe(e)&&(this.nameCard=e)}initC2CReadReceiptInfo(e){this.conversationType===se&&!0===this.needReadReceipt&&(this.readReceiptInfo.isPeerRead=1===e)}}class co{constructor(e){this._grpM=e,this._n="GroupTipsHandler",this._cachedGroupTipsMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4}onCheckTimer(e){e%1==0&&0<this._cachedGroupTipsMap.size&&this._checkCachedGroupTips()}_checkCachedGroupTips(){this._cachedGroupTipsMap.forEach((e,t)=>{let s=this._checkCountMap.get(t);var o=this._grpM.hasLocalGroup(t);at.l(this._n+`._checkCachedGroupTips groupID:${t} hasLocalGroup:${o} checkCount:`+s),o?(this._notifyCachedGroupTips(t),this._checkCountMap.delete(t),this._grpM.deleteUnjoinedAVChatRoom(t)):s>=this.MAX_CHECK_COUNT?(this._deleteCachedGroupTips(t),this._checkCountMap.delete(t)):(s++,this._checkCountMap.set(t,s))})}onNewGroupTips(e){at.l(this._n+".onNewGroupTips options:"+JSON.stringify(e.dataList));var{eventDataList:e,result:t,AVChatRoomMessageList:s}=this.newGroupTipsStoredAndSummary(e);0<s.length&&this._grpM.onAVChatRoomMessage(s),0<e.length&&(this._grpM.updateNextMessageSeq(e),this._grpM.get(o).onNewMessage({conversationOptionsList:e,isInstantMessage:!0})),0<t.length&&(this._grpM.emitOuterEvent(wt,t),this.handleMessageList(t))}newGroupTipsStoredAndSummary(s){var{event:r,dataList:c}=s;let i=null;const n=[],a=[],u={},m=[];for(let e=0,t=c.length;e<t;e++){const s=Ke(c[e]);if(6===r){if(this._grpM.isGroupAttributesUpdatedNotice(s))continue;if(this._grpM.isGroupCountersNotice(s))continue}var{groupProfile:{groupID:p,communityType:d=0,topicID:_,invisible:M}}=s;let t=void 0;var f=this._grpM.isMessageFromTopic(d,_),l=(f&&(t=re,s.to=_),this._grpM.hasLocalGroup(p));if(l||!this._grpM.isUnjoinedAVChatRoom(p))if(l||f)if(this._grpM.isMessageFromOrToAVChatroom(p))s.event=r,m.push(s);else if(s.currentUser=this._grpM.getMyUserID(),s.conversationType=oe,(i=new lo(s)).setElement({type:W,content:{...s.elements,groupProfile:s.groupProfile}}),i.isSystemMessage=!1,1!==M){const h=this._grpM.get(o),{conversationID:g,sequence:I}=i;if(6===r)i._onlineOnlyFlag=!0,a.push(i);else if(!h.pushIntoNoticeResult(a,i))continue;if(!(this._grpM.isMessageFromCommunityOfTopic(d,_)||6===r&&h.getLocalConversation(g))){6!==r&&this._qualityStat(i);l=h.isRemoteRead({conversationID:g,sequence:I});if(Fe(u[g])){let e=0;"in"===i.flow&&(i._isExcludedFromUnreadCount||i._onlineOnlyFlag||l||(e=1)),u[g]=n.push({conversationID:g,unreadCount:e,type:Fe(t)?i.conversationType:t,subType:i.conversationSubType,lastMessage:i._isExcludedFromLastMessage?"":i})-1}else{const s=u[g];n[s].type=i.conversationType,n[s].subType=i.conversationSubType,n[s].lastMessage=i._isExcludedFromLastMessage?"":i,"in"===i.flow&&(i._isExcludedFromUnreadCount||i._onlineOnlyFlag||l||n[s].unreadCount++)}}}else this._qualityStat(i);else this._cacheGroupTipsAndProbe({groupID:p,event:r,item:s})}return{eventDataList:n,result:a,AVChatRoomMessageList:m}}_qualityStat(e){this._grpM.get(u).addMessageSequence({key:Kt,message:e})}handleMessageList(e){e.forEach(e=>{switch(e.payload.operationType){case 1:this._onNewMemberComeIn(e);break;case 2:this._onMemberQuit(e);break;case 3:this._onMemberKickedOut(e);break;case 4:this._onMemberSetAdmin(e);break;case 5:this._onMemberCancelledAdmin(e);break;case 6:this._onGroupProfileModified(e);break;case 7:this._onMemberInfoModified(e);break;case 8:this._onTopicProfileUpdated(e);break;default:at.w(this._n+".handleMessageList unknown operationType:"+e.payload.operationType)}})}_onNewMemberComeIn(e){const{memberNum:t,groupProfile:{groupID:s}}=e.payload,o=this._grpM.getLocalGroupProfile(s);o&&Ne(t)&&o.memberCount!==t&&(o.memberCount=t,this._updateConversationGroupProfile(o))}_onMemberQuit(e){const{memberNum:t,groupProfile:{groupID:s}}=e.payload,o=this._grpM.getLocalGroupProfile(s);o&&Ne(t)&&o.memberCount!==t&&(o.memberCount=t,this._updateConversationGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(s,e.payload.userIDList)}_onMemberKickedOut(e){const{memberNum:t,groupProfile:{groupID:s}}=e.payload,o=this._grpM.getLocalGroupProfile(s);o&&Ne(t)&&o.memberCount!==t&&(o.memberCount=t,this._updateConversationGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(s,e.payload.userIDList)}_updateConversationGroupProfile(e){this._grpM.get(o).updateConversationGroupProfile([e])}_onMemberSetAdmin(e){const s=e.payload.groupProfile.groupID,t=e.payload.userIDList,o=this._grpM.getGroupMemberHandler();t.forEach(e=>{const t=o.getLocalGroupMemberInfo(s,e);t&&t.updateRole(me)})}_onMemberCancelledAdmin(e){const s=e.payload.groupProfile.groupID,t=e.payload.userIDList,o=this._grpM.getGroupMemberHandler();t.forEach(e=>{const t=o.getLocalGroupMemberInfo(s,e);t&&t.updateRole(de)})}_onGroupProfileModified(e){const{newGroupProfile:t,groupProfile:s}=e.payload,o=s["groupID"],r=this._grpM.getLocalGroupProfile(o);Object.keys(t).forEach(e=>{switch(e){case"ownerID":this._ownerChanged(r,t);break;case"groupName":r.name=t[e];break;default:r[e]=t[e]}});e=!r.isSupportTopic;this._grpM.emitGroupListUpdate(!0,e)}_ownerChanged({groupID:e},t){const s=this._grpM.getLocalGroupProfile(e),o=this._grpM.getMyUserID();if(o===t.ownerID){s.updateGroup({selfInfo:{role:ge}});const t=this._grpM.getGroupMemberHandler(),r=t.getLocalGroupMemberInfo(e,o),i=this._grpM.getLocalGroupProfile(e).ownerID,n=t.getLocalGroupMemberInfo(e,i);r&&r.updateRole(ge),n&&n.updateRole(de)}}_onMemberInfoModified(e){const{to:t,payload:{groupProfile:s,memberList:o}}=e,r=s.groupID,i=(Qe(t)&&this._updateTopicMuteTime(e),this._grpM.getGroupMemberHandler());o.forEach(e=>{const t=i.getLocalGroupMemberInfo(r,e.userID);t&&Ne(e.muteTime)&&t.updateMuteUntil(e.muteTime)})}_updateTopicMuteTime(e){const{to:t,payload:{groupProfile:o,memberList:r=[]}}=e,i=this._grpM.get(s),n=o["groupID"],a=i.getLocalTopic(n,t);if(a){let t=!1;for(let e=0;e<r.length;e++){const s=r[e];if(s.userID===this._grpM.getMyUserID()&&0<=s.muteTime){a.updateSelfInfo({muteTime:s.muteTime}),t=!0;break}}t&&this._grpM.emitOuterEvent(Ft,{groupID:n,topic:a})}}_onTopicProfileUpdated(e){var{groupProfile:{groupID:t},newTopicInfo:o}=e.payload;this._grpM.get(s).onTopicProfileUpdated({groupID:t,topicID:e.to,...o})}_cacheGroupTips(e,t){this._cachedGroupTipsMap.has(e)||this._cachedGroupTipsMap.set(e,[]),this._cachedGroupTipsMap.get(e).push(t)}_deleteCachedGroupTips(e){this._cachedGroupTipsMap.has(e)&&this._cachedGroupTipsMap.delete(e)}_notifyCachedGroupTips(e){const t=this._cachedGroupTipsMap.get(e)||[];t.forEach(e=>{this.onNewGroupTips(e)}),this._deleteCachedGroupTips(e),at.l(this._n+`._notifyCachedGroupTips groupID:${e} count:`+t.length)}_cacheGroupTipsAndProbe(e){const{groupID:s,event:t,item:o}=e;this._cacheGroupTips(s,{event:t,dataList:[o]}),this._grpM.getGroupSimplifiedInfo(s).then(e=>{var t=e["type"];t===pe?this._grpM.hasLocalGroup(s)?this._notifyCachedGroupTips(s):this._grpM.setUnjoinedAVChatRoom(s):(this._grpM.updateGroupMap([e]),this._notifyCachedGroupTips(s))}),this._checkCountMap.has(s)||this._checkCountMap.set(s,0),at.l(this._n+"._cacheGroupTipsAndProbe groupID:"+s)}reset(){this._cachedGroupTipsMap.clear(),this._checkCountMap.clear()}}class ho{constructor(e){this._grpM=e,this._n="CommonGroupHandler",this.tempConversationList=null,this._cachedGroupMessageMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4,this.PAGING_GRP_COUNT_LIMIT=200,this._pagingStatus=Ks,this._pagingGetCostList=[],e.getInnerEmitterInstance().on(Bt.A2KEY_AND_TINYID_UPDATED,this.syncGroupList,this)}onCheckTimer(e){e%1==0&&0<this._cachedGroupMessageMap.size&&this._checkCachedGroupMessage()}_checkCachedGroupMessage(){this._cachedGroupMessageMap.forEach((e,t)=>{let s=this._checkCountMap.get(t);var o=this._grpM.hasLocalGroup(t);at.l(this._n+`._checkCachedGroupMessage groupID:${t} hasLocalGroup:${o} checkCount:`+s),o?(this._notifyCachedGroupMessage(t),this._checkCountMap.delete(t),this._grpM.deleteUnjoinedAVChatRoom(t)):s>=this.MAX_CHECK_COUNT?(this._deleteCachedGroupMessage(t),this._checkCountMap.delete(t)):(s++,this._checkCountMap.set(t,s))})}handleUpdateGroupLastMessage(n){var a,u,e=this._n+".handleUpdateGroupLastMessage";if(0!==this._grpM.getGroupMap().size){let s,o,r,i=!1;for(let e=0,t=n.length;e<t;e++)(s=n[e]).type===oe&&0!==s.lastMessage.lastSequence&&null!==s.lastMessage.payload&&(o=s.conversationID.split(/^GROUP/)[1],(r=this._grpM.getLocalGroupProfile(o))&&(a=r.lastMessage,u=s.lastMessage,JSON.stringify(a)!==JSON.stringify(u)&&(r.lastMessage={...s.lastMessage},i=!0)));at.l(e+` conversation count:${n.length}, local group count:${this._grpM.getLocalGroupList().length} isGroupListUpdated:`+i),i&&(this._grpM.sortLocalGroupList(),this._grpM.emitGroupListUpdate(!0,!1))}else this.tempConversationList=n}onNewGroupMessage(e){at.d(this._n+".onNewGroupMessage count:"+e.dataList.length);const{conversationOptionsList:t,messageList:s,AVChatRoomMessageList:r}=this._newGroupMessageStoredAndSummary(e);0<r.length&&this._grpM.onAVChatRoomMessage(r);var i=We(s),i=(0<i.length&&this._grpM.emitOuterEvent(Ut,i),0<t.length&&(this._grpM.updateNextMessageSeq(t),this._grpM.get(o).onNewMessage({conversationOptionsList:t,isInstantMessage:e.isInstantMessage||!0,updateUnreadCount:e.updateUnreadCount||!0})),ze(s));0<i.length&&this._grpM.emitOuterEvent(wt,i),s.length=0}_newGroupMessageStoredAndSummary(i){const{dataList:n,event:e,isInstantMessage:m}=i;let a=null;const u=[],p=[],d=[],l={},_=this._grpM.getFileDownloadProxy(),h=n.length,g=(1<h&&n.sort((e,t)=>e.sequence-t.sequence),this._grpM.get(o)),M=this._grpM.get(t);for(let r=0;r<h;r++){const i=Ke(n[r]),{groupProfile:{groupID:o,communityType:h=0,topicID:c,invisible:L}}=i;let s=void 0;var f=this._grpM.isMessageFromTopic(h,c),I=(f&&(s=re,i.to=c),this._grpM.hasLocalGroup(o));if(I||!this._grpM.isUnjoinedAVChatRoom(o))if(I||f)if(this._grpM.isMessageFromOrToAVChatroom(o))i.event=e,d.push(i);else if(i.currentUser=this._grpM.getMyUserID(),i.conversationType=oe,i.isSystemMessage=!!i.isSystemMessage,(a=new lo(i)).setElement(i.elements,_),1!==L){let e=1===n[r].isModified;if(g.isMessageSentByCurrentInstance(a)?a.isModified=e:e=!1,1===i.onlineOnlyFlag)a._onlineOnlyFlag=!0,g.isMessageSentByCurrentInstance(a)||p.push(a);else{if(this._grpM.isMessageFromCommunityOfTopic(h,c)){p.push(a);continue}if(a.from===this._grpM.getMyUserID()){const t=g.getLatestMessageSentByMe(a.conversationID);if(t){const{nick:n,avatar:o}=t;n===a.nick&&o===a.avatar||(g.modifyMessageSentByMe({conversationID:i,latestNick:a.nick,latestAvatar:a.avatar}),M.mockOnNickAvatarModified(a.nick,a.avatar))}}if(!g.pushIntoMessageList(p,a,e))continue;this._qualityStat(m,a);const{conversationID:i,sequence:t}=a,n=g.isRemoteRead({conversationID:i,sequence:t});if(Fe(l[i])){let e=0;"in"===a.flow&&(a._isExcludedFromUnreadCount||n||(e=1)),l[i]=u.push({conversationID:i,unreadCount:e,type:Fe(s)?a.conversationType:s,subType:a.conversationSubType,lastMessage:a._isExcludedFromLastMessage?"":a})-1}else{const t=l[i];u[t].type=Fe(s)?a.conversationType:s,u[t].subType=a.conversationSubType,u[t].lastMessage=a._isExcludedFromLastMessage?"":a,"in"===a.flow&&(a._isExcludedFromUnreadCount||n||u[t].unreadCount++)}}}else this._qualityStat(m,a);else this._cacheGroupMessageAndProbe({groupID:o,event:e,item:i})}return{conversationOptionsList:u,messageList:p,AVChatRoomMessageList:d}}_qualityStat(e,t){const s=this._grpM.get(u);s.addMessageSequence({key:Kt,message:t}),e&&0<t.clientTime&&s.addMessageDelay(t.clientTime)}onGroupMessageRevoked(e){const p=this._grpM.get(o),l=[],h=[];e.dataList.forEach(e=>{const t=e.elements["revokedInfos"],{revokerInfo:n,groupProfile:a}=e;let u=!1;a&&(u=Ye({groupID:a.groupID})||!Pe(a.topicID)),Fe(t)||t.forEach(e=>{var t=Pe(e.topicID)?"GROUP"+e.groupID:"GROUP"+e.topicID,s=p.getLocalConversation(t),o=e.revokerInfo&&e.revokerInfo.revoker||n&&n.revoker,r=n&&n.reason||"";let i;if(s&&Xe(s.type))i={conversationID:t,sequence:e.sequence,ID:`${e.tinyID}-${e.clientTime}-`+e.random};else{const l=p.revoke(t,e.sequence,e.random);l?i=l:(i={conversationID:t,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(i.ID=`${e.tinyID}-${e.clientTime}-`+e.random),e.time&&(i.time=e.time))}i&&(i.revoker=o,i.revokeReason=r,i.revokerInfo={userID:o,nick:"",avatar:""},u?(i.revokerInfo.nick=a.nick,i.revokerInfo.avatar=a.avatar,l.push(i)):h.push(i))})}),0===h.length&&0===l.length||(p.onMessageRevoked([...l,...h]),0<l.length&&this._grpM.emitOuterEvent(Nt,l),0<h.length&&p.updateRevokerInfo(h).then(e=>{this._grpM.emitOuterEvent(Nt,e)}))}_groupListTreeShaking(s){const o=new Map([...this._grpM.getGroupMap()]);for(let e=0,t=s.length;e<t;e++)o.delete(s[e].groupID);this._grpM.hasJoinedAVChatRoom()&&this._grpM.getJoinedAVChatRoom().forEach(e=>{o.delete(e)}),this._grpM.getGroupMap().forEach((e,t)=>{e.isSupportTopic&&o.delete(t)});var r=[...o.keys()];for(let e=0,t=r.length;e<t;e++)this._grpM.deleteGroup(r[e])}syncGroupList(e=!1){this._pagingStatus===Ks&&this._grpM.clearGroupMap();const t=["Type","Name","FaceUrl","NextMsgSeq","LastMsgTime","AtInfoList","LastRecallTime"],s=this.PAGING_GRP_COUNT_LIMIT,o=[];if(!0===e)return this._pagingGetGroupListWithTopic({limit:s,offset:0,groupBaseInfoFilter:t,groupList:o});const r=this._n+".syncGroupList",i=new Qt("syncGroupList");return this._pagingGetGroupList({limit:s,offset:0,groupBaseInfoFilter:t,groupList:o}).then(()=>{var e=function(e){if(Oe(e)&&0!==e.length){let t=0;return e.forEach(e=>{t+=e}),(t/e.length).toFixed(0)}}(this._pagingGetCostList),t=function(e){if(Oe(e)&&0!==e.length){let t=0;return e.forEach(e=>{t+=e}),t.toFixed(0)}}(this._pagingGetCostList),t=(this._pagingGetCostList.length=0,this._pagingStatus=Js,this._groupListTreeShaking(o),this._grpM.updateGroupMap(o),`count:${this._grpM.getLocalGroupList().length} sum:${t} avg:`+e);return at.l(r+" ok. "+t),i.setMessage(t).end(),this.tempConversationList&&(this.handleUpdateGroupLastMessage(this.tempConversationList),this.tempConversationList=null),this._grpM.emitGroupListUpdate(!0,!0),ut({groupList:this._grpM.getLocalGroupList()})}).catch(e=>(this._pagingStatus=Ws,i.setError(e).end(),at.e(r+" failed. error:",e),jt(e)))}getGroupList(){const t=this._n+".getGroupList";if(at.l(t+" pagingStatus:"+this._pagingStatus),this._pagingStatus===Ws||this._pagingStatus===Ks)return this.syncGroupList().then(()=>{var e=this._grpM.getLocalGroupList();return ut({groupList:e,isSyncCompleted:this.isPagingGetCompleted()})}).catch(e=>(at.e(t+" failed. error:",e),jt(e)));var e=this._grpM.getLocalGroupList();return at.l(t+". returned group count:"+e.length),Ht({groupList:e,isSyncCompleted:this.isPagingGetCompleted()})}isPagingGetCompleted(){return this._pagingStatus===Js}_pagingGetGroupList(e){const o=this._n+"._pagingGetGroupList";let{isCommunityRelay:r=!1,limit:i,offset:n,groupBaseInfoFilter:a,groupList:u}=e;const p=Date.now();return this._grpM.req({proto:es,data:{type:r?le:void 0,memberAccount:this._grpM.getMyUserID(),limit:i,offset:n,responseFilter:{groupBaseInfoFilter:a,selfInfoFilter:["Role","JoinTime","MsgFlag","MsgSeq"]}}}).then(e=>{var{groups:e=[],totalCount:t}=e.data,e=(u.push(...e),this._handleGroupAtInfoWithoutTopic(r,e),n+i),s=!(e<t),t=`offset:${n} limit:${i} totalCount:${t} isCompleted:${s} currentCount:${u.length} isCommunityRelay:`+r;return this._pagingGetCostList.push(ot(p,!1)),at.l(o+` ok. ${t} cost:`+ot(p)),r||s?!r&&s?(at.l(o+" start to get community list"),n=0,this._pagingGetGroupList({limit:i,offset:n,groupBaseInfoFilter:a,groupList:u,isCommunityRelay:!0})):r&&!s?(n=e,this._pagingGetGroupList({limit:i,offset:n,groupBaseInfoFilter:a,groupList:u,isCommunityRelay:!0})):ut({groupList:u}):(n=e,this._pagingGetGroupList({limit:i,offset:n,groupBaseInfoFilter:a,groupList:u}))}).catch(e=>10018===e.code?(at.w(this.logPrefix+" response size exceeds the limit, request count:"+i),i=50,this._pagingGetGroupList({limit:i,offset:n,groupBaseInfoFilter:a,groupList:u,isCommunityRelay:r})):r?(11e3===e.code&&at.l(o+" ok. community unavailable"),Ht({groupList:u})):jt(e))}_pagingGetGroupListWithTopic(e){const o=this._n+"._pagingGetGroupListWithTopic";let{limit:r,offset:i,groupBaseInfoFilter:n,groupList:a}=e;const u=Date.now();return this._grpM.req({proto:es,data:{type:le,memberAccount:this._grpM.getMyUserID(),limit:r,offset:i,responseFilter:{groupBaseInfoFilter:n,selfInfoFilter:["Role","JoinTime","MsgFlag","MsgSeq"]},isSupportTopic:1}}).then(e=>{var{groups:e=[],totalCount:t}=e.data,e=(a.push(...e),i+r),s=!(e<t);if(at.l(o+` ok. offset:${i} limit:${r} totalCount:${t} isCompleted:${s} currentCount:${a.length} cost:`+ot(u)),!s)return i=e,this._pagingGetGroupListWithTopic({limit:r,offset:i,groupBaseInfoFilter:n,groupList:a});this._grpM.updateGroupMap(a),this._grpM.emitGroupListUpdate(!0,!1);t=this._grpM.getLocalGroupList().filter(e=>!0===e.isSupportTopic);return ut({groupList:t})}).catch(e=>10018===e.code?(at.w(this.logPrefix+" response size exceeds the limit, request count:"+r),r=50,this._pagingGetGroupListWithTopic({limit:r,offset:i,groupBaseInfoFilter:n,groupList:a})):jt(e))}_cacheGroupMessage(e,t){this._cachedGroupMessageMap.has(e)||this._cachedGroupMessageMap.set(e,[]),this._cachedGroupMessageMap.get(e).push(t)}_deleteCachedGroupMessage(e){this._cachedGroupMessageMap.has(e)&&this._cachedGroupMessageMap.delete(e)}_notifyCachedGroupMessage(e){const t=this._cachedGroupMessageMap.get(e)||[];t.forEach(e=>{this.onNewGroupMessage(e)}),this._deleteCachedGroupMessage(e),at.l(this._n+`._notifyCachedGroupMessage groupID:${e} count:`+t.length)}_cacheGroupMessageAndProbe(e){const{groupID:s,event:t,item:o}=e;this._cacheGroupMessage(s,{event:t,dataList:[o]}),this._grpM.getGroupSimplifiedInfo(s).then(e=>{var t=e["type"];t===pe?this._grpM.hasLocalGroup(s)?this._notifyCachedGroupMessage(s):this._grpM.setUnjoinedAVChatRoom(s):(this._grpM.updateGroupMap([e]),this._notifyCachedGroupMessage(s))}),this._checkCountMap.has(s)||this._checkCountMap.set(s,0),at.l(this._n+"._cacheGroupMessageAndProbe groupID:"+s)}_handleGroupAtInfoWithoutTopic(e,t){e&&0!==t.length&&t.forEach(e=>{const{groupID:t,groupAtInfoList:s}=e,r=[];Fe(s)||(s.forEach(e=>{r.push({...e,groupID:t})}),this._grpM.get(o).onNewGroupAtTips({dataList:r}))})}setPagingGroupCount(e){Fe(e)||(this.PAGING_GRP_COUNT_LIMIT=parseInt(e,10))}reset(){this.PAGING_GRP_COUNT_LIMIT=200,this._cachedGroupMessageMap.clear(),this._checkCountMap.clear(),this._pagingStatus=Ks,this._pagingGetCostList=[]}}const go=1,mo=2,_o=3,fo=4,Mo=5;class Io{constructor(e){this._grpM=e,this._n="GroupAttributesHandler",this._groupAttributesMap=new Map,this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4,this._grpM.getInnerEmitterInstance().on(Bt.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}_onCloudConfigUpdated(){var e=this._grpM.getCloudConfig("grp_attr_cache_time");Fe(e)||(this.CACHE_EXPIRE_TIME=Number(e))}updateLocalMainSequenceOnReconnected(){this._groupAttributesMap.forEach(e=>{e.localMainSequence=0})}isGroupAttributesUpdatedNotice(e){var{to:e,elements:{newGroupProfile:t}}=e,s=!Fe(t)&&!Pe(t.groupAttributeOption);return s&&this._onGroupAttributesUpdated({groupID:e,groupAttributeOption:t.groupAttributeOption}),s}_onGroupAttributesUpdated(e){const{groupID:t,groupAttributeOption:s}=e,{mainSequence:o,isWithChangedAttributeInfo:r,groupAttributeList:i=[],operationType:n}=s;if(at.l(this._n+".onGroupAttributesUpdated. "+`groupID:${t} isWithChangedAttributeInfo:${r} operationType:`+n),!Fe(n)){this._groupAttributesCopy=this._getCachedAttributes({groupID:t});e=this._getLocalGroupAttributes(t)["localMainSequence"],e=o-e;if(0!=e){if(1===r&&1==e)return this._refreshCachedGroupAttributes({groupID:t,remoteMainSequence:o,groupAttributeList:i,operationType:n}),void this._emitGroupAttributesUpdated(t);if(this._hasLocalGroupAttributes(t)){const e=this._getLocalGroupAttributes(t)["avChatRoomKey"];this._getGroupAttributes({groupID:t,avChatRoomKey:e}).then(()=>{this._emitGroupAttributesUpdated(t)})}}}}initGroupAttributesCache(e){var{groupID:e,avChatRoomKey:t}=e;this._groupAttributesMap.set(e,{lastUpdateTime:0,localMainSequence:0,remoteMainSequence:0,attributes:new Map,avChatRoomKey:t}),at.l(this._n+`.initGroupAttributesCache groupID:${e} avChatRoomKey:`+t)}initGroupAttributes(e){const{groupID:r,groupAttributes:i}=e,{remoteMainSequence:t,avChatRoomKey:s}=this._getLocalGroupAttributes(r),n=new Qt("initGroupAttributes");return n.setMessage(`groupID:${r} avChatRoomKey:${s} mainSequence:`+t),this._grpM.req({proto:Ts,data:{groupID:r,avChatRoomKey:s,mainSequence:t,groupAttributeList:this._transformGroupAttributes(i)}}).then(e=>{at.l(this._n+".initGroupAttributes ok. groupID:"+r);const{mainSequence:t,groupAttributeList:s}=e.data,o=[...s];return o.forEach(e=>{e.value=i[e.key]}),this._groupAttributesCopy=this._getCachedAttributes({groupID:r}),this._refreshCachedGroupAttributes({groupID:r,remoteMainSequence:t,groupAttributeList:o,operationType:go}),this._emitGroupAttributesUpdated(r),n.end(),ut({groupAttributes:i})}).catch(e=>(n.setError(e).end(),jt(e)))}setGroupAttributes(e){const r=this._n+".setGroupAttributes",{groupID:i,groupAttributes:n}=e,{remoteMainSequence:t,avChatRoomKey:s,attributes:o}=this._getLocalGroupAttributes(i),a=this._transformGroupAttributes(n),u=(a.forEach(e=>{var t=e["key"];e.sequence=0,o.has(t)&&(e.sequence=o.get(t).sequence)}),new Qt("setGroupAttributes"));return u.setMessage(`groupID:${i} groupAttributes:`+JSON.stringify(n)),at.l(r+`. groupID:${i} mainSequence:`+t),this._grpM.req({proto:As,data:{groupID:i,avChatRoomKey:s,mainSequence:t,groupAttributeList:a}}).then(e=>{at.l(r+" ok.");const{mainSequence:t,groupAttributeList:s}=e.data,o=[...s];return o.forEach(e=>{e.value=n[e.key]}),this._groupAttributesCopy=this._getCachedAttributes({groupID:i}),this._refreshCachedGroupAttributes({groupID:i,remoteMainSequence:t,groupAttributeList:o,operationType:mo}),this._emitGroupAttributesUpdated(i),u.end(),ut({groupAttributes:n})}).catch(e=>(u.setError(e).end(),jt(e)))}deleteGroupAttributes(l){const{groupID:t,keyList:e=[]}=l,{remoteMainSequence:s,avChatRoomKey:h,attributes:o}=this._getLocalGroupAttributes(t);let r=[...o.keys()],i=vs,n=_o;const a={groupID:t,avChatRoomKey:h,mainSequence:s},u=[],p=(0<e.length&&(r=[],i=Ss,n=fo,e.forEach(e=>{let t=0;o.has(e)&&(t=o.get(e).sequence,r.push(e)),u.push({key:e,sequence:t})}),a.groupAttributeList=u),new Qt("deleteGroupAttributes"));return p.setMessage(`groupID:${t} mainSequence:${s} keyList:${e} proto:`+i),this._grpM.req({proto:i,data:a}).then(e=>{at.l(this._n+".deleteGroupAttributes ok. groupID:"+t);e=e.data.mainSequence;return this._groupAttributesCopy=this._getCachedAttributes({groupID:t}),this._refreshCachedGroupAttributes({groupID:t,remoteMainSequence:e,groupAttributeList:u,operationType:n}),this._emitGroupAttributesUpdated(t),p.end(),ut({keyList:r})}).catch(e=>(p.setError(e).end(),jt(e)))}getGroupAttributes(t){const s=this._n+".getGroupAttributes",o=t["groupID"],{avChatRoomKey:e,lastUpdateTime:r,localMainSequence:i,remoteMainSequence:n}=this._getLocalGroupAttributes(o),a=new Qt("getGroupAttributes");if(a.setMessage(`groupID:${o} localMainSequence:${i} remoteMainSequence:${n} keyList:`+t.keyList),Date.now()-r>=this.CACHE_EXPIRE_TIME||i<n)return this._getGroupAttributes({groupID:o,avChatRoomKey:e}).then(e=>{a.setMoreMessage("get attributes from remote. count:"+e.length).end(),at.l(s+" from remote. groupID:"+o);e=this._getCachedAttributes(t);return ut({groupAttributes:e})}).catch(e=>(a.setError(e).end(),jt(e)));a.setMoreMessage("get attributes from cache").end(),at.l(s+" from cache. groupID:"+o);var u=this._getCachedAttributes(t);return Ht({groupAttributes:u})}_getGroupAttributes(o){let e=0;return Fe(o.avChatRoomKey)||(e=1),this._grpM.req({proto:Rs,data:{...o,groupType:e}}).then(e=>{at.l(this._n+"._getGroupAttributes ok. groupID:"+o.groupID);var{mainSequence:e,groupAttributeList:t}=e.data,s=[...t];return Fe(e)||this._refreshCachedGroupAttributes({groupID:o.groupID,remoteMainSequence:e,groupAttributeList:s,operationType:Mo}),t}).catch(e=>jt(e))}_refreshCachedGroupAttributes(e){var{groupID:t,remoteMainSequence:s,groupAttributeList:o,operationType:r}=e;if(this._hasLocalGroupAttributes(t)){const e=this._getLocalGroupAttributes(t),i=e["localMainSequence"];if(r===Mo||s-i==1)e.remoteMainSequence=s,e.localMainSequence=s,e.lastUpdateTime=Date.now(),this._updateCachedAttributes({groupAttributes:e,groupAttributeList:o,operationType:r});else{if(i===s)return;e.remoteMainSequence=s}this._groupAttributesMap.set(t,e);o=`operationType:${r} localMainSequence:${i} remoteMainSequence:`+s;at.l(this._n+"._refreshCachedGroupAttributes. "+o)}}_getCachedAttributes(t){const{groupID:e,keyList:s=[]}=t,o={};if(this._hasLocalGroupAttributes(e)){const t=this._getLocalGroupAttributes(e)["attributes"];if(0<s.length)s.forEach(e=>{t.has(e)&&(o[e]=t.get(e).value)});else for(const e of t.keys())o[e]=t.get(e).value}return o}_updateCachedAttributes(e){const{groupAttributes:o,groupAttributeList:t,operationType:s}=e;s!==_o?s!==fo?(s===go&&o.attributes.clear(),t.forEach(e=>{var{key:e,value:t,sequence:s}=e;o.attributes.set(e,{value:t,sequence:s})})):t.forEach(e=>{o.attributes.delete(e.key)}):o.attributes.clear()}_hasLocalGroupAttributes(e){return this._groupAttributesMap.has(e)}_getLocalGroupAttributes(e){return this._hasLocalGroupAttributes(e)||this.initGroupAttributesCache({groupID:e}),this._groupAttributesMap.get(e)}_transformGroupAttributes(t){const s=[];return Object.keys(t).forEach(e=>{s.push({key:e,value:t[e]})}),s}_emitGroupAttributesUpdated(e){var t=this._getCachedAttributes({groupID:e}),{updatedKeyList:s,deletedKeyList:o}=this._computeAttrChangedInfo(t);at.l(`${this._n}._emitGroupAttributesUpdated update:${s.length}, delete:`+o.length),0===s.length&&0===o.length||this._grpM.emitOuterEvent(kt,{groupID:e,groupAttributes:t,updatedKeyList:s,deletedKeyList:o})}_computeAttrChangedInfo(t){const s=[],o=[];return Object.keys(t).forEach(e=>{t[e]!==this._groupAttributesCopy[e]&&s.push(e)}),Object.keys(this._groupAttributesCopy).forEach(e=>{Fe(t[e])&&o.push(e)}),this._groupAttributesCopy={},{updatedKeyList:s,deletedKeyList:o}}deleteLocalGroupAttributes(e){this._hasLocalGroupAttributes(e)&&this._groupAttributesMap.delete(e)}reset(){this._groupAttributesMap.clear(),this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4}}const Do="Set",Lo="Increase",yo="Decrease";class Go{constructor(e){this._grpM=e,this._n="GroupCountersHandler",this._groupCountersMap=new Map,this.EXPIRE_TIME=3e4,this._grpM.getInnerEmitterInstance().on(Bt.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}_onCloudConfigUpdated(){var e=this._grpM.getCloudConfig("grp_counter_expire_time");Fe(e)||(this.EXPIRE_TIME=Number(e))}isGroupCountersNotice(e){var{to:e,elements:{groupCounterInfo:t}}=e;let s=!1;return Pe(t)||(this._onGroupCountersUpdated({groupID:e,groupCounterInfo:t}),s=!0),s}_onGroupCountersUpdated(e){const{groupID:r,groupCounterInfo:t}=e;t.forEach(e=>{const{type:t,groupCounterSeq:s,counterList:o=[]}=e;0!==t&&2!==t||(this._updateLocalGroupCounters({groupID:r,groupCounterSeq:s,counterList:o}),o.forEach(e=>{this._grpM.emitOuterEvent(Ot,{groupID:r,key:e.key,value:e.value})})),1===t&&this._deleteLocalGroupCounters({groupID:r,groupCounterSeq:s,counterList:o})}),at.l(this._n+"._onGroupCountersUpdated groupID:"+r)}initGroupCountersCache(e){var{groupID:e,avChatRoomKey:t}=e;this._groupCountersMap.set(e,{lastUpdateTime:0,groupCounterSeq:0,counters:new Map,avChatRoomKey:t}),at.l(this._n+`.initGroupCountersCache groupID:${e} avChatRoomKey:`+t)}setGroupCounters(e){if(!this._grpM.canIUse(M.GRP_COUNTER))return this._grpM.cannotUseCommercialAbility("setGroupCounters");const t=this._n+".setGroupCounters",{groupID:s,counters:o}=e,r=this._convertObjectToList(o),i=this._getLocalGroupCounters(s)["avChatRoomKey"],n=`groupID:${s} count:`+r.length,a=new Qt("setGroupCounters");return a.setMessage(n),at.l(t+". "+n),this._updateGroupCounters({groupID:s,counterList:r,avChatRoomKey:i,mode:Do}).then(e=>(a.end(),at.l(t+" ok."),ut({counters:e}))).catch(e=>(a.setError(e).end(),at.e(t+" failed. error:",e),jt(e)))}increaseGroupCounter(e){var t="increaseGroupCounter";if(!this._grpM.canIUse(M.GRP_COUNTER))return this._grpM.cannotUseCommercialAbility(t);const s=this._n+"."+t,{groupID:o,key:r,value:i}=e,n=this._getLocalGroupCounters(o)["avChatRoomKey"],a=`groupID:${o} key:${r} value:`+i,u=new Qt(t);return u.setMessage(a),at.l(s+". "+a),this._updateGroupCounters({groupID:o,counterList:[{key:r,value:i}],avChatRoomKey:n,mode:Lo}).then(e=>(u.end(),at.l(s+" ok."),ut({counters:e}))).catch(e=>(u.setError(e).end(),at.e(s+" failed. error:",e),jt(e)))}decreaseGroupCounter(e){var t="decreaseGroupCounter";if(!this._grpM.canIUse(M.GRP_COUNTER))return this._grpM.cannotUseCommercialAbility(t);const s=this._n+"."+t,{groupID:o,key:r,value:i}=e,n=this._getLocalGroupCounters(o)["avChatRoomKey"],a=`groupID:${o} key:${r} value:`+i,u=new Qt(t);return u.setMessage(a),at.l(s+". "+a),this._updateGroupCounters({groupID:o,counterList:[{key:r,value:i}],avChatRoomKey:n,mode:yo}).then(e=>(u.end(),at.l(s+" ok."),ut({counters:e}))).catch(e=>(u.setError(e).end(),at.e(s+" failed. error:",e),jt(e)))}getGroupCounters(e){if(!this._grpM.canIUse(M.GRP_COUNTER))return this._grpM.cannotUseCommercialAbility("getGroupCounters");const t=this._n+".getGroupCounters",{groupID:s,keyList:o=[]}=e,{avChatRoomKey:r,lastUpdateTime:i}=this._getLocalGroupCounters(s),n=new Qt("getGroupCounters");if(n.setMessage("groupID:"+s),Date.now()-i>=this.EXPIRE_TIME)return this._getRemoteGroupCounters({groupID:s,avChatRoomKey:r}).then(e=>{n.setMoreMessage("from remote. count:"+e.length).end(),at.l(t+" from remote. groupID:"+s);e=this._getLocalCounters(s,o);return ut({counters:e})}).catch(e=>(n.setError(e).end(),jt(e)));n.setMoreMessage("from cache").end(),at.l(t+" from cache. groupID:"+s);e=this._getLocalCounters(s,o);return Ht({counters:e})}_getRemoteGroupCounters(s){return this._grpM.req({proto:Us,data:{...s}}).then(e=>{var{counterList:e=[],groupCounterSeq:t}=e.data;return this._updateLocalGroupCounters({groupID:s.groupID,counterList:e,groupCounterSeq:t}),at.l(this._n+"._getRemoteGroupCounters ok. groupID:"+s.groupID),e}).catch(e=>jt(e))}_convertObjectToList(t){const s=[];return Object.keys(t).forEach(e=>{s.push({key:e,value:t[e]})}),s}_updateGroupCounters(e){const o=this._n+"._updateGroupCounters",{groupID:t,avChatRoomKey:s,mode:r}=e;return at.l(o+`. groupID:${t} avChatRoomKey:${s} mode:`+r),this._grpM.req({proto:ws,data:{...e}}).then(e=>{at.l(o+" ok.");const{counterList:t=[]}=e.data,s={};return t.forEach(e=>{var{key:e,value:t}=e;s[e]=t}),s}).catch(e=>jt(e))}_hasLocalGroupCounters(e){return this._groupCountersMap.has(e)}_getLocalGroupCounters(e){return this._hasLocalGroupCounters(e)||this.initGroupCountersCache({groupID:e}),this._groupCountersMap.get(e)}_updateLocalGroupCounters(s){const{groupID:e,counterList:t=[],groupCounterSeq:o}=s;if(this._hasLocalGroupCounters(e)){const{counters:s,avChatRoomKey:r,groupCounterSeq:i}=this._getLocalGroupCounters(e);0<o&&o<i||(t.forEach(e=>{var{key:e,value:t}=e;s.set(e,t)}),this._groupCountersMap.set(e,{lastUpdateTime:Date.now(),groupCounterSeq:o,counters:s,avChatRoomKey:r}))}}_deleteLocalGroupCounters(t){const{groupID:e,counterList:s=[],groupCounterSeq:o}=t;if(this._hasLocalGroupCounters(e)){const{counters:t,avChatRoomKey:r}=this._getLocalGroupCounters(e);s.forEach(e=>{t.delete(e.key)}),this._groupCountersMap.set(e,{lastUpdateTime:Date.now(),groupCounterSeq:o,counters:t,avChatRoomKey:r})}}_getLocalCounters(e,t){const s={};if(!this._hasLocalGroupCounters(e))return s;const o=this._getLocalGroupCounters(e)["counters"];if(0<t.length)t.forEach(e=>{o.has(e)&&(s[e]=o.get(e))});else for(const r of o.keys())s[r]=o.get(r);return s}reset(){this._groupCountersMap.clear(),this.EXPIRE_TIME=3e4}}class Co{constructor(e){var{manager:e,groupID:t,onInit:s,onSuccess:o,onFail:r}=e;this._n="Polling",this._manager=e,this._grpM=e._grpM,this._onInit=s,this._onSuccess=o,this._onFail=r,this._groupID=t,this._timeoutID=-1,this._isRunning=!1,this._proto=Ls}start(){var e=this._grpM.isLoggedIn();e||(this._proto=ys),at.l(`${this._n}.start pollingInterval:${this._manager.getPollingInterval()} isLoggedIn:`+e),this._isRunning=!0,this._request()}isRunning(){return this._isRunning}_request(){var e=this._onInit(this._groupID);this._grpM.req({proto:this._proto,data:e}).then(e=>{this._onSuccess(this._groupID,e),this.isRunning()&&(clearTimeout(this._timeoutID),this._timeoutID=setTimeout(this._request.bind(this),this._manager.getPollingInterval()))}).catch(e=>{this._onFail(this._groupID,e),this.isRunning()&&(clearTimeout(this._timeoutID),this._timeoutID=setTimeout(this._request.bind(this),this._manager.MAX_POLLING_INTERVAL))})}stop(){at.l(this._n+".stop"),0<this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=-1),this._isRunning=!1}getPollingTimerID(){return this._timeoutID}}class bo{constructor(e){this.value=e,this.next=null}}class To{constructor(e){this.MAX_LENGTH=e,this.pTail=null,this.pNodeToDel=null,this.map=new Map}set(t){var s=new bo(t);if(this.map.size<this.MAX_LENGTH)null===this.pTail?(this.pTail=s,this.pNodeToDel=s):(this.pTail.next=s,this.pTail=s),this.map.set(t,1);else{let e=this.pNodeToDel;this.pNodeToDel=this.pNodeToDel.next,this.map.delete(e.value),e.next=null,e=null,this.pTail.next=s,this.pTail=s,this.map.set(t,1)}}has(e){return this.map.has(e)}delete(e){this.has(e)&&this.map.delete(e)}tail(){return this.pTail}size(){return this.map.size}data(){return Array.from(this.map.keys())}reset(){let e;for(;null!==this.pNodeToDel;)e=this.pNodeToDel,this.pNodeToDel=this.pNodeToDel.next,e.next=null,e=null;this.pTail=null,this.map.clear()}}const Ao=["groupID","name","avatar","type","introduction","notification","ownerID","selfInfo","createTime","infoSequence","lastInfoTime","lastMessage","nextMessageSeq","memberNum","maxMemberNum","memberList","joinOption","groupCustomField","muteAllMembers","isSupportTopic","inviteOption","_lastRevokedTime"];class So{constructor(e){this.groupID="",this.name="",this.avatar="",this.type="",this.introduction="",this.notification="",this.ownerID="",this.createTime="",this.infoSequence="",this.lastInfoTime="",this.selfInfo={messageRemindType:"",joinTime:"",nameCard:"",role:"",userID:"",memberCustomField:void 0,readedSequence:0,excludedUnreadSequenceList:void 0},this.lastMessage={lastTime:"",lastSequence:"",fromAccount:"",messageForShow:""},this.nextMessageSeq="",this.memberNum="",this.memberCount="",this.maxMemberNum="",this.maxMemberCount="",this.joinOption="",this.inviteOption="",this.groupCustomField=[],this.muteAllMembers=!1,this.isSupportTopic=!1,this._lastRevokedTime=0,this._initGroup(e)}set memberNum(e){}set maxMemberNum(e){}get memberNum(){return this.memberCount}get maxMemberNum(){return this.maxMemberCount}_initGroup(e){for(const t in e)Ao.indexOf(t)<0||("selfInfo"!==t?("memberNum"===t&&(this.memberCount=e[t]),"maxMemberNum"===t&&(this.maxMemberCount=e[t]),"isSupportTopic"!==t?this[t]=e[t]:this.isSupportTopic=1===e[t]):this.updateSelfInfo(e[t]))}updateGroup(e){e.appid=void 0,e.grossTopicNextMsgSeq=void 0,e.selfInfo&&(e.selfInfo.grossTopicReadSeq=void 0);const t=JSON.parse(JSON.stringify(e));t.lastMsgTime&&(this.lastMessage.lastTime=t.lastMsgTime),Fe(t.muteAllMembers)||("On"===t.muteAllMembers?t.muteAllMembers=!0:t.muteAllMembers=!1),t.groupCustomField&&Je(this.groupCustomField,t.groupCustomField),Fe(t.memberNum)||(this.memberCount=t.memberNum),Fe(t.maxMemberNum)||(this.maxMemberCount=t.maxMemberNum),Fe(t.isSupportTopic)||(this.isSupportTopic=Ne(t.isSupportTopic)?1===t.isSupportTopic:t.isSupportTopic),He(this,t,["members","errorCode","lastMsgTime","groupCustomField","memberNum","maxMemberNum","isSupportTopic"]),Oe(t.members)&&0<t.members.length&&t.members.forEach(e=>{e.userID===this.selfInfo.userID&&He(this.selfInfo,e,["sequence"])})}updateSelfInfo({nameCard:e,joinTime:t,role:s,messageRemindType:o,readedSequence:r,excludedUnreadSequenceList:i}){e={nameCard:e,joinTime:t,role:s,messageRemindType:o,readedSequence:r,excludedUnreadSequenceList:i};He(this.selfInfo,{...e},[],["",null,void 0,0,NaN])}setSelfNameCard(e){this.selfInfo.nameCard=e}}const vo={3:!0,4:!0,5:!0,6:!0,17:!0,20:!0,21:!0,100:!0};class Ro{constructor(e){this._grpM=e,this._n="AVChatRoomHandler",this._joinedGroupMap=new Map,this._pollingRequestInfoMap=new Map,this._pollingInstanceMap=new Map,this.sequencesLinkedList=new To(200),this.messageIDLinkedList=new To(100),this._reportMessageStackedCount=0,this._onlineMemberCountMap=new Map,this.DEFAULT_EXPIRE_TIME=60,this.DEFAULT_POLLING_INTERVAL=300,this.MAX_POLLING_INTERVAL=2e3,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0,this._startBroadcastSeq=1,this._broadcastMessageIDMap=new Map,this.DEFAULT_POLLING_SIMPLIFIED_MSG=0}hasJoinedAVChatRoom(){let e=[];return 0<(e=0<this._joinedGroupMap.size?[...this._joinedGroupMap.values()].filter(e=>e.type===pe):e).length}getJoinedLiveList(){let e=[];return e=0<this._joinedGroupMap.size?[...this._joinedGroupMap.values()].filter(e=>e.type===he):e}checkJoinedAVChatRoomByID(e){return this._joinedGroupMap.has(e)}getJoinedAVChatRoom(){return 0<this._joinedGroupMap.size?[...this._joinedGroupMap.keys()]:[]}_updatedata(e){var t=this._pollingRequestInfoMap.get(e);return e===[...this._pollingInstanceMap.keys()][0]?{...t,startBroadcastSeq:this._startBroadcastSeq,simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG}:{...t,simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG}}_handleSuccess(e,t){const{key:s,nextSeq:o,rspMsgList:r,errorCode:i,nextBroadcastSeq:n,broadcastMessageList:a}=t.data;if(0!==i){const s=this._pollingRequestInfoMap.get(e),o=new Qt("longPollingAVError"),r=s?s.key+"-"+s.startSeq:"requestInfo is undefined";o.setMessage(`${e}-${r}-`+t.errorInfo).setCode(t.errorCode).end(!0)}else this.checkJoinedAVChatRoomByID(e)&&(qe(s)&&Ne(o)&&this._pollingRequestInfoMap.set(e,{key:s,startSeq:o}),Ne(n)&&n>this._startBroadcastSeq&&(this._startBroadcastSeq=n),Oe(r)&&0<r.length?(r.forEach(e=>{e.to=e.groupID}),this.onMessage(r,e)):(this._pollingNoMessageCount+=1,this._pollingNoMessageCount===this.DEFAULT_POLLING_NO_MESSAGE_COUNT&&(this._pollingInterval=this.DEFAULT_POLLING_INTERVAL+this.DEFAULT_POLLING_INTERVAL_PLUS)),this._onBroadcastMessage(a))}_handleFailure(e,t){}onMessage(n,a){if(Oe(n)&&0!==n.length){let t=this._n+".onMessage",s=(a&&(t+=" groupID:"+a),0!==this._pollingNoMessageCount&&(this._pollingNoMessageCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL),null);const l=[],g=this._get(o),c=this._get(u),m=n.length;1<m&&n.sort((e,t)=>e.sequence-t.sequence);var p=this._get(r).isUnlimitedAVChatRoom();let i=!1;if(at.getLevel()<=0){const a=n.map(e=>e.sequence);at.l(`${t} count:${a.length} sequenceList:`+a),a.length=0}for(let e=0;e<m;e++){const a=this.restoreMessageFromSimplified(n[e]);if(vo[a.event]){if(6===a.event){if(this._grpM.isGroupAttributesUpdatedNotice(a))continue;if(this._grpM.isGroupCountersNotice(a))continue}if(20!==a.event)if(21!==a.event)if(100!==a.event){s=this.packMessage(a,a.event);const r=1===a.isModified;if(i=1===a.isHistoryMessage,!p){if(this.sequencesLinkedList.has(s.sequence))continue;this.sequencesLinkedList.set(s.sequence)}const u=this.messageIDLinkedList.has(s.ID);if(u)at.w(`${t} ID:${s.ID} has:`+u);else{this.messageIDLinkedList.set(s.ID);let e=!1;if(!i&&this._isMessageSentByCurrentInstance(s)?r&&(e=!0,s.isModified=r,g.updateMessageIsModifiedProperty(s)):e=!0,e){if(s.conversationType===ie&&5===s.payload.operationType&&this._onGroupDismissed(s.payload.groupProfile.groupID),!i&&s.conversationType!==ie){const n=s.conversationID.replace(oe,"");this._pollingInstanceMap.has(n)?this._grpM.isLoggedIn()&&c.addMessageSequence({key:Wt,message:s}):(s.type!==W&&0<s.clientTime&&c.addMessageDelay(s.clientTime),c.addMessageSequence({key:Jt,message:s}))}l.push(s)}}}else this.onRoomCustomData(a);else this._get(h).onMessageReactionNotify({event:21,dataList:a.elements.messageReactionNotifyList});else this.handleMessageRevokedNotice(a)}else at.w(t+". unknown event:"+a.event)}if(0!==l.length){a=We(l);if(0<a.length&&this._grpM.emitOuterEvent(Ut,a),!i){const n=this.packConversationOption(l);0<n.length&&g.onNewMessage({conversationOptionsList:n,isInstantMessage:!0})}this._checkMessageStacked(l);a=ze(l);0<a.length&&this._grpM.emitOuterEvent(wt,a),l.length=0}}}handleMessageRevokedNotice(e){const{groupID:r,elements:{revokeMsgList:t},revokerInfo:i}=e,n=[];t.forEach(e=>{var{tinyID:e,clientTime:t,random:s,sequence:o}=e,e={conversationID:""+oe+r,ID:e+`-${t}-`+s,revoker:i.revoker,revokeReason:i.reason||"",revokerInfo:{userID:i.revoker,nick:"",avatar:""},sequence:o};n.push(e)}),0!==n.length&&this._get(o).updateRevokerInfo(n).then(e=>{this._grpM.emitOuterEvent(Nt,e)})}isBroadcastOrNormal(e){return 3===e||17===e}isGroupTip(e){return 4===e||6===e}isGroupSystemNotice(e){return 5===e}restoreGroupTipElements(e={}){const{operatorInfo:t={},operatorID:s,userIDList:o=[],operationType:r}=e;Ne(e.groupJoinType)||1!==r&&2!==r||(e.groupJoinType=2===r?0:1);var{userID:i=s,avatar:n="",nick:a=""}=t,i=(e.operatorInfo={userID:i,avatar:n,nick:a},o.map(e=>({userID:e})));return e.memberInfoList=e.memberInfoList||i,e}restoreMessageFromSimplified(s){const e=s["event"];if(this.isBroadcastOrNormal(e)&&(s.cloudCustomData=s.cloudCustomData||"",s.elements=s.elements.map(e=>{var t;return e.type===X&&({content:t={}}=e,e.content={data:"",description:"",extension:"",...t}),e})),(this.isGroupTip(e)||this.isGroupSystemNotice(e))&&(s.from=s.from||"@TIM#SYSTEM"),this.isGroupTip(e)){s.elements=this.restoreGroupTipElements(s.elements);const{elements:e={}}=s,{operationType:t,operatorInfo:r={}}=e;if(1===t){const s=[{userID:r.userID}];e.memberInfoList=e.memberInfoList||s}}if(this.isGroupSystemNotice(e)){let{memberInfoList:e,operatorInfo:t={}}=s.elements;e=e||t,s.elements.memberInfoList={userID:s.elements.operatorID,avatar:"",nick:"",...e},s.elements={authentication:"",remarkInfo:"",messageKey:1e3*s.time,...s.elements};var o=Object.keys(s.elements).filter(e=>"operatorInfo"!==e).reduce((e,t)=>({...e,[t]:s.elements[t]}),{});s.elements=o}return s}_onGroupDismissed(e){at.l(this._n+"._onGroupDismissed groupID:"+e),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e)}_checkMessageStacked(e){var t="MessageStacked",e=e.length;100<=e&&(this._grpM.outputWarning(t,e),this._reportMessageStackedCount<5)&&(new Qt(t).setMessage(`count:${e} groupID:`+[...this._joinedGroupMap.keys()]).setLevel("warning").end(),this._reportMessageStackedCount+=1)}_isMessageSentByCurrentInstance(e){return!!this._get(o).isMessageSentByCurrentInstance(e)}packMessage(e,t){e.currentUser=this._grpM.getMyUserID(),e.conversationType=5===t?ie:oe,e.isSystemMessage=!!e.isSystemMessage;const s=new lo(e),o=this.packElements(e,t);return s.setElement(o,this._grpM.getFileDownloadProxy()),s}packElements(e,t){return 4===t||6===t?(this._updateMemberCountByGroupTips(e),{type:W,content:{...e.elements,groupProfile:e.groupProfile}}):5===t?{type:z,content:{...e.elements,groupProfile:{...e.groupProfile,groupID:e.groupID}}}:e.elements}packConversationOption(t){const s=new Map;for(let e=0;e<t.length;e++){var o=t[e],r=o.conversationID;if(s.has(r)){const t=s.get(r);"in"===(t.lastMessage=o).flow&&t.unreadCount++}else s.set(r,{conversationID:o.conversationID,unreadCount:"out"===o.flow?0:1,type:o.conversationType,subType:o.conversationSubType,lastMessage:o})}return[...s.values()]}_updateMemberCountByGroupTips(e){var{groupProfile:{groupID:e},elements:{onlineMemberInfo:t}}=e;if(Pe(t))return;const{onlineMemberNum:s=0,expireTime:o=this.DEFAULT_EXPIRE_TIME}=t,r=this._onlineMemberCountMap.get(e)||{},i=Date.now();Pe(r)?Object.assign(r,{lastReqTime:0,lastSyncTime:0,latestUpdateTime:i,memberCount:s,expireTime:o}):(r.latestUpdateTime=i,r.memberCount=s),this._onlineMemberCountMap.set(e,r)}_onBroadcastMessage(s){if(!Pe(s)){const o=[],r=s.length;let t=null;for(let e=0;e<r;e++){const r=this.restoreMessageFromSimplified(s[e]);vo[r.event]?((t=this.packMessage(r,r.event)).isBroadcastMessage=!0,this._broadcastMessageIDMap.has(t.ID)||(o.push(t),this._broadcastMessageIDMap.set(t.ID,1))):at.w(this._n+"._onBroadcastMessage unknown event:"+r.event)}0<o.length&&this._grpM.emitOuterEvent(wt,o)}}start(e){if(this._pollingInstanceMap.has(e)){const t=this._pollingInstanceMap.get(e);void(t.isRunning()||t.start())}else{const t=new Co({manager:this,groupID:e,onInit:this._updatedata.bind(this),onSuccess:this._handleSuccess.bind(this),onFail:this._handleFailure.bind(this)});t.start(),this._pollingInstanceMap.set(e,t),at.l(this._n+".start groupID:"+e)}}handleJoinResult(o){return this._preCheck(o.group).then(()=>{var{longPollingKey:e,group:t}=o,s=t.groupID;return this._joinedGroupMap.set(s,t),this._grpM.updateGroupMap([t]),this._grpM.deleteUnjoinedAVChatRoom(s),this._grpM.emitGroupListUpdate(!0,!1),Fe(e)?Ht({status:Ae,group:t}):Promise.resolve()})}startRunLoop(r){return this.handleJoinResult(r).then(()=>{var{longPollingKey:e,group:t,startSeq:s=0}=r,o=t.groupID;return this._pollingRequestInfoMap.set(o,{key:e,startSeq:s}),this.start(o),this._grpM.isLoggedIn()?Ht({status:Ae,group:t}):Ht({status:Ae})})}_preCheck(e){if(this._get(r).isUnlimitedAVChatRoom())return Promise.resolve();if(!this.hasJoinedAVChatRoom())return Promise.resolve();if(e.type===he)return Promise.resolve();var[e,t]=this._joinedGroupMap.entries().next().value;if(this._grpM.isLoggedIn()){if(t.selfInfo.role!==ge&&t.ownerID!==this._grpM.getMyUserID())return this._grpM.quitGroup(e);this._grpM.deleteLocalGroupAndConversation(e)}else this._grpM.deleteLocalGroupAndConversation(e);return this.reset(e),Promise.resolve()}joinWithoutAuth(e){const s=e["groupID"],r=this._n+".joinWithoutAuth",n=new Qt("joinWithoutAuth");return this._grpM.req({proto:ns,data:e}).then(({data:{longPollingKey:e}})=>{if(n.setMessage(`groupID:${s} longPollingKey:`+e).end(!0),Fe(e))return jt({code:yt});at.l(r+" ok. groupID:"+s),this._get(o).setCompleted(""+oe+s);var t=new So({groupID:s});return this.startRunLoop({group:t,longPollingKey:e}),ut({status:Ae})}).catch(e=>(at.e(r+` failed. groupID:${s} error:`,e),n.setError(e).setMessage("groupID:"+s).end(!0),jt(e))).finally(()=>{this._grpM.get(i).reportAtOnce()})}getGroupOnlineMemberCount(e){const t=this._onlineMemberCountMap.get(e)||{},s=Date.now();return Pe(t)||s-t.lastSyncTime>1e3*t.expireTime&&1e4<s-t.latestUpdateTime&&3e3<s-t.lastReqTime?(t.lastReqTime=s,this._onlineMemberCountMap.set(e,t),this._getGroupOnlineMemberCount(e).then(e=>ut({memberCount:e.memberCount})).catch(e=>jt(e))):Ht({memberCount:t.memberCount})}_getGroupOnlineMemberCount(r){const i=this._n+"._getGroupOnlineMemberCount",t=new Qt("_getGroupOnlineMemberCount");return this._grpM.requestOnlineCount(r).then(e=>{const t=this._onlineMemberCountMap.get(r)||{},{memberCount:s=0,expireTime:o=this.DEFAULT_EXPIRE_TIME}=e.data;at.l(i+` ok. groupID:${r} memberCount:${s} expireTime:`+o);e=Date.now();return Pe(t)&&(t.lastReqTime=e),this._onlineMemberCountMap.set(r,Object.assign(t,{lastSyncTime:e,latestUpdateTime:e,memberCount:s,expireTime:o})),{memberCount:s}}).catch(e=>(at.w(i+" failed. error:",e),t.setCode(e.code).setMessage(`groupID:${r} error:`+JSON.stringify(e)).end(),Promise.reject(e)))}_get(e){return this._grpM.get(e)}setPollingInterval(e){Fe(e)||(Ne(e)?this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=e:this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=parseInt(e,10))}setPollingIntervalPlus(e){Fe(e)||(Ne(e)?this.DEFAULT_POLLING_INTERVAL_PLUS=e:this.DEFAULT_POLLING_INTERVAL_PLUS=parseInt(e,10))}setPollingNoMessageCount(e){Fe(e)||(Ne(e)?this.DEFAULT_POLLING_NO_MESSAGE_COUNT=e:this.DEFAULT_POLLING_NO_MESSAGE_COUNT=parseInt(e,10))}setPollingSimplifiedMessage(e){Fe(e)||"0"!==e&&"1"!==e||(this.DEFAULT_POLLING_SIMPLIFIED_MSG=parseInt(e,10))}getPollingInterval(){return this._pollingInterval}onAVChatRoomMemberBanned(e){e=e.payload.groupProfile.groupID;at.l(this._n+".onAVChatRoomMemberBanned groupID:"+e),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e)}restartPolling(){at.l(this._n+".restartPolling count:"+this._pollingInstanceMap.size);for(const e of this._pollingInstanceMap.values())e.stop(),e.start()}getPollingTimerID(e){if(!this._pollingInstanceMap.has(e))return-1;var t=this._pollingInstanceMap.get(e).getPollingTimerID();return at.l(this._n+`.getPollingTimerID groupID:${e} timerID:`+t),t}hasPollingInstance(e){return this._pollingInstanceMap.has(e)}onRoomCustomData(e){var{groupID:e,sequence:t,time:s,elements:o}=e,o=o&&o.content;this._get(c).onRoomCustomDataReceived(o),at.l(this._n+`.onRoomCustomData groupID:${e} sequence:${t} time:${s} data:`+o)}reset(e){if(e){at.l(this._n+".reset groupID:"+e);const t=this._pollingInstanceMap.get(e);t&&t.stop(),this._pollingInstanceMap.delete(e),this._joinedGroupMap.delete(e),this._pollingRequestInfoMap.delete(e),this._onlineMemberCountMap.delete(e)}else{at.l(this._n+".reset all");for(const e of this._pollingInstanceMap.values())e.stop();this._pollingInstanceMap.clear(),this._joinedGroupMap.clear(),this._pollingRequestInfoMap.clear(),this._onlineMemberCountMap.clear(),this._broadcastMessageIDMap.clear()}this.sequencesLinkedList.reset(),this.messageIDLinkedList.reset(),this._reportMessageStackedCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=300,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0}}class $o{constructor(e){this.userID="",this.avatar="",this.nick="",this.role="",this.joinTime="",this.lastSendMsgTime="",this.nameCard="",this.muteUntil=0,this.memberCustomField=[],this.isOnline=!1,this.updateMember(e)}updateMember(e){Fe(e.onlineStatus)||(this.isOnline="Online"===e.onlineStatus);var t=[null,void 0,"",0,NaN];e.memberCustomField&&Je(this.memberCustomField,e.memberCustomField),He(this,e,["memberCustomField","marks","onlineStatus"],t)}updateRole(e){["Owner","Admin","Member"].indexOf(e)<0||(this.role=e)}updateMuteUntil(e){Fe(e)||(this.muteUntil=Math.floor((Date.now()+1e3*e)/1e3))}updateNameCard(e){Fe(e)||(this.nameCard=e)}updateMemberCustomField(e){e&&Je(this.memberCustomField,e)}}class Po{constructor(e){this._grpM=e,this._n="GroupMemberHandler",this.groupMemberListMap=new Map,this.DEFAULT_MEMBER_INFO_FILTER=["Role","JoinTime","NameCard","ShutUpUntil","OnlineStatus"],this._grpM.getInnerEmitterInstance().on(Bt.PROFILE_UPDATED,this._onProfileUpdated,this)}_onProfileUpdated({data:t}){for(let e=0;e<t.length;e++){const s=t[e];this.groupMemberListMap.forEach(e=>{e.has(s.userID)&&e.get(s.userID).updateMember({nick:s.nick,avatar:s.avatar})})}}deleteGroupMemberList(e){this.groupMemberListMap.delete(e)}getGroupMemberList({groupID:r,role:e,offset:s=0,count:o=15,filter:h}){const i=this._n+".getGroupMemberList",n=this._grpM.hasLocalGroup(r);if(at.l(i+` groupID:${r} role:${e} offset:${s} count:${o} hasLocalGroup:`+n),!n)return Ht({memberList:[],offset:0});if(this._grpM.getLocalGroupProfile(r).type===pe){if(this._grpM.canIUse(M.AV_MBR_LIST))return this._getAVChatRoomMemberList({groupID:r,offset:s,filter:h});this._grpM.outputWarning("LiveOnlineMember")}let a;e!==me&&e!==ge&&e!==de||(a=e);const g=new Qt("getGroupMemberList");let u=0;const p={groupID:r,limit:100<o?100:o,memberRoleFilter:a?[a]:void 0,memberInfoFilter:this.DEFAULT_MEMBER_INFO_FILTER};Ye({groupID:r})?p.next=""+s:(p.offset=s,u=s+o);let l=[];return this._grpM.req({proto:Ns,data:p}).then(({data:{members:e,memberNum:s,next:o}})=>(Fe(o)||(u=Pe(o)?0:o),Oe(e)&&0!==e.length?(this._grpM.hasLocalGroup(r)&&(this._grpM.getLocalGroupProfile(r).memberNum=s),l=this._updateLocalGroupMemberMap(r,e),this._grpM.get(t).getUserProfile({userIDList:e.map(e=>e.userID),tagList:[Te.NICK,Te.AVATAR]})):(u=0,Promise.resolve([])))).then(e=>{const t=e["data"];if(!Oe(t)||0===t.length)return Ht({memberList:[],offset:u});e=t.map(e=>({userID:e.userID,nick:e.nick,avatar:e.avatar}));return this._updateLocalGroupMemberMap(r,e),l.length<o&&(u=0),g.setMessage(`groupID:${r} offset:${s} count:`+o).end(),at.l(i+" ok."),ut({memberList:l,offset:u})}).catch(e=>(g.setError(e).end(),at.e(i+" failed. error:",e),jt(e)))}_getAVChatRoomMemberList({groupID:o,offset:e,filter:t}){const r=this._n+"._getAVChatRoomMemberList",i=new Qt("_getAVChatRoomMemberList");return i.setMessage(`groupID:${o} offset:${e} filter:`+t),this._grpM.req({proto:qs,data:{groupID:o,offset:e,filter:t}}).then(e=>{const{memberList:t=[],offset:s=0}=e.data;i.end(),at.l(r+` ok. member count:${t.length}, next request timestamp:`+s);e=t.map(e=>({...e,onlineStatus:"Online"})),e=this._updateLocalGroupMemberMap(o,e);return ut({memberList:e,offset:s})}).catch(e=>(i.setError(e).end(),at.e(r+" failed. error:",e),jt(e)))}getGroupMemberProfile(e){var s="getGroupMemberProfile",o=this._n+"."+s;let r="groupID:"+e.groupID;5<e.userIDList.length?r+=" userIDList.length:"+e.userIDList.length:r+=" userIDList:"+e.userIDList,at.l(o+" "+r),50<e.userIDList.length&&(e.userIDList=e.userIDList.slice(0,50));const{groupID:i,userIDList:n}=e,a=this._grpM.getLocalGroupProfile(i);if(a&&Xe(a.type)){const e=vt;return jt({code:e,message:this._grpM.getErrorMessage(e,s)})}const u=new Qt(s);return u.setMessage(r),this._getGroupMemberProfileAdvance({...e,userIDList:n}).then(e=>{const s=e.data["members"];return Oe(s)&&0!==s.length?(this._updateLocalGroupMemberMap(i,s),this._grpM.get(t).getUserProfile({userIDList:s.map(({userID:e})=>e),tagList:[Te.NICK,Te.AVATAR]})):Ht([])}).then(e=>{e=e.data.map(({userID:e,nick:t,avatar:s})=>({userID:e,nick:t,avatar:s})),this._updateLocalGroupMemberMap(i,e),e=n.filter(e=>this.hasLocalGroupMember(i,e)).map(e=>this.getLocalGroupMemberInfo(i,e));return u.end(),ut({memberList:e})})}addGroupMember(i){const n=this._n+".addGroupMember",e=i["groupID"],a=this._grpM.getLocalGroupProfile(e),t=a["type"],u=new Qt("addGroupMember");if(u.setMessage(`groupID:${e} groupType:`+t),Xe(t)){const i=new pt({code:Lt});return u.setError(i).end(),jt(i)}return i.userIDList=i.userIDList.map(e=>({userID:e})),at.l(n+" groupID:"+e),this._grpM.req({proto:Os,data:i}).then(({data:{members:e}})=>{at.l(n+" ok");var t=e.filter(e=>1===e.result).map(e=>e.userID),s=e.filter(e=>0===e.result).map(e=>e.userID),o=e.filter(e=>2===e.result).map(e=>e.userID),e=e.filter(e=>4===e.result).map(e=>e.userID),r=`groupID:${i.groupID}, successUserIDList:${t}, failureUserIDList:${s}, existedUserIDList:${o}, overLimitUserIDList:`+e;return u.setMoreMessage(r).end(),0===t.length?ut({successUserIDList:t,failureUserIDList:s,existedUserIDList:o,overLimitUserIDList:e}):(this._updateConversationGroupProfile(a),ut({successUserIDList:t,failureUserIDList:s,existedUserIDList:o,overLimitUserIDList:e,group:a}))}).catch(e=>(u.setError(e).end(),at.e(n+" failed. error:",e),jt(e)))}deleteGroupMember(e){const t=this._n+".deleteGroupMember",{groupID:s,userIDList:o}=e,r=this._grpM.getLocalGroupProfile(s);if(Fe(r))return jt({code:dt});if(Xe(r.type))return this._grpM.canIUse(M.AV_BAN_MBR)?this._banAVChatRoomMember(e):this._grpM.cannotUseCommercialAbility("deleteGroupMember");var i=`groupID:${s} `+(5<o.length?"userIDList.length:"+o.length:"userIDList:"+o);at.l(t+` groupID:${s} userIDList:`,o);const n=new Qt("deleteGroupMember");return n.setMessage(i),this._grpM.req({proto:Fs,data:e}).then(()=>(n.end(),at.l(t+" ok"),this._updateConversationGroupProfile(r),this.deleteLocalGroupMembers(s,o),ut({group:r,userIDList:o}))).catch(e=>(n.setError(e).end(),at.e(t+" failed. error:",e),jt(e)))}_updateConversationGroupProfile(e){this._grpM.get(o).updateConversationGroupProfile([e])}_banAVChatRoomMember(e){const t=this._n+"._banAVChatRoomMember",{groupID:s,userIDList:o}=e,r=`groupID:${s} `+(5<o.length?"userIDList.length:"+o.length:"userIDList:"+o),i=new Qt("_banAVChatRoomMember"),n=(i.setMessage(r),at.l(t+` groupID:${s} userIDList:`,o),this._grpM.getLocalGroupProfile(s));return Fe(e.duration)||0===e.duration?jt({code:St}):this._grpM.req({proto:xs,data:e}).then(()=>(i.end(),at.l(t+" ok"),this.deleteLocalGroupMembers(s,o),ut({group:n,userIDList:o}))).catch(e=>(i.setError(e).end(),at.e(t+" failed. error:",e),jt(e)))}setGroupMemberMuteTime(e){const{groupID:s,userID:t,muteTime:o}=e,r=this._n+".setGroupMemberMuteTime";if(t===this._grpM.getMyUserID())return jt({code:At});e=`groupID:${s} userID:${t} muteTime:`+o;at.l(r+" "+e);const i=new Qt("setGroupMemberMuteTime");return i.setMessage(e),this.modifyGroupMemberInfo({groupID:s,userID:t,muteTime:o}).then(e=>{i.end(),at.l(r+" ok");var t=this._grpM.getLocalGroupProfile(s);return ut({group:t,member:e})}).catch(e=>(i.setError(e).end(),at.e(r+" failed. error:",e),jt(e)))}setGroupMemberRole(e){const t=this._n+".setGroupMemberRole",{groupID:s,userID:o,role:r}=e,i=`groupID:${s} userID:${o} role:`+r,n=this._grpM.getLocalGroupProfile(s);if(!n||n.type===ne||n.type===pe)return jt({code:Ct});if(n&&n.selfInfo.role!==ge)return jt({code:Gt});const a=[me,de];if(Ye({groupID:s})&&a.push(_e),a.indexOf(r)<0)return jt({code:bt});if(o===this._grpM.getMyUserID())return jt({code:Tt});const u=new Qt("setGroupMemberRole");return u.setMessage(i),at.l(t+" "+i),this.modifyGroupMemberInfo({groupID:s,userID:o,role:r}).then(e=>(u.end(),at.l(t+" ok"),ut({group:n,member:e}))).catch(e=>(u.setError(e).end(),at.e(t+" failed. error:",e),jt(e)))}_filterProfanity(e,t){const s=this._grpM.get(l);if(!s)return!0;var{isAllowedToSend:o,modifiedText:r}=s.filterText(t[e],D);return!0===o&&(t[e]=r,!0)}setGroupMemberNameCard(e){const t="setGroupMemberNameCard",s=this._n+"."+t;if(e.nameCard&&!1===this._filterProfanity("nameCard",e))return jt({code:Et});const{groupID:o,userID:r=this._grpM.getMyUserID(),nameCard:i}=e,n=`groupID:${o} userID:${r} nameCard:`+i;at.l(s+" "+n);e=this._grpM.getLocalGroupProfile(o);if(e&&Xe(e.type)){const e=vt;return jt({code:e,message:this._grpM.getErrorMessage(e,t)})}const a=new Qt(t);return a.setMessage(n),this.modifyGroupMemberInfo({groupID:o,userID:r,nameCard:i}).then(e=>{at.l(s+" ok"),a.end();const t=this._grpM.getLocalGroupProfile(o);return r===this._grpM.getMyUserID()&&t&&t.setSelfNameCard(i),ut({group:t,member:e})}).catch(e=>(a.setError(e).end(),at.e(s+" failed. error:",e),jt(e)))}setGroupMemberCustomField(e){const t="setGroupMemberCustomField",s=this._n+"."+t,{groupID:o,userID:r=this._grpM.getMyUserID(),memberCustomField:i}=e,n=`groupID:${o} userID:${r} memberCustomField:`+JSON.stringify(i);at.l(s+" "+n);e=this._grpM.getLocalGroupProfile(o);if(e&&Xe(e.type)){const e=vt;return jt({code:e,message:this._grpM.getErrorMessage(e,t)})}const a=new Qt(t);return a.setMessage(n),this.modifyGroupMemberInfo({groupID:o,userID:r,memberCustomField:i}).then(e=>{a.end(),at.l(s+" ok");var t=this._grpM.getLocalGroupProfile(o);return ut({group:t,member:e})}).catch(e=>(a.setError(e).end(),at.e(s+" failed. error:",e),jt(e)))}modifyGroupMemberInfo(t){let{groupID:s,userID:o}=t,e=void 0;return Qe(s)&&(s=Ze(e=s)),this._grpM.req({proto:Vs,data:{...t,groupID:s,topicID:e}}).then(()=>{if(this.hasLocalGroupMember(s,o)){const e=this.getLocalGroupMemberInfo(s,o);return Fe(t.muteTime)||e.updateMuteUntil(t.muteTime),Fe(t.role)||e.updateRole(t.role),Fe(t.nameCard)||e.updateNameCard(t.nameCard),Fe(t.memberCustomField)||e.updateMemberCustomField(t.memberCustomField),e}const e=this._grpM.getLocalGroupProfile(s);if(e&&!Xe(e.type))return this.getGroupMemberProfile({groupID:s,userIDList:[o]}).then(({data:{memberList:[e]}})=>e)})}markGroupMemberList(l){const r=this._n+".markGroupMemberList",{groupID:e,markType:t,enableMark:s,userIDList:i=[]}=l,o=`groupID:${e} markType:${t} enableMark:${s} userIDList count:`+i.length;at.l(r+" "+o);let n=2;const a=[];!0===s&&(n=1);let u=[...i];500<i.length&&(u=i.slice(0,500),at.w(r+" "+"the length of userIDList cannot exceed 500")),u.forEach(e=>{a.push({userID:e,markType:[t]})}),u=null;const p=new Qt("markGroupMemberList");return p.setMessage(o),this._grpM.req({proto:Hs,data:{groupID:e,operationType:n,memberList:a}}).then(e=>{const{memberList:t=[]}=e.data,s=[],o=[];t.length===i.length?s.push(...i):(t.forEach(e=>{s.push(e.userID)}),i.forEach(e=>{s.includes(e)||o.push(e)}));e=`success count:${s.length} fail count:`+o.length;return p.setMessage(e).end(),at.l(r+" ok. "+e),ut({successUserIDList:s,failureUserIDList:o})}).catch(e=>(p.setError(e).end(),at.e(r+" failed. error:",e),jt(e)))}_getGroupMemberProfileAdvance(e){return this._grpM.req({proto:ks,data:{...e,memberInfoFilter:e.memberInfoFilter||this.DEFAULT_MEMBER_INFO_FILTER}})}_updateLocalGroupMemberMap(t,e){return Oe(e)&&0!==e.length?e.map(e=>(this.hasLocalGroupMember(t,e.userID)?this.getLocalGroupMemberInfo(t,e.userID).updateMember(e):this.setLocalGroupMember(t,new $o(e)),this.getLocalGroupMemberInfo(t,e.userID))):[]}deleteLocalGroupMembers(e,t){const s=this.groupMemberListMap.get(e);s&&t.forEach(e=>{s.delete(e)})}getLocalGroupMemberInfo(e,t){return this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).get(t):null}setLocalGroupMember(e,t){this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).set(t.userID,t):(t=(new Map).set(t.userID,t),this.groupMemberListMap.set(e,t))}getLocalGroupMemberList(e){return this.groupMemberListMap.get(e)}hasLocalGroupMember(e,t){return this.groupMemberListMap.has(e)&&this.groupMemberListMap.get(e).has(t)}hasLocalGroupMemberMap(e){return this.groupMemberListMap.has(e)}reset(){this.groupMemberListMap.clear()}}function Eo(e){var t=e.lastIndexOf(".");return-1===t?e:e.slice(0,t)}function wo(e){var{androidInfo:e={},androidOPPOChannelID:t=""}=e,t=e.OPPOChannelID||t;return{...e,Sound:Eo(e.sound||""),OPPOChannelID:t,GoogleChannelID:e.FCMChannelID||""}}function Uo(e){var{apnsInfo:e={},ignoreIOSBadge:t=!1,disableVoipPush:s}=e,t=!0===e.ignoreIOSBadge||!0===t?1:0;let o=void 0;return Fe(s)||(o=!1===s?1:0),Fe(e.disableVoipPush)||(o=!1===e.disableVoipPush?1:0),{...e,badgeMode:t,isVoipPush:o}}function No(e){if(ke(e))return{pushFlag:!0===e.disablePush?1:0,title:e.title||"",desc:e.description||"",ext:e.extension||"",apnsInfo:Uo(e),androidInfo:wo(e)}}const qo=1,ko=15;class Oo{constructor(e){this._grpM=e,this._n="GroupSystemNoticeHandler",this.pendencyMap=new Map}onNewGroupSystemNotice(e){var{dataList:e,isSyncingEnded:t,isInstantMessage:s}=e,{eventDataList:e,result:r}=(at.d(this._n+".onReceiveSystemNotice count:"+e.length),this.newSystemNoticeStoredAndSummary({notifiesList:e,isInstantMessage:s}));0<e.length&&(this._grpM.get(o).onNewMessage({conversationOptionsList:e,isInstantMessage:s}),this._onReceivedGroupSystemNotice({result:r,isInstantMessage:s})),s?0<r.length&&this._grpM.emitOuterEvent(wt,r):!0===t&&this._clearGroupSystemNotice()}newSystemNoticeStoredAndSummary({notifiesList:e,isInstantMessage:h}){let t=null;const s=e.length;let r=0;const i=[],n={conversationID:ie,unreadCount:0,type:ie,subType:null,lastMessage:null};for(r=0;r<s;r++){const s=e[r],{groupProfile:{communityType:a=0,topicID:u},elements:{topicIDList:p,operationType:l}}=s;if(!(2!==a||Pe(u)&&Pe(p))){if([17,18,20].includes(l)){this._handleTopicSystemNotice(s);continue}Pe(u)||(s.to=u)}s.elements.operationType!==ko&&(s.currentUser=this._grpM.getMyUserID(),s.conversationType=ie,s.conversationID=ie,(t=new lo(s)).setElement({type:z,content:{...s.elements,groupProfile:{...s.groupProfile}}}),t.isSystemMessage=!0,(1===t.sequence&&1===t.random||2===t.sequence&&2===t.random)&&(t.sequence=je(),t.random=je(),t.generateMessageID(),at.l(this._n+".newSystemNoticeStoredAndSummary sequence and random maybe duplicated, regenerate. ID:"+t.ID)),this._grpM.get(o).pushIntoNoticeResult(i,t)&&(h?n.unreadCount++:t.setIsRead(!0),n.subType=t.conversationSubType))}return n.lastMessage=i[i.length-1],{eventDataList:0<i.length?[n]:[],result:i}}_clearGroupSystemNotice(){this._getPendencyList().then(e=>{e.forEach(e=>{this.pendencyMap.set(`${e.from}_${e.groupID}_`+e.to,e)});const t=this._grpM.get(o).getLocalMessageList(ie),i=[];t.forEach(e=>{const{operatorID:t,operationType:s,groupProfile:o}=e.payload;if(s===qo){const s=`${t}_${o.groupID}_`+o.to,r=this.pendencyMap.get(s);r&&Ne(r.handled)&&0!==r.handled&&i.push(e)}}),this.deleteGroupSystemNotice({messageList:i})})}deleteGroupSystemNotice(e){const s=this._n+".deleteGroupSystemNotice";return Oe(e.messageList)&&0!==e.messageList.length?(at.l(s+" "+e.messageList.map(e=>e.ID)),this._grpM.req({proto:Ds,data:{messageListToDelete:e.messageList.map(e=>({from:ie,messageSeq:e.clientSequence,messageRandom:e.random}))}}).then(()=>{at.l(s+" ok");const t=this._grpM.get(o);return e.messageList.forEach(e=>{t.deleteLocalMessage(e)}),ut()}).catch(e=>(at.e(s+" error:",e),jt(e)))):Ht()}_getPendencyList(e={}){var{type:e,startTime:t=0,limit:s=20}=e;return this._grpM.req({proto:Is,data:{type:e,startTime:t,limit:s,handleAccount:this._grpM.getMyUserID()}}).then(e=>{const t=e.data.pendencyList;return 0!==e.data.nextStartTime?this._getPendencyList({startTime:e.data.nextStartTime}).then(e=>[...t,...e]):t})}getGroupApplicationList(){return this._getPendencyList().then(t=>this._getPendencyList({type:le}).then(e=>(t.push(...e),this._handlePendencyResult(t))).catch(e=>this._handlePendencyResult(t)))}_handlePendencyResult(e){const t=[];return e.forEach(e=>{this.pendencyMap.set(`${e.from}_${e.groupID}_`+e.to,e),0===e.handled&&t.push({applicant:e.from,applicantNick:e.fromUserNickName,groupName:e.groupName,groupID:e.groupID,authentication:e.authentication,messageKey:e.time,applicationType:e.applicationType,userID:e.userID,note:e.note})}),Ht({applicationList:t})}_onReceivedGroupSystemNotice({result:e,isInstantMessage:t}){t&&e.forEach(e=>{switch(e.payload.operationType){case 1:break;case 2:this._onApplyJoinGroup(e);break;case 3:break;case 4:this._onMemberKicked(e);break;case 5:this._onGroupDismissed(e);break;case 6:break;case 7:this._onInviteGroup(e);break;case 8:this._onQuitGroup(e);break;case 9:this._onSetManager(e);break;case 10:this._onDeleteManager(e);break;case 11:case 12:case 15:break;case 20:this._onMessageRemindTypeSynced(e);break;case 21:this._grpM.onAVChatRoomMemberBanned(e)}})}_onApplyJoinGroup(e){var{groupID:e,groupType:t}=e.payload.groupProfile,s=this._grpM.hasLocalGroup(e);at.l(this._n+`._onApplyJoinGroup groupID:${e} groupType:${t} hasGroup:`+s),s||Xe(t)||this._grpM.getGroupProfile({groupID:e}).then(({data:{group:e}})=>{e&&(this._grpM.updateGroupMap([e]),e=!e.isSupportTopic,this._grpM.emitGroupListUpdate(!0,e))})}_onMemberKicked(e){e=e.payload.groupProfile.groupID;this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e)}_onGroupDismissed(e){e=e.payload.groupProfile.groupID;this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e);const t=this._grpM["_AVChatRoomHandler"];t&&t.checkJoinedAVChatRoomByID(e)&&t.reset(e)}_onInviteGroup(e){const t=e.payload.groupProfile.groupID,s=this._grpM.hasLocalGroup(t);at.l(`${this._n}._onInviteGroup groupID:${t} hasGroup:`+s),this._grpM.getGroupProfile({groupID:t}).then(()=>{this._grpM.emitGroupListUpdate(),this._grpM.get(o).recoverMessageOnInviteGroup(""+oe+t)})}_onQuitGroup(e){var{groupID:e,groupType:t}=e.payload.groupProfile,s=this._grpM.hasLocalGroup(e);at.l(this._n+`._onQuitGroup groupID:${e} groupType:${t} hasGroup:`+s),s&&this._grpM.deleteLocalGroupAndConversation(e)}_onSetManager(e){const{to:t,groupID:s}=e.payload.groupProfile,o=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(s,t);o&&o.updateRole(me)}_onDeleteManager(e){const{to:t,groupID:s}=e.payload.groupProfile,o=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(s,t);o&&o.updateRole(de)}_onMessageRemindTypeSynced(e){var t=e.payload.groupProfile["groupID"],e=e.payload.messageRemindType;this._grpM.get(o).onGroupMessageRemindTypeUpdated({groupID:t,messageRemindType:e})}_handleTopicSystemNotice(e){const{groupProfile:{groupID:t,topicID:o},elements:{operationType:r,topicIDList:i,messageRemindType:n}}=e,a=this._grpM.get(s);17===r?a.onTopicCreated({groupID:t,topicID:o}):18===r?a.onTopicDeleted({groupID:t,topicIDList:i}):20===r&&a.onTopicMessageRemindTypeUpdated({groupID:t,topicID:o,messageRemindType:n})}reset(){this.pendencyMap.clear()}}class Fo extends class{constructor(e){this._m=e,this._n=""}isLoggedIn(){return this._m.get(r).isLoggedIn()}isOversea(){return this._m.get(r).isOversea()}isPrivateNetWork(){return this._m.get(r).isPrivateNetWork()}getFileDownloadProxy(){return this._m.get(r).getFileDownloadProxy()}getMyUserID(){return this._m.get(r).getUserID()}getMyTinyID(){return this._m.get(r).getTinyID()}getSDKAppID(){return this._m.get(r).getSDKAppID()}isIntl(){return this._m.get(r).isIntl()}isUsingChatCore(){return this._m.get(r).isUsingChatCore()}isDevMode(){return this._m.get(r).isDevMode()}get(e){return this._m.get(e)}getPlatform(){return E}getCloudConfig(e){return this._m.get(a).getCloudConfig(e)}emitOuterEvent(e,t){this._m.getOuterEmitterInstance().emit(e,t)}emitInnerEvent(e,t){this._m.getInnerEmitterInstance().emit(e,t)}getInnerEmitterInstance(){return this._m.getInnerEmitterInstance()}generateTjgID(e){return this._m.get(r).getTinyID()+"-"+e.random}req(e){return this._m.get(n).req(e)}canIUse(e){return this._m.get(p).canIUse(e)}getErrorMessage(e,t,s){return this._m.getErrorMessage(e,t,s)}outputWarning(e,t,s){e=this.getErrorMessage(e,t,s);e&&at.w(e)}cannotUseCommercialAbility(e){var t=Pt;return jt({code:t,message:this.getErrorMessage(t,e)})}}{constructor(e){super(e),this._n="GroupModule",this._commonGroupHandler=new ho(this),this._groupAttributesHandler=new Io(this),this._groupCountersHandler=new Go(this),this._AVChatRoomHandler=new Ro(this),this._groupTipsHandler=new co(this),this._groupSystemNoticeHandler=new Oo(this),this._groupMemberHandler=new Po(this),this.groupMap=new Map,this._unjoinedAVChatRoomList=new Map,this._receiptDetailCompleteMap=new Map,this._onlineMemberCountMap=new Map,this._timeoutIDs=[],this.getInnerEmitterInstance().on(Bt.CLOUD_CONFIG_UPDATED,this._onCloudConfigUpdated,this)}_onCloudConfigUpdated(){var e=this.getCloudConfig("polling_interval"),t=this.getCloudConfig("polling_interval_plus"),s=this.getCloudConfig("polling_no_msg_count"),o=this.getCloudConfig("polling_simplified_msg"),r=this.getCloudConfig("paging_grp_count");at.l(this._n+`._onCloudConfigUpdated pollingInterval:${e} pollingIntervalPlus:${t} pollingNoMessageCount:${s} pollingSimplifiedMessage:${o} pagingGroupCount:`+r),this._AVChatRoomHandler.setPollingInterval(e),this._AVChatRoomHandler.setPollingIntervalPlus(t),this._AVChatRoomHandler.setPollingNoMessageCount(s),this._AVChatRoomHandler.setPollingSimplifiedMessage(o),this._commonGroupHandler.setPagingGroupCount(r)}onCheckTimer(e){this.isLoggedIn()&&(this._commonGroupHandler.onCheckTimer(e),this._groupTipsHandler.onCheckTimer(e))}guardForAVChatRoom(t){if(t.conversationType!==oe)return Ht();{const s=Qe(t.to)?Ze(t.to):t.to;return this.hasLocalGroup(s)?Ht():this.getGroupProfile({groupID:s}).then(e=>{e=e.data.group.type;if(at.l(`${this._n}.guardForAVChatRoom. groupID:${s} type:`+e),e!==pe)return Ht();{const e=lt;return jt(new pt({code:e,message:this.getErrorMessage(e,t.from,s),data:{message:t}}))}})}}checkJoinedAVChatRoomByID(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}onNewGroupMessage(e){this._commonGroupHandler.onNewGroupMessage(e)}updateNextMessageSeq(e){if(Oe(e)){const o=this.get(s);e.forEach(e=>{var t=e.conversationID.replace(oe,"");Qe(t)&&o.updateLastMessage(t,e.lastMessage),this.groupMap.has(t)&&(this.groupMap.get(t).nextMessageSeq=e.lastMessage.sequence+1)})}}onNewGroupTips(e){this._groupTipsHandler.onNewGroupTips(e)}onGroupMessageRevoked(e){this._commonGroupHandler.onGroupMessageRevoked(e)}onNewGroupSystemNotice(e){this._groupSystemNoticeHandler.onNewGroupSystemNotice(e)}onGroupMessageReadNotice(e){e.dataList.forEach(i=>{const e=i.elements["groupMessageReadNotice"];if(!Fe(e)){const i=this.get(o);e.forEach(e=>{var{groupID:e,topicID:t,lastMessageSeq:s}=e;at.d(this._n+`.onGroupMessageReadNotice groupID:${e} lastMessageSeq:`+s);let o=""+oe+e,r=!0;Pe(t)||(o=""+oe+t,r=!1),i.updateIsReadAfterReadReport({conversationID:o,lastMessageSeq:s}),i.updateUnreadCount(o,r),i.clearGroupAtInfoList(o,r)})}})}onReadReceiptList(e){at.d(this._n+".onReadReceiptList options:",JSON.stringify(e)),e.dataList.forEach(e=>{const{groupProfile:t,elements:s}=e,r=t["groupID"],i=this.get(o),n=s["readReceiptList"];i.updateReadReceiptInfo({groupID:r,readReceiptList:n})})}onGroupMessageModified(e){at.d(this._n+".onGroupMessageModified options:",JSON.stringify(e));const t=this.get(o);e.dataList.forEach(e=>{t.onMessageModified({...e,conversationType:oe,to:e.topicID||e.groupID})})}deleteGroupSystemNotice(e){this._groupSystemNoticeHandler.deleteGroupSystemNotice(e)}initGroupMap(e){this.groupMap.set(e.groupID,new So(e))}clearGroupMap(){this.groupMap.clear()}deleteGroup(e){this.groupMap.delete(e)}updateGroupMap(e){const t=this.get(o);let s;e.forEach(e=>{s=e.groupID,this.groupMap.has(s)?this.groupMap.get(s).updateGroup(e):(this.groupMap.set(s,new So(e)),t.deleteGroupRoamingMessageInfo(s))});var r=this.getMyUserID();for(const[,o]of this.groupMap)o.selfInfo.userID=r,"Owner"===o.selfInfo.role&&(o.ownerID=r)}getGroupMap(){return this.groupMap}getLocalGroupList(){return[...this.groupMap.values()].filter(e=>e.type!==ce&&e.type!==he)}getLocalGroupProfile(e){return this.groupMap.get(e)}sortLocalGroupList(){const e=[...this.groupMap].filter(([,e])=>!Pe(e.lastMessage));e.sort((e,t)=>t[1].lastMessage.lastTime-e[1].lastMessage.lastTime),this.groupMap=new Map([...e])}updateGroupLastMessage(e){this._commonGroupHandler.handleUpdateGroupLastMessage(e)}emitGroupListUpdate(e=!0,t=!0){var s=this.getLocalGroupList();if(e&&this.emitOuterEvent(qt),t){const e=JSON.parse(JSON.stringify(s));this.get(o).updateConversationGroupProfile(e)}}getMyNameCardByGroupID(e){e=this.getLocalGroupProfile(e);return e?e.selfInfo.nameCard:""}isPagingGetCompleted(){return this._commonGroupHandler.isPagingGetCompleted()}getMessageRemindType(e){!Oe(e)||0===e.length||0!==(e=e.filter(e=>!Xe(this.getLocalGroupProfile(e).type))).length&&(at.l(this._n+".getMessageRemindType groupIDList:"+e),this.getGroupProfileAdvance({groupIDList:e,responseFilter:{memberInfoFilter:["MsgFlag"]}}).then(e=>{const t=e.data["successGroupList"],s=this.get(o);t.forEach(e=>{s.onGroupMessageRemindTypeUpdated({groupID:e.groupID,messageRemindType:Oe(e.members)?e.members[0].messageRemindType:""})})}))}getGroupList(){return this._commonGroupHandler.getGroupList()}syncCommunityWithTopic(){return this._commonGroupHandler.syncGroupList(!0)}getGroupProfile(t){const r=this._n+".getGroupProfile",i=new Qt("getGroupProfile"),{groupID:n,groupCustomFieldFilter:e}=t;at.l(r+" groupID:"+n);var s={groupIDList:[n],responseFilter:{groupBaseInfoFilter:["Type","Name","Introduction","Notification","FaceUrl","Owner_Account","CreateTime","InfoSeq","LastInfoTime","LastMsgTime","MemberNum","MaxMemberNum","ApplyJoinOption","NextMsgSeq","ShutUpAllMember","InviteJoinOption"],groupCustomFieldFilter:e,memberInfoFilter:["Role","JoinTime","MsgSeq","MsgFlag","NameCard"]}};return this.getGroupProfileAdvance(s).then(({data:{successGroupList:e,failureGroupList:t}})=>{if(at.l(r+" ok"),0<t.length)return jt(t[0]);let s;return(s=Xe(e[0].type)&&!this.hasLocalGroup(n)?new So(e[0]):(this.updateGroupMap(e),this.getLocalGroupProfile(n))).isSupportTopic||this.get(o).updateConversationGroupProfile([s]),i.setMessage(`groupID:${n} type:${s.type} muteAllMembers:${s.muteAllMembers} ownerID:`+s.ownerID).end(),ut({group:s})}).catch(e=>(i.setError(e).setMessage("groupID:"+t.groupID).end(),at.e(r+" failed. error:",e),jt(e)))}getGroupProfileAdvance(e){const t=this._n+".getGroupProfileAdvance",s=e["groupIDList"],o=(Oe(s)&&50<s.length&&(this.outputWarning("GetGroupProfileLimit"),s.length=50),[]),r=[],i=(s.forEach(e=>{(Ye({groupID:e})?r:o).push(e)}),[]);if(0<o.length){const t=this._getGroupProfileAdvance({...e,groupIDList:o});i.push(t)}if(0<r.length){const t=this._getGroupProfileAdvance({...e,groupIDList:r,relayFlag:0<o.length});i.push(t)}return Promise.all(i).then(e=>{const t=[],s=[];return e.forEach(e=>{t.push(...e.successGroupList),s.push(...e.failureGroupList)}),ut({successGroupList:t,failureGroupList:s})}).catch(e=>(at.e(t+" failed. error:",e),jt(e)))}_getGroupProfileAdvance(t){const{relayFlag:s=!1,...o}=t;return this.req({proto:ts,data:o}).then(e=>{at.l(this._n+"._getGroupProfileAdvance ok. options:",o);const t=e.data["groups"];return{successGroupList:t.filter(e=>Fe(e.errorCode)||0===e.errorCode),failureGroupList:t.filter(e=>e.errorCode&&0!==e.errorCode).map(e=>new pt({code:e.errorCode,message:e.errorInfo,data:{groupID:e.groupID}}))}}).catch(e=>s&&Ye({groupID:t.groupIDList[0]})?{successGroupList:[],failureGroupList:[]}:jt(e))}createGroup(u){const s=[ae,ne,ue,pe,le],p=this._n+".createGroup",{type:o,groupID:r}=u;if(u.name&&!1===this._filterProfanity("name",u))return jt({code:Et});if(u.introduction&&!1===this._filterProfanity("introduction",u))return jt({code:Et});if(u.notification&&!1===this._filterProfanity("notification",u))return jt({code:Et});if(!s.includes(o))return jt({code:ht});if(!Ye({type:o})){if(!Pe(r)&&Ye({groupID:r}))return jt({code:mt});u.isSupportTopic=void 0}if(Xe(o)&&!Fe(u.memberList)&&0<u.memberList.length&&(u.memberList=void 0),this._canIUseJoinOption(o)||Fe(u.joinOption)||(u.joinOption=void 0),Ye({type:o})){if(!Pe(r)&&!Ye({groupID:r}))return jt({code:mt});u.isSupportTopic=!0===u.isSupportTopic?1:0}const l=new Qt("createGroup");at.l(p+" options:",u);let h=null,g=[];return this.req({proto:ss,data:{...u,ownerID:this.getMyUserID(),webPushFlag:1}}).then(s=>{const{groupID:o,overLimitUserIDList:r=[]}=s.data;h=o,g=r;s=`groupType:${u.type} groupID:${o} overLimitUserIDList:`+r;if(l.setMessage(s).end(),at.l(p+" ok. "+s),u.type===pe)return this.getGroupProfile({groupID:o});if(u.type===le&&1===u.isSupportTopic)return this.getGroupProfile({groupID:o});Pe(u.memberList)||Pe(r)||(u.memberList=u.memberList.filter(e=>-1===r.indexOf(e.userID))),this.updateGroupMap([{...u,groupID:o}]);const i=this.get(e);let n="",a=0;u.type===le?(n=this.isIntl()?"Create Community":"创建社群",a=1):n=this.isIntl()?"Create Group":"创建群组";s=this.get(t).getMyNick(),s=i.createCustomMessage({to:o,conversationType:oe,payload:{data:JSON.stringify({businessID:"group_create",content:n,cmd:a,opUser:s||this.getMyUserID(),version:4})}});return i.sendMessageInstance(s),this.emitGroupListUpdate(),this.getGroupProfile({groupID:o})}).then(e=>{const t=e.data["group"],{nameCard:s,joinTime:o}=t.selfInfo;return t.updateSelfInfo({nameCard:s,joinTime:o,messageRemindType:Le,role:ge}),ut({group:t,overLimitUserIDList:g})}).catch(e=>{if(l.setMessage("groupType:"+u.type).setError(e).end(),10010!==e.code&&10007!==e.code)return at.e(p+" failed. error:",e),jt(e);{this._silentlyGetGroupProfile(e.code,h),this.updateGroupMap([{...u,groupID:h}]);const t=this.getLocalGroupProfile(h);return t.selfInfo.role=ge,ut({group:t,overLimitUserIDList:g})}})}dismissGroup(e){const t=this._n+".dismissGroup",s="groupID:"+e;if(this.hasLocalGroup(e)&&this.getLocalGroupProfile(e).type===ne)return jt(new pt({code:Mt}));const o=new Qt("dismissGroup");return o.setMessage(s),at.l(t+" "+s),this.req({proto:os,data:{groupID:e}}).then(()=>(o.end(),at.l(t+" ok"),this.deleteLocalGroupAndConversation(e),this.checkJoinedAVChatRoomByID(e)&&this._AVChatRoomHandler.reset(e),this._groupAttributesHandler.deleteLocalGroupAttributes(e),ut({groupID:e}))).catch(e=>(o.setError(e).end(),at.e(t+" failed. error:",e),jt(e)))}updateGroupProfile(e){const t=this._n+".updateGroupProfile";if(this.hasLocalGroup(e.groupID)){const s=this.getLocalGroupProfile(e.groupID).type;this._canIUseJoinOption(s)||Fe(e.joinOption)||(at.w(t+" joinOption is unavailable for Work/Meeting/AVChatRoom"),e.joinOption=void 0)}if(Fe(e.muteAllMembers)||(e.muteAllMembers?e.muteAllMembers="On":e.muteAllMembers="Off"),e.name&&!1===this._filterProfanity("name",e))return jt({code:Et});if(e.introduction&&!1===this._filterProfanity("introduction",e))return jt({code:Et});if(e.notification&&!1===this._filterProfanity("notification",e))return jt({code:Et});const s=new Qt("updateGroupProfile");return s.setMessage(JSON.stringify(e)),at.l(t+" groupID:"+e.groupID),this.req({proto:rs,data:e}).then(()=>(s.end(),at.l(t+" ok"),this.hasLocalGroup(e.groupID)&&this.groupMap.get(e.groupID).updateGroup(e),ut({group:this.groupMap.get(e.groupID)}))).catch(e=>(s.setError(e).end(),at.l(t+" failed. error:",e),jt(e)))}_filterProfanity(e,t){const s=this.get(l);if(!s)return!0;var{isAllowedToSend:o,modifiedText:r}=s.filterText(t[e],I);return!0===o&&(t[e]=r,!0)}joinGroup(t){const{groupID:s,type:o}=t,r=this._n+".joinGroup";if(o===ne)return jt({code:gt});if(this.deleteUnjoinedAVChatRoom(s),this.hasLocalGroup(s)){if(!this.isLoggedIn())return Ht({status:ye});const o=new Qt("applyJoinGroup");return this.getGroupProfile({groupID:s}).then(()=>(o.setMessage(`groupID:${s} joinedStatus:`+ye).end(),Ht({status:ye}))).catch(e=>(o.setMessage(`groupID:${s} unjoined`).end(),at.w(r+` ${s} was unjoined, now join!`),this.groupMap.delete(s),this.applyJoinGroup(t)))}return at.l(r+" groupID:"+s),this.isLoggedIn()?this.applyJoinGroup(t):this._AVChatRoomHandler.joinWithoutAuth(t)}applyJoinGroup(e){const a=this._n+".applyJoinGroup",{groupID:u,applyMessage:t}=e;if(!Pe(t)&&!1===this._filterProfanity("applyMessage",e))return jt({code:Et});const p=new Qt("applyJoinGroup"),s={...e},l=this.canIUse(M.AV_HISTORY_MSG);return l&&(s.historyMessageFlag=1),this.get(o).deleteTopicRoamingMessageInfo(u),this.req({proto:is,data:s}).then(({data:{joinedStatus:e,longPollingKey:t,startSeq:s,avChatRoomFlag:o,avChatRoomKey:r,messageList:i}})=>{var n=`groupID:${u} joinedStatus:${e} longPollingKey:${t} startSeq:${s} avChatRoomFlag:${o} canGetAVChatRoomHistoryMessage:${l}, history message count:`+(Pe(i)?0:i.length);switch(p.setMessage(n).end(),at.l(a+" ok. "+n),e){case Se:return ut({status:Se});case Ae:return this.getGroupProfile({groupID:u}).then(({data:{group:e}})=>this._handleJoinResult({group:e,avChatRoomFlag:o,longPollingKey:t,startSeq:s,avChatRoomKey:r,messageList:i})).catch(e=>{if(10010!==e.code&&10007!==e.code)return at.e(a+" failed. error:",e),jt(e);{this._silentlyGetGroupProfile(e.code,u);const a=new So({groupID:u});return this.updateGroupMap([a]),this._handleJoinResult({group:a,avChatRoomFlag:o,longPollingKey:t,startSeq:s,avChatRoomKey:r,messageList:i})}});default:{const e=new pt({code:Dt});return at.e(a+" failed. error:",e),jt(e)}}}).catch(e=>(p.setMessage("groupID:"+u).setError(e).end(),at.e(a+" failed. error:",e),jt(e)))}_handleJoinResult(e){const{group:t,avChatRoomFlag:s,longPollingKey:r,startSeq:i,avChatRoomKey:n,messageList:a}=e,u=t["groupID"];if(1!==s)return this.emitGroupListUpdate(!0,!1),ut({status:Ae,group:t});{let e;return this.get(o).setCompleted(""+oe+u),this._groupAttributesHandler.initGroupAttributesCache({groupID:u,avChatRoomKey:n}),this._groupCountersHandler.initGroupCountersCache({groupID:u,avChatRoomKey:n}),(e=Fe(r)?this._AVChatRoomHandler.handleJoinResult({group:t}):this._AVChatRoomHandler.startRunLoop({group:t,longPollingKey:r,startSeq:i})).then(()=>{this._onAVChatRoomHistoryMessage(a,u)}),e}}quitGroup(e){const t=this._n+".quitGroup",s="groupID:"+e,o=(at.l(t+" "+s),this.checkJoinedAVChatRoomByID(e));if(!o&&!this.hasLocalGroup(e))return jt({code:It});if(o&&!this.isLoggedIn())return at.l(t+" anonymously ok. "+s),this.deleteLocalGroupAndConversation(e),this._AVChatRoomHandler.reset(e),Ht({groupID:e});const r=new Qt("quitGroup");return r.setMessage(s),this.req({proto:as,data:{groupID:e}}).then(()=>(r.end(),at.l(t+" ok"),this.deleteLocalGroupAndConversation(e),o&&this._AVChatRoomHandler.reset(e),this._groupAttributesHandler.deleteLocalGroupAttributes(e),ut({groupID:e}))).catch(e=>(r.setError(e).end(),at.e(t+" failed. error:",e),jt(e)))}searchGroupByID(e){const t=this._n+".searchGroupByID",s={groupIDList:[e]},o=new Qt("searchGroupByID");return o.setMessage("groupID:"+e),at.l(t+" groupID:"+e),this.req({proto:us,data:s}).then(({data:{groupProfile:e}})=>{if(0!==e[0].errorCode)throw new pt({code:e[0].errorCode,message:e[0].errorInfo});return o.end(),at.l(t+" ok"),ut({group:new So(e[0])})}).catch(e=>(o.setError(e).end(),at.w(t+" failed. error:",e),jt(e)))}changeGroupOwner(o){const r=this._n+".changeGroupOwner";if(this.hasLocalGroup(o.groupID)&&this.getLocalGroupProfile(o.groupID).type===pe)return jt({code:_t});if(o.newOwnerID===this.getMyUserID())return jt({code:ft});const i=new Qt("changeGroupOwner");return i.setMessage(`groupID:${o.groupID} newOwnerID:`+o.newOwnerID),at.l(r+" groupID:"+o.groupID),this.req({proto:ps,data:o}).then(()=>{i.end(),at.l(r+" ok");var{groupID:e,newOwnerID:t}=o;this.groupMap.get(e).ownerID=t;const s=this._groupMemberHandler.getLocalGroupMemberList(e);if(s instanceof Map){const o=s.get(this.getMyUserID()),r=(Fe(o)||(o.updateRole("Member"),this.groupMap.get(e).selfInfo.role="Member"),s.get(t));Fe(r)||r.updateRole("Owner")}return this.emitGroupListUpdate(!0,!1),ut({group:this.groupMap.get(e)})}).catch(e=>(i.setError(e).end(),at.e(r+" failed. error:",e),jt(e)))}getGroupApplicationList(){return this._groupSystemNoticeHandler.getGroupApplicationList()}handleGroupApplication(e){const t=this._n+".handleGroupApplication",{handleAction:l,handleMessage:h,message:s,application:o}=e;let r,i,n,a,u,g=(s?(r=s.payload.operatorID,i=s.payload.groupProfile.groupID,n=s.payload.authentication,a=s.payload.messageKey):o&&(r=o.applicant,i=o.groupID,n=o.authentication,a=o.messageKey),ls);o&&2===o.applicationType&&(g=cs,u=o.userID);const p=new Qt("handleGroupApplication");return p.setMessage("groupID:"+i),at.l(t+" groupID:"+i),this.req({proto:g,data:{handleAction:l,handleMessage:h,applicant:r,invitee:u,groupID:i,authentication:n,messageKey:a}}).then(()=>(p.end(),at.l(t+" ok"),s&&this._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),ut({group:this.getLocalGroupProfile(i)}))).catch(e=>(p.setError(e).end(),at.e(t+" failed. error",e),jt(e)))}handleGroupInvitation(e){const t=this._n+".handleGroupInvitation",{groupProfile:{groupID:s},authentication:o,messageKey:r,operatorID:i}=e.message.payload,n=e["handleAction"],a=new Qt("handleGroupInvitation");return a.setMessage(`groupID:${s} inviter:${i} handleAction:`+n),at.l(t+` groupID:${s} inviter:${i} handleAction:`+n),this.req({proto:hs,data:{...e,inviter:i,groupID:s,authentication:o,messageKey:r}}).then(()=>(a.end(),at.l(t+" ok"),this._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),ut({group:this.getLocalGroupProfile(s)}))).catch(e=>(a.setError(e).end(),at.e(t+" failed. error",e),jt(e)))}getGroupOnlineMemberCount(t){const s=this._n+".getGroupOnlineMemberCount",e=this._AVChatRoomHandler.checkJoinedAVChatRoomByID(t),o=this.hasLocalGroup(t);if(at.l(s+` groupID:${t} isAVChatRoom:${e} has:`+o),e)return this._AVChatRoomHandler.getGroupOnlineMemberCount(t);if(!o)return Ht({memberCount:0});var r=Date.now();if(this._onlineMemberCountMap.has(t)){const s=this._onlineMemberCountMap.get(t);if(r-s.lastReqTime<=6e4)return Ht({memberCount:s.memberCount});s.lastReqTime=r}return this.requestOnlineCount(t).then(e=>{var{memberCount:e=0}=e.data;return this._onlineMemberCountMap.set(t,{lastReqTime:Date.now(),memberCount:e}),at.l(s+` ok. groupID:${t} memberCount:`+e),Ht({memberCount:e})}).catch(e=>(at.w(s+" failed. error:",e),Promise.reject(e)))}requestOnlineCount(e){return this.req({proto:Gs,data:{groupID:e}})}hasLocalGroup(e){return this.groupMap.has(e)}deleteLocalGroupAndConversation(e){const t=this.checkJoinedAVChatRoomByID(e),r=(at.l(this._n+`.deleteLocalGroupAndConversation groupID:${e} isJoinedAVChatRoom:`+t),this.get(o)),i=""+oe+e;if(t&&r.deleteLocalConversation(i),Ye({groupID:e})){const t=this.getLocalGroupProfile(e);t&&!0===t.isSupportTopic&&this.get(s).deleteTopicListInCommunity(e)}r.clearUnreadCount(i),this._deleteLocalGroup(e),this._onlineMemberCountMap.delete(e),this.emitGroupListUpdate(!0,!1)}_deleteLocalGroup(e){this.groupMap.delete(e),this._groupMemberHandler.deleteGroupMemberList(e)}sendMessage(e,t){if(Oe(e._receiverList)&&0<e._receiverList.length&&!this.canIUse(M.MSG_TO_SPECIFIED_GRP_MBR))return this.cannotUseCommercialAbility("group direct messages");e=this.createGroupMessagePack(e,t);return this.req(e)}createGroupMessagePack(e,t){let s=null,o=(t&&t.offlinePushInfo&&(s=t.offlinePushInfo),"");qe(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData);const r=[];if(ke(t)&&ke(t.messageControlInfo)){const{excludedFromUnreadCount:e,excludedFromLastMessage:s,excludedFromContentModeration:o}=t.messageControlInfo;!0===e&&r.push("NoUnread"),!0===s&&r.push("NoLastMsg"),!0===o&&r.push("NoMsgCheck")}let i=void 0;Oe(e._receiverList)&&0<e._receiverList.length&&(i=e._receiverList,50<e._receiverList.length&&(i=e._receiverList.slice(0,50),this.outputWarning("ReceiverListLimit")));const n=this.isOnlineMessage(e,t)?1:0,a=e.getGroupAtInfoList(),u={fromAccount:this.getMyUserID(),groupID:e.to,msgBody:e.getElements(),cloudCustomData:o,random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:e.type!==x||Pe(a)?void 0:a,onlineOnlyFlag:n,clientTime:e.clientTime,offlinePushInfo:No(s),messageControlInfo:0==n?r:void 0,needReadReceipt:!0!==e.needReadReceipt||this.isMessageFromOrToAVChatroom(e.to)?0:1,receiverList:i,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID};return Qe(e.to)&&(u.groupID=Ze(e.to),u.topicID=e.to),{proto:Zt,tjgID:this.generateTjgID(e),data:u}}revokeMessage(e){const t={groupID:e.to,msgSeqList:[{msgSeq:e.sequence}]};return Qe(e.to)&&(t.groupID=Ze(e.to),t.topicID=e.to),this.req({proto:gs,data:t})}deleteMessage(e){var{to:e,keyList:t}=e;at.l(this._n+`.deleteMessage groupID:${e} count:`+t.length);const s={groupID:e,deleter:this.getMyUserID(),keyList:t};return Qe(e)&&(s.groupID=Ze(e),s.topicID=e),this.req({proto:Cs,data:s})}modifyRemoteMessage(e){var{to:e,sequence:t,payload:s,type:o,version:r=0,cloudCustomData:i}=e;let n=e,a=void 0,u=(Qe(e)&&(n=Ze(e),a=e),void 0);return(e=o)!==x&&e!==X&&e!==J&&e!==B||(u=[]).push({type:o,content:s}),this.req({proto:bs,data:{groupID:n,topicID:a,sequence:t,version:r,elements:u,cloudCustomData:i}})}getRoamingMessage(e){const u=this._n+".getRoamingMessage";let{conversationID:p,groupID:l,sequence:t}=e;const h=new Qt("getGroupRoamingMessages");let g=0,c=void 0;return Qe(l)&&(l=Ze(c=l)),this._computeLastSequence({groupID:l,topicID:c,sequence:t}).then(e=>(g=e,at.l(u+` groupID:${l} startSequence:`+g),this.req({proto:ds,data:{groupID:l,count:21,sequence:g,topicID:c}}))).then(e=>{var{messageList:t,complete:s,invisibleSequenceList:r=[]}=e.data;let{nextSequence:i=0}=e.data;Fe(t)?at.l(u+` ok. complete:${s} nextSequence:${i} but messageList is undefined!`):at.l(u+` ok. complete:${s} nextSequence:${i} count:`+t.length),h.setMessage(`groupID:${l} topicID:${c} startSequence:${g} complete:${s} nextSequence:`+i).end();const n=this.get(o);let a=[];return Pe(t)?1<=i&&n.updateRoamingMessageSequence(p,i):(n.updateRoamingMessageSequence(p,i),a=n.onRoamingMessage(t,p),n.updateIsRead(p),n.patchConversationLastMessage(p)),(2===s||i<1)&&(n.setCompleted(p),i=""),at.l(u+` nextReqID:${i}, stored message count:${a.length}, invisible sequence count:`+r.length),{nextReqID:i+"",storedMessageList:a}}).catch(e=>(h.setError(e).setMessage(`groupID:${l} topicID:${c} startSequence:`+g).end(),at.w(u+" failed. error:",e),jt(e)))}_getGroupIDOfMessage(e){return e.conversationID.replace(oe,"")}getReadReceiptList(s){const o=this._n+".getReadReceiptList",e=this._getGroupIDOfMessage(s[0]),t=this.getMyUserID(),r=s.filter(e=>e.from===t&&!0===e.needReadReceipt).map(e=>({sequence:e.sequence}));if(at.l(o+` groupID:${e} sequenceList:`+JSON.stringify(r)),0===r.length)return Ht({messageList:s});const i=new Qt("getReadReceiptList");return i.setMessage("groupID:"+e),this.req({proto:_s,data:{groupID:e,sequenceList:r}}).then(e=>{i.end(),at.l(o+" ok");const t=e.data["readReceiptList"];return Oe(t)&&t.forEach(t=>{s.forEach(e=>{0===t.code&&t.sequence===e.sequence&&(e.readReceiptInfo.readCount=t.readCount,e.readReceiptInfo.unreadCount=t.unreadCount)})}),ut({messageList:s})}).catch(e=>(i.setError(e).end(),at.w(o+" failed. error:",e),jt(e)))}sendReadReceipt(e){const t=this._n+".sendReadReceipt",s=this._getGroupIDOfMessage(e[0]),o=new Qt("sendReadReceipt"),r=(o.setMessage("groupID:"+s),this.getMyUserID()),i=e.filter(e=>e.from!==r&&!0===e.needReadReceipt).map(e=>({sequence:e.sequence}));return 0===i.length?jt({code:ct}):(at.l(t+". sequenceList:"+JSON.stringify(i)),this.req({proto:fs,data:{groupID:s,sequenceList:i}}).then(e=>(o.end(),at.l(t+" ok"),ut())).catch(e=>(o.setError(e).end(),at.w(t+" failed. error:",e),jt(e))))}getReadReceiptDetail(l){const{message:e,filter:t,cursor:s,count:o}=l,r=this._getGroupIDOfMessage(e),i=e.ID,h=e.sequence,n=this._n+".getReadReceiptDetail",g=this._receiptDetailCompleteMap.get(i)||!1,a=0!==t&&1!==t?0:t,c=qe(s)?s:"",m=!Ne(o)||o<=0||100<=o?100:o,d=`groupID:${r} sequence:${h} cursor:${c} filter:${a} completeFlag:`+g,u=(at.l(n+" "+d),{cursor:"",isCompleted:!1,messageID:i,unreadUserIDList:[],readUserIDList:[]}),p=new Qt("getReadReceiptDetail");return p.setMessage(d),this.req({proto:Ms,data:{groupID:r,sequence:h,flag:a,cursor:c,count:m}}).then(e=>{p.end();const{cursor:t,isCompleted:s,unreadUserIDList:o,readUserIDList:r}=e.data;return u.cursor=t,1===s&&(u.isCompleted=!0,this._receiptDetailCompleteMap.set(i,!0)),0===a?u.readUserIDList=r.map(e=>e.userID):1===a&&(u.unreadUserIDList=o.map(e=>e.userID)),at.l(n+" ok"),ut(u)}).catch(e=>(p.setError(e).end(),at.w(n+" failed. error:",e),jt(e)))}getRoamingMessagesHopping(u){const p=this._n+".getRoamingMessagesHopping";let{groupID:t,count:s,sequence:l,direction:h}=u,e=l;if(Fe(l)){if(1===h)return Ht({messageList:[],isCompleted:!0,nextMessageSeq:""});if(this.hasLocalGroup(t)){const u=this.getLocalGroupProfile(t)["nextMessageSeq"];e=1<u?u-1:0}Qe(t)&&(e=0)}else 1===h&&(e=l+s-1);let r=void 0;Qe(t)&&(t=Ze(r=t));const g=`${r?"topicID:"+r:"groupID:"+t} sequence:${l} direction:`+h,c=(at.l(p+" "+g),new Qt("getGroupRoamingMessagesHopping"));return this.req({proto:ds,data:{groupID:t,topicID:r,count:s,sequence:e}}).then(e=>{var{messageList:e,complete:t}=e.data,s=`complete:${t} count:`+(e?e.length:0);if(at.l(p+" ok. "+s),c.setMessage(g+" "+s).end(),2===t||Pe(e)){const u=this._computeResult();return ut(u)}const r=""+oe+u.groupID,i=this.get(o),n=i.onRoamingMessage(e,r,!1),a=this._computeResult({direction:h,sequence:l,remoteMessageList:e,processedMessageList:n});return i.storeHoppingMessageList(a.messageList),ut(a)}).catch(e=>(c.setError(e).setMessage(`groupID:${t} sequence:${l} count:`+s).end(),at.w(p+" failed. error:",e),jt(e)))}_computeResult(e){const t={messageList:[],isCompleted:!1,nextMessageSeq:""};if(Fe(e))return t.isCompleted=!0,t;const{direction:s,sequence:o,remoteMessageList:r=[],processedMessageList:i=[]}=e,n=r.length;return 1===s?(t.nextMessageSeq=r[0].sequence+1,i.forEach(e=>{e.sequence>=o&&t.messageList.push(e)}),0===t.messageList.length&&r[0].sequence<o&&(t.isCompleted=!0,t.nextMessageSeq="")):(t.nextMessageSeq=r[n-1].sequence-1,t.messageList=[...i],0===t.nextMessageSeq&&(t.isCompleted=!0,t.nextMessageSeq="")),t}setMessageRead({conversationID:r,lastMessageSeq:i}){const n=this._n+".setMessageRead",e=`conversationID:${r} lastMessageSeq:`+i,a=(at.l(n+" "+e),Ne(i)||this.outputWarning("DoNotModifyLastSeq"),new Qt("setMessageRead"));a.setMessage(e);let u=r.replace(oe,""),p=void 0;return Qe(u)&&(u=Ze(p=u)),this.req({proto:ms,data:{groupID:u,topicID:p,messageReadSeq:i}}).then(()=>{a.end(),at.l(n+" ok");const e=this.get(o);e.updateIsReadAfterReadReport({conversationID:r,lastMessageSeq:i});let t=!0;if(!Fe(p)){t=!1;const r=this.get(s).getLocalTopic(u,p);r&&r.updateSelfInfo({readedSequence:i})}return e.updateUnreadCount(r,t),ut()}).catch(e=>(a.setError(e).end(),at.l(n+" failed. error:",e),jt(e)))}_computeLastSequence(e){var{groupID:e,topicID:t,sequence:s}=e;return 0<s?Promise.resolve(s):Fe(t)?this.getGroupLastSequence(e):Promise.resolve(0)}getGroupLastSequence(e){const t=this._n+".getGroupLastSequence",s=new Qt("getGroupLastSequence");let r=0,i="";const n="groupID:"+e;if(this.hasLocalGroup(e)){const o=this.getLocalGroupProfile(e),a=o.lastMessage;if(0<a.lastSequence&&!1===a.onlineOnlyFlag)return r=a.lastSequence,i=n+`, ${r} from group.lastMessage.lastSequence`,at.l(t+" "+i),s.setMessage(i).end(),Promise.resolve(r);if(1<o.nextMessageSeq)return r=o.nextMessageSeq-1,i=n+`, ${r} from group.nextMessageSeq`,at.l(t+" "+i),s.setMessage(i).end(),Promise.resolve(r)}const a=this.get(o).getLocalConversation("GROUP"+e);return a&&a.lastMessage.lastSequence&&!1===a.lastMessage.onlineOnlyFlag?(r=a.lastMessage.lastSequence,i=n+`, ${r} from conversation.lastMessage.lastSequence`,at.l(t+" "+i),s.setMessage(i).end(),Promise.resolve(r)):this.getGroupProfileAdvance({groupIDList:[e],responseFilter:{groupBaseInfoFilter:["NextMsgSeq"]}}).then(({data:{successGroupList:e}})=>(Pe(e)?at.w(t+` ${n}, empty successGroupList`):(r=e[0].nextMessageSeq-1,i=n+`, ${r} from remote`,at.l(t+" "+i)),s.setMessage(i).end(),r)).catch(e=>(s.setError(e).setMessage(n).end(),at.w(t+" failed. error:",e),jt(e)))}isMessageFromOrToAVChatroom(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}hasJoinedAVChatRoom(){return this._AVChatRoomHandler.hasJoinedAVChatRoom()}getJoinedAVChatRoom(){return this._AVChatRoomHandler.getJoinedAVChatRoom()}getGroupRemoteLastSeq(e){e=this.getLocalGroupProfile(e);return e?e.nextMessageSeq-1:1}isOnlineMessage(e,t){return!(!this._canIUseOnlineOnlyFlag(e)||!t||!0!==t.onlineUserOnly)}_canIUseOnlineOnlyFlag(e){const t=this.getJoinedAVChatRoom();return!t||!t.includes(e.to)||e.conversationType!==oe}_onAVChatRoomHistoryMessage(e,t){if(!Pe(e)){at.l(this._n+`._onAVChatRoomHistoryMessage groupID:${t} count:`+e.length);const s=[];e.forEach(e=>{s.push({...e,isHistoryMessage:1})}),this.onAVChatRoomMessage(s,t)}}onAVChatRoomMessage(e,t=""){this._AVChatRoomHandler.onMessage(e,t)}onAVChatRoomMemberBanned(e){this._AVChatRoomHandler.onAVChatRoomMemberBanned(e)}getGroupSimplifiedInfo(t){const s=new Qt("getGroupSimplifiedInfo"),e={groupIDList:[t],responseFilter:{groupBaseInfoFilter:["Type","Name"]}};return this.getGroupProfileAdvance(e).then(({data:{successGroupList:e}})=>(s.setMessage(`groupID:${t} type:`+e[0].type).end(),e[0])).catch(e=>{s.setError(e).setMessage("groupID:"+t).end()})}setUnjoinedAVChatRoom(e){this._unjoinedAVChatRoomList.set(e,1)}deleteUnjoinedAVChatRoom(e){this._unjoinedAVChatRoomList.has(e)&&this._unjoinedAVChatRoomList.delete(e)}isUnjoinedAVChatRoom(e){return this._unjoinedAVChatRoomList.has(e)}isGroupAttributesUpdatedNotice(e){return this._groupAttributesHandler.isGroupAttributesUpdatedNotice(e)}updateLocalMainSequenceOnReconnected(){this._groupAttributesHandler.updateLocalMainSequenceOnReconnected()}initGroupAttributes(e){return this._groupAttributesHandler.initGroupAttributes(e)}setGroupAttributes(e){return this._groupAttributesHandler.setGroupAttributes(e)}deleteGroupAttributes(e){return this._groupAttributesHandler.deleteGroupAttributes(e)}getGroupAttributes(e){return this._groupAttributesHandler.getGroupAttributes(e)}isMessageFromTopic(e,t){return 2===e&&!Pe(t)}isMessageFromCommunityOfTopic(e,t){return 2===e&&Pe(t)}getMessageExtensions(e,t){return at.l(this._n+".getMessageExtensions startSequence:"+t),this.req({proto:Ps,data:{groupID:e.to,messageSequence:e.sequence,startSequence:t}})}modifyMessageExtensions(e,t,s=1){return at.l(this._n+".modifyMessageExtensions operateType:"+s),this.req({proto:$s,data:{groupID:e.to,messageSequence:e.sequence,extensionList:t,operateType:s}})}_genNotifyReqList(s){const o=[];for(let e=0,t=s.length;e<t;e++){var r=s[e],i=this.getLocalGroupProfile(r)["type"],n=this._getGroupLastRevokedTime(r),a=1e3*Ce(),i={notifyType:1,limit:20,type:Ye({type:i,groupID:r})?le:void 0,groupID:r,beginTime:n,endTime:a};o.push(i)}return o}getGroupNotify(e){const s=this._n+".getGroupNotify",t=e.filter(e=>{var{type:t,isSupportTopic:s}=this.getLocalGroupProfile(e);return this.hasLocalGroup(e)&&!Xe(t)&&!s});let o="filteredGroupIDList.length:"+t.length;t.length<=10&&(o="filteredGroupIDList:"+JSON.stringify(t)),at.l(s+" "+o),0!==t.length&&this.req({proto:Es,data:{notifyReqList:this._genNotifyReqList(e)}}).then(o=>{const e=o.data["notifyRspList"],r=[];if(Oe(e)){const o={dataList:[]};e.forEach(e=>{var{nextRevokedTime:t,groupID:s}=e;o.dataList.push({elements:{revokedInfos:this._genRevokedInfos(e)}}),0!==t?(this._setGroupLastRevokedTime(s,t),r.push(s)):this._setGroupLastRevokedTime(s,1e3*Ce())}),this.onGroupMessageRevoked(o)}0<r.length&&this.getGroupNotify(r);let t="nextGroupIDList.length:"+r.length;r.length<=10&&(t="nextGroupIDList:"+JSON.stringify(r)),at.l(s+" "+t)}).catch(e=>{at.e(s+" failed. error:",e)})}_genRevokedInfos(e){const{notifyList:t,groupID:s}=e,o=[];return Oe(t)&&t.forEach(e=>{o.push({groupID:s,sequence:e.sequence,random:e.random,revokerInfo:{...e.revokerInfo}})}),o}_getGroupLastRevokedTime(e){return this.hasLocalGroup(e)?this.getLocalGroupProfile(e)._lastRevokedTime:0}_setGroupLastRevokedTime(e,t){this.hasLocalGroup(e)&&(this.getLocalGroupProfile(e)._lastRevokedTime=t)}isGroupCountersNotice(e){return this._groupCountersHandler.isGroupCountersNotice(e)}setGroupCounters(e){return this._groupCountersHandler.setGroupCounters(e)}increaseGroupCounter(e){return this._groupCountersHandler.increaseGroupCounter(e)}decreaseGroupCounter(e){return this._groupCountersHandler.decreaseGroupCounter(e)}getGroupCounters(e){return this._groupCountersHandler.getGroupCounters(e)}getGroupMemberHandler(){return this._groupMemberHandler}getGroupMemberList(e){return this._groupMemberHandler.getGroupMemberList(e)}getGroupMemberProfile(e){return this._groupMemberHandler.getGroupMemberProfile(e)}addGroupMember(e){return this._groupMemberHandler.addGroupMember(e)}deleteGroupMember(e){return this._groupMemberHandler.deleteGroupMember(e)}setGroupMemberMuteTime(e){return this._groupMemberHandler.setGroupMemberMuteTime(e)}setGroupMemberRole(e){return this._groupMemberHandler.setGroupMemberRole(e)}setGroupMemberNameCard(e){return this._groupMemberHandler.setGroupMemberNameCard(e)}setGroupMemberCustomField(e){return this._groupMemberHandler.setGroupMemberCustomField(e)}markGroupMemberList(e){return this._groupMemberHandler.markGroupMemberList(e)}modifyGroupMemberInfo(e){return this._groupMemberHandler.modifyGroupMemberInfo(e)}restartPolling(){this._AVChatRoomHandler.restartPolling()}getPollingTimerID(e){if(!e)return-1;var t=this.getLocalGroupProfile(e);return t&&Xe(t.type)?this._AVChatRoomHandler.getPollingTimerID(e):-1}_canIUseJoinOption(e){return e===ae||Ye({type:e})}_silentlyGetGroupProfile(e,t){var s=setTimeout(this.getGroupProfile.bind(this,{groupID:t}),3e3);this._timeoutIDs.push(s),at.l(this._n+`._silentlyGetGroupProfile errorCode:${e} groupID:${t} timeoutIDs:`+this._timeoutIDs)}_clearTimeoutIDs(){this._timeoutIDs.forEach(e=>{clearTimeout(e)}),this._timeoutIDs=[]}startMessageLongPolling(e){var{groupID:e,longPollingKey:t,longPollingSequence:s=1}=e,o=this.get(r).isUnlimitedAVChatRoom(),i=(this._AVChatRoomHandler.hasPollingInstance(e)&&this.stopMessageLongPolling({groupID:e}),this._AVChatRoomHandler.getJoinedLiveList()),o=(!o&&0<i.length&&this.stopMessageLongPolling({groupID:i[0]}),new So({groupID:e,type:he}));return at.l(this._n+`.startMessageLongPolling groupID:${e} longPollingKey:${t} longPollingSequence:`+s),this._AVChatRoomHandler.startRunLoop({group:o,longPollingKey:t,startSeq:s})}stopMessageLongPolling(e){const t=e["groupID"],s=this.get(o);return this._AVChatRoomHandler.reset(t),this._deleteLocalGroup(t),s.deleteLocalConversation(""+oe+t),at.l(this._n+".stopMessageLongPolling ok, groupID:"+t),Ht({groupID:t})}reset(){this.groupMap.clear(),this._unjoinedAVChatRoomList.clear(),this._receiptDetailCompleteMap.clear(),this._onlineMemberCountMap.clear(),this._commonGroupHandler.reset(),this._groupSystemNoticeHandler.reset(),this._groupTipsHandler.reset(),this._groupAttributesHandler.reset(),this._groupCountersHandler.reset(),this._AVChatRoomHandler.reset(),this._groupMemberHandler.reset(),this._clearTimeoutIDs()}}export{Fo as default};